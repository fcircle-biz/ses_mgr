<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:replace="${title}">SES業務システム</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <!-- Additional CSS -->
    <th:block th:replace="${links}" />
</head>
<body>
    <!-- Header -->
    <header class="system-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="menu-toggle me-2" id="menu-toggle">
                        <i class="bi bi-list"></i>
                    </button>
                    <a th:href="@{/dashboard}" class="system-logo fs-4">SES業務システム</a>
                </div>
                <div class="d-flex align-items-center">
                    <div class="dropdown me-3">
                        <button class="btn btn-dark position-relative" type="button" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                                  th:if="${notificationCount > 0}" th:text="${notificationCount}">
                                0
                                <span class="visually-hidden">未読通知</span>
                            </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown">
                            <li><h6 class="dropdown-header" th:text="|未読通知 (${notificationCount ?: 0})|">未読通知 (0)</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li th:if="${notifications == null || notifications.isEmpty()}">
                                <span class="dropdown-item text-muted">通知はありません</span>
                            </li>
                            <li th:each="notification : ${notifications}">
                                <a class="dropdown-item" th:href="${notification.url}" th:text="${notification.message}">通知メッセージ</a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-primary" th:href="@{/notifications}">全ての通知を見る</a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-dark dropdown-toggle d-flex align-items-center" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="avatar-circle bg-primary text-white me-2" 
                                  th:if="${currentUser != null}">
                                <span th:text="${#strings.substring(currentUser.fullName, 0, 1)}">U</span>
                            </span>
                            <span th:text="${currentUser != null ? currentUser.fullName : 'ゲスト'}">ユーザー名</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" th:href="@{/profile}"><i class="bi bi-person me-2"></i>プロフィール</a></li>
                            <li><a class="dropdown-item" th:href="@{/settings}"><i class="bi bi-gear me-2"></i>設定</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="dropdown-item p-0">
                                    <button type="submit" class="dropdown-item"><i class="bi bi-box-arrow-right me-2"></i>ログアウト</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="d-flex">
        <!-- サイドメニュー -->
        <aside class="sidebar" id="sidebar">
            <nav class="nav flex-column mt-3">
                <a th:href="@{/dashboard}" class="nav-link" th:classappend="${activeMenu == 'dashboard' ? 'active' : ''}">
                    <i class="bi bi-house"></i>ダッシュボード
                </a>
                
                <!-- メニュー画面へのリンク -->
                <a th:href="@{/menu}" class="nav-link" th:classappend="${activeMenu == 'menu' ? 'active' : ''}">
                    <i class="bi bi-list"></i>メニュー
                </a>
                
                <!-- 案件管理 -->
                <div class="nav-item" th:classappend="${activeMenu == 'project' ? 'menu-open' : ''}" 
                     sec:authorize="hasAnyRole('ADMIN', 'SALES', 'EXECUTIVE', 'MANAGER')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-kanban"></i>案件管理
                    </a>
                    <div class="submenu">
                        <a th:href="@{/projects}" class="nav-link" th:classappend="${subMenu == 'projects' ? 'active' : ''}">案件一覧</a>
                        <a th:href="@{/projects/create}" class="nav-link" th:classappend="${subMenu == 'project-create' ? 'active' : ''}">案件登録</a>
                        <a th:href="@{/customers}" class="nav-link" th:classappend="${subMenu == 'customers' ? 'active' : ''}">顧客管理</a>
                    </div>
                </div>
                
                <!-- 技術者管理 -->
                <div class="nav-item" th:classappend="${activeMenu == 'engineer' ? 'menu-open' : ''}" 
                     sec:authorize="hasAnyRole('ADMIN', 'HR', 'SALES', 'EXECUTIVE', 'MANAGER')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-people"></i>技術者管理
                    </a>
                    <div class="submenu">
                        <a th:href="@{/engineers}" class="nav-link" th:classappend="${subMenu == 'engineers' ? 'active' : ''}">技術者一覧</a>
                        <a th:href="@{/engineers/create}" class="nav-link" th:classappend="${subMenu == 'engineer-create' ? 'active' : ''}" 
                           sec:authorize="hasAnyRole('ADMIN', 'HR', 'MANAGER')">技術者登録</a>
                        <a th:href="@{/engineers/skills}" class="nav-link" th:classappend="${subMenu == 'skills' ? 'active' : ''}">スキルシート管理</a>
                    </div>
                </div>
                
                <!-- マッチング -->
                <div class="nav-item" th:classappend="${activeMenu == 'matching' ? 'menu-open' : ''}" 
                     sec:authorize="hasAnyRole('ADMIN', 'SALES', 'HR', 'EXECUTIVE', 'MANAGER')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-search"></i>マッチング
                    </a>
                    <div class="submenu">
                        <a th:href="@{/matching/search}" class="nav-link" th:classappend="${subMenu == 'matching-search' ? 'active' : ''}">マッチング検索</a>
                        <a th:href="@{/matching/proposals}" class="nav-link" th:classappend="${subMenu == 'proposals' ? 'active' : ''}" 
                           sec:authorize="hasAnyRole('ADMIN', 'SALES', 'EXECUTIVE', 'MANAGER')">提案管理</a>
                    </div>
                </div>
                
                <!-- 契約管理 -->
                <div class="nav-item" th:classappend="${activeMenu == 'contract' ? 'menu-open' : ''}" 
                     sec:authorize="hasAnyRole('ADMIN', 'SALES', 'ACCOUNTING', 'EXECUTIVE', 'MANAGER')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-file-earmark-text"></i>契約管理
                    </a>
                    <div class="submenu">
                        <a th:href="@{/contracts}" class="nav-link" th:classappend="${subMenu == 'contracts' ? 'active' : ''}">契約一覧</a>
                        <a th:href="@{/contracts/create}" class="nav-link" th:classappend="${subMenu == 'contract-create' ? 'active' : ''}" 
                           sec:authorize="hasAnyRole('ADMIN', 'SALES', 'MANAGER')">契約作成</a>
                        <a th:href="@{/contracts/signatures}" class="nav-link" th:classappend="${subMenu == 'signatures' ? 'active' : ''}">電子署名管理</a>
                    </div>
                </div>
                
                <!-- 勤怠・工数 -->
                <div class="nav-item" th:classappend="${activeMenu == 'timesheet' ? 'menu-open' : ''}" 
                     sec:authorize="hasAnyRole('ADMIN', 'HR', 'ENGINEER', 'MANAGER')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-calendar-check"></i>勤怠・工数
                    </a>
                    <div class="submenu">
                        <a th:href="@{/timesheet/daily}" class="nav-link" th:classappend="${subMenu == 'timesheet-daily' ? 'active' : ''}" 
                           sec:authorize="hasAnyRole('ADMIN', 'ENGINEER')">勤怠入力</a>
                        <a th:href="@{/timesheet/effort}" class="nav-link" th:classappend="${subMenu == 'timesheet-effort' ? 'active' : ''}" 
                           sec:authorize="hasAnyRole('ADMIN', 'ENGINEER')">工数入力</a>
                        <a th:href="@{/timesheet/approve}" class="nav-link" th:classappend="${subMenu == 'timesheet-approve' ? 'active' : ''}" 
                           sec:authorize="hasAnyRole('ADMIN', 'HR', 'MANAGER')">勤怠承認</a>
                    </div>
                </div>
                
                <!-- 請求・支払 -->
                <div class="nav-item" th:classappend="${activeMenu == 'billing' ? 'menu-open' : ''}" 
                     sec:authorize="hasAnyRole('ADMIN', 'ACCOUNTING', 'EXECUTIVE', 'MANAGER')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-cash-stack"></i>請求・支払
                    </a>
                    <div class="submenu">
                        <a th:href="@{/billing/invoices}" class="nav-link" th:classappend="${subMenu == 'invoices' ? 'active' : ''}">請求管理</a>
                        <a th:href="@{/billing/payments}" class="nav-link" th:classappend="${subMenu == 'payments' ? 'active' : ''}">入金管理</a>
                        <a th:href="@{/billing/expenses}" class="nav-link" th:classappend="${subMenu == 'expenses' ? 'active' : ''}">支払管理</a>
                    </div>
                </div>
                
                <!-- レポート -->
                <div class="nav-item" th:classappend="${activeMenu == 'report' ? 'menu-open' : ''}" 
                     sec:authorize="hasAnyRole('ADMIN', 'EXECUTIVE', 'MANAGER')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-graph-up"></i>レポート
                    </a>
                    <div class="submenu">
                        <a th:href="@{/reports/kpi}" class="nav-link" th:classappend="${subMenu == 'kpi' ? 'active' : ''}">KPIダッシュボード</a>
                        <a th:href="@{/reports/financial}" class="nav-link" th:classappend="${subMenu == 'financial' ? 'active' : ''}">売上・粗利レポート</a>
                        <a th:href="@{/reports/utilization}" class="nav-link" th:classappend="${subMenu == 'utilization' ? 'active' : ''}">稼働・予測レポート</a>
                    </div>
                </div>
                
                <!-- システム管理 -->
                <div class="nav-item" th:classappend="${activeMenu == 'admin' ? 'menu-open' : ''}" 
                     sec:authorize="hasRole('ADMIN')">
                    <a href="#" class="nav-link has-submenu">
                        <i class="bi bi-gear"></i>システム管理
                    </a>
                    <div class="submenu">
                        <a th:href="@{/admin/users}" class="nav-link" th:classappend="${subMenu == 'users' ? 'active' : ''}">ユーザー管理</a>
                        <a th:href="@{/admin/roles}" class="nav-link" th:classappend="${subMenu == 'roles' ? 'active' : ''}">ロール管理</a>
                        <a th:href="@{/admin/masters}" class="nav-link" th:classappend="${subMenu == 'masters' ? 'active' : ''}">マスタ管理</a>
                        <a th:href="@{/admin/logs}" class="nav-link" th:classappend="${subMenu == 'logs' ? 'active' : ''}">ログ管理</a>
                        <a th:href="@{/admin/batch}" class="nav-link" th:classappend="${subMenu == 'batch' ? 'active' : ''}">バッチ管理</a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow-1 p-4">
            <th:block th:replace="${content}" />
        </main>
    </div>
    
    <!-- Footer -->
    <footer class="bg-light py-3 mt-3">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 SES業務システム</p>
        </div>
    </footer>
    
    <!-- Bootstrap JS with Popper -->
    <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
    
    <!-- Custom JavaScript -->
    <script th:src="@{/js/main.js}"></script>
    
    <!-- Additional Scripts -->
    <th:block th:replace="${scripts}" />
</body>
</html>