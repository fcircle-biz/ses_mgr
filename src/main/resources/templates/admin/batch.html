<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layouts/default :: layout(~{::title}, ~{::main})}">
<head>
    <meta charset="UTF-8">
    <title>バッチ管理 | SES業務システム</title>
</head>
<body>
<main>
    <!-- パンくずリスト -->
    <div class="container-fluid py-2 bg-light border-bottom">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a th:href="@{/}">ホーム</a></li>
                <li class="breadcrumb-item"><a th:href="@{/admin}">システム管理</a></li>
                <li class="breadcrumb-item active" aria-current="page">バッチ管理</li>
            </ol>
        </nav>
    </div>

    <!-- メインコンテンツ -->
    <div class="container-fluid my-4">
        <!-- ページヘッダー -->
        <div class="page-header mb-4">
            <h2 class="h4 mb-0">バッチ管理</h2>
        </div>

        <!-- バッチ管理タブ -->
        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="batchTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="scheduled-tab" data-bs-toggle="tab" data-bs-target="#scheduled-content" type="button" role="tab" aria-controls="scheduled-content" aria-selected="true">定期バッチ</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ondemand-tab" data-bs-toggle="tab" data-bs-target="#ondemand-content" type="button" role="tab" aria-controls="ondemand-content" aria-selected="false">オンデマンドバッチ</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-content" type="button" role="tab" aria-controls="history-content" aria-selected="false">実行履歴</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="batchTabsContent">
                    <!-- 定期バッチタブ -->
                    <div class="tab-pane fade show active" id="scheduled-content" role="tabpanel" aria-labelledby="scheduled-tab" tabindex="0">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="categoryFilter">
                                    <option selected>カテゴリ：すべて</option>
                                    <option>データ集計</option>
                                    <option>請求・支払</option>
                                    <option>通知</option>
                                    <option>データメンテナンス</option>
                                    <option>インポート/エクスポート</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" placeholder="バッチ名で検索..." id="scheduledBatchSearch">
                                    <button class="btn btn-outline-secondary" type="button" id="scheduledBatchSearchBtn"><i class="bi bi-search"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle" id="scheduledBatchTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>バッチID</th>
                                        <th>バッチ名</th>
                                        <th>カテゴリ</th>
                                        <th>スケジュール</th>
                                        <th>次回実行予定</th>
                                        <th>最終実行</th>
                                        <th>状態</th>
                                        <th>最終結果</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JavaScriptでデータを挿入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- オンデマンドバッチタブ -->
                    <div class="tab-pane fade" id="ondemand-content" role="tabpanel" aria-labelledby="ondemand-tab" tabindex="0">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="categoryFilterOnDemand">
                                    <option selected>カテゴリ：すべて</option>
                                    <option>データ集計</option>
                                    <option>請求・支払</option>
                                    <option>データメンテナンス</option>
                                    <option>インポート/エクスポート</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" placeholder="バッチ名で検索..." id="ondemandBatchSearch">
                                    <button class="btn btn-outline-secondary" type="button" id="ondemandBatchSearchBtn"><i class="bi bi-search"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle" id="ondemandBatchTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>バッチID</th>
                                        <th>バッチ名</th>
                                        <th>カテゴリ</th>
                                        <th>説明</th>
                                        <th>最終実行</th>
                                        <th>状態</th>
                                        <th>最終結果</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JavaScriptでデータを挿入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 実行履歴タブ -->
                    <div class="tab-pane fade" id="history-content" role="tabpanel" aria-labelledby="history-tab" tabindex="0">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="card-title mb-0">検索条件</h6>
                            </div>
                            <div class="card-body">
                                <form id="historySearchForm">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="historyStartDate" class="form-label">期間（開始）</label>
                                            <input type="datetime-local" class="form-control form-control-sm" id="historyStartDate" name="startDate">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="historyEndDate" class="form-label">期間（終了）</label>
                                            <input type="datetime-local" class="form-control form-control-sm" id="historyEndDate" name="endDate">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="historyBatchSelect" class="form-label">バッチ選択</label>
                                            <select class="form-select form-select-sm" id="historyBatchSelect" name="batchId">
                                                <option value="" selected>すべて</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">結果フィルタ</label>
                                            <div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="resultSuccess" name="success" checked>
                                                    <label class="form-check-label" for="resultSuccess">成功</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="resultWarning" name="warning" checked>
                                                    <label class="form-check-label" for="resultWarning">警告</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="resultError" name="error" checked>
                                                    <label class="form-check-label" for="resultError">失敗</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="historyResetBtn">
                                                <i class="bi bi-arrow-counterclockwise"></i> クリア
                                            </button>
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="bi bi-search"></i> 検索
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle" id="historyTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>実行ID</th>
                                        <th>バッチ名</th>
                                        <th>開始日時</th>
                                        <th>終了日時</th>
                                        <th>処理時間</th>
                                        <th>実行トリガー</th>
                                        <th>実行ユーザー</th>
                                        <th>結果</th>
                                        <th>詳細</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JavaScriptでデータを挿入 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <nav aria-label="ページナビゲーション" class="mt-3">
                            <ul class="pagination pagination-sm justify-content-center" id="historyPagination">
                                <!-- JavaScriptでページネーションを挿入 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- バッチ実行モーダル -->
    <div class="modal fade" id="batchRunModal" tabindex="-1" aria-labelledby="batchRunModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchRunModalLabel">バッチ実行</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="batchRunModalBody">
                    <form id="batchRunForm">
                        <input type="hidden" id="runBatchId" name="batchId">
                        <div class="mb-3">
                            <p><strong>バッチID:</strong> <span id="runBatchIdText"></span></p>
                            <p><strong>バッチ名:</strong> <span id="runBatchName"></span></p>
                            <p><strong>説明:</strong> <span id="runBatchDescription"></span></p>
                        </div>
                        
                        <div id="dynamicParamFormContent">
                            <!-- 動的パラメータフォームが追加される場所 -->
                        </div>
                        
                        <div class="mb-3">
                            <label for="notificationEmail" class="form-label">通知先メールアドレス</label>
                            <input type="email" class="form-control" id="notificationEmail" name="notificationEmail">
                            <div class="form-text">実行結果の通知先メールアドレス（複数の場合はカンマ区切り）</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="executionPriority" class="form-label">実行優先度</label>
                            <select class="form-select" id="executionPriority" name="executionPriority">
                                <option value="low">低</option>
                                <option value="normal" selected>標準</option>
                                <option value="high">高</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="runBatchSubmitBtn">実行</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- バッチスケジュール設定モーダル -->
    <div class="modal fade" id="batchScheduleModal" tabindex="-1" aria-labelledby="batchScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchScheduleModalLabel">バッチスケジュール設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="scheduleTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule-content" type="button" role="tab" aria-controls="schedule-content" aria-selected="true">スケジュール</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="param-tab" data-bs-toggle="tab" data-bs-target="#param-content" type="button" role="tab" aria-controls="param-content" aria-selected="false">パラメータ</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0 rounded-bottom">
                        <div class="tab-pane fade show active" id="schedule-content" role="tabpanel" aria-labelledby="schedule-tab">
                            <form id="scheduleSettingsForm">
                                <input type="hidden" id="scheduleSettingsBatchId" name="batchId">
                                <div class="mb-3">
                                    <p><strong>バッチID:</strong> <span id="scheduleSettingsBatchIdText"></span></p>
                                    <p><strong>バッチ名:</strong> <span id="scheduleSettingsBatchName"></span></p>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="scheduleEnabled" name="enabled" checked>
                                    <label class="form-check-label" for="scheduleEnabled">
                                        スケジュール有効
                                    </label>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">スケジュール設定方式</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scheduleMode" id="scheduleWizard" checked>
                                        <label class="form-check-label" for="scheduleWizard">
                                            ウィザード方式
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scheduleMode" id="scheduleCron">
                                        <label class="form-check-label" for="scheduleCron">
                                            Cron式
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="cron-editor mb-3" id="cronWizardSection">
                                    <div class="input-group mb-2">
                                        <label class="col-md-2 col-form-label" for="cronMinute">分</label>
                                        <select class="form-select" id="cronMinute" name="minute">
                                            <option value="0" selected>0 (00分)</option>
                                            <option value="15">15 (15分)</option>
                                            <option value="30">30 (30分)</option>
                                            <option value="45">45 (45分)</option>
                                            <option value="*">* (毎分)</option>
                                        </select>
                                    </div>
                                    <div class="input-group mb-2">
                                        <label class="col-md-2 col-form-label" for="cronHour">時</label>
                                        <select class="form-select" id="cronHour" name="hour">
                                            <option value="0">0 (0時)</option>
                                            <option value="1">1 (1時)</option>
                                            <option value="2">2 (2時)</option>
                                            <option value="3">3 (3時)</option>
                                            <option value="4">4 (4時)</option>
                                            <option value="5" selected>5 (5時)</option>
                                            <option value="*">* (毎時)</option>
                                        </select>
                                    </div>
                                    <div class="input-group mb-2">
                                        <label class="col-md-2 col-form-label" for="cronDay">日</label>
                                        <select class="form-select" id="cronDay" name="day">
                                            <option value="*" selected>* (毎日)</option>
                                            <option value="1">1 (1日)</option>
                                            <option value="15">15 (15日)</option>
                                            <option value="L">L (月末日)</option>
                                        </select>
                                    </div>
                                    <div class="input-group mb-2">
                                        <label class="col-md-2 col-form-label" for="cronMonth">月</label>
                                        <select class="form-select" id="cronMonth" name="month">
                                            <option value="*" selected>* (毎月)</option>
                                            <option value="1">1 (1月)</option>
                                            <option value="4">4 (4月)</option>
                                            <option value="7">7 (7月)</option>
                                            <option value="10">10 (10月)</option>
                                        </select>
                                    </div>
                                    <div class="input-group mb-2">
                                        <label class="col-md-2 col-form-label" for="cronWeekday">曜日</label>
                                        <select class="form-select" id="cronWeekday" name="weekday">
                                            <option value="*" selected>* (毎日)</option>
                                            <option value="0">0 (日曜日)</option>
                                            <option value="1">1 (月曜日)</option>
                                            <option value="1-5">1-5 (平日)</option>
                                            <option value="0,6">0,6 (休日)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3" id="cronExpressionSection" style="display: none;">
                                    <label for="cronExpression" class="form-label">Cron式</label>
                                    <input type="text" class="form-control" id="cronExpression" name="cronExpression" value="0 5 * * *">
                                    <div class="form-text">「分 時 日 月 曜日」の形式</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">タイムゾーン</label>
                                    <select class="form-select" id="timezone" name="timezone">
                                        <option value="Asia/Tokyo" selected>Asia/Tokyo (JST)</option>
                                        <option value="UTC">UTC</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="scheduleNote" class="form-label">説明</label>
                                    <textarea class="form-control" id="scheduleNote" name="note" rows="2">毎日午前5時に実行</textarea>
                                </div>
                                
                                <div class="alert alert-info">
                                    <div><strong>次回実行予定:</strong> <span id="nextRunPrediction"></span></div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="param-content" role="tabpanel" aria-labelledby="param-tab">
                            <form id="paramSettingsForm">
                                <input type="hidden" id="paramSettingsBatchId" name="batchId">
                                <div class="mb-3">
                                    <p><strong>バッチID:</strong> <span id="paramSettingsBatchIdText"></span></p>
                                    <p><strong>バッチ名:</strong> <span id="paramSettingsBatchName"></span></p>
                                </div>
                                
                                <div id="dynamicBatchParams">
                                    <!-- 動的パラメータフォームが追加される場所 -->
                                </div>
                                
                                <div class="mb-3">
                                    <label for="retryCount" class="form-label">リトライ回数</label>
                                    <input type="number" class="form-control" id="retryCount" name="retryCount" value="3" min="0" max="10">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="timeout" class="form-label">タイムアウト（分）</label>
                                    <input type="number" class="form-control" id="timeout" name="timeout" value="60" min="1" max="360">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">通知設定</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifySuccess" name="notifySuccess">
                                        <label class="form-check-label" for="notifySuccess">
                                            成功時に通知
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyWarning" name="notifyWarning" checked>
                                        <label class="form-check-label" for="notifyWarning">
                                            警告時に通知
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyError" name="notifyError" checked>
                                        <label class="form-check-label" for="notifyError">
                                            失敗時に通知
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="notifyEmail" class="form-label">通知先メールアドレス</label>
                                    <input type="text" class="form-control" id="notifyEmail" name="notifyEmail" value="admin@example.com">
                                    <div class="form-text">複数の場合はカンマ区切りで入力してください</div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="saveScheduleBtn">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- バッチ実行詳細モーダル -->
    <div class="modal fade" id="batchDetailModal" tabindex="-1" aria-labelledby="batchDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchDetailModalLabel">バッチ実行詳細</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="batchDetailModalBody">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>実行ID:</strong> <span id="detailExecutionId"></span></p>
                            <p><strong>バッチ名:</strong> <span id="detailBatchName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>実行結果:</strong> <span id="detailResultBadge"></span></p>
                            <p><strong>実行トリガー:</strong> <span id="detailTrigger"></span></p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>実行情報</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>開始日時:</strong> <span id="detailStartTime"></span></p>
                                <p><strong>終了日時:</strong> <span id="detailEndTime"></span></p>
                                <p><strong>処理時間:</strong> <span id="detailDuration"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>実行サーバー:</strong> <span id="detailServer"></span></p>
                                <p><strong>実行ユーザー:</strong> <span id="detailUser"></span></p>
                                <p><strong>スケジュールID:</strong> <span id="detailScheduleId"></span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>パラメータ</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered" id="detailParamsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>パラメータ名</th>
                                        <th>値</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JavaScriptでデータを挿入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>処理結果サマリー</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered" id="detailSummaryTable">
                                <tbody>
                                    <!-- JavaScriptでデータを挿入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>ログ出力</h6>
                        <div class="border bg-light p-3 overflow-auto" style="max-height: 300px; font-family: monospace; white-space: pre-wrap; font-size: 0.875rem;" id="detailLogOutput">
                            <!-- JavaScriptでデータを挿入 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary me-2" id="downloadLogBtn"><i class="bi bi-download"></i> ログダウンロード</button>
                    <button type="button" class="btn btn-outline-primary me-2" id="rerunBatchBtn"><i class="bi bi-arrow-repeat"></i> 再実行</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- ページ固有のJavaScript -->
<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    // 初期データ読み込み
    loadScheduledBatches();
    
    // 定期バッチカテゴリフィルタ
    document.getElementById('categoryFilter').addEventListener('change', function() {
        filterScheduledBatches();
    });
    
    // 定期バッチ検索
    document.getElementById('scheduledBatchSearchBtn').addEventListener('click', function() {
        filterScheduledBatches();
    });
    
    document.getElementById('scheduledBatchSearch').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            filterScheduledBatches();
        }
    });
    
    // オンデマンドバッチタブ選択時
    document.getElementById('ondemand-tab').addEventListener('click', function() {
        if (document.querySelectorAll('#ondemandBatchTable tbody tr').length === 0) {
            loadOnDemandBatches();
        }
    });
    
    // オンデマンドバッチカテゴリフィルタ
    document.getElementById('categoryFilterOnDemand').addEventListener('change', function() {
        filterOnDemandBatches();
    });
    
    // オンデマンドバッチ検索
    document.getElementById('ondemandBatchSearchBtn').addEventListener('click', function() {
        filterOnDemandBatches();
    });
    
    document.getElementById('ondemandBatchSearch').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            filterOnDemandBatches();
        }
    });
    
    // 実行履歴タブ選択時
    document.getElementById('history-tab').addEventListener('click', function() {
        if (document.querySelectorAll('#historyTable tbody tr').length === 0) {
            loadBatchHistory();
            loadBatchList();
        }
    });
    
    // 実行履歴検索フォーム
    document.getElementById('historySearchForm').addEventListener('submit', function(event) {
        event.preventDefault();
        loadBatchHistory();
    });
    
    // 実行履歴検索リセット
    document.getElementById('historyResetBtn').addEventListener('click', function() {
        document.getElementById('historySearchForm').reset();
        loadBatchHistory();
    });
    
    // クロン式とウィザードの切り替え
    document.getElementById('scheduleWizard').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('cronWizardSection').style.display = 'block';
            document.getElementById('cronExpressionSection').style.display = 'none';
            updateCronExpression();
        }
    });
    
    document.getElementById('scheduleCron').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('cronWizardSection').style.display = 'none';
            document.getElementById('cronExpressionSection').style.display = 'block';
        }
    });
    
    // Cronウィザードの値が変更された時
    ['cronMinute', 'cronHour', 'cronDay', 'cronMonth', 'cronWeekday'].forEach(function(id) {
        document.getElementById(id).addEventListener('change', updateCronExpression);
    });
    
    // スケジュール保存ボタン
    document.getElementById('saveScheduleBtn').addEventListener('click', function() {
        const activeTab = document.querySelector('#scheduleTab .nav-link.active');
        if (activeTab.id === 'schedule-tab') {
            saveScheduleSettings();
        } else {
            saveParameterSettings();
        }
    });
    
    // バッチ実行ボタン
    document.getElementById('runBatchSubmitBtn').addEventListener('click', function() {
        executeBatch();
    });
    
    // 再実行ボタン
    document.getElementById('rerunBatchBtn').addEventListener('click', function() {
        const executionId = document.getElementById('detailExecutionId').textContent;
        rerunBatch(executionId);
    });
    
    // ログダウンロードボタン
    document.getElementById('downloadLogBtn').addEventListener('click', function() {
        const executionId = document.getElementById('detailExecutionId').textContent;
        const batchName = document.getElementById('detailBatchName').textContent;
        const logContent = document.getElementById('detailLogOutput').textContent;
        
        // ログをダウンロード
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${batchName}_${executionId}.log`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
});

// 定期バッチの読み込み
function loadScheduledBatches() {
    fetch('/api/admin/batch/scheduled')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector('#scheduledBatchTable tbody');
            tableBody.innerHTML = '';
            
            data.forEach(batch => {
                const row = document.createElement('tr');
                
                // 日付のフォーマット
                const nextRun = batch.nextRun ? new Date(batch.nextRun).toLocaleString('ja-JP') : '-';
                const lastRun = batch.lastRun ? new Date(batch.lastRun).toLocaleString('ja-JP') : '-';
                
                // ステータスバッジのクラス
                const statusClass = batch.enabled ? 'success' : 'danger';
                const statusText = batch.enabled ? '有効' : '無効';
                
                // 結果バッジのクラス
                let resultClass = 'secondary';
                let resultText = '-';
                
                if (batch.lastResult) {
                    switch(batch.lastResult) {
                        case 'SUCCESS':
                            resultClass = 'success';
                            resultText = '成功';
                            break;
                        case 'WARNING':
                            resultClass = 'warning';
                            resultText = '警告';
                            break;
                        case 'FAILED':
                            resultClass = 'danger';
                            resultText = '失敗';
                            break;
                        case 'RUNNING':
                            resultClass = 'info';
                            resultText = '実行中';
                            break;
                    }
                }
                
                // 操作ボタンの設定
                let actionButtons = '';
                if (batch.lastResult === 'RUNNING') {
                    actionButtons = `
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-danger" title="停止" onclick="stopBatchExecution('${batch.id}')">
                                <i class="bi bi-stop-fill"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" title="設定" disabled>
                                <i class="bi bi-gear"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" title="無効化" disabled>
                                <i class="bi bi-toggle-off"></i>
                            </button>
                        </div>
                    `;
                } else {
                    actionButtons = `
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" title="実行" onclick="openBatchRunModal('${batch.id}')">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" title="設定" onclick="openBatchScheduleModal('${batch.id}')">
                                <i class="bi bi-gear"></i>
                            </button>
                            <button type="button" class="btn ${batch.enabled ? 'btn-outline-danger' : 'btn-outline-success'}" 
                                    title="${batch.enabled ? '無効化' : '有効化'}" 
                                    onclick="toggleBatchStatus('${batch.id}', ${!batch.enabled})">
                                <i class="bi ${batch.enabled ? 'bi-toggle-off' : 'bi-toggle-on'}"></i>
                            </button>
                        </div>
                    `;
                }
                
                row.innerHTML = `
                    <td>${batch.id}</td>
                    <td>${batch.name}</td>
                    <td>${batch.category}</td>
                    <td><code>${batch.schedule}</code></td>
                    <td>${nextRun}</td>
                    <td>${lastRun}</td>
                    <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    <td><span class="badge bg-${resultClass}">${resultText}</span></td>
                    <td>${actionButtons}</td>
                `;
                
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('定期バッチデータの取得に失敗しました:', error);
        });
}

// 定期バッチをフィルタリング
function filterScheduledBatches() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const searchText = document.getElementById('scheduledBatchSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#scheduledBatchTable tbody tr');
    
    rows.forEach(row => {
        const category = row.cells[2].textContent;
        const batchName = row.cells[1].textContent.toLowerCase();
        const batchId = row.cells[0].textContent.toLowerCase();
        
        const categoryMatch = categoryFilter === 'カテゴリ：すべて' || category === categoryFilter;
        const textMatch = batchName.includes(searchText) || batchId.includes(searchText);
        
        row.style.display = categoryMatch && textMatch ? '' : 'none';
    });
}

// オンデマンドバッチの読み込み
function loadOnDemandBatches() {
    fetch('/api/admin/batch/ondemand')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector('#ondemandBatchTable tbody');
            tableBody.innerHTML = '';
            
            data.forEach(batch => {
                const row = document.createElement('tr');
                
                // 日付のフォーマット
                const lastRun = batch.lastRun ? new Date(batch.lastRun).toLocaleString('ja-JP') : '-';
                
                // ステータスバッジのクラス
                const statusClass = batch.enabled ? 'success' : 'danger';
                const statusText = batch.enabled ? '有効' : '無効';
                
                // 結果バッジのクラス
                let resultClass = 'secondary';
                let resultText = '-';
                
                if (batch.lastResult) {
                    switch(batch.lastResult) {
                        case 'SUCCESS':
                            resultClass = 'success';
                            resultText = '成功';
                            break;
                        case 'WARNING':
                            resultClass = 'warning';
                            resultText = '警告';
                            break;
                        case 'FAILED':
                            resultClass = 'danger';
                            resultText = '失敗';
                            break;
                    }
                }
                
                row.innerHTML = `
                    <td>${batch.id}</td>
                    <td>${batch.name}</td>
                    <td>${batch.category}</td>
                    <td>${batch.description}</td>
                    <td>${lastRun}</td>
                    <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    <td><span class="badge bg-${resultClass}">${resultText}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" title="実行" onclick="openBatchRunModal('${batch.id}')">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" title="設定" onclick="openBatchScheduleModal('${batch.id}')">
                                <i class="bi bi-gear"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('オンデマンドバッチデータの取得に失敗しました:', error);
        });
}

// オンデマンドバッチをフィルタリング
function filterOnDemandBatches() {
    const categoryFilter = document.getElementById('categoryFilterOnDemand').value;
    const searchText = document.getElementById('ondemandBatchSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#ondemandBatchTable tbody tr');
    
    rows.forEach(row => {
        const category = row.cells[2].textContent;
        const batchName = row.cells[1].textContent.toLowerCase();
        const batchId = row.cells[0].textContent.toLowerCase();
        
        const categoryMatch = categoryFilter === 'カテゴリ：すべて' || category === categoryFilter;
        const textMatch = batchName.includes(searchText) || batchId.includes(searchText);
        
        row.style.display = categoryMatch && textMatch ? '' : 'none';
    });
}

// バッチ一覧の読み込み（セレクトボックス用）
function loadBatchList() {
    Promise.all([
        fetch('/api/admin/batch/scheduled').then(response => response.json()),
        fetch('/api/admin/batch/ondemand').then(response => response.json())
    ])
    .then(([scheduled, ondemand]) => {
        const batches = [...scheduled, ...ondemand];
        const selectElement = document.getElementById('historyBatchSelect');
        
        // 既存のオプションをクリア（「すべて」を除く）
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }
        
        // バッチ一覧をセレクトボックスに追加
        batches.forEach(batch => {
            const option = document.createElement('option');
            option.value = batch.id;
            option.textContent = `${batch.id} (${batch.name})`;
            selectElement.appendChild(option);
        });
    })
    .catch(error => {
        console.error('バッチ一覧データの取得に失敗しました:', error);
    });
}

// バッチ実行履歴の読み込み
function loadBatchHistory(page = 1) {
    // 検索条件の取得
    const startDate = document.getElementById('historyStartDate').value;
    const endDate = document.getElementById('historyEndDate').value;
    const batchId = document.getElementById('historyBatchSelect').value;
    const success = document.getElementById('resultSuccess').checked;
    const warning = document.getElementById('resultWarning').checked;
    const error = document.getElementById('resultError').checked;
    
    const searchParams = {
        page: page,
        pageSize: 10
    };
    
    if (startDate) searchParams.startDate = startDate;
    if (endDate) searchParams.endDate = endDate;
    if (batchId) searchParams.batchId = batchId;
    
    const resultFilter = [];
    if (success) resultFilter.push('SUCCESS');
    if (warning) resultFilter.push('WARNING');
    if (error) resultFilter.push('FAILED');
    if (resultFilter.length > 0) searchParams.resultFilter = resultFilter;
    
    fetch('/api/admin/batch/history', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(searchParams)
    })
    .then(response => response.json())
    .then(data => {
        const tableBody = document.querySelector('#historyTable tbody');
        tableBody.innerHTML = '';
        
        data.forEach(history => {
            const row = document.createElement('tr');
            
            // 日付のフォーマット
            const startTime = history.startTime ? new Date(history.startTime).toLocaleString('ja-JP') : '-';
            const endTime = history.endTime ? new Date(history.endTime).toLocaleString('ja-JP') : '-';
            
            // 結果バッジのクラス
            let resultClass = 'secondary';
            let resultText = '-';
            
            if (history.result) {
                switch(history.result) {
                    case 'SUCCESS':
                        resultClass = 'success';
                        resultText = '成功';
                        break;
                    case 'WARNING':
                        resultClass = 'warning';
                        resultText = '警告';
                        break;
                    case 'FAILED':
                        resultClass = 'danger';
                        resultText = '失敗';
                        break;
                    case 'RUNNING':
                        resultClass = 'info';
                        resultText = '実行中';
                        break;
                }
            }
            
            row.innerHTML = `
                <td>${history.id}</td>
                <td>${history.batchName}</td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td>${history.duration}</td>
                <td>${history.trigger}</td>
                <td>${history.user}</td>
                <td><span class="badge bg-${resultClass}">${resultText}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" onclick="openBatchDetailModal('${history.id}')">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // ページネーションの更新（模擬データのため、固定ページ数）
        updatePagination(page, 3);
    })
    .catch(error => {
        console.error('バッチ実行履歴データの取得に失敗しました:', error);
    });
}

// ページネーションの更新
function updatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('historyPagination');
    pagination.innerHTML = '';
    
    // 前へボタン
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage <= 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="return ${currentPage > 1 ? `loadBatchHistory(${currentPage - 1})` : 'false'}">前へ</a>`;
    pagination.appendChild(prevLi);
    
    // ページ番号
    for (let i = 1; i <= totalPages; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" onclick="return ${i !== currentPage ? `loadBatchHistory(${i})` : 'false'}">${i}</a>`;
        pagination.appendChild(pageLi);
    }
    
    // 次へボタン
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage >= totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="return ${currentPage < totalPages ? `loadBatchHistory(${currentPage + 1})` : 'false'}">次へ</a>`;
    pagination.appendChild(nextLi);
}

// バッチ実行モーダルを開く
function openBatchRunModal(batchId) {
    fetch(`/api/admin/batch/${batchId}`)
        .then(response => response.json())
        .then(batch => {
            document.getElementById('runBatchId').value = batchId;
            document.getElementById('runBatchIdText').textContent = batchId;
            document.getElementById('runBatchName').textContent = batch.name;
            document.getElementById('runBatchDescription').textContent = batch.description || '';
            
            // 動的パラメータフォームを生成
            const paramFormContent = document.getElementById('dynamicParamFormContent');
            paramFormContent.innerHTML = '';
            
            if (batch.parameters) {
                Object.entries(batch.parameters).forEach(([key, value]) => {
                    if (key !== 'notifyEmail' && key !== 'executionPriority') {
                        let inputHtml = '';
                        
                        if (typeof value === 'boolean') {
                            inputHtml = `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="param_${key}" name="${key}" ${value ? 'checked' : ''}>
                                    <label class="form-check-label" for="param_${key}">
                                        ${key}
                                    </label>
                                </div>
                            `;
                        } else if (typeof value === 'number') {
                            inputHtml = `
                                <div class="mb-3">
                                    <label for="param_${key}" class="form-label">${key}</label>
                                    <input type="number" class="form-control" id="param_${key}" name="${key}" value="${value}">
                                </div>
                            `;
                        } else {
                            inputHtml = `
                                <div class="mb-3">
                                    <label for="param_${key}" class="form-label">${key}</label>
                                    <input type="text" class="form-control" id="param_${key}" name="${key}" value="${value}">
                                </div>
                            `;
                        }
                        
                        paramFormContent.innerHTML += inputHtml;
                    }
                });
                
                // 通知先メールアドレスの設定
                if (batch.parameters.notifyEmail) {
                    document.getElementById('notificationEmail').value = batch.parameters.notifyEmail;
                }
                
                // 実行優先度の設定
                if (batch.parameters.executionPriority) {
                    document.getElementById('executionPriority').value = batch.parameters.executionPriority;
                }
            }
            
            const batchRunModal = new bootstrap.Modal(document.getElementById('batchRunModal'));
            batchRunModal.show();
        })
        .catch(error => {
            console.error('バッチ詳細データの取得に失敗しました:', error);
        });
}

// バッチスケジュール設定モーダルを開く
function openBatchScheduleModal(batchId) {
    fetch(`/api/admin/batch/${batchId}`)
        .then(response => response.json())
        .then(batch => {
            // スケジュールタブの設定
            document.getElementById('scheduleSettingsBatchId').value = batchId;
            document.getElementById('scheduleSettingsBatchIdText').textContent = batchId;
            document.getElementById('scheduleSettingsBatchName').textContent = batch.name;
            document.getElementById('scheduleEnabled').checked = batch.enabled;
            
            // Cron式の設定
            if (batch.schedule) {
                document.getElementById('cronExpression').value = batch.schedule;
                
                // Cron式をウィザードフォームに反映
                const cronParts = batch.schedule.trim().split(' ');
                if (cronParts.length === 5) {
                    document.getElementById('cronMinute').value = cronParts[0];
                    document.getElementById('cronHour').value = cronParts[1];
                    document.getElementById('cronDay').value = cronParts[2];
                    document.getElementById('cronMonth').value = cronParts[3];
                    document.getElementById('cronWeekday').value = cronParts[4];
                }
            }
            
            // タイムゾーンの設定
            if (batch.timezone) {
                document.getElementById('timezone').value = batch.timezone;
            }
            
            // パラメータタブの設定
            document.getElementById('paramSettingsBatchId').value = batchId;
            document.getElementById('paramSettingsBatchIdText').textContent = batchId;
            document.getElementById('paramSettingsBatchName').textContent = batch.name;
            
            // 動的パラメータフォームを生成
            const paramFormContent = document.getElementById('dynamicBatchParams');
            paramFormContent.innerHTML = '';
            
            if (batch.parameters) {
                // リトライ回数
                if (batch.parameters.retryCount !== undefined) {
                    document.getElementById('retryCount').value = batch.parameters.retryCount;
                }
                
                // タイムアウト
                if (batch.parameters.timeout !== undefined) {
                    document.getElementById('timeout').value = batch.parameters.timeout;
                }
                
                // 通知設定
                document.getElementById('notifySuccess').checked = batch.parameters.notifySuccess === true;
                document.getElementById('notifyWarning').checked = batch.parameters.notifyWarning !== false;
                document.getElementById('notifyError').checked = batch.parameters.notifyError !== false;
                
                // 通知先メールアドレス
                if (batch.parameters.notifyEmail) {
                    document.getElementById('notifyEmail').value = batch.parameters.notifyEmail;
                }
                
                // バッチ固有のパラメータを追加
                Object.entries(batch.parameters).forEach(([key, value]) => {
                    if (!['retryCount', 'timeout', 'notifySuccess', 'notifyWarning', 'notifyError', 'notifyEmail'].includes(key)) {
                        let inputHtml = '';
                        
                        if (typeof value === 'boolean') {
                            inputHtml = `
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="batchParam_${key}" name="${key}" ${value ? 'checked' : ''}>
                                    <label class="form-check-label" for="batchParam_${key}">
                                        ${key}
                                    </label>
                                </div>
                            `;
                        } else if (typeof value === 'number') {
                            inputHtml = `
                                <div class="mb-3">
                                    <label for="batchParam_${key}" class="form-label">${key}</label>
                                    <input type="number" class="form-control" id="batchParam_${key}" name="${key}" value="${value}">
                                </div>
                            `;
                        } else {
                            inputHtml = `
                                <div class="mb-3">
                                    <label for="batchParam_${key}" class="form-label">${key}</label>
                                    <input type="text" class="form-control" id="batchParam_${key}" name="${key}" value="${value}">
                                </div>
                            `;
                        }
                        
                        paramFormContent.innerHTML += inputHtml;
                    }
                });
            }
            
            // 次回実行予定を表示
            updateNextRunPrediction();
            
            const batchScheduleModal = new bootstrap.Modal(document.getElementById('batchScheduleModal'));
            batchScheduleModal.show();
        })
        .catch(error => {
            console.error('バッチ詳細データの取得に失敗しました:', error);
        });
}

// バッチ実行詳細モーダルを開く
function openBatchDetailModal(executionId) {
    fetch(`/api/admin/batch/execution/${executionId}`)
        .then(response => response.json())
        .then(execution => {
            document.getElementById('detailExecutionId').textContent = execution.id;
            document.getElementById('detailBatchName').textContent = execution.batchName;
            
            // 日付のフォーマット
            const startTime = execution.startTime ? new Date(execution.startTime).toLocaleString('ja-JP') : '-';
            const endTime = execution.endTime ? new Date(execution.endTime).toLocaleString('ja-JP') : '-';
            
            document.getElementById('detailStartTime').textContent = startTime;
            document.getElementById('detailEndTime').textContent = endTime;
            document.getElementById('detailDuration').textContent = execution.duration;
            document.getElementById('detailTrigger').textContent = execution.trigger;
            document.getElementById('detailUser').textContent = execution.user;
            document.getElementById('detailServer').textContent = execution.server || '-';
            document.getElementById('detailScheduleId').textContent = execution.scheduleId || '-';
            
            // 結果バッジの設定
            let resultClass = 'secondary';
            let resultText = '-';
            
            if (execution.result) {
                switch(execution.result) {
                    case 'SUCCESS':
                        resultClass = 'success';
                        resultText = '成功';
                        break;
                    case 'WARNING':
                        resultClass = 'warning';
                        resultText = '警告';
                        break;
                    case 'FAILED':
                        resultClass = 'danger';
                        resultText = '失敗';
                        break;
                    case 'RUNNING':
                        resultClass = 'info';
                        resultText = '実行中';
                        break;
                }
            }
            
            document.getElementById('detailResultBadge').innerHTML = `<span class="badge bg-${resultClass}">${resultText}</span>`;
            
            // パラメータテーブルの設定
            const paramsTable = document.getElementById('detailParamsTable').querySelector('tbody');
            paramsTable.innerHTML = '';
            
            if (execution.parameters) {
                Object.entries(execution.parameters).forEach(([key, value]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${key}</td>
                        <td>${value !== null && value !== undefined ? value.toString() : '-'}</td>
                    `;
                    paramsTable.appendChild(row);
                });
            }
            
            // サマリーテーブルの設定
            const summaryTable = document.getElementById('detailSummaryTable').querySelector('tbody');
            summaryTable.innerHTML = '';
            
            if (execution.summary) {
                Object.entries(execution.summary).forEach(([key, value]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${key}</td>
                        <td>${value}</td>
                    `;
                    summaryTable.appendChild(row);
                });
            }
            
            // ログ出力の設定
            document.getElementById('detailLogOutput').textContent = execution.log || 'ログデータがありません';
            
            const batchDetailModal = new bootstrap.Modal(document.getElementById('batchDetailModal'));
            batchDetailModal.show();
        })
        .catch(error => {
            console.error('バッチ実行詳細データの取得に失敗しました:', error);
        });
}

// Cron式を更新する
function updateCronExpression() {
    const minute = document.getElementById('cronMinute').value;
    const hour = document.getElementById('cronHour').value;
    const day = document.getElementById('cronDay').value;
    const month = document.getElementById('cronMonth').value;
    const weekday = document.getElementById('cronWeekday').value;
    
    const cronExpression = `${minute} ${hour} ${day} ${month} ${weekday}`;
    document.getElementById('cronExpression').value = cronExpression;
    
    // 次回実行予定を更新
    updateNextRunPrediction();
}

// 次回実行予定を更新する
function updateNextRunPrediction() {
    // 実装は簡略化（実際には正確なCron式の解析が必要）
    const now = new Date();
    const nextRun = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 5, 0, 0);
    document.getElementById('nextRunPrediction').textContent = nextRun.toLocaleString('ja-JP');
}

// スケジュール設定を保存する
function saveScheduleSettings() {
    const batchId = document.getElementById('scheduleSettingsBatchId').value;
    const enabled = document.getElementById('scheduleEnabled').checked;
    const cronExpression = document.getElementById('cronExpression').value;
    const timezone = document.getElementById('timezone').value;
    const note = document.getElementById('scheduleNote').value;
    
    const scheduleParams = {
        enabled: enabled,
        schedule: cronExpression,
        timezone: timezone,
        note: note
    };
    
    fetch(`/api/admin/batch/${batchId}/schedule`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(scheduleParams)
    })
    .then(response => response.json())
    .then(result => {
        if (result.updated) {
            // モーダルを閉じる
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchScheduleModal'));
            modal.hide();
            
            // 成功メッセージを表示
            alert('スケジュール設定を保存しました');
            
            // バッチ一覧を再読み込み
            loadScheduledBatches();
        } else {
            alert('スケジュール設定の保存に失敗しました');
        }
    })
    .catch(error => {
        console.error('スケジュール設定の保存に失敗しました:', error);
        alert('スケジュール設定の保存に失敗しました');
    });
}

// パラメータ設定を保存する
function saveParameterSettings() {
    const batchId = document.getElementById('paramSettingsBatchId').value;
    const retryCount = parseInt(document.getElementById('retryCount').value);
    const timeout = parseInt(document.getElementById('timeout').value);
    const notifySuccess = document.getElementById('notifySuccess').checked;
    const notifyWarning = document.getElementById('notifyWarning').checked;
    const notifyError = document.getElementById('notifyError').checked;
    const notifyEmail = document.getElementById('notifyEmail').value;
    
    const paramSettings = {
        retryCount: retryCount,
        timeout: timeout,
        notifySuccess: notifySuccess,
        notifyWarning: notifyWarning,
        notifyError: notifyError,
        notifyEmail: notifyEmail
    };
    
    // バッチ固有のパラメータも追加
    const dynamicParams = document.querySelectorAll('#dynamicBatchParams input, #dynamicBatchParams select');
    dynamicParams.forEach(input => {
        const name = input.name;
        let value;
        
        if (input.type === 'checkbox') {
            value = input.checked;
        } else if (input.type === 'number') {
            value = parseInt(input.value);
        } else {
            value = input.value;
        }
        
        paramSettings[name] = value;
    });
    
    fetch(`/api/admin/batch/${batchId}/parameters`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(paramSettings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.updated) {
            // モーダルを閉じる
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchScheduleModal'));
            modal.hide();
            
            // 成功メッセージを表示
            alert('パラメータ設定を保存しました');
            
            // バッチ一覧を再読み込み
            loadScheduledBatches();
        } else {
            alert('パラメータ設定の保存に失敗しました');
        }
    })
    .catch(error => {
        console.error('パラメータ設定の保存に失敗しました:', error);
        alert('パラメータ設定の保存に失敗しました');
    });
}

// バッチを実行する
function executeBatch() {
    const batchId = document.getElementById('runBatchId').value;
    const notificationEmail = document.getElementById('notificationEmail').value;
    const executionPriority = document.getElementById('executionPriority').value;
    
    const parameters = {
        notificationEmail: notificationEmail,
        executionPriority: executionPriority
    };
    
    // 動的パラメータも追加
    const dynamicParams = document.querySelectorAll('#dynamicParamFormContent input, #dynamicParamFormContent select');
    dynamicParams.forEach(input => {
        const name = input.name;
        let value;
        
        if (input.type === 'checkbox') {
            value = input.checked;
        } else if (input.type === 'number') {
            value = parseInt(input.value);
        } else {
            value = input.value;
        }
        
        parameters[name] = value;
    });
    
    fetch(`/api/admin/batch/${batchId}/execute`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(parameters)
    })
    .then(response => response.json())
    .then(result => {
        // モーダルを閉じる
        const modal = bootstrap.Modal.getInstance(document.getElementById('batchRunModal'));
        modal.hide();
        
        // 成功メッセージを表示
        alert(`バッチを実行キューに登録しました (実行ID: ${result.executionId})`);
        
        // 履歴タブへの切り替え
        document.getElementById('history-tab').click();
        
        // バッチ履歴を再読み込み
        setTimeout(() => {
            loadBatchHistory();
        }, 1000);
    })
    .catch(error => {
        console.error('バッチ実行に失敗しました:', error);
        alert('バッチ実行に失敗しました');
    });
}

// バッチの状態を切り替える
function toggleBatchStatus(batchId, enabled) {
    fetch(`/api/admin/batch/${batchId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(result => {
        if (result.updated) {
            // 成功メッセージを表示
            alert(result.message);
            
            // バッチ一覧を再読み込み
            loadScheduledBatches();
        } else {
            alert('バッチ状態の変更に失敗しました');
        }
    })
    .catch(error => {
        console.error('バッチ状態の変更に失敗しました:', error);
        alert('バッチ状態の変更に失敗しました');
    });
}

// 実行中のバッチを停止する
function stopBatchExecution(batchId) {
    if (confirm('実行中のバッチを停止しますか？')) {
        const executionId = document.querySelector(`tr:has(td:first-child:contains('${batchId}')) span.badge.bg-info`).closest('tr').cells[0].textContent;
        
        fetch(`/api/admin/batch/execution/${executionId}/stop`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            if (result.stopped) {
                // 成功メッセージを表示
                alert('バッチ実行を停止しました');
                
                // バッチ一覧を再読み込み
                loadScheduledBatches();
            } else {
                alert('バッチ実行の停止に失敗しました');
            }
        })
        .catch(error => {
            console.error('バッチ実行の停止に失敗しました:', error);
            alert('バッチ実行の停止に失敗しました');
        });
    }
}

// バッチを再実行する
function rerunBatch(executionId) {
    fetch(`/api/admin/batch/execution/${executionId}`)
        .then(response => response.json())
        .then(execution => {
            const batchId = execution.batchId;
            const parameters = execution.parameters || {};
            
            fetch(`/api/admin/batch/${batchId}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(parameters)
            })
            .then(response => response.json())
            .then(result => {
                // モーダルを閉じる
                const modal = bootstrap.Modal.getInstance(document.getElementById('batchDetailModal'));
                modal.hide();
                
                // 成功メッセージを表示
                alert(`バッチを再実行キューに登録しました (実行ID: ${result.executionId})`);
                
                // バッチ履歴を再読み込み
                setTimeout(() => {
                    loadBatchHistory();
                }, 1000);
            })
            .catch(error => {
                console.error('バッチ再実行に失敗しました:', error);
                alert('バッチ再実行に失敗しました');
            });
        })
        .catch(error => {
            console.error('バッチ実行詳細データの取得に失敗しました:', error);
            alert('バッチ実行詳細データの取得に失敗しました');
        });
}
</script>
</body>
</html>