<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レポーティング テーブル定義書 (PostgreSQL)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2980b9;
            margin-top: 30px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }
        p {
            margin-bottom: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        ul {
            margin-bottom: 20px;
        }
        li {
            margin-bottom: 5px;
        }
        .code-block {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>レポーティング テーブル定義書 (PostgreSQL)</h1>

    <h2>ダッシュボードテーブル (dashboards)</h2>
    <p>ユーザー別のダッシュボード設定を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>dashboard_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>ダッシュボードID</td>
            </tr>
            <tr>
                <td>dashboard_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>ダッシュボード名</td>
            </tr>
            <tr>
                <td>user_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>ユーザーID</td>
            </tr>
            <tr>
                <td>dashboard_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'個人'</td>
                <td>ダッシュボード種別</td>
            </tr>
            <tr>
                <td>layout_config</td>
                <td>JSONB</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'{}'</td>
                <td>レイアウト設定</td>
            </tr>
            <tr>
                <td>description</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>説明</td>
            </tr>
            <tr>
                <td>is_default</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>FALSE</td>
                <td>デフォルトフラグ</td>
            </tr>
            <tr>
                <td>is_public</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>FALSE</td>
                <td>公開フラグ</td>
            </tr>
            <tr>
                <td>created_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>作成者ID</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (dashboard_type IN ('個人', '部門', '全社', 'その他'))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (dashboard_id)</li>
                <li>CREATE INDEX idx_dashboards_user_id ON dashboards(user_id);</li>
                <li>CREATE INDEX idx_dashboards_dashboard_type ON dashboards(dashboard_type);</li>
                <li>CREATE INDEX idx_dashboards_is_public ON dashboards(is_public);</li>
            </ul>
        </li>
    </ul>

    <h2>ウィジェットテーブル (widgets)</h2>
    <p>ダッシュボード上のウィジェット（グラフや表など）を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>widget_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>ウィジェットID</td>
            </tr>
            <tr>
                <td>dashboard_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(dashboards.dashboard_id)</td>
                <td></td>
                <td>ダッシュボードID</td>
            </tr>
            <tr>
                <td>widget_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>ウィジェット名</td>
            </tr>
            <tr>
                <td>widget_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'グラフ'</td>
                <td>ウィジェット種別</td>
            </tr>
            <tr>
                <td>visualization_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'折れ線'</td>
                <td>可視化種別</td>
            </tr>
            <tr>
                <td>data_source</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'SQL'</td>
                <td>データソース</td>
            </tr>
            <tr>
                <td>query_config</td>
                <td>JSONB</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'{}'</td>
                <td>クエリ設定</td>
            </tr>
            <tr>
                <td>display_config</td>
                <td>JSONB</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'{}'</td>
                <td>表示設定</td>
            </tr>
            <tr>
                <td>position_config</td>
                <td>JSONB</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'{}'</td>
                <td>位置設定</td>
            </tr>
            <tr>
                <td>refresh_interval</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>更新間隔(秒)</td>
            </tr>
            <tr>
                <td>created_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>作成者ID</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (widget_type IN ('グラフ', '表', 'カード', 'フィルター', 'テキスト', 'その他'))</li>
                <li>CHECK (visualization_type IN ('折れ線', '棒', '円', '散布図', 'ヒートマップ', 'テーブル', 'ピボット', 'カウンター', 'その他'))</li>
                <li>CHECK (data_source IN ('SQL', 'API', 'CSV', 'メトリクス', 'その他'))</li>
                <li>CHECK (refresh_interval >= 0)</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (widget_id)</li>
                <li>CREATE INDEX idx_widgets_dashboard_id ON widgets(dashboard_id);</li>
                <li>CREATE INDEX idx_widgets_widget_type ON widgets(widget_type);</li>
                <li>CREATE INDEX idx_widgets_data_source ON widgets(data_source);</li>
            </ul>
        </li>
    </ul>

    <h2>KPI設定テーブル (kpi_definitions)</h2>
    <p>主要業績評価指標（KPI）の定義を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>kpi_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td>KPI ID</td>
            </tr>
            <tr>
                <td>kpi_code</td>
                <td>VARCHAR(50)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>KPIコード</td>
            </tr>
            <tr>
                <td>kpi_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>KPI名</td>
            </tr>
            <tr>
                <td>kpi_category</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td>'売上'</td>
                <td>KPIカテゴリー</td>
            </tr>
            <tr>
                <td>description</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>説明</td>
            </tr>
            <tr>
                <td>calculation_formula</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>計算式</td>
            </tr>
            <tr>
                <td>unit</td>
                <td>VARCHAR(20)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>単位</td>
            </tr>
            <tr>
                <td>data_source</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>データソース</td>
            </tr>
            <tr>
                <td>frequency</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td>'月次'</td>
                <td>集計頻度</td>
            </tr>
            <tr>
                <td>is_active</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td>TRUE</td>
                <td>有効フラグ</td>
            </tr>
            <tr>
                <td>target_direction</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td>'上昇'</td>
                <td>目標方向</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (kpi_category IN ('売上', '利益', '顧客', '技術者', '案件', '稼働率', 'その他'))</li>
                <li>CHECK (frequency IN ('日次', '週次', '月次', '四半期', '年次'))</li>
                <li>CHECK (target_direction IN ('上昇', '下降', '範囲内', '一定'))</li>
                <li>UNIQUE (kpi_code)</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (kpi_id)</li>
                <li>CREATE UNIQUE INDEX idx_kpi_definitions_code ON kpi_definitions(kpi_code);</li>
                <li>CREATE INDEX idx_kpi_definitions_category ON kpi_definitions(kpi_category);</li>
                <li>CREATE INDEX idx_kpi_definitions_frequency ON kpi_definitions(frequency);</li>
                <li>CREATE INDEX idx_kpi_definitions_is_active ON kpi_definitions(is_active);</li>
            </ul>
        </li>
    </ul>

    <h2>KPI目標テーブル (kpi_targets)</h2>
    <p>KPIの目標値を設定するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>target_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>目標ID</td>
            </tr>
            <tr>
                <td>kpi_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(kpi_definitions.kpi_id)</td>
                <td></td>
                <td>KPI ID</td>
            </tr>
            <tr>
                <td>target_year</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>目標年</td>
            </tr>
            <tr>
                <td>target_month</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>目標月</td>
            </tr>
            <tr>
                <td>target_quarter</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>目標四半期</td>
            </tr>
            <tr>
                <td>target_value</td>
                <td>NUMERIC(15,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>目標値</td>
            </tr>
            <tr>
                <td>minimum_value</td>
                <td>NUMERIC(15,2)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>最小値</td>
            </tr>
            <tr>
                <td>maximum_value</td>
                <td>NUMERIC(15,2)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>最大値</td>
            </tr>
            <tr>
                <td>target_department_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(departments.department_id)</td>
                <td></td>
                <td>部門ID</td>
            </tr>
            <tr>
                <td>notes</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>メモ</td>
            </tr>
            <tr>
                <td>created_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>作成者ID</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (target_year >= 2000 AND target_year <= 2100)</li>
                <li>CHECK (target_month IS NULL OR (target_month >= 1 AND target_month <= 12))</li>
                <li>CHECK (target_quarter IS NULL OR (target_quarter >= 1 AND target_quarter <= 4))</li>
                <li>CHECK ((target_month IS NOT NULL AND target_quarter IS NULL) OR (target_month IS NULL AND target_quarter IS NOT NULL) OR (target_month IS NULL AND target_quarter IS NULL))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (target_id)</li>
                <li>CREATE INDEX idx_kpi_targets_kpi_id ON kpi_targets(kpi_id);</li>
                <li>CREATE INDEX idx_kpi_targets_target_year ON kpi_targets(target_year);</li>
                <li>CREATE INDEX idx_kpi_targets_target_month ON kpi_targets(target_month);</li>
                <li>CREATE INDEX idx_kpi_targets_target_quarter ON kpi_targets(target_quarter);</li>
                <li>CREATE INDEX idx_kpi_targets_target_department_id ON kpi_targets(target_department_id);</li>
                <li>CREATE UNIQUE INDEX idx_kpi_targets_unique_period ON kpi_targets(kpi_id, target_year, COALESCE(target_month, 0), COALESCE(target_quarter, 0), COALESCE(target_department_id, 0));</li>
            </ul>
        </li>
    </ul>

    <h2>KPI実績テーブル (kpi_achievements)</h2>
    <p>KPIの実績値を記録するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>achievement_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>実績ID</td>
            </tr>
            <tr>
                <td>kpi_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(kpi_definitions.kpi_id)</td>
                <td></td>
                <td>KPI ID</td>
            </tr>
            <tr>
                <td>target_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(kpi_targets.target_id)</td>
                <td></td>
                <td>目標ID</td>
            </tr>
            <tr>
                <td>achievement_year</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>実績年</td>
            </tr>
            <tr>
                <td>achievement_month</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>実績月</td>
            </tr>
            <tr>
                <td>achievement_quarter</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>実績四半期</td>
            </tr>
            <tr>
                <td>achievement_date</td>
                <td>DATE</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>実績日</td>
            </tr>
            <tr>
                <td>achievement_value</td>
                <td>NUMERIC(15,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>実績値</td>
            </tr>
            <tr>
                <td>achievement_percentage</td>
                <td>NUMERIC(6,2)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>目標達成率(%)</td>
            </tr>
            <tr>
                <td>target_department_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(departments.department_id)</td>
                <td></td>
                <td>部門ID</td>
            </tr>
            <tr>
                <td>notes</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>メモ</td>
            </tr>
            <tr>
                <td>data_source</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'システム'</td>
                <td>データソース</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (achievement_year >= 2000 AND achievement_year <= 2100)</li>
                <li>CHECK (achievement_month IS NULL OR (achievement_month >= 1 AND achievement_month <= 12))</li>
                <li>CHECK (achievement_quarter IS NULL OR (achievement_quarter >= 1 AND achievement_quarter <= 4))</li>
                <li>CHECK ((achievement_month IS NOT NULL AND achievement_quarter IS NULL) OR (achievement_month IS NULL AND achievement_quarter IS NOT NULL) OR (achievement_month IS NULL AND achievement_quarter IS NULL))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (achievement_id)</li>
                <li>CREATE INDEX idx_kpi_achievements_kpi_id ON kpi_achievements(kpi_id);</li>
                <li>CREATE INDEX idx_kpi_achievements_target_id ON kpi_achievements(target_id);</li>
                <li>CREATE INDEX idx_kpi_achievements_achievement_year ON kpi_achievements(achievement_year);</li>
                <li>CREATE INDEX idx_kpi_achievements_achievement_month ON kpi_achievements(achievement_month);</li>
                <li>CREATE INDEX idx_kpi_achievements_achievement_quarter ON kpi_achievements(achievement_quarter);</li>
                <li>CREATE INDEX idx_kpi_achievements_achievement_date ON kpi_achievements(achievement_date);</li>
                <li>CREATE INDEX idx_kpi_achievements_target_department_id ON kpi_achievements(target_department_id);</li>
                <li>CREATE UNIQUE INDEX idx_kpi_achievements_unique_period ON kpi_achievements(kpi_id, achievement_year, COALESCE(achievement_month, 0), COALESCE(achievement_quarter, 0), COALESCE(target_department_id, 0));</li>
            </ul>
        </li>
    </ul>

    <h2>レポート出力履歴テーブル (report_history)</h2>
    <p>レポート出力の履歴を記録するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>report_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>レポートID</td>
            </tr>
            <tr>
                <td>report_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>レポート名</td>
            </tr>
            <tr>
                <td>report_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'標準'</td>
                <td>レポート種別</td>
            </tr>
            <tr>
                <td>user_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>ユーザーID</td>
            </tr>
            <tr>
                <td>parameters</td>
                <td>JSONB</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'{}'</td>
                <td>パラメーター</td>
            </tr>
            <tr>
                <td>output_format</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'PDF'</td>
                <td>出力形式</td>
            </tr>
            <tr>
                <td>file_path</td>
                <td>VARCHAR(255)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>ファイルパス</td>
            </tr>
            <tr>
                <td>execution_time</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>実行時間(ミリ秒)</td>
            </tr>
            <tr>
                <td>record_count</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>レコード数</td>
            </tr>
            <tr>
                <td>status</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'完了'</td>
                <td>ステータス</td>
            </tr>
            <tr>
                <td>error_message</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>エラーメッセージ</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (report_type IN ('標準', 'カスタム', 'スケジュール', 'その他'))</li>
                <li>CHECK (output_format IN ('PDF', 'Excel', 'CSV', 'HTML', 'JSON', 'その他'))</li>
                <li>CHECK (status IN ('完了', '失敗', '処理中', 'キャンセル'))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (report_id)</li>
                <li>CREATE INDEX idx_report_history_user_id ON report_history(user_id);</li>
                <li>CREATE INDEX idx_report_history_report_type ON report_history(report_type);</li>
                <li>CREATE INDEX idx_report_history_status ON report_history(status);</li>
                <li>CREATE INDEX idx_report_history_created_at ON report_history(created_at);</li>
            </ul>
        </li>
    </ul>

    <h2>レポートスケジュールテーブル (report_schedules)</h2>
    <p>レポートの定期実行スケジュールを管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>schedule_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>スケジュールID</td>
            </tr>
            <tr>
                <td>schedule_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>スケジュール名</td>
            </tr>
            <tr>
                <td>report_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>レポート名</td>
            </tr>
            <tr>
                <td>user_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>ユーザーID</td>
            </tr>
            <tr>
                <td>parameters</td>
                <td>JSONB</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'{}'</td>
                <td>パラメーター</td>
            </tr>
            <tr>
                <td>output_format</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'PDF'</td>
                <td>出力形式</td>
            </tr>
            <tr>
                <td>schedule_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'月次'</td>
                <td>スケジュール種別</td>
            </tr>
            <tr>
                <td>cron_expression</td>
                <td>VARCHAR(100)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>CRON式</td>
            </tr>
            <tr>
                <td>next_run_date</td>
                <td>TIMESTAMP</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>次回実行日時</td>
            </tr>
            <tr>
                <td>last_run_date</td>
                <td>TIMESTAMP</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>前回実行日時</td>
            </tr>
            <tr>
                <td>is_active</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>TRUE</td>
                <td>有効フラグ</td>
            </tr>
            <tr>
                <td>recipients</td>
                <td>TEXT[]</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>送信先メールアドレス</td>
            </tr>
            <tr>
                <td>created_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>作成者ID</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (schedule_type IN ('日次', '週次', '月次', '四半期', '年次', 'カスタム'))</li>
                <li>CHECK (output_format IN ('PDF', 'Excel', 'CSV', 'HTML', 'JSON', 'その他'))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (schedule_id)</li>
                <li>CREATE INDEX idx_report_schedules_user_id ON report_schedules(user_id);</li>
                <li>CREATE INDEX idx_report_schedules_schedule_type ON report_schedules(schedule_type);</li>
                <li>CREATE INDEX idx_report_schedules_next_run_date ON report_schedules(next_run_date);</li>
                <li>CREATE INDEX idx_report_schedules_is_active ON report_schedules(is_active);</li>
            </ul>
        </li>
    </ul>

    <h2>データソーステーブル (data_sources)</h2>
    <p>レポートやダッシュボードで使用するデータソースを管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>source_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td>ソースID</td>
            </tr>
            <tr>
                <td>source_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>ソース名</td>
            </tr>
            <tr>
                <td>source_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td>'SQL'</td>
                <td>ソース種別</td>
            </tr>
            <tr>
                <td>connection_details</td>
                <td>JSONB</td>
                <td>YES</td>
                <td></td>
                <td>'{}'</td>
                <td>接続詳細</td>
            </tr>
            <tr>
                <td>query_text</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>クエリ文</td>
            </tr>
            <tr>
                <td>description</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>説明</td>
            </tr>
            <tr>
                <td>is_active</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td>TRUE</td>
                <td>有効フラグ</td>
            </tr>
            <tr>
                <td>refresh_interval</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>0</td>
                <td>更新間隔(秒)</td>
            </tr>
            <tr>
                <td>created_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>作成者ID</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (source_type IN ('SQL', 'API', 'CSV', 'ストアドプロシージャ', 'その他'))</li>
                <li>CHECK (refresh_interval >= 0)</li>
                <li>UNIQUE (source_name)</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (source_id)</li>
                <li>CREATE UNIQUE INDEX idx_data_sources_name ON data_sources(source_name);</li>
                <li>CREATE INDEX idx_data_sources_source_type ON data_sources(source_type);</li>
                <li>CREATE INDEX idx_data_sources_is_active ON data_sources(is_active);</li>
            </ul>
        </li>
    </ul>

    <h2>テーブル作成用SQL</h2>
    <div class="code-block">
-- 更新タイムスタンプ用のトリガー関数
CREATE OR REPLACE FUNCTION update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ダッシュボードテーブル
CREATE TABLE dashboards (
    dashboard_id SERIAL PRIMARY KEY,
    dashboard_name VARCHAR(100) NOT NULL,
    user_id INTEGER REFERENCES users(user_id),
    dashboard_type TEXT NOT NULL DEFAULT '個人' CHECK (dashboard_type IN ('個人', '部門', '全社', 'その他')),
    layout_config JSONB DEFAULT '{}',
    description TEXT,
    is_default BOOLEAN NOT NULL DEFAULT FALSE,
    is_public BOOLEAN NOT NULL DEFAULT FALSE,
    created_by INTEGER REFERENCES users(user_id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_dashboards_user_id ON dashboards(user_id);
CREATE INDEX idx_dashboards_dashboard_type ON dashboards(dashboard_type);
CREATE INDEX idx_dashboards_is_public ON dashboards(is_public);

CREATE TRIGGER update_dashboards_timestamp
BEFORE UPDATE ON dashboards
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- ウィジェットテーブル
CREATE TABLE widgets (
    widget_id SERIAL PRIMARY KEY,
    dashboard_id INTEGER NOT NULL REFERENCES dashboards(dashboard_id),
    widget_name VARCHAR(100) NOT NULL,
    widget_type TEXT NOT NULL DEFAULT 'グラフ' 
        CHECK (widget_type IN ('グラフ', '表', 'カード', 'フィルター', 'テキスト', 'その他')),
    visualization_type TEXT NOT NULL DEFAULT '折れ線' 
        CHECK (visualization_type IN ('折れ線', '棒', '円', '散布図', 'ヒートマップ', 'テーブル', 'ピボット', 'カウンター', 'その他')),
    data_source TEXT NOT NULL DEFAULT 'SQL' 
        CHECK (data_source IN ('SQL', 'API', 'CSV', 'メトリクス', 'その他')),
    query_config JSONB DEFAULT '{}',
    display_config JSONB DEFAULT '{}',
    position_config JSONB DEFAULT '{}',
    refresh_interval INTEGER DEFAULT 0 CHECK (refresh_interval >= 0),
    created_by INTEGER REFERENCES users(user_id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_widgets_dashboard_id ON widgets(dashboard_id);
CREATE INDEX idx_widgets_widget_type ON widgets(widget_type);
CREATE INDEX idx_widgets_data_source ON widgets(data_source);

CREATE TRIGGER update_widgets_timestamp
BEFORE UPDATE ON widgets
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- KPI設定テーブル
CREATE TABLE kpi_definitions (
    kpi_id SERIAL PRIMARY KEY,
    kpi_code VARCHAR(50) NOT NULL UNIQUE,
    kpi_name VARCHAR(100) NOT NULL,
    kpi_category TEXT NOT NULL DEFAULT '売上' 
        CHECK (kpi_category IN ('売上', '利益', '顧客', '技術者', '案件', '稼働率', 'その他')),
    description TEXT,
    calculation_formula TEXT,
    unit VARCHAR(20),
    data_source TEXT,
    frequency TEXT NOT NULL DEFAULT '月次' 
        CHECK (frequency IN ('日次', '週次', '月次', '四半期', '年次')),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    target_direction TEXT NOT NULL DEFAULT '上昇' 
        CHECK (target_direction IN ('上昇', '下降', '範囲内', '一定')),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_kpi_definitions_code ON kpi_definitions(kpi_code);
CREATE INDEX idx_kpi_definitions_category ON kpi_definitions(kpi_category);
CREATE INDEX idx_kpi_definitions_frequency ON kpi_definitions(frequency);
CREATE INDEX idx_kpi_definitions_is_active ON kpi_definitions(is_active);

CREATE TRIGGER update_kpi_definitions_timestamp
BEFORE UPDATE ON kpi_definitions
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- KPI目標テーブル
CREATE TABLE kpi_targets (
    target_id SERIAL PRIMARY KEY,
    kpi_id INTEGER NOT NULL REFERENCES kpi_definitions(kpi_id),
    target_year INTEGER NOT NULL CHECK (target_year >= 2000 AND target_year <= 2100),
    target_month INTEGER CHECK (target_month IS NULL OR (target_month >= 1 AND target_month <= 12)),
    target_quarter INTEGER CHECK (target_quarter IS NULL OR (target_quarter >= 1 AND target_quarter <= 4)),
    target_value NUMERIC(15,2) NOT NULL DEFAULT 0,
    minimum_value NUMERIC(15,2),
    maximum_value NUMERIC(15,2),
    target_department_id INTEGER REFERENCES departments(department_id),
    notes TEXT,
    created_by INTEGER REFERENCES users(user_id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CHECK ((target_month IS NOT NULL AND target_quarter IS NULL) OR 
           (target_month IS NULL AND target_quarter IS NOT NULL) OR 
           (target_month IS NULL AND target_quarter IS NULL))
);

CREATE INDEX idx_kpi_targets_kpi_id ON kpi_targets(kpi_id);
CREATE INDEX idx_kpi_targets_target_year ON kpi_targets(target_year);
CREATE INDEX idx_kpi_targets_target_month ON kpi_targets(target_month);
CREATE INDEX idx_kpi_targets_target_quarter ON kpi_targets(target_quarter);
CREATE INDEX idx_kpi_targets_target_department_id ON kpi_targets(target_department_id);
CREATE UNIQUE INDEX idx_kpi_targets_unique_period ON kpi_targets(kpi_id, target_year, COALESCE(target_month, 0), COALESCE(target_quarter, 0), COALESCE(target_department_id, 0));

CREATE TRIGGER update_kpi_targets_timestamp
BEFORE UPDATE ON kpi_targets
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- KPI実績テーブル
CREATE TABLE kpi_achievements (
    achievement_id SERIAL PRIMARY KEY,
    kpi_id INTEGER NOT NULL REFERENCES kpi_definitions(kpi_id),
    target_id INTEGER REFERENCES kpi_targets(target_id),
    achievement_year INTEGER NOT NULL CHECK (achievement_year >= 2000 AND achievement_year <= 2100),
    achievement_month INTEGER CHECK (achievement_month IS NULL OR (achievement_month >= 1 AND achievement_month <= 12)),
    achievement_quarter INTEGER CHECK (achievement_quarter IS NULL OR (achievement_quarter >= 1 AND achievement_quarter <= 4)),
    achievement_date DATE,
    achievement_value NUMERIC(15,2) NOT NULL DEFAULT 0,
    achievement_percentage NUMERIC(6,2),
    target_department_id INTEGER REFERENCES departments(department_id),
    notes TEXT,
    data_source TEXT DEFAULT 'システム',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CHECK ((achievement_month IS NOT NULL AND achievement_quarter IS NULL) OR 
           (achievement_month IS NULL AND achievement_quarter IS NOT NULL) OR 
           (achievement_month IS NULL AND achievement_quarter IS NULL))
);

CREATE INDEX idx_kpi_achievements_kpi_id ON kpi_achievements(kpi_id);
CREATE INDEX idx_kpi_achievements_target_id ON kpi_achievements(target_id);
CREATE INDEX idx_kpi_achievements_achievement_year ON kpi_achievements(achievement_year);
CREATE INDEX idx_kpi_achievements_achievement_month ON kpi_achievements(achievement_month);
CREATE INDEX idx_kpi_achievements_achievement_quarter ON kpi_achievements(achievement_quarter);
CREATE INDEX idx_kpi_achievements_achievement_date ON kpi_achievements(achievement_date);
CREATE INDEX idx_kpi_achievements_target_department_id ON kpi_achievements(target_department_id);
CREATE UNIQUE INDEX idx_kpi_achievements_unique_period ON kpi_achievements(kpi_id, achievement_year, COALESCE(achievement_month, 0), COALESCE(achievement_quarter, 0), COALESCE(target_department_id, 0));

CREATE TRIGGER update_kpi_achievements_timestamp
BEFORE UPDATE ON kpi_achievements
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- レポート出力履歴テーブル
CREATE TABLE report_history (
    report_id SERIAL PRIMARY KEY,
    report_name VARCHAR(100) NOT NULL,
    report_type TEXT NOT NULL DEFAULT '標準' 
        CHECK (report_type IN ('標準', 'カスタム', 'スケジュール', 'その他')),
    user_id INTEGER REFERENCES users(user_id),
    parameters JSONB DEFAULT '{}',
    output_format TEXT NOT NULL DEFAULT 'PDF' 
        CHECK (output_format IN ('PDF', 'Excel', 'CSV', 'HTML', 'JSON', 'その他')),
    file_path VARCHAR(255),
    execution_time INTEGER,
    record_count INTEGER,
    status TEXT NOT NULL DEFAULT '完了' 
        CHECK (status IN ('完了', '失敗', '処理中', 'キャンセル')),
    error_message TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_report_history_user_id ON report_history(user_id);
CREATE INDEX idx_report_history_report_type ON report_history(report_type);
CREATE INDEX idx_report_history_status ON report_history(status);
CREATE INDEX idx_report_history_created_at ON report_history(created_at);

-- レポートスケジュールテーブル
CREATE TABLE report_schedules (
    schedule_id SERIAL PRIMARY KEY,
    schedule_name VARCHAR(100) NOT NULL,
    report_name VARCHAR(100) NOT NULL,
    user_id INTEGER REFERENCES users(user_id),
    parameters JSONB DEFAULT '{}',
    output_format TEXT NOT NULL DEFAULT 'PDF' 
        CHECK (output_format IN ('PDF', 'Excel', 'CSV', 'HTML', 'JSON', 'その他')),
    schedule_type TEXT NOT NULL DEFAULT '月次' 
        CHECK (schedule_type IN ('日次', '週次', '月次', '四半期', '年次', 'カスタム')),
    cron_expression VARCHAR(100),
    next_run_date TIMESTAMP,
    last_run_date TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    recipients TEXT[],
    created_by INTEGER REFERENCES users(user_id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_report_schedules_user_id ON report_schedules(user_id);
CREATE INDEX idx_report_schedules_schedule_type ON report_schedules(schedule_type);
CREATE INDEX idx_report_schedules_next_run_date ON report_schedules(next_run_date);
CREATE INDEX idx_report_schedules_is_active ON report_schedules(is_active);

CREATE TRIGGER update_report_schedules_timestamp
BEFORE UPDATE ON report_schedules
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- データソーステーブル
CREATE TABLE data_sources (
    source_id SERIAL PRIMARY KEY,
    source_name VARCHAR(100) NOT NULL UNIQUE,
    source_type TEXT NOT NULL DEFAULT 'SQL' 
        CHECK (source_type IN ('SQL', 'API', 'CSV', 'ストアドプロシージャ', 'その他')),
    connection_details JSONB DEFAULT '{}',
    query_text TEXT,
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    refresh_interval INTEGER NOT NULL DEFAULT 0 CHECK (refresh_interval >= 0),
    created_by INTEGER REFERENCES users(user_id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_data_sources_name ON data_sources(source_name);
CREATE INDEX idx_data_sources_source_type ON data_sources(source_type);
CREATE INDEX idx_data_sources_is_active ON data_sources(is_active);

CREATE TRIGGER update_data_sources_timestamp
BEFORE UPDATE ON data_sources
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();
    </div>

</body>
</html>