# DB詳細設計 - スキーマ設計

## 1. スキーマ構造

本システムでは、機能モジュールごとに論理的なスキーマを分割し、責務の明確化とメンテナンス性の向上を図る。

### 1.1 スキーマ一覧

| スキーマ名    | 説明                           | 主な機能                                           |
|--------------|--------------------------------|---------------------------------------------------|
| `common`     | 共通機能                       | 認証・認可、ユーザー管理、コード値、ファイル管理など |
| `engineer`   | 技術者管理                     | 技術者情報、スキル、稼働状況など                    |
| `project`    | 案件管理                       | 案件情報、要件、ステータス管理など                  |
| `matching`   | マッチング機能                 | マッチングロジック、提案管理など                    |
| `contract`   | 契約管理                       | 契約情報、電子署名、契約テンプレートなど            |
| `timesheet`  | 勤怠工数管理                   | 勤怠記録、工数入力、承認管理など                    |
| `billing`    | 請求支払管理                   | 請求書、入金、支払管理など                          |
| `reporting`  | レポーティング                 | KPI、集計データ、分析など                           |
| `audit`      | 監査ログ                       | システム全体の監査ログ                              |

### 1.2 スキーマ作成

各スキーマの作成は以下のようなSQL文で行う。

```sql
-- スキーマ作成
CREATE SCHEMA common;
CREATE SCHEMA engineer;
CREATE SCHEMA project;
CREATE SCHEMA matching;
CREATE SCHEMA contract;
CREATE SCHEMA timesheet;
CREATE SCHEMA billing;
CREATE SCHEMA reporting;
CREATE SCHEMA audit;

-- スキーマ権限設定
GRANT USAGE ON SCHEMA common TO app_user;
GRANT USAGE ON SCHEMA engineer TO app_user;
GRANT USAGE ON SCHEMA project TO app_user;
GRANT USAGE ON SCHEMA matching TO app_user;
GRANT USAGE ON SCHEMA contract TO app_user;
GRANT USAGE ON SCHEMA timesheet TO app_user;
GRANT USAGE ON SCHEMA billing TO app_user;
GRANT USAGE ON SCHEMA reporting TO app_user;
GRANT USAGE ON SCHEMA audit TO auditor_user;
```

### 1.3 スキーマ間参照

スキーマ間の参照は以下のような方針で行う。

- 共通スキーマ(`common`)は他のすべてのスキーマから参照可能
- 業務スキーマ間の参照は必要最小限に制限
- 監査スキーマ(`audit`)は他のスキーマからの参照不可
- `reporting`スキーマは他のスキーマを参照するが、他からは参照されない

#### スキーマ検索パスの設定:

```sql
-- アプリケーション用ユーザーの検索パス設定
ALTER ROLE app_user SET search_path TO common, engineer, project, matching, contract, timesheet, billing, reporting, public;

-- レポーティング用ユーザーの検索パス設定
ALTER ROLE report_user SET search_path TO reporting, common, public;
```

## 2. 命名規則

### 2.1 一般命名規則

- スネークケース（小文字、単語間はアンダースコア）を使用
- 略語は極力避け、わかりやすい名称を使用
- 予約語との衝突を避ける
- 名称は英語とし、日本語ローマ字表記は避ける

### 2.2 テーブル命名規則

| 種類               | 命名パターン                        | 例                               |
|-------------------|------------------------------------|----------------------------------|
| 基本テーブル       | `[機能]_[エンティティ]`             | `engineer_skill`, `project_request` |
| 関連テーブル       | `[テーブル1]_[テーブル2]_rel`       | `engineer_skill_rel`, `project_engineer_rel` |
| 履歴テーブル       | `[テーブル名]_history`              | `contract_history`, `timesheet_history` |
| ログテーブル       | `[機能]_log`                        | `auth_log`, `operation_log` |
| 一時テーブル       | `tmp_[目的]`                        | `tmp_billing_calc`, `tmp_report_data` |
| ビュー             | `vw_[目的]`                         | `vw_active_engineers`, `vw_project_summary` |
| マテリアライズドビュー | `mvw_[目的]`                     | `mvw_monthly_sales`, `mvw_resource_stats` |

### 2.3 カラム命名規則

| 種類               | 命名パターン                        | 例                               |
|-------------------|------------------------------------|----------------------------------|
| 主キー             | `id`                               | `id` |
| 外部キー           | `[参照テーブル]_id`                 | `engineer_id`, `project_id` |
| 日時型             | `[内容]_date`, `[内容]_datetime`    | `start_date`, `registration_datetime` |
| フラグ型           | `is_[状態]`, `has_[属性]`           | `is_active`, `has_attachment` |
| カウント型         | `[内容]_count`                      | `login_count`, `error_count` |
| コード型           | `[内容]_code`                       | `status_code`, `company_code` |
| 名称型             | `[内容]_name`                       | `engineer_name`, `project_name` |
| JSON型            | `[内容]_json`                       | `settings_json`, `data_json` |

### 2.4 制約命名規則

| 種類               | 命名パターン                        | 例                               |
|-------------------|------------------------------------|----------------------------------|
| 主キー制約         | `pk_[テーブル名]`                   | `pk_engineer`, `pk_project` |
| 外部キー制約       | `fk_[テーブル名]_[参照テーブル名]`   | `fk_engineer_skill_engineer` |
| 一意制約           | `uq_[テーブル名]_[カラム名]`         | `uq_user_email` |
| チェック制約       | `ck_[テーブル名]_[チェック内容]`     | `ck_timesheet_valid_hours` |
| デフォルト制約     | `df_[テーブル名]_[カラム名]`         | `df_user_registration_date` |

### 2.5 インデックス命名規則

| 種類               | 命名パターン                         | 例                               |
|-------------------|-------------------------------------|----------------------------------|
| 一意インデックス   | `uix_[テーブル名]_[カラム名]`         | `uix_user_email` |
| 非一意インデックス | `ix_[テーブル名]_[カラム名]`          | `ix_project_start_date` |
| 複合インデックス   | `ix_[テーブル名]_[カラム1]_[カラム2]` | `ix_timesheet_engineer_id_date` |
| GINインデックス    | `gin_[テーブル名]_[カラム名]`         | `gin_engineer_skills_json` |
| GiSTインデックス   | `gist_[テーブル名]_[カラム名]`        | `gist_location_geom` |

## 3. スキーマ詳細設計

### 3.1 common スキーマ

共通機能を提供するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `common.user`              | ユーザー情報                       | `id`, `email`, `password_hash`, `role_id`    |
| `common.role`              | ロール情報                         | `id`, `role_name`, `permissions_json`        |
| `common.code_category`     | コード値カテゴリ                   | `id`, `category_name`, `description`         |
| `common.code_value`        | コード値                           | `id`, `category_id`, `code`, `value`, `sort_order` |
| `common.file_storage`      | ファイル管理                       | `id`, `file_name`, `content_type`, `size`, `path` |
| `common.notification`      | 通知情報                           | `id`, `user_id`, `type`, `content`, `read_flag` |

### 3.2 engineer スキーマ

技術者管理機能に関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `engineer.engineer`        | 技術者基本情報                     | `id`, `name`, `email`, `phone`, `status_code` |
| `engineer.skill`           | スキル情報                         | `id`, `skill_name`, `category_id`, `level`   |
| `engineer.skill_category`  | スキルカテゴリ                     | `id`, `category_name`, `sort_order`          |
| `engineer.engineer_skill`  | 技術者スキル関連                   | `id`, `engineer_id`, `skill_id`, `level`, `years` |
| `engineer.availability`    | 稼働状況                           | `id`, `engineer_id`, `date`, `status_code`   |

### 3.3 project スキーマ

案件管理機能に関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `project.project`          | 案件基本情報                       | `id`, `title`, `description`, `status_code`  |
| `project.requirement`      | 案件要件情報                       | `id`, `project_id`, `skill_id`, `importance` |
| `project.status_history`   | 案件ステータス履歴                 | `id`, `project_id`, `status_code`, `changed_datetime` |
| `project.customer`         | 顧客情報                          | `id`, `company_name`, `contact_name`, `email` |

### 3.4 matching スキーマ

マッチング機能に関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `matching.result`          | マッチング結果                     | `id`, `project_id`, `engineer_id`, `score`   |
| `matching.proposal`        | 提案情報                           | `id`, `project_id`, `engineer_id`, `status_code` |
| `matching.proposal_doc`    | 提案書情報                         | `id`, `proposal_id`, `file_id`, `version`    |
| `matching.search_history`  | 検索履歴                           | `id`, `user_id`, `criteria_json`, `datetime` |

### 3.5 contract スキーマ

契約管理機能に関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `contract.contract`        | 契約基本情報                       | `id`, `project_id`, `engineer_id`, `status_code` |
| `contract.document`        | 契約書情報                         | `id`, `contract_id`, `file_id`, `version`    |
| `contract.signature`       | 電子署名情報                       | `id`, `document_id`, `signer_id`, `sign_date` |
| `contract.template`        | 契約テンプレート                   | `id`, `template_name`, `file_id`, `version`  |

### 3.6 timesheet スキーマ

勤怠工数管理機能に関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `timesheet.attendance`     | 勤怠情報                           | `id`, `engineer_id`, `date`, `status_code`   |
| `timesheet.working_hours`  | 工数情報                           | `id`, `engineer_id`, `project_id`, `date`, `hours` |
| `timesheet.approval`       | 承認情報                           | `id`, `timesheet_id`, `approver_id`, `status_code` |
| `timesheet.summary`        | 集計情報                           | `id`, `engineer_id`, `year_month`, `total_hours` |

### 3.7 billing スキーマ

請求支払管理機能に関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `billing.invoice`          | 請求情報                           | `id`, `contract_id`, `billing_date`, `amount` |
| `billing.invoice_detail`   | 請求詳細                           | `id`, `invoice_id`, `item_name`, `quantity`, `unit_price` |
| `billing.payment`          | 入金情報                           | `id`, `invoice_id`, `payment_date`, `amount` |
| `billing.expense`          | 支払情報                           | `id`, `contract_id`, `expense_date`, `amount` |

### 3.8 reporting スキーマ

レポーティング機能に関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `reporting.kpi`            | KPI情報                            | `id`, `kpi_name`, `value`, `target`, `period` |
| `reporting.report`         | レポート情報                       | `id`, `report_name`, `created_by`, `params_json` |
| `reporting.aggregated_data`| 集計データ                         | `id`, `dimension`, `measure`, `value`, `period` |
| `reporting.forecast`       | 予測データ                         | `id`, `target`, `forecast_value`, `confidence` |

### 3.9 audit スキーマ

監査ログに関連するテーブル群を格納する。

#### 主要テーブル:

| テーブル名                  | 説明                               | 主要カラム                                    |
|----------------------------|-----------------------------------|----------------------------------------------|
| `audit.system_log`         | システムログ                       | `id`, `level`, `message`, `timestamp`, `source` |
| `audit.operation_log`      | 操作ログ                           | `id`, `user_id`, `operation`, `target`, `timestamp` |
| `audit.data_change_log`    | データ変更ログ                     | `id`, `table_name`, `record_id`, `old_values_json`, `new_values_json` |

## 4. スキーマ管理戦略

### 4.1 バージョン管理

データベースのスキーマ変更はFlyway等のマイグレーションツールを使用して管理する。

#### マイグレーションファイル命名規則:

```
V{バージョン番号}__{変更内容}.sql
```

例: `V1.0.0__initial_schema.sql`, `V1.0.1__add_engineer_skills.sql`

### 4.2 デプロイメント戦略

スキーマ変更は以下の手順で行う。

1. 開発環境で変更を検証
2. ステージング環境でのテスト
3. 本番環境への適用（メンテナンス時間帯）

### 4.3 互換性管理

スキーマ変更時は以下の点に留意する。

- 既存データの整合性維持
- 後方互換性の確保
- 適切なロールバック手順の準備
- ダウンタイムの最小化

## 5. パーティショニング設計

大規模テーブルやアクセス頻度の高いテーブルには適切なパーティショニングを適用する。詳細は「06_パーティション設計.md」を参照。