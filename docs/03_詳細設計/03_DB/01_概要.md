# DB詳細設計 - 概要

## 1. 設計方針

本プロジェクトのデータベース設計においては、以下の方針に基づいて詳細設計を行う。

### 1.1 品質目標

- **整合性**: データの整合性を保ち、不正なデータの挿入・更新を防止する
- **性能**: 負荷の高い操作においても安定したパフォーマンスを発揮する設計
- **拡張性**: 将来の機能追加やデータ量の増加に対応可能な柔軟な設計
- **保守性**: 運用・保守が容易で、問題発生時に迅速に対応可能な設計
- **セキュリティ**: 機密データを適切に保護し、不正アクセスを防止する設計

### 1.2 基本方針

- **正規化の原則**: 第3正規形を基本とし、必要に応じて適切な非正規化を行う
- **参照整合性の確保**: 外部キー制約による参照整合性を確保する
- **データ型の適切な選択**: 各カラムの用途に最適なデータ型を選択する
- **インデックス戦略**: クエリパターンを考慮した効率的なインデックス設計
- **PostgreSQL固有機能の活用**: PostgreSQLの高度な機能を適切に活用する

## 2. データベース概要

### 2.1 システム構成

本システムでは、PostgreSQL 17をデータベース管理システムとして採用する。

- **データベース名**: `ses_mgr`
- **文字セット**: UTF-8
- **照合順序**: ja_JP.utf8

### 2.2 モジュール構成

データベースは以下の業務モジュールに対応するスキーマ構成とする。

| スキーマ名    | 説明                             | 主要テーブル群                             |
|--------------|----------------------------------|-------------------------------------------|
| common       | 共通機能                         | ユーザー、認証、コード値、ファイル管理など |
| engineer     | 技術者管理                       | 技術者、スキル、稼働状況など              |
| project      | 案件管理                         | 案件、要件、ステータス管理など            |
| matching     | マッチング機能                   | マッチング結果、提案管理など              |
| contract     | 契約管理                         | 契約、電子署名、契約テンプレートなど      |
| timesheet    | 勤怠工数管理                     | 勤怠、工数、承認フローなど                |
| billing      | 請求支払管理                     | 請求、入金、支払など                      |
| reporting    | レポーティング                   | KPI、集計データ、予測分析など             |

## 3. 環境構成

### 3.1 開発環境

- **サーバ**: Docker コンテナ（公式 PostgreSQL 17 イメージ）
- **管理ツール**: pgAdmin 4
- **バックアップ**: 日次差分バックアップ、週次フルバックアップ

### 3.2 本番環境

- **サーバ**: AWS RDS for PostgreSQL (マルチAZ構成)
- **レプリケーション**: 自動フェイルオーバー対応のレプリカ構成
- **バックアップ**: 自動バックアップ（保持期間30日）、手動スナップショット（月次）
- **監視**: Amazon CloudWatch + カスタム監視スクリプト

## 4. 設計ドキュメント構成

DB詳細設計は、以下のドキュメントから構成される。

1. **概要** (本ドキュメント)
2. **物理設計** - ハードウェア、パラメータ設定
3. **スキーマ設計** - スキーマ構成、命名規則
4. **データ型と制約** - データ型選定基準、制約設計
5. **インデックス設計** - インデックス戦略、最適化
6. **パーティション設計** - パーティション方針
7. **PostgreSQL拡張機能** - 特殊機能活用
8. **パフォーマンス最適化** - チューニング戦略
9. **バックアップリカバリ** - バックアップ計画
10. **モニタリング設計** - 監視方針

加えて、各業務モジュールごとに以下のテーブル定義補足ドキュメントを作成する。

- **モジュール別テーブル定義補足**:
  - 各業務モジュールごとの詳細なテーブル設計情報
  - モジュール固有のパフォーマンス最適化戦略
  - 特殊なデータ処理や制約条件
  - 典型的なクエリパターンとその最適化

## 5. 移行計画概要

システム稼働に向けて、以下の移行計画を策定する。

1. **移行対象データの特定と分析**
2. **データクレンジング・変換ルールの策定**
3. **移行スクリプトの開発**
4. **テスト環境での移行リハーサル**
5. **本番環境への移行実施**
6. **移行後の検証**

詳細な移行計画については別途「データ移行計画書」にて定義する。

## 6. 運用・保守計画概要

システム安定稼働に向けて、以下の運用・保守計画を策定する。

1. **定期メンテナンス**: VACUUM、ANALYZE、インデックス再構築など
2. **パフォーマンスモニタリング**: スロークエリ分析、リソース使用率監視
3. **容量管理**: データ増加予測、ディスク使用率監視
4. **バックアップ・リストア**: 定期バックアップ、リストア手順確立
5. **セキュリティ対策**: 脆弱性対応、アクセス制御管理

詳細な運用・保守計画については別途「DB運用・保守計画書」にて定義する。