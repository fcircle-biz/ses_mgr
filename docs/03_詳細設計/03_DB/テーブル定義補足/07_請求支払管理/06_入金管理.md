# 入金管理テーブル

入金管理に関連するテーブルは、入金情報（`receipts`）と入金割当情報（`receipt_allocations`）の2つのテーブルで構成されます。

## receipts（入金情報）

顧客からの入金情報を管理するテーブルです。入金日、入金金額、入金方法などを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| receipt_id | uuid | NO | YES | - | - | 入金ID |
| invoice_id | uuid | YES | NO | invoices.invoice_id | NULL | 請求ID（1対1の場合のみ指定） |
| receipt_date | date | NO | NO | - | - | 入金日 |
| amount | decimal(12,2) | NO | NO | - | 0.00 | 入金額 |
| payment_method | varchar(20) | NO | NO | - | 'bank_transfer' | 支払方法（bank_transfer:振込, direct_debit:引落, credit_card:カード決済, etc） |
| reference_number | varchar(50) | YES | NO | - | NULL | 参照番号（振込番号など） |
| notes | text | YES | NO | - | NULL | 備考 |
| created_by | uuid | NO | NO | users.user_id | - | 作成者ID |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### チェック制約

1. 入金額は0より大きい値
   ```
   CHECK (amount > 0)
   ```

2. 支払方法の値チェック
   ```
   CHECK (payment_method IN ('bank_transfer', 'direct_debit', 'credit_card', 'cash', 'offset', 'other'))
   ```

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_receipts_invoice_id | invoice_id | 請求IDによる検索用 |
| idx_receipts_receipt_date | receipt_date | 入金日による検索用 |
| idx_receipts_reference_number | reference_number | 参照番号による検索用 |

### ビジネスルール

- 入金額は0より大きい金額であること
- 入金情報が登録されると、関連する請求の入金ステータスが自動更新される
- 1対1の入金・請求紐づけの場合はinvoice_idに直接指定
- 複数の請求に対する入金、または1つの請求に対する複数回の入金の場合は、receipt_allocationsテーブルで紐づけを管理
- 入金情報が更新されると、関連する全ての請求の入金ステータスを再計算

## receipt_allocations（入金割当情報）

入金金額を複数の請求に割り当てるためのテーブルです。どの入金がどの請求にいくら割り当てられたかを管理します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| allocation_id | uuid | NO | YES | - | - | 割当ID |
| receipt_id | uuid | NO | NO | receipts.receipt_id | - | 入金ID |
| invoice_id | uuid | NO | NO | invoices.invoice_id | - | 請求ID |
| amount | decimal(12,2) | NO | NO | - | 0.00 | 割当金額 |
| notes | text | YES | NO | - | NULL | 備考 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### チェック制約

1. 割当金額は0より大きい値
   ```
   CHECK (amount > 0)
   ```

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_receipt_allocations_receipt_id | receipt_id | 入金IDによる検索用 |
| idx_receipt_allocations_invoice_id | invoice_id | 請求IDによる検索用 |

### ビジネスルール

- 割当金額は0より大きい金額であること
- 1つの入金に対する割当金額の合計は、入金額を超えてはならない
- 割当情報が追加・更新・削除されると、関連する請求の入金ステータスが自動更新される
- 割当金額の総和と請求金額を比較して、請求の入金ステータスを決定
  - 合計 < 請求金額: 一部入金（partially_paid）
  - 合計 = 請求金額: 入金済（paid）
  - 合計 > 請求金額: 過払い（overpaid）

## クエリパターン

### 主要なクエリパターン

1. 請求IDに対する入金状況の確認
   ```
   SELECT i.invoice_id, i.invoice_number, i.total_amount,
          COALESCE(SUM(ra.amount), 0) as paid_amount,
          i.total_amount - COALESCE(SUM(ra.amount), 0) as remaining_amount
   FROM invoices i
   LEFT JOIN receipt_allocations ra ON i.invoice_id = ra.invoice_id AND ra.is_deleted = false
   WHERE i.invoice_id = [invoice_id]
   AND i.is_deleted = false
   GROUP BY i.invoice_id, i.invoice_number, i.total_amount;
   ```

2. 特定期間の入金一覧
   ```
   SELECT * FROM receipts
   WHERE receipt_date BETWEEN [start_date] AND [end_date]
   AND is_deleted = false
   ORDER BY receipt_date DESC;
   ```

3. 入金IDによる割当情報の取得
   ```
   SELECT ra.*, i.invoice_number, i.total_amount
   FROM receipt_allocations ra
   JOIN invoices i ON ra.invoice_id = i.invoice_id
   WHERE ra.receipt_id = [receipt_id]
   AND ra.is_deleted = false
   AND i.is_deleted = false
   ORDER BY ra.created_at ASC;
   ```

4. 未入金・一部入金の請求一覧
   ```
   SELECT i.invoice_id, i.invoice_number, i.billing_date, i.payment_due_date,
          i.total_amount, COALESCE(SUM(ra.amount), 0) as paid_amount,
          i.total_amount - COALESCE(SUM(ra.amount), 0) as remaining_amount
   FROM invoices i
   LEFT JOIN receipt_allocations ra ON i.invoice_id = ra.invoice_id AND ra.is_deleted = false
   WHERE i.payment_status IN ('unpaid', 'partially_paid')
   AND i.is_deleted = false
   GROUP BY i.invoice_id, i.invoice_number, i.billing_date, i.payment_due_date, i.total_amount
   ORDER BY i.payment_due_date ASC;
   ```

5. 参照番号による入金検索
   ```
   SELECT * FROM receipts
   WHERE reference_number LIKE '%[reference_number]%'
   AND is_deleted = false
   ORDER BY receipt_date DESC;
   ```

### パフォーマンス最適化

- 請求IDによる検索は専用インデックスを利用
- 入金日による範囲検索は専用インデックスを利用
- 参照番号による検索は専用インデックスを利用
- 入金と割当の結合クエリの最適化
- 請求ごとの入金集計クエリの最適化

## データ整合性

### 入金額と割当額の整合性

1つの入金（receipt）に対する割当金額（receipt_allocations.amount）の合計は、入金額（receipts.amount）を超えてはならない。この整合性はアプリケーションロジックまたはデータベーストリガーによって保証されます。

```sql
-- 入金額と割当額の整合性チェック例
SELECT r.receipt_id, r.amount as receipt_amount, 
       COALESCE(SUM(ra.amount), 0) as total_allocated,
       r.amount - COALESCE(SUM(ra.amount), 0) as unallocated_amount
FROM receipts r
LEFT JOIN receipt_allocations ra ON r.receipt_id = ra.receipt_id AND ra.is_deleted = false
WHERE r.is_deleted = false
GROUP BY r.receipt_id, r.amount
HAVING r.amount < COALESCE(SUM(ra.amount), 0);
```

### 請求入金ステータスの整合性

請求の入金ステータス（invoices.payment_status）は、関連する入金割当の合計額と請求金額を比較して決定されます。この更新はアプリケーションロジックまたはデータベーストリガーによって実行されます。

```sql
-- 請求入金ステータスの更新ロジック例
UPDATE invoices i
SET payment_status = 
  CASE 
    WHEN allocated.total_amount IS NULL THEN 'unpaid'
    WHEN allocated.total_amount < i.total_amount THEN 'partially_paid'
    WHEN allocated.total_amount = i.total_amount THEN 'paid'
    WHEN allocated.total_amount > i.total_amount THEN 'overpaid'
  END,
  payment_date = 
  CASE 
    WHEN allocated.total_amount >= i.total_amount THEN allocated.last_receipt_date
    ELSE NULL
  END
FROM (
  SELECT ra.invoice_id, 
         SUM(ra.amount) as total_amount,
         MAX(r.receipt_date) as last_receipt_date
  FROM receipt_allocations ra
  JOIN receipts r ON ra.receipt_id = r.receipt_id
  WHERE ra.is_deleted = false
  AND r.is_deleted = false
  GROUP BY ra.invoice_id
) as allocated
WHERE i.invoice_id = allocated.invoice_id;
```

## 入金管理処理ロジック

### 入金登録プロセス

1. 入金情報（日付、金額、支払方法、参照番号など）を登録
2. 入金額を請求に割り当てる
   - 単一請求への割当: invoice_idを直接指定するか、receipt_allocationsに単一レコードを作成
   - 複数請求への割当: receipt_allocationsに複数レコードを作成
3. 割当後、関連する全ての請求の入金ステータスを更新

### 入金割当の自動提案

入金額が請求金額と完全に一致する場合、システムは対応する請求を自動的に提案します：

1. 参照番号または入金額から対応する請求を検索
2. 完全一致する請求があれば、その請求への割当を提案
3. 複数の候補がある場合、支払期限が最も早い請求を優先
4. 入金担当者が提案を確認・調整してから確定

### 入金割当の変更・修正

入金割当に誤りがあった場合、以下のプロセスで修正します：

1. 既存の割当を論理削除（is_deleted=true）
2. 新しい割当情報を登録
3. 関連する全ての請求の入金ステータスを再計算

## インターフェースポイント

- **請求管理機能**: 請求の入金ステータス管理と連動
- **銀行API連携**: 銀行入金情報の自動取込
- **会計システム連携**: 入金データの会計連携
- **通知機能**: 入金通知や未入金アラートの送信