# 請求支払管理モジュール概要

## ER図

以下のER図は請求支払管理モジュールの主要テーブル間の関連を示しています。

```mermaid
erDiagram
    INVOICES ||--o{ INVOICE_ITEMS : "contains"
    INVOICES ||--o{ RECEIPTS : "receives"
    RECEIPTS ||--o{ RECEIPT_ALLOCATIONS : "allocates"
    RECEIPT_ALLOCATIONS }|--|| INVOICES : "allocated to"
    PAYMENTS ||--o{ PAYMENT_ITEMS : "contains"
    PAYMENTS ||--o{ PAYMENT_APPROVALS : "requires"
    INVOICES }o--|| CUSTOMERS : "billed to"
    INVOICES }o--o| PROJECTS : "related to"
    INVOICES }o--o| CONTRACTS : "based on"
    PAYMENTS }o--o| COMPANIES : "paid to company"
    PAYMENTS }o--o| ENGINEERS : "paid to engineer"
    PAYMENTS }o--o| PROJECTS : "related to"
    PAYMENTS }o--o| CONTRACTS : "based on"
    PAYMENTS }o--o| INVOICES : "related to"
    BANK_ACCOUNTS }o--o| COMPANIES : "belongs to"
    BANK_ACCOUNTS }o--o| ENGINEERS : "belongs to"
    INVOICES }o--o| BANK_ACCOUNTS : "payment to"
    PAYMENTS }o--o| BANK_ACCOUNTS : "payment from"
    PAYMENT_APPROVALS }|--|| USERS : "approved by"
    
    INVOICES {
        uuid invoice_id PK
        varchar invoice_number UK
        uuid customer_id FK
        uuid project_id FK
        uuid contract_id FK
        integer billing_year
        integer billing_month
        date billing_date
        date payment_due_date
        decimal amount_before_tax
        decimal tax_amount
        decimal total_amount
        decimal tax_rate
        varchar billing_status
        varchar payment_status
        date payment_date
        varchar payment_method
        text billing_address
        uuid bank_account_id FK
        varchar invoice_file_path
        varchar receipt_file_path
        text notes
        uuid created_by
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    INVOICE_ITEMS {
        uuid invoice_item_id PK
        uuid invoice_id FK
        uuid engineer_id FK
        varchar item_type
        varchar item_name
        text description
        decimal quantity
        decimal unit_price
        decimal amount
        decimal tax_rate
        boolean taxable
        integer sort_order
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    PAYMENTS {
        uuid payment_id PK
        varchar payment_number UK
        uuid company_id FK
        uuid engineer_id FK
        uuid project_id FK
        uuid contract_id FK
        uuid invoice_id FK
        integer payment_year
        integer payment_month
        date issue_date
        date payment_date
        decimal amount_before_tax
        decimal tax_amount
        decimal total_amount
        decimal tax_rate
        varchar payment_status
        varchar payment_method
        uuid bank_account_id FK
        varchar payment_file_path
        text notes
        uuid approved_by
        timestamp approved_at
        uuid created_by
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    PAYMENT_ITEMS {
        uuid payment_item_id PK
        uuid payment_id FK
        varchar item_type
        varchar item_name
        text description
        decimal quantity
        decimal unit_price
        decimal amount
        decimal tax_rate
        boolean taxable
        integer sort_order
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    BANK_ACCOUNTS {
        uuid account_id PK
        varchar account_type
        uuid company_id FK
        uuid engineer_id FK
        varchar bank_name
        varchar branch_name
        varchar branch_code
        varchar account_number
        varchar account_name
        varchar account_name_kana
        varchar swift_code
        boolean is_default
        boolean is_active
        text notes
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    PAYMENT_APPROVALS {
        uuid approval_id PK
        uuid payment_id FK
        uuid approver_id FK
        varchar approver_role
        integer approval_order
        varchar status
        text comments
        timestamp approved_at
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    RECEIPTS {
        uuid receipt_id PK
        uuid invoice_id FK
        date receipt_date
        decimal amount
        varchar payment_method
        text reference_number
        text notes
        uuid created_by
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    RECEIPT_ALLOCATIONS {
        uuid allocation_id PK
        uuid receipt_id FK
        uuid invoice_id FK
        decimal amount
        text notes
        timestamp created_at
        timestamp updated_at
        boolean is_deleted
    }
    
    FINANCE_SETTINGS {
        uuid setting_id PK
        varchar setting_key UK
        text setting_value
        varchar setting_type
        text description
        boolean is_system
        timestamp created_at
        timestamp updated_at
        uuid updated_by
        boolean is_deleted
    }
    
    CUSTOMERS {
        uuid customer_id PK
    }
    
    PROJECTS {
        uuid project_id PK
    }
    
    CONTRACTS {
        uuid contract_id PK
    }
    
    COMPANIES {
        uuid company_id PK
    }
    
    ENGINEERS {
        uuid engineer_id PK
    }
    
    USERS {
        uuid user_id PK
    }
```

## スキーマ設計概要

請求支払管理モジュールは、顧客への請求業務と技術者・協力会社への支払業務を管理するためのデータモデルを提供します。このモジュールは以下のサブドメインで構成されています。

1. **請求管理**: 顧客への請求情報と請求明細情報の管理
2. **支払管理**: 技術者・協力会社への支払情報と支払明細情報の管理
3. **銀行口座管理**: 自社、顧客、技術者、協力会社の銀行口座情報の管理
4. **支払承認管理**: 支払承認ワークフローの管理
5. **入金管理**: 顧客からの入金情報と入金割当の管理
6. **財務設定管理**: 税率や支払条件などの財務設定の管理

### データフロー

1. 勤怠工数管理モジュールから承認された勤怠・工数データを取得
2. 契約管理モジュールから契約条件（単価など）を取得
3. 請求情報を生成（自動または手動）
4. 請求書を生成・発行・送付
5. 入金情報を登録・請求と紐づけ
6. 支払情報を生成（自動または手動）
7. 支払承認ワークフローに沿って承認処理
8. 支払処理の実行・記録

### 主なテーブル間の関連

- `invoices`テーブルは顧客への請求情報を保持し、`invoice_items`テーブルと1対多の関係
- `payments`テーブルは技術者・協力会社への支払情報を保持し、`payment_items`テーブルと1対多の関係
- `invoices`テーブルと`receipts`テーブルは1対多の関係で入金情報を管理
- `receipts`テーブルと`receipt_allocations`テーブルは1対多の関係で入金割当を管理
- `payments`テーブルと`payment_approvals`テーブルは1対多の関係で承認フローを管理
- `bank_accounts`テーブルは技術者または会社に紐づく銀行口座情報を保持

### データ整合性と制約

- 請求書番号・支払書番号の一意性保証
- 請求金額と入金額の整合性（入金割当の合計 = 請求金額）
- 支払承認ステップの順序整合性（順序の重複なし）
- 銀行口座情報の所有者一意性（技術者または会社のいずれか）
- 税率・金額の整合性（税抜金額 + 税額 = 合計金額）

### パフォーマンス最適化

- 請求・支払の年月による検索の最適化
- 請求・支払のステータスによる検索の最適化
- 顧客・案件・技術者・協力会社IDによる検索の最適化
- 期間（日付範囲）による検索の最適化
- 承認ステータスによる検索の最適化

### セキュリティ考慮事項

- 銀行口座情報の保護（暗号化または権限制御）
- 請求・支払金額の改ざん防止
- 承認フローのバイパス防止
- 変更履歴の追跡（監査証跡）
- ロールベースのアクセス制御

## インターフェースポイント

### 内部モジュールとの連携

- **契約管理モジュール**
  - 契約情報の参照（契約条件、単価情報など）
  - 契約に基づく請求・支払条件の取得

- **勤怠工数管理モジュール**
  - 承認済み勤怠・工数データの取得
  - 請求・支払計算の基礎データ利用

- **技術者管理モジュール**
  - 技術者情報の参照
  - 技術者銀行口座情報の参照

- **案件管理モジュール**
  - 案件情報の参照
  - 案件に紐づく契約・請求・支払情報の関連付け

- **共通機能モジュール**
  - ファイル管理（請求書・支払明細書のPDFなど）
  - 通知機能（請求書発行・支払承認通知など）
  - コード値管理（ステータスコードなど）

### 外部システム連携

- **会計システム**
  - 請求・入金・支払データの会計システム連携
  - 仕訳データの生成と連携

- **銀行システム**
  - 振込データ出力（全銀フォーマットなど）
  - 入金データ取込・照合

- **電子請求書ポータル**
  - インボイス制度対応
  - 電子請求書の発行と送信