# 銀行口座管理テーブル

銀行口座管理に関連するテーブルは、銀行口座情報（`bank_accounts`）テーブルで構成されます。

## bank_accounts（銀行口座情報）

振込先・振込元の銀行口座情報を管理するテーブルです。自社、顧客、パートナー会社、技術者それぞれの銀行口座情報を保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| account_id | uuid | NO | YES | - | - | 口座ID |
| account_type | varchar(20) | NO | NO | - | 'company' | 口座種別（company:自社, customer:顧客, partner:パートナー, engineer:技術者, other:その他） |
| company_id | uuid | YES | NO | companies.company_id | NULL | 会社ID（顧客またはパートナー会社） |
| engineer_id | uuid | YES | NO | engineers.engineer_id | NULL | 技術者ID |
| bank_name | varchar(100) | NO | NO | - | - | 銀行名 |
| branch_name | varchar(100) | NO | NO | - | - | 支店名 |
| branch_code | varchar(10) | YES | NO | - | NULL | 支店コード |
| account_number | varchar(20) | NO | NO | - | - | 口座番号 |
| account_name | varchar(100) | NO | NO | - | - | 口座名義 |
| account_name_kana | varchar(100) | YES | NO | - | NULL | 口座名義カナ |
| swift_code | varchar(20) | YES | NO | - | NULL | SWIFTコード |
| is_default | boolean | NO | NO | - | false | デフォルト口座フラグ |
| is_active | boolean | NO | NO | - | true | 有効フラグ |
| notes | text | YES | NO | - | NULL | 備考 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### チェック制約

1. 口座所有者の指定方法に関する制約
   ```
   CHECK (
     (account_type = 'company' AND company_id IS NULL AND engineer_id IS NULL) OR 
     (account_type = 'customer' AND company_id IS NOT NULL AND engineer_id IS NULL) OR 
     (account_type = 'partner' AND company_id IS NOT NULL AND engineer_id IS NULL) OR 
     (account_type = 'engineer' AND company_id IS NULL AND engineer_id IS NOT NULL) OR
     (account_type = 'other')
   )
   ```

2. 口座種別の値チェック
   ```
   CHECK (account_type IN ('company', 'customer', 'partner', 'engineer', 'other'))
   ```

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_bank_accounts_company_id | company_id | 会社IDによる検索用 |
| idx_bank_accounts_engineer_id | engineer_id | 技術者IDによる検索用 |
| idx_bank_accounts_account_type | account_type | 口座種別による検索用 |
| idx_bank_accounts_is_default | is_default | デフォルト口座検索用 |
| idx_bank_accounts_is_active | is_active | 有効口座検索用 |
| idx_bank_accounts_bank_branch | bank_name, branch_name | 銀行・支店名による検索用 |

### ビジネスルール

- 自社口座（account_type='company'）の場合は、company_id、engineer_idともにNULL
- 顧客口座（account_type='customer'）の場合は、company_idが必須でengineer_idはNULL
- パートナー口座（account_type='partner'）の場合は、company_idが必須でengineer_idはNULL
- 技術者口座（account_type='engineer'）の場合は、engineer_idが必須でcompany_idはNULL
- 同一所有者（会社または技術者）に対して、is_default=trueの口座は1つのみ設定可能
- 銀行口座情報の変更履歴は監査のために記録する
- 銀行名、支店名、口座番号、口座名義は必須
- 口座名義カナは日本国内の振込で使用
- SWIFTコードは国際送金で使用
- 削除された口座は関連する請求書や支払いに影響を与えないように論理削除（is_deleted=true）を使用

## クエリパターン

### 主要なクエリパターン

1. 会社IDによる口座情報の検索
   ```
   SELECT * FROM bank_accounts 
   WHERE company_id = [company_id] 
   AND is_active = true 
   AND is_deleted = false
   ORDER BY is_default DESC, created_at DESC;
   ```

2. 技術者IDによる口座情報の検索
   ```
   SELECT * FROM bank_accounts 
   WHERE engineer_id = [engineer_id] 
   AND is_active = true 
   AND is_deleted = false
   ORDER BY is_default DESC, created_at DESC;
   ```

3. 口座種別による口座情報の検索
   ```
   SELECT * FROM bank_accounts 
   WHERE account_type = [account_type] 
   AND is_active = true 
   AND is_deleted = false;
   ```

4. 会社または技術者のデフォルト口座の取得
   ```
   SELECT * FROM bank_accounts 
   WHERE (company_id = [company_id] OR engineer_id = [engineer_id]) 
   AND is_default = true 
   AND is_active = true 
   AND is_deleted = false;
   ```

5. 銀行名・支店名による口座検索
   ```
   SELECT * FROM bank_accounts 
   WHERE bank_name LIKE '%[search_term]%' 
   AND branch_name LIKE '%[search_term]%' 
   AND is_active = true 
   AND is_deleted = false;
   ```

### パフォーマンス最適化

- 会社ID、技術者IDによる検索は専用インデックスを利用
- 口座種別による検索は専用インデックスを利用
- デフォルト口座、有効口座の検索は専用インデックスを利用
- 銀行名・支店名による検索は複合インデックスを利用
- 頻繁にアクセスされる自社口座情報はキャッシュを検討

## データ整合性

### デフォルト口座の一意性

同一所有者（会社または技術者）に対して、デフォルト口座（is_default=true）は1つのみ設定可能です。この整合性はアプリケーションロジックまたはデータベーストリガーによって保証されます。

```sql
-- デフォルト口座の重複チェック例（会社の場合）
SELECT company_id, COUNT(*) 
FROM bank_accounts
WHERE company_id IS NOT NULL
AND is_default = true
AND is_active = true
AND is_deleted = false
GROUP BY company_id
HAVING COUNT(*) > 1;

-- デフォルト口座の重複チェック例（技術者の場合）
SELECT engineer_id, COUNT(*) 
FROM bank_accounts
WHERE engineer_id IS NOT NULL
AND is_default = true
AND is_active = true
AND is_deleted = false
GROUP BY engineer_id
HAVING COUNT(*) > 1;
```

### 所有者の整合性

口座種別（account_type）と所有者（company_id, engineer_id）の組み合わせが整合していることを確認します。

```sql
-- 所有者整合性チェック例
SELECT account_id, account_type, company_id, engineer_id
FROM bank_accounts
WHERE (
  (account_type = 'company' AND (company_id IS NOT NULL OR engineer_id IS NOT NULL)) OR
  (account_type = 'customer' AND (company_id IS NULL OR engineer_id IS NOT NULL)) OR
  (account_type = 'partner' AND (company_id IS NULL OR engineer_id IS NOT NULL)) OR
  (account_type = 'engineer' AND (company_id IS NOT NULL OR engineer_id IS NULL))
);
```

## セキュリティ考慮事項

銀行口座情報は機密性の高い情報であるため、以下のセキュリティ対策を実施します：

1. **アクセス制御**
   - 銀行口座情報へのアクセスは権限を持つユーザーのみに制限
   - 閲覧・編集・追加・削除の各操作に対して細かな権限制御を実施

2. **データ保護**
   - 口座番号などの機密情報は暗号化して保存を検討
   - API通信時は必ずTLS/SSLで暗号化
   - ログには口座情報の詳細を記録しない（マスキング処理）

3. **監査証跡**
   - 銀行口座情報の閲覧・変更履歴を記録
   - 誰がいつどのような変更を行ったかを追跡可能に

4. **データ表示制限**
   - UIでの口座番号表示は一部をマスク（例: **** 1234）
   - 口座情報のエクスポート・印刷機能は厳格に制限

## インターフェースポイント

- **請求管理機能**: 請求書の支払先口座情報として利用
- **支払管理機能**: 支払処理の振込先口座情報として利用
- **技術者管理モジュール**: 技術者の銀行口座情報として利用
- **パートナー管理モジュール**: パートナー会社の銀行口座情報として利用
- **顧客管理モジュール**: 顧客の銀行口座情報として利用
- **銀行API連携**: 振込データ生成時に口座情報を利用