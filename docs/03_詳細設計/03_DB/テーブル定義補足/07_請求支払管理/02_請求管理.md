# 請求管理テーブル

請求管理に関連するテーブルは、請求情報（`invoices`）と請求明細情報（`invoice_items`）の2つのテーブルで構成されます。

## invoices（請求情報）

顧客への請求情報を管理するテーブルです。請求書の基本情報、金額、ステータスなどを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| invoice_id | uuid | NO | YES | - | - | 請求ID |
| invoice_number | varchar(50) | NO | NO | - | - | 請求番号 |
| customer_id | uuid | NO | NO | customers.customer_id | - | 顧客ID |
| project_id | uuid | YES | NO | projects.project_id | NULL | 案件ID |
| contract_id | uuid | YES | NO | contracts.contract_id | NULL | 契約ID |
| billing_year | integer | NO | NO | - | - | 請求年 |
| billing_month | integer | NO | NO | - | - | 請求月 |
| billing_date | date | NO | NO | - | - | 請求日 |
| payment_due_date | date | NO | NO | - | - | 支払期限日 |
| amount_before_tax | decimal(12,2) | NO | NO | - | 0.00 | 税抜金額 |
| tax_amount | decimal(12,2) | NO | NO | - | 0.00 | 消費税額 |
| total_amount | decimal(12,2) | NO | NO | - | 0.00 | 合計金額 |
| tax_rate | decimal(5,2) | NO | NO | - | 10.00 | 消費税率(%) |
| billing_status | varchar(20) | NO | NO | - | 'draft' | 請求ステータス（draft:下書き, issued:発行済, approved:承認済, cancelled:キャンセル） |
| payment_status | varchar(20) | NO | NO | - | 'unpaid' | 入金ステータス（unpaid:未入金, partially_paid:一部入金, paid:入金済, overdue:遅延） |
| payment_date | date | YES | NO | - | NULL | 入金日 |
| payment_method | varchar(20) | YES | NO | - | 'bank_transfer' | 支払方法（bank_transfer:振込, direct_debit:引落, credit_card:カード決済, etc） |
| billing_address | text | YES | NO | - | NULL | 請求先住所 |
| bank_account_id | uuid | YES | NO | bank_accounts.account_id | NULL | 振込先口座ID |
| invoice_file_path | varchar(255) | YES | NO | - | NULL | 請求書ファイルパス |
| receipt_file_path | varchar(255) | YES | NO | - | NULL | 領収書ファイルパス |
| notes | text | YES | NO | - | NULL | 備考 |
| created_by | uuid | NO | NO | users.user_id | - | 作成者ID |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_invoices_invoice_number | invoice_number, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_invoices_invoice_number | invoice_number | 請求番号による検索用 |
| idx_invoices_customer_id | customer_id | 顧客IDによる検索用 |
| idx_invoices_project_id | project_id | 案件IDによる検索用 |
| idx_invoices_contract_id | contract_id | 契約IDによる検索用 |
| idx_invoices_billing_date | billing_date | 請求日による検索用 |
| idx_invoices_payment_due_date | payment_due_date | 支払期限日による検索用 |
| idx_invoices_billing_status | billing_status | 請求ステータスによる検索用 |
| idx_invoices_payment_status | payment_status | 入金ステータスによる検索用 |
| idx_invoices_billing_year_month | billing_year, billing_month | 請求年月による検索用 |

### ビジネスルール

- 請求番号は自動採番され、システム内で一意であること
- 請求ステータスの状態遷移は以下の順序に従う
  - draft → issued → approved → (paid/partially_paid)
  - draft/issued → cancelled
- 入金ステータスは入金情報に基づいて自動更新される
- 金額関連項目の整合性：total_amount = amount_before_tax + tax_amount
- tax_amount = amount_before_tax × (tax_rate ÷ 100) ※端数処理ルールあり
- 請求書ファイルは発行済（issued）以降のステータスで生成される
- 領収書ファイルは入金済（paid）ステータスのみ生成可能
- 承認済（approved）以降のステータスでは基本情報の編集不可

## invoice_items（請求明細情報）

請求書の明細項目を管理するテーブルです。明細ごとの品目、数量、単価、金額などを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| invoice_item_id | uuid | NO | YES | - | - | 請求明細ID |
| invoice_id | uuid | NO | NO | invoices.invoice_id | - | 請求ID |
| engineer_id | uuid | YES | NO | engineers.engineer_id | NULL | 技術者ID |
| item_type | varchar(20) | NO | NO | - | 'labor' | 項目タイプ（labor:人月, fixed:固定, variable:従量, expense:経費, other:その他） |
| item_name | varchar(100) | NO | NO | - | - | 項目名 |
| description | text | YES | NO | - | NULL | 詳細説明 |
| quantity | decimal(8,2) | NO | NO | - | 1.00 | 数量 |
| unit_price | decimal(12,2) | NO | NO | - | 0.00 | 単価 |
| amount | decimal(12,2) | NO | NO | - | 0.00 | 金額 |
| tax_rate | decimal(5,2) | NO | NO | - | 10.00 | 消費税率(%) |
| taxable | boolean | NO | NO | - | true | 課税対象フラグ |
| sort_order | integer | NO | NO | - | 0 | 表示順 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_invoice_items_invoice_id | invoice_id | 請求IDによる検索用 |
| idx_invoice_items_engineer_id | engineer_id | 技術者IDによる検索用 |
| idx_invoice_items_item_type | item_type | 項目タイプによる検索用 |

### ビジネスルール

- 明細金額の計算ルール：amount = quantity × unit_price
- 明細の数量は0より大きい値であること
- 明細の単価・金額は0以上の値であること
- 請求書の税抜金額は明細金額の合計と一致すること
- 課税対象フラグ（taxable）がfalseの場合、該当明細は消費税計算から除外
- 請求書が発行済（issued）以降のステータスの場合、明細の追加・編集・削除は制限される
- 技術者ID（engineer_id）が指定された明細は、技術者の作業実績に紐づく

## クエリパターン

### 主要なクエリパターン

1. 請求番号による請求情報の取得
   ```
   SELECT * FROM invoices WHERE invoice_number = [invoice_number] AND is_deleted = false;
   ```

2. 顧客IDと年月による請求情報の検索
   ```
   SELECT * FROM invoices 
   WHERE customer_id = [customer_id] 
   AND billing_year = [year] AND billing_month = [month] 
   AND is_deleted = false;
   ```

3. 請求ステータスによる請求情報の検索
   ```
   SELECT * FROM invoices 
   WHERE billing_status = [status] 
   AND is_deleted = false
   ORDER BY billing_date DESC;
   ```

4. 支払期限切れの未入金請求書の検索
   ```
   SELECT * FROM invoices 
   WHERE payment_status = 'unpaid' 
   AND payment_due_date < CURRENT_DATE 
   AND is_deleted = false
   ORDER BY payment_due_date ASC;
   ```

5. 請求IDによる明細情報の取得
   ```
   SELECT * FROM invoice_items 
   WHERE invoice_id = [invoice_id] 
   AND is_deleted = false
   ORDER BY sort_order ASC;
   ```

6. 技術者IDによる明細情報の検索
   ```
   SELECT i.invoice_number, i.billing_year, i.billing_month, it.* 
   FROM invoice_items it
   JOIN invoices i ON it.invoice_id = i.invoice_id
   WHERE it.engineer_id = [engineer_id] 
   AND it.is_deleted = false 
   AND i.is_deleted = false
   ORDER BY i.billing_year DESC, i.billing_month DESC;
   ```

### パフォーマンス最適化

- 請求番号検索は一意制約インデックスを利用して高速化
- 顧客ID、案件ID、契約IDによる検索は専用インデックスを利用
- 請求年月検索は複合インデックスを利用して高速化
- 請求ステータス、入金ステータスによる検索は専用インデックスを利用
- 請求情報と明細情報の結合クエリの最適化
- 大量データに対するページング処理の最適化

## データ整合性

### 請求情報と明細情報の整合性

請求情報の税抜金額（amount_before_tax）は、紐づく明細情報の金額（amount）の合計と一致する必要があります。この整合性はアプリケーションロジックまたはデータベーストリガーによって保証されます。

```sql
-- 税抜金額の整合性チェック例
SELECT i.invoice_id, i.amount_before_tax, SUM(it.amount) as total_item_amount
FROM invoices i
JOIN invoice_items it ON i.invoice_id = it.invoice_id
WHERE it.is_deleted = false
GROUP BY i.invoice_id, i.amount_before_tax
HAVING i.amount_before_tax <> SUM(it.amount);
```

### 消費税計算の整合性

消費税額（tax_amount）は、課税対象明細の合計金額に消費税率を乗じて計算されます。端数処理ルール（切り捨て、切り上げ、四捨五入など）は設定により変更可能です。

```sql
-- 消費税額計算例（課税対象明細のみ集計）
SELECT i.invoice_id, 
       i.tax_amount,
       ROUND(SUM(it.amount) * (i.tax_rate / 100), 0) as calculated_tax
FROM invoices i
JOIN invoice_items it ON i.invoice_id = it.invoice_id
WHERE it.is_deleted = false AND it.taxable = true
GROUP BY i.invoice_id, i.tax_amount, i.tax_rate;
```

### 合計金額の整合性

合計金額（total_amount）は、税抜金額（amount_before_tax）と消費税額（tax_amount）の合計と一致する必要があります。

```sql
-- 合計金額の整合性チェック例
SELECT invoice_id, amount_before_tax, tax_amount, total_amount
FROM invoices
WHERE amount_before_tax + tax_amount <> total_amount;
```

## インターフェースポイント

- **勤怠工数管理モジュール**: 承認済み勤怠・工数データを元に請求明細を生成
- **契約管理モジュール**: 契約条件（単価、請求サイクルなど）を参照して請求情報を生成
- **請求書管理機能**: 請求データを元に請求書ドキュメントを生成
- **入金管理機能**: 請求情報と入金情報の紐づけ
- **レポート生成機能**: 請求情報を集計してレポート生成