# 財務設定管理テーブル

財務設定管理に関連するテーブルは、財務設定情報（`finance_settings`）テーブルで構成されます。

## finance_settings（財務設定情報）

請求や支払に関する財務設定を管理するためのテーブルです。税率、支払条件、請求書テンプレートなどの設定情報を保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| setting_id | uuid | NO | YES | - | - | 設定ID |
| setting_key | varchar(100) | NO | NO | - | - | 設定キー |
| setting_value | text | YES | NO | - | NULL | 設定値 |
| setting_type | varchar(20) | NO | NO | - | 'string' | 設定値タイプ（string:文字列, integer:整数, decimal:小数, boolean:真偽値, json:JSON, date:日付） |
| description | text | YES | NO | - | NULL | 説明 |
| is_system | boolean | NO | NO | - | false | システム設定フラグ |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| updated_by | uuid | YES | NO | users.user_id | NULL | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### チェック制約

1. 設定値タイプの値チェック
   ```
   CHECK (setting_type IN ('string', 'integer', 'decimal', 'boolean', 'json', 'date'))
   ```

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_finance_settings_key | setting_key, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_finance_settings_key | setting_key | 設定キーによる検索用 |
| idx_finance_settings_type | setting_type | 設定値タイプによる検索用 |
| idx_finance_settings_is_system | is_system | システム設定フラグによる検索用 |

### ビジネスルール

- 設定キー（setting_key）はシステム内で一意であること
- 設定値タイプ（setting_type）に応じて、設定値（setting_value）のフォーマットを検証
  - integer: 整数値（例: "123"）
  - decimal: 小数値（例: "123.45"）
  - boolean: 真偽値（例: "true"/"false"）
  - json: 有効なJSON形式（例: `{"key": "value"}`）
  - date: 日付形式（例: "2025-05-01"）
- システム設定（is_system=true）は通常の運用では変更不可
- 設定値の変更は監査目的で記録（updated_by, updated_at）
- 論理削除により設定履歴を保持

## 主要な財務設定項目例

### 税率・課税関連設定

| 設定キー | 設定値タイプ | 説明 | デフォルト値例 |
|---------|------------|-----|-------------|
| tax.consumption_rate | decimal | 消費税率（％） | "10.00" |
| tax.reduced_rate | decimal | 軽減税率（％） | "8.00" |
| tax.rounding_method | string | 端数処理方法（round:四捨五入, floor:切り捨て, ceiling:切り上げ） | "floor" |
| tax.invoice_issuer_number | string | 適格請求書発行事業者番号 | "T1234567890123" |

### 請求関連設定

| 設定キー | 設定値タイプ | 説明 | デフォルト値例 |
|---------|------------|-----|-------------|
| invoice.payment_term_days | integer | デフォルト支払期限日数 | "30" |
| invoice.number_format | string | 請求番号フォーマット | "INV{YYYYMM}{SEQ:4}" |
| invoice.default_template | string | デフォルト請求書テンプレートID | "template_standard" |
| invoice.email_template | string | 請求書送付メールテンプレートID | "email_invoice_issue" |
| invoice.reminder_days | json | 未入金リマインド日数（配列） | "[7, 14, 21]" |

### 支払関連設定

| 設定キー | 設定値タイプ | 説明 | デフォルト値例 |
|---------|------------|-----|-------------|
| payment.number_format | string | 支払番号フォーマット | "PAY{YYYYMM}{SEQ:4}" |
| payment.default_payment_date | integer | デフォルト支払日（月内の日付） | "25" |
| payment.approval_threshold_low | decimal | 承認閾値（低）：この金額未満は1段階承認 | "100000" |
| payment.approval_threshold_high | decimal | 承認閾値（高）：この金額以上は3段階承認 | "1000000" |
| payment.bank_transfer_fee | decimal | 銀行振込手数料 | "770" |

### 財務計算・レポート関連設定

| 設定キー | 設定値タイプ | 説明 | デフォルト値例 |
|---------|------------|-----|-------------|
| finance.fiscal_year_start_month | integer | 会計年度開始月 | "4" |
| finance.report_currency | string | レポート通貨コード | "JPY" |
| finance.exchange_rate_source | string | 為替レートソース | "internal" |
| finance.accounting_system_export_format | string | 会計システム連携フォーマット | "csv_freee" |

## クエリパターン

### 主要なクエリパターン

1. 設定キーによる設定値の取得
   ```
   SELECT setting_value, setting_type FROM finance_settings
   WHERE setting_key = [setting_key]
   AND is_deleted = false;
   ```

2. 設定タイプによる設定値の一覧取得
   ```
   SELECT setting_key, setting_value, description
   FROM finance_settings
   WHERE setting_type = [setting_type]
   AND is_deleted = false
   ORDER BY setting_key;
   ```

3. システム設定の一覧取得
   ```
   SELECT setting_key, setting_value, setting_type, description
   FROM finance_settings
   WHERE is_system = true
   AND is_deleted = false
   ORDER BY setting_key;
   ```

4. 設定値の検索
   ```
   SELECT setting_key, setting_value, setting_type, description
   FROM finance_settings
   WHERE (setting_key LIKE '%[search_term]%' OR description LIKE '%[search_term]%')
   AND is_deleted = false
   ORDER BY setting_key;
   ```

5. 最近更新された設定の取得
   ```
   SELECT setting_key, setting_value, updated_at, updated_by
   FROM finance_settings
   WHERE is_deleted = false
   ORDER BY updated_at DESC
   LIMIT 10;
   ```

### パフォーマンス最適化

- 設定キーによる検索は一意制約インデックスを利用して高速化
- 設定値タイプによる検索は専用インデックスを利用
- システム設定フラグによる検索は専用インデックスを利用
- 頻繁にアクセスされる設定値はキャッシュを検討

## 設定値管理機能

### 設定値の型変換

設定値（setting_value）はテキスト形式で保存されますが、設定値タイプ（setting_type）に基づいて適切な型に変換して使用します。

```java
// 設定値の型変換例（擬似コード）
public Object getSettingValue(String key) {
    FinanceSetting setting = financeSettingRepository.findByKey(key);
    if (setting == null) return null;
    
    switch (setting.getSettingType()) {
        case "integer":
            return Integer.parseInt(setting.getSettingValue());
        case "decimal":
            return new BigDecimal(setting.getSettingValue());
        case "boolean":
            return Boolean.parseBoolean(setting.getSettingValue());
        case "json":
            return objectMapper.readValue(setting.getSettingValue(), Map.class);
        case "date":
            return LocalDate.parse(setting.getSettingValue());
        default: // string
            return setting.getSettingValue();
    }
}
```

### 設定値の検証

設定値の保存時には、設定値タイプに基づいて値の検証を行います。

```java
// 設定値の検証例（擬似コード）
public boolean validateSettingValue(String type, String value) {
    try {
        switch (type) {
            case "integer":
                Integer.parseInt(value);
                break;
            case "decimal":
                new BigDecimal(value);
                break;
            case "boolean":
                if (!value.equals("true") && !value.equals("false")) {
                    return false;
                }
                break;
            case "json":
                objectMapper.readValue(value, Object.class);
                break;
            case "date":
                LocalDate.parse(value);
                break;
            case "string":
                // 文字列の場合は特別な検証は不要
                break;
            default:
                return false;
        }
        return true;
    } catch (Exception e) {
        return false;
    }
}
```

### 設定値の変更履歴

重要な設定値の変更履歴を監査目的で記録します。

```sql
-- 設定値変更ログの記録例
CREATE TABLE finance_setting_history (
    history_id UUID PRIMARY KEY,
    setting_id UUID NOT NULL REFERENCES finance_settings(setting_id),
    setting_key VARCHAR(100) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    changed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    changed_by UUID REFERENCES users(user_id),
    change_reason TEXT
);
```

## インターフェースポイント

- **請求管理機能**: 税率、請求書番号フォーマット、支払条件などの設定を参照
- **支払管理機能**: 支払番号フォーマット、承認閾値、支払日などの設定を参照
- **レポート生成機能**: 会計年度、通貨設定などを参照
- **システム管理機能**: 設定値の管理・更新インターフェース