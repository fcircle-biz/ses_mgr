# 支払管理テーブル

支払管理に関連するテーブルは、支払情報（`payments`）と支払明細情報（`payment_items`）の2つのテーブルで構成されます。

## payments（支払情報）

パートナー会社や技術者への支払情報を管理するテーブルです。支払の基本情報、金額、ステータスなどを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| payment_id | uuid | NO | YES | - | - | 支払ID |
| payment_number | varchar(50) | NO | NO | - | - | 支払番号 |
| company_id | uuid | YES | NO | companies.company_id | NULL | 会社ID（パートナー会社） |
| engineer_id | uuid | YES | NO | engineers.engineer_id | NULL | 技術者ID |
| project_id | uuid | YES | NO | projects.project_id | NULL | 案件ID |
| contract_id | uuid | YES | NO | contracts.contract_id | NULL | 契約ID |
| invoice_id | uuid | YES | NO | invoices.invoice_id | NULL | 請求ID（バックマージン時） |
| payment_year | integer | NO | NO | - | - | 支払年 |
| payment_month | integer | NO | NO | - | - | 支払月 |
| issue_date | date | NO | NO | - | - | 発行日 |
| payment_date | date | NO | NO | - | - | 支払日 |
| amount_before_tax | decimal(12,2) | NO | NO | - | 0.00 | 税抜金額 |
| tax_amount | decimal(12,2) | NO | NO | - | 0.00 | 消費税額 |
| total_amount | decimal(12,2) | NO | NO | - | 0.00 | 合計金額 |
| tax_rate | decimal(5,2) | NO | NO | - | 10.00 | 消費税率(%) |
| payment_status | varchar(20) | NO | NO | - | 'draft' | 支払ステータス（draft:下書き, pending_approval:承認待ち, approved:承認済, processed:支払済, cancelled:キャンセル） |
| payment_method | varchar(20) | NO | NO | - | 'bank_transfer' | 支払方法（bank_transfer:振込, direct_deposit:口座振替, cash:現金, other:その他） |
| bank_account_id | uuid | YES | NO | bank_accounts.account_id | NULL | 振込先口座ID |
| payment_file_path | varchar(255) | YES | NO | - | NULL | 支払書類パス |
| notes | text | YES | NO | - | NULL | 備考 |
| approved_by | uuid | YES | NO | users.user_id | NULL | 承認者ID |
| approved_at | timestamp | YES | NO | - | NULL | 承認日時 |
| created_by | uuid | NO | NO | users.user_id | - | 作成者ID |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### チェック制約

1. 支払先は会社または技術者のどちらか一方のみ指定可能
   ```
   CHECK ((company_id IS NOT NULL AND engineer_id IS NULL) OR 
          (company_id IS NULL AND engineer_id IS NOT NULL))
   ```

2. 支払年月の範囲チェック
   ```
   CHECK (payment_year >= 2000 AND payment_year <= 2100)
   CHECK (payment_month >= 1 AND payment_month <= 12)
   ```

3. 支払ステータスの値チェック
   ```
   CHECK (payment_status IN ('draft', 'pending_approval', 'approved', 'processed', 'cancelled'))
   ```

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_payments_payment_number | payment_number, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_payments_payment_number | payment_number | 支払番号による検索用 |
| idx_payments_company_id | company_id | 会社IDによる検索用 |
| idx_payments_engineer_id | engineer_id | 技術者IDによる検索用 |
| idx_payments_project_id | project_id | 案件IDによる検索用 |
| idx_payments_contract_id | contract_id | 契約IDによる検索用 |
| idx_payments_invoice_id | invoice_id | 請求IDによる検索用 |
| idx_payments_issue_date | issue_date | 発行日による検索用 |
| idx_payments_payment_date | payment_date | 支払日による検索用 |
| idx_payments_payment_status | payment_status | 支払ステータスによる検索用 |
| idx_payments_payment_year_month | payment_year, payment_month | 支払年月による検索用 |

### ビジネスルール

- 支払番号は自動採番され、システム内で一意であること
- 支払先は、会社（company_id）または技術者（engineer_id）のどちらか一方のみ指定可能
- 支払ステータスの状態遷移は以下の順序に従う
  - draft → pending_approval → approved → processed
  - draft/pending_approval → cancelled
- 支払ステータスが承認済（approved）以降は基本情報の編集不可
- 金額関連項目の整合性：total_amount = amount_before_tax + tax_amount
- tax_amount = amount_before_tax × (tax_rate ÷ 100) ※端数処理ルールあり
- 支払処理済（processed）の場合は支払日（payment_date）が必須
- 承認済（approved）状態では承認者（approved_by）と承認日時（approved_at）が必須

## payment_items（支払明細情報）

支払情報の明細項目を管理するテーブルです。明細ごとの品目、数量、単価、金額などを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| payment_item_id | uuid | NO | YES | - | - | 支払明細ID |
| payment_id | uuid | NO | NO | payments.payment_id | - | 支払ID |
| item_type | varchar(20) | NO | NO | - | 'labor' | 項目タイプ（labor:人月, fixed:固定, variable:従量, expense:経費, other:その他） |
| item_name | varchar(100) | NO | NO | - | - | 項目名 |
| description | text | YES | NO | - | NULL | 詳細説明 |
| quantity | decimal(8,2) | NO | NO | - | 1.00 | 数量 |
| unit_price | decimal(12,2) | NO | NO | - | 0.00 | 単価 |
| amount | decimal(12,2) | NO | NO | - | 0.00 | 金額 |
| tax_rate | decimal(5,2) | NO | NO | - | 10.00 | 消費税率(%) |
| taxable | boolean | NO | NO | - | true | 課税対象フラグ |
| sort_order | integer | NO | NO | - | 0 | 表示順 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_payment_items_payment_id | payment_id | 支払IDによる検索用 |
| idx_payment_items_item_type | item_type | 項目タイプによる検索用 |

### ビジネスルール

- 明細金額の計算ルール：amount = quantity × unit_price
- 明細の数量は0より大きい値であること
- 明細の単価・金額は0以上の値であること
- 支払情報の税抜金額は明細金額の合計と一致すること
- 課税対象フラグ（taxable）がfalseの場合、該当明細は消費税計算から除外
- 支払ステータスが承認待ち（pending_approval）以降の場合、明細の追加・編集・削除は制限される

## クエリパターン

### 主要なクエリパターン

1. 支払番号による支払情報の取得
   ```
   SELECT * FROM payments WHERE payment_number = [payment_number] AND is_deleted = false;
   ```

2. 会社ID/技術者IDと年月による支払情報の検索
   ```
   SELECT * FROM payments 
   WHERE (company_id = [company_id] OR engineer_id = [engineer_id])
   AND payment_year = [year] AND payment_month = [month] 
   AND is_deleted = false;
   ```

3. 支払ステータスによる支払情報の検索
   ```
   SELECT * FROM payments 
   WHERE payment_status = [status] 
   AND is_deleted = false
   ORDER BY issue_date DESC;
   ```

4. 支払日範囲による支払情報の検索
   ```
   SELECT * FROM payments 
   WHERE payment_date BETWEEN [start_date] AND [end_date]
   AND payment_status = 'processed'
   AND is_deleted = false
   ORDER BY payment_date ASC;
   ```

5. 承認待ちの支払情報の取得
   ```
   SELECT * FROM payments
   WHERE payment_status = 'pending_approval'
   AND is_deleted = false
   ORDER BY issue_date ASC;
   ```

6. 支払IDによる明細情報の取得
   ```
   SELECT * FROM payment_items 
   WHERE payment_id = [payment_id] 
   AND is_deleted = false
   ORDER BY sort_order ASC;
   ```

### パフォーマンス最適化

- 支払番号検索は一意制約インデックスを利用して高速化
- 会社ID、技術者ID、案件ID、契約IDによる検索は専用インデックスを利用
- 支払年月検索は複合インデックスを利用して高速化
- 支払ステータスによる検索は専用インデックスを利用
- 支払情報と明細情報の結合クエリの最適化
- 大量データに対するページング処理の最適化

## データ整合性

### 支払情報と明細情報の整合性

支払情報の税抜金額（amount_before_tax）は、紐づく明細情報の金額（amount）の合計と一致する必要があります。この整合性はアプリケーションロジックまたはデータベーストリガーによって保証されます。

```sql
-- 税抜金額の整合性チェック例
SELECT p.payment_id, p.amount_before_tax, SUM(pi.amount) as total_item_amount
FROM payments p
JOIN payment_items pi ON p.payment_id = pi.payment_id
WHERE pi.is_deleted = false
GROUP BY p.payment_id, p.amount_before_tax
HAVING p.amount_before_tax <> SUM(pi.amount);
```

### 消費税計算の整合性

消費税額（tax_amount）は、課税対象明細の合計金額に消費税率を乗じて計算されます。端数処理ルール（切り捨て、切り上げ、四捨五入など）は設定により変更可能です。

```sql
-- 消費税額計算例（課税対象明細のみ集計）
SELECT p.payment_id, 
       p.tax_amount,
       ROUND(SUM(pi.amount) * (p.tax_rate / 100), 0) as calculated_tax
FROM payments p
JOIN payment_items pi ON p.payment_id = pi.payment_id
WHERE pi.is_deleted = false AND pi.taxable = true
GROUP BY p.payment_id, p.tax_amount, p.tax_rate;
```

### 合計金額の整合性

合計金額（total_amount）は、税抜金額（amount_before_tax）と消費税額（tax_amount）の合計と一致する必要があります。

```sql
-- 合計金額の整合性チェック例
SELECT payment_id, amount_before_tax, tax_amount, total_amount
FROM payments
WHERE amount_before_tax + tax_amount <> total_amount;
```

### 支払先の整合性

支払情報には会社（company_id）または技術者（engineer_id）のどちらか一方のみが指定されている必要があります。両方が指定されている、または両方が指定されていない状態は不正です。

```sql
-- 支払先整合性チェック例
SELECT payment_id, company_id, engineer_id
FROM payments
WHERE NOT ((company_id IS NOT NULL AND engineer_id IS NULL) OR 
           (company_id IS NULL AND engineer_id IS NOT NULL));
```

## インターフェースポイント

- **勤怠工数管理モジュール**: 承認済み勤怠・工数データを元に支払明細を生成
- **契約管理モジュール**: 契約条件（単価、支払サイクルなど）を参照して支払情報を生成
- **技術者/パートナー管理モジュール**: 技術者・パートナー会社情報を参照
- **銀行口座管理機能**: 支払先の銀行口座情報を取得
- **支払承認管理機能**: 支払情報の承認フローを管理