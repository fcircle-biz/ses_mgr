# 支払承認管理テーブル

支払承認管理に関連するテーブルは、支払承認フロー情報（`payment_approvals`）テーブルで構成されます。

## payment_approvals（支払承認フロー情報）

支払の承認フローを管理するためのテーブルです。支払情報の承認者、承認順序、承認ステータスなどを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| approval_id | uuid | NO | YES | - | - | 承認ID |
| payment_id | uuid | NO | NO | payments.payment_id | - | 支払ID |
| approver_id | uuid | NO | NO | users.user_id | - | 承認者ID |
| approver_role | varchar(50) | NO | NO | - | 'manager' | 承認者役割（manager:担当マネージャー, finance:経理担当, director:部門責任者, etc） |
| approval_order | integer | NO | NO | - | 1 | 承認順序 |
| status | varchar(20) | NO | NO | - | 'pending' | 承認ステータス（pending:未対応, approved:承認, rejected:差戻, hold:保留, skipped:スキップ） |
| comments | text | YES | NO | - | NULL | コメント |
| approved_at | timestamp | YES | NO | - | NULL | 承認日時 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### チェック制約

1. 承認順序は1以上の正の整数
   ```
   CHECK (approval_order >= 1)
   ```

2. 承認者役割の値チェック
   ```
   CHECK (approver_role IN ('manager', 'finance', 'director', 'ceo', 'other'))
   ```

3. 承認ステータスの値チェック
   ```
   CHECK (status IN ('pending', 'approved', 'rejected', 'hold', 'skipped'))
   ```

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_payment_approvals_payment_order | payment_id, approval_order, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_payment_approvals_payment_id | payment_id | 支払IDによる検索用 |
| idx_payment_approvals_approver_id | approver_id | 承認者IDによる検索用 |
| idx_payment_approvals_status | status | 承認ステータスによる検索用 |
| idx_payment_approvals_approved_at | approved_at | 承認日時による検索用 |

### ビジネスルール

- 同一支払IDに対する承認順序（approval_order）は重複不可
- 承認ステータスが変更されると、対応する支払情報（payments）のステータスも連動して更新される
- 承認（approved）または差戻（rejected）の場合、承認日時（approved_at）は必須
- コメント（comments）は任意だが、差戻（rejected）や保留（hold）の場合は推奨
- 承認フローは支払金額や支払先の種類によって異なる承認経路を設定可能
- 承認者がアクションを実行した後は、承認ステータスと承認日時は変更不可
- スキップ（skipped）は例外的なフロー変更時に使用（例: 承認者不在時）

## 承認フローの例

以下は一般的な承認フローの例です：

1. **少額支払（例: 10万円未満）**
   - 承認順序1: 担当マネージャー
   - 承認順序2: 経理担当

2. **中額支払（例: 10万円以上100万円未満）**
   - 承認順序1: 担当マネージャー
   - 承認順序2: 部門責任者
   - 承認順序3: 経理担当

3. **高額支払（例: 100万円以上）**
   - 承認順序1: 担当マネージャー
   - 承認順序2: 部門責任者
   - 承認順序3: CEO/役員
   - 承認順序4: 経理担当

## クエリパターン

### 主要なクエリパターン

1. 支払IDによる承認フロー情報の取得
   ```
   SELECT * FROM payment_approvals 
   WHERE payment_id = [payment_id] 
   AND is_deleted = false
   ORDER BY approval_order ASC;
   ```

2. 承認者IDによる未承認の承認タスク検索
   ```
   SELECT pa.*, p.payment_number, p.total_amount, 
          CASE WHEN e.engineer_id IS NOT NULL THEN e.name
               WHEN c.company_id IS NOT NULL THEN c.name
               ELSE NULL
          END as payee_name
   FROM payment_approvals pa
   JOIN payments p ON pa.payment_id = p.payment_id
   LEFT JOIN engineers e ON p.engineer_id = e.engineer_id
   LEFT JOIN companies c ON p.company_id = c.company_id
   WHERE pa.approver_id = [approver_id]
   AND pa.status = 'pending'
   AND p.payment_status = 'pending_approval'
   AND pa.is_deleted = false
   AND p.is_deleted = false
   ORDER BY p.issue_date ASC;
   ```

3. 承認フロー中の次の承認者の取得
   ```
   SELECT * FROM payment_approvals
   WHERE payment_id = [payment_id]
   AND status = 'pending'
   AND is_deleted = false
   ORDER BY approval_order ASC
   LIMIT 1;
   ```

4. 承認完了ステップ数の確認
   ```
   SELECT payment_id, COUNT(*) as total_steps, 
          SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approved_steps
   FROM payment_approvals
   WHERE payment_id = [payment_id]
   AND is_deleted = false
   GROUP BY payment_id;
   ```

5. 特定期間内の承認状況の集計
   ```
   SELECT status, COUNT(*) as count
   FROM payment_approvals
   WHERE approved_at BETWEEN [start_date] AND [end_date]
   AND is_deleted = false
   GROUP BY status;
   ```

### パフォーマンス最適化

- 支払IDによる検索は専用インデックスを利用
- 承認者IDによる検索は専用インデックスを利用
- 承認ステータスによる検索は専用インデックスを利用
- 承認日時による範囲検索は専用インデックスを利用
- 支払情報と承認情報の結合クエリの最適化
- 承認者別の未対応タスク検索の最適化

## 承認フロー処理ロジック

### 承認フロー作成プロセス

1. 支払情報が作成され、支払ステータスが「承認待ち（pending_approval）」になると承認フローが開始
2. 支払額や支払先タイプなどに基づいて適切な承認フローテンプレートを選択
3. テンプレートに従って、複数の承認ステップを作成
   - 各ステップには承認者（approver_id）、役割（approver_role）、承認順序（approval_order）を設定
   - 初期ステータスは全て「未対応（pending）」

### 承認処理ロジック

1. 承認者が承認タスク一覧から対象の支払を選択
2. 支払詳細と明細を確認
3. 承認（approve）、差戻（reject）、保留（hold）のいずれかを選択
   - 承認の場合: statusを「approved」に変更し、approved_atに現在時刻を設定
   - 差戻の場合: statusを「rejected」に変更し、approved_atに現在時刻を設定、commentsに差戻理由を記録
   - 保留の場合: statusを「hold」に変更し、commentsに保留理由を記録

4. 承認フロー状態の更新
   - 承認の場合: 次の承認ステップがあれば、支払ステータスは引き続き「承認待ち」、全ての承認が完了すれば「承認済」に更新
   - 差戻の場合: 支払ステータスを「下書き（draft）」に戻し、全ての未処理の承認ステップをリセット
   - 保留の場合: 支払ステータスはそのまま「承認待ち」

### 特殊なフロー制御

1. **承認者の代理**
   - 承認者が不在の場合、権限のある管理者が代理で承認可能
   - 代理承認の場合、commentsに代理承認であることを記録

2. **承認ステップのスキップ**
   - 例外的に特定の承認ステップをスキップする場合
   - statusを「skipped」に設定し、commentsにスキップ理由を記録
   - 管理者権限が必要な操作

3. **承認フローの変更**
   - 支払情報が大幅に修正された場合（金額変更など）
   - 既存の承認を全てキャンセルし、新たな承認フローを作成

## インターフェースポイント

- **支払管理機能**: 支払情報のステータス管理と連動
- **通知機能**: 承認依頼や承認結果の通知を送信
- **ユーザー管理モジュール**: 承認者情報の取得
- **権限管理モジュール**: 承認権限の確認