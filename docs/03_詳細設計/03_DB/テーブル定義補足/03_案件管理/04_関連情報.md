# 案件管理モジュール テーブル定義補足 - 関連情報

## 1. resource_requirement テーブル

resource_requirement テーブルは、案件に必要な技術者の要件を管理します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| requirement_id | bigint | NOT NULL | | 要件ID（主キー） |
| project_id | bigint | NOT NULL | | 案件ID（外部キー） |
| position_name | varchar(100) | NOT NULL | | ポジション名 |
| required_number | integer | NOT NULL | 1 | 必要人数 |
| job_type | varchar(50) | NOT NULL | | 職種（列挙型） |
| minimum_experience | integer | NULL | | 最低経験年数 |
| preferred_experience | integer | NULL | | 推奨経験年数 |
| description | text | NULL | | 詳細 |
| priority | varchar(20) | NOT NULL | 'MEDIUM' | 優先度（列挙型） |
| is_required | boolean | NOT NULL | true | 必須フラグ |
| status | varchar(20) | NOT NULL | 'OPEN' | 充足状態（列挙型） |
| assigned_engineer_id | bigint | NULL | | アサイン技術者ID（外部キー） |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| created_by | bigint | NOT NULL | | 作成者ID（外部キー） |
| updated_by | bigint | NOT NULL | | 更新者ID（外部キー） |

**制約:**
- PRIMARY KEY (requirement_id)
- FOREIGN KEY (project_id) REFERENCES project.project(project_id)
- FOREIGN KEY (assigned_engineer_id) REFERENCES engineer.engineer(engineer_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- FOREIGN KEY (updated_by) REFERENCES common.users(user_id)
- CHECK (required_number > 0)
- CHECK (preferred_experience IS NULL OR minimum_experience IS NULL OR preferred_experience >= minimum_experience)

**インデックス:**
- ix_resource_requirement_project_id (project_id)
- ix_resource_requirement_job_type (job_type)
- ix_resource_requirement_status (status)
- ix_resource_requirement_assigned_engineer_id (assigned_engineer_id)

### 1.2 列挙型項目

#### job_type（職種）
- PROGRAMMER: プログラマ
- SYSTEM_ENGINEER: システムエンジニア
- PROJECT_MANAGER: プロジェクトマネージャ
- INFRASTRUCTURE_ENGINEER: インフラエンジニア
- DATABASE_ENGINEER: データベースエンジニア
- NETWORK_ENGINEER: ネットワークエンジニア
- SECURITY_ENGINEER: セキュリティエンジニア
- DATA_SCIENTIST: データサイエンティスト
- QA_ENGINEER: QAエンジニア
- UI_UX_DESIGNER: UI/UXデザイナー
- TECHNICAL_SUPPORT: テクニカルサポート
- OTHER: その他

#### priority（優先度）
- HIGHEST: 最優先（5）
- HIGH: 高（4）
- MEDIUM: 中（3）
- LOW: 低（2）
- LOWEST: 最低（1）

#### status（充足状態）
- OPEN: 未充足
- IN_PROGRESS: 調整中
- ASSIGNED: アサイン済み
- CANCELED: キャンセル

### 1.3 特記事項

- **必要人数の制約**: required_number は1以上の整数である必要があります
- **経験年数の関係**: 推奨経験年数は、最低経験年数以上である必要があります
- **要員充足状態**: statusはマッチングやアサイン状況に応じて更新されます
- **アサイン関連**: assigned_engineer_id は技術者がアサインされた場合に設定され、status が ASSIGNED に更新されます

## 2. skill_requirement テーブル

skill_requirement テーブルは、要員要件に対するスキル条件を管理します。

### 2.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| skill_requirement_id | bigint | NOT NULL | | スキル要件ID（主キー） |
| resource_requirement_id | bigint | NOT NULL | | 要員要件ID（外部キー） |
| skill_definition_id | bigint | NOT NULL | | スキル定義ID（外部キー） |
| minimum_level | integer | NOT NULL | 1 | 最低スキルレベル(1-5) |
| preferred_level | integer | NULL | | 推奨スキルレベル(1-5) |
| is_required | boolean | NOT NULL | true | 必須フラグ |
| weight | integer | NOT NULL | 5 | 重み(1-10) |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**制約:**
- PRIMARY KEY (skill_requirement_id)
- FOREIGN KEY (resource_requirement_id) REFERENCES project.resource_requirement(requirement_id)
- FOREIGN KEY (skill_definition_id) REFERENCES engineer.skill_definition(skill_definition_id)
- CHECK (minimum_level BETWEEN 1 AND 5)
- CHECK (preferred_level IS NULL OR (preferred_level BETWEEN minimum_level AND 5))
- CHECK (weight BETWEEN 1 AND 10)
- UNIQUE (resource_requirement_id, skill_definition_id)

**インデックス:**
- ix_skill_requirement_resource_requirement_id (resource_requirement_id)
- ix_skill_requirement_skill_definition_id (skill_definition_id)
- ix_skill_requirement_min_level (skill_definition_id, minimum_level)

### 2.2 特記事項

- **スキルレベル**: 最低スキルレベルと推奨スキルレベルは1から5の整数値で表現します
- **必須スキル**: is_required がtrueのスキルは、マッチングにおいて必須条件として扱われます
- **重み付け**: weightはマッチングアルゴリズムにおけるスキルの重要度を表し、1から10の整数値で指定します
- **一意制約**: 同一要員要件に対して同一スキルの重複登録はできません

## 3. project_budget テーブル

project_budget テーブルは、案件の予算情報を管理します。

### 3.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| budget_id | bigint | NOT NULL | | 予算ID（主キー） |
| project_id | bigint | NOT NULL | | 案件ID（外部キー） |
| budget_type | varchar(20) | NOT NULL | | 予算種別（列挙型） |
| billing_type | varchar(30) | NOT NULL | | 請求種別（列挙型） |
| amount | numeric(12,2) | NOT NULL | | 金額 |
| currency | varchar(3) | NOT NULL | 'JPY' | 通貨コード |
| unit_amount | numeric(12,2) | NULL | | 単価 |
| tax_rate | numeric(5,2) | NOT NULL | 10.00 | 税率 |
| start_date | date | NOT NULL | | 適用開始日 |
| end_date | date | NOT NULL | | 適用終了日 |
| remarks | varchar(500) | NULL | | 備考 |
| is_confidential | boolean | NOT NULL | true | 機密フラグ |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| created_by | bigint | NOT NULL | | 作成者ID（外部キー） |
| updated_by | bigint | NOT NULL | | 更新者ID（外部キー） |

**制約:**
- PRIMARY KEY (budget_id)
- FOREIGN KEY (project_id) REFERENCES project.project(project_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- FOREIGN KEY (updated_by) REFERENCES common.users(user_id)
- CHECK (amount >= 0)
- CHECK (unit_amount IS NULL OR unit_amount >= 0)
- CHECK (tax_rate BETWEEN 0 AND 100)
- CHECK (end_date >= start_date)

**インデックス:**
- ix_project_budget_project_id (project_id)
- ix_project_budget_date_range (project_id, start_date, end_date)
- ix_project_budget_budget_type (budget_type)

### 3.2 列挙型項目

#### budget_type（予算種別）
- TOTAL: 総額
- MONTHLY: 月額
- DAILY: 日額
- HOURLY: 時間単価

#### billing_type（請求種別）
- FIXED: 固定
- TIME_AND_MATERIAL: T&M（実績に応じた精算）
- MILESTONE: マイルストーン
- SUBSCRIPTION: サブスクリプション

#### currency（通貨コード）
- JPY: 日本円
- USD: 米ドル
- EUR: ユーロ
- GBP: 英ポンド
- CNY: 中国元

### 3.3 特記事項

- **請求種別と単価**: billing_type が TIME_AND_MATERIAL の場合、unit_amount（単価）の設定が必要です
- **適用期間**: 同一案件に対して期間が重複する複数の予算レコードを登録可能ですが、アプリケーション層で整合性を検証します
- **機密情報**: is_confidential がtrueの予算情報は、権限のあるユーザーのみアクセス可能です

## 4. project_document テーブル

project_document テーブルは、案件に関連するドキュメントを管理します。

### 4.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| document_id | bigint | NOT NULL | | ドキュメントID（主キー） |
| project_id | bigint | NOT NULL | | 案件ID（外部キー） |
| document_type | varchar(20) | NOT NULL | | ドキュメント種別（列挙型） |
| title | varchar(200) | NOT NULL | | タイトル |
| description | varchar(500) | NULL | | 説明 |
| file_id | bigint | NOT NULL | | ファイルID（外部キー） |
| version | varchar(20) | NULL | | バージョン |
| is_confidential | boolean | NOT NULL | false | 機密フラグ |
| is_active | boolean | NOT NULL | true | 有効フラグ |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| created_by | bigint | NOT NULL | | 作成者ID（外部キー） |
| updated_by | bigint | NOT NULL | | 更新者ID（外部キー） |

**制約:**
- PRIMARY KEY (document_id)
- FOREIGN KEY (project_id) REFERENCES project.project(project_id)
- FOREIGN KEY (file_id) REFERENCES common.file(file_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- FOREIGN KEY (updated_by) REFERENCES common.users(user_id)
- UNIQUE (project_id, document_type, title, version) WHERE is_active = true

**インデックス:**
- ix_project_document_project_id (project_id)
- ix_project_document_document_type (document_type)
- ix_project_document_file_id (file_id)

### 4.2 列挙型項目

#### document_type（ドキュメント種別）
- RFP: 提案依頼書
- PROPOSAL: 提案書
- SPECIFICATION: 仕様書
- CONTRACT: 契約書
- REPORT: 報告書
- MINUTES: 議事録
- OTHER: その他

### 4.3 特記事項

- **バージョン管理**: 同一タイトルのドキュメントでもバージョンが異なれば別レコードとして登録可能です
- **論理削除**: ドキュメントの削除は is_active フラグを false にすることで論理削除として扱います
- **機密文書**: is_confidential フラグがtrueのドキュメントは、権限のあるユーザーのみアクセス可能です
- **ファイル実体**: ファイルの実体は common.file テーブルで管理され、file_id でリンクされます

## 5. クエリパターンと最適化

### 5.1 要員・スキル要件の検索パターン

1. **案件別の要員要件一覧**
   - 特定案件の全要員要件とそのスキル要件を取得
   - `resource_requirement.project_id` および `skill_requirement.resource_requirement_id` インデックスを活用

2. **職種別の要員要件検索**
   - 特定職種の要員要件を検索
   - `resource_requirement.job_type` インデックスを活用

3. **スキル条件によるマッチング検索**
   - 特定スキルを必要とする要員要件を検索
   - `skill_requirement.skill_definition_id` インデックスを活用

4. **充足状態による絞り込み**
   - 未充足の要員要件のみを表示
   - `resource_requirement.status` インデックスを活用

### 5.2 予算関連の検索パターン

1. **案件別予算情報取得**
   - 特定案件の予算情報を取得
   - `project_budget.project_id` インデックスを活用

2. **期間指定での予算検索**
   - 特定期間に有効な予算情報を検索
   - `project_budget.date_range` 複合インデックスを活用

3. **予算種別による集計**
   - 予算種別ごとの案件数や金額を集計
   - `project_budget.budget_type` インデックスを活用

### 5.3 ドキュメント関連の検索パターン

1. **案件別ドキュメント一覧**
   - 特定案件の全ドキュメントを取得
   - `project_document.project_id` インデックスを活用

2. **ドキュメント種別による検索**
   - 特定種別のドキュメントを検索
   - `project_document.document_type` インデックスを活用

### 5.4 パフォーマンス最適化施策

1. **要員要件とスキル要件の結合最適化**
   - 頻繁に実行される要員要件とスキル要件の結合クエリに対する最適化
   - 場合によっては統計情報の収集頻度を調整

2. **ドキュメント検索の最適化**
   - 全文検索機能の導入を検討
   - ドキュメントメタデータの効率的な検索インデックス設計

3. **大量データの効率的な処理**
   - 長期間利用に伴うデータ量増加に対応するパーティショニング戦略
   - 非アクティブデータのアーカイブ方針の策定

## 6. 運用時の注意点

1. **機密情報のアクセス制御**
   - 予算情報やドキュメントなどの機密情報については、適切なアクセス制御を実装する必要があります
   - アプリケーション層での権限チェックに加え、データベース側でも行レベルセキュリティの導入を検討

2. **要員要件の変更履歴管理**
   - 要員要件やスキル要件の重要な変更については、監査ログやイベント履歴を残すことが望ましい
   - 特に外部連携やマッチングに影響する変更は追跡可能に

3. **大量データのパフォーマンス**
   - 案件数の増加に伴い、各関連テーブルのデータ量も増加するため、定期的なパフォーマンス分析と最適化が必要
   - 特にマッチング処理など、複雑なクエリのパフォーマンスに注意