# 案件管理モジュール テーブル定義補足 - ステータス管理

## 1. project_status テーブル

project_status テーブルは、案件のライフサイクル上の状態を定義します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| status_id | bigint | NOT NULL | | ステータスID（主キー） |
| status_code | varchar(50) | NOT NULL | | ステータスコード |
| status_name | varchar(100) | NOT NULL | | ステータス名 |
| description | varchar(500) | NULL | | 説明 |
| display_order | integer | NOT NULL | 0 | 表示順 |
| is_active | boolean | NOT NULL | true | 有効フラグ |
| color | varchar(7) | NULL | | 表示色（HEX形式） |
| allowed_next_statuses | varchar(500) | NULL | | 遷移可能な次ステータス（カンマ区切り） |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**制約:**
- PRIMARY KEY (status_id)
- UNIQUE (status_code)
- CHECK (display_order >= 0)
- CHECK (color IS NULL OR color ~ '^#[0-9A-Fa-f]{6}$')

**インデックス:**
- ix_project_status_display_order (display_order)

### 1.2 標準ステータス値

テーブルの初期データとして、以下のステータスが定義されます：

| status_code | status_name | display_order | color | allowed_next_statuses |
|------------|------------|---------------|-------|-----------------------|
| DRAFT | 下書き | 10 | #CCCCCC | OPEN,CANCELED |
| OPEN | 公開中 | 20 | #66CC66 | PROPOSAL,HOLD,CLOSED,CANCELED |
| PROPOSAL | 提案中 | 30 | #66AAFF | NEGOTIATION,HOLD,CLOSED,CANCELED |
| NEGOTIATION | 交渉中 | 40 | #FFCC66 | CONTRACT,HOLD,CLOSED,CANCELED |
| CONTRACT | 契約中 | 50 | #FF9966 | INPROGRESS,HOLD,CANCELED |
| INPROGRESS | 進行中 | 60 | #FF6666 | COMPLETED,HOLD,CANCELED |
| COMPLETED | 完了 | 70 | #9966FF | CLOSED |
| CLOSED | 終了 | 80 | #999999 | | 
| HOLD | 保留中 | 90 | #FFFF66 | OPEN,PROPOSAL,NEGOTIATION,CONTRACT,INPROGRESS,CANCELED |
| CANCELED | 取消 | 100 | #FF0000 | | 

### 1.3 特記事項

- **ステータス遷移制御**: allowed_next_statuses 列を使用して、ステータス遷移の制約を定義します。遷移制御はアプリケーション層でも実装します。
- **ステータスの追加・変更**: ステータスの追加・変更は管理者のみが実行できるよう、権限制御を行います。
- **表示順の管理**: display_order によりUI上での表示順序を制御します。
- **表示色の管理**: color はUI上でのステータス表示色を定義します。HEX形式（#RRGGBB）で指定します。

## 2. project_status_history テーブル

project_status_history テーブルは、案件のステータス変更履歴を記録します。

### 2.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| history_id | bigint | NOT NULL | | 履歴ID（主キー） |
| project_id | bigint | NOT NULL | | 案件ID（外部キー） |
| previous_status_id | bigint | NULL | | 前ステータスID（外部キー） |
| new_status_id | bigint | NOT NULL | | 新ステータスID（外部キー） |
| change_reason | varchar(500) | NULL | | 変更理由 |
| changed_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 変更日時 |
| changed_by | bigint | NOT NULL | | 変更者ID（外部キー） |

**制約:**
- PRIMARY KEY (history_id)
- FOREIGN KEY (project_id) REFERENCES project.project(project_id)
- FOREIGN KEY (previous_status_id) REFERENCES project.project_status(status_id)
- FOREIGN KEY (new_status_id) REFERENCES project.project_status(status_id)
- FOREIGN KEY (changed_by) REFERENCES common.users(user_id)

**インデックス:**
- ix_project_status_history_project_id (project_id)
- ix_project_status_history_changed_at (changed_at)
- ix_project_status_history_previous_new (previous_status_id, new_status_id)

### 2.2 特記事項

- **初回ステータス**: 案件の初回登録時はprevious_status_idはnullとなります。
- **変更理由の記録**: 重要なステータス変更（例：契約中→取消）時には変更理由の入力を必須とするなど、アプリケーション層で制御します。
- **履歴データの増加**: 履歴データは継続的に増加するため、必要に応じてパーティショニングやアーカイブを検討します。

## 3. ステータス管理機能の処理フロー

### 3.1 ステータス変更処理

1. **変更前検証**: 
   - 現在のステータスから次のステータスへの遷移が allowed_next_statuses に基づいて許可されているか検証
   - ステータス変更に必要な条件（例：契約書添付済み）を満たしているか検証

2. **ステータス更新**: 
   - project テーブルの status_id を更新
   - project_status_history テーブルに履歴レコードを追加

3. **関連処理の実行**: 
   - ステータス変更に伴う通知の送信
   - ステータスに応じたワークフロー処理の実行

### 3.2 ステータス毎の特殊処理

| ステータス変更 | 特殊処理 |
|--------------|--------|
| DRAFT → OPEN | 公開フラグをtrueに設定、検索エンジンにインデックス登録 |
| * → CONTRACT | 契約情報の整合性チェック、契約モジュールとの連携処理 |
| * → COMPLETED | 完了日の記録、評価情報の収集開始 |
| * → CLOSED | 関連リソースの解放、アーカイブ処理の準備 |
| * → CANCELED | 関連する提案・契約のキャンセル処理、理由の必須記録 |

## 4. クエリパターンと最適化

### 4.1 ステータス関連の主要クエリパターン

1. **案件のステータス遷移履歴取得**
   - 特定案件のステータス変更履歴を時系列で取得
   - `project_id` と `changed_at` のインデックスを活用

2. **特定ステータス間の遷移件数集計**
   - 例：「提案中」から「契約中」に遷移した案件数の集計（成約率分析）
   - `previous_status_id` と `new_status_id` の複合インデックスを活用

3. **ステータス別の案件数集計**
   - ステータス別の案件数をダッシュボード表示
   - project テーブルの `status_id` インデックスを活用

4. **特定期間内のステータス変更分析**
   - 期間内のステータス変化パターンを分析
   - `changed_at` インデックスを活用

### 4.2 パフォーマンス最適化施策

1. **履歴テーブルのパーティショニング**
   - 時系列（年月単位）でのパーティショニングにより、大量の履歴データを効率的に管理

2. **集計テーブルの活用**
   - ダッシュボード表示用の集計データをバッチ処理で事前計算し、専用テーブルに格納

3. **キャッシュ戦略**
   - ステータス定義など、頻繁に参照されるがほとんど変更されないデータはアプリケーションレベルでキャッシュ

## 5. ステータス管理に関する運用時の注意点

1. **ステータスマスタの変更影響**
   - ステータスコード・名称変更時は、関連する画面・帳票・APIなどへの影響を確認
   - 遷移ルールの変更は既存データへの影響を考慮して慎重に実施

2. **ステータス追加時の考慮事項**
   - 新ステータス追加時は、既存のステータスフローとの整合性を確保
   - 関連するビジネスロジック・レポートなどの修正も並行して実施

3. **履歴データの肥大化対策**
   - 長期間経過したステータス履歴データのアーカイブ方針を策定
   - レポーティング用途と監査証跡用途での保持期間バランスを考慮