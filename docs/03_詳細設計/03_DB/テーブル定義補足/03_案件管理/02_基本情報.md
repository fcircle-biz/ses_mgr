# 案件管理モジュール テーブル定義補足 - 基本情報

## 1. project テーブル

project テーブルは案件の基本情報を管理する中心的なテーブルです。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| project_id | bigint | NOT NULL | | 案件ID（主キー） |
| project_code | varchar(20) | NOT NULL | | 案件コード（例: P-20250511-0001） |
| project_name | varchar(200) | NOT NULL | | 案件名 |
| customer_id | bigint | NOT NULL | | 顧客ID（外部キー） |
| customer_department_id | bigint | NULL | | 顧客部署ID（外部キー） |
| description | text | NOT NULL | | 案件概要 |
| project_type | varchar(50) | NOT NULL | | 案件種別（列挙型） |
| project_category | varchar(50) | NOT NULL | | 案件区分（列挙型） |
| start_date | date | NOT NULL | | 開始日 |
| end_date | date | NOT NULL | | 終了日 |
| work_location | varchar(100) | NOT NULL | | 勤務地 |
| work_style | varchar(50) | NOT NULL | | 勤務形態（列挙型） |
| status_id | bigint | NOT NULL | | ステータスID（外部キー） |
| priority | varchar(20) | NOT NULL | 'MEDIUM' | 優先度（列挙型） |
| confidential_level | varchar(20) | NOT NULL | 'PUBLIC' | 機密レベル（列挙型） |
| is_public | boolean | NOT NULL | true | 公開フラグ |
| sales_rep_id | bigint | NOT NULL | | 営業担当者ID（外部キー） |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| created_by | bigint | NOT NULL | | 作成者ID（外部キー） |
| updated_by | bigint | NOT NULL | | 更新者ID（外部キー） |

**制約:**
- PRIMARY KEY (project_id)
- UNIQUE (project_code)
- FOREIGN KEY (customer_id) REFERENCES customer.customer(customer_id)
- FOREIGN KEY (customer_department_id) REFERENCES customer.customer_department(department_id)
- FOREIGN KEY (status_id) REFERENCES project.project_status(status_id)
- FOREIGN KEY (sales_rep_id) REFERENCES common.users(user_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- FOREIGN KEY (updated_by) REFERENCES common.users(user_id)
- CHECK (end_date > start_date)

**インデックス:**
- ix_project_customer_id (customer_id)
- ix_project_status_id (status_id)
- ix_project_start_date (start_date)
- ix_project_end_date (end_date)
- ix_project_priority (priority)
- ix_project_type_category (project_type, project_category)
- ix_project_work_location (work_location)
- ix_project_sales_rep_id (sales_rep_id)

### 1.2 列挙型項目

#### project_type（案件種別）
- NEW_DEVELOPMENT: 新規開発
- ENHANCEMENT: 機能追加・改修
- MAINTENANCE: 保守運用
- MIGRATION: 移行
- CONSULTING: コンサルティング
- TESTING: テスト業務
- TRAINING: 研修・教育
- OTHER: その他

#### project_category（案件区分）
- SYSTEM_INTEGRATION: システムインテグレーション
- SOFTWARE_DEVELOPMENT: ソフトウェア開発
- INFRASTRUCTURE: インフラ構築・運用
- DATA_ANALYSIS: データ分析・BI
- SECURITY: セキュリティ
- QUALITY_ASSURANCE: 品質保証
- SUPPORT: サポート・ヘルプデスク
- OTHER: その他

#### work_style（勤務形態）
- ONSITE: オンサイト
- REMOTE: リモート
- HYBRID: ハイブリッド
- FLEXIBLE: 柔軟対応可

#### priority（優先度）
- HIGHEST: 最優先（5）
- HIGH: 高（4）
- MEDIUM: 中（3）
- LOW: 低（2）
- LOWEST: 最低（1）

#### confidential_level（機密レベル）
- PUBLIC: 公開（社内全体に公開可能）
- INTERNAL: 社内（関連部署のみ）
- CONFIDENTIAL: 機密（担当者のみ）
- RESTRICTED: 制限（特定の権限者のみ）

### 1.3 特記事項

- **案件コード生成ルール**: 「P-」+「登録日(YYYYMMDD)」+「連番4桁」の形式で自動生成
- **アクセス制御**: confidential_level と is_public フラグに基づき、案件へのアクセス権限を制御
- **案件期間の妥当性検証**: start_date と end_date の関係は、データベース制約とアプリケーション層の両方で検証
- **履歴管理**: 案件基本情報の変更履歴は別途監査テーブルで管理

## 2. project_member テーブル

project_member テーブルは、案件に関わる担当者（営業、PM等）を管理します。

### 2.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| member_id | bigint | NOT NULL | | 担当者ID（主キー） |
| project_id | bigint | NOT NULL | | 案件ID（外部キー） |
| user_id | bigint | NOT NULL | | ユーザーID（外部キー） |
| role_type | varchar(50) | NOT NULL | | 役割タイプ（列挙型） |
| is_main_contact | boolean | NOT NULL | false | 主担当フラグ |
| start_date | date | NOT NULL | | 担当開始日 |
| end_date | date | NULL | | 担当終了日 |
| remarks | varchar(500) | NULL | | 備考 |
| is_active | boolean | NOT NULL | true | 有効フラグ |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**制約:**
- PRIMARY KEY (member_id)
- FOREIGN KEY (project_id) REFERENCES project.project(project_id)
- FOREIGN KEY (user_id) REFERENCES common.users(user_id)
- CHECK (end_date IS NULL OR end_date > start_date)
- UNIQUE (project_id, user_id, role_type, start_date) WHERE is_active = true

**インデックス:**
- ix_project_member_project_id (project_id)
- ix_project_member_user_id (user_id)
- ix_project_member_role_type (role_type)
- ix_project_member_main_contact (project_id, role_type, is_main_contact) WHERE is_main_contact = true AND is_active = true

### 2.2 列挙型項目

#### role_type（役割タイプ）
- SALES_REP: 営業担当
- PROJECT_MANAGER: プロジェクトマネージャー
- ACCOUNT_MANAGER: アカウントマネージャー
- DELIVERY_MANAGER: デリバリーマネージャー
- TECHNICAL_LEAD: テクニカルリード
- SUPPORT: サポート

### 2.3 特記事項

- **主担当の一意性**: 同一案件・同一役割タイプでの主担当は1人のみというビジネスルールをアプリケーション層でも検証
- **担当期間の重複チェック**: 同一案件・同一ユーザー・同一役割の担当期間が重複しないようにアプリケーション層でチェック
- **論理削除**: 担当者の削除は is_active フラグによる論理削除を基本とし、物理削除は原則行わない

## 3. クエリパターンと最適化

### 3.1 案件基本情報の検索パターン

案件検索は以下のパターンが高頻度で実行されるため、対応するインデックスを設定しています。

1. **ステータスによる検索**
   - 未提案案件、進行中案件など、ステータスによる絞り込み検索が頻繁に行われます
   - `status_id` に対するインデックスを活用

2. **期間による検索**
   - 特定期間内に開始/終了する案件の検索
   - `start_date`, `end_date` に対するインデックスを活用

3. **顧客別の案件検索**
   - 特定顧客の案件一覧表示
   - `customer_id` に対するインデックスを活用

4. **営業担当者別の案件検索**
   - 担当営業による案件一覧表示
   - `sales_rep_id` に対するインデックスを活用

5. **種別・区分による検索**
   - 案件種別や区分による絞り込み
   - `project_type`, `project_category` の複合インデックスを活用

6. **勤務地による検索**
   - 勤務地による絞り込み
   - `work_location` に対するインデックスを活用

### 3.2 担当者関連の検索パターン

1. **ユーザー別担当案件検索**
   - ユーザーが担当する案件の一覧表示
   - `user_id` に対するインデックスを活用

2. **役割別担当者検索**
   - 特定の役割の担当者を持つ案件の検索
   - `role_type` に対するインデックスを活用

3. **主担当者検索**
   - 各案件の主担当者を取得
   - `is_main_contact` を含む複合インデックスを活用

### 3.3 パフォーマンス最適化施策

1. **キャッシュ戦略**
   - 頻繁にアクセスされる案件情報やマスタ情報（ステータス等）はアプリケーションレベルでキャッシュ

2. **データ量増加対策**
   - 案件テーブルは年度単位でのパーティショニングを将来的に検討
   - 案件ステータス履歴は時系列でのパーティショニングを検討

3. **複雑なソート対応**
   - 複数条件での並べ替えを効率化するために必要に応じて複合インデックスを追加