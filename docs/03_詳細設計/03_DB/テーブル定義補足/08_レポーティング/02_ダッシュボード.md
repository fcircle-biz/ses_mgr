# ダッシュボード関連テーブル

ダッシュボード関連テーブルは、ダッシュボード設定（`dashboards`）とダッシュボードウィジェット（`widgets`）の2つのテーブルで構成されます。

## dashboards（ダッシュボード設定）

ユーザー別のダッシュボード設定を管理するテーブルです。ダッシュボードの名前、レイアウト、公開設定などを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| dashboard_id | uuid | NO | YES | - | - | ダッシュボードID |
| name | varchar(100) | NO | NO | - | - | ダッシュボード名 |
| user_id | uuid | NO | NO | users.user_id | - | 所有ユーザーID |
| dashboard_type | varchar(20) | NO | NO | - | 'personal' | ダッシュボード種別（personal:個人, team:チーム, system:システム） |
| layout_config | jsonb | NO | NO | - | '{}' | レイアウト設定 |
| is_default | boolean | NO | NO | - | false | デフォルト設定フラグ |
| is_public | boolean | NO | NO | - | false | 公開フラグ |
| description | varchar(500) | YES | NO | - | NULL | 説明 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | users.user_id | - | 作成者ID |
| updated_by | uuid | NO | NO | users.user_id | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_dashboards_user_id | user_id | ユーザーIDによる検索用 |
| idx_dashboards_dashboard_type | dashboard_type | ダッシュボード種別による検索用 |
| idx_dashboards_is_default | is_default | デフォルト設定検索用 |
| idx_dashboards_is_public | is_public | 公開設定検索用 |

### ビジネスルール

- ダッシュボード名は同一ユーザー内で一意であること
- ユーザーごとにデフォルトのダッシュボードは1つのみ設定可能
- 公開設定されたダッシュボードは他ユーザーが参照可能
- システム種別のダッシュボードは管理者のみ作成・編集可能
- レイアウト設定はグリッドベースで、ウィジェットの位置・サイズを定義
- ダッシュボードを削除すると、関連するウィジェットも論理削除される

### layout_config JSONBの構造例

```json
{
  "gridSize": { "cols": 12, "rows": 10 },
  "gridGap": 10,
  "background": "#f5f5f5",
  "autoSave": true,
  "mobileLayout": "stack",
  "refreshInterval": 300
}
```

## widgets（ダッシュボードウィジェット）

ダッシュボード上に配置される可視化コンポーネントを管理するテーブルです。ウィジェットの種類、データソース、表示設定などを保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| widget_id | uuid | NO | YES | - | - | ウィジェットID |
| dashboard_id | uuid | NO | NO | dashboards.dashboard_id | - | ダッシュボードID |
| title | varchar(100) | NO | NO | - | - | ウィジェットタイトル |
| widget_type | varchar(30) | NO | NO | - | - | ウィジェット種別（kpi_card, line_chart, bar_chart, pie_chart, table, heat_map, gauge, counter, text, alert） |
| data_source_id | uuid | NO | NO | data_sources.data_source_id | - | データソースID |
| query_config | jsonb | NO | NO | - | '{}' | クエリ設定 |
| display_config | jsonb | NO | NO | - | '{}' | 表示設定 |
| position_config | jsonb | NO | NO | - | '{}' | 位置・サイズ設定 |
| refresh_interval | integer | NO | NO | - | 0 | 更新間隔(秒) |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_widgets_dashboard_id | dashboard_id | ダッシュボードIDによる検索用 |
| idx_widgets_widget_type | widget_type | ウィジェット種別による検索用 |
| idx_widgets_data_source_id | data_source_id | データソースIDによる検索用 |

### ビジネスルール

- ウィジェットは必ず1つのダッシュボードに所属する
- ウィジェット種別によって必要な設定項目が異なる
- 位置設定はグリッド座標で指定（x, y, width, height）
- データソースID、クエリ設定は必須（テキストウィジェットなど一部例外あり）
- 更新間隔が0の場合は自動更新しない
- ダッシュボードが削除された場合、関連するウィジェットも論理削除される

### JSON構造例

#### query_config の例（KPIカード）

```json
{
  "kpiCode": "SALES_MONTHLY",
  "periodType": "MONTH",
  "compareTo": "PREVIOUS_PERIOD",
  "filters": [
    { "field": "department_id", "operator": "=", "value": "DEPT001" }
  ]
}
```

#### display_config の例（折れ線グラフ）

```json
{
  "chartTitle": "月次売上推移",
  "xAxisLabel": "月",
  "yAxisLabel": "売上額（万円）",
  "showLegend": true,
  "legendPosition": "bottom",
  "colors": ["#4CAF50", "#2196F3", "#FFC107"],
  "showDataLabels": false,
  "showGrid": true,
  "animation": true,
  "tooltipFormat": "売上: {value}万円"
}
```

#### position_config の例

```json
{
  "x": 0,
  "y": 0,
  "width": 6,
  "height": 4,
  "minWidth": 2,
  "minHeight": 2,
  "maxWidth": 12,
  "maxHeight": 8
}
```

## クエリパターン

### 主要なクエリパターン

1. ユーザーIDによるダッシュボード一覧取得
   ```
   SELECT * FROM dashboards 
   WHERE user_id = [user_id] 
   AND is_deleted = false
   ORDER BY is_default DESC, created_at DESC;
   ```

2. 公開ダッシュボード一覧取得
   ```
   SELECT * FROM dashboards 
   WHERE is_public = true 
   AND is_deleted = false
   ORDER BY name;
   ```

3. ユーザーのデフォルトダッシュボード取得
   ```
   SELECT * FROM dashboards 
   WHERE user_id = [user_id] 
   AND is_default = true 
   AND is_deleted = false
   LIMIT 1;
   ```

4. ダッシュボードIDによるウィジェット一覧取得
   ```
   SELECT * FROM widgets 
   WHERE dashboard_id = [dashboard_id] 
   AND is_deleted = false;
   ```

5. ウィジェット種別による検索
   ```
   SELECT * FROM widgets 
   WHERE widget_type = [widget_type] 
   AND is_deleted = false;
   ```

6. 特定データソースを使用するウィジェット検索
   ```
   SELECT w.*, d.name as dashboard_name
   FROM widgets w
   JOIN dashboards d ON w.dashboard_id = d.dashboard_id
   WHERE w.data_source_id = [data_source_id]
   AND w.is_deleted = false
   AND d.is_deleted = false;
   ```

### パフォーマンス最適化

- ユーザーIDによる検索は専用インデックスを利用
- ダッシュボードIDによるウィジェット検索は専用インデックスを利用
- 頻繁にアクセスされるダッシュボード・ウィジェットデータのキャッシュを検討
- ウィジェットのデータ取得時に必要なカラムのみを選択
- データソースクエリの結果キャッシュを実装

## データ整合性

### ダッシュボードとウィジェットの整合性

ダッシュボードが削除された場合、関連するウィジェットも論理削除する必要があります。これは、アプリケーションロジックまたはデータベーストリガーによって実現します。

```sql
-- ダッシュボード削除時のウィジェット論理削除例（トリガー関数）
CREATE OR REPLACE FUNCTION delete_dashboard_widgets()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.is_deleted = true AND OLD.is_deleted = false THEN
        UPDATE widgets
        SET is_deleted = true,
            updated_at = CURRENT_TIMESTAMP
        WHERE dashboard_id = NEW.dashboard_id
        AND is_deleted = false;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### デフォルトダッシュボードの整合性

ユーザーごとにデフォルトダッシュボードは1つのみ存在するよう、整合性を保証する必要があります。

```sql
-- デフォルトダッシュボード設定時の整合性確保例（トリガー関数）
CREATE OR REPLACE FUNCTION ensure_single_default_dashboard()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.is_default = true AND OLD.is_default = false THEN
        UPDATE dashboards
        SET is_default = false,
            updated_at = CURRENT_TIMESTAMP
        WHERE user_id = NEW.user_id
        AND dashboard_id <> NEW.dashboard_id
        AND is_default = true
        AND is_deleted = false;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

## インターフェースポイント

- **ユーザー管理モジュール**: ダッシュボードの所有者、アクセス権限の管理
- **KPI管理機能**: KPIウィジェットのデータソース
- **データソース管理機能**: ウィジェットのデータソース設定
- **レポート管理機能**: ダッシュボードからレポート表示、ウィジェットのレポート連携