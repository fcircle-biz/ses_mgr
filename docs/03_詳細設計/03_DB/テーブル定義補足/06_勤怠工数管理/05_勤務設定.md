# 勤務設定テーブル

勤務設定に関連するテーブルは、勤務設定情報（`work_settings`）と休日カレンダー（`holidays`）および勤怠関連通知（`attendance_notifications`）の3つのテーブルで構成されます。

## work_settings（勤務設定情報）

技術者と案件の組み合わせごとの勤務条件を管理するためのテーブルです。所定労働時間や勤務曜日、デフォルトの勤務時間などを設定します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| setting_id | uuid | NO | YES | - | - | 設定ID |
| engineer_id | uuid | NO | NO | engineers.engineer_id | - | 技術者ID |
| project_id | uuid | NO | NO | projects.project_id | - | 案件ID |
| regular_work_hours | decimal(4,2) | NO | NO | - | 8.00 | 1日あたり所定労働時間 |
| start_date | date | NO | NO | - | - | 適用開始日 |
| end_date | date | YES | NO | - | NULL | 適用終了日（NULL=無期限） |
| working_days | varchar(20) | NO | NO | - | '1,2,3,4,5' | 勤務曜日（1=月曜, 2=火曜, ..., 7=日曜） |
| default_start_time | time | YES | NO | - | '09:00:00' | デフォルト開始時間 |
| default_end_time | time | YES | NO | - | '18:00:00' | デフォルト終了時間 |
| default_break_hours | decimal(4,2) | YES | NO | - | 1.00 | デフォルト休憩時間（時間） |
| auto_input | boolean | NO | NO | - | false | 自動入力フラグ |
| remarks | text | YES | NO | - | NULL | 備考 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_work_settings_engineer_id | engineer_id | 技術者IDによる検索用 |
| idx_work_settings_project_id | project_id | 案件IDによる検索用 |
| idx_work_settings_date_range | start_date, end_date | 期間による検索用 |

### ビジネスルール

- 同一技術者・同一案件・同一期間に重複する設定を登録できない
- 適用期間（start_date, end_date）は案件の契約期間内である必要がある
- 勤務曜日はカンマ区切りの数値で、各数値は1〜7の範囲内（1=月曜, 7=日曜）
- regular_work_hoursは0より大きい値である必要がある
- auto_input=trueの場合、勤怠情報が自動的に生成される
- 勤務設定が有効な間は、関連する月次・日次勤怠情報の入力テンプレートとして機能する

## holidays（休日カレンダー）

休日情報を管理するためのテーブルです。法定休日、会社休日などを登録し、勤怠管理に活用します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| holiday_id | uuid | NO | YES | - | - | 休日ID |
| holiday_date | date | NO | NO | - | - | 休日日付 |
| holiday_name | varchar(100) | NO | NO | - | - | 休日名称 |
| holiday_type | varchar(20) | NO | NO | - | 'national' | 休日種別（national:法定休日, company:会社休日, client:クライアント休日） |
| target_project_id | uuid | YES | NO | projects.project_id | NULL | 対象案件ID（NULLの場合は全案件対象） |
| description | text | YES | NO | - | NULL | 説明 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_holidays_date_type_project | holiday_date, holiday_type, target_project_id, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_holidays_date | holiday_date | 日付による検索用 |
| idx_holidays_type | holiday_type | 休日種別による検索用 |
| idx_holidays_target_project_id | target_project_id | 対象案件IDによる検索用 |

### ビジネスルール

- 同一日付、同一休日種別、同一対象案件の休日は重複して登録できない
- 法定休日（national）は基本的にtarget_project_idがNULL（全案件対象）
- クライアント休日（client）は、特定の案件に紐づく休日情報
- 休日情報は勤怠入力の自動化および工数計算の基礎情報として利用される
- 休日種別により残業計算やコスト計算のルールが異なる場合がある

## attendance_notifications（勤怠関連通知）

勤怠・工数管理に関連する通知情報を管理するためのテーブルです。タイムシート提出リマインダーや承認依頼などの通知を保存します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| notification_id | uuid | NO | YES | - | - | 通知ID |
| notification_type | varchar(50) | NO | NO | - | - | 通知種別（timesheet_reminder, approval_request, etc） |
| user_id | uuid | NO | NO | users.user_id | - | ユーザーID |
| title | varchar(200) | NO | NO | - | - | タイトル |
| content | text | YES | NO | - | NULL | 内容 |
| related_id | uuid | YES | NO | - | NULL | 関連ID（月次勤怠ID、承認フローIDなど） |
| is_read | boolean | NO | NO | - | false | 既読フラグ |
| read_at | timestamp | YES | NO | - | NULL | 既読日時 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_attendance_notifications_user_id | user_id | ユーザーIDによる検索用 |
| idx_attendance_notifications_type | notification_type | 通知種別による検索用 |
| idx_attendance_notifications_is_read | is_read | 既読フラグによる検索用 |
| idx_attendance_notifications_related_id | related_id | 関連IDによる検索用 |
| idx_attendance_notifications_created_at | created_at | 作成日時による検索用 |

### ビジネスルール

- 通知は特定のユーザーに対して送信される
- 通知は作成されたらすぐに配信される（プッシュ通知、メール通知などと連携）
- 通知が閲覧されると既読フラグがtrueに設定され、既読日時が記録される
- 通知種別により表示方法やアクション方法が異なる
- 一定期間経過後の通知は自動的にアーカイブされる

## クエリパターン

### 主要なクエリパターン

1. 技術者IDと案件IDによる勤務設定検索
   ```
   技術者ID = [engineer_id] AND 案件ID = [project_id] AND 
   適用開始日 <= [target_date] AND (適用終了日 IS NULL OR 適用終了日 >= [target_date]) AND 
   is_deleted = false
   ```

2. 日付範囲による休日検索
   ```
   休日日付 BETWEEN [start_date] AND [end_date] AND 
   (対象案件ID IS NULL OR 対象案件ID = [project_id]) AND
   is_deleted = false
   ```

3. ユーザーIDによる未読通知検索
   ```
   ユーザーID = [user_id] AND 既読フラグ = false AND is_deleted = false
   ORDER BY 作成日時 DESC
   ```

4. 通知種別による通知検索
   ```
   通知種別 = [notification_type] AND ユーザーID = [user_id] AND is_deleted = false
   ORDER BY 作成日時 DESC
   ```

5. 関連IDによる通知検索
   ```
   関連ID = [related_id] AND is_deleted = false
   ```

### パフォーマンス最適化

- 勤務設定の日付範囲検索を最適化するためのインデックス作成
- 休日カレンダーの日付検索を効率化するためのインデックス作成
- ユーザー別の通知一覧取得を高速化するためのインデックス作成
- 通知テーブルの定期的なアーカイブ処理による性能維持

## 勤務設定の応用

### 勤務パターンの自動適用

勤務設定に基づいて、以下の自動処理が可能です：

1. 所定労働日の自動判定
   - 勤務曜日（working_days）と休日カレンダーに基づいて勤務日を判定
   - 月次のカレンダー生成時に活用

2. デフォルト値の自動適用
   - 日次勤怠情報の新規作成時にデフォルト値を適用
   - 開始時間、終了時間、休憩時間などを自動設定

3. 残業時間の自動計算
   - 所定労働時間（regular_work_hours）を超える勤務時間を残業として自動計算
   - 休日出勤の場合は別途計算ルールを適用

### 勤務実績の集計・分析

1. 稼働率の計算
   - 所定労働時間に対する実際の工数の割合を計算
   - プロジェクト別、技術者別、期間別の稼働率を集計

2. 勤務パターンの分析
   - 出退勤時間のパターン分析
   - 残業傾向の分析
   - 休暇取得パターンの分析

## データ整合性

- 勤務設定の期間は案件の契約期間内である必要がある
- 勤務曜日の値は1〜7の範囲内であることを検証
- 休日情報は重複して登録できない（同一日付、同一種別、同一対象案件）
- 通知の関連IDは、実際に存在するリソース（月次勤怠情報など）を参照する必要がある
- トリガーまたはアプリケーションロジックにより、関連テーブル間の整合性を維持