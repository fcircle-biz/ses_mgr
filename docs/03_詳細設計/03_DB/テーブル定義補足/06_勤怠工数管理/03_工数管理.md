# 工数管理テーブル

工数管理に関連するテーブルは、作業工数情報（`work_hours`）テーブルで構成されます。

## work_hours（作業工数情報）

技術者の日ごとの案件別作業工数を管理するためのテーブルです。どの案件に対してどれだけの時間を費やしたかを記録し、請求可能工数の管理を行います。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| work_hour_id | uuid | NO | YES | - | - | 工数ID |
| daily_attendance_id | uuid | NO | NO | daily_attendances.daily_attendance_id | - | 日次勤怠ID |
| project_id | uuid | NO | NO | projects.project_id | - | 案件ID |
| task_name | varchar(200) | YES | NO | - | NULL | タスク名 |
| task_category | varchar(50) | YES | NO | - | NULL | タスク区分 |
| work_hours | decimal(4,2) | NO | NO | - | 0.00 | 作業時間（時間） |
| billable | boolean | NO | NO | - | true | 請求可否フラグ |
| billable_reason | varchar(100) | YES | NO | - | NULL | 請求可否理由（billable=falseの場合） |
| remarks | text | YES | NO | - | NULL | 備考 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_work_hours_daily_attendance_id | daily_attendance_id | 日次勤怠IDによる検索用 |
| idx_work_hours_project_id | project_id | 案件IDによる検索用 |
| idx_work_hours_billable | billable | 請求可否フラグによる検索用 |
| idx_work_hours_task_category | task_category | タスク区分による検索用 |

### ビジネスルール

- 日次勤怠情報に紐づく工数情報の合計時間は、日次勤怠情報の勤務時間を超えてはならない
- 1日の勤務内容を複数の案件やタスクに分けて記録可能
- 契約条件に基づき、工数の請求可否を管理（研修時間、移動時間、不具合対応時間など）
- 請求不可（billable=false）の場合は、その理由を記録
- 月次勤怠情報の状態が承認中（in_progress）または承認済（approved）の場合、関連する工数情報は編集不可
- 作業時間は0より大きい値である必要がある

## データモデルの関連性

### 上位関連

工数情報（`work_hours`）は日次勤怠情報（`daily_attendances`）に従属し、日次勤怠情報は月次勤怠情報（`monthly_attendances`）に従属します。この階層構造により、勤怠と工数のデータを効率的に管理できます。

```
monthly_attendances (月次勤怠情報)
  └── daily_attendances (日次勤怠情報)
        └── work_hours (作業工数情報)
```

### 外部モジュールとの関連

- **案件管理モジュール**: `project_id`を通じて案件情報と関連付け
- **請求支払管理モジュール**: 承認済みの工数データを請求書作成の元データとして利用
- **レポーティングモジュール**: 工数データを集計・分析してレポート生成に利用

## クエリパターン

### 主要なクエリパターン

1. 日次勤怠IDによる工数情報の取得
   ```
   日次勤怠ID = [daily_attendance_id] AND is_deleted = false
   ```

2. 案件IDと期間による工数集計
   ```
   案件ID = [project_id] AND 日次勤怠ID IN (
     SELECT daily_attendance_id FROM daily_attendances
     WHERE 勤務日 BETWEEN [start_date] AND [end_date]
   ) AND is_deleted = false
   ```

3. 技術者IDと期間による工数集計
   ```
   日次勤怠ID IN (
     SELECT daily_attendance_id FROM daily_attendances
     WHERE monthly_attendance_id IN (
       SELECT monthly_attendance_id FROM monthly_attendances
       WHERE 技術者ID = [engineer_id] AND 対象年 = [year] AND 対象月 = [month]
     )
   ) AND is_deleted = false
   ```

4. 請求可能工数の集計
   ```
   請求可否フラグ = true AND 案件ID = [project_id] AND is_deleted = false
   ```

5. タスク区分別の工数集計
   ```
   タスク区分 = [task_category] AND is_deleted = false
   ```

### パフォーマンス最適化

- 日次勤怠IDおよび案件IDによる検索を最適化するためのインデックス作成
- 請求可否フラグでフィルタリングするクエリのためのインデックス作成
- 月次・プロジェクト単位での集計クエリのパフォーマンス向上のため、必要に応じて集計テーブルの導入を検討
- 大量のデータに対する集計処理を効率化するためのクエリチューニング

## データ整合性

- 日次勤怠情報に紐づく工数情報の合計時間は、日次勤怠情報の勤務時間と一致する必要がある
- 案件が存在しない場合、その案件IDを持つ工数情報は登録できない
- 日次勤怠情報が存在しない場合、その日次勤怠IDを持つ工数情報は登録できない
- 工数情報の作業時間は、契約で定められた上限を超えてはならない
- トリガーまたはアプリケーションロジックにより、関連テーブル間の整合性を維持

## 運用上の考慮事項

### データ量と成長率

- 1人の技術者が1日に複数の工数情報を登録可能
- 平均的な技術者あたりの月間レコード数：約20件（日次勤怠）× 2件（1日あたりの工数情報）= 40件/月
- 年間成長率：技術者数の増加に比例

### バックアップと復旧

- 請求の根拠となるデータのため、厳格なバックアップ体制が必要
- 承認済みデータの変更は監査ログを残し、変更履歴を追跡可能にする

### アーカイブ戦略

- 過去の工数データは、一定期間（例：3年）経過後にアーカイブテーブルに移動
- アーカイブデータは参照のみ可能とし、変更不可とする