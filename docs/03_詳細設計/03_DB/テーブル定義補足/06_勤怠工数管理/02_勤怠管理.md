# 勤怠管理テーブル

勤怠管理に関連するテーブルは、月次勤怠情報（`monthly_attendances`）と日次勤怠情報（`daily_attendances`）の2つのテーブルで構成されます。

## monthly_attendances（月次勤怠情報）

技術者の月単位の勤怠情報を管理するためのテーブルです。月次のタイムシート作成および承認フローのベースとなります。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| monthly_attendance_id | uuid | NO | YES | - | - | 月次勤怠ID |
| engineer_id | uuid | NO | NO | engineers.engineer_id | - | 技術者ID |
| target_year | integer | NO | NO | - | - | 対象年 |
| target_month | integer | NO | NO | - | - | 対象月（1-12） |
| status | varchar(20) | NO | NO | - | 'draft' | 状態（draft:下書き, submitted:提出済, in_progress:承認中, approved:承認済, rejected:却下） |
| total_regular_hours | decimal(6,2) | YES | NO | - | 0.00 | 合計所定時間 |
| total_overtime_hours | decimal(6,2) | YES | NO | - | 0.00 | 合計残業時間 |
| total_billable_hours | decimal(6,2) | YES | NO | - | 0.00 | 合計請求可能時間 |
| submitted_at | timestamp | YES | NO | - | NULL | 提出日時 |
| remarks | text | YES | NO | - | NULL | 備考 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_monthly_attendances_engineer_year_month | engineer_id, target_year, target_month, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_monthly_attendances_engineer_id | engineer_id | 技術者IDによる検索用 |
| idx_monthly_attendances_status | status | ステータスによる検索用 |
| idx_monthly_attendances_year_month | target_year, target_month | 年月による検索用 |
| idx_monthly_attendances_submitted_at | submitted_at | 提出日時による検索用 |

### ビジネスルール

- 同一技術者の同一年月のレコードは重複して登録できない
- 月次勤怠情報の状態遷移は以下の順序に従う
  - draft → submitted → in_progress → approved/rejected
  - rejected → draft（再提出可能）
- 承認済みの月次勤怠情報は、特別な権限を持つユーザーのみが編集可能
- total_regular_hours, total_overtime_hours, total_billable_hoursは関連する日次勤怠情報から計算される
- 月次勤怠情報が承認されると、関連する日次勤怠情報も確定される

## daily_attendances（日次勤怠情報）

技術者の日ごとの勤怠情報を管理するためのテーブルです。出退勤時間、休憩時間、勤務場所などの情報を保持します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| daily_attendance_id | uuid | NO | YES | - | - | 日次勤怠ID |
| monthly_attendance_id | uuid | NO | NO | monthly_attendances.monthly_attendance_id | - | 月次勤怠ID |
| attendance_date | date | NO | NO | - | - | 勤務日 |
| start_time | time | YES | NO | - | NULL | 開始時間 |
| end_time | time | YES | NO | - | NULL | 終了時間 |
| break_hours | decimal(4,2) | YES | NO | - | 0.00 | 休憩時間（時間） |
| working_hours | decimal(4,2) | YES | NO | - | 0.00 | 勤務時間（時間） |
| overtime_hours | decimal(4,2) | YES | NO | - | 0.00 | 残業時間（時間） |
| working_location | varchar(100) | YES | NO | - | 'office' | 勤務場所（office:オフィス, client:クライアント先, home:在宅, etc） |
| attendance_type | varchar(20) | NO | NO | - | 'regular' | 勤務種別（regular:通常勤務, holiday:休日出勤, absence:欠勤, paid_leave:有給休暇, etc） |
| remarks | text | YES | NO | - | NULL | 備考 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_daily_attendances_monthly_att_date | monthly_attendance_id, attendance_date, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_daily_attendances_monthly_attendance_id | monthly_attendance_id | 月次勤怠IDによる検索用 |
| idx_daily_attendances_attendance_date | attendance_date | 勤務日による検索用 |
| idx_daily_attendances_attendance_type | attendance_type | 勤務種別による検索用 |

### ビジネスルール

- 同一月次勤怠情報内の同一日付のレコードは重複して登録できない
- 開始時間と終了時間から、休憩時間を差し引いた勤務時間を自動計算
- 所定労働時間を超えた場合の超過分を残業時間として自動計算
- 月次勤怠情報のステータスが承認中（in_progress）または承認済（approved）の場合、関連する日次勤怠情報は編集不可
- 休日出勤や有給休暇等の特殊な勤務種別の場合、対応する勤務時間計算ルールを適用

## クエリパターン

### 主要なクエリパターン

1. 技術者IDと年月による月次勤怠情報の取得
   ```
   技術者ID = [engineer_id] AND 対象年 = [target_year] AND 対象月 = [target_month] AND is_deleted = false
   ```

2. ステータスによる月次勤怠情報の検索
   ```
   状態 = [status] AND is_deleted = false
   ```

3. 月次勤怠IDによる日次勤怠情報の取得
   ```
   月次勤怠ID = [monthly_attendance_id] AND is_deleted = false
   ORDER BY 勤務日
   ```

4. 期間指定による日次勤怠情報の取得
   ```
   勤務日 BETWEEN [start_date] AND [end_date] AND is_deleted = false
   ```

5. 勤務種別によるフィルタリング
   ```
   勤務種別 = [attendance_type] AND is_deleted = false
   ```

### パフォーマンス最適化

- 月次集計クエリのパフォーマンス向上のため、月次勤怠情報テーブルに合計時間のカラムを持たせる
- 日次勤怠情報の検索で頻繁に使用される条件（月次勤怠ID、勤務日、勤務種別）に対応するインデックスを作成
- 月次レポート生成時のパフォーマンス向上のため、承認済みデータのキャッシュ戦略を検討

## データ整合性

- 月次勤怠情報の合計時間は、関連する日次勤怠情報の合計と一致する必要がある
- 日次勤怠情報の勤務時間、残業時間などは、開始時間、終了時間、休憩時間から整合性を保って計算される
- トリガーまたはアプリケーションロジックにより、関連テーブル間の整合性を維持
- 月次勤怠情報の対象年月と、日次勤怠情報の勤務日の年月は一致している必要がある