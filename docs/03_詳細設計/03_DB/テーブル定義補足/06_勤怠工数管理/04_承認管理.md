# 承認管理テーブル

承認管理に関連するテーブルは、承認フロー管理（`approval_flows`）と承認ステップ情報（`approval_steps`）の2つのテーブルで構成されます。

## approval_flows（承認フロー管理）

タイムシート（月次勤怠情報）の承認フローを管理するためのテーブルです。承認ワークフローの状態とステップを追跡します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| flow_id | uuid | NO | YES | - | - | 承認フローID |
| monthly_attendance_id | uuid | NO | NO | monthly_attendances.monthly_attendance_id | - | 月次勤怠ID |
| current_step | integer | NO | NO | - | 0 | 現在のステップ番号 |
| status | varchar(20) | NO | NO | - | 'not_submitted' | 状態（not_submitted:未提出, in_progress:承認中, approved:承認済, rejected:却下） |
| submitted_at | timestamp | YES | NO | - | NULL | 提出日時 |
| completed_at | timestamp | YES | NO | - | NULL | 完了日時 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_approval_flows_monthly_attendance_id | monthly_attendance_id, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_approval_flows_monthly_attendance_id | monthly_attendance_id | 月次勤怠IDによる検索用 |
| idx_approval_flows_status | status | 状態による検索用 |
| idx_approval_flows_submitted_at | submitted_at | 提出日時による検索用 |

### ビジネスルール

- 1つの月次勤怠情報に対して1つの承認フローのみ存在可能
- 承認フローの状態と月次勤怠情報の状態は同期して更新される
- 承認フローの状態遷移は以下の順序に従う
  - not_submitted → in_progress → approved/rejected
- current_stepは次に承認を行うべきステップ番号を示す
- 承認フローが完了（承認済または却下）した場合、completed_atに完了日時を記録

## approval_steps（承認ステップ情報）

承認フローの各ステップを管理するためのテーブルです。承認者の情報やステップの状態を記録します。

### テーブル定義

| カラム名 | データ型 | NULL | 主キー | 外部キー | デフォルト | 説明 |
|---------|---------|------|-------|---------|----------|------|
| step_id | uuid | NO | YES | - | - | ステップID |
| flow_id | uuid | NO | NO | approval_flows.flow_id | - | 承認フローID |
| step_number | integer | NO | NO | - | - | ステップ番号（1から開始） |
| approver_id | uuid | NO | NO | users.user_id | - | 承認者ID |
| approver_role | varchar(50) | YES | NO | - | NULL | 承認者役割（project_manager, accountant, etc） |
| status | varchar(20) | NO | NO | - | 'pending' | 状態（pending:未処理, approved:承認, rejected:却下） |
| comment | text | YES | NO | - | NULL | コメント |
| processed_at | timestamp | YES | NO | - | NULL | 処理日時 |
| created_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NO | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| created_by | uuid | NO | NO | - | - | 作成者ID |
| updated_by | uuid | NO | NO | - | - | 更新者ID |
| is_deleted | boolean | NO | NO | - | false | 論理削除フラグ |

### ユニーク制約

| 制約名 | カラム |
|--------|-------|
| uk_approval_steps_flow_step | flow_id, step_number, is_deleted |

### インデックス

| インデックス名 | カラム | 説明 |
|--------------|-------|------|
| idx_approval_steps_flow_id | flow_id | 承認フローIDによる検索用 |
| idx_approval_steps_approver_id | approver_id | 承認者IDによる検索用 |
| idx_approval_steps_status | status | 状態による検索用 |
| idx_approval_steps_processed_at | processed_at | 処理日時による検索用 |

### ビジネスルール

- 承認フロー内のステップ番号は一意である必要がある
- ステップの状態遷移は以下の通り
  - pending → approved/rejected
- ステップが処理（承認または却下）されると、processed_atに処理日時を記録
- ステップが却下された場合、承認フロー全体が却下状態となる
- 最終ステップが承認された場合、承認フロー全体が承認済状態となる
- 承認者は自身に割り当てられたステップのみ処理可能
- 各ステップの承認者は異なるユーザーである必要がある（重複チェック）

## 承認フローの例

以下は一般的な承認フローの例です：

1. 技術者が月次勤怠情報を入力し提出
2. ステップ1：プロジェクトマネージャーによる承認
3. ステップ2：営業担当者による承認
4. ステップ3：経理担当者による承認
5. 全ステップ承認完了後、月次勤怠情報が確定され請求処理へ

## クエリパターン

### 主要なクエリパターン

1. 月次勤怠IDによる承認フロー取得
   ```
   月次勤怠ID = [monthly_attendance_id] AND is_deleted = false
   ```

2. 承認フロー状態による検索
   ```
   状態 = [status] AND is_deleted = false
   ```

3. 承認者IDによるステップ検索
   ```
   承認者ID = [approver_id] AND 状態 = 'pending' AND is_deleted = false
   ```

4. 承認フローIDによるステップ一覧取得
   ```
   承認フローID = [flow_id] AND is_deleted = false
   ORDER BY ステップ番号
   ```

5. 期間指定による承認フロー検索
   ```
   提出日時 BETWEEN [start_datetime] AND [end_datetime] AND is_deleted = false
   ```

### パフォーマンス最適化

- 承認者別の未処理タスク検索を最適化するためのインデックス作成
- 承認フローの状態検索を効率化するためのインデックス作成
- 月次勤怠情報と承認フローの結合クエリのパフォーマンス向上
- 承認フロー履歴データの効率的な取得と表示

## 承認ワークフローの動作

### 承認フロー作成プロセス

1. 月次勤怠情報が登録される際に、対応する承認フローが自動生成される
2. 承認ルール設定に基づき、承認ステップが自動生成される
   - プロジェクト設定
   - 組織構造
   - 契約条件
3. 技術者が月次勤怠情報を提出すると、承認フローが開始される

### 承認プロセス

1. 承認フローの状態が in_progress に変更され、current_step が 1 に設定される
2. 各ステップの承認者に通知が送信される
3. 承認者がステップを承認すると、current_step が次のステップに進む
4. 承認者がステップを却下すると、承認フロー全体が却下状態になる
5. 最終ステップが承認されると、承認フロー全体が承認済状態になる

### 承認フロー変更管理

- 承認フローが進行中に承認者が変更された場合の処理
- 組織変更に伴う承認フローの自動更新
- 特殊なケースでの承認フローのオーバーライド（代理承認、緊急承認など）

## データ整合性

- 承認フローの状態と月次勤怠情報の状態の整合性を保つ
- 承認ステップの処理順序を保証（step_number順の処理）
- 承認フローが完了（承認済または却下）した場合、ステップの変更を禁止
- 承認フローが完了した場合、関連する月次勤怠情報と日次勤怠情報の変更を禁止
- トリガーまたはアプリケーションロジックにより、関連テーブル間の整合性を維持