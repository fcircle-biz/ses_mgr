# コード値テーブル詳細設計

## 概要

コード値モジュールは、システム全体で使用する各種コード値（マスタデータ）を管理するためのテーブル群です。各業務で利用する分類や区分などの固定値を一元管理し、外部キー制約によりデータ整合性を確保します。

## テーブル一覧

| テーブル名 | スキーマ | 概要 |
|------------|---------|------|
| code_categories | common | コード値カテゴリマスタ |
| code_values | common | コード値マスタ |
| code_hierarchies | common | コード値階層関係 |
| code_mappings | common | 外部システムコード値マッピング |

## 詳細テーブル定義

### code_categories

コード値のカテゴリを定義するマスタテーブルです。

#### テーブル定義

| カラム名 | データ型 | NOT NULL | デフォルト | 説明 |
|---------|---------|----------|-----------|------|
| id | BIGSERIAL | YES | | 主キー |
| category_code | VARCHAR(50) | YES | | カテゴリコード（一意） |
| category_name | VARCHAR(100) | YES | | カテゴリ名称 |
| description | TEXT | NO | NULL | 説明 |
| is_system | BOOLEAN | YES | FALSE | システム予約カテゴリフラグ |
| sort_order | INTEGER | YES | 0 | 表示順 |
| created_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 更新日時 |
| created_by | VARCHAR(128) | YES | | 作成者 |
| updated_by | VARCHAR(128) | YES | | 更新者 |
| version | INTEGER | YES | 0 | 楽観的ロック用バージョン |
| is_deleted | BOOLEAN | YES | FALSE | 論理削除フラグ |

#### インデックス

| インデックス名 | カラム | 一意性 | 説明 |
|--------------|-------|-------|------|
| pk_code_categories | id | YES | 主キー |
| uq_code_categories_category_code | category_code | YES | カテゴリコードの一意性 |
| idx_code_categories_sort_order | sort_order | NO | 表示順によるソート用 |

### code_values

各カテゴリに属するコード値を定義するマスタテーブルです。

#### テーブル定義

| カラム名 | データ型 | NOT NULL | デフォルト | 説明 |
|---------|---------|----------|-----------|------|
| id | BIGSERIAL | YES | | 主キー |
| category_id | BIGINT | YES | | カテゴリID（外部キー） |
| code | VARCHAR(50) | YES | | コード値 |
| name | VARCHAR(100) | YES | | 名称 |
| short_name | VARCHAR(50) | NO | NULL | 略称 |
| description | TEXT | NO | NULL | 説明 |
| additional_info | JSONB | NO | NULL | 追加情報（任意の属性を格納） |
| is_default | BOOLEAN | YES | FALSE | デフォルト値フラグ |
| is_system | BOOLEAN | YES | FALSE | システム予約コードフラグ |
| valid_from | DATE | NO | NULL | 有効期間（開始） |
| valid_to | DATE | NO | NULL | 有効期間（終了） |
| sort_order | INTEGER | YES | 0 | 表示順 |
| parent_code_id | BIGINT | NO | NULL | 親コードID（自己参照） |
| created_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 更新日時 |
| created_by | VARCHAR(128) | YES | | 作成者 |
| updated_by | VARCHAR(128) | YES | | 更新者 |
| version | INTEGER | YES | 0 | 楽観的ロック用バージョン |
| is_deleted | BOOLEAN | YES | FALSE | 論理削除フラグ |

#### インデックス

| インデックス名 | カラム | 一意性 | 説明 |
|--------------|-------|-------|------|
| pk_code_values | id | YES | 主キー |
| uq_code_values_category_id_code | category_id, code | YES | カテゴリ内でのコード値の一意性 |
| idx_code_values_category_id | category_id | NO | カテゴリによる検索 |
| idx_code_values_parent_code_id | parent_code_id | NO | 親コードによる検索 |
| idx_code_values_valid_dates | valid_from, valid_to | NO | 有効期間による検索 |
| idx_code_values_sort_order | category_id, sort_order | NO | カテゴリ内での表示順 |

#### 外部キー制約

| 制約名 | カラム | 参照先 | ON UPDATE | ON DELETE | 説明 |
|--------|-------|--------|-----------|-----------|------|
| fk_code_values_category_id | category_id | code_categories(id) | CASCADE | RESTRICT | カテゴリテーブルへの参照 |
| fk_code_values_parent_code_id | parent_code_id | code_values(id) | CASCADE | SET NULL | 親コードへの自己参照 |

### code_hierarchies

コード値間の階層関係を管理するテーブルです。

#### テーブル定義

| カラム名 | データ型 | NOT NULL | デフォルト | 説明 |
|---------|---------|----------|-----------|------|
| id | BIGSERIAL | YES | | 主キー |
| parent_code_id | BIGINT | YES | | 親コードID |
| child_code_id | BIGINT | YES | | 子コードID |
| hierarchy_type | VARCHAR(50) | YES | 'DEFAULT' | 階層関係タイプ |
| sort_order | INTEGER | YES | 0 | 表示順 |
| created_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 更新日時 |
| created_by | VARCHAR(128) | YES | | 作成者 |
| updated_by | VARCHAR(128) | YES | | 更新者 |
| version | INTEGER | YES | 0 | 楽観的ロック用バージョン |
| is_deleted | BOOLEAN | YES | FALSE | 論理削除フラグ |

#### インデックス

| インデックス名 | カラム | 一意性 | 説明 |
|--------------|-------|-------|------|
| pk_code_hierarchies | id | YES | 主キー |
| uq_code_hierarchies_parent_child | parent_code_id, child_code_id, hierarchy_type | YES | 親子関係の一意性 |
| idx_code_hierarchies_parent_id | parent_code_id | NO | 親コードによる検索 |
| idx_code_hierarchies_child_id | child_code_id | NO | 子コードによる検索 |

#### 外部キー制約

| 制約名 | カラム | 参照先 | ON UPDATE | ON DELETE | 説明 |
|--------|-------|--------|-----------|-----------|------|
| fk_code_hierarchies_parent_id | parent_code_id | code_values(id) | CASCADE | CASCADE | 親コードへの参照 |
| fk_code_hierarchies_child_id | child_code_id | code_values(id) | CASCADE | CASCADE | 子コードへの参照 |

### code_mappings

外部システムとのコード値マッピングを管理するテーブルです。

#### テーブル定義

| カラム名 | データ型 | NOT NULL | デフォルト | 説明 |
|---------|---------|----------|-----------|------|
| id | BIGSERIAL | YES | | 主キー |
| code_value_id | BIGINT | YES | | 内部コード値ID |
| external_system | VARCHAR(50) | YES | | 外部システム識別子 |
| external_code | VARCHAR(100) | YES | | 外部システムでのコード値 |
| external_name | VARCHAR(200) | NO | NULL | 外部システムでの名称 |
| is_primary | BOOLEAN | YES | FALSE | 主要マッピングフラグ |
| mapping_direction | VARCHAR(20) | YES | 'BIDIRECTIONAL' | マッピング方向（INBOUND/OUTBOUND/BIDIRECTIONAL） |
| valid_from | DATE | NO | NULL | 有効期間（開始） |
| valid_to | DATE | NO | NULL | 有効期間（終了） |
| created_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | YES | CURRENT_TIMESTAMP | 更新日時 |
| created_by | VARCHAR(128) | YES | | 作成者 |
| updated_by | VARCHAR(128) | YES | | 更新者 |
| version | INTEGER | YES | 0 | 楽観的ロック用バージョン |
| is_deleted | BOOLEAN | YES | FALSE | 論理削除フラグ |

#### インデックス

| インデックス名 | カラム | 一意性 | 説明 |
|--------------|-------|-------|------|
| pk_code_mappings | id | YES | 主キー |
| uq_code_mappings_system_code | external_system, external_code | YES | 外部システム内でのコード値の一意性 |
| idx_code_mappings_code_value_id | code_value_id | NO | 内部コード値による検索 |
| idx_code_mappings_external_system | external_system | NO | 外部システムによる検索 |
| idx_code_mappings_valid_dates | valid_from, valid_to | NO | 有効期間による検索 |

#### 外部キー制約

| 制約名 | カラム | 参照先 | ON UPDATE | ON DELETE | 説明 |
|--------|-------|--------|-----------|-----------|------|
| fk_code_mappings_code_value_id | code_value_id | code_values(id) | CASCADE | CASCADE | 内部コード値への参照 |

## テーブル間の関連

### ER図

```
code_categories 1--* code_values
code_values 1--* code_values (自己参照)
code_values 1--* code_hierarchies (parent)
code_values 1--* code_hierarchies (child)
code_values 1--* code_mappings
```

## データ操作パターン

### コード値の検索

カテゴリコードと有効期間によるコード値検索の例：

```sql
SELECT cv.*
FROM common.code_values cv
JOIN common.code_categories cc ON cv.category_id = cc.id
WHERE cc.category_code = 'EMPLOYEE_STATUS'
  AND (cv.valid_from IS NULL OR cv.valid_from <= CURRENT_DATE)
  AND (cv.valid_to IS NULL OR cv.valid_to >= CURRENT_DATE)
  AND cv.is_deleted = FALSE
  AND cc.is_deleted = FALSE
ORDER BY cv.sort_order;
```

### 階層関係を含むコード値の取得

特定コードの配下にある子コード値を取得する例：

```sql
WITH RECURSIVE code_tree AS (
  -- ベースケース（開始点）
  SELECT cv.id, cv.code, cv.name, cv.parent_code_id, 0 AS level
  FROM common.code_values cv
  WHERE cv.code = 'SKILL_CATEGORY_PROGRAMMING'
    AND cv.is_deleted = FALSE
  
  UNION ALL
  
  -- 再帰部分
  SELECT cv.id, cv.code, cv.name, cv.parent_code_id, ct.level + 1
  FROM common.code_values cv
  JOIN code_tree ct ON cv.parent_code_id = ct.id
  WHERE cv.is_deleted = FALSE
)
SELECT * FROM code_tree
ORDER BY level, name;
```

## 拡張性考慮事項

1. **多言語対応**: 必要に応じて、コード値の多言語対応テーブルを追加

    ```sql
    CREATE TABLE common.code_value_translations (
      id BIGSERIAL PRIMARY KEY,
      code_value_id BIGINT NOT NULL REFERENCES common.code_values(id),
      language_code VARCHAR(10) NOT NULL,
      name VARCHAR(100) NOT NULL,
      short_name VARCHAR(50),
      description TEXT,
      UNIQUE(code_value_id, language_code)
    );
    ```

2. **時系列変更管理**: コード値の変更履歴を保持するための履歴テーブルの検討

## 注意事項

1. システム予約コード値（`is_system = TRUE`）は、アプリケーション側でも削除・更新できないよう制御する
2. 有効期間の重複チェックはアプリケーションロジックで実装する
3. パフォーマンス向上のため、頻繁に参照されるコード値はキャッシュを検討する