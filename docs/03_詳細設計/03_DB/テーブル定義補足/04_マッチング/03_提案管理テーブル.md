# マッチングモジュール テーブル定義補足 - 提案管理テーブル

## 1. proposal テーブル

proposal テーブルは、マッチング結果から作成された技術者の案件への提案情報を管理するテーブルです。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | | 提案ID（主キー） |
| project_id | uuid | NOT NULL | | 案件ID（外部キー） |
| engineer_id | uuid | NOT NULL | | 技術者ID（外部キー） |
| matching_result_id | uuid | NOT NULL | | マッチング結果ID（外部キー） |
| proposal_date | date | NOT NULL | CURRENT_DATE | 提案日 |
| status | varchar(20) | NOT NULL | 'draft' | 提案状態 |
| rate | integer | NOT NULL | | 提案単価 |
| work_start_date | date | NOT NULL | | 稼働開始日 |
| work_end_date | date | NULL | | 稼働終了日 |
| proposal_content | text | NULL | | 提案内容 |
| additional_conditions | text | NULL | | 追加条件 |
| notes | text | NULL | | 備考 |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| created_by | uuid | NOT NULL | | 作成者ID（外部キー） |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 最終更新日時 |
| updated_by | uuid | NOT NULL | | 最終更新者ID（外部キー） |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (project_id) REFERENCES project.project(id)
- FOREIGN KEY (engineer_id) REFERENCES engineer.engineer(id)
- FOREIGN KEY (matching_result_id) REFERENCES matching.matching_result(id)
- FOREIGN KEY (created_by) REFERENCES common.users(id)
- FOREIGN KEY (updated_by) REFERENCES common.users(id)
- CHECK (rate > 0)
- CHECK (status IN ('draft', 'pending', 'presented', 'interview', 'accepted', 'rejected', 'cancelled'))
- CHECK (work_end_date IS NULL OR work_end_date >= work_start_date)

**インデックス:**
- ix_proposal_project_id (project_id)
- ix_proposal_engineer_id (engineer_id)
- ix_proposal_matching_result_id (matching_result_id)
- ix_proposal_status (status)
- ix_proposal_work_start_date (work_start_date)
- ix_proposal_created_at (created_at)
- ix_proposal_created_by (created_by)

### 1.2 提案状態定義

| 状態値 | 説明 | 遷移条件 |
|-------|------|----------|
| draft | 下書き | 初期状態 |
| pending | 提案中 | draft から遷移可能 |
| presented | 提案済み | pending から遷移可能 |
| interview | 面談調整中 | presented から遷移可能 |
| accepted | 成約 | interview から遷移可能 |
| rejected | 不成約 | interview から遷移可能 |
| cancelled | キャンセル | pending/presented/interview から遷移可能 |

### 1.3 特記事項

- **提案ワークフロー**: 提案状態の遷移はビジネスルールで定義された順序のみ許可されます。アプリケーションレベルで遷移の妥当性を検証します。
- **成約時の連携**: 提案が成約（accepted）になった場合、契約管理モジュールに連携して契約情報を自動作成します。
- **重複提案チェック**: 同一技術者の同一案件への重複提案は、既存提案がキャンセルまたは不成約の場合のみ許可されます。
- **提案履歴管理**: 状態変更の履歴は proposal_history テーブルに記録されます。

## 2. proposal_history テーブル

proposal_history テーブルは、提案の状態変更履歴を記録するテーブルです。

### 2.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | | 履歴ID（主キー） |
| proposal_id | uuid | NOT NULL | | 提案ID（外部キー） |
| status | varchar(20) | NOT NULL | | 提案状態 |
| date | timestamp | NOT NULL | CURRENT_TIMESTAMP | 変更日時 |
| user_id | uuid | NOT NULL | | 変更ユーザーID（外部キー） |
| user_name | varchar(100) | NOT NULL | | 変更ユーザー名 |
| reason | text | NULL | | 変更理由 |
| notes | text | NULL | | 備考 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (proposal_id) REFERENCES matching.proposal(id)
- FOREIGN KEY (user_id) REFERENCES common.users(id)
- CHECK (status IN ('draft', 'pending', 'presented', 'interview', 'accepted', 'rejected', 'cancelled'))

**インデックス:**
- ix_proposal_history_proposal_id (proposal_id)
- ix_proposal_history_date (date)
- ix_proposal_history_user_id (user_id)
- ix_proposal_history_status (status)

### 2.2 特記事項

- **自動記録**: 提案の状態が変更されるたびに、自動的に履歴レコードが作成されます。
- **変更理由**: 不成約やキャンセルなど、特定の状態変更には理由の入力が必須となります。
- **監査証跡**: このテーブルは監査証跡として利用され、誰がいつどのような変更を行ったかを追跡します。

## 3. proposal_document テーブル

proposal_document テーブルは、提案に関連する書類（提案書、スキルシートなど）を管理するテーブルです。

### 3.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | | 書類ID（主キー） |
| proposal_id | uuid | NOT NULL | | 提案ID（外部キー） |
| name | varchar(100) | NOT NULL | | 書類名 |
| type | varchar(50) | NOT NULL | | 書類種別 |
| description | varchar(500) | NULL | | 説明 |
| file_id | uuid | NOT NULL | | ファイルID（外部キー） |
| version | integer | NOT NULL | 1 | バージョン |
| status | varchar(20) | NOT NULL | 'draft' | 書類ステータス |
| sent_date | date | NULL | | 送付日 |
| template_id | uuid | NULL | | テンプレートID |
| custom_fields | jsonb | NULL | | カスタマイズフィールド |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| created_by | uuid | NOT NULL | | 作成者ID（外部キー） |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| updated_by | uuid | NULL | | 更新者ID（外部キー） |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (proposal_id) REFERENCES matching.proposal(id)
- FOREIGN KEY (file_id) REFERENCES common.file(id)
- FOREIGN KEY (template_id) REFERENCES common.document_template(id)
- FOREIGN KEY (created_by) REFERENCES common.users(id)
- FOREIGN KEY (updated_by) REFERENCES common.users(id)
- CHECK (version > 0)
- CHECK (status IN ('draft', 'sent', 'revised'))
- CHECK (status != 'sent' OR sent_date IS NOT NULL)
- UNIQUE (proposal_id, name, version)

**インデックス:**
- ix_proposal_document_proposal_id (proposal_id)
- ix_proposal_document_type (type)
- ix_proposal_document_file_id (file_id)
- ix_proposal_document_status (status)
- ix_proposal_document_created_at (created_at)
- ix_proposal_document_template_id (template_id)

### 3.2 書類種別定義

| 種別値 | 説明 |
|-------|------|
| skill_sheet | スキルシート |
| proposal_document | 提案書 |
| resume | 経歴書 |
| agreement | 同意書 |
| other | その他 |

### 3.3 書類ステータス定義

| ステータス値 | 説明 |
|------------|------|
| draft | 下書き（初期値） |
| sent | 送付済み |
| revised | 改訂版 |

### 3.4 特記事項

- **バージョン管理**: 同一名称の書類は、バージョンを変えて複数保存できます。
- **送付済み保護**: 送付済みステータスの書類は削除できず、改訂が必要な場合は新バージョンを作成します。
- **テンプレート活用**: template_id を指定して、定型の提案書テンプレートを元に書類を作成できます。
- **カスタマイズフィールド**: custom_fields には、テンプレートのパラメータや特別な設定値をJSON形式で保存します。

## 4. クエリパターンと最適化

### 4.1 提案関連の主要クエリパターン

1. **案件別の提案一覧取得**
   - 特定の案件に対する提案を取得するクエリ
   - project_id インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.proposal 
WHERE project_id = ? 
ORDER BY created_at DESC LIMIT 20 OFFSET 0;
```

2. **技術者別の提案一覧取得**
   - 特定の技術者に対する提案を取得するクエリ
   - engineer_id インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.proposal 
WHERE engineer_id = ? 
ORDER BY created_at DESC LIMIT 20 OFFSET 0;
```

3. **提案状態別の取得**
   - 特定の状態の提案のみを取得するクエリ
   - status インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.proposal 
WHERE status = 'pending' 
ORDER BY created_at DESC LIMIT 20 OFFSET 0;
```

4. **提案履歴の取得**
   - 特定の提案の状態変更履歴を取得するクエリ
   - proposal_id インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.proposal_history 
WHERE proposal_id = ? 
ORDER BY date DESC;
```

5. **提案書類の取得**
   - 特定の提案に関連する書類を取得するクエリ
   - proposal_id インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.proposal_document 
WHERE proposal_id = ? 
ORDER BY type, version DESC;
```

### 4.2 提案状態遷移の実装

提案状態の遷移は、以下のような方法で実装されます：

```sql
-- 擬似コード：提案状態更新処理
BEGIN TRANSACTION;

-- 提案状態の更新
UPDATE matching.proposal 
SET status = ?, updated_at = CURRENT_TIMESTAMP, updated_by = ? 
WHERE id = ? AND status IN (?);

-- 履歴レコードの追加
INSERT INTO matching.proposal_history (id, proposal_id, status, date, user_id, user_name, reason, notes) 
VALUES (?, ?, ?, CURRENT_TIMESTAMP, ?, ?, ?, ?);

-- 成約時の関連処理（例：契約管理モジュールへの連携）
IF new_status = 'accepted' THEN
  INSERT INTO contract.contract (...) VALUES (...);
END IF;

COMMIT;
```

### 4.3 パフォーマンス最適化施策

1. **複合条件による検索の最適化**
   - 複数の条件を組み合わせた検索条件が頻繁に使用される場合は、複合インデックスを検討

2. **履歴データの効率的な管理**
   - 提案履歴データは増加し続けるため、古いデータのアーカイブ戦略を検討
   - 提案ID、日付などでパーティショニングを行うことも検討

3. **書類テンプレートのキャッシュ**
   - 頻繁に使用される提案書テンプレートはアプリケーションレベルでキャッシュ

4. **JSONデータのインデックス**
   - custom_fields 内の特定の属性に対する検索が多い場合、GINインデックスを追加
   - 例：`CREATE INDEX idx_proposal_document_custom_fields ON matching.proposal_document USING GIN (custom_fields)`