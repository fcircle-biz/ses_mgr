# マッチングモジュール テーブル定義補足 - マッチング基本テーブル

## 1. matching_result テーブル

matching_result テーブルは、案件と技術者のマッチング結果を保存するテーブルです。マッチングスコアや詳細情報を管理します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | | マッチング結果ID（主キー） |
| search_type | varchar(50) | NOT NULL | | 検索タイプ（project_to_engineers/engineer_to_projects） |
| project_id | uuid | NOT NULL | | 案件ID（外部キー） |
| engineer_id | uuid | NOT NULL | | 技術者ID（外部キー） |
| matching_score | decimal(5,2) | NOT NULL | | マッチングスコア（0〜100） |
| skill_score | decimal(5,2) | NOT NULL | | スキルマッチングスコア（0〜100） |
| experience_score | decimal(5,2) | NOT NULL | | 経験マッチングスコア（0〜100） |
| availability_score | decimal(5,2) | NOT NULL | | 稼働状況マッチングスコア（0〜100） |
| location_score | decimal(5,2) | NOT NULL | | 勤務地マッチングスコア（0〜100） |
| rate_score | decimal(5,2) | NOT NULL | | 単金マッチングスコア（0〜100） |
| matching_details | jsonb | NOT NULL | | マッチング詳細情報（JSON） |
| status | varchar(20) | NOT NULL | 'pending' | マッチング結果ステータス |
| notes | text | NULL | | 備考 |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (project_id) REFERENCES project.project(id)
- FOREIGN KEY (engineer_id) REFERENCES engineer.engineer(id)
- UNIQUE (project_id, engineer_id, created_at)
- CHECK (matching_score BETWEEN 0 AND 100)
- CHECK (skill_score BETWEEN 0 AND 100)
- CHECK (experience_score BETWEEN 0 AND 100)
- CHECK (availability_score BETWEEN 0 AND 100)
- CHECK (location_score BETWEEN 0 AND 100)
- CHECK (rate_score BETWEEN 0 AND 100)
- CHECK (status IN ('pending', 'reviewed', 'proposed', 'rejected'))

**インデックス:**
- ix_matching_result_project_id (project_id)
- ix_matching_result_engineer_id (engineer_id)
- ix_matching_result_matching_score (matching_score)
- ix_matching_result_status (status)
- ix_matching_result_created_at (created_at)
- ix_matching_result_project_engineer (project_id, engineer_id)

### 1.2 ステータス定義

| ステータス値 | 説明 |
|------------|------|
| pending | 未確認（初期値） |
| reviewed | 確認済み |
| proposed | 提案済み |
| rejected | 不採用 |

### 1.3 matching_details の構造

matching_details カラムは、マッチング結果の詳細情報をJSON形式で保存します。主な構造は以下の通りです：

```json
{
  "matched_skills": [
    {
      "name": "Java",
      "required_level": 4,
      "actual_level": 5,
      "score": 100
    },
    ...
  ],
  "missing_skills": [
    {
      "name": "AWS",
      "required_level": 3
    },
    ...
  ],
  "availability": {
    "required_from": "2025-06-01",
    "required_to": "2025-12-31",
    "actual_from": "2025-06-15",
    "actual_to": "2025-12-31"
  },
  "location": {
    "required_location": "東京都",
    "actual_location": "東京都"
  },
  "rate": {
    "required_min": 600000,
    "required_max": 800000,
    "actual": 750000
  }
}
```

### 1.4 特記事項

- **スコアの重み付け**: 各要素スコア（skill_score, experience_score など）はモジュール設定で定義された重み付けに基づいて計算され、合計値が matching_score となります。
- **大量データ対策**: マッチング結果テーブルは大量データが蓄積されるため、アーカイブポリシーの設定や、場合によっては時系列でのパーティショニングが必要です。
- **JSONインデックス**: matching_details に対して頻繁に検索を行う項目がある場合、JSON パスに対するインデックスを検討します。

## 2. matching_search テーブル

matching_search テーブルは、ユーザーが実行したマッチング検索条件と履歴を保存するテーブルです。

### 2.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | | 検索ID（主キー） |
| type | varchar(50) | NOT NULL | | 検索タイプ（project_to_engineers/engineer_to_projects） |
| criteria | jsonb | NOT NULL | | 検索条件（JSON） |
| result_ids | uuid[] | NOT NULL | '{}' | 結果ID一覧（配列） |
| user_id | uuid | NOT NULL | | 実行ユーザーID（外部キー） |
| created | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| saved | boolean | NOT NULL | false | 保存フラグ |
| name | varchar(100) | NULL | | 検索名 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES common.users(id)
- CHECK (saved = false OR name IS NOT NULL)

**インデックス:**
- ix_matching_search_user_id (user_id)
- ix_matching_search_created (created)
- ix_matching_search_type (type)
- ix_matching_search_saved (saved)

### 2.2 検索タイプ定義

| 検索タイプ値 | 説明 |
|-------------|------|
| project_to_engineers | 案件から技術者検索 |
| engineer_to_projects | 技術者から案件検索 |

### 2.3 criteria の構造

criteria カラムは、検索条件をJSON形式で保存します。主な構造は以下の通りです：

```json
{
  "project_id": "550e8400-e29b-41d4-a716-446655440000",
  "min_matching_score": 70,
  "skills_weight": 4,
  "experience_weight": 3,
  "availability_weight": 5,
  "location_weight": 2,
  "rate_weight": 3,
  "required_skills": [
    {
      "name": "Java",
      "min_level": 3
    },
    {
      "name": "Spring Boot",
      "min_level": 2
    }
  ],
  "availability_from": "2025-06-01",
  "availability_to": "2025-12-31"
}
```

### 2.4 特記事項

- **結果ID配列**: result_ids 列には、この検索で生成されたマッチング結果のID配列が保存され、検索結果の再表示が可能です。
- **検索保存**: saved フラグが true の場合、検索条件に名前を付けて保存されます。保存された検索は定期的に実行できます。
- **検索履歴管理**: 未保存の検索履歴は30日経過後に自動削除される設計です。

## 3. クエリパターンと最適化

### 3.1 マッチング結果の主要クエリパターン

1. **案件別のマッチング結果取得**
   - 特定の案件に対するマッチング結果を取得するクエリで、matching_score 降順で並べ替え
   - project_id インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.matching_result 
WHERE project_id = ? AND status = 'pending'
ORDER BY matching_score DESC LIMIT 20 OFFSET 0;
```

2. **技術者別のマッチング結果取得**
   - 特定の技術者に対するマッチング結果を取得するクエリ
   - engineer_id インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.matching_result 
WHERE engineer_id = ? AND status IN ('pending', 'reviewed')
ORDER BY matching_score DESC LIMIT 20 OFFSET 0;
```

3. **スコア閾値を超えるマッチング結果取得**
   - マッチングスコアが特定の閾値を超える結果のみを取得
   - matching_score インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.matching_result 
WHERE project_id = ? AND matching_score >= 70
ORDER BY matching_score DESC, created_at DESC LIMIT 20 OFFSET 0;
```

### 3.2 検索履歴の主要クエリパターン

1. **ユーザー別の検索履歴取得**
   - 特定のユーザーが実行した検索履歴を取得
   - user_id インデックスを活用

```sql
-- 擬似コード
SELECT * FROM matching.matching_search 
WHERE user_id = ? 
ORDER BY created DESC LIMIT 10;
```

2. **保存済み検索の取得**
   - ユーザーが保存した検索条件一覧を取得
   - user_id と saved の複合条件を活用

```sql
-- 擬似コード
SELECT * FROM matching.matching_search 
WHERE user_id = ? AND saved = true
ORDER BY name;
```

### 3.3 パフォーマンス最適化施策

1. **パーティショニング戦略**
   - matching_result テーブルは検索日付による範囲パーティショニングを検討
   - 過去データのアクセス頻度は低いため、古いパーティションをアーカイブストレージに移動して効率化

2. **マッチング詳細の効率的な検索**
   - matching_details の特定パスに対するGINインデックスを作成
   - 例: スキル名での検索を高速化するためのインデックス

3. **定期的な統計情報更新**
   - テーブルの統計情報を定期的に更新し、最適な実行計画が選択されるようにする

4. **結果キャッシュ戦略**
   - 頻繁に参照される検索結果をアプリケーションレベルでキャッシュし、データベースアクセスを削減