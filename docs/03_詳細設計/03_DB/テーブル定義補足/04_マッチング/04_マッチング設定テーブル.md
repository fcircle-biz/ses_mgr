# マッチングモジュール テーブル定義補足 - マッチング設定テーブル

## 1. matching_parameter テーブル

matching_parameter テーブルは、マッチングアルゴリズムのパラメータ設定を管理するテーブルです。検索時の重み付けやスコア計算のルールなどを定義します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | | パラメータID（主キー） |
| parameter_key | varchar(100) | NOT NULL | | パラメータキー |
| parameter_value | varchar(255) | NOT NULL | | パラメータ値 |
| data_type | varchar(20) | NOT NULL | 'string' | データ型 |
| is_default | boolean | NOT NULL | true | デフォルト設定フラグ |
| category | varchar(50) | NOT NULL | 'general' | パラメータカテゴリ |
| description | varchar(500) | NULL | | パラメータ説明 |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| updated_by | uuid | NOT NULL | | 更新者ID（外部キー） |

**制約:**
- PRIMARY KEY (id)
- UNIQUE (parameter_key, is_default)
- FOREIGN KEY (updated_by) REFERENCES common.users(id)
- CHECK (data_type IN ('string', 'integer', 'decimal', 'boolean', 'json'))

**インデックス:**
- ix_matching_parameter_parameter_key (parameter_key)
- ix_matching_parameter_category (category)
- ix_matching_parameter_updated_at (updated_at)

### 1.2 標準パラメータ定義

以下は、マッチングアルゴリズムで使用される標準的なパラメータの一覧です。

#### 重み付け関連パラメータ

| パラメータキー | 説明 | デフォルト値 | データ型 |
|--------------|------|------------|----------|
| weight.skill | スキルマッチングの重み | "40" | integer |
| weight.experience | 経験マッチングの重み | "30" | integer |
| weight.qualification | 資格マッチングの重み | "10" | integer |
| weight.location | 勤務地マッチングの重み | "10" | integer |
| weight.work_condition | 勤務条件マッチングの重み | "10" | integer |

#### スコア計算関連パラメータ

| パラメータキー | 説明 | デフォルト値 | データ型 |
|--------------|------|------------|----------|
| score.required_match | 必須スキル一致時のスコア | "100" | integer |
| score.preferred_match | 推奨スキル一致時のスコア | "70" | integer |
| score.partial_match | 部分一致時のスコア | "40" | integer |
| score.level_match.exact | 要求レベル完全一致時のスコア | "100" | integer |
| score.level_match.plus_one | 要求レベル+1時のスコア | "100" | integer |
| score.level_match.minus_one | 要求レベル-1時のスコア | "70" | integer |
| score.level_match.minus_two | 要求レベル-2時のスコア | "40" | integer |

#### 検索関連パラメータ

| パラメータキー | 説明 | デフォルト値 | データ型 |
|--------------|------|------------|----------|
| search.default_min_score | デフォルト最小マッチングスコア | "60" | integer |
| search.max_results | 検索結果の最大件数 | "100" | integer |
| search.history_days | 検索履歴保持日数 | "30" | integer |
| search.cache_minutes | 検索結果キャッシュ時間（分） | "60" | integer |

#### アルゴリズム制御パラメータ

| パラメータキー | 説明 | デフォルト値 | データ型 |
|--------------|------|------------|----------|
| algorithm.version | 使用するアルゴリズムのバージョン | "1.0" | string |
| algorithm.use_ml | 機械学習モデルの使用フラグ | "false" | boolean |
| algorithm.boost_factors | ブースト要素の設定 | "{}" | json |

### 1.3 特記事項

- **パラメータのオーバーライド**: is_default=true のレコードはシステム全体のデフォルト設定で、特定ユーザーまたはグループ向けにカスタム設定を作成する場合は is_default=false で同じ parameter_key のレコードを追加できます。
- **動的設定**: パラメータはアプリケーション実行中に動的に読み込まれ、ダウンタイムなく設定を変更できます。
- **設定変更の監査**: updated_at と updated_by で設定変更の履歴を追跡できます。
- **JSON型パラメータ**: より複雑な設定は parameter_value に JSON 形式で保存できます。

## 2. マッチングアルゴリズムとパラメータの関係

マッチングアルゴリズムは、matching_parameter テーブルに定義されたパラメータを使用して以下のような計算を行います。

### 2.1 総合マッチングスコアの計算

総合マッチングスコアは、各要素のスコアを重み付けして合計した値です。

```
総合スコア = (スキルスコア × スキル重み + 経験スコア × 経験重み + 資格スコア × 資格重み 
           + 勤務地スコア × 勤務地重み + 勤務条件スコア × 勤務条件重み) ÷ 重み合計
```

例えば、デフォルト設定では：
```
総合スコア = (スキルスコア × 40 + 経験スコア × 30 + 資格スコア × 10 
           + 勤務地スコア × 10 + 勤務条件スコア × 10) ÷ 100
```

### 2.2 スキルマッチングの計算例

スキルスコアの計算方法は以下の通りです：

1. 各スキル要件に対して、技術者のスキルレベルと要求レベルを比較
2. レベルの差に応じたスコアを割り当て（パラメータ `score.level_match.*` の値を使用）
3. スキルの重要度に応じた重み付けを適用（必須スキルは係数1.0、推奨スキルは係数0.7など）
4. 全スキル要件の平均スコアを計算

```
スキルスコア = Σ(個別スキルスコア × スキル重要度係数) ÷ スキル要件数
```

### 2.3 機械学習モデルの統合（オプション）

`algorithm.use_ml` パラメータが true の場合、過去のマッチング結果や成約率データを学習した機械学習モデルからの予測スコアも総合スコアに組み込みます。

```
総合スコア = 基本スコア × (1 - ML重み) + MLスコア × ML重み
```

ML重みは、`algorithm.boost_factors` JSON パラメータ内に定義されます。

## 3. クエリパターンと最適化

### 3.1 パラメータ取得の主要クエリパターン

1. **全てのデフォルトパラメータ取得**
   - システム全体のデフォルト設定を取得するクエリ
   - is_default フィルタを使用

```sql
-- 擬似コード
SELECT parameter_key, parameter_value, data_type 
FROM matching.matching_parameter 
WHERE is_default = true 
ORDER BY category, parameter_key;
```

2. **カテゴリ別パラメータ取得**
   - 特定カテゴリのパラメータのみを取得するクエリ
   - category インデックスを活用

```sql
-- 擬似コード
SELECT parameter_key, parameter_value, data_type 
FROM matching.matching_parameter 
WHERE category = 'weight' AND is_default = true;
```

3. **特定パラメータの取得**
   - キーを指定して特定のパラメータを取得するクエリ
   - parameter_key インデックスを活用

```sql
-- 擬似コード
SELECT parameter_value, data_type 
FROM matching.matching_parameter 
WHERE parameter_key = 'weight.skill' AND is_default = true;
```

### 3.2 パフォーマンス最適化施策

1. **キャッシュ戦略**
   - パラメータ設定はほとんど変更されないため、アプリケーションレベルでキャッシュし、定期的に（または明示的な変更時に）更新
   - キャッシュのTTL（有効期限）は `search.cache_minutes` パラメータで制御

2. **バルク取得**
   - 個々のパラメータを1つずつ取得するのではなく、カテゴリ単位または全体をバルク取得
   - 必要なパラメータはメモリ上でフィルタリング

3. **型変換の最適化**
   - data_type 列の情報を使用して、アプリケーション側で適切なデータ型に変換
   - 例：`parameter_value = "40"` と `data_type = "integer"` の場合、整数型の 40 として処理

## 4. 運用上の考慮事項

### 4.1 パラメータ変更の影響

- **段階的なロールアウト**: 重要なパラメータ変更は、まずテスト環境で効果を検証した後、本番環境に適用します。
- **A/Bテスト**: 新しいパラメータ設定の効果を検証するために、一部のユーザーまたはプロジェクトに対してのみ適用するA/Bテストを検討します。
- **変更履歴の管理**: 重要なパラメータ変更は、その理由と効果を記録する変更履歴を維持します。

### 4.2 チューニングプロセス

1. **現状分析**: 現在のマッチング結果の精度と成約率を分析
2. **問題特定**: マッチングが適切でない事例を特定
3. **パラメータ調整**: 問題に対応するパラメータを調整
4. **効果測定**: 調整後の結果を測定し、改善を確認
5. **フィードバックループ**: 継続的な改善のためのフィードバックサイクルを確立

### 4.3 パラメータ管理のベストプラクティス

- **設定バックアップ**: 定期的に現在のパラメータ設定をバックアップ
- **変更前テスト**: パラメータ変更前に、変更がどのような影響を与えるかをシミュレーション
- **文書化**: 各パラメータの目的、影響範囲、最適値の根拠を文書化
- **担当者制限**: パラメータ変更権限は、適切なトレーニングを受けた担当者のみに付与