# 契約管理モジュール テーブル定義補足 - 電子署名

## 1. e_signatures テーブル

e_signatures テーブルは、契約の電子署名プロセスを管理するテーブルです。外部の電子署名サービス（DocuSignなど）との連携情報や署名の進行状況を記録します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| signature_id | uuid | NOT NULL | | 署名ID（主キー） |
| contract_id | uuid | NOT NULL | | 契約ID（外部キー） |
| document_id | uuid | NOT NULL | | 対象ドキュメントID（外部キー） |
| external_id | varchar(100) | NULL | | 外部サービスID |
| service_provider | varchar(50) | NOT NULL | 'DocuSign' | 署名サービス提供者 |
| signature_url | varchar(255) | NULL | | 署名URL |
| message | text | NULL | | 署名依頼メッセージ |
| status | varchar(20) | NOT NULL | 'CREATED' | 署名ステータス |
| sequential_signing | boolean | NOT NULL | TRUE | 順序署名フラグ |
| initiated_at | timestamp | NULL | | 署名開始日時 |
| completed_at | timestamp | NULL | | 署名完了日時 |
| expires_at | timestamp | NULL | | 署名有効期限 |
| signature_method | varchar(50) | NULL | | 署名方法 |
| signed_document_path | varchar(255) | NULL | | 署名済み文書パス |
| signed_document_id | uuid | NULL | | 署名済み文書ID（外部キー） |
| created_by | uuid | NOT NULL | | 作成者ID（外部キー） |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**制約:**
- PRIMARY KEY (signature_id)
- FOREIGN KEY (contract_id) REFERENCES contract.contracts(contract_id)
- FOREIGN KEY (document_id) REFERENCES contract.contract_document_history(document_history_id)
- FOREIGN KEY (signed_document_id) REFERENCES contract.contract_document_history(document_history_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- CHECK (service_provider IN ('DocuSign', 'Adobe Sign', 'CloudSign', 'GMO Sign', 'Other'))
- CHECK (status IN ('CREATED', 'SENT', 'IN_PROGRESS', 'COMPLETED', 'DECLINED', 'EXPIRED', 'CANCELLED'))

**インデックス:**
- idx_e_signatures_contract_id (contract_id)
- idx_e_signatures_document_id (document_id)
- idx_e_signatures_external_id (external_id)
- idx_e_signatures_status (status)
- idx_e_signatures_service_provider (service_provider)
- idx_e_signatures_created_at (created_at)
- idx_e_signatures_expires_at (expires_at)
- idx_e_signatures_signed_document_id (signed_document_id)

### 1.2 署名ステータス定義

| ステータス値 | 説明 | 次のステータス |
|------------|------|--------------|
| CREATED | 作成済み | SENT |
| SENT | 送信済み | IN_PROGRESS, EXPIRED, CANCELLED |
| IN_PROGRESS | 署名中 | COMPLETED, DECLINED, EXPIRED, CANCELLED |
| COMPLETED | 完了 | - |
| DECLINED | 拒否 | CREATED, CANCELLED |
| EXPIRED | 期限切れ | CREATED, CANCELLED |
| CANCELLED | 取消 | CREATED |

### 1.3 電子署名サービス連携

電子署名テーブルは、外部の電子署名サービスと連携して動作します。主な連携ポイントは以下の通りです：

1. **署名依頼の送信**
   - 契約ドキュメントを外部サービスにアップロードし、署名依頼を送信
   - 署名URLと外部サービスIDを取得して保存

2. **署名状態の監視**
   - 定期的または webhook による通知で署名の進行状況を取得
   - 署名者の署名状況を更新

3. **署名済み文書の取得**
   - 全署名者の署名完了後、署名済み文書を取得
   - 署名済み文書を新しいドキュメントバージョンとして登録し、`signed_document_id` と `signed_document_path` を更新

4. **署名証明書の管理**
   - 署名の法的有効性を証明する証明書を取得し、保管
   - 必要に応じて監査や法的手続きで参照可能に

## 2. signatories テーブル

signatories テーブルは、電子署名の署名者情報と署名状況を管理するテーブルです。一つの契約には複数の署名者が関与し、各署名者の署名順序や進行状況を記録します。

### 2.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| signatory_id | uuid | NOT NULL | | 署名者ID（主キー） |
| signature_id | uuid | NOT NULL | | 署名ID（外部キー） |
| external_signatory_id | varchar(100) | NULL | | 外部サービス署名者ID |
| name | varchar(100) | NOT NULL | | 署名者名 |
| email | varchar(100) | NOT NULL | | メールアドレス |
| position | varchar(100) | NULL | | 役職 |
| organization | varchar(100) | NULL | | 組織名 |
| signing_order | integer | NOT NULL | 1 | 署名順序 |
| status | varchar(20) | NOT NULL | 'PENDING' | 署名者ステータス |
| sent_at | timestamp | NULL | | 送信日時 |
| viewed_at | timestamp | NULL | | 閲覧日時 |
| signed_at | timestamp | NULL | | 署名日時 |
| decline_reason | text | NULL | | 拒否理由 |
| reminder_count | integer | NOT NULL | 0 | リマインダー送信回数 |
| last_reminder_at | timestamp | NULL | | 最終リマインダー送信日時 |
| ip_address | varchar(45) | NULL | | 署名時IPアドレス |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**制約:**
- PRIMARY KEY (signatory_id)
- FOREIGN KEY (signature_id) REFERENCES contract.e_signatures(signature_id)
- CHECK (status IN ('PENDING', 'NOTIFIED', 'VIEWED', 'SIGNED', 'DECLINED', 'EXPIRED'))
- CHECK (signing_order > 0)
- CHECK (reminder_count >= 0)

**インデックス:**
- idx_signatories_signature_id (signature_id)
- idx_signatories_email (email)
- idx_signatories_status (status)
- idx_signatories_signing_order (signing_order)
- idx_signatories_external_signatory_id (external_signatory_id)
- idx_signatories_signature_status (signature_id, status)
- idx_signatories_signed_at (signed_at)

### 2.2 署名者ステータス定義

| ステータス値 | 説明 | 次のステータス |
|------------|------|--------------|
| PENDING | 待機中 | NOTIFIED |
| NOTIFIED | 通知済み | VIEWED, EXPIRED |
| VIEWED | 閲覧済み | SIGNED, DECLINED, EXPIRED |
| SIGNED | 署名済み | - |
| DECLINED | 拒否 | PENDING |
| EXPIRED | 期限切れ | PENDING |

### 2.3 署名順序管理

1. **順序署名プロセス**
   - `e_signatures.sequential_signing = TRUE` の場合、署名者は `signing_order` の順に従って署名を行います。
   - 前の順序の署名者全員が署名を完了するまで、次の署名者には署名依頼が送信されません。

2. **並行署名プロセス**
   - `e_signatures.sequential_signing = FALSE` の場合、全ての署名者に同時に署名依頼が送信されます。
   - 署名者は互いに依存せず、任意の順序で署名できます。

3. **署名順序の決定要因**
   - 契約の種類によって適切な署名順序が異なります（例：SES契約では通常、自社→取引先の順）。
   - 組織内の承認階層に応じた署名順序を設定可能です（例：部長→役員の順）。

## 3. クエリパターンと最適化

### 3.1 電子署名の主要クエリパターン

1. **契約の署名ステータス確認**
   - 特定の契約の署名状況を確認するクエリ

```sql
-- 擬似コード
SELECT * FROM contract.e_signatures 
WHERE contract_id = ? 
ORDER BY created_at DESC LIMIT 1;
```

2. **署名者ステータスの確認**
   - 特定の署名プロセスの全署名者の状態を確認するクエリ

```sql
-- 擬似コード
SELECT * FROM contract.signatories 
WHERE signature_id = ? 
ORDER BY signing_order ASC;
```

3. **未完了の署名プロセス一覧取得**
   - 進行中または期限切れの署名プロセスを取得するクエリ

```sql
-- 擬似コード
SELECT e.*, c.contract_number, c.title 
FROM contract.e_signatures e 
JOIN contract.contracts c ON e.contract_id = c.contract_id 
WHERE e.status IN ('SENT', 'IN_PROGRESS') 
   OR (e.status = 'EXPIRED' AND e.expires_at > ?);
```

4. **署名リマインダー送信対象の取得**
   - リマインダー送信が必要な署名者を特定するクエリ

```sql
-- 擬似コード
SELECT s.* 
FROM contract.signatories s 
JOIN contract.e_signatures e ON s.signature_id = e.signature_id 
WHERE e.status IN ('SENT', 'IN_PROGRESS') 
  AND s.status IN ('NOTIFIED', 'VIEWED') 
  AND (s.last_reminder_at IS NULL OR s.last_reminder_at < ?) 
  AND s.reminder_count < 3;
```

5. **署名の有効期限チェック**
   - 期限切れになった署名プロセスを特定するクエリ

```sql
-- 擬似コード
SELECT * FROM contract.e_signatures 
WHERE status IN ('SENT', 'IN_PROGRESS') 
  AND expires_at < CURRENT_TIMESTAMP;
```

### 3.2 パフォーマンス最適化施策

1. **署名状態監視の効率化**
   - 署名状態確認は頻繁に行われるため、`contract_id` と `status` の複合インデックスを活用
   - 契約別の最新署名状態を効率的に取得するビューの作成を検討

2. **署名者ステータス検索の最適化**
   - `signature_id` と `status` の複合インデックスにより、署名の進行状況確認を高速化
   - `signing_order` を含めたインデックスで順序署名プロセスの次の署名者を効率的に特定

3. **有効期限管理の効率化**
   - `status` と `expires_at` の複合インデックスにより、期限切れチェックプロセスを最適化
   - バッチ処理での期限切れ更新処理の効率化

4. **リマインダー処理の最適化**
   - リマインダー送信対象の特定に必要な複合条件に対応したクエリ計画の最適化
   - `last_reminder_at` と `reminder_count` のインデックス活用を検討

5. **外部サービス連携の効率化**
   - 外部サービスとの同期処理はバッチで効率的に行い、リアルタイムのデータベースアクセスを最小化
   - `external_id` と `external_signatory_id` にインデックスを設定し、外部サービスからの通知処理を高速化