# 契約管理モジュール テーブル定義補足 - 契約書ドキュメント

## 1. contract_document_history テーブル

contract_document_history テーブルは、契約書のバージョン履歴を管理するテーブルです。契約書の作成から改訂、確定に至るまでの各バージョンを記録し、文書の変更履歴を追跡します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| document_history_id | uuid | NOT NULL | | ドキュメント履歴ID（主キー） |
| contract_id | uuid | NOT NULL | | 契約ID（外部キー） |
| version | integer | NOT NULL | 1 | バージョン番号 |
| document_type | varchar(30) | NOT NULL | 'CONTRACT_MAIN' | ドキュメント種別 |
| document_path | varchar(255) | NOT NULL | | ドキュメントファイルパス |
| file_id | uuid | NOT NULL | | ファイルID（外部キー） |
| file_name | varchar(255) | NOT NULL | | ファイル名 |
| content_type | varchar(100) | NOT NULL | | コンテンツタイプ |
| file_size | integer | NOT NULL | | ファイルサイズ（バイト） |
| is_current | boolean | NOT NULL | TRUE | 現行バージョンフラグ |
| is_executed_copy | boolean | NOT NULL | FALSE | 署名済み原本フラグ |
| change_summary | text | NULL | | 変更概要 |
| created_by | uuid | NOT NULL | | 作成者ID（外部キー） |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |

**制約:**
- PRIMARY KEY (document_history_id)
- FOREIGN KEY (contract_id) REFERENCES contract.contracts(contract_id)
- FOREIGN KEY (file_id) REFERENCES common.files(file_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- CHECK (version > 0)
- CHECK (document_type IN ('CONTRACT_MAIN', 'AMENDMENT', 'APPENDIX', 'TERMS_AND_CONDITIONS', 'SPECIFICATION', 'NDA', 'OTHER'))
- UNIQUE (contract_id, document_type, version)

**インデックス:**
- idx_contract_document_history_contract_id (contract_id)
- idx_contract_document_history_is_current (is_current)
- idx_contract_document_history_version (version)
- idx_contract_document_history_document_type (document_type)
- idx_contract_document_history_created_at (created_at)
- idx_contract_document_history_file_id (file_id)
- idx_contract_document_history_is_executed_copy (is_executed_copy)
- idx_contract_document_history_contract_current (contract_id, is_current)

### 1.2 ドキュメント種別定義

| ドキュメント種別値 | 説明 | バージョン管理 |
|-----------------|------|-------------|
| CONTRACT_MAIN | 本契約書 | 必須 |
| AMENDMENT | 変更合意書 | 必須 |
| APPENDIX | 別紙・付属書類 | 必須 |
| TERMS_AND_CONDITIONS | 約款 | 必須 |
| SPECIFICATION | 仕様書 | 必須 |
| NDA | 秘密保持契約書 | 必須 |
| OTHER | その他 | 必須 |

### 1.3 バージョン管理ルール

1. **新規作成時のバージョン**:
   - 契約書ドキュメントの初回作成時は、バージョン番号 = 1 で登録されます。
   - 同じ契約ID、ドキュメント種別の組み合わせでは、バージョン番号はユニークです。

2. **バージョンアップ**:
   - 既存のドキュメントに変更を加える場合、新しいレコードが作成され、バージョン番号が1増えます。
   - 旧バージョンの `is_current` フラグは FALSE に更新され、新バージョンの `is_current` フラグは TRUE に設定されます。

3. **現行バージョンの特定**:
   - 契約ドキュメントの最新バージョンを取得する際は、`is_current = TRUE` の条件を使用します。
   - 特定のバージョンを取得する場合は、`version` の値を指定します。

4. **署名済み文書の保護**:
   - 署名済み文書（`is_executed_copy = TRUE`）は、修正や削除ができないように保護されます。
   - 署名済み文書に修正が必要な場合は、新しい変更合意書（AMENDMENT）を作成します。

## 2. 契約書ドキュメント管理の特記事項

### 2.1 署名済み文書の管理

1. **署名済み文書の登録**:
   - 電子署名が完了すると、署名サービスから取得した署名済み文書を新しいドキュメントバージョンとして登録します。
   - 署名済み文書には `is_executed_copy = TRUE` のフラグが設定され、法的に有効な原本として管理されます。

2. **文書の法的効力**:
   - 署名済み文書は、改ざん防止のために特別なセキュリティ対策が施されます。
   - 署名証明書や署名タイムスタンプなどの情報が、関連する電子署名テーブルに記録されます。

### 2.2 ファイル管理との連携

1. **ファイル実体の管理**:
   - 契約書ファイルの実体は、共通機能のファイル管理モジュールで管理されます。
   - `document_path` には、ファイル管理モジュールでのファイルパスが格納されます。
   - `file_id` には、ファイル管理モジュールでのファイルIDが格納され、ファイルメタデータとのリンクを提供します。

2. **アクセス制御**:
   - ファイルへのアクセス権限は、契約の閲覧権限と連動して管理されます。
   - 高機密文書については、追加のアクセス制限が適用される場合があります。

### 2.3 バージョン管理の目的

1. **法的要件の充足**:
   - 契約書の変更履歴を明確に記録することで、法的要件を満たします。
   - 各バージョンがいつ、誰によって作成されたかの監査証跡を維持します。

2. **交渉プロセスの透明性**:
   - 契約交渉の過程で生じた文書の変更を追跡可能にします。
   - 各バージョンの変更概要を記録することで、交渉の経緯を明確にします。

3. **過去バージョンの参照**:
   - 必要に応じて過去のバージョンを参照できるようにします。
   - 契約条件の変遷を追跡することで、紛争解決に役立てることができます。

## 3. クエリパターンと最適化

### 3.1 ドキュメント履歴の主要クエリパターン

1. **契約の現行ドキュメント取得**
   - 特定の契約の現行バージョンのドキュメントを取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_document_history 
WHERE contract_id = ? AND document_type = ? AND is_current = TRUE;
```

2. **契約のドキュメント履歴取得**
   - 特定の契約の全バージョン履歴を取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_document_history 
WHERE contract_id = ? AND document_type = ? 
ORDER BY version DESC;
```

3. **署名済み文書の取得**
   - 契約の署名済み原本を取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_document_history 
WHERE contract_id = ? AND is_executed_copy = TRUE;
```

4. **特定バージョンのドキュメント取得**
   - 契約書の特定バージョンを参照

```sql
-- 擬似コード
SELECT * FROM contract.contract_document_history 
WHERE contract_id = ? AND document_type = ? AND version = ?;
```

5. **最近作成されたドキュメント取得**
   - 最近作成または更新されたドキュメントを日時順に取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_document_history 
ORDER BY created_at DESC LIMIT ?;
```

### 3.2 パフォーマンス最適化施策

1. **複合インデックスの活用**
   - 頻出する検索条件の組み合わせに対して複合インデックスを作成
   - 例: `(contract_id, is_current)` の複合インデックスで、契約ごとの現行ドキュメント検索を高速化

2. **不変データの活用**
   - 契約書ドキュメント履歴は基本的に不変（一度作成したレコードは更新しない）設計とすることで、ロック競合を回避
   - `is_current` フラグの更新のみ例外として許可

3. **ファイルメタデータの効率的な取得**
   - ファイル名やサイズなどの基本情報を冗長に保持することで、ファイル管理モジュールへの参照を最小化
   - 頻繁にアクセスされるメタデータの効率的な取得が可能

4. **大量ドキュメントの効率的な管理**
   - 長期契約や頻繁な改訂が行われる契約では、バージョン数が増大する可能性があるため、アーカイブ戦略の実装を検討
   - 一定期間経過した非現行バージョンを別テーブルにアーカイブするなど

5. **ファイルサイズを考慮した設計**
   - 契約書ファイルは比較的サイズが大きいため、ファイル実体はデータベース外で管理
   - ファイルパスと最小限のメタデータのみをデータベースに保存し、効率化