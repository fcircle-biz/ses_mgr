# 契約管理モジュール テーブル定義補足 - 契約テンプレート

## 1. contract_templates テーブル

contract_templates テーブルは、契約書のテンプレートを管理するテーブルです。様々な契約種別に対応するテンプレートを登録し、契約書作成の基礎として使用します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| template_id | uuid | NOT NULL | | テンプレートID（主キー） |
| template_name | varchar(100) | NOT NULL | | テンプレート名 |
| description | text | NULL | | 説明 |
| contract_type | varchar(30) | NOT NULL | | 契約種別 |
| template_content | text | NULL | | テンプレート内容 |
| template_file_id | uuid | NOT NULL | | テンプレートファイルID（外部キー） |
| file_path | varchar(255) | NOT NULL | | ファイルパス |
| file_name | varchar(100) | NOT NULL | | ファイル名 |
| content_type | varchar(50) | NOT NULL | | コンテンツタイプ |
| file_size | integer | NOT NULL | | ファイルサイズ（バイト） |
| placeholder_variables | jsonb | NULL | | 置換変数定義 |
| version | integer | NOT NULL | 1 | バージョン |
| previous_version_id | uuid | NULL | | 前バージョンID（外部キー） |
| is_active | boolean | NOT NULL | TRUE | 有効フラグ |
| is_default | boolean | NOT NULL | FALSE | デフォルトフラグ |
| approval_required | boolean | NOT NULL | TRUE | 承認要否フラグ |
| created_by | uuid | NOT NULL | | 作成者ID（外部キー） |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_by | uuid | NOT NULL | | 更新者ID（外部キー） |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| approved_by | uuid | NULL | | 承認者ID（外部キー） |
| approved_at | timestamp | NULL | | 承認日時 |

**制約:**
- PRIMARY KEY (template_id)
- FOREIGN KEY (template_file_id) REFERENCES common.files(file_id)
- FOREIGN KEY (previous_version_id) REFERENCES contract.contract_templates(template_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- FOREIGN KEY (updated_by) REFERENCES common.users(user_id)
- FOREIGN KEY (approved_by) REFERENCES common.users(user_id)
- CHECK (contract_type IN ('SES_CONTRACT', 'OUTSOURCING_CONTRACT', 'DISPATCH_CONTRACT', 'NDA', 'FRAMEWORK_AGREEMENT', 'AMENDMENT', 'OTHER'))
- CHECK (version > 0)
- CHECK (content_type IN ('application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/html'))
- UNIQUE (template_name, version)

**インデックス:**
- idx_contract_templates_template_name (template_name)
- idx_contract_templates_contract_type (contract_type)
- idx_contract_templates_is_active (is_active)
- idx_contract_templates_is_default (is_default)
- idx_contract_templates_version (version)
- idx_contract_templates_created_at (created_at)
- idx_contract_templates_previous_version_id (previous_version_id)
- idx_contract_templates_content_type (content_type)
- idx_contract_templates_approved_at (approved_at)
- idx_contract_templates_type_active_default (contract_type, is_active, is_default)

### 1.2 置換変数の構造

`placeholder_variables` カラムは、テンプレート内の置換変数に関する情報をJSON形式で保存します。基本構造は以下の通りです：

```json
{
  "variables": [
    {
      "name": "contract_number",
      "description": "契約番号",
      "type": "TEXT",
      "required": true,
      "default_value": null,
      "source": "CONTRACT.contract_number"
    },
    {
      "name": "customer_name",
      "description": "顧客名",
      "type": "TEXT",
      "required": true,
      "default_value": null,
      "source": "CUSTOMER.name"
    },
    {
      "name": "start_date",
      "description": "契約開始日",
      "type": "DATE",
      "required": true,
      "default_value": null,
      "format": "yyyy年MM月dd日",
      "source": "CONTRACT.start_date"
    },
    {
      "name": "payment_terms",
      "description": "支払条件",
      "type": "ENUM",
      "required": true,
      "options": ["月末締め翌月末払い", "月末締め翌月15日払い", "月末締め翌々月末払い"],
      "default_value": "月末締め翌月末払い",
      "source": "CONTRACT.payment_terms"
    }
  ],
  "sections": [
    {
      "name": "confidentiality",
      "description": "秘密保持条項",
      "optional": false,
      "conditions": null
    },
    {
      "name": "indemnification",
      "description": "賠償責任条項",
      "optional": true,
      "conditions": [
        { "variable": "contract_amount", "operator": ">", "value": 1000000 }
      ]
    }
  ]
}
```

### 1.3 テンプレートバージョン管理

1. **バージョン番号付与**:
   - 同一テンプレート名の新バージョンを作成する場合、既存の最大バージョン番号に1を加えた値が自動的に割り当てられます。
   - 初回作成時はバージョン = 1 となります。

2. **バージョン間の関連**:
   - 新バージョン作成時、前バージョンのIDが `previous_version_id` に設定されます。
   - これにより、テンプレートのバージョン履歴をたどることが可能です。

3. **アクティブバージョン**:
   - 同一テンプレート名で複数のバージョンが存在する場合、通常は最新バージョンのみ `is_active = TRUE` となります。
   - テンプレートの改訂を行う場合、新バージョンを作成し、旧バージョンの `is_active` を FALSE に更新します。

4. **デフォルトテンプレート**:
   - 各契約種別において、一つのテンプレートのみがデフォルト（`is_default = TRUE`）として設定可能です。
   - 契約作成時に特定のテンプレートを指定しない場合、対応する契約種別のデフォルトテンプレートが使用されます。

## 2. テンプレート管理の特記事項

### 2.1 テンプレートファイル形式

1. **サポートされるファイル形式**:
   - Microsoft Word (.docx): 変数置換やセクション条件付き表示などの高度な機能をサポート
   - PDF (.pdf): 固定レイアウトでの表示が重要な場合に使用
   - HTML (.html): Web表示に最適化されたテンプレート

2. **テンプレート内の変数表記**:
   - Word文書: `${variable_name}` 形式のプレースホルダーを使用
   - HTML: `{{variable_name}}` 形式のテンプレートタグを使用
   - PDF: フォームフィールドを使用してマッピング

### 2.2 テンプレート承認プロセス

1. **承認フロー**:
   - テンプレートの作成または変更後、法務部門などによる承認が必要な場合があります。
   - `approval_required = TRUE` の場合、テンプレートは承認されるまで一般利用できません。
   - 承認者情報と承認日時が記録されます。

2. **承認済みテンプレートの保護**:
   - 承認済みテンプレート（`approved_at IS NOT NULL`）は、直接編集できません。
   - 変更が必要な場合は、新しいバージョンを作成する必要があります。

### 2.3 変数マッピング

1. **変数ソースの定義**:
   - `source` 属性は、変数の値がどこから取得されるかを示します。
   - 例: `CONTRACT.contract_number` は契約テーブルの contract_number カラムを参照することを意味します。

2. **自動マッピングと手動入力**:
   - 一部の変数は契約情報から自動的にマッピングされます。
   - その他の変数は、契約作成時にユーザーによる手動入力が必要です。

3. **条件付きセクション**:
   - `sections` 配列内の `conditions` は、特定のセクションを表示するかどうかを決定する条件を定義します。
   - 複数の条件が指定された場合、すべての条件を満たす必要があります（AND条件）。

## 3. クエリパターンと最適化

### 3.1 テンプレートの主要クエリパターン

1. **契約種別ごとのアクティブテンプレート取得**
   - 特定の契約種別で現在利用可能なテンプレート一覧を取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_templates 
WHERE contract_type = ? AND is_active = TRUE 
ORDER BY template_name, version DESC;
```

2. **デフォルトテンプレート取得**
   - 特定の契約種別のデフォルトテンプレートを取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_templates 
WHERE contract_type = ? AND is_active = TRUE AND is_default = TRUE;
```

3. **テンプレートの全バージョン取得**
   - 特定のテンプレートの全バージョン履歴を取得

```sql
-- 擬似コード
WITH RECURSIVE template_versions AS (
  SELECT * FROM contract.contract_templates WHERE template_id = ?
  UNION ALL
  SELECT t.* FROM contract.contract_templates t
  JOIN template_versions tv ON t.template_id = tv.previous_version_id
)
SELECT * FROM template_versions ORDER BY version DESC;
```

4. **最近追加されたテンプレート取得**
   - 最近作成または更新されたテンプレートを取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_templates 
WHERE is_active = TRUE 
ORDER BY created_at DESC LIMIT ?;
```

5. **特定の変数を含むテンプレート検索**
   - 特定の置換変数を含むテンプレートを検索

```sql
-- 擬似コード
SELECT * FROM contract.contract_templates 
WHERE is_active = TRUE 
  AND placeholder_variables->'variables' @> '[{"name":"target_variable"}]'::jsonb;
```

### 3.2 パフォーマンス最適化施策

1. **複合インデックスの活用**
   - 頻出する検索条件の組み合わせに対して複合インデックスを作成
   - 例: `(contract_type, is_active, is_default)` の複合インデックスで、デフォルトテンプレート検索を高速化

2. **JSONB検索の最適化**
   - `placeholder_variables` のJSONB型に対してGINインデックスを作成し、特定の変数やセクションの検索を高速化
   - 例: `CREATE INDEX idx_contract_templates_variables ON contract.contract_templates USING GIN (placeholder_variables);`

3. **バージョン履歴の効率的な管理**
   - 再帰クエリを使用したバージョン履歴の取得は処理コストが高いため、特に多数のバージョンがある場合はキャッシュの活用を検討

4. **テンプレートキャッシング**
   - 頻繁に使用されるテンプレート、特にデフォルトテンプレートはアプリケーションレベルでキャッシュし、データベースアクセスを削減

5. **テンプレートファイルの効率的な管理**
   - テンプレートファイルは共通のファイル管理モジュールで管理し、頻繁なアクセスが必要なメタデータのみをテンプレートテーブルに保持