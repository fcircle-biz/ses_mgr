# 契約管理モジュール テーブル定義補足 - 契約基本テーブル

## 1. contracts テーブル

contracts テーブルは、契約の基本情報を管理するテーブルです。案件、技術者、契約条件など、契約の中核となる情報を保持します。

### 1.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| contract_id | uuid | NOT NULL | | 契約ID（主キー） |
| contract_number | varchar(50) | NOT NULL | | 契約番号（一意制約） |
| project_id | uuid | NOT NULL | | 案件ID（外部キー） |
| engineer_id | uuid | NULL | | 技術者ID（外部キー） |
| customer_id | uuid | NOT NULL | | 顧客ID（外部キー） |
| template_id | uuid | NULL | | 契約テンプレートID（外部キー） |
| contract_type | varchar(20) | NOT NULL | | 契約種別 |
| title | varchar(200) | NOT NULL | | 契約タイトル |
| start_date | date | NOT NULL | | 契約開始日 |
| end_date | date | NULL | | 契約終了日 |
| billing_amount | decimal(12,2) | NULL | | 請求金額 |
| payment_amount | decimal(12,2) | NULL | | 支払金額 |
| payment_terms | text | NULL | | 支払条件 |
| status | varchar(20) | NOT NULL | 'DRAFT' | 契約ステータス |
| document_path | varchar(255) | NULL | | 契約書ファイルパス |
| notes | text | NULL | | 備考 |
| created_by | uuid | NOT NULL | | 作成者ID（外部キー） |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_by | uuid | NOT NULL | | 更新者ID（外部キー） |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| approved_by | uuid | NULL | | 承認者ID（外部キー） |
| approved_at | timestamp | NULL | | 承認日時 |

**制約:**
- PRIMARY KEY (contract_id)
- UNIQUE (contract_number)
- FOREIGN KEY (project_id) REFERENCES project.projects(project_id)
- FOREIGN KEY (engineer_id) REFERENCES engineer.engineers(engineer_id)
- FOREIGN KEY (customer_id) REFERENCES common.customers(customer_id)
- FOREIGN KEY (template_id) REFERENCES contract.contract_templates(template_id)
- FOREIGN KEY (created_by) REFERENCES common.users(user_id)
- FOREIGN KEY (updated_by) REFERENCES common.users(user_id)
- FOREIGN KEY (approved_by) REFERENCES common.users(user_id)
- CHECK (contract_type IN ('SES_CONTRACT', 'OUTSOURCING_CONTRACT', 'DISPATCH_CONTRACT', 'NDA', 'FRAMEWORK_AGREEMENT', 'AMENDMENT', 'OTHER'))
- CHECK (status IN ('DRAFT', 'REVIEW_IN_PROGRESS', 'REVIEW_COMPLETED', 'APPROVAL_PENDING', 'APPROVED', 'SIGNATURE_PENDING', 'EXECUTED', 'EXPIRED', 'TERMINATED', 'RENEWED', 'CANCELLED'))
- CHECK (end_date IS NULL OR end_date >= start_date)

**インデックス:**
- idx_contracts_contract_number (contract_number)
- idx_contracts_project_id (project_id)
- idx_contracts_engineer_id (engineer_id)
- idx_contracts_customer_id (customer_id)
- idx_contracts_status (status)
- idx_contracts_start_date (start_date)
- idx_contracts_end_date (end_date)
- idx_contracts_created_at (created_at)
- idx_contracts_contract_type (contract_type)
- idx_contracts_billing_amount (billing_amount)
- idx_contracts_project_status (project_id, status)

### 1.2 契約ステータス定義

| ステータス値 | 説明 | 遷移可能な次のステータス |
|------------|------|------------------------|
| DRAFT | 下書き | REVIEW_IN_PROGRESS |
| REVIEW_IN_PROGRESS | レビュー中 | REVIEW_COMPLETED, DRAFT |
| REVIEW_COMPLETED | レビュー完了 | APPROVAL_PENDING, DRAFT |
| APPROVAL_PENDING | 承認待ち | APPROVED, DRAFT |
| APPROVED | 承認済み | SIGNATURE_PENDING, DRAFT |
| SIGNATURE_PENDING | 署名中 | EXECUTED, CANCELLED |
| EXECUTED | 締結済み | EXPIRED, TERMINATED, RENEWED |
| EXPIRED | 期限切れ | RENEWED |
| TERMINATED | 解約 | - |
| RENEWED | 更新済み | - |
| CANCELLED | 取消 | DRAFT |

### 1.3 契約種別定義

| 契約種別値 | 説明 | 技術者必須 |
|-----------|------|----------|
| SES_CONTRACT | SES契約（準委任） | Yes |
| OUTSOURCING_CONTRACT | 業務委託契約（請負） | No |
| DISPATCH_CONTRACT | 派遣契約 | Yes |
| NDA | 秘密保持契約 | No |
| FRAMEWORK_AGREEMENT | 基本契約 | No |
| AMENDMENT | 契約変更合意書 | No |
| OTHER | その他 | No |

### 1.4 契約番号採番規則

契約番号は以下の形式で自動採番されます：

```
CNT-{年月}-{5桁連番}
```

例：CNT-202505-00001

年月は契約作成時の年月（YYYYMM形式）を使用し、連番は当該年月内で一意の5桁の数字です。

## 2. contract_changes テーブル

contract_changes テーブルは、契約の変更履歴を管理するテーブルです。契約の金額、期間、支払条件などに変更があった場合、変更前後の値や変更理由などを記録します。

### 2.1 テーブル定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| change_id | uuid | NOT NULL | | 変更ID（主キー） |
| contract_id | uuid | NOT NULL | | 契約ID（外部キー） |
| change_type | varchar(20) | NOT NULL | | 変更タイプ |
| change_date | date | NOT NULL | CURRENT_DATE | 変更日 |
| previous_value | text | NULL | | 変更前の値 |
| new_value | text | NULL | | 変更後の値 |
| field_name | varchar(50) | NOT NULL | | 変更フィールド名 |
| reason | text | NULL | | 変更理由 |
| changed_by | uuid | NOT NULL | | 変更者ID（外部キー） |
| status | varchar(20) | NOT NULL | 'PENDING' | 変更ステータス |
| approved_by | uuid | NULL | | 承認者ID（外部キー） |
| approved_at | timestamp | NULL | | 承認日時 |
| created_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | timestamp | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**制約:**
- PRIMARY KEY (change_id)
- FOREIGN KEY (contract_id) REFERENCES contract.contracts(contract_id)
- FOREIGN KEY (changed_by) REFERENCES common.users(user_id)
- FOREIGN KEY (approved_by) REFERENCES common.users(user_id)
- CHECK (change_type IN ('CONTRACT_PERIOD', 'AMOUNT', 'PAYMENT_TERMS', 'STATUS', 'OTHER'))
- CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED'))

**インデックス:**
- idx_contract_changes_contract_id (contract_id)
- idx_contract_changes_change_type (change_type)
- idx_contract_changes_change_date (change_date)
- idx_contract_changes_status (status)
- idx_contract_changes_field_name (field_name)
- idx_contract_changes_created_at (created_at)

### 2.2 変更タイプ定義

| 変更タイプ値 | 説明 | 承認要否 |
|------------|------|---------|
| CONTRACT_PERIOD | 契約期間変更 | 要 |
| AMOUNT | 金額変更 | 要 |
| PAYMENT_TERMS | 支払条件変更 | 要 |
| STATUS | ステータス変更 | 要（一部除外） |
| OTHER | その他 | 要 |

### 2.3 変更ステータス定義

| ステータス値 | 説明 |
|------------|------|
| PENDING | 承認待ち |
| APPROVED | 承認済み |
| REJECTED | 拒否 |
| CANCELLED | 取消 |

## 3. クエリパターンと最適化

### 3.1 契約の主要クエリパターン

1. **契約一覧の取得**
   - 契約ステータス、契約種別、日付範囲などで絞り込み
   - 作成日時の降順でページング

```sql
-- 擬似コード
SELECT * FROM contract.contracts 
WHERE status = ? AND contract_type = ? 
  AND start_date >= ? AND (end_date <= ? OR end_date IS NULL)
ORDER BY created_at DESC LIMIT ? OFFSET ?;
```

2. **案件に関連する契約一覧の取得**
   - 特定の案件IDに紐づく全契約を取得

```sql
-- 擬似コード
SELECT * FROM contract.contracts 
WHERE project_id = ? 
ORDER BY created_at DESC;
```

3. **技術者に関連する契約一覧の取得**
   - 特定の技術者IDに紐づく全契約を取得

```sql
-- 擬似コード
SELECT * FROM contract.contracts 
WHERE engineer_id = ? 
ORDER BY start_date DESC;
```

4. **期間中の有効契約の取得**
   - 特定の日付範囲で有効な契約を取得

```sql
-- 擬似コード
SELECT * FROM contract.contracts 
WHERE status = 'EXECUTED' 
  AND start_date <= ? 
  AND (end_date >= ? OR end_date IS NULL);
```

5. **契約変更履歴の取得**
   - 特定の契約の全変更履歴を取得

```sql
-- 擬似コード
SELECT * FROM contract.contract_changes 
WHERE contract_id = ? 
ORDER BY change_date DESC, created_at DESC;
```

### 3.2 パフォーマンス最適化施策

1. **複合インデックスの活用**
   - 頻出する検索条件の組み合わせに対して複合インデックスを作成
   - 例: `(project_id, status)` の複合インデックスで案件ごとの契約ステータス検索を高速化

2. **有効期間検索の最適化**
   - 契約期間（start_date, end_date）での検索が多いため、これらのカラムにインデックスを設定
   - NULL値（終了日未定の無期限契約）を考慮した検索条件の最適化

3. **金額範囲検索の最適化**
   - 金額範囲での検索に対応するため、billing_amountとpayment_amountにインデックスを設定

4. **履歴データの効率的な管理**
   - contract_changesテーブルは時間経過とともに増大するため、古いデータのアーカイブや時系列パーティショニングを検討
   - 契約IDと変更日付によるパーティショニングが有効

5. **契約ステータス遷移の整合性確保**
   - ステータス変更時のアプリケーションレベルでの検証に加えて、トリガーによるデータベースレベルでの整合性チェックを実装