# DB詳細設計 - 物理設計

## 1. ハードウェア構成

### 1.1 開発環境

開発環境では、Docker コンテナ上で PostgreSQL 17 を稼働させる。

- **CPU**: 4コア以上
- **メモリ**: 8GB以上割当
- **ストレージ**: SSD 100GB以上
- **ネットワーク**: 1Gbps以上

### 1.2 本番環境 (AWS RDS)

AWS RDS for PostgreSQL を使用し、以下の構成を推奨する。

- **インスタンスタイプ**: db.m6i.2xlarge (8 vCPU, 32 GB RAM)
- **ストレージタイプ**: 汎用SSD (gp3)
- **初期ストレージ容量**: 500GB
- **最大ストレージ容量**: 2TB (自動スケーリング有効)
- **マルチAZ構成**: 有効
- **リードレプリカ**: 1インスタンス (レポーティング用)

#### 推奨パラメータグループ設定:

```
max_connections = 500
shared_buffers = 8GB
effective_cache_size = 24GB
work_mem = 64MB
maintenance_work_mem = 1GB
min_wal_size = 2GB
max_wal_size = 8GB
checkpoint_timeout = 15min
random_page_cost = 1.1
effective_io_concurrency = 200
parallel_workers = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
wal_buffers = 16MB
default_statistics_target = 100
```

## 2. ストレージ構成

### 2.1 テーブルスペース

| テーブルスペース名 | 用途 | 設定 |
|------------------|------|------|
| `default` | 一般テーブル・インデックス | デフォルト設定 |
| `large_tables` | 大規模テーブル (500万行以上) | 大容量ファイル用に最適化 |
| `logging_space` | ログテーブル | WAL設定を最適化 |
| `archive_space` | アーカイブデータ | 圧縮率高、読み取り最適化 |

#### テーブルスペース作成例:

```sql
CREATE TABLESPACE large_tables
  OWNER postgres
  LOCATION '/rds/large_tables';

CREATE TABLESPACE logging_space
  OWNER postgres
  LOCATION '/rds/logging_space';

CREATE TABLESPACE archive_space
  OWNER postgres
  LOCATION '/rds/archive_space';
```

### 2.2 ファイルレイアウト

AWS RDS環境では物理的なファイルレイアウトの変更は制限されるが、以下の管理方針を採用する。

- **データファイル**: 自動拡張設定、初期サイズ設計
- **WALファイル**: 適切なチェックポイント間隔とWAL圧縮の設定
- **一時ファイル**: 専用の一時テーブルスペースを使用

## 3. メモリ構成

### 3.1 メモリパラメータ

| パラメータ名 | 値 | 説明 |
|-------------|-----|------|
| `shared_buffers` | 8GB | 共有バッファのサイズ (RAM の 25%) |
| `effective_cache_size` | 24GB | OS キャッシュ含む予想メモリサイズ (RAM の 75%) |
| `work_mem` | 64MB | クエリ処理ワークスペースのサイズ |
| `maintenance_work_mem` | 1GB | メンテナンス操作用メモリ |
| `temp_buffers` | 64MB | 一時テーブル用バッファ |
| `autovacuum_work_mem` | 512MB | 自動VACUUM処理用メモリ |

### 3.2 クエリキャッシュ

- **prepared statement**: アプリケーションでの再利用を推奨
- **PgBouncer**: コネクションプーリングの実装
- **クエリプラン再利用**: `plan_cache_mode = auto`の設定

## 4. プロセス構成

### 4.1 プロセスパラメータ

| パラメータ名 | 値 | 説明 |
|-------------|-----|------|
| `max_connections` | 500 | 最大同時接続数 |
| `superuser_reserved_connections` | 10 | スーパーユーザー用予約接続数 |
| `max_parallel_workers` | 8 | 並列処理の最大ワーカー数 |
| `max_parallel_workers_per_gather` | 2 | Gather ノードあたりの並列ワーカー数 |
| `max_parallel_maintenance_workers` | 4 | メンテナンス操作での並列ワーカー数 |

### 4.2 バックグラウンドプロセス

- **自動VACUUM**: 適切なタイミングで実行されるよう設定
- **統計情報収集**: 定期的な統計情報更新の設定
- **WAL書き込み**: 同期設定とチェックポイント間隔の最適化

#### 自動VACUUM関連設定:

```
autovacuum = on
autovacuum_max_workers = 5
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = 2000
```

## 5. 接続設定

### 5.1 接続パラメータ

| パラメータ名 | 値 | 説明 |
|-------------|-----|------|
| `listen_addresses` | '*' | 接続可能なIPアドレス |
| `port` | 5432 | リスニングポート |
| `max_connections` | 500 | 最大同時接続数 |
| `password_encryption` | scram-sha-256 | パスワード暗号化アルゴリズム |
| `ssl` | on | SSL接続の有効化 |
| `ssl_cert_file` | 'server.crt' | サーバー証明書ファイル |
| `ssl_key_file` | 'server.key' | サーバーキーファイル |

### 5.2 コネクションプーリング

PgBouncer を使用したコネクションプーリングを実装する。

- **プールモード**: transaction
- **最大クライアント接続数**: 3000
- **デフォルトプールサイズ**: 100
- **最小プールサイズ**: 10
- **リザーブプールサイズ**: 20

#### PgBouncer設定例:

```ini
[databases]
ses_mgr = host=ses-mgr-prod.cluster-xxxxx.ap-northeast-1.rds.amazonaws.com port=5432 dbname=ses_mgr

[pgbouncer]
listen_addr = *
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
admin_users = admin
pool_mode = transaction
default_pool_size = 100
min_pool_size = 10
reserve_pool_size = 20
max_client_conn = 3000
max_db_connections = 500
```

## 6. 物理設計考慮事項

### 6.1 可用性設計

- **マルチAZ構成**: 自動フェイルオーバー対応
- **リードレプリカ**: レポーティング処理の負荷分散
- **バックアップ**: 自動バックアップと手動スナップショット

### 6.2 セキュリティ設計

- **ネットワークセキュリティ**: VPC内での配置、セキュリティグループ設定
- **暗号化**: 保存データの暗号化、通信の暗号化(SSL/TLS)
- **アクセス制御**: 最小権限の原則に基づくロールベースアクセス制御

### 6.3 拡張性設計

- **垂直スケーリング**: インスタンスタイプのアップグレード
- **水平スケーリング**: リードレプリカの追加
- **ストレージスケーリング**: 自動ストレージスケーリングの有効化

### 6.4 運用設計

- **モニタリング**: CloudWatchとカスタムメトリクスによる監視
- **メンテナンス**: 定期的なメンテナンスウィンドウの設定
- **パッチ適用**: マイナーバージョン自動アップグレードの設定