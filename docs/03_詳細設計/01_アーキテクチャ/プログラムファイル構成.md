# プログラムファイル構成

本ドキュメントでは、SES業務システムの実装におけるプログラムファイル構成について説明します。

## 1. 全体ディレクトリ構成

```
/
├── build.gradle               # Gradleビルド設定
├── docker-compose.yaml        # Docker環境設定
├── docs/                      # ドキュメント
├── gradle/                    # Gradleラッパー
├── src/                       # ソースコード
│   ├── main/                  # メインソースコード
│   │   ├── java/              # Javaソースコード
│   │   └── resources/         # リソースファイル
│   └── test/                  # テストソースコード
│       ├── java/              # テストJavaソースコード
│       └── resources/         # テストリソースファイル
├── build/                     # ビルド成果物（自動生成）
└── logs/                      # ログファイル（実行時生成）
```

## 2. src/main ディレクトリ構成

### 2.1 Javaソースコード構成

```
src/main/java/jp/co/example/sesapp/
├── SesApplication.java                    # アプリケーションエントリポイント
├── common/                                # 共通機能
│   ├── auth/                              # 認証・認可機能
│   │   ├── config/                        # 認証設定クラス
│   │   │   └── AuthConfig.java
│   │   ├── controller/                    # 認証コントローラー
│   │   │   ├── AuthController.java        # 認証API
│   │   │   └── UserController.java        # ユーザー管理API
│   │   ├── domain/                        # 認証ドメインモデル
│   │   │   ├── ActionType.java            # アクション種別
│   │   │   ├── AuthEventType.java         # 認証イベント種別
│   │   │   ├── AuthenticationMethod.java  # 認証方式
│   │   │   ├── Permission.java            # 権限モデル
│   │   │   ├── RefreshToken.java          # リフレッシュトークン
│   │   │   ├── ResourceType.java          # リソース種別
│   │   │   ├── Role.java                  # ロールモデル
│   │   │   ├── User.java                  # ユーザーモデル
│   │   │   └── dto/                       # DTOクラス
│   │   │       ├── AuthenticationResponse.java  # 認証レスポンス
│   │   │       ├── Credentials.java             # 認証情報
│   │   │       ├── LogoutRequest.java           # ログアウトリクエスト
│   │   │       ├── MfaChallenge.java            # 多要素認証チャレンジ
│   │   │       ├── MfaDisableRequest.java       # 多要素認証無効化リクエスト
│   │   │       ├── MfaEnableRequest.java        # 多要素認証有効化リクエスト
│   │   │       ├── MfaSetupResponse.java        # 多要素認証設定レスポンス
│   │   │       ├── PasswordChangeRequest.java   # パスワード変更リクエスト
│   │   │       ├── TokenRefreshRequest.java     # トークン更新リクエスト
│   │   │       ├── UserCreateDto.java           # ユーザー作成DTO
│   │   │       ├── UserDto.java                 # ユーザーDTO
│   │   │       └── UserUpdateDto.java           # ユーザー更新DTO
│   │   ├── filter/                       # 認証フィルター
│   │   │   └── JwtAuthenticationFilter.java  # JWT認証フィルター
│   │   ├── handler/                      # 認証例外ハンドラー
│   │   │   ├── CustomAccessDeniedHandler.java       # アクセス拒否ハンドラー
│   │   │   └── CustomAuthenticationEntryPoint.java  # 認証エントリーポイント
│   │   ├── repository/                   # 認証リポジトリ
│   │   │   ├── PermissionRepository.java  # 権限リポジトリインターフェース
│   │   │   ├── RefreshTokenRepository.java  # リフレッシュトークンリポジトリインターフェース
│   │   │   ├── RoleRepository.java        # ロールリポジトリインターフェース
│   │   │   ├── UserRepository.java        # ユーザーリポジトリインターフェース
│   │   │   └── jdbc/                      # JDBCリポジトリ実装
│   │   │       ├── JdbcPermissionRepository.java    # 権限リポジトリJDBC実装
│   │   │       ├── JdbcRefreshTokenRepository.java  # リフレッシュトークンリポジトリJDBC実装
│   │   │       ├── JdbcRoleRepository.java          # ロールリポジトリJDBC実装
│   │   │       └── JdbcUserRepository.java          # ユーザーリポジトリJDBC実装
│   │   ├── service/                      # 認証サービス
│   │   │   ├── AuthenticationService.java  # 認証サービスインターフェース
│   │   │   ├── AuthorizationService.java   # 認可サービスインターフェース
│   │   │   ├── JwtProvider.java            # JWTプロバイダーインターフェース
│   │   │   ├── UserService.java            # ユーザーサービスインターフェース
│   │   │   └── impl/                       # サービス実装
│   │   │       ├── AuthenticationServiceImpl.java  # 認証サービス実装
│   │   │       ├── AuthorizationServiceImpl.java   # 認可サービス実装
│   │   │       ├── JwtProviderImpl.java            # JWTプロバイダー実装
│   │   │       └── UserServiceImpl.java            # ユーザーサービス実装
│   │   └── util/                         # 認証ユーティリティ
│   ├── config/                           # 共通設定
│   │   └── SecurityConfig.java           # セキュリティ設定
│   ├── exception/                        # 例外処理
│   │   ├── dto/                          # 例外DTO
│   │   │   └── ErrorResponse.java        # エラーレスポンス
│   │   ├── handler/                      # 例外ハンドラー
│   │   ├── business/                     # ビジネス例外
│   │   └── system/                       # システム例外
│   ├── file/                             # ファイル管理機能
│   │   ├── config/                       # ファイル設定
│   │   ├── controller/                   # ファイルコントローラー
│   │   ├── domain/                       # ファイルドメインモデル
│   │   ├── repository/                   # ファイルリポジトリ
│   │   ├── service/                      # ファイルサービス
│   │   │   └── impl/                     # ファイルサービス実装
│   │   └── storage/                      # ストレージ実装
│   ├── notification/                     # 通知機能
│   │   ├── config/                       # 通知設定
│   │   ├── controller/                   # 通知コントローラー
│   │   ├── domain/                       # 通知ドメインモデル
│   │   ├── repository/                   # 通知リポジトリ
│   │   ├── service/                      # 通知サービス
│   │   │   └── impl/                     # 通知サービス実装
│   │   └── sender/                       # 通知送信実装
│   ├── logging/                          # ロギング機能
│   │   ├── aspect/                       # ロギングアスペクト
│   │   ├── config/                       # ロギング設定
│   │   └── service/                      # ロギングサービス
│   ├── search/                           # 検索機能
│   │   ├── controller/                   # 検索コントローラー
│   │   ├── service/                      # 検索サービス
│   │   └── repository/                   # 検索リポジトリ
│   └── web/                              # Web共通コンポーネント
│       └── controller/                   # 共通コントローラー
│           ├── DashboardController.java  # ダッシュボードコントローラー
│           └── LoginController.java      # ログインコントローラー
├── config/                               # アプリケーション設定
│   ├── ApplicationProperties.java        # アプリケーションプロパティ
│   ├── MDCLoggingFilter.java             # ロギングフィルター
│   ├── SecurityConfig.java               # セキュリティ設定
│   ├── TransactionConfig.java            # トランザクション設定
│   ├── TransactionLoggingAspect.java     # トランザクションロギングアスペクト
│   └── WebConfig.java                    # Webアプリケーション設定
└── [業務モジュール]/                     # 各業務モジュール
    ├── web/                              # Webレイヤー
    │   └── [機能名]Controller.java       # コントローラークラス
    ├── application/                      # アプリケーションレイヤー
    │   ├── [機能名]Service.java          # サービスインターフェース
    │   └── impl/                         # サービス実装
    │       └── [機能名]ServiceImpl.java  # サービス実装クラス
    ├── domain/                           # ドメインレイヤー
    │   ├── [エンティティ名].java         # ドメインエンティティ
    │   └── dto/                          # DTOクラス
    │       ├── [機能名]Dto.java          # 一般DTO
    │       ├── [機能名]Request.java      # リクエストDTO
    │       └── [機能名]Response.java     # レスポンスDTO
    ├── repository/                       # リポジトリレイヤー
    │   ├── [エンティティ名]Repository.java  # リポジトリインターフェース
    │   └── jdbc/                         # JDBC実装
    │       └── Jdbc[エンティティ名]Repository.java  # リポジトリJDBC実装
    └── config/                           # モジュール固有の設定
        └── [モジュール名]Config.java     # モジュール設定クラス
```

### 2.2 リソースファイル構成

```
src/main/resources/
├── application.yml                # アプリケーション共通設定
├── application-dev.yml            # 開発環境設定
├── application-test.yml           # テスト環境設定
├── application-prod.yml           # 本番環境設定
├── logback-spring.xml             # ロギング設定
├── db/                            # データベース関連
│   └── migration/                 # Flyway マイグレーションスクリプト
│       ├── V1__init_schema.sql    # 初期スキーマ作成
│       ├── V2__create_schemas.sql # スキーマ作成
│       ├── V3__create_engineer_tables.sql  # 技術者テーブル作成
│       └── V4__create_project_tables.sql   # 案件テーブル作成
├── static/                        # 静的リソース
│   ├── css/                       # CSS
│   │   └── style.css              # 共通スタイル
│   ├── js/                        # JavaScript
│   │   └── scripts.js             # 共通スクリプト
│   ├── images/                    # 画像
│   │   └── logo.svg               # ロゴ
│   └── lib/                       # 外部ライブラリ
└── templates/                     # Thymeleafテンプレート
    ├── auth/                      # 認証関連ページ
    │   └── login.html             # ログインページ
    ├── common/                    # 共通コンポーネント
    ├── dashboard/                 # ダッシュボード
    │   └── index.html             # メインダッシュボード
    ├── error/                     # エラーページ
    │   ├── 403.html               # アクセス拒否
    │   ├── 404.html               # ページ未検出
    │   └── 500.html               # サーバーエラー
    ├── layout/                    # レイアウト
    │   └── default.html           # デフォルトレイアウト
    └── [業務モジュール]/          # 業務モジュールページ
        ├── list.html              # 一覧ページ
        ├── detail.html            # 詳細ページ
        ├── create.html            # 作成ページ
        └── edit.html              # 編集ページ
```

## 3. src/test ディレクトリ構成

```
src/test/java/jp/co/example/sesapp/
├── common/                         # 共通機能テスト
│   ├── auth/                       # 認証・認可機能テスト
│   │   ├── SecurityIntegrationTest.java  # セキュリティ統合テスト
│   │   ├── repository/                   # リポジトリテスト
│   │   │   └── jdbc/                     # JDBCリポジトリテスト
│   │   │       └── JdbcUserRepositoryTest.java  # ユーザーリポジトリテスト
│   │   ├── service/                      # サービステスト
│   │   │   └── impl/                     # サービス実装テスト
│   │   │       ├── AuthenticationServiceImplTest.java  # 認証サービステスト
│   │   │       ├── AuthorizationServiceImplTest.java   # 認可サービステスト
│   │   │       └── JwtProviderImplTest.java            # JWTプロバイダーテスト
│   │   └── web/                          # Webテスト
│   │       └── controller/               # コントローラーテスト
│   │           └── LoginControllerTest.java  # ログインコントローラーテスト
│   ├── exception/                    # 例外処理テスト
│   ├── file/                         # ファイル管理テスト
│   └── notification/                 # 通知機能テスト
└── [業務モジュール]/                 # 業務モジュールテスト
    ├── web/                          # Webレイヤーテスト
    │   └── [機能名]ControllerTest.java  # コントローラーテスト
    ├── application/                  # アプリケーションレイヤーテスト
    │   └── impl/                     # サービス実装テスト
    │       └── [機能名]ServiceImplTest.java  # サービステスト
    ├── domain/                       # ドメインレイヤーテスト
    │   └── [エンティティ名]Test.java # エンティティテスト
    └── repository/                   # リポジトリレイヤーテスト
        └── jdbc/                     # JDBC実装テスト
            └── Jdbc[エンティティ名]RepositoryTest.java  # リポジトリテスト
```

テストリソース構成:

```
src/test/resources/
├── application-test.yml          # テスト環境設定
└── db/                           # テストデータベース
    └── test-data/                # テストデータ
        ├── auth-schema.sql       # 認証スキーマ
        └── users-test-data.sql   # ユーザーテストデータ
```

## 4. クラスファイル構成

### 4.1 一般的なクラス構成パターン

各種クラスは以下のような内部構成で実装します。

#### エンティティクラス

```java
package jp.co.example.sesapp.[モジュール名].domain;

import ...;

/**
 * [エンティティ名] エンティティ
 */
public class [エンティティ名] {
    // ID
    private UUID id;
    
    // フィールド定義
    private String name;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // コンストラクタ
    
    // ゲッター・セッター
    
    // ビジネスメソッド
    
    // Equals & HashCode
    
    // ToString
}
```

#### コントローラークラス

```java
package jp.co.example.sesapp.[モジュール名].web;

import ...;

/**
 * [機能名] コントローラー
 */
@RestController
@RequestMapping("/api/[リソース名]")
public class [機能名]Controller {
    
    private final [機能名]Service service;
    
    // コンストラクタインジェクション
    public [機能名]Controller([機能名]Service service) {
        this.service = service;
    }
    
    // APIエンドポイント
    @GetMapping
    public ResponseEntity<List<[DTO名]>> getAll() {
        // 実装
    }
    
    @GetMapping("/{id}")
    public ResponseEntity<[DTO名]> getById(@PathVariable UUID id) {
        // 実装
    }
    
    @PostMapping
    public ResponseEntity<[DTO名]> create(@Valid @RequestBody [DTO名] dto) {
        // 実装
    }
    
    @PutMapping("/{id}")
    public ResponseEntity<[DTO名]> update(@PathVariable UUID id, @Valid @RequestBody [DTO名] dto) {
        // 実装
    }
    
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> delete(@PathVariable UUID id) {
        // 実装
    }
}
```

#### サービスインターフェース

```java
package jp.co.example.sesapp.[モジュール名].application;

import ...;

/**
 * [機能名] サービス
 */
public interface [機能名]Service {
    
    /**
     * 全件取得
     */
    List<[DTO名]> findAll();
    
    /**
     * ID指定取得
     */
    Optional<[DTO名]> findById(UUID id);
    
    /**
     * 作成
     */
    [DTO名] create([DTO名] dto);
    
    /**
     * 更新
     */
    [DTO名] update(UUID id, [DTO名] dto);
    
    /**
     * 削除
     */
    void delete(UUID id);
}
```

#### サービス実装クラス

```java
package jp.co.example.sesapp.[モジュール名].application.impl;

import ...;

/**
 * [機能名] サービス実装
 */
@Service
@Transactional
public class [機能名]ServiceImpl implements [機能名]Service {
    
    private final [エンティティ名]Repository repository;
    
    // コンストラクタインジェクション
    public [機能名]ServiceImpl([エンティティ名]Repository repository) {
        this.repository = repository;
    }
    
    @Override
    @Transactional(readOnly = true)
    public List<[DTO名]> findAll() {
        // 実装
    }
    
    @Override
    @Transactional(readOnly = true)
    public Optional<[DTO名]> findById(UUID id) {
        // 実装
    }
    
    @Override
    public [DTO名] create([DTO名] dto) {
        // 実装
    }
    
    @Override
    public [DTO名] update(UUID id, [DTO名] dto) {
        // 実装
    }
    
    @Override
    public void delete(UUID id) {
        // 実装
    }
}
```

#### リポジトリインターフェース

```java
package jp.co.example.sesapp.[モジュール名].repository;

import ...;

/**
 * [エンティティ名] リポジトリ
 */
public interface [エンティティ名]Repository {
    
    /**
     * 全件取得
     */
    List<[エンティティ名]> findAll();
    
    /**
     * ID指定取得
     */
    Optional<[エンティティ名]> findById(UUID id);
    
    /**
     * 保存
     */
    [エンティティ名] save([エンティティ名] entity);
    
    /**
     * 削除
     */
    void deleteById(UUID id);
    
    // カスタムクエリメソッド
}
```

#### リポジトリJDBC実装クラス

```java
package jp.co.example.sesapp.[モジュール名].repository.jdbc;

import ...;

/**
 * [エンティティ名] リポジトリJDBC実装
 */
@Repository
public class Jdbc[エンティティ名]Repository implements [エンティティ名]Repository {
    
    private final NamedParameterJdbcTemplate jdbcTemplate;
    private final RowMapper<[エンティティ名]> rowMapper;
    
    // コンストラクタインジェクション
    public Jdbc[エンティティ名]Repository(NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
        this.rowMapper = new [エンティティ名]RowMapper();
    }
    
    @Override
    public List<[エンティティ名]> findAll() {
        // 実装
    }
    
    @Override
    public Optional<[エンティティ名]> findById(UUID id) {
        // 実装
    }
    
    @Override
    public [エンティティ名] save([エンティティ名] entity) {
        // 実装
    }
    
    @Override
    public void deleteById(UUID id) {
        // 実装
    }
    
    // RowMapperクラス
    private static class [エンティティ名]RowMapper implements RowMapper<[エンティティ名]> {
        @Override
        public [エンティティ名] mapRow(ResultSet rs, int rowNum) throws SQLException {
            // 実装
        }
    }
}
```

## 5. テストクラス構成

テストクラスは以下のような内部構成で実装します。

### 単体テスト

```java
package jp.co.example.sesapp.[モジュール名].[レイヤー名];

import ...;

/**
 * [クラス名] テスト
 */
@ExtendWith(MockitoExtension.class)
public class [クラス名]Test {
    
    @Mock
    private [依存クラス] dependencyMock;
    
    @InjectMocks
    private [テスト対象クラス] target;
    
    @BeforeEach
    public void setup() {
        // セットアップ
    }
    
    @Test
    public void test[メソッド名]_[テストシナリオ]() {
        // 準備
        
        // 実行
        
        // 検証
    }
}
```

### 統合テスト

```java
package jp.co.example.sesapp.[モジュール名].[レイヤー名];

import ...;

/**
 * [クラス名] 統合テスト
 */
@SpringBootTest
@Transactional
public class [クラス名]IntegrationTest {
    
    @Autowired
    private [テスト対象クラス] target;
    
    @Autowired
    private [依存クラス] dependency;
    
    @BeforeEach
    public void setup() {
        // セットアップ
    }
    
    @Test
    public void test[メソッド名]_[テストシナリオ]() {
        // 準備
        
        // 実行
        
        // 検証
    }
}
```

## 6. 開発ガイドライン

プログラムファイル構成に関する開発ガイドラインは以下の通りです：

1. **フォルダ構造の遵守**：定義された構造に従ってファイルを配置する
2. **命名規則の統一**：クラス・パッケージ・ファイル名の命名規則を厳守する
3. **レイヤー間の責務分離**：各レイヤーの責務に合わせてコードを実装する
4. **テストカバレッジの確保**：全クラスに対応するテストクラスを作成する
5. **コメント記述**：クラス・メソッドには適切なJavadocコメントを付与する
6. **設定の環境分離**：環境依存の設定は適切なプロファイルに分離する
7. **リソースファイルの整理**：静的リソースは適切なディレクトリに配置する
8. **テンプレートの標準化**：画面テンプレートは統一されたレイアウトを使用する
9. **マイグレーションスクリプトの管理**：データベースマイグレーションは順序を守って管理する
10. **業務ロジックの分離**：業務ロジックはサービス層に集約し、コントローラーは薄く保つ