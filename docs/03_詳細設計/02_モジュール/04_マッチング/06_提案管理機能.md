# 提案管理機能

## 1. 機能概要

提案管理機能は、マッチング結果に基づいて技術者を案件に提案するプロセスを管理します。提案の作成、提案ステータスの追跡、提案履歴の管理、提案統計の分析などの機能を提供します。営業活動の効率化、提案プロセスの透明性確保、成約率の向上を支援します。

## 2. 処理フロー

### 2.1 提案作成フロー

1. 案件ID、技術者ID、マッチング結果IDの受け取り
2. 案件・技術者・マッチング結果の存在確認
3. 提案の重複チェック
4. 技術者の稼働状況確認
5. 案件ステータスの確認
6. 提案データの作成（単価、稼働開始日等のパラメータ設定）
7. 提案履歴の初期エントリ作成
8. 永続化処理
9. 関係者への通知
10. 作成された提案の返却

### 2.2 提案ステータス更新フロー

1. 提案IDと新ステータス情報の受け取り
2. 提案の存在確認
3. ステータス遷移の妥当性チェック
4. ステータス更新処理
5. 提案履歴への新エントリ追加
6. 永続化処理
7. 関係者への通知
8. ステータスに応じた後続処理（成約時の契約情報連携など）
9. 更新された提案の返却

### 2.3 提案取得フロー

1. 提案IDの受け取り
2. 提案の存在確認
3. 権限チェック
4. 関連情報（案件詳細、技術者詳細）の取得
5. 提案データの返却

### 2.4 案件別提案一覧取得フロー

1. 案件IDとフィルタ条件の受け取り
2. 権限チェック
3. 提案データの取得
4. フィルタリング処理
5. ソートとページング処理
6. 提案一覧の返却

### 2.5 技術者別提案一覧取得フロー

1. 技術者IDとフィルタ条件の受け取り
2. 権限チェック
3. 提案データの取得
4. フィルタリング処理
5. ソートとページング処理
6. 提案一覧の返却

## 3. 主要コンポーネント構成

### 3.1 ProposalService

提案管理機能の主要サービスインターフェースです。

```java
interface ProposalService {
    Proposal createProposal(String projectId, String engineerId, String matchingResultId, ProposalCreateRequest request);
    Proposal updateProposalStatus(String proposalId, ProposalStatus newStatus, String notes);
    Proposal getProposal(String proposalId);
    List<Proposal> getProposalsForProject(String projectId, List<ProposalStatus> statuses, Pageable pageable);
    List<Proposal> getProposalsForEngineer(String engineerId, List<ProposalStatus> statuses, Pageable pageable);
    ProposalStatistics getProposalStatistics(ProposalStatisticsRequest request);
    void cancelProposal(String proposalId, String reason);
}
```

### 3.2 ProposalRepository

提案データを永続化するためのリポジトリです。

```java
interface ProposalRepository {
    Proposal save(Proposal proposal);
    Optional<Proposal> findById(String id);
    List<Proposal> findByProjectId(String projectId, Pageable pageable);
    List<Proposal> findByProjectIdAndStatusIn(String projectId, List<ProposalStatus> statuses, Pageable pageable);
    List<Proposal> findByEngineerId(String engineerId, Pageable pageable);
    List<Proposal> findByEngineerIdAndStatusIn(String engineerId, List<ProposalStatus> statuses, Pageable pageable);
    List<Proposal> findByProjectIdAndEngineerIdAndStatus(String projectId, String engineerId, ProposalStatus status);
    List<Proposal> findByCreatedBetween(LocalDateTime start, LocalDateTime end, Pageable pageable);
    long countByStatusAndCreatedBetween(ProposalStatus status, LocalDateTime start, LocalDateTime end);
}
```

### 3.3 ProposalValidator

提案データの検証を行うコンポーネントです。

```java
interface ProposalValidator {
    ValidationResult validateForCreation(String projectId, String engineerId, String matchingResultId, ProposalCreateRequest request);
    ValidationResult validateStatusTransition(Proposal proposal, ProposalStatus newStatus);
    boolean isDuplicate(String projectId, String engineerId);
    boolean isEngineerAvailable(String engineerId, LocalDate startDate, LocalDate endDate);
    boolean isProjectValid(String projectId);
}
```

### 3.4 ProposalWorkflowManager

提案ワークフローを管理するコンポーネントです。

```java
interface ProposalWorkflowManager {
    boolean canTransition(ProposalStatus currentStatus, ProposalStatus newStatus);
    List<ProposalStatus> getNextPossibleStatuses(ProposalStatus currentStatus);
    void performStatusTransition(Proposal proposal, ProposalStatus newStatus, String notes);
    void performPostTransitionActions(Proposal proposal, ProposalStatus oldStatus, ProposalStatus newStatus);
}
```

### 3.5 ProposalNotifier

提案に関する通知を送信するコンポーネントです。

```java
interface ProposalNotifier {
    void notifyProposalCreation(Proposal proposal, List<String> recipientIds);
    void notifyStatusChange(Proposal proposal, ProposalStatus oldStatus, List<String> recipientIds);
    void notifyCancellation(Proposal proposal, String reason, List<String> recipientIds);
    void notifyDeadlineApproaching(Proposal proposal, List<String> recipientIds);
}
```

### 3.6 ProposalAnalyzer

提案データの分析を行うコンポーネントです。

```java
interface ProposalAnalyzer {
    ProposalStatistics calculateStatistics(ProposalStatisticsRequest request);
    double calculateConversionRate(LocalDateTime start, LocalDateTime end);
    Map<ProposalStatus, Integer> getStatusDistribution(LocalDateTime start, LocalDateTime end);
    List<ProposalTrend> analyzeProposalTrends(LocalDateTime start, LocalDateTime end, TemporalUnit unit);
}
```

## 4. 例外処理

### 4.1 ProposalNotFoundException

指定された提案IDが存在しない場合に発生する例外です。

```java
class ProposalNotFoundException extends ResourceNotFoundException {
    // コンストラクタ、getterなど
}
```

### 4.2 DuplicateProposalException

同一の案件-技術者の組み合わせで重複する提案が存在する場合に発生する例外です。

```java
class DuplicateProposalException extends BusinessRuleException {
    private String existingProposalId;
    private ProposalStatus existingStatus;
    
    // コンストラクタ、getterなど
}
```

### 4.3 InvalidProposalDataException

提案データが不正な場合に発生する例外です。

```java
class InvalidProposalDataException extends ValidationException {
    // コンストラクタ、getterなど
}
```

### 4.4 InvalidStatusTransitionException

無効なステータス遷移が試みられた場合に発生する例外です。

```java
class InvalidStatusTransitionException extends BusinessRuleException {
    private ProposalStatus currentStatus;
    private ProposalStatus newStatus;
    private List<ProposalStatus> allowedStatuses;
    
    // コンストラクタ、getterなど
}
```

## 5. 提案ワークフロー詳細

### 5.1 ステータス定義

- **DRAFT**: 下書き - 提案データ作成中の状態
- **PENDING**: 提案準備中 - 提案書作成など、提案準備が進行中の状態
- **PRESENTED**: 提案済み - クライアントに提案済みの状態
- **INTERVIEW**: 面談調整中 - 面談の日程調整や準備を行っている状態
- **ACCEPTED**: 成約 - 提案が受け入れられ、契約に進んだ状態
- **REJECTED**: 不成約 - 提案が不採用となった状態
- **CANCELLED**: キャンセル - 何らかの理由で提案がキャンセルされた状態

### 5.2 ステータス遷移ルール

以下の遷移のみが許可されます：

- DRAFT → PENDING
- PENDING → PRESENTED
- PENDING → CANCELLED
- PRESENTED → INTERVIEW
- PRESENTED → REJECTED
- PRESENTED → CANCELLED
- INTERVIEW → ACCEPTED
- INTERVIEW → REJECTED
- INTERVIEW → CANCELLED

### 5.3 ステータス別アクション

#### 5.3.1 DRAFTステータス時のアクション

- 提案データの編集
- 提案単価の設定
- 提案内容のレビュー
- PENDINGステータスへの移行

#### 5.3.2 PENDINGステータス時のアクション

- 提案書の作成
- 技術者への確認
- 提案内容の最終確認
- PRESENTEDステータスへの移行

#### 5.3.3 PRESENTEDステータス時のアクション

- クライアントからの反応記録
- 追加質問への対応
- INTERVIEWステータスへの移行
- REJECTEDステータスへの移行

#### 5.3.4 INTERVIEWステータス時のアクション

- 面談日程の調整
- 面談準備資料の作成
- 面談実施記録
- ACCEPTEDステータスへの移行
- REJECTEDステータスへの移行

#### 5.3.5 ACCEPTEDステータス時のアクション

- 契約情報への連携
- 稼働開始準備
- 技術者への通知
- 案件管理システムへの反映

#### 5.3.6 REJECTEDステータス時のアクション

- 不採用理由の記録
- フィードバックの整理
- 代替案件の検討
- マッチングアルゴリズムへのフィードバック

#### 5.3.7 CANCELLEDステータス時のアクション

- キャンセル理由の記録
- 関係者への通知
- 代替案の検討

## 6. 提案分析機能詳細

### 6.1 提案統計情報

1. 期間別提案件数
2. ステータス別提案分布
3. 成約率（全体、営業担当者別、案件カテゴリ別）
4. 提案から成約までの平均期間
5. 不成約理由の分類と割合

### 6.2 傾向分析

1. 時系列での提案件数・成約率の変化
2. 季節・月別の提案傾向
3. スキルカテゴリ別の提案傾向
4. 単価帯別の成約率分析
5. クライアント企業別の成約パターン分析

### 6.3 パフォーマンス分析

1. 営業担当者別のパフォーマンス指標
2. 提案から面談までの平均所要日数
3. 面談から成約までの平均所要日数
4. 提案書の品質評価と成約率の相関
5. マッチングスコアと成約率の相関