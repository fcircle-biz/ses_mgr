# マッチング検索機能

## 1. 機能概要

マッチング検索機能は、案件と技術者のマッチングを効率的に行うための検索機能を提供します。案件条件に合致する技術者の検索、技術者条件に合致する案件の検索、およびそれらの検索結果の管理を行います。AIを活用した高度なマッチングアルゴリズムにより、正確なマッチングを実現します。

## 2. 処理フロー

### 2.1 案件から技術者検索フロー

1. 案件IDまたは検索条件の受け取り
2. 案件IDの場合は案件管理モジュールから案件情報の取得
3. 検索条件の正規化と解析
4. 技術者管理モジュールから検索対象技術者データの取得
5. マッチングアルゴリズムによるスコアリング計算
6. 結果のソートとページング
7. マッチング結果の保存（オプション）
8. 検索履歴の保存（オプション）
9. 結果の返却

### 2.2 技術者から案件検索フロー

1. 技術者IDまたは検索条件の受け取り
2. 技術者IDの場合は技術者管理モジュールから技術者情報の取得
3. 検索条件の正規化と解析
4. 案件管理モジュールから検索対象案件データの取得
5. マッチングアルゴリズムによるスコアリング計算
6. 結果のソートとページング
7. マッチング結果の保存（オプション）
8. 検索履歴の保存（オプション）
9. 結果の返却

### 2.3 検索パラメータ取得フロー

1. パラメータカテゴリと検索クエリの受け取り
2. マスタデータからのパラメータ情報の取得
3. 検索クエリによるフィルタリング（指定された場合）
4. カテゴリ別にグループ化された結果の返却

### 2.4 検索履歴取得フロー

1. 検索タイプとページネーション情報の受け取り
2. ユーザーIDに基づく検索履歴の取得
3. 検索タイプによるフィルタリング（指定された場合）
4. ページング処理の適用
5. 結果の返却

## 3. 主要コンポーネント構成

### 3.1 MatchingSearchService

マッチング検索機能の主要サービスインターフェースで、実際の検索リクエストを処理します。

```java
interface MatchingSearchService {
    List<MatchingResult> searchEngineersForProject(String projectId, SearchCriteria criteria, Pageable pageable, boolean saveSearch);
    List<MatchingResult> searchProjectsForEngineer(String engineerId, SearchCriteria criteria, Pageable pageable, boolean saveSearch);
    Map<String, List<SearchParameter>> getSearchParameters(String category, String query);
    Page<MatchingSearch> getSearchHistory(MatchingSearchType type, Pageable pageable);
}
```

### 3.2 MatchingAlgorithm

マッチングスコアを計算するアルゴリズムを提供するコンポーネントです。

```java
interface MatchingAlgorithm {
    MatchingResult calculateMatch(Project project, Engineer engineer);
    MatchingResult calculateMatch(SearchCriteria projectCriteria, Engineer engineer);
    MatchingResult calculateMatch(Engineer engineer, Project project);
    MatchingResult calculateMatch(SearchCriteria engineerCriteria, Project project);
}
```

### 3.3 SearchCriteriaParser

検索条件を解析し、マッチングに適した形式に変換するコンポーネントです。

```java
interface SearchCriteriaParser {
    SearchCriteria parseFromProject(Project project);
    SearchCriteria parseFromEngineer(Engineer engineer);
    SearchCriteria normalize(SearchCriteria criteria);
}
```

### 3.4 MatchingResultRepository

マッチング結果を永続化するためのリポジトリです。

```java
interface MatchingResultRepository {
    MatchingResult save(MatchingResult result);
    Optional<MatchingResult> findById(String id);
    List<MatchingResult> findByProjectId(String projectId, Pageable pageable);
    List<MatchingResult> findByEngineerId(String engineerId, Pageable pageable);
}
```

### 3.5 SearchHistoryRepository

検索履歴を永続化するためのリポジトリです。

```java
interface SearchHistoryRepository {
    MatchingSearch save(MatchingSearch search);
    Optional<MatchingSearch> findById(String id);
    Page<MatchingSearch> findByUserIdAndType(String userId, MatchingSearchType type, Pageable pageable);
}
```

## 4. 例外処理

### 4.1 ResourceNotFoundException

指定されたリソース（案件ID、技術者IDなど）が存在しない場合に発生する例外です。

```java
class ResourceNotFoundException extends RuntimeException {
    private String resourceType;
    private String resourceId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 ValidationException

検索条件が不正な場合に発生する例外です。

```java
class ValidationException extends RuntimeException {
    private Map<String, String> validationErrors;
    
    // コンストラクタ、getterなど
}
```

### 4.3 SearchLimitExceededException

検索制限（回数、頻度など）を超えた場合に発生する例外です。

```java
class SearchLimitExceededException extends RuntimeException {
    private String limitType;
    private int currentValue;
    private int maxValue;
    
    // コンストラクタ、getterなど
}
```

## 5. マッチングアルゴリズム詳細

### 5.1 スキルマッチング

1. スキル要求レベルとエンジニアのスキルレベルを比較
2. 重要度（必須、望ましい、任意）に基づいた重み付け
3. スキル種別（プログラミング言語、フレームワーク、ツールなど）ごとの重み付け
4. 合計スコアの計算（0〜100点）

### 5.2 経験マッチング

1. 業界経験、役割経験、プロジェクトタイプ経験の比較
2. 要求年数と実績年数の比較
3. 重要度に基づいた重み付け
4. 合計スコアの計算（0〜100点）

### 5.3 資格マッチング

1. 要求資格と保有資格の比較
2. 資格の有効期限確認
3. 重要度に基づいた重み付け
4. 合計スコアの計算（0〜100点）

### 5.4 勤務地マッチング

1. 要求勤務地とエンジニアの希望勤務地の比較
2. リモートワーク条件の比較
3. 通勤時間・距離の考慮
4. 合計スコアの計算（0〜100点）

### 5.5 勤務条件マッチング

1. 単価条件の比較
2. 稼働期間の比較
3. 稼働日数・時間の比較
4. 契約形態の比較
5. 合計スコアの計算（0〜100点）

### 5.6 総合スコア計算

各要素スコアに重み付けを適用して総合スコアを算出します。

- スキルマッチング：40%
- 経験マッチング：30%
- 資格マッチング：10%
- 勤務地マッチング：10%
- 勤務条件マッチング：10%

## 6. 検索最適化手法

### 6.1 インデックス最適化

1. スキルタグに基づくインデックス作成
2. 経験業界に基づくインデックス作成
3. 勤務地に基づくインデックス作成
4. 稼働可能時期に基づくインデックス作成

### 6.2 キャッシュ戦略

1. 頻繁に使用される検索条件の結果をキャッシュ
2. 技術者データの部分的なキャッシュ
3. 案件データの部分的なキャッシュ
4. キャッシュの有効期限設定（技術者データは1日、案件データは1時間など）

### 6.3 並列処理

1. 複数の技術者データの並列スコアリング
2. 複数の案件データの並列スコアリング
3. スコアリング処理の非同期実行
4. 結果の集約と統合