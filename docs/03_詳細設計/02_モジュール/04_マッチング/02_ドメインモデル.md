# マッチング機能 ドメインモデル

## 1. エンティティ定義

### 1.1 MatchingResult（マッチング結果）

マッチング検索の結果を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | マッチング結果ID | 主キー、UUID形式 |
| projectId | String | 案件ID | 必須、案件管理モジュールの案件IDと紐付け |
| engineerId | String | 技術者ID | 必須、技術者管理モジュールの技術者IDと紐付け |
| matchingScore | Decimal | マッチングスコア | 必須、0.0〜100.0の範囲 |
| matchingDetails | MatchingDetails | マッチング詳細 | 必須 |
| created | DateTime | 作成日時 | 必須 |
| lastUpdated | DateTime | 最終更新日時 | 必須 |
| status | MatchingResultStatus | ステータス | 必須 |

**ビジネスルール**：
- マッチングスコアは要素別スコアの重み付け合計で算出される
- スコア70以上は「高マッチ」、50〜69は「中マッチ」、49以下は「低マッチ」とみなされる

### 1.2 MatchingSearch（マッチング検索）

マッチング検索の条件と履歴を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 検索ID | 主キー、UUID形式 |
| type | MatchingSearchType | 検索タイプ | 必須 |
| criteria | SearchCriteria | 検索条件 | 必須 |
| resultIds | List\<String\> | 結果ID一覧 | 空リスト許容 |
| userId | String | 実行ユーザーID | 必須 |
| created | DateTime | 作成日時 | 必須 |
| saved | Boolean | 保存フラグ | 必須 |
| name | String | 検索名 | savedがtrueの場合は必須 |

**ビジネスルール**：
- 検索履歴は30日間保持される
- 保存された検索条件は明示的に削除されるまで保持される

### 1.3 Proposal（提案）

技術者を案件に提案する情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 提案ID | 主キー、UUID形式 |
| projectId | String | 案件ID | 必須、案件管理モジュールの案件IDと紐付け |
| engineerId | String | 技術者ID | 必須、技術者管理モジュールの技術者IDと紐付け |
| matchingResultId | String | マッチング結果ID | 必須、MatchingResultのIDと紐付け |
| proposalDate | Date | 提案日 | 必須 |
| status | ProposalStatus | 提案状態 | 必須 |
| rate | Integer | 提案単価 | 必須、0以上 |
| workStartDate | Date | 稼働開始日 | 必須 |
| workEndDate | Date | 稼働終了日 | 任意 |
| notes | String | 備考 | 任意、1000文字以内 |
| documents | List\<ProposalDocument\> | 提案書類一覧 | 空リスト許容 |
| history | List\<ProposalHistory\> | 履歴 | 空リスト不可、必ず1つ以上の履歴が存在する |
| created | DateTime | 作成日時 | 必須 |
| createdBy | User | 作成者 | 必須 |
| lastUpdated | DateTime | 最終更新日時 | 必須 |
| lastUpdatedBy | User | 最終更新者 | 必須 |

**ビジネスルール**：
- 提案状態が「成約」に変更された場合、契約管理モジュールに連携して契約情報を作成する
- 同一技術者の同一期間での重複提案は、提案ステータスが「不成約」「キャンセル」の場合のみ許可される

### 1.4 ProposalDocument（提案書類）

提案に関連する書類を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 書類ID | 主キー、UUID形式 |
| proposalId | String | 提案ID | 必須、ProposalのIDと紐付け |
| name | String | 書類名 | 必須、100文字以内 |
| type | DocumentType | 書類種別 | 必須 |
| fileId | String | ファイルID | 必須、ファイル管理モジュールのファイルIDと紐付け |
| version | Integer | バージョン | 必須、1以上 |
| created | DateTime | 作成日時 | 必須 |
| createdBy | User | 作成者 | 必須 |

**ビジネスルール**：
- 提案書のバージョン管理を行い、履歴を保持する
- 送付済みの提案書は削除できない

## 2. 値オブジェクト定義

### 2.1 MatchingDetails（マッチング詳細）

マッチング結果の詳細を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| skills | SkillMatchResult | スキルマッチング結果 |
| experience | ExperienceMatchResult | 経験マッチング結果 |
| qualifications | QualificationMatchResult | 資格マッチング結果 |
| workLocation | WorkLocationMatchResult | 勤務地マッチング結果 |
| workConditions | WorkConditionMatchResult | 勤務条件マッチング結果 |

### 2.2 SkillMatchResult（スキルマッチング結果）

スキルのマッチング結果を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| score | Decimal | スキルスコア（0.0〜100.0） |
| details | List\<SkillMatchDetail\> | スキル別マッチング詳細 |

### 2.3 SkillMatchDetail（スキルマッチング詳細）

個々のスキルのマッチング詳細を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| skillId | String | スキルID |
| skillName | String | スキル名 |
| required | Integer | 要求レベル（1〜5） |
| actual | Integer | 実際レベル（1〜5） |
| match | Boolean | マッチフラグ |

### 2.4 ExperienceMatchResult（経験マッチング結果）

経験のマッチング結果を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| score | Decimal | 経験スコア（0.0〜100.0） |
| details | List\<ExperienceMatchDetail\> | 経験別マッチング詳細 |

### 2.5 SearchCriteria（検索条件）

マッチング検索条件を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| skills | List\<SkillCriteria\> | スキル条件一覧 |
| experience | List\<ExperienceCriteria\> | 経験条件一覧 |
| qualifications | List\<QualificationCriteria\> | 資格条件一覧 |
| workLocation | WorkLocationCriteria | 勤務地条件 |
| workConditions | WorkConditionCriteria | 勤務条件 |

### 2.6 ProposalHistory（提案履歴）

提案状態の変更履歴を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| status | ProposalStatus | 提案状態 |
| date | DateTime | 変更日時 |
| userId | String | 変更ユーザーID |
| userName | String | 変更ユーザー名 |
| notes | String | 備考 |

## 3. 列挙型定義

### 3.1 MatchingResultStatus（マッチング結果ステータス）

```
enum MatchingResultStatus {
  ACTIVE,    // 有効
  INACTIVE   // 無効（案件または技術者が無効化された場合など）
}
```

### 3.2 MatchingSearchType（マッチング検索タイプ）

```
enum MatchingSearchType {
  PROJECT_TO_ENGINEERS,  // 案件→技術者検索
  ENGINEER_TO_PROJECTS   // 技術者→案件検索
}
```

### 3.3 ProposalStatus（提案状態）

```
enum ProposalStatus {
  DRAFT,     // 下書き
  PENDING,   // 提案中
  PRESENTED, // 提案済み
  INTERVIEW, // 面談調整中
  ACCEPTED,  // 成約
  REJECTED,  // 不成約
  CANCELLED  // キャンセル
}
```

### 3.4 DocumentType（書類種別）

```
enum DocumentType {
  SKILL_SHEET,       // スキルシート
  PROPOSAL_DOCUMENT, // 提案書
  RESUME,            // 経歴書
  AGREEMENT,         // 同意書
  OTHER              // その他
}
```

### 3.5 ImportanceLevel（重要度レベル）

```
enum ImportanceLevel {
  REQUIRED,  // 必須
  PREFERRED, // 望ましい
  OPTIONAL   // 任意
}
```

## 4. ドメイン関連図

```
MatchingResult 1 --- 1 MatchingDetails
MatchingResult * --- 1 Proposal
Proposal 1 --- * ProposalDocument
Proposal 1 --- * ProposalHistory
MatchingSearch 1 --- * MatchingResult
MatchingSearch 1 --- 1 SearchCriteria
```

## 5. 重要なビジネスルール

### 5.1 マッチングスコア計算ルール

マッチングスコアは、以下の要素のスコアを重み付けして計算します。

- スキルマッチ：40%
- 経験マッチ：30%
- 資格マッチ：10%
- 勤務地マッチ：10%
- 勤務条件マッチ：10%

各要素のスコアは0〜100点で計算され、重み付けした合計がマッチングスコアとなります。

### 5.2 スキルマッチング計算ルール

スキルマッチングは、以下のルールに基づいて計算します。

- 要求レベル以上のスキルレベルを持つ場合：100点
- 要求レベルより1低いスキルレベルを持つ場合：70点
- 要求レベルより2低いスキルレベルを持つ場合：40点
- 要求レベルより3以上低いスキルレベルを持つ場合：0点
- スキルを持たない場合：0点

重要度（ImportanceLevel）によって、各スキルの重みが変わります。
- REQUIRED：係数1.0
- PREFERRED：係数0.7
- OPTIONAL：係数0.3

### 5.3 提案ワークフロールール

提案ステータスは以下の遷移のみが許可されます。

- DRAFT → PENDING：提案が完成し、提案準備完了時
- PENDING → PRESENTED：クライアントへの提案実施時
- PRESENTED → INTERVIEW：面談設定時
- INTERVIEW → ACCEPTED：成約時
- INTERVIEW → REJECTED：不成約時
- PENDING/PRESENTED/INTERVIEW → CANCELLED：提案取消時

ステータスが変更される際には、必ずProposalHistoryに履歴を残します。