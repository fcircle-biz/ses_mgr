# 提案書管理機能

## 1. 機能概要

提案書管理機能は、技術者を案件に提案する際に必要な提案書の生成、管理、バージョン管理を行う機能を提供します。技術者のスキルシートから自動的に提案書を生成し、テンプレートベースのカスタマイズ、PDFへの変換、提案書の保管と検索、バージョン管理などを実現します。これにより、品質の高い提案書を効率的に作成し、提案プロセスを効率化します。

## 2. 処理フロー

### 2.1 提案書生成フロー

1. 提案IDと書類タイプの受け取り
2. 提案の存在確認と関連情報の取得
3. テンプレートの選択
4. 技術者情報・スキル情報の取得
5. 案件情報の取得
6. テンプレートにデータを適用
7. カスタマイズパラメータの適用
8. 書類のレンダリング（HTML/PDF等）
9. ファイルの保存（ファイル管理機能連携）
10. 提案書メタデータの作成と保存
11. 生成された提案書情報の返却

### 2.2 提案書取得フロー

1. 提案書IDの受け取り
2. 提案書メタデータの取得
3. 権限チェック
4. ファイルIDを使用したファイル内容の取得
5. 提案書データの返却

### 2.3 提案別書類一覧取得フロー

1. 提案IDと書類タイプの受け取り
2. 権限チェック
3. 提案に関連する書類メタデータの取得
4. フィルタリング処理（書類タイプによる）
5. ソート処理（作成日時、バージョン等）
6. 提案書類一覧の返却

### 2.4 提案書更新フロー

1. 提案書IDと更新内容の受け取り
2. 提案書の存在確認
3. 権限チェック
4. 変更可能かのチェック（送付済み書類の保護）
5. 更新内容の適用
6. 新バージョンの書類生成
7. ファイルの保存（ファイル管理機能連携）
8. 提案書メタデータの更新
9. 更新された提案書情報の返却

## 3. 主要コンポーネント構成

### 3.1 ProposalDocumentService

提案書管理機能の主要サービスインターフェースです。

```java
interface ProposalDocumentService {
    ProposalDocument generateProposalDocument(String proposalId, DocumentType type, DocumentGenerateRequest request);
    ProposalDocument getProposalDocument(String documentId);
    List<ProposalDocument> getProposalDocumentsForProposal(String proposalId, DocumentType type);
    ProposalDocument updateProposalDocument(String documentId, DocumentUpdateRequest request);
    void deleteProposalDocument(String documentId);
    byte[] downloadProposalDocument(String documentId);
    String shareProposalDocument(String documentId, DocumentShareRequest request);
}
```

### 3.2 ProposalDocumentRepository

提案書メタデータを永続化するためのリポジトリです。

```java
interface ProposalDocumentRepository {
    ProposalDocument save(ProposalDocument document);
    Optional<ProposalDocument> findById(String id);
    List<ProposalDocument> findByProposalId(String proposalId);
    List<ProposalDocument> findByProposalIdAndType(String proposalId, DocumentType type);
    List<ProposalDocument> findByProposalIdAndTypeOrderByVersionDesc(String proposalId, DocumentType type);
    Optional<ProposalDocument> findByProposalIdAndTypeAndVersion(String proposalId, DocumentType type, int version);
}
```

### 3.3 DocumentGenerator

提案書を生成するコンポーネントです。

```java
interface DocumentGenerator {
    byte[] generateDocument(DocumentTemplate template, Map<String, Object> data, OutputFormat format);
    byte[] generateSkillSheet(Engineer engineer, DocumentTemplate template, Map<String, Object> data, OutputFormat format);
    byte[] generateProposalSheet(Proposal proposal, Engineer engineer, Project project, DocumentTemplate template, Map<String, Object> data, OutputFormat format);
    byte[] generateAgreement(Proposal proposal, Engineer engineer, Project project, DocumentTemplate template, Map<String, Object> data, OutputFormat format);
}
```

### 3.4 TemplateManager

提案書テンプレートを管理するコンポーネントです。

```java
interface TemplateManager {
    DocumentTemplate getTemplate(String templateId);
    DocumentTemplate getDefaultTemplate(DocumentType type);
    List<DocumentTemplate> getTemplatesByType(DocumentType type);
    DocumentTemplate saveTemplate(DocumentTemplate template);
    void deleteTemplate(String templateId);
}
```

### 3.5 DocumentRenderer

テンプレートとデータからドキュメントをレンダリングするコンポーネントです。

```java
interface DocumentRenderer {
    byte[] renderToHtml(String templateContent, Map<String, Object> data);
    byte[] renderToPdf(String templateContent, Map<String, Object> data);
    byte[] renderToWord(String templateContent, Map<String, Object> data);
    byte[] convertHtmlToPdf(byte[] htmlContent);
    byte[] convertHtmlToWord(byte[] htmlContent);
}
```

### 3.6 DocumentDataProvider

提案書生成に必要なデータを収集するコンポーネントです。

```java
interface DocumentDataProvider {
    Map<String, Object> getEngineerData(String engineerId);
    Map<String, Object> getProjectData(String projectId);
    Map<String, Object> getProposalData(String proposalId);
    Map<String, Object> getSkillData(String engineerId);
    Map<String, Object> getCompanyData();
    Map<String, Object> getCombinedData(String proposalId);
}
```

## 4. 例外処理

### 4.1 DocumentNotFoundException

指定された提案書IDが存在しない場合に発生する例外です。

```java
class DocumentNotFoundException extends ResourceNotFoundException {
    // コンストラクタ、getterなど
}
```

### 4.2 TemplateNotFoundException

指定されたテンプレートIDが存在しない場合に発生する例外です。

```java
class TemplateNotFoundException extends ResourceNotFoundException {
    // コンストラクタ、getterなど
}
```

### 4.3 DocumentGenerationException

提案書の生成中にエラーが発生した場合の例外です。

```java
class DocumentGenerationException extends ApplicationException {
    private String failureReason;
    private Map<String, String> templateErrors;
    
    // コンストラクタ、getterなど
}
```

### 4.4 DocumentUpdateNotAllowedException

送付済みなど更新が許可されない提案書の更新が試みられた場合に発生する例外です。

```java
class DocumentUpdateNotAllowedException extends BusinessRuleException {
    private String documentId;
    private String reason;
    
    // コンストラクタ、getterなど
}
```

## 5. 提案書テンプレート機能詳細

### 5.1 テンプレート種別

1. スキルシートテンプレート
   - 技術者の基本情報、スキル、経験を整理したテンプレート
   - レベル表示のグラフィカル表現を含む

2. 提案書テンプレート
   - 案件に対して技術者を提案するための正式文書テンプレート
   - 企業ロゴ、フォーマットを含む

3. 合意書テンプレート
   - 提案合意のための文書テンプレート
   - 法的な文言を含む

4. 経歴書テンプレート
   - 技術者の経歴を詳細に記載するテンプレート
   - プロジェクト履歴、担当業務を含む

### 5.2 テンプレートエンジン

1. テンプレート記法
   - Handlebars/Mustache形式の変数置換
   - 条件分岐（if-else）
   - 繰り返し処理（each）
   - ヘルパー関数（日付フォーマット、数値フォーマットなど）

2. テンプレート構造
   - HTMLベースの構造定義
   - CSSによるスタイル定義
   - 埋め込み画像のBase64エンコード
   - ページ区切り、ヘッダー・フッター定義

3. カスタマイズポイント
   - 企業ロゴ・情報
   - フォントとカラースキーム
   - セクションの表示/非表示
   - 項目の表示順序

### 5.3 データマッピング

1. エンジニアプロファイルマッピング
   - 基本情報（氏名、年齢、住所など）
   - 連絡先情報
   - 最終学歴
   - 保有資格

2. スキルマッピング
   - 技術カテゴリ別のスキル
   - スキルレベル（1-5）
   - 経験年数
   - 自己PR

3. 経験マッピング
   - プロジェクト名
   - 期間
   - 役割
   - プロジェクト概要
   - 担当業務
   - 使用技術

4. 案件マッピング
   - 案件名
   - クライアント名
   - 案件概要
   - 求めるスキル
   - 勤務条件

5. 提案マッピング
   - 提案日
   - 提案単価
   - 稼働開始日
   - 提案ポイント
   - 特記事項

## 6. 提案書バージョン管理機能

### 6.1 バージョン管理ポリシー

1. 同一種類の提案書は複数バージョン管理
2. バージョン番号は1から開始し、更新ごとにインクリメント
3. 最新バージョンを標準表示、過去バージョンは履歴から参照可能
4. 提案送付済みの書類は新バージョンとして保存（上書きなし）
5. 提案のステータス変更に応じて自動バージョニング

### 6.2 バージョン操作機能

1. 特定バージョンの表示
2. バージョン間の差分表示
3. 特定バージョンからの新バージョン作成
4. バージョンコメント管理
5. バージョン履歴の表示

## 7. 提案書配布・共有機能

### 7.1 PDF出力機能

1. 高品質なPDF変換
2. フォント埋め込み
3. ブックマーク・目次生成
4. ヘッダー/フッター設定
5. ページ番号・日付自動挿入

### 7.2 共有機能

1. メール送信機能（添付または安全なリンク）
2. 閲覧用一時URLの生成
3. 閲覧状況のトラッキング
4. アクセス権限の設定
5. 有効期限の設定

### 7.3 保護機能

1. パスワード保護
2. 編集制限
3. 印刷制限
4. 電子透かし
5. アクセスログ記録