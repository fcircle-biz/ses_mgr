# 案件基本情報管理機能

## 1. 機能概要

案件基本情報管理機能は、SES業務システムにおいて、案件（プロジェクト）の基本情報を登録・更新・照会・削除するための機能を提供します。案件の属性情報（案件名、顧客、期間、勤務地など）を一元管理し、他の機能モジュールに案件基本情報を提供する役割を担います。

### 主な責務
- 案件の基本情報の登録・更新・削除・照会
- 案件情報の検証とバリデーション
- 案件情報の一覧表示と検索
- 案件情報の変更履歴管理
- 案件情報へのアクセス制御

## 2. 主要コンポーネント構成

案件基本情報管理機能は、以下の主要コンポーネントから構成されます。

### 2.1 ProjectController

案件基本情報のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- REST API経由での案件情報のCRUD操作の受付
- リクエストのバリデーション
- レスポンスの整形と返却
- エラーハンドリング

### 2.2 ProjectService

案件基本情報のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- 案件情報の登録・更新・削除・照会のビジネスロジック実装
- 案件情報のビジネスルール検証
- トランザクション管理
- ドメインイベントの発行
- 関連モジュールとの連携

### 2.3 ProjectRepository

案件情報のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- 案件情報のデータベース操作（CRUD）
- 複雑な検索条件によるクエリ実行
- データベースとのマッピング
- パフォーマンス最適化

### 2.4 ProjectValidator

案件情報のバリデーションを行うコンポーネントです。

**主な責務:**
- 案件情報の整合性チェック
- ビジネスルールに基づくバリデーション
- 重複データチェック
- データ型・形式の検証

### 2.5 ProjectEventPublisher

案件情報の変更に関するイベントを発行するコンポーネントです。

**主な責務:**
- 案件登録・更新・削除イベントの発行
- イベントデータの構築
- イベント配信の確実性確保

### 2.6 CustomerService

顧客情報の管理を行うコンポーネントです。

**主な責務:**
- 顧客情報の取得・検証
- 顧客部署情報の取得
- 顧客関連の整合性チェック

## 3. 処理フロー

案件基本情報管理機能における主要な処理フローを説明します。

### 3.1 案件情報登録フロー

1. クライアントが案件登録APIを呼び出し、案件情報を送信
2. ProjectControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ProjectValidatorが案件情報の詳細バリデーションを実行
   - 必須項目のチェック
   - データ形式の検証（日付、期間など）
   - 関連情報の存在確認（顧客IDなど）
4. CustomerServiceが顧客情報の存在確認と詳細情報の取得
5. ProjectServiceが案件情報のビジネスロジックを処理
   - 案件コードの生成
   - 案件エンティティの生成
   - ビジネスルールの適用
6. ProjectRepositoryが案件情報をデータベースに保存
7. ProjectEventPublisherが案件登録イベントを発行
8. ProjectControllerが結果をクライアントに返却

### 3.2 案件情報更新フロー

1. クライアントが案件更新APIを呼び出し、更新対象のIDと更新情報を送信
2. ProjectControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ProjectServiceが対象の案件情報をリポジトリから取得
4. 対象案件が存在しない場合はエラーを返却
5. ProjectValidatorが更新情報の詳細バリデーションを実行
6. ProjectServiceが案件情報の更新ロジックを処理
   - 更新対象フィールドの判定
   - ビジネスルールの適用
   - 更新履歴の記録
7. ProjectRepositoryが更新された案件情報をデータベースに保存
8. ProjectEventPublisherが案件更新イベントを発行
9. ProjectControllerが結果をクライアントに返却

### 3.3 案件情報照会フロー

1. クライアントが案件照会APIを呼び出し、案件IDを指定
2. ProjectControllerがリクエストを受け取り、パラメータをバリデーション
3. ProjectServiceが対象の案件情報をリポジトリから取得
4. 対象案件が存在しない場合はエラーを返却
5. 案件の可視性チェック（非公開案件へのアクセス権限確認）
6. 必要に応じて関連情報（顧客情報、ステータス情報など）を取得して結合
7. ProjectControllerが案件情報をレスポンスとして整形
8. クライアントに案件情報を返却

### 3.4 案件情報一覧取得フロー

1. クライアントが案件一覧APIを呼び出し、検索条件とページネーション情報を送信
2. ProjectControllerがリクエストを受け取り、パラメータをバリデーション
3. ProjectServiceが検索条件に基づく一覧取得ロジックを実行
4. ProjectRepositoryが検索条件に合致する案件情報の一覧とカウントを取得
5. 非公開案件のフィルタリング（アクセス権限がない場合は除外）
6. 各案件情報に必要な関連情報を付加
7. ProjectControllerが案件情報一覧とページネーション情報をレスポンスとして整形
8. クライアントに案件情報一覧を返却

### 3.5 案件情報削除フロー（論理削除）

1. クライアントが案件削除APIを呼び出し、削除対象のIDを送信
2. ProjectControllerがリクエストを受け取り、パラメータをバリデーション
3. ProjectServiceが対象の案件情報をリポジトリから取得
4. 対象案件が存在しない場合はエラーを返却
5. 削除前の検証（関連データの確認など）を実行
6. ProjectServiceが案件情報の論理削除ロジックを処理（ステータスの更新など）
7. ProjectRepositoryが更新された案件情報をデータベースに保存
8. ProjectEventPublisherが案件削除イベントを発行
9. ProjectControllerが結果をクライアントに返却

## 4. データモデル参照

案件基本情報管理機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティと値オブジェクトを扱います。

- 案件 (Project) エンティティ
- 案件期間 (ProjectPeriod) 値オブジェクト
- 金額 (Money) 値オブジェクト

## 5. バリデーションルール

案件基本情報に適用されるバリデーションルールは以下の通りです。

### 5.1 基本情報バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| projectName | 必須、最大200文字 |
| customerId | 必須、存在する顧客ID |
| customerDepartmentId | 任意、存在する顧客部署ID |
| description | 必須、最大1000文字 |
| projectType | 必須、定義された列挙値のいずれか |
| projectCategory | 必須、定義された列挙値のいずれか |
| startDate | 必須、現在日以降（過去の案件登録は特権ユーザーのみ許可） |
| endDate | 必須、startDateより後の日付 |
| workLocation | 必須、最大100文字 |
| workStyle | 必須、定義された列挙値のいずれか |
| statusId | 必須、存在するステータスID |
| priority | 必須、定義された列挙値のいずれか |
| confidentialLevel | 必須、定義された列挙値のいずれか |
| isPublic | 必須、真偽値 |
| salesRepId | 必須、存在するユーザーID |

### 5.2 期間バリデーション

- 終了日は開始日より後の日付である必要がある
- プロジェクト期間は妥当な範囲内である必要がある（最大5年など）
- 開始日が過去の日付の場合、特権ユーザーによる登録のみ許可

### 5.3 顧客関連バリデーション

- 顧客IDは存在する顧客を参照している必要がある
- 顧客部署IDを指定する場合、対象の顧客に属する部署である必要がある
- 顧客の取引状態がアクティブである必要がある

### 5.4 ステータス関連バリデーション

- ステータスIDは存在するステータスを参照している必要がある
- 初回登録時は「新規」などの初期ステータスのみ設定可能
- ステータス変更は許可された遷移パターンに従う必要がある

## 6. 例外処理

案件基本情報管理機能における主な例外処理は以下の通りです。

### 6.1 バリデーション例外

- **InvalidProjectDataException**: 案件データが無効な場合にスローされる例外
  - 処理: クライアントにバリデーションエラーの詳細を返却

### 6.2 リソース未検出例外

- **ProjectNotFoundException**: 指定されたIDの案件が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **CustomerNotFoundException**: 指定されたIDの顧客が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 6.3 権限例外

- **ProjectAccessDeniedException**: 案件へのアクセス権限がない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

### 6.4 ビジネスルール違反例外

- **BusinessRuleViolationException**: ビジネスルールに違反する操作が行われた場合にスローされる例外
  - 処理: クライアントにビジネスルール違反の詳細を返却

### 6.5 データベース例外

- **DataAccessException**: データベースアクセス中にエラーが発生した場合にスローされる例外
  - 処理: ログに詳細を記録し、クライアントに一般的なエラーメッセージを返却

### 6.6 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. バリデーション例外は詳細なエラー情報をクライアントに返却
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. トランザクション管理による整合性の確保

## 7. セキュリティ考慮事項

案件基本情報管理機能における主なセキュリティ考慮事項は以下の通りです。

### 7.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- 案件情報の操作には以下の権限が必要
  - 照会: `PROJECT_VIEW` 権限
  - 登録: `PROJECT_CREATE` 権限
  - 更新: `PROJECT_UPDATE` 権限
  - 削除: `PROJECT_DELETE` 権限
- 機密レベルに応じたアクセス制御
  - PUBLIC: 一般ユーザーもアクセス可能
  - INTERNAL: 関連部署のユーザーのみアクセス可能
  - CONFIDENTIAL: 担当者のみアクセス可能
  - RESTRICTED: 特定の権限を持つユーザーのみアクセス可能
- 非公開案件（isPublic=false）は、担当者と特権ユーザーのみアクセス可能

### 7.2 データ保護

- 機密性の高い情報（予算情報など）は保存時に暗号化
- 顧客情報へのアクセスは監査ログに記録
- 案件情報へのすべての変更操作は監査ログに記録

### 7.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- SQLインジェクション対策としてパラメータ化クエリを使用
- クロスサイトスクリプティング対策として出力エスケープを実施

### 7.4 監査証跡

- 案件情報の重要な操作（登録、更新、削除）はすべて監査ログに記録
- 監査ログには以下の情報を含める
  - 操作を行ったユーザーID
  - 操作の種類（登録、更新、削除、照会）
  - 操作の対象（案件ID）
  - 操作の日時
  - 操作のIPアドレス
  - 変更前後の値（更新の場合）

## 8. パフォーマンス最適化

案件基本情報管理機能におけるパフォーマンス最適化策は以下の通りです。

### 8.1 データベース最適化

- 頻繁に検索される項目（案件コード、案件名、顧客ID、ステータスIDなど）にインデックスを作成
- 大量データの一覧取得にはページネーションを必須とする
- N+1問題を回避するためのJOINフェッチ戦略の採用

### 8.2 キャッシング戦略

- 頻繁にアクセスされる案件情報のキャッシング
- ステータスや顧客などのマスタデータのキャッシング
- キャッシュの有効期間: 案件情報は5分、マスタデータは60分
- 更新操作時のキャッシュ無効化処理

### 8.3 クエリ最適化

- 案件一覧取得時に必要最小限のフィールドのみを取得
- 複雑な検索条件に対応するための動的クエリビルダーの活用
- 集計クエリの最適化（COUNT最適化など）

### 8.4 バッチ処理

- ステータス自動更新などの定期的な処理はバッチで実行
- 非活性案件の処理は負荷の少ない時間帯に実行
- 大量データ更新時はバッチサイズの最適化

## 9. 監視とロギング

案件基本情報管理機能における監視とロギングの方針は以下の通りです。

### 9.1 ロギング方針

- INFO レベル: 通常の操作ログ（案件登録、更新、削除など）
- WARN レベル: 潜在的な問題（バリデーションエラー、権限不足など）
- ERROR レベル: 例外と障害（データベース接続エラー、未処理例外など）
- DEBUG レベル: 開発・トラブルシューティング用の詳細ログ

### 9.2 監視指標

- API応答時間
- エラー率（4xx, 5xxレスポンス）
- 案件情報操作の頻度（登録数、更新数、検索数）
- ステータス別案件数の推移
- データベースクエリのパフォーマンス

### 9.3 アラート条件

- API応答時間が閾値（2秒）を超えた場合
- エラー率が閾値（5%）を超えた場合
- 特定の時間枠内で案件登録・更新数が急増した場合
- データベース接続プールの枯渇
- ディスク使用率の閾値超過

## 10. インターフェース連携

案件基本情報管理機能と他モジュールとのインターフェース連携について説明します。

### 10.1 マッチングモジュールとの連携

- 案件情報とスキル要件情報をマッチングエンジンに提供
- マッチング結果を案件ステータスに反映
- マッチング進行状況の案件への更新

### 10.2 技術者管理モジュールとの連携

- 要員要件情報を技術者検索機能に提供
- アサイン可能な技術者情報の取得
- アサイン登録時の技術者情報確認

### 10.3 契約管理モジュールとの連携

- 契約対象の案件情報を契約書生成に提供
- 契約成立時の案件ステータス更新
- 契約条件と案件情報の整合性確認

### 10.4 請求管理モジュールとの連携

- 請求対象の案件情報を請求書生成に提供
- 請求状況を案件情報に反映
- 予算情報と請求実績の突合

### 10.5 レポーティングモジュールとの連携

- 案件情報の統計データの提供
- ステータス推移・件数等の分析データの提供
- カスタムレポート用の案件データ抽出

## 11. テスト方針

案件基本情報管理機能のテスト方針は以下の通りです。

### 11.1 単体テスト

- ProjectServiceのすべてのパブリックメソッドに対するテスト
- バリデーションロジックの網羅的テスト
- 例外処理の動作検証

### 11.2 統合テスト

- コントローラーからリポジトリまでの連携テスト
- データベースとの連携テスト（実DBまたはインメモリDB使用）
- イベント発行と受信の連携テスト

### 11.3 API テスト

- すべてのAPIエンドポイントに対する正常系・異常系テスト
- 権限による動作の違いを検証
- パフォーマンステスト（応答時間、同時アクセス）

### 11.4 負荷テスト

- 大量データ（1万件以上）での一覧取得・検索のパフォーマンス
- 同時アクセス（50ユーザー）時の応答性能
- 長時間稼働時のリソース使用状況