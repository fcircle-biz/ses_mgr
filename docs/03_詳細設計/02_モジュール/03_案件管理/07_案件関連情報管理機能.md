# 案件関連情報管理機能

## 1. 機能概要

案件関連情報管理機能は、SES業務システムにおいて案件の基本情報以外の関連情報を管理するための機能です。要員要件、予算情報、関連ドキュメント、担当者情報など、案件に付随する様々な情報を一元管理し、案件管理の充実と業務効率の向上を実現します。

### 主な責務
- 要員要件情報の管理（職種、スキル要件、人数など）
- 予算情報の管理（単価、総額、請求方式など）
- 案件関連ドキュメントの管理（提案書、仕様書、契約書など）
- 案件担当者情報の管理（営業担当、PM、管理担当など）
- 関連情報の登録・更新・削除・参照
- 関連情報へのアクセス制御と機密管理

## 2. 主要コンポーネント構成

案件関連情報管理機能は、以下の主要コンポーネントから構成されます。

### 2.1 ProjectRelatedInfoController

案件関連情報のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- 関連情報操作のREST APIエンドポイント提供
- リクエストのバリデーション
- レスポンスの整形と返却
- エラーハンドリング

### 2.2 ResourceRequirementService

要員要件管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- 要員要件の登録・更新・削除・照会
- スキル要件の管理
- 要員要件の検証と整合性確保
- 関連イベントの発行

### 2.3 ProjectBudgetService

予算情報管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- 予算情報の登録・更新・削除・照会
- 予算種別・請求方式の管理
- 予算情報の計算と集計
- 機密予算情報のアクセス制御

### 2.4 ProjectDocumentService

案件ドキュメント管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- ドキュメント情報の登録・更新・削除・照会
- ドキュメントファイルの保存と取得連携
- ドキュメント種別管理
- ドキュメントのバージョン管理

### 2.5 ProjectMemberService

案件担当者管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- 担当者情報の登録・更新・削除・照会
- 役割タイプの管理
- 主担当者の管理
- 担当者履歴の管理

### 2.6 関連リポジトリコンポーネント

各種関連情報のデータアクセスを担当するリポジトリコンポーネントです。

- **ResourceRequirementRepository**: 要員要件情報のデータアクセス
- **SkillRequirementRepository**: スキル要件情報のデータアクセス
- **ProjectBudgetRepository**: 予算情報のデータアクセス
- **ProjectDocumentRepository**: ドキュメント情報のデータアクセス
- **ProjectMemberRepository**: 担当者情報のデータアクセス

### 2.7 FileStorageIntegrationService

ファイル保存機能との連携を担当するサービスコンポーネントです。

**主な責務:**
- ドキュメントファイルの保存・取得
- ファイルメタデータの管理
- ファイルアクセス制御との連携

## 3. 処理フロー

案件関連情報管理機能における主要な処理フローを説明します。

### 3.1 要員要件管理フロー

#### 3.1.1 要員要件登録フロー

1. クライアントが要員要件登録APIを呼び出し、案件IDと要員要件情報を送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ResourceRequirementServiceが以下の処理を実行
   - 案件の存在確認
   - 要員要件情報のバリデーション
   - 要員要件エンティティの生成
4. ResourceRequirementRepositoryが要員要件情報をデータベースに保存
5. 要員要件IDが生成される
6. ResourceRequirementServiceが要員要件追加イベントを発行
7. ProjectRelatedInfoControllerが結果をクライアントに返却

#### 3.1.2 スキル要件追加フロー

1. クライアントがスキル要件追加APIを呼び出し、要員要件IDとスキル要件情報を送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ResourceRequirementServiceが以下の処理を実行
   - 要員要件の存在確認
   - スキル定義の存在確認
   - スキル要件情報のバリデーション
   - スキル要件エンティティの生成
4. SkillRequirementRepositoryがスキル要件情報をデータベースに保存
5. スキル要件IDが生成される
6. ResourceRequirementServiceがスキル要件追加イベントを発行
7. ProjectRelatedInfoControllerが結果をクライアントに返却

#### 3.1.3 要員要件状態変更フロー

1. クライアントが要員要件状態変更APIを呼び出し、要員要件IDと新状態を送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、パラメータをバリデーション
3. ResourceRequirementServiceが以下の処理を実行
   - 要員要件の存在確認
   - 状態変更の妥当性検証
   - 要員要件状態の更新
4. 状態が「アサイン済み」に変更される場合、技術者の割り当て情報を検証
5. ResourceRequirementRepositoryが更新された要員要件情報をデータベースに保存
6. ResourceRequirementServiceが要員要件状態変更イベントを発行
7. ProjectRelatedInfoControllerが結果をクライアントに返却

### 3.2 予算情報管理フロー

#### 3.2.1 予算情報登録フロー

1. クライアントが予算情報登録APIを呼び出し、案件IDと予算情報を送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ProjectBudgetServiceが以下の処理を実行
   - 案件の存在確認
   - 予算情報のバリデーション
   - 予算期間重複チェック
   - 予算情報エンティティの生成
4. 機密情報のアクセス権限チェック
5. ProjectBudgetRepositoryが予算情報をデータベースに保存
6. 予算情報IDが生成される
7. ProjectBudgetServiceが予算情報追加イベントを発行
8. ProjectRelatedInfoControllerが結果をクライアントに返却

#### 3.2.2 予算情報更新フロー

1. クライアントが予算情報更新APIを呼び出し、予算情報IDと更新内容を送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ProjectBudgetServiceが以下の処理を実行
   - 予算情報の存在確認
   - 更新内容のバリデーション
   - 予算期間重複チェック
   - 予算情報の更新
4. 機密情報のアクセス権限チェック
5. ProjectBudgetRepositoryが更新された予算情報をデータベースに保存
6. ProjectBudgetServiceが予算情報更新イベントを発行
7. ProjectRelatedInfoControllerが結果をクライアントに返却

### 3.3 ドキュメント管理フロー

#### 3.3.1 ドキュメント登録フロー

1. クライアントがドキュメント登録APIを呼び出し、案件ID、ドキュメント情報、ファイルを送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. FileStorageIntegrationServiceがファイルを保存し、ファイルIDを取得
4. ProjectDocumentServiceが以下の処理を実行
   - 案件の存在確認
   - ドキュメント情報のバリデーション
   - ドキュメントエンティティの生成
5. ドキュメントの機密レベルに応じたアクセス権限設定
6. ProjectDocumentRepositoryがドキュメント情報をデータベースに保存
7. ドキュメントIDが生成される
8. ProjectDocumentServiceがドキュメント追加イベントを発行
9. ProjectRelatedInfoControllerが結果をクライアントに返却

#### 3.3.2 ドキュメント取得フロー

1. クライアントがドキュメント取得APIを呼び出し、ドキュメントIDを送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、パラメータをバリデーション
3. ProjectDocumentServiceが以下の処理を実行
   - ドキュメント情報の取得
   - アクセス権限チェック
4. ドキュメントが存在しない場合はエラーを返却
5. FileStorageIntegrationServiceがファイルIDを使用してファイルコンテンツを取得
6. ProjectRelatedInfoControllerがドキュメント情報とファイルコンテンツをレスポンスとして整形
7. クライアントにドキュメント情報とファイルコンテンツを返却

### 3.4 担当者管理フロー

#### 3.4.1 担当者登録フロー

1. クライアントが担当者登録APIを呼び出し、案件IDと担当者情報を送信
2. ProjectRelatedInfoControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ProjectMemberServiceが以下の処理を実行
   - 案件の存在確認
   - ユーザーの存在確認
   - 担当者情報のバリデーション
   - 主担当者の重複チェック
   - 担当者エンティティの生成
4. ProjectMemberRepositoryが担当者情報をデータベースに保存
5. 担当者IDが生成される
6. ProjectMemberServiceが担当者追加イベントを発行
7. 必要に応じて新担当者に通知を送信
8. ProjectRelatedInfoControllerが結果をクライアントに返却

## 4. データモデル参照

案件関連情報管理機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティを扱います。

- 要員要件 (ResourceRequirement) エンティティ
- スキル要件 (SkillRequirement) エンティティ
- 予算情報 (ProjectBudget) エンティティ
- 案件ドキュメント (ProjectDocument) エンティティ
- 案件担当者 (ProjectMember) エンティティ

## 5. バリデーションルール

案件関連情報管理機能に適用されるバリデーションルールは以下の通りです。

### 5.1 要員要件バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| projectId | 必須、存在する案件ID |
| positionName | 必須、最大100文字 |
| requiredNumber | 必須、1以上の整数 |
| jobType | 必須、定義された列挙値のいずれか |
| minimumExperience | 任意、0以上の整数 |
| preferredExperience | 任意、minimumExperience以上の整数 |
| description | 任意、最大1000文字 |
| priority | 必須、定義された列挙値のいずれか |
| isRequired | 必須、真偽値 |
| status | 必須、定義された列挙値のいずれか |
| assignedEngineerId | 条件付き、status=ASSIGNEDの場合は必須、存在する技術者ID |

### 5.2 スキル要件バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| resourceRequirementId | 必須、存在する要員要件ID |
| skillDefinitionId | 必須、存在するスキル定義ID |
| minimumLevel | 必須、1-5の整数 |
| preferredLevel | 任意、minimumLevel以上、最大5の整数 |
| isRequired | 必須、真偽値 |
| weight | 必須、1-10の整数 |

### 5.3 予算情報バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| projectId | 必須、存在する案件ID |
| budgetType | 必須、定義された列挙値のいずれか |
| billingType | 必須、定義された列挙値のいずれか |
| amount | 必須、0より大きい数値 |
| currency | 必須、定義された列挙値のいずれか |
| unitAmount | 条件付き、billingType=TIME_AND_MATERIALの場合は必須、0より大きい数値 |
| taxRate | 必須、0-100の範囲内の数値 |
| startDate | 必須、有効な日付 |
| endDate | 必須、startDateより後の日付 |
| remarks | 任意、最大500文字 |
| isConfidential | 必須、真偽値 |

### 5.4 ドキュメントバリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| projectId | 必須、存在する案件ID |
| documentType | 必須、定義された列挙値のいずれか |
| title | 必須、最大200文字 |
| description | 任意、最大500文字 |
| fileId | 必須、存在するファイルID |
| version | 任意、最大20文字 |
| isConfidential | 必須、真偽値 |
| isActive | 必須、真偽値 |

### 5.5 担当者バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| projectId | 必須、存在する案件ID |
| userId | 必須、存在するユーザーID |
| roleType | 必須、定義された列挙値のいずれか |
| isMainContact | 必須、真偽値 |
| startDate | 必須、有効な日付 |
| endDate | 任意、startDateより後の日付 |
| remarks | 任意、最大500文字 |
| isActive | 必須、真偽値 |

## 6. 例外処理

案件関連情報管理機能における主な例外処理は以下の通りです。

### 6.1 バリデーション例外

- **InvalidDataException**: 入力データが無効な場合にスローされる例外
  - 処理: クライアントにバリデーションエラーの詳細を返却

### 6.2 リソース未検出例外

- **ProjectNotFoundException**: 指定されたIDの案件が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **ResourceRequirementNotFoundException**: 指定されたIDの要員要件が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **BudgetNotFoundException**: 指定されたIDの予算情報が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **DocumentNotFoundException**: 指定されたIDのドキュメントが存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **MemberNotFoundException**: 指定されたIDの担当者が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 6.3 競合例外

- **DuplicateResourceException**: 重複リソースが検出された場合にスローされる例外
  - 処理: クライアントに409エラーと適切なメッセージを返却

- **BudgetOverlapException**: 予算期間の重複が検出された場合にスローされる例外
  - 処理: クライアントに409エラーと重複情報を含むメッセージを返却

- **MainContactDuplicateException**: 同一役割タイプで複数の主担当者が設定された場合にスローされる例外
  - 処理: クライアントに409エラーと適切なメッセージを返却

### 6.4 権限例外

- **AccessDeniedException**: リソースへのアクセス権限がない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

- **ConfidentialAccessDeniedException**: 機密情報へのアクセス権限がない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

### 6.5 ファイル例外

- **FileStorageException**: ファイルの保存・取得に失敗した場合にスローされる例外
  - 処理: ログに詳細を記録し、クライアントに適切なエラーメッセージを返却

### 6.6 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. バリデーション例外は詳細なエラー情報をクライアントに返却
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. トランザクション管理による整合性の確保

## 7. セキュリティ考慮事項

案件関連情報管理機能における主なセキュリティ考慮事項は以下の通りです。

### 7.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- 関連情報の操作には以下の権限が必要
  - 照会: `PROJECT_VIEW` 権限
  - 登録・更新: `PROJECT_UPDATE` 権限
  - 削除: `PROJECT_DELETE` 権限
- 機密情報（予算情報、機密ドキュメントなど）へのアクセスには特別な権限が必要
  - 予算情報: `BUDGET_VIEW` 権限
  - 機密ドキュメント: `CONFIDENTIAL_DOC_ACCESS` 権限

### 7.2 データ保護

- 機密予算情報の暗号化保存
- 機密ドキュメントの暗号化保存
- 機密情報へのアクセスログ記録
- ドキュメントダウンロード操作の詳細ログ記録

### 7.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- ドキュメントのファイルタイプ制限（許可された拡張子のみ）
- ファイルサイズ制限
- ドキュメント内容のウイルススキャン

### 7.4 監査証跡

- 関連情報の操作はすべて監査ログに記録
- 特に以下の操作は詳細に記録
  - 予算情報の変更
  - 機密ドキュメントへのアクセス
  - 要員要件のステータス変更
  - 担当者の追加・変更

## 8. パフォーマンス最適化

案件関連情報管理機能におけるパフォーマンス最適化策は以下の通りです。

### 8.1 データベース最適化

- 頻繁に検索される項目へのインデックス作成
  - 案件IDフィールド
  - ステータスフィールド
  - 日付関連フィールド
- 大量データテーブルのパーティショニング
- 効率的なJOINクエリの設計

### 8.2 クエリ最適化

- 関連情報一覧取得時の最適化
  - 必要最小限のフィールドのみ取得
  - ページネーションの適用
  - 適切なソート条件の設定
- N+1問題の回避

### 8.3 ファイル処理最適化

- ドキュメントファイルのキャッシング
- 大容量ファイルの分割アップロード
- ファイルメタデータの事前取得

### 8.4 非同期処理

- 大量ファイルのアップロード・変換処理の非同期実行
- バッチ処理による定期的なデータ整理

## 9. 監視とロギング

案件関連情報管理機能における監視とロギングの方針は以下の通りです。

### 9.1 ロギング方針

- INFO レベル: 関連情報の操作ログ（登録、更新、削除）
- WARN レベル: 潜在的な問題（バリデーションエラー、権限不足など）
- ERROR レベル: 例外と障害（ファイル処理エラー、未処理例外など）
- DEBUG レベル: 詳細な処理ログ（クエリパラメータ、データ変換など）

### 9.2 監視指標

- API応答時間
- エラー率（4xx, 5xxレスポンス）
- 関連情報操作の頻度（登録数、更新数、検索数）
- ファイルストレージ使用量
- ファイル処理時間

### 9.3 アラート条件

- API応答時間が閾値（2秒）を超えた場合
- エラー率が閾値（5%）を超えた場合
- ファイル処理エラー率が閾値（2%）を超えた場合
- ストレージ使用量が閾値を超えた場合

## 10. インテグレーション

案件関連情報管理機能と他システムとのインテグレーションについて説明します。

### 10.1 ファイルストレージとの連携

- 共通ファイルストレージサービスを使用したドキュメント保存
- ファイルメタデータの管理
- アクセス制御の統合

### 10.2 通知システムとの連携

- 要員要件ステータス変更時の通知
- ドキュメント追加・更新時の通知
- 担当者変更時の通知

### 10.3 マッチングシステムとの連携

- 要員要件情報のマッチングエンジンへの提供
- マッチング結果の要員要件ステータスへの反映

### 10.4 契約管理システムとの連携

- 予算情報の契約管理システムへの連携
- 契約ドキュメントの共有

## 11. ユースケース詳細

以下に、案件関連情報管理機能の主要なユースケースを詳細に説明します。

### 11.1 要員要件の登録と管理

営業担当者やプロジェクトマネージャーが、案件に必要な要員のスキル要件や条件を登録・管理するユースケースです。

**主な流れ:**
1. 営業担当者が案件詳細画面の「要員要件」タブを選択
2. 「要員要件追加」ボタンをクリック
3. 以下の情報を入力
   - ポジション名
   - 必要人数
   - 職種
   - 最低経験年数
   - 推奨経験年数
   - 詳細説明
   - 優先度
   - 必須フラグ
4. 「スキル要件」セクションで必要なスキルを追加
   - スキル選択（カテゴリ別リストから）
   - 最低レベル設定
   - 推奨レベル設定
   - 必須フラグ設定
   - 重み設定
5. 入力内容を確認して保存
6. システムが要員要件を登録し、マッチングエンジンに通知

**代替フロー:**
- スキル要件の一括インポート（テンプレートからの読み込み）
- 既存要員要件からのコピー作成

### 11.2 予算情報の管理

営業担当者や営業管理者が案件の予算情報を管理するユースケースです。

**主な流れ:**
1. 営業担当者が案件詳細画面の「予算情報」タブを選択
2. 「予算情報追加」ボタンをクリック
3. 以下の情報を入力
   - 予算種別（総額/月額/日額/時間単価）
   - 請求種別（固定/T&M/マイルストーン/サブスクリプション）
   - 金額
   - 通貨
   - 単価（必要に応じて）
   - 税率
   - 適用期間（開始日・終了日）
   - 備考
   - 機密フラグ
4. 入力内容を確認して保存
5. システムが予算情報を登録し、関連するイベントを発行

**代替フロー:**
- 複数予算情報の期間設定（契約更新を見据えた複数期間の予算設定）
- 予算情報のコピー作成と調整

### 11.3 案件ドキュメントの管理

営業担当者やプロジェクト関係者が案件に関連するドキュメントを管理するユースケースです。

**主な流れ:**
1. ユーザーが案件詳細画面の「ドキュメント」タブを選択
2. 「ドキュメント追加」ボタンをクリック
3. 以下の情報を入力
   - ドキュメント種別（提案書/仕様書/契約書/報告書/議事録/その他）
   - タイトル
   - 説明
   - ファイルアップロード
   - バージョン
   - 機密フラグ
4. 入力内容を確認して保存
5. システムがファイルを保存し、ドキュメント情報を登録
6. 必要に応じて関係者に通知

**代替フロー:**
- ドキュメントの新バージョンアップロード
- 複数ファイルの一括アップロード
- ドキュメントの検索とフィルタリング

### 11.4 案件担当者の管理

営業管理者やプロジェクト管理者が案件の担当者を管理するユースケースです。

**主な流れ:**
1. 管理者が案件詳細画面の「担当者」タブを選択
2. 「担当者追加」ボタンをクリック
3. 以下の情報を入力
   - ユーザー選択
   - 役割タイプ（営業担当/PM/アカウントマネージャー/デリバリーマネージャー/テクニカルリード/サポート）
   - 主担当フラグ
   - 担当期間（開始日・終了日）
   - 備考
4. 入力内容を確認して保存
5. システムが担当者情報を登録し、新担当者に通知

**代替フロー:**
- 担当者の一括変更（組織変更時など）
- 担当期間の延長
- 主担当の交代