# 案件管理モジュール ドメインモデル

## 1. エンティティ

### 1.1 案件 (Project)

案件エンティティは、SES事業において受注・提案する案件（プロジェクト）を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| projectId | Long | 案件ID | 主キー、自動採番 |
| projectCode | String | 案件コード | 必須、一意、パターン[P-YYYYMMDD-NNNN] |
| projectName | String | 案件名 | 必須、最大200文字 |
| customerId | Long | 顧客ID | FK(customers)、必須 |
| customerDepartmentId | Long | 顧客部署ID | FK(customer_departments)、任意 |
| description | String | 案件概要 | 必須、最大1000文字 |
| projectType | ProjectType | 案件種別 | 必須（列挙型） |
| projectCategory | ProjectCategory | 案件区分 | 必須（列挙型） |
| startDate | Date | 開始日 | 必須 |
| endDate | Date | 終了日 | 必須、startDateより後の日付 |
| workLocation | String | 勤務地 | 必須、最大100文字 |
| workStyle | WorkStyle | 勤務形態 | 必須（列挙型） |
| statusId | Long | ステータスID | FK(project_statuses)、必須 |
| priority | Priority | 優先度 | 必須（列挙型） |
| confidentialLevel | ConfidentialLevel | 機密レベル | 必須（列挙型） |
| isPublic | Boolean | 公開フラグ | 必須、デフォルトtrue |
| salesRepId | Long | 営業担当者ID | FK(users)、必須 |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- 案件コードは一意であり、システムで自動生成される
- 終了日は開始日より後の日付である必要がある
- 非公開案件(isPublic=false)は特定の権限を持つユーザーのみアクセス可能
- 機密レベルに応じてアクセス権限が制限される

### 1.2 案件ステータス (ProjectStatus)

案件ステータスエンティティは、案件のライフサイクル上の状態を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| statusId | Long | ステータスID | 主キー、自動採番 |
| statusCode | String | ステータスコード | 必須、一意、最大50文字 |
| statusName | String | ステータス名 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| displayOrder | Integer | 表示順 | 必須、0以上の整数 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| color | String | 表示色 | 任意、HEX形式(#RRGGBB) |
| allowedNextStatuses | String | 遷移可能な次ステータス | カンマ区切りのステータスコード |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |

**ビジネスルール：**
- ステータスコードは一意であり、ビジネスフローを表現する
- allowedNextStatusesに指定されたステータスにのみ遷移可能
- ステータスの追加・変更は管理者のみ実行可能

### 1.3 要員要件 (ResourceRequirement)

要員要件エンティティは、案件に必要な技術者のスキル要件や条件を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| requirementId | Long | 要件ID | 主キー、自動採番 |
| projectId | Long | 案件ID | FK(projects)、必須 |
| positionName | String | ポジション名 | 必須、最大100文字 |
| requiredNumber | Integer | 必要人数 | 必須、1以上の整数 |
| jobType | JobType | 職種 | 必須（列挙型） |
| minimumExperience | Integer | 最低経験年数 | 任意、0以上の整数 |
| preferredExperience | Integer | 推奨経験年数 | 任意、minimumExperience以上 |
| description | String | 詳細 | 任意、最大1000文字 |
| priority | Priority | 優先度 | 必須（列挙型） |
| isRequired | Boolean | 必須フラグ | 必須、デフォルトtrue |
| status | RequirementStatus | 充足状態 | 必須（列挙型） |
| assignedEngineerId | Long | アサイン技術者ID | FK(engineers)、任意 |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- 必要人数は1以上の整数である必要がある
- 推奨経験年数は最低経験年数以上である必要がある
- 要員要件のステータスは案件の進行に応じて更新される
- 技術者がアサインされると、充足状態が更新される

### 1.4 スキル要件 (SkillRequirement)

スキル要件エンティティは、要員要件に対するスキル条件を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| skillRequirementId | Long | スキル要件ID | 主キー、自動採番 |
| resourceRequirementId | Long | 要員要件ID | FK(resource_requirements)、必須 |
| skillDefinitionId | Long | スキル定義ID | FK(skill_definitions)、必須 |
| minimumLevel | Integer | 最低スキルレベル | 必須、1-5の整数 |
| preferredLevel | Integer | 推奨スキルレベル | 任意、minimumLevel以上、最大5 |
| isRequired | Boolean | 必須フラグ | 必須、デフォルトtrue |
| weight | Integer | 重み | 必須、1-10の整数、デフォルト5 |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |

**ビジネスルール：**
- 最低スキルレベルは1から5の間の整数である必要がある
- 推奨スキルレベルは最低スキルレベル以上である必要がある
- 重みはマッチングアルゴリズムで使用される優先度を表す

### 1.5 予算情報 (ProjectBudget)

予算情報エンティティは、案件の予算に関する情報を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| budgetId | Long | 予算ID | 主キー、自動採番 |
| projectId | Long | 案件ID | FK(projects)、必須 |
| budgetType | BudgetType | 予算種別 | 必須（列挙型） |
| billingType | BillingType | 請求種別 | 必須（列挙型） |
| amount | Money | 金額 | 必須、値オブジェクト |
| unitAmount | Money | 単価 | 条件付き必須、値オブジェクト |
| taxRate | BigDecimal | 税率 | 必須、0-100の範囲、デフォルト10% |
| startDate | Date | 適用開始日 | 必須 |
| endDate | Date | 適用終了日 | 必須、startDateより後の日付 |
| remarks | String | 備考 | 任意、最大500文字 |
| isConfidential | Boolean | 機密フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- 請求種別が単価方式の場合、unitAmountは必須
- 終了日は開始日より後の日付である必要がある
- 機密フラグがtrueの場合、特別な権限を持つユーザーのみアクセス可能

### 1.6 案件ドキュメント (ProjectDocument)

案件ドキュメントエンティティは、案件に関連するドキュメントファイルを表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| documentId | Long | ドキュメントID | 主キー、自動採番 |
| projectId | Long | 案件ID | FK(projects)、必須 |
| documentType | DocumentType | ドキュメント種別 | 必須（列挙型） |
| title | String | タイトル | 必須、最大200文字 |
| description | String | 説明 | 任意、最大500文字 |
| fileId | Long | ファイルID | FK(files)、必須 |
| version | String | バージョン | 任意、最大20文字 |
| isConfidential | Boolean | 機密フラグ | 必須、デフォルトfalse |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- 同一案件に同一タイトル・同一バージョンのドキュメントは登録不可
- 機密フラグがtrueの場合、特別な権限を持つユーザーのみアクセス可能
- 論理削除の場合はisActiveをfalseに設定

### 1.7 案件ステータス履歴 (ProjectStatusHistory)

案件ステータス履歴エンティティは、案件のステータス変更履歴を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| historyId | Long | 履歴ID | 主キー、自動採番 |
| projectId | Long | 案件ID | FK(projects)、必須 |
| previousStatusId | Long | 前ステータスID | FK(project_statuses)、任意 |
| newStatusId | Long | 新ステータスID | FK(project_statuses)、必須 |
| changeReason | String | 変更理由 | 任意、最大500文字 |
| changedAt | Timestamp | 変更日時 | 必須、自動設定 |
| changedBy | Long | 変更者ID | 必須、FK(users) |

**ビジネスルール：**
- 案件ステータスが変更されるたびに新しい履歴レコードが作成される
- 初回登録時はpreviousStatusIdはnull

### 1.8 案件担当者 (ProjectMember)

案件担当者エンティティは、案件に関わる担当者（営業、PM等）を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| memberId | Long | 担当者ID | 主キー、自動採番 |
| projectId | Long | 案件ID | FK(projects)、必須 |
| userId | Long | ユーザーID | FK(users)、必須 |
| roleType | ProjectRoleType | 役割タイプ | 必須（列挙型） |
| isMainContact | Boolean | 主担当フラグ | 必須、デフォルトfalse |
| startDate | Date | 担当開始日 | 必須 |
| endDate | Date | 担当終了日 | 任意、startDateより後の日付 |
| remarks | String | 備考 | 任意、最大500文字 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |

**ビジネスルール：**
- 同一案件・同一役割タイプでの主担当は1人のみ
- 担当終了日は担当開始日より後の日付である必要がある
- 論理削除の場合はisActiveをfalseに設定

## 2. 値オブジェクト

### 2.1 金額 (Money)

金額は通貨付きの金額を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| amount | BigDecimal | 金額 | 必須、0以上 |
| currency | Currency | 通貨 | 必須（列挙型） |

### 2.2 案件期間 (ProjectPeriod)

案件期間は開始日と終了日を持つ期間を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| startDate | Date | 開始日 | 必須 |
| endDate | Date | 終了日 | 必須、startDateより後の日付 |

### 2.3 案件検索条件 (ProjectSearchCriteria)

案件検索条件は案件検索時の条件を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| keyword | String | キーワード | 任意 |
| projectTypes | List<ProjectType> | 案件種別リスト | 任意 |
| projectCategories | List<ProjectCategory> | 案件区分リスト | 任意 |
| statusIds | List<Long> | ステータスIDリスト | 任意 |
| customerIds | List<Long> | 顧客IDリスト | 任意 |
| startDateRange | DateRange | 開始日期間 | 任意、値オブジェクト |
| endDateRange | DateRange | 終了日期間 | 任意、値オブジェクト |
| workLocations | List<String> | 勤務地リスト | 任意 |
| workStyles | List<WorkStyle> | 勤務形態リスト | 任意 |
| priorities | List<Priority> | 優先度リスト | 任意 |
| salesRepIds | List<Long> | 営業担当者IDリスト | 任意 |
| skillRequirements | List<SkillSearchCriteria> | スキル要件検索条件 | 任意 |
| budgetRange | MoneyRange | 予算範囲 | 任意、値オブジェクト |

### 2.4 日付範囲 (DateRange)

日付範囲は検索条件等で使用する日付の範囲を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| fromDate | Date | 開始日 | 任意 |
| toDate | Date | 終了日 | 任意、fromDateより後の日付 |

### 2.5 金額範囲 (MoneyRange)

金額範囲は検索条件等で使用する金額の範囲を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| minAmount | BigDecimal | 最小金額 | 任意、0以上 |
| maxAmount | BigDecimal | 最大金額 | 任意、minAmount以上 |
| currency | Currency | 通貨 | 必須（列挙型） |

## 3. 列挙型

### 3.1 案件種別 (ProjectType)
- NEW_DEVELOPMENT: 新規開発
- ENHANCEMENT: 機能追加・改修
- MAINTENANCE: 保守運用
- MIGRATION: 移行
- CONSULTING: コンサルティング
- TESTING: テスト業務
- TRAINING: 研修・教育
- OTHER: その他

### 3.2 案件区分 (ProjectCategory)
- SYSTEM_INTEGRATION: システムインテグレーション
- SOFTWARE_DEVELOPMENT: ソフトウェア開発
- INFRASTRUCTURE: インフラ構築・運用
- DATA_ANALYSIS: データ分析・BI
- SECURITY: セキュリティ
- QUALITY_ASSURANCE: 品質保証
- SUPPORT: サポート・ヘルプデスク
- OTHER: その他

### 3.3 勤務形態 (WorkStyle)
- ONSITE: オンサイト
- REMOTE: リモート
- HYBRID: ハイブリッド
- FLEXIBLE: 柔軟対応可

### 3.4 優先度 (Priority)
- HIGHEST: 最優先（5）
- HIGH: 高（4）
- MEDIUM: 中（3）
- LOW: 低（2）
- LOWEST: 最低（1）

### 3.5 機密レベル (ConfidentialLevel)
- PUBLIC: 公開（社内全体に公開可能）
- INTERNAL: 社内（関連部署のみ）
- CONFIDENTIAL: 機密（担当者のみ）
- RESTRICTED: 制限（特定の権限者のみ）

### 3.6 要件充足状態 (RequirementStatus)
- OPEN: 未充足
- IN_PROGRESS: 調整中
- ASSIGNED: アサイン済み
- CANCELED: キャンセル

### 3.7 予算種別 (BudgetType)
- TOTAL: 総額
- MONTHLY: 月額
- DAILY: 日額
- HOURLY: 時間単価

### 3.8 請求種別 (BillingType)
- FIXED: 固定
- TIME_AND_MATERIAL: T&M（実績に応じた精算）
- MILESTONE: マイルストーン
- SUBSCRIPTION: サブスクリプション

### 3.9 ドキュメント種別 (DocumentType)
- RFP: 提案依頼書
- PROPOSAL: 提案書
- SPECIFICATION: 仕様書
- CONTRACT: 契約書
- REPORT: 報告書
- MINUTES: 議事録
- OTHER: その他

### 3.10 案件役割タイプ (ProjectRoleType)
- SALES_REP: 営業担当
- PROJECT_MANAGER: プロジェクトマネージャー
- ACCOUNT_MANAGER: アカウントマネージャー
- DELIVERY_MANAGER: デリバリーマネージャー
- TECHNICAL_LEAD: テクニカルリード
- SUPPORT: サポート

### 3.11 通貨 (Currency)
- JPY: 日本円
- USD: 米ドル
- EUR: ユーロ
- GBP: 英ポンド
- CNY: 中国元

## 4. ドメインサービス

### 4.1 案件検索サービス (ProjectSearchService)

案件検索サービスは、複雑な検索条件を用いて案件を検索するためのドメインサービスです。

**主要メソッド:**
- findProjectsByKeyword(String keyword)
- findProjectsByStatus(List<Long> statusIds)
- findProjectsByDateRange(DateRange startDateRange, DateRange endDateRange)
- findProjectsByCustomer(List<Long> customerIds)
- findProjectsByCompoundCriteria(ProjectSearchCriteria criteria)

### 4.2 案件ステータス管理サービス (ProjectStatusManagementService)

案件ステータス管理サービスは、案件のステータス管理を行うためのドメインサービスです。

**主要メソッド:**
- changeProjectStatus(Long projectId, Long newStatusId, String changeReason)
- validateStatusTransition(Long currentStatusId, Long newStatusId)
- getStatusTransitionHistory(Long projectId)
- getAvailableNextStatuses(Long currentStatusId)

### 4.3 予算管理サービス (BudgetManagementService)

予算管理サービスは、案件の予算情報を管理するためのドメインサービスです。

**主要メソッド:**
- calculateTotalBudget(Long projectId)
- validateBudgetOverlap(ProjectBudget budget)
- convertBudgetType(ProjectBudget budget, BudgetType targetType)
- calculateMonthlyBudget(Long projectId, YearMonth month)

### 4.4 要員要件管理サービス (ResourceRequirementManagementService)

要員要件管理サービスは、案件の要員要件を管理するためのドメインサービスです。

**主要メソッド:**
- calculateTotalRequiredResources(Long projectId)
- validateRequirementDuplication(ResourceRequirement requirement)
- updateRequirementStatus(Long requirementId, RequirementStatus newStatus)
- matchEngineerToRequirement(Long requirementId, Long engineerId)

## 5. 集約

案件管理モジュールでは、以下の集約を定義します。

### 5.1 案件集約

案件を中心とした集約で、案件の基本情報と状態を管理します。

**ルート：** 案件 (Project)
**含まれるエンティティ：**
- 案件ステータス履歴 (ProjectStatusHistory)
- 案件担当者 (ProjectMember)

### 5.2 要員要件集約

要員要件を中心とした集約で、案件に必要な人材要件を管理します。

**ルート：** 要員要件 (ResourceRequirement)
**含まれるエンティティ：**
- スキル要件 (SkillRequirement)

### 5.3 予算情報集約

予算情報を中心とした集約で、案件の予算管理を行います。

**ルート：** 予算情報 (ProjectBudget)

### 5.4 案件ドキュメント集約

案件ドキュメントを中心とした集約で、案件関連文書を管理します。

**ルート：** 案件ドキュメント (ProjectDocument)

## 6. ドメインイベント

### 6.1 案件登録イベント (ProjectRegisteredEvent)

新しい案件が登録された際に発行されるイベントです。

**属性:**
- projectId: 登録された案件のID
- projectCode: 案件コード
- projectName: 案件名
- customerId: 顧客ID
- timestamp: イベント発生時刻

### 6.2 案件更新イベント (ProjectUpdatedEvent)

案件情報が更新された際に発行されるイベントです。

**属性:**
- projectId: 案件ID
- updatedFields: 更新されたフィールドの一覧
- timestamp: イベント発生時刻

### 6.3 案件ステータス変更イベント (ProjectStatusChangedEvent)

案件のステータスが変更された際に発行されるイベントです。

**属性:**
- projectId: 案件ID
- previousStatusId: 変更前のステータスID
- newStatusId: 変更後のステータスID
- changeReason: 変更理由
- changedBy: 変更者ID
- timestamp: イベント発生時刻

### 6.4 要員要件追加イベント (ResourceRequirementAddedEvent)

案件に新しい要員要件が追加された際に発行されるイベントです。

**属性:**
- projectId: 案件ID
- requirementId: 要件ID
- positionName: ポジション名
- requiredNumber: 必要人数
- timestamp: イベント発生時刻

### 6.5 要員要件ステータス変更イベント (RequirementStatusChangedEvent)

要員要件のステータスが変更された際に発行されるイベントです。

**属性:**
- requirementId: 要件ID
- projectId: 案件ID
- previousStatus: 変更前のステータス
- newStatus: 変更後のステータス
- timestamp: イベント発生時刻

### 6.6 案件ドキュメント追加イベント (ProjectDocumentAddedEvent)

案件に新しいドキュメントが追加された際に発行されるイベントです。

**属性:**
- documentId: ドキュメントID
- projectId: 案件ID
- documentType: ドキュメント種別
- title: タイトル
- fileId: ファイルID
- timestamp: イベント発生時刻