# 工数管理機能

## 1. 機能概要

工数管理機能は、技術者および社内スタッフの案件別・作業別の工数情報を記録・管理するための機能を提供します。日次または週次での工数入力、複数案件への工数配分、プロジェクト別の計画工数と実績工数の管理、工数データの集計・検索、月次の工数シート管理などを通じて、プロジェクト管理と請求・支払業務を支援します。

## 2. 処理フロー

### 2.1 日次工数入力フロー

1. ユーザーが工数入力画面を開く
2. システムがユーザーのアサイン案件情報を取得
3. システムが当日または指定日の勤怠情報を取得
   - 勤怠データに基づき入力可能時間を表示
4. システムが既存の工数明細がある場合は表示
5. ユーザーが工数明細を入力
   - 案件選択
   - 作業種別選択
   - 工数時間入力
   - 作業内容入力
   - 請求可否選択
6. 入力データのバリデーション
   - 必須項目チェック
   - 合計時間の整合性チェック（勤怠時間以下か）
   - 工数単位チェック（0.25時間単位か）
7. 工数明細の保存
8. 日次工数合計の更新

### 2.2 週次工数入力フロー

1. ユーザーが週次工数入力画面を開く
2. システムが選択週の日別勤怠情報を取得
3. システムがユーザーのアサイン案件情報を取得
4. システムが既存の工数明細を表示（週全体）
5. ユーザーが週次の工数明細をグリッド形式で入力
   - 日×案件のマトリクス形式
   - 作業種別の選択
   - 工数時間の入力
   - 作業内容の一括入力
6. 入力データのバリデーション
   - 日ごとの合計時間チェック
   - 工数単位チェック
7. 工数明細の一括保存
8. 週次工数合計の更新

### 2.3 月次工数提出フロー

1. ユーザーが月次工数一覧画面を開く
2. システムが指定月の全工数データを表示
3. ユーザーが未入力日の工数を補完
4. システムが月次集計データを表示
   - 案件別合計時間
   - 作業種別別合計時間
   - 請求可能／不可の内訳
5. 工数データのバリデーション
   - 必須日の入力確認
   - 勤怠時間との整合性確認
   - 月次トータルの妥当性確認
6. ユーザーが月次工数を提出
7. 承認ワークフローの開始

### 2.4 プロジェクト工数計画設定フロー

1. プロジェクトマネージャがプロジェクト工数計画画面を開く
2. システムがプロジェクト基本情報を表示
3. プロジェクトマネージャが計画期間を設定
4. システムが計画期間の月別画面を表示
5. プロジェクトマネージャが以下を入力
   - 月別予定工数
   - 作業種別別予定工数
   - 担当者別予定工数
6. 入力データのバリデーション
   - 合計整合性チェック
   - プロジェクト期間チェック
7. 工数計画の保存
8. 計画vs実績比較の更新

### 2.5 工数データ修正フロー

1. ユーザーが修正対象の工数データを選択
2. システムが現在のデータを表示
3. 修正可能性チェック
   - 月次締め前かどうか
   - 承認状態
   - 修正権限
4. ユーザーがデータを修正
5. 修正データのバリデーション
6. 修正理由の入力（必要に応じて）
7. 修正データの保存
8. 修正履歴の記録
9. 必要に応じて承認者に通知

### 2.6 工数テンプレート利用フロー

1. ユーザーが工数テンプレート適用を選択
2. システムが利用可能なテンプレート一覧を表示
3. ユーザーがテンプレートを選択
4. システムがテンプレート内容をプレビュー表示
5. ユーザーがテンプレート適用範囲を指定（日/週/月）
6. システムが既存データとの競合チェック
   - 重複がある場合、処理方針を選択（上書き/マージ/キャンセル）
7. テンプレートの適用実行
8. 適用結果の表示

## 3. 主要コンポーネント構成

### 3.1 TimesheetService

工数情報の基本操作を提供するサービスコンポーネントです。

```java
class TimesheetServiceImpl implements TimesheetService {
    private TimesheetRepository timesheetRepository;
    private TimesheetEntryRepository timesheetEntryRepository;
    private ProjectService projectService;
    private AttendanceService attendanceService;
    private NotificationService notificationService;
    private AuthorizationService authorizationService;
    
    @Override
    public TimesheetEntry createTimesheetEntry(TimesheetEntryCreateRequest request) {
        // 工数明細の作成ロジック
    }
    
    @Override
    public TimesheetEntry updateTimesheetEntry(String entryId, TimesheetEntryUpdateRequest request) {
        // 工数明細の更新ロジック
    }
    
    @Override
    public void deleteTimesheetEntry(String entryId) {
        // 工数明細の削除ロジック
    }
    
    @Override
    public List<TimesheetEntry> getTimesheetEntries(String userId, LocalDate date) {
        // 日付指定での工数明細取得ロジック
    }
    
    @Override
    public List<TimesheetEntry> getTimesheetEntriesByPeriod(String userId, LocalDate startDate, LocalDate endDate) {
        // 期間指定での工数明細取得ロジック
    }
    
    @Override
    public Timesheet createTimesheet(TimesheetCreateRequest request) {
        // 工数シート作成ロジック
    }
    
    @Override
    public Timesheet submitTimesheet(String timesheetId, String comment) {
        // 工数シート提出ロジック
    }
    
    @Override
    public ProjectTimesheet getProjectTimesheet(String projectId, int year, int month) {
        // プロジェクト工数集計取得ロジック
    }
    
    // その他のメソッド実装
}
```

### 3.2 TimesheetEntryRepository

工数明細の永続化と検索を担当するリポジトリコンポーネントです。

```java
interface TimesheetEntryRepository {
    TimesheetEntry save(TimesheetEntry timesheetEntry);
    Optional<TimesheetEntry> findById(String id);
    List<TimesheetEntry> findByTimesheetId(String timesheetId);
    List<TimesheetEntry> findByUserIdAndDate(String userId, LocalDate date);
    List<TimesheetEntry> findByUserIdAndDateBetween(String userId, LocalDate startDate, LocalDate endDate);
    List<TimesheetEntry> findByProjectIdAndDateBetween(String projectId, LocalDate startDate, LocalDate endDate);
    List<TimesheetEntry> findByUserIdAndProjectIdAndDateBetween(String userId, String projectId, LocalDate startDate, LocalDate endDate);
    void deleteById(String id);
    long countByUserIdAndTaskTypeAndDateBetween(String userId, TaskType taskType, LocalDate startDate, LocalDate endDate);
    BigDecimal sumHoursByProjectIdAndDateBetween(String projectId, LocalDate startDate, LocalDate endDate);
    BigDecimal sumHoursByUserIdAndDateBetween(String userId, LocalDate startDate, LocalDate endDate);
}
```

### 3.3 TimesheetRepository

工数シートの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface TimesheetRepository {
    Timesheet save(Timesheet timesheet);
    Optional<Timesheet> findById(String id);
    Optional<Timesheet> findByUserIdAndYearAndMonth(String userId, int year, int month);
    List<Timesheet> findByStatusAndYearAndMonth(SheetStatus status, int year, int month);
    List<Timesheet> findByStatus(SheetStatus status);
    List<Timesheet> findByUserIdAndStatusIn(String userId, List<SheetStatus> statuses);
}
```

### 3.4 ProjectTimesheetRepository

プロジェクト工数計画と実績の永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ProjectTimesheetRepository {
    ProjectTimesheet save(ProjectTimesheet projectTimesheet);
    Optional<ProjectTimesheet> findById(String id);
    Optional<ProjectTimesheet> findByProjectIdAndYearAndMonth(String projectId, int year, int month);
    List<ProjectTimesheet> findByProjectId(String projectId);
    List<ProjectTimesheet> findByProjectIdAndYearAndMonthBetween(String projectId, int yearStart, int monthStart, int yearEnd, int monthEnd);
}
```

### 3.5 TimesheetTemplateRepository

工数テンプレートの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface TimesheetTemplateRepository {
    TimesheetTemplate save(TimesheetTemplate template);
    Optional<TimesheetTemplate> findById(String id);
    List<TimesheetTemplate> findByUserId(String userId);
    List<TimesheetTemplate> findByProjectId(String projectId);
    List<TimesheetTemplate> findByActive(boolean active);
}
```

### 3.6 TimesheetValidator

工数データのバリデーションを担当するコンポーネントです。

```java
class TimesheetValidator {
    private AttendanceService attendanceService;
    private ProjectService projectService;
    
    public ValidationResult validateTimesheetEntry(TimesheetEntryCreateRequest request) {
        // 工数明細作成時のバリデーションロジック
        return validationResult;
    }
    
    public ValidationResult validateTimesheetEntryUpdate(TimesheetEntry entry, TimesheetEntryUpdateRequest request) {
        // 工数明細更新時のバリデーションロジック
        return validationResult;
    }
    
    public ValidationResult validateDailyTotal(String userId, LocalDate date, BigDecimal additionalHours) {
        // 日次工数合計のバリデーションロジック（勤怠時間との整合性など）
        return validationResult;
    }
    
    public ValidationResult validateTimesheet(String userId, int year, int month) {
        // 月次工数シートのバリデーションロジック
        return validationResult;
    }
    
    public ValidationResult validateProjectTimesheet(ProjectTimesheetCreateRequest request) {
        // プロジェクト工数計画のバリデーションロジック
        return validationResult;
    }
}
```

### 3.7 TimesheetCalculator

工数の計算と集計を担当するコンポーネントです。

```java
class TimesheetCalculator {
    public TimesheetSummary calculateTimesheetSummary(String userId, int year, int month) {
        // 月次工数集計計算ロジック
        return summary;
    }
    
    public ProjectTimesheetSummary calculateProjectTimesheetSummary(String projectId, int year, int month) {
        // プロジェクト月次工数集計計算ロジック
        return projectSummary;
    }
    
    public Map<TaskType, BigDecimal> calculateTaskTypeDistribution(List<TimesheetEntry> entries) {
        // 作業種別別工数分布計算ロジック
        return distribution;
    }
    
    public BigDecimal calculateUtilizationRate(String userId, int year, int month) {
        // 稼働率計算ロジック
        return utilizationRate;
    }
    
    public Map<String, BigDecimal> calculateProjectDistribution(List<TimesheetEntry> entries) {
        // プロジェクト別工数分布計算ロジック
        return distribution;
    }
}
```

### 3.8 TimesheetTemplateManager

工数テンプレートの管理を担当するコンポーネントです。

```java
class TimesheetTemplateManager {
    private TimesheetTemplateRepository templateRepository;
    private TimesheetEntryRepository entryRepository;
    
    public TimesheetTemplate createTemplate(TimesheetTemplateCreateRequest request) {
        // テンプレート作成ロジック
        return template;
    }
    
    public TimesheetTemplate updateTemplate(String templateId, TimesheetTemplateUpdateRequest request) {
        // テンプレート更新ロジック
        return template;
    }
    
    public TemplateApplyResult applyTemplate(String templateId, TemplateApplyRequest request) {
        // テンプレート適用ロジック
        return result;
    }
    
    public TemplateApplyPreview previewTemplateApplication(String templateId, TemplateApplyRequest request) {
        // テンプレート適用プレビュー生成ロジック
        return preview;
    }
}
```

## 4. 例外処理

### 4.1 TimesheetEntryNotFoundException

指定された工数明細IDが存在しない場合に発生する例外です。

```java
class TimesheetEntryNotFoundException extends ResourceNotFoundException {
    private String entryId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 TimesheetNotFoundException

指定された工数シートIDが存在しない場合に発生する例外です。

```java
class TimesheetNotFoundException extends ResourceNotFoundException {
    private String timesheetId;
    
    // コンストラクタ、getterなど
}
```

### 4.3 TimesheetValidationException

工数データのバリデーションエラーが発生した場合の例外です。

```java
class TimesheetValidationException extends ValidationException {
    private Map<String, String> validationErrors;
    
    // コンストラクタ、getterなど
}
```

### 4.4 DailyTimesheetOverflowException

日次の工数合計が勤怠時間を超える場合に発生する例外です。

```java
class DailyTimesheetOverflowException extends BusinessRuleException {
    private String userId;
    private LocalDate date;
    private BigDecimal attemptedHours;
    private BigDecimal availableHours;
    
    // コンストラクタ、getterなど
}
```

### 4.5 TimesheetStateException

工数シートが特定の操作を行うのに適切な状態でない場合に発生する例外です。

```java
class TimesheetStateException extends BusinessRuleException {
    private String timesheetId;
    private SheetStatus currentStatus;
    private String operation;
    
    // コンストラクタ、getterなど
}
```

### 4.6 ProjectTimesheetNotFoundException

指定されたプロジェクト工数計画が存在しない場合に発生する例外です。

```java
class ProjectTimesheetNotFoundException extends ResourceNotFoundException {
    private String projectId;
    private int year;
    private int month;
    
    // コンストラクタ、getterなど
}
```

## 5. 工数入力画面の主要機能

### 5.1 日次工数入力

日々の工数情報を入力するための画面で、以下の機能を提供します:

- 日付選択（カレンダーからの選択）
- 担当案件リスト表示（アサイン中の案件一覧）
- 案件検索・選択機能
- 複数案件への工数配分入力
- 作業種別選択（開発、テスト、会議など）
- 工数時間入力（0.25時間単位）
- 請求可否選択
- 作業内容入力
- リアルタイム合計時間表示
- 利用可能時間表示（勤怠情報に基づく）
- 保存・キャンセルボタン

### 5.2 週次工数入力

週単位で工数情報を入力するためのグリッド形式の画面です:

- 週選択（カレンダーからの選択）
- 案件×日付のマトリクス表示
- 一括工数入力機能
- 案件ごとの小計表示
- 日ごとの小計表示
- 勤怠情報との整合性表示
- 工数テンプレート適用機能
- 前週コピー機能
- 一括保存・キャンセルボタン

### 5.3 月次工数管理

月単位で工数状況を確認・編集・提出するための画面です:

- 月選択（カレンダーからの選択）
- 月間カレンダー表示（日ごとの工数合計表示）
- 案件別集計表示
- 作業種別別集計表示
- 請求可能/不可別集計表示
- 未入力日の警告表示
- 勤怠時間との不整合警告表示
- 月次提出ボタン
- 前月・翌月への移動ボタン

### 5.4 プロジェクト工数計画

プロジェクトの工数計画を設定・管理するための画面です:

- プロジェクト選択
- 期間設定（開始月・終了月）
- 月別計画工数入力
- 担当者別計画工数配分
- 作業種別別計画工数配分
- 実績との比較表示
- 消化率・進捗率の表示
- 差異分析グラフ表示
- 保存・キャンセルボタン

### 5.5 工数テンプレート管理

よく使用する工数パターンをテンプレート化して管理する機能です:

- テンプレート一覧表示
- テンプレート作成機能
  - テンプレート名設定
  - 案件選択
  - 作業種別設定
  - 工数パターン設定
  - 説明文入力
- テンプレート編集機能
- テンプレート適用機能
- テンプレート共有設定（個人用/プロジェクト用/部門用）
- インポート/エクスポート機能

## 6. 工数区分と計算ルール

### 6.1 作業種別区分

| 作業種別 | 説明 | 請求可否デフォルト | 備考 |
|---------|------|----------------|------|
| 開発 | プログラム開発作業 | 可能 | 基本的な開発作業 |
| テスト | テスト実行・結果確認 | 可能 | テスト関連作業 |
| 会議 | 打ち合わせ・レビュー | 可能 | 顧客・プロジェクト会議 |
| 分析・設計 | 要件分析・設計作業 | 可能 | 上流工程作業 |
| 保守・運用 | システム保守・運用 | 可能 | 継続的な保守作業 |
| ドキュメント作成 | 文書作成作業 | 可能 | ドキュメント関連作業 |
| 研修・学習 | スキル習得・研修 | 不可 | 内部の能力開発 |
| 内部業務 | 社内作業・管理業務 | 不可 | 社内向け作業 |
| 営業活動 | 営業・提案活動 | 不可 | 営業関連作業 |
| その他 | 上記以外の作業 | 要判断 | 個別判断が必要 |

### 6.2 工数単位と入力ルール

- 基本工数単位: 0.25時間（15分）
- 最小入力単位: 0.25時間
- 日次合計上限: 当日の実労働時間（勤怠データから取得）
- 工数入力精度: 実作業時間の切り上げ（例: 10分→0.25時間）
- 複数案件配分: 同一日に複数案件の工数入力可能

### 6.3 請求可否判断ルール

- 請求可能条件:
  - 契約内の作業であること
  - 顧客価値を生み出す作業であること
  - 契約の作業範囲内であること
- 請求不可の典型例:
  - 内部研修・学習時間
  - 社内会議・管理業務
  - 営業・提案活動
  - 不具合修正（責任範囲内の場合）

### 6.4 プロジェクト工数計画ルール

- 計画単位: 月次
- 計画項目:
  - 月別予定工数
  - 担当者別予定工数
  - 作業種別別予定工数
- 進捗管理:
  - 計画工数消化率 = 実績工数 / 計画工数
  - プロジェクト進捗率（別途管理）
  - EVM分析（オプション）

## 7. 工数実績の活用

### 7.1 請求処理への連携

- 月次承認済み工数データの請求システムへの連携
- 請求可能工数の集計・抽出
- 案件別請求工数の算出
- レート適用による請求金額計算
- 請求明細の自動生成
- 請求書エビデンスとしての工数データエクスポート

### 7.2 プロジェクト管理での活用

- 計画vs実績の比較分析
- 進捗率と工数消化率の乖離分析
- 作業種別分布の分析（開発・テスト比率など）
- メンバー別の負荷状況分析
- 残工数予測と完了予測

### 7.3 予実管理での活用

- 予算消化状況のモニタリング
- 予算超過アラート機能
- 工数ベースのEVM分析
  - 計画値（PV）
  - 獲得価値（EV）
  - 実績コスト（AC）
- コスト効率性指標（CPI）の算出
- スケジュール効率性指標（SPI）の算出

### 7.4 リソース管理での活用

- 技術者の稼働率分析
- 空き工数の可視化
- スキル別の工数分布分析
- 部門別・チーム別の稼働状況分析
- リソース配分最適化の判断材料

## 8. 工数データ連携

### 8.1 他モジュールとの連携

- 勤怠管理モジュール
  - 日次勤怠データの参照
  - 実労働時間の取得
  - 休暇情報の連携
- 案件管理モジュール
  - 案件情報の参照
  - 予算情報の取得
  - 進捗情報への連携
- 請求支払管理モジュール
  - 請求用工数データの提供
  - 請求対象期間の確定工数提供
  - 請求金額計算への入力
- 技術者管理モジュール
  - 技術者の稼働状況連携
  - スキル別稼働実績の提供
- レポーティングモジュール
  - 集計データの提供
  - 分析用データの提供

### 8.2 外部システムとの連携

- プロジェクト管理ツール連携
  - 工数データのエクスポート
  - 計画データのインポート
- 給与システム連携
  - 工数実績データの提供
  - インセンティブ計算用データ提供
- BI/分析ツール連携
  - 工数データの定期エクスポート
  - 分析用データマートへの連携
- 顧客ポータル連携
  - 承認済み工数の公開
  - エビデンスデータの提供

### 8.3 データ連携形式

- CSV形式（基本連携形式）
- JSON形式（API連携用）
- Excel形式（レポート出力用）
- PDF形式（承認・請求用）
- XML形式（特定システム連携用）

### 8.4 連携スケジュール

- 日次連携（勤怠データとの整合性チェック）
- 週次連携（週次レポート生成）
- 月次連携（月締め後の確定データ連携）
- リアルタイム連携（ダッシュボード表示用）