# 勤怠工数管理 インターフェース定義

## 1. インターフェース概要

勤怠工数管理モジュールは、SES業務システムにおける勤怠情報と工数情報を管理するためのインターフェースを提供します。このモジュールが提供するインターフェースを通じて、技術者管理モジュールや案件管理モジュール、請求支払管理モジュールなどの他モジュールは、勤怠・工数データを参照し、業務フローを適切に実行できます。また、勤怠工数管理モジュール自身は、技術者情報や案件情報、組織情報などを他のモジュールから取得し、勤怠・工数管理に活用します。

## 2. 提供インターフェース

### 2.1 AttendanceService

勤怠情報の登録・参照・管理を行うインターフェースです。

#### 2.1.1 createAttendance

```java
Attendance createAttendance(AttendanceCreateRequest request);
```

- **説明**: 日次の勤怠情報を新規作成します
- **パラメータ**:
  - request: 勤怠作成リクエスト（ユーザーID、日付、出勤時間、退勤時間、勤怠区分等）
- **戻り値**: 作成された勤怠情報
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - ResourceNotFoundException: 指定されたユーザーや技術者が存在しない場合
  - BusinessRuleException: ビジネスルール違反の場合（例：重複する日付の勤怠登録）
- **使用コンテキスト**: 技術者や従業員が日々の勤怠情報を登録する際に使用されます。モバイルアプリや勤怠管理画面から呼び出されます。

#### 2.1.2 updateAttendance

```java
Attendance updateAttendance(String attendanceId, AttendanceUpdateRequest request);
```

- **説明**: 既存の勤怠情報を更新します
- **パラメータ**:
  - attendanceId: 勤怠ID
  - request: 勤怠更新リクエスト（出勤時間、退勤時間、勤怠区分等）
- **戻り値**: 更新された勤怠情報
- **例外**:
  - ResourceNotFoundException: 指定された勤怠IDが存在しない場合
  - ValidationException: リクエストデータが不正な場合
  - BusinessRuleException: ビジネスルール違反の場合（例：締め後の修正）
  - AccessDeniedException: 勤怠データへのアクセス権がない場合
- **使用コンテキスト**: 技術者や従業員が登録済みの勤怠情報を修正する際に使用されます。勤怠修正画面から呼び出されます。

#### 2.1.3 getAttendance

```java
Attendance getAttendance(String attendanceId);
```

- **説明**: 指定されたIDの勤怠情報を取得します
- **パラメータ**:
  - attendanceId: 勤怠ID
- **戻り値**: 勤怠情報
- **例外**:
  - ResourceNotFoundException: 指定された勤怠IDが存在しない場合
  - AccessDeniedException: 勤怠データへのアクセス権がない場合
- **使用コンテキスト**: 勤怠詳細画面での表示や、勤怠データの編集前の情報取得に使用されます。

#### 2.1.4 getAttendanceByDate

```java
Attendance getAttendanceByDate(String userId, LocalDate date);
```

- **説明**: 指定されたユーザーと日付の勤怠情報を取得します
- **パラメータ**:
  - userId: ユーザーID
  - date: 日付
- **戻り値**: 勤怠情報（存在しない場合はnull）
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: 勤怠データへのアクセス権がない場合
- **使用コンテキスト**: 日次の勤怠入力画面で、既存の勤怠データを表示する際に使用されます。また、工数入力時に対応する勤怠情報を取得するためにも使用されます。

#### 2.1.5 searchAttendances

```java
Page<Attendance> searchAttendances(AttendanceSearchRequest request, Pageable pageable);
```

- **説明**: 勤怠情報を検索します
- **パラメータ**:
  - request: 勤怠検索リクエスト（ユーザーID、日付範囲、勤怠区分等）
  - pageable: ページネーション情報
- **戻り値**: 勤怠情報のページ
- **例外**:
  - ValidationException: リクエストデータが不正な場合
- **使用コンテキスト**: 管理者が特定条件で勤怠データを検索する際や、月次の勤怠一覧を表示する際に使用されます。

#### 2.1.6 createAttendanceSheet

```java
AttendanceSheet createAttendanceSheet(AttendanceSheetCreateRequest request);
```

- **説明**: 月次の勤怠シートを作成します
- **パラメータ**:
  - request: 勤怠シート作成リクエスト（ユーザーID、年、月）
- **戻り値**: 作成された勤怠シート
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - ResourceNotFoundException: 指定されたユーザーが存在しない場合
  - BusinessRuleException: ビジネスルール違反の場合（例：すでに存在する勤怠シート）
- **使用コンテキスト**: 月初や新しい月の勤怠入力を始める際に、システムが自動的に月次シートを作成するために使用されます。

#### 2.1.7 submitAttendanceSheet

```java
AttendanceSheet submitAttendanceSheet(String sheetId, String comment);
```

- **説明**: 勤怠シートを提出します
- **パラメータ**:
  - sheetId: 勤怠シートID
  - comment: 提出コメント（任意）
- **戻り値**: 更新された勤怠シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - ValidationException: シートが提出可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
- **使用コンテキスト**: 技術者や従業員が月末に月次の勤怠情報を確定して提出する際に使用されます。提出後、承認ワークフローが開始されます。

#### 2.1.8 getAttendanceSheet

```java
AttendanceSheet getAttendanceSheet(String sheetId);
```

- **説明**: 指定されたIDの勤怠シートを取得します
- **パラメータ**:
  - sheetId: 勤怠シートID
- **戻り値**: 勤怠シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - AccessDeniedException: シートへのアクセス権がない場合
- **使用コンテキスト**: 勤怠シート詳細画面での表示や、承認処理の前の情報取得に使用されます。

#### 2.1.9 getAttendanceSheetByYearMonth

```java
AttendanceSheet getAttendanceSheetByYearMonth(String userId, int year, int month);
```

- **説明**: 指定されたユーザー、年、月の勤怠シートを取得します
- **パラメータ**:
  - userId: ユーザーID
  - year: 年
  - month: 月
- **戻り値**: 勤怠シート（存在しない場合はnull）
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: シートへのアクセス権がない場合
- **使用コンテキスト**: 月次の勤怠入力・確認画面で、既存の勤怠シートを表示する際に使用されます。

#### 2.1.10 createLeaveRequest

```java
LeaveRequest createLeaveRequest(LeaveRequestCreateRequest request);
```

- **説明**: 休暇申請を作成します
- **パラメータ**:
  - request: 休暇申請リクエスト（ユーザーID、休暇種別、開始日、終了日等）
- **戻り値**: 作成された休暇申請
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - ResourceNotFoundException: 指定されたユーザーが存在しない場合
  - BusinessRuleException: ビジネスルール違反の場合（例：有給休暇残日数不足）
- **使用コンテキスト**: 技術者や従業員が休暇を申請する際に使用されます。休暇申請画面から呼び出されます。

#### 2.1.11 getLeaveRequests

```java
List<LeaveRequest> getLeaveRequests(String userId, LeaveRequestStatus status, LocalDate startDate, LocalDate endDate);
```

- **説明**: 指定された条件に合致する休暇申請を取得します
- **パラメータ**:
  - userId: ユーザーID
  - status: 申請ステータス（任意）
  - startDate: 開始日（任意）
  - endDate: 終了日（任意）
- **戻り値**: 休暇申請のリスト
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 休暇申請一覧画面での表示や、特定期間の休暇状況を確認する際に使用されます。

### 2.2 TimesheetService

工数情報の登録・参照・管理を行うインターフェースです。

#### 2.2.1 createTimesheetEntry

```java
TimesheetEntry createTimesheetEntry(TimesheetEntryCreateRequest request);
```

- **説明**: 工数明細を作成します
- **パラメータ**:
  - request: 工数明細作成リクエスト（ユーザーID、日付、案件ID、作業種別、工数時間等）
- **戻り値**: 作成された工数明細
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - ResourceNotFoundException: 指定されたユーザーや案件が存在しない場合
  - BusinessRuleException: ビジネスルール違反の場合（例：勤怠時間を超える工数登録）
- **使用コンテキスト**: 技術者や従業員が日々の工数を入力する際に使用されます。工数入力画面から呼び出されます。

#### 2.2.2 updateTimesheetEntry

```java
TimesheetEntry updateTimesheetEntry(String entryId, TimesheetEntryUpdateRequest request);
```

- **説明**: 工数明細を更新します
- **パラメータ**:
  - entryId: 工数明細ID
  - request: 工数明細更新リクエスト（作業種別、工数時間等）
- **戻り値**: 更新された工数明細
- **例外**:
  - ResourceNotFoundException: 指定された工数明細IDが存在しない場合
  - ValidationException: リクエストデータが不正な場合
  - BusinessRuleException: ビジネスルール違反の場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 技術者や従業員が登録済みの工数情報を修正する際に使用されます。工数修正画面から呼び出されます。

#### 2.2.3 deleteTimesheetEntry

```java
void deleteTimesheetEntry(String entryId);
```

- **説明**: 工数明細を削除します
- **パラメータ**:
  - entryId: 工数明細ID
- **例外**:
  - ResourceNotFoundException: 指定された工数明細IDが存在しない場合
  - BusinessRuleException: ビジネスルール違反の場合（例：承認済み工数の削除）
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 技術者や従業員が登録した工数情報を削除する際に使用されます。工数入力画面から呼び出されます。

#### 2.2.4 getTimesheetEntries

```java
List<TimesheetEntry> getTimesheetEntries(String userId, LocalDate date);
```

- **説明**: 指定されたユーザーと日付の工数明細を取得します
- **パラメータ**:
  - userId: ユーザーID
  - date: 日付
- **戻り値**: 工数明細のリスト
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 日次の工数入力画面で、既存の工数データを表示する際に使用されます。

#### 2.2.5 getTimesheetEntriesByPeriod

```java
List<TimesheetEntry> getTimesheetEntriesByPeriod(String userId, LocalDate startDate, LocalDate endDate);
```

- **説明**: 指定されたユーザーと期間の工数明細を取得します
- **パラメータ**:
  - userId: ユーザーID
  - startDate: 開始日
  - endDate: 終了日
- **戻り値**: 工数明細のリスト
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 週次や月次の工数入力画面で、期間内の工数データを表示する際に使用されます。

#### 2.2.6 createTimesheet

```java
Timesheet createTimesheet(TimesheetCreateRequest request);
```

- **説明**: 月次の工数シートを作成します
- **パラメータ**:
  - request: 工数シート作成リクエスト（ユーザーID、年、月）
- **戻り値**: 作成された工数シート
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - ResourceNotFoundException: 指定されたユーザーが存在しない場合
  - BusinessRuleException: ビジネスルール違反の場合（例：すでに存在する工数シート）
- **使用コンテキスト**: 月初や新しい月の工数入力を始める際に、システムが自動的に月次シートを作成するために使用されます。

#### 2.2.7 submitTimesheet

```java
Timesheet submitTimesheet(String timesheetId, String comment);
```

- **説明**: 工数シートを提出します
- **パラメータ**:
  - timesheetId: 工数シートID
  - comment: 提出コメント（任意）
- **戻り値**: 更新された工数シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - ValidationException: シートが提出可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
- **使用コンテキスト**: 技術者や従業員が月末に月次の工数情報を確定して提出する際に使用されます。提出後、承認ワークフローが開始されます。

#### 2.2.8 getTimesheet

```java
Timesheet getTimesheet(String timesheetId);
```

- **説明**: 指定されたIDの工数シートを取得します
- **パラメータ**:
  - timesheetId: 工数シートID
- **戻り値**: 工数シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - AccessDeniedException: シートへのアクセス権がない場合
- **使用コンテキスト**: 工数シート詳細画面での表示や、承認処理の前の情報取得に使用されます。

#### 2.2.9 getTimesheetByYearMonth

```java
Timesheet getTimesheetByYearMonth(String userId, int year, int month);
```

- **説明**: 指定されたユーザー、年、月の工数シートを取得します
- **パラメータ**:
  - userId: ユーザーID
  - year: 年
  - month: 月
- **戻り値**: 工数シート（存在しない場合はnull）
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: シートへのアクセス権がない場合
- **使用コンテキスト**: 月次の工数入力・確認画面で、既存の工数シートを表示する際に使用されます。

#### 2.2.10 getProjectTimesheet

```java
ProjectTimesheet getProjectTimesheet(String projectId, int year, int month);
```

- **説明**: 指定されたプロジェクト、年、月の工数集計を取得します
- **パラメータ**:
  - projectId: プロジェクトID
  - year: 年
  - month: 月
- **戻り値**: プロジェクト工数集計
- **例外**:
  - ResourceNotFoundException: 指定されたプロジェクトIDが存在しない場合
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: プロジェクトマネージャが月次のプロジェクト工数を確認する際や、請求処理のための工数データを取得する際に使用されます。

### 2.3 ApprovalService

承認管理機能を提供するインターフェースです。

#### 2.3.1 approveAttendanceSheet

```java
AttendanceSheet approveAttendanceSheet(String sheetId, ApprovalRequest request);
```

- **説明**: 勤怠シートを承認します
- **パラメータ**:
  - sheetId: 勤怠シートID
  - request: 承認リクエスト（コメント等）
- **戻り値**: 更新された勤怠シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - ValidationException: 承認可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
  - AccessDeniedException: 承認権限がない場合
- **使用コンテキスト**: 管理者や上長が部下の勤怠シートを承認する際に使用されます。承認ワークフローの一部として呼び出されます。

#### 2.3.2 rejectAttendanceSheet

```java
AttendanceSheet rejectAttendanceSheet(String sheetId, RejectionRequest request);
```

- **説明**: 勤怠シートを差し戻します
- **パラメータ**:
  - sheetId: 勤怠シートID
  - request: 差戻リクエスト（理由、コメント等）
- **戻り値**: 更新された勤怠シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - ValidationException: 差戻可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
  - AccessDeniedException: 差戻権限がない場合
- **使用コンテキスト**: 管理者や上長が部下の勤怠シートに問題がある場合に差し戻す際に使用されます。

#### 2.3.3 approveTimesheet

```java
Timesheet approveTimesheet(String timesheetId, ApprovalRequest request);
```

- **説明**: 工数シートを承認します
- **パラメータ**:
  - timesheetId: 工数シートID
  - request: 承認リクエスト（コメント等）
- **戻り値**: 更新された工数シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - ValidationException: 承認可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
  - AccessDeniedException: 承認権限がない場合
- **使用コンテキスト**: プロジェクトマネージャや上長が部下の工数シートを承認する際に使用されます。

#### 2.3.4 rejectTimesheet

```java
Timesheet rejectTimesheet(String timesheetId, RejectionRequest request);
```

- **説明**: 工数シートを差し戻します
- **パラメータ**:
  - timesheetId: 工数シートID
  - request: 差戻リクエスト（理由、コメント等）
- **戻り値**: 更新された工数シート
- **例外**:
  - ResourceNotFoundException: 指定されたシートIDが存在しない場合
  - ValidationException: 差戻可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
  - AccessDeniedException: 差戻権限がない場合
- **使用コンテキスト**: プロジェクトマネージャや上長が部下の工数シートに問題がある場合に差し戻す際に使用されます。

#### 2.3.5 approveLeaveRequest

```java
LeaveRequest approveLeaveRequest(String requestId, ApprovalRequest request);
```

- **説明**: 休暇申請を承認します
- **パラメータ**:
  - requestId: 休暇申請ID
  - request: 承認リクエスト（コメント等）
- **戻り値**: 更新された休暇申請
- **例外**:
  - ResourceNotFoundException: 指定された申請IDが存在しない場合
  - ValidationException: 承認可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
  - AccessDeniedException: 承認権限がない場合
- **使用コンテキスト**: 管理者や上長が部下の休暇申請を承認する際に使用されます。

#### 2.3.6 rejectLeaveRequest

```java
LeaveRequest rejectLeaveRequest(String requestId, RejectionRequest request);
```

- **説明**: 休暇申請を差し戻します
- **パラメータ**:
  - requestId: 休暇申請ID
  - request: 差戻リクエスト（理由、コメント等）
- **戻り値**: 更新された休暇申請
- **例外**:
  - ResourceNotFoundException: 指定された申請IDが存在しない場合
  - ValidationException: 差戻可能な状態でない場合
  - BusinessRuleException: ビジネスルール違反の場合
  - AccessDeniedException: 差戻権限がない場合
- **使用コンテキスト**: 管理者や上長が部下の休暇申請に問題がある場合に差し戻す際に使用されます。

#### 2.3.7 getApprovalWorkflows

```java
List<ApprovalWorkflow> getApprovalWorkflows(ApprovalTargetType targetType, String organizationId);
```

- **説明**: 承認ワークフローを取得します
- **パラメータ**:
  - targetType: 承認対象種別
  - organizationId: 組織ID
- **戻り値**: 承認ワークフローのリスト
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 承認フロー設定画面での表示や、承認処理の開始時に適用すべきワークフローを決定する際に使用されます。

#### 2.3.8 getApprovalHistory

```java
List<ApprovalHistory> getApprovalHistory(String targetType, String targetId);
```

- **説明**: 承認履歴を取得します
- **パラメータ**:
  - targetType: 対象種別（"ATTENDANCE_SHEET", "TIMESHEET", "LEAVE_REQUEST"等）
  - targetId: 対象ID
- **戻り値**: 承認履歴のリスト
- **例外**:
  - ValidationException: パラメータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 勤怠シートや工数シートの詳細画面で、承認履歴を表示する際に使用されます。

### 2.4 ReportService

勤怠・工数のレポート機能を提供するインターフェースです。

#### 2.4.1 getAttendanceSummary

```java
AttendanceSummary getAttendanceSummary(String userId, int year, int month);
```

- **説明**: ユーザーの月次勤怠集計を取得します
- **パラメータ**:
  - userId: ユーザーID
  - year: 年
  - month: 月
- **戻り値**: 勤怠集計情報
- **例外**:
  - ValidationException: パラメータが不正な場合
  - ResourceNotFoundException: 指定されたユーザーの勤怠データが存在しない場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 月次の勤怠レポート画面での表示や、給与計算の際のデータ取得に使用されます。

#### 2.4.2 getTimesheetSummary

```java
TimesheetSummary getTimesheetSummary(String userId, int year, int month);
```

- **説明**: ユーザーの月次工数集計を取得します
- **パラメータ**:
  - userId: ユーザーID
  - year: 年
  - month: 月
- **戻り値**: 工数集計情報
- **例外**:
  - ValidationException: パラメータが不正な場合
  - ResourceNotFoundException: 指定されたユーザーの工数データが存在しない場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 月次の工数レポート画面での表示や、請求処理の際のデータ取得に使用されます。

#### 2.4.3 getProjectTimesheetSummary

```java
ProjectTimesheetSummary getProjectTimesheetSummary(String projectId, int year, int month);
```

- **説明**: プロジェクトの月次工数集計を取得します
- **パラメータ**:
  - projectId: プロジェクトID
  - year: 年
  - month: 月
- **戻り値**: プロジェクト工数集計情報
- **例外**:
  - ValidationException: パラメータが不正な場合
  - ResourceNotFoundException: 指定されたプロジェクトの工数データが存在しない場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: プロジェクトの月次工数レポート画面での表示や、プロジェクト予算管理の際のデータ取得に使用されます。

#### 2.4.4 getDepartmentAttendanceSummary

```java
DepartmentAttendanceSummary getDepartmentAttendanceSummary(String departmentId, int year, int month);
```

- **説明**: 部門の月次勤怠集計を取得します
- **パラメータ**:
  - departmentId: 部門ID
  - year: 年
  - month: 月
- **戻り値**: 部門勤怠集計情報
- **例外**:
  - ValidationException: パラメータが不正な場合
  - ResourceNotFoundException: 指定された部門の勤怠データが存在しない場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 部門の月次勤怠レポート画面での表示や、部門管理の際のデータ取得に使用されます。

#### 2.4.5 getUtilizationReport

```java
UtilizationReport getUtilizationReport(UtilizationReportRequest request);
```

- **説明**: 稼働率レポートを取得します
- **パラメータ**:
  - request: 稼働率レポートリクエスト（対象期間、対象組織、集計単位等）
- **戻り値**: 稼働率レポート
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 経営層や管理者が稼働状況を確認するためのダッシュボードや、リソース配分計画の際のデータ取得に使用されます。

#### 2.4.6 exportAttendanceData

```java
byte[] exportAttendanceData(AttendanceExportRequest request);
```

- **説明**: 勤怠データをエクスポートします
- **パラメータ**:
  - request: 勤怠エクスポートリクエスト（対象期間、対象ユーザー、出力形式等）
- **戻り値**: エクスポートデータのバイナリ
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 管理者が勤怠データを外部システムに連携する際や、データ分析のためにエクスポートする際に使用されます。

#### 2.4.7 exportTimesheetData

```java
byte[] exportTimesheetData(TimesheetExportRequest request);
```

- **説明**: 工数データをエクスポートします
- **パラメータ**:
  - request: 工数エクスポートリクエスト（対象期間、対象ユーザー、出力形式等）
- **戻り値**: エクスポートデータのバイナリ
- **例外**:
  - ValidationException: リクエストデータが不正な場合
  - AccessDeniedException: データへのアクセス権がない場合
- **使用コンテキスト**: 管理者やプロジェクトマネージャが工数データを外部システムに連携する際や、データ分析のためにエクスポートする際に使用されます。

## 3. 要求インターフェース

### 3.1 ProjectService（案件管理モジュール）

案件情報を取得するためのインターフェースです。

#### 3.1.1 getProject

```java
Project getProject(String projectId);
```

- **説明**: 指定されたIDのプロジェクト情報を取得します
- **パラメータ**:
  - projectId: プロジェクトID
- **戻り値**: プロジェクト情報
- **例外**:
  - ResourceNotFoundException: 指定されたプロジェクトIDが存在しない場合
- **目的と使用文脈**: 工数入力時にプロジェクト情報を参照するために使用します。プロジェクト名や期間、予算などの情報を取得し、工数入力画面に表示したり、入力値の妥当性チェックに利用します。

#### 3.1.2 getActiveProjects

```java
List<Project> getActiveProjects(String engineerId);
```

- **説明**: 指定された技術者のアクティブなプロジェクト一覧を取得します
- **パラメータ**:
  - engineerId: 技術者ID
- **戻り値**: プロジェクト情報のリスト
- **例外**:
  - ResourceNotFoundException: 指定された技術者IDが存在しない場合
- **目的と使用文脈**: 工数入力画面でプロジェクト選択リストを表示する際に使用します。技術者がアサインされているアクティブなプロジェクトのみを表示することで、入力の効率化と誤入力防止を図ります。

### 3.2 EngineerService（技術者管理モジュール）

技術者情報を取得するためのインターフェースです。

#### 3.2.1 getEngineer

```java
Engineer getEngineer(String engineerId);
```

- **説明**: 指定されたIDの技術者情報を取得します
- **パラメータ**:
  - engineerId: 技術者ID
- **戻り値**: 技術者情報
- **例外**:
  - ResourceNotFoundException: 指定された技術者IDが存在しない場合
- **目的と使用文脈**: 勤怠・工数データの登録時に技術者の情報を参照するために使用します。技術者の所属部門や雇用形態などの情報を取得し、勤務形態やルールの適用に利用します。

#### 3.2.2 getEngineerAssignments

```java
List<Assignment> getEngineerAssignments(String engineerId, LocalDate date);
```

- **説明**: 指定された技術者の特定日のアサイン情報を取得します
- **パラメータ**:
  - engineerId: 技術者ID
  - date: 日付
- **戻り値**: アサイン情報のリスト
- **例外**:
  - ResourceNotFoundException: 指定された技術者IDが存在しない場合
- **目的と使用文脈**: 工数入力時に技術者のアサイン状況を確認するために使用します。複数案件にアサインされている場合の工数配分の参考情報として利用します。

### 3.3 OrganizationService（共通機能）

組織情報を取得するためのインターフェースです。

#### 3.3.1 getOrganization

```java
Organization getOrganization(String organizationId);
```

- **説明**: 指定されたIDの組織情報を取得します
- **パラメータ**:
  - organizationId: 組織ID
- **戻り値**: 組織情報
- **例外**:
  - ResourceNotFoundException: 指定された組織IDが存在しない場合
- **目的と使用文脈**: 勤怠・工数の承認フロー設定や部門別集計を行う際に、組織構造情報を参照するために使用します。

#### 3.3.2 getUserOrganization

```java
Organization getUserOrganization(String userId);
```

- **説明**: 指定されたユーザーの所属組織を取得します
- **パラメータ**:
  - userId: ユーザーID
- **戻り値**: 組織情報
- **例外**:
  - ResourceNotFoundException: 指定されたユーザーIDが存在しない場合
- **目的と使用文脈**: ユーザーの勤怠・工数データ登録時に、所属組織に基づく勤務ルールや承認フローを適用するために使用します。

### 3.4 NotificationService（共通機能）

通知の送信を行うためのインターフェースです。

#### 3.4.1 sendNotification

```java
void sendNotification(NotificationRequest request);
```

- **説明**: 通知を送信します
- **パラメータ**:
  - request: 通知リクエスト（受信者、タイトル、内容、タイプなど）
- **目的と使用文脈**: 勤怠・工数の提出・承認・差戻し時に関係者への通知を送信するために使用します。また、締め日前のリマインダーや承認待ちの通知なども送信します。

### 3.5 AuthorizationService（共通機能）

認可と権限管理を行うためのインターフェースです。

#### 3.5.1 checkPermission

```java
boolean checkPermission(String userId, String resourceType, String resourceId, String permission);
```

- **説明**: ユーザーが特定のリソースに対して特定の権限を持っているかを確認します
- **パラメータ**:
  - userId: ユーザーID
  - resourceType: リソースタイプ（"attendance", "timesheet"など）
  - resourceId: リソースID
  - permission: 権限（"read", "write", "approve"など）
- **戻り値**: 権限の有無
- **目的と使用文脈**: ユーザーが勤怠・工数データに対して特定の操作（閲覧、編集、承認など）を行う権限があるかを確認するために使用します。セキュリティチェックとして、各APIの実行前に呼び出されます。

### 3.6 CalendarService（共通機能）

カレンダー情報を取得するためのインターフェースです。

#### 3.6.1 getBusinessDays

```java
List<LocalDate> getBusinessDays(int year, int month);
```

- **説明**: 指定された年月の営業日一覧を取得します
- **パラメータ**:
  - year: 年
  - month: 月
- **戻り値**: 営業日の日付リスト
- **目的と使用文脈**: 勤怠カレンダー表示や勤務日数の計算、休日出勤の判定などに使用します。

#### 3.6.2 getHolidays

```java
List<Holiday> getHolidays(int year, int month);
```

- **説明**: 指定された年月の休日情報を取得します
- **パラメータ**:
  - year: 年
  - month: 月
- **戻り値**: 休日情報のリスト
- **目的と使用文脈**: 勤怠カレンダー表示や休日の判定、休日出勤時の割増計算などに使用します。

## 4. データ交換モデル

勤怠工数管理モジュールで使用される主要なデータ交換モデル（DTO）を定義します。

### 4.1 AttendanceCreateRequestDTO

```java
class AttendanceCreateRequestDTO {
    String userId;
    String engineerId;    // 任意（技術者の場合）
    LocalDate date;
    LocalDateTime startTime;
    LocalDateTime endTime;
    Duration breakTime;
    AttendanceType attendanceType;
    String workPatternId;
    String note;
}
```

### 4.2 AttendanceUpdateRequestDTO

```java
class AttendanceUpdateRequestDTO {
    LocalDateTime startTime;
    LocalDateTime endTime;
    Duration breakTime;
    AttendanceType attendanceType;
    String workPatternId;
    String note;
}
```

### 4.3 AttendanceDTO

```java
class AttendanceDTO {
    String id;
    String userId;
    String engineerId;
    String userName;
    LocalDate date;
    LocalDateTime startTime;
    LocalDateTime endTime;
    Duration breakTime;
    AttendanceType attendanceType;
    WorkPatternDTO workPattern;
    BigDecimal actualWorkHours;
    BigDecimal overtimeHours;
    BigDecimal lateNightHours;
    BigDecimal holidayWorkHours;
    AttendanceStatus status;
    String note;
    LocalDateTime createdAt;
    LocalDateTime updatedAt;
}
```

### 4.4 AttendanceSheetCreateRequestDTO

```java
class AttendanceSheetCreateRequestDTO {
    String userId;
    String engineerId;    // 任意（技術者の場合）
    int year;
    int month;
}
```

### 4.5 AttendanceSheetDTO

```java
class AttendanceSheetDTO {
    String id;
    String userId;
    String engineerId;
    String userName;
    int year;
    int month;
    SheetStatus status;
    int totalWorkDays;
    BigDecimal totalWorkHours;
    BigDecimal totalOvertimeHours;
    BigDecimal totalHolidayWorkHours;
    LocalDateTime submittedAt;
    LocalDateTime approvedAt;
    String approvedBy;
    String approverName;
    LocalDateTime rejectedAt;
    String rejectedBy;
    String rejectionReason;
    String note;
    List<AttendanceDTO> attendances;
}
```

### 4.6 TimesheetEntryCreateRequestDTO

```java
class TimesheetEntryCreateRequestDTO {
    String timesheetId;
    String userId;
    String engineerId;    // 任意（技術者の場合）
    LocalDate date;
    String projectId;
    String taskId;        // 任意
    TaskType taskType;
    BigDecimal hours;
    boolean billable;
    String description;
}
```

### 4.7 TimesheetEntryDTO

```java
class TimesheetEntryDTO {
    String id;
    String timesheetId;
    String userId;
    String engineerId;
    LocalDate date;
    String projectId;
    String projectName;
    String taskId;
    String taskName;
    TaskType taskType;
    BigDecimal hours;
    boolean billable;
    String description;
    LocalDateTime createdAt;
    LocalDateTime updatedAt;
}
```

### 4.8 TimesheetCreateRequestDTO

```java
class TimesheetCreateRequestDTO {
    String userId;
    String engineerId;    // 任意（技術者の場合）
    int year;
    int month;
}
```

### 4.9 TimesheetDTO

```java
class TimesheetDTO {
    String id;
    String userId;
    String engineerId;
    String userName;
    int year;
    int month;
    SheetStatus status;
    BigDecimal totalHours;
    LocalDateTime submittedAt;
    LocalDateTime approvedAt;
    String approvedBy;
    String approverName;
    LocalDateTime rejectedAt;
    String rejectedBy;
    String rejectionReason;
    String note;
    List<TimesheetEntryDTO> entries;
}
```

### 4.10 LeaveRequestCreateRequestDTO

```java
class LeaveRequestCreateRequestDTO {
    String userId;
    String engineerId;    // 任意（技術者の場合）
    LeaveType leaveType;
    LocalDate startDate;
    LocalDate endDate;
    boolean startHalf;
    boolean endHalf;
    String reason;
}
```

### 4.11 LeaveRequestDTO

```java
class LeaveRequestDTO {
    String id;
    String userId;
    String engineerId;
    String userName;
    LeaveType leaveType;
    LocalDate startDate;
    LocalDate endDate;
    boolean startHalf;
    boolean endHalf;
    BigDecimal leaveDays;
    String reason;
    ApprovalStatus status;
    LocalDateTime approvedAt;
    String approvedBy;
    String approverName;
    LocalDateTime rejectedAt;
    String rejectedBy;
    String rejectionReason;
    LocalDateTime createdAt;
    LocalDateTime updatedAt;
}
```

### 4.12 ApprovalRequestDTO

```java
class ApprovalRequestDTO {
    String comment;
}
```

### 4.13 RejectionRequestDTO

```java
class RejectionRequestDTO {
    String reason;
    String comment;
}
```

### 4.14 AttendanceSummaryDTO

```java
class AttendanceSummaryDTO {
    String userId;
    String engineerId;
    String userName;
    int year;
    int month;
    int totalWorkDays;
    BigDecimal totalWorkHours;
    BigDecimal regularHours;
    BigDecimal overtimeHours;
    BigDecimal holidayWorkHours;
    BigDecimal lateNightHours;
    BigDecimal paidLeaveUsed;
    BigDecimal specialLeaveUsed;
    int absenceDays;
}
```

### 4.15 TimesheetSummaryDTO

```java
class TimesheetSummaryDTO {
    String userId;
    String engineerId;
    String userName;
    int year;
    int month;
    BigDecimal totalHours;
    BigDecimal billableHours;
    BigDecimal nonBillableHours;
    Map<String, BigDecimal> projectHours;
    Map<TaskType, BigDecimal> taskTypeHours;
    BigDecimal utilizationRate;
}
```

### 4.16 ProjectTimesheetSummaryDTO

```java
class ProjectTimesheetSummaryDTO {
    String projectId;
    String projectName;
    int year;
    int month;
    BigDecimal totalHours;
    BigDecimal budgetHours;
    BigDecimal remainingHours;
    BigDecimal progressPercentage;
    List<EngineerTimesheetDTO> engineerTimesheets;
    Map<TaskType, BigDecimal> taskTypeHours;
}
```

### 4.17 EngineerTimesheetDTO

```java
class EngineerTimesheetDTO {
    String engineerId;
    String engineerName;
    BigDecimal totalHours;
    Map<LocalDate, BigDecimal> dailyHours;
    Map<TaskType, BigDecimal> taskTypeHours;
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- 日次勤怠・工数データの登録・更新は1秒以内に完了すること
- 月次勤怠・工数シートの取得は2秒以内に完了すること
- 部門やプロジェクト全体の集計レポート生成は5秒以内に完了すること
- 同時に100ユーザーが勤怠・工数データを入力しても性能劣化がないこと
- 月末の一斉入力時（ピーク時）でも応答時間が3秒を超えないこと

### 5.2 セキュリティ要件

- 勤怠・工数データへのアクセスは認証と認可を通過したユーザーのみに制限すること
- 個人の勤怠・工数データは本人と承認権限者のみがアクセス可能であること
- 部門やプロジェクト全体のデータは適切な権限を持つ管理者のみがアクセス可能であること
- データ修正履歴はすべて監査ログに記録し、改ざんできないように保護すること
- 月次締め後のデータ修正は特別な権限と承認プロセスを経た場合のみ許可すること

### 5.3 可用性要件

- 勤怠工数管理システムは営業時間内（平日8:00〜20:00）は99.5%の可用性を確保すること
- 計画メンテナンス以外でのサービス停止は月間で4時間未満とすること
- バックアップは1日1回実施し、30日間保持すること
- 障害発生時は30分以内に復旧を開始すること
- 勤怠・工数データの復旧目標時間（RTO）は4時間以内とすること

### 5.4 拡張性要件

- 利用ユーザー数が現状の2倍に増加しても性能を維持できる設計とすること
- 新しい勤務形態や工数区分の追加が容易に行えること
- 承認ワークフローのカスタマイズが可能であること
- 外部システムとの連携インターフェースを柔軟に拡張できること
- レポート項目のカスタマイズが可能であること