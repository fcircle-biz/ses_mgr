# 勤怠工数管理 ドメインモデル

## 1. エンティティ定義

### 1.1 Attendance（勤怠）

日次の勤怠情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 勤怠ID | 主キー、UUID形式 |
| userId | String | ユーザーID | 必須、ユーザー管理モジュールのユーザーIDと紐付け |
| engineerId | String | 技術者ID | 条件付き必須（技術者の場合）、技術者管理モジュールの技術者IDと紐付け |
| date | Date | 日付 | 必須 |
| startTime | DateTime | 出勤時間 | 条件付き必須（勤務日の場合） |
| endTime | DateTime | 退勤時間 | 条件付き必須（勤務日の場合） |
| breakTime | Duration | 休憩時間 | 任意、デフォルト値あり |
| attendanceType | AttendanceType | 勤怠区分 | 必須 |
| workPattern | WorkPattern | 勤務形態 | 必須 |
| actualWorkHours | Decimal | 実労働時間 | 必須、startTime, endTime, breakTimeから自動計算 |
| overtimeHours | Decimal | 残業時間 | 任意、自動計算 |
| lateNightHours | Decimal | 深夜時間 | 任意、自動計算 |
| holidayWorkHours | Decimal | 休日労働時間 | 任意、自動計算 |
| status | AttendanceStatus | 勤怠ステータス | 必須 |
| note | String | 備考 | 任意 |
| createdBy | String | 作成者ID | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedBy | String | 更新者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 日付と技術者IDの組み合わせで一意の勤怠記録を作成
- 勤務日（WORKDAY）の場合、開始時間と終了時間は必須
- 実労働時間は（終了時間 - 開始時間 - 休憩時間）で自動計算
- 残業時間、深夜時間、休日労働時間は勤務形態に基づいて自動計算
- 月末締め後（APPROVED, REJECTED以外）の勤怠記録は修正不可

### 1.2 AttendanceSheet（勤怠シート）

月次の勤怠情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 勤怠シートID | 主キー、UUID形式 |
| userId | String | ユーザーID | 必須、ユーザー管理モジュールのユーザーIDと紐付け |
| engineerId | String | 技術者ID | 条件付き必須（技術者の場合） |
| year | Integer | 年 | 必須 |
| month | Integer | 月 | 必須、1-12の値 |
| status | SheetStatus | シートステータス | 必須 |
| totalWorkDays | Integer | 総勤務日数 | 必須、自動計算 |
| totalWorkHours | Decimal | 総労働時間 | 必須、自動計算 |
| totalOvertimeHours | Decimal | 総残業時間 | 任意、自動計算 |
| totalHolidayWorkHours | Decimal | 総休日労働時間 | 任意、自動計算 |
| submittedAt | DateTime | 提出日時 | 任意 |
| approvedAt | DateTime | 承認日時 | 任意 |
| approvedBy | String | 承認者ID | 任意 |
| rejectedAt | DateTime | 差戻日時 | 任意 |
| rejectedBy | String | 差戻者ID | 任意 |
| rejectionReason | String | 差戻理由 | 任意 |
| note | String | 備考 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 技術者ID（または一般ユーザーID）、年、月の組み合わせで一意
- 総勤務日数、総労働時間、総残業時間、総休日労働時間は関連する日次勤怠記録から自動集計
- 承認済み（APPROVED）状態の勤怠シートは修正不可
- 差戻し（REJECTED）状態の場合、修正後に再提出可能

### 1.3 Timesheet（工数シート）

日次または月次の工数情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 工数シートID | 主キー、UUID形式 |
| userId | String | ユーザーID | 必須、ユーザー管理モジュールのユーザーIDと紐付け |
| engineerId | String | 技術者ID | 条件付き必須（技術者の場合） |
| year | Integer | 年 | 必須 |
| month | Integer | 月 | 必須、1-12の値 |
| status | SheetStatus | シートステータス | 必須 |
| totalHours | Decimal | 総工数時間 | 必須、自動計算 |
| submittedAt | DateTime | 提出日時 | 任意 |
| approvedAt | DateTime | 承認日時 | 任意 |
| approvedBy | String | 承認者ID | 任意 |
| rejectedAt | DateTime | 差戻日時 | 任意 |
| rejectedBy | String | 差戻者ID | 任意 |
| rejectionReason | String | 差戻理由 | 任意 |
| note | String | 備考 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 技術者ID（または一般ユーザーID）、年、月の組み合わせで一意
- 総工数時間は関連する工数明細から自動集計
- 承認済み（APPROVED）状態の工数シートは修正不可
- 差戻し（REJECTED）状態の場合、修正後に再提出可能
- 工数シートの総時間は、対応する月の勤怠シートの総労働時間と整合性が取れていること

### 1.4 TimesheetEntry（工数明細）

特定の案件・作業に対する工数を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 工数明細ID | 主キー、UUID形式 |
| timesheetId | String | 工数シートID | 必須、Timesheetのidと紐付け |
| date | Date | 日付 | 必須 |
| projectId | String | 案件ID | 条件付き必須、案件管理モジュールの案件IDと紐付け |
| taskId | String | タスクID | 任意 |
| taskType | TaskType | 作業種別 | 必須 |
| hours | Decimal | 工数時間 | 必須、0より大きい値 |
| billable | Boolean | 請求可否フラグ | 必須 |
| description | String | 作業内容 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 特定の工数シート内の日付、案件、タスクの組み合わせで一意
- 工数時間は0.25（15分）単位で入力
- 1日の合計工数は対応する勤怠の実労働時間を超えないこと
- 内部作業（TaskType.INTERNAL）の場合は案件IDは任意

### 1.5 WorkPattern（勤務形態）

勤務形態を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 勤務形態ID | 主キー |
| name | String | 勤務形態名 | 必須、一意 |
| regularStartTime | Time | 標準開始時間 | 必須 |
| regularEndTime | Time | 標準終了時間 | 必須 |
| regularBreakTime | Duration | 標準休憩時間 | 必須 |
| regularWorkHours | Decimal | 標準労働時間 | 必須 |
| flexibleTimeAllowed | Boolean | フレックスタイム許可 | 必須 |
| coreTimeStart | Time | コアタイム開始 | 条件付き必須（フレックスタイムの場合） |
| coreTimeEnd | Time | コアタイム終了 | 条件付き必須（フレックスタイムの場合） |
| overtimeThreshold | Decimal | 残業閾値 | 必須 |
| description | String | 説明 | 任意 |
| active | Boolean | 有効フラグ | 必須 |

**ビジネスルール**：
- 標準労働時間は（標準終了時間 - 標準開始時間 - 標準休憩時間）で計算
- フレックスタイム許可がtrueの場合、コアタイムの設定が必要
- 残業閾値は標準労働時間以上の値であること

### 1.6 LeaveRequest（休暇申請）

休暇の申請情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 休暇申請ID | 主キー、UUID形式 |
| userId | String | ユーザーID | 必須 |
| engineerId | String | 技術者ID | 条件付き必須（技術者の場合） |
| leaveType | LeaveType | 休暇種別 | 必須 |
| startDate | Date | 開始日 | 必須 |
| endDate | Date | 終了日 | 必須 |
| startHalf | Boolean | 初日半休フラグ | 任意 |
| endHalf | Boolean | 最終日半休フラグ | 任意 |
| reason | String | 理由 | 条件付き必須（種別による） |
| status | ApprovalStatus | 承認ステータス | 必須 |
| approvedAt | DateTime | 承認日時 | 任意 |
| approvedBy | String | 承認者ID | 任意 |
| rejectedAt | DateTime | 差戻日時 | 任意 |
| rejectedBy | String | 差戻者ID | 任意 |
| rejectionReason | String | 差戻理由 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 休暇日数は開始日と終了日から自動計算（半休を考慮）
- 有給休暇の場合、残有給日数を超える申請は不可
- 休暇申請が承認されると、対応する日の勤怠区分が自動的に更新される
- 特別休暇の場合、理由の入力が必須

### 1.7 ApprovalWorkflow（承認ワークフロー）

承認フローを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | ワークフローID | 主キー |
| targetType | ApprovalTargetType | 対象種別 | 必須 |
| organizationId | String | 組織ID | 必須 |
| name | String | ワークフロー名 | 必須 |
| description | String | 説明 | 任意 |
| active | Boolean | 有効フラグ | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 組織ごとに承認フローを設定可能
- 同じ組織、対象種別に複数の有効な承認フローが存在する場合、優先度の高いものが適用される

### 1.8 ApprovalStep（承認ステップ）

承認フローの各ステップを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | ステップID | 主キー |
| workflowId | String | ワークフローID | 必須、ApprovalWorkflowのidと紐付け |
| stepOrder | Integer | ステップ順序 | 必須、0以上 |
| approverType | ApproverType | 承認者タイプ | 必須 |
| approverId | String | 承認者ID | 条件付き必須 |
| approverRole | String | 承認者ロール | 条件付き必須 |
| autoApprove | Boolean | 自動承認フラグ | 必須 |
| autoApproveCondition | String | 自動承認条件 | 条件付き必須 |

**ビジネスルール**：
- 承認者タイプに応じて、承認者IDまたは承認者ロールのいずれかが必須
- 自動承認フラグがtrueの場合、自動承認条件の設定が必要
- 同一ワークフロー内のステップ順序は一意であること

## 2. 値オブジェクト定義

### 2.1 WorkTime（勤務時間）

勤務時間に関する値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| startTime | Time | 開始時間 |
| endTime | Time | 終了時間 |
| breakTime | Duration | 休憩時間 |
| actualHours | Decimal | 実労働時間 |

### 2.2 AttendanceSummary（勤怠集計）

一定期間の勤怠集計に関する値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| totalWorkDays | Integer | 総勤務日数 |
| totalWorkHours | Decimal | 総労働時間 |
| regularHours | Decimal | 所定内時間 |
| overtimeHours | Decimal | 残業時間 |
| holidayWorkHours | Decimal | 休日労働時間 |
| lateNightHours | Decimal | 深夜労働時間 |
| paidLeaveUsed | Decimal | 有給休暇使用日数 |
| specialLeaveUsed | Decimal | 特別休暇使用日数 |
| absenceDays | Integer | 欠勤日数 |

### 2.3 TimesheetSummary（工数集計）

一定期間の工数集計に関する値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| totalHours | Decimal | 総工数時間 |
| billableHours | Decimal | 請求可能時間 |
| nonBillableHours | Decimal | 請求不可時間 |
| projectHours | Map<String, Decimal> | 案件別工数 |
| taskTypeHours | Map<TaskType, Decimal> | 作業種別別工数 |
| utilizationRate | Decimal | 稼働率（%） |

### 2.4 ApprovalHistory（承認履歴）

承認に関する履歴情報を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| timestamp | DateTime | タイムスタンプ |
| actorId | String | 実行者ID |
| actorName | String | 実行者名 |
| action | ApprovalAction | 承認アクション |
| comment | String | コメント |

## 3. 列挙型定義

### 3.1 AttendanceType（勤怠区分）

```
enum AttendanceType {
    WORKDAY,              // 勤務日
    PAID_LEAVE,           // 有給休暇
    HALF_PAID_LEAVE,      // 半休
    SPECIAL_LEAVE,        // 特別休暇
    ABSENCE,              // 欠勤
    BUSINESS_TRIP,        // 出張
    REMOTE_WORK,          // リモートワーク
    HOLIDAY,              // 休日
    TRANSFER_HOLIDAY      // 振替休日
}
```

### 3.2 AttendanceStatus（勤怠ステータス）

```
enum AttendanceStatus {
    DRAFT,                // 下書き
    SUBMITTED,            // 提出済
    APPROVED,             // 承認済
    REJECTED,             // 差戻し
    LOCKED                // ロック済（修正不可）
}
```

### 3.3 SheetStatus（シートステータス）

```
enum SheetStatus {
    DRAFT,                // 下書き
    SUBMITTED,            // 提出済
    APPROVAL_IN_PROGRESS, // 承認中
    APPROVED,             // 承認済
    REJECTED,             // 差戻し
    LOCKED                // ロック済（修正不可）
}
```

### 3.4 TaskType（作業種別）

```
enum TaskType {
    DEVELOPMENT,          // 開発
    TESTING,              // テスト
    MEETING,              // 会議・打ち合わせ
    ANALYSIS,             // 分析・設計
    MAINTENANCE,          // 保守・運用
    DOCUMENTATION,        // ドキュメント作成
    TRAINING,             // 研修・学習
    INTERNAL,             // 内部業務
    SALES,                // 営業活動
    OTHER                 // その他
}
```

### 3.5 LeaveType（休暇種別）

```
enum LeaveType {
    PAID_LEAVE,           // 有給休暇
    HALF_PAID_LEAVE,      // 半休
    COMPENSATORY_LEAVE,   // 代休
    SICK_LEAVE,           // 病気休暇
    MATERNITY_LEAVE,      // 産前産後休暇
    CHILDCARE_LEAVE,      // 育児休暇
    NURSING_CARE_LEAVE,   // 介護休暇
    BEREAVEMENT_LEAVE,    // 忌引休暇
    SPECIAL_LEAVE,        // 特別休暇
    ABSENCE               // 欠勤
}
```

### 3.6 ApprovalStatus（承認ステータス）

```
enum ApprovalStatus {
    PENDING,              // 承認待ち
    IN_PROGRESS,          // 承認中
    APPROVED,             // 承認済
    REJECTED,             // 差戻し
    CANCELLED             // 取消
}
```

### 3.7 ApprovalTargetType（承認対象種別）

```
enum ApprovalTargetType {
    ATTENDANCE_SHEET,     // 勤怠シート
    TIMESHEET,            // 工数シート
    LEAVE_REQUEST,        // 休暇申請
    EXPENSE_CLAIM         // 経費申請
}
```

### 3.8 ApproverType（承認者タイプ）

```
enum ApproverType {
    SPECIFIC_USER,        // 特定ユーザー
    ROLE_BASED,           // ロールベース
    DEPARTMENT_MANAGER,   // 部門管理者
    PROJECT_MANAGER,      // プロジェクトマネージャ
    SYSTEM                // システム（自動承認）
}
```

### 3.9 ApprovalAction（承認アクション）

```
enum ApprovalAction {
    SUBMIT,               // 提出
    APPROVE,              // 承認
    REJECT,               // 差戻し
    CANCEL,               // 取消
    DELEGATE,             // 委任
    AUTO_APPROVE          // 自動承認
}
```

## 4. ドメイン関連図

```
Attendance * --- 1 AttendanceSheet
AttendanceSheet 1 --- 1 User
Timesheet 1 --- * TimesheetEntry
Timesheet 1 --- 1 User
Timesheet 1 --- 1 AttendanceSheet
LeaveRequest * --- 1 User
LeaveRequest * --- * Attendance
ApprovalWorkflow 1 --- * ApprovalStep
AttendanceSheet * --- 1 ApprovalWorkflow
Timesheet * --- 1 ApprovalWorkflow
LeaveRequest * --- 1 ApprovalWorkflow
```

## 5. 重要なビジネスルール

### 5.1 勤怠入力ルール

- 勤務日の勤怠データは、出勤時間、退勤時間、休憩時間の入力が必須
- 1日の勤務時間は、所定労働時間未満の場合は警告を表示
- フレックスタイム制の場合、コアタイム内の勤務が必須
- 休日出勤の場合は承認者の事前承認が必要
- 月末締め後の勤怠データ修正には、特別な承認プロセスが必要

### 5.2 工数入力ルール

- 工数の合計は対応する日の実労働時間を超えてはならない
- 工数は0.25時間（15分）単位で入力
- 案件に紐づく工数（請求可能工数）と内部業務の工数（請求不可工数）を明確に区分
- 複数案件に従事する場合、案件ごとの工数配分が必要
- 月末締め後の工数データ修正には、特別な承認プロセスが必要

### 5.3 休暇管理ルール

- 有給休暇は付与された日数を超えて取得不可
- 休暇申請は原則として事前申請が必要
- 急な病欠などの事後申請は、速やかに申請と承認を行うこと
- 連続する長期休暇（5営業日以上）は、部門長の承認が必要
- 休暇取得状況は定期的にレポートし、有給休暇の計画的取得を促進

### 5.4 承認ワークフローのルール

- 勤怠シート、工数シートの承認は月次で行う
- 承認フローは組織構造や役割に基づいて設定可能
- 承認待ち状態が一定期間（3営業日）続く場合、自動リマインダーを送信
- 承認者が不在の場合、代理承認者を設定可能
- 組織変更や人事異動時には、承認フローを自動的に更新

### 5.5 データ整合性ルール

- 月次勤怠シートの総労働時間と月次工数シートの総工数時間の差異は許容範囲内（±1時間）であること
- 工数シートの請求可能工数は、対応する案件の契約条件と整合していること
- 月次データの締め後は、前月データの修正には特別な承認が必要
- 年度締め後のデータは原則として修正不可（監査証跡を残した上での例外処理のみ許可）