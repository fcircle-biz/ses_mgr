# 勤怠管理機能

## 1. 機能概要

勤怠管理機能は、技術者および社内スタッフの日々の勤怠情報を記録・管理するための機能を提供します。出退勤時間の登録、休暇の申請・管理、勤怠データの集計・検索、月次の勤怠シート管理などを通じて、適切な勤怠管理と労務管理を支援します。

## 2. 処理フロー

### 2.1 日次勤怠登録フロー

1. ユーザーが勤怠登録画面を開く
2. システムが当日または指定日の勤怠情報を確認
   - 既存データがある場合は表示
   - ない場合は新規登録モードで表示
3. ユーザーが勤怠情報（出勤時間、退勤時間、休憩時間、勤怠区分等）を入力
4. 入力データのバリデーション
   - 必須項目チェック
   - 時間の論理チェック（出勤 < 退勤など）
   - 勤務形態に基づく制約チェック
5. 労働時間の自動計算
   - 実労働時間 = 退勤時間 - 出勤時間 - 休憩時間
   - 残業時間、深夜時間、休日労働時間の算出
6. 勤怠データの保存
7. 工数入力画面への連携（オプション）

### 2.2 月次勤怠提出フロー

1. ユーザーが月次勤怠一覧画面を開く
2. システムが指定月の全勤怠データを表示
3. ユーザーが未入力日の勤怠を補完
4. システムが月次集計データを表示
   - 総勤務日数
   - 総労働時間
   - 残業時間
   - 休暇取得状況等
5. 勤怠データのバリデーション
   - 必須日の入力確認
   - 勤務パターンとの整合性確認
   - 月次トータルの妥当性確認
6. ユーザーが月次勤怠を提出
7. 承認ワークフローの開始

### 2.3 休暇申請フロー

1. ユーザーが休暇申請画面を開く
2. システムが休暇残日数を表示
3. ユーザーが休暇情報を入力
   - 休暇種別
   - 開始日・終了日
   - 半休フラグ
   - 理由等
4. 入力データのバリデーション
   - 休暇取得可能性チェック
   - 日付の妥当性チェック
   - 必須項目チェック
5. 休暇日数の自動計算（半休考慮）
6. 休暇申請の登録
7. 承認者への通知
8. 承認後、対象日の勤怠情報を自動更新

### 2.4 勤怠データ修正フロー

1. ユーザーが修正対象の勤怠データを選択
2. システムが現在のデータを表示
3. 修正可能性チェック
   - 月次締め前かどうか
   - 承認状態
   - 修正権限
4. ユーザーがデータを修正
5. 修正データのバリデーション
6. 修正理由の入力（必要に応じて）
7. 修正データの保存
8. 修正履歴の記録
9. 必要に応じて承認者に通知

### 2.5 勤怠データインポートフロー

1. 管理者が勤怠データインポート機能を選択
2. システムがインポートフォーマットを提示
3. 管理者がインポートファイルをアップロード
4. システムがファイル形式をチェック
5. インポートデータのバリデーション
   - 必須項目チェック
   - 日付・時間フォーマットチェック
   - ユーザー存在確認
6. 重複チェック（既存データとの比較）
7. インポート結果のプレビュー表示
8. 管理者が確認し、インポート実行
9. インポート結果のレポート表示

## 3. 主要コンポーネント構成

### 3.1 AttendanceService

勤怠情報の基本操作を提供するサービスコンポーネントです。

```java
class AttendanceServiceImpl implements AttendanceService {
    private AttendanceRepository attendanceRepository;
    private AttendanceSheetRepository attendanceSheetRepository;
    private LeaveRequestRepository leaveRequestRepository;
    private WorkPatternRepository workPatternRepository;
    private NotificationService notificationService;
    private AuthorizationService authorizationService;
    private CalendarService calendarService;
    
    @Override
    public Attendance createAttendance(AttendanceCreateRequest request) {
        // 勤怠データの作成ロジック
    }
    
    @Override
    public Attendance updateAttendance(String attendanceId, AttendanceUpdateRequest request) {
        // 勤怠データの更新ロジック
    }
    
    @Override
    public Attendance getAttendance(String attendanceId) {
        // 勤怠データの取得ロジック
    }
    
    @Override
    public Attendance getAttendanceByDate(String userId, LocalDate date) {
        // 日付指定での勤怠データ取得ロジック
    }
    
    @Override
    public Page<Attendance> searchAttendances(AttendanceSearchRequest request, Pageable pageable) {
        // 勤怠データの検索ロジック
    }
    
    @Override
    public AttendanceSheet createAttendanceSheet(AttendanceSheetCreateRequest request) {
        // 勤怠シート作成ロジック
    }
    
    @Override
    public AttendanceSheet submitAttendanceSheet(String sheetId, String comment) {
        // 勤怠シート提出ロジック
    }
    
    @Override
    public LeaveRequest createLeaveRequest(LeaveRequestCreateRequest request) {
        // 休暇申請作成ロジック
    }
    
    // その他のメソッド実装
}
```

### 3.2 AttendanceRepository

勤怠データの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface AttendanceRepository {
    Attendance save(Attendance attendance);
    Optional<Attendance> findById(String id);
    Optional<Attendance> findByUserIdAndDate(String userId, LocalDate date);
    List<Attendance> findByUserIdAndDateBetween(String userId, LocalDate startDate, LocalDate endDate);
    Page<Attendance> findAll(Specification<Attendance> spec, Pageable pageable);
    List<Attendance> findByAttendanceTypeIn(List<AttendanceType> attendanceTypes);
    List<Attendance> findByStatusAndDateBefore(AttendanceStatus status, LocalDate date);
    long countByUserIdAndAttendanceTypeAndDateBetween(String userId, AttendanceType type, LocalDate startDate, LocalDate endDate);
}
```

### 3.3 AttendanceSheetRepository

勤怠シートの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface AttendanceSheetRepository {
    AttendanceSheet save(AttendanceSheet attendanceSheet);
    Optional<AttendanceSheet> findById(String id);
    Optional<AttendanceSheet> findByUserIdAndYearAndMonth(String userId, int year, int month);
    List<AttendanceSheet> findByStatusAndYearAndMonth(SheetStatus status, int year, int month);
    List<AttendanceSheet> findByStatus(SheetStatus status);
    List<AttendanceSheet> findByUserIdAndStatusIn(String userId, List<SheetStatus> statuses);
}
```

### 3.4 LeaveRequestRepository

休暇申請の永続化と検索を担当するリポジトリコンポーネントです。

```java
interface LeaveRequestRepository {
    LeaveRequest save(LeaveRequest leaveRequest);
    Optional<LeaveRequest> findById(String id);
    List<LeaveRequest> findByUserId(String userId);
    List<LeaveRequest> findByUserIdAndStatus(String userId, ApprovalStatus status);
    List<LeaveRequest> findByUserIdAndLeaveTypeAndStartDateBetween(String userId, LeaveType leaveType, LocalDate startDate, LocalDate endDate);
    List<LeaveRequest> findByStartDateBetweenOrEndDateBetween(LocalDate startDate1, LocalDate endDate1, LocalDate startDate2, LocalDate endDate2);
}
```

### 3.5 WorkPatternRepository

勤務形態の永続化と検索を担当するリポジトリコンポーネントです。

```java
interface WorkPatternRepository {
    WorkPattern save(WorkPattern workPattern);
    Optional<WorkPattern> findById(String id);
    List<WorkPattern> findByActive(boolean active);
    Optional<WorkPattern> findByName(String name);
}
```

### 3.6 AttendanceCalculator

勤怠時間の計算を担当するコンポーネントです。

```java
class AttendanceCalculator {
    private CalendarService calendarService;
    
    public WorkTime calculateWorkTime(LocalDateTime startTime, LocalDateTime endTime, Duration breakTime, WorkPattern workPattern) {
        // 実労働時間計算ロジック
        return workTime;
    }
    
    public OvertimeResult calculateOvertime(LocalDateTime startTime, LocalDateTime endTime, Duration breakTime, WorkPattern workPattern, LocalDate date) {
        // 残業時間計算ロジック
        return overtimeResult;
    }
    
    public Duration calculateLateNightHours(LocalDateTime startTime, LocalDateTime endTime) {
        // 深夜時間計算ロジック
        return lateNightHours;
    }
    
    public BigDecimal calculateLeaveUsage(LocalDate startDate, LocalDate endDate, boolean startHalf, boolean endHalf) {
        // 休暇日数計算ロジック
        return leaveUsage;
    }
    
    // その他の計算メソッド
}
```

### 3.7 AttendanceValidator

勤怠データのバリデーションを担当するコンポーネントです。

```java
class AttendanceValidator {
    private CalendarService calendarService;
    private WorkPatternRepository workPatternRepository;
    
    public ValidationResult validateForCreation(AttendanceCreateRequest request) {
        // 勤怠作成時のバリデーションロジック
        return validationResult;
    }
    
    public ValidationResult validateForUpdate(Attendance attendance, AttendanceUpdateRequest request) {
        // 勤怠更新時のバリデーションロジック
        return validationResult;
    }
    
    public ValidationResult validateAttendanceSheet(String userId, int year, int month) {
        // 勤怠シートのバリデーションロジック
        return validationResult;
    }
    
    public ValidationResult validateLeaveRequest(LeaveRequestCreateRequest request) {
        // 休暇申請のバリデーションロジック
        return validationResult;
    }
}
```

### 3.8 AttendanceImporter

外部システムからの勤怠データインポートを担当するコンポーネントです。

```java
class AttendanceImporter {
    private AttendanceRepository attendanceRepository;
    private UserService userService;
    private WorkPatternRepository workPatternRepository;
    private AttendanceValidator attendanceValidator;
    
    public ImportResult importAttendances(InputStream inputStream, String format) {
        // インポートロジック
        return importResult;
    }
    
    public List<AttendanceImportError> validateImportData(List<AttendanceImportItem> items) {
        // インポートデータのバリデーションロジック
        return errors;
    }
    
    public ImportPreview previewImport(List<AttendanceImportItem> items) {
        // インポートプレビュー生成ロジック
        return preview;
    }
}
```

## 4. 例外処理

### 4.1 AttendanceNotFoundException

指定された勤怠IDが存在しない場合に発生する例外です。

```java
class AttendanceNotFoundException extends ResourceNotFoundException {
    private String attendanceId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 AttendanceSheetNotFoundException

指定された勤怠シートIDが存在しない場合に発生する例外です。

```java
class AttendanceSheetNotFoundException extends ResourceNotFoundException {
    private String sheetId;
    
    // コンストラクタ、getterなど
}
```

### 4.3 AttendanceValidationException

勤怠データのバリデーションエラーが発生した場合の例外です。

```java
class AttendanceValidationException extends ValidationException {
    private Map<String, String> validationErrors;
    
    // コンストラクタ、getterなど
}
```

### 4.4 LeaveBalanceInsufficientException

休暇残日数が不足している場合に発生する例外です。

```java
class LeaveBalanceInsufficientException extends BusinessRuleException {
    private String userId;
    private LeaveType leaveType;
    private BigDecimal requested;
    private BigDecimal available;
    
    // コンストラクタ、getterなど
}
```

### 4.5 AttendanceAlreadyExistsException

同一ユーザー・日付の勤怠データが既に存在する場合に発生する例外です。

```java
class AttendanceAlreadyExistsException extends BusinessRuleException {
    private String userId;
    private LocalDate date;
    
    // コンストラクタ、getterなど
}
```

### 4.6 AttendanceStateException

勤怠データが特定の操作を行うのに適切な状態でない場合に発生する例外です。

```java
class AttendanceStateException extends BusinessRuleException {
    private String attendanceId;
    private AttendanceStatus currentStatus;
    private String operation;
    
    // コンストラクタ、getterなど
}
```

## 5. 勤怠入力画面の主要機能

### 5.1 日次勤怠入力

日々の勤怠情報を入力するための画面で、以下の機能を提供します:

- 日付選択（カレンダーからの選択）
- 勤怠区分選択（勤務日、休暇、出張など）
- 出退勤時間入力（時刻ピッカー）
- 休憩時間入力
- 勤務形態選択
- 備考欄入力
- リアルタイム労働時間計算表示
- 残業時間・深夜時間の自動計算表示
- 保存・キャンセルボタン

### 5.2 月次勤怠カレンダー

月単位で勤怠状況を確認・編集するためのカレンダー形式の画面です:

- 月単位のカレンダー表示
- 日ごとの勤怠状況の色分け表示（勤務、休暇、未入力など）
- 日ごとの労働時間表示
- 日付クリックによる詳細表示・編集
- 月次集計情報の表示
- 一括入力機能（同じパターンの一括適用）
- 月次提出ボタン
- 前月・翌月への移動ボタン

### 5.3 休暇申請機能

休暇を申請するための専用画面です:

- 休暇種別選択（有給、半休、特別休暇など）
- 日付範囲選択（開始日・終了日）
- 半休選択（午前・午後）
- 理由入力欄
- 休暇日数自動計算表示
- 残有給日数表示
- 申請ボタン
- 申請履歴表示

### 5.4 勤怠修正・承認機能

過去の勤怠データを修正し、承認するための機能です:

- 修正対象日の選択
- 修正前データの表示
- 修正理由入力欄
- 承認者向け修正一覧表示
- 一括承認機能
- 差戻し機能（コメント付き）
- 修正履歴表示

### 5.5 勤怠検索・フィルタ機能

特定条件に合致する勤怠データを検索・フィルタリングする機能です:

- 期間指定検索
- ユーザー/部門指定検索
- 勤怠区分によるフィルタリング
- 承認状態によるフィルタリング
- 特定条件（残業あり、休日出勤など）での絞り込み
- 検索結果のエクスポート機能

## 6. 勤務形態管理

システムで扱う主要な勤務形態とその設定です。

### 6.1 標準勤務形態

| 勤務形態 | 標準開始時間 | 標準終了時間 | 標準休憩時間 | 標準労働時間 | フレックス | 備考 |
|---------|------------|------------|------------|------------|---------|------|
| 通常勤務 | 9:00 | 18:00 | 1時間 | 8時間 | 不可 | 基本的な勤務形態 |
| フレックスタイム | - | - | 1時間 | 8時間 | 可能 | コアタイム10:00-15:00 |
| 時短勤務 | 9:00 | 16:00 | 1時間 | 6時間 | 不可 | 育児・介護等の理由 |
| 交代制 | 8:00/16:00 | 17:00/24:00 | 1時間 | 8時間 | 不可 | シフト制 |
| 裁量労働 | - | - | - | 8時間 | - | 成果ベースで評価 |

### 6.2 残業時間計算ルール

- 通常勤務: 標準労働時間（8時間）を超える時間を残業として計算
- フレックスタイム: 月間の総労働時間が所定労働時間を超える部分を残業として計算
- 時短勤務: 時短分の標準労働時間（6時間）を超え、かつ通常の標準労働時間（8時間）以内の時間は通常残業、8時間を超える時間は深夜残業として計算
- 交代制: シフトごとに定められた労働時間を超える時間を残業として計算

### 6.3 深夜時間計算ルール

- 22:00から翌5:00までの労働時間を深夜時間として計算
- 深夜時間の残業には割増係数を適用
- 深夜のみの勤務は全時間に深夜係数を適用

### 6.4 休日労働計算ルール

- 会社カレンダーで休日に設定されている日の労働を休日労働として計算
- 法定休日（日曜日）の労働には特別な割増係数を適用
- 休日労働に対する代休取得ルールを適用

## 7. 休暇管理

システムで扱う主要な休暇種別とその管理ルールです。

### 7.1 休暇種別一覧

| 休暇種別 | 説明 | 付与ルール | 取得単位 | 事前申請 | 
|---------|------|------------|---------|---------|
| 有給休暇 | 年次有給休暇 | 法定による | 1日/半日 | 原則必要 |
| 代休 | 休日労働の振替 | 休日労働に応じて | 1日 | 必要 |
| 特別休暇 | 慶弔、災害等 | 事由に応じて | 1日 | 事後可 |
| 病気休暇 | 傷病による休暇 | 規定による | 1日 | 事後可 |
| 育児休暇 | 育児による休暇 | 法定による | 1日 | 必要 |
| 介護休暇 | 介護による休暇 | 法定による | 1日/時間 | 必要 |

### 7.2 有給休暇付与ルール

- 入社6ヶ月経過後に10日付与
- 以後、勤続年数に応じて付与日数を増加
- 付与日から2年間有効
- 時季指定による計画的取得の促進
- 半日単位での取得も可能

### 7.3 休暇取得時の勤怠処理

- 有給休暇取得日は勤怠区分を「PAID_LEAVE」に設定
- 半休取得日は「HALF_PAID_LEAVE」に設定し、出勤時間も記録
- 特別休暇は「SPECIAL_LEAVE」に設定し、事由も記録
- 休暇取得による工数への影響を管理（工数入力不要に設定）

### 7.4 休暇残日数管理

- ユーザーごとの休暇残日数をデータベースで管理
- 休暇申請・承認時に残日数を自動的に更新
- 残日数不足の場合は申請不可
- 月次・年次での取得状況レポート生成

## 8. 勤怠データインポート・エクスポート

外部システムとのデータ連携に関する仕様です。

### 8.1 インポート対応フォーマット

- CSV形式
- Excel形式（.xlsx）
- JSON形式
- 外部打刻システム専用形式

### 8.2 インポート処理の流れ

1. インポートファイルの選択
2. ファイル形式の検証
3. ヘッダー情報の確認
4. データマッピング設定
5. データの検証
   - 必須項目の確認
   - 日付・時刻形式の確認
   - ユーザーIDの存在確認
6. 重複データの処理方針選択
   - 上書き
   - スキップ
   - エラー報告
7. インポートプレビュー表示
8. インポート実行
9. 結果レポート表示

### 8.3 エクスポート対応フォーマット

- CSV形式
- Excel形式（.xlsx）
- PDF形式（帳票用）
- JSON形式（API連携用）

### 8.4 エクスポート項目カスタマイズ

- 基本項目（日付、ユーザー情報、勤怠区分、時間情報）
- 集計項目（労働時間、残業時間、深夜時間）
- 承認情報（ステータス、承認者、日時）
- カスタム項目（任意の追加情報）