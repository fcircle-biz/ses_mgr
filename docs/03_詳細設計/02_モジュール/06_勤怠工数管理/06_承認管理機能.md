# 承認管理機能

## 1. 機能概要

承認管理機能は、勤怠シート、工数シート、休暇申請などのワークフローを管理し、適切な承認プロセスを実現するための機能を提供します。組織階層やプロジェクト構造に基づく承認者の自動設定、複数承認者によるステップ承認、代理承認、一括承認などの機能を通じて、効率的かつ透明性の高い承認プロセスを実現します。

## 2. 処理フロー

### 2.1 勤怠シート承認フロー

1. ユーザーが月次勤怠シートを提出
2. システムが承認ワークフローを特定
   - 組織情報に基づく承認フロー選択
   - 承認ステップの設定
3. 最初の承認者への通知送信
4. 承認者が承認画面にアクセス
5. 勤怠データの確認
   - 全体サマリーの確認
   - 日別データの確認
   - 異常値のチェック
6. 承認処理の実行
   - 承認または差戻し
   - コメント入力
7. 次の承認ステップの処理
   - 次の承認者への通知送信
   - または全承認完了処理
8. 最終承認完了時の処理
   - 勤怠シートのステータス更新（APPROVED）
   - 申請者への通知
   - 関連システムへのデータ連携

### 2.2 工数シート承認フロー

1. ユーザーが月次工数シートを提出
2. システムが承認ワークフローを特定
   - プロジェクト情報に基づく承認フロー選択
   - 承認ステップの設定
3. 最初の承認者（プロジェクトマネージャ）への通知送信
4. 承認者が承認画面にアクセス
5. 工数データの確認
   - 案件別工数の確認
   - 作業種別別工数の確認
   - 勤怠時間との整合性確認
6. 承認処理の実行
   - 承認または差戻し
   - コメント入力
7. 次の承認ステップの処理
   - 次の承認者への通知送信
   - または全承認完了処理
8. 最終承認完了時の処理
   - 工数シートのステータス更新（APPROVED）
   - 申請者への通知
   - 請求処理への工数データ連携

### 2.3 休暇申請承認フロー

1. ユーザーが休暇申請を提出
2. システムが承認ワークフローを特定
   - 休暇種別に基づく承認フロー選択
   - 承認ステップの設定
3. 承認者（通常は直属上長）への通知送信
4. 承認者が承認画面にアクセス
5. 休暇申請の確認
   - 申請内容の確認
   - 休暇残日数の確認
   - チーム全体の休暇予定との調整
6. 承認処理の実行
   - 承認または差戻し
   - コメント入力
7. 次の承認ステップの処理（必要な場合）
   - 次の承認者への通知送信
   - または全承認完了処理
8. 最終承認完了時の処理
   - 休暇申請のステータス更新（APPROVED）
   - 申請者への通知
   - 勤怠カレンダーへの反映

### 2.4 承認ワークフロー設定フロー

1. 管理者が承認ワークフロー設定画面にアクセス
2. 承認対象種別の選択（勤怠シート、工数シート、休暇申請など）
3. 適用組織の選択
4. 承認ステップの設定
   - ステップ数の設定
   - 各ステップの承認者タイプ設定（特定ユーザー、役割ベース、部門管理者など）
   - 承認者の選択または条件設定
   - 自動承認条件の設定（オプション）
5. ワークフロー名と説明の入力
6. 有効期間の設定
7. ワークフロー設定の保存
8. 既存ワークフローとの競合チェック
9. ワークフロー設定の有効化

### 2.5 代理承認者設定フロー

1. ユーザーまたは管理者が代理承認者設定画面にアクセス
2. 不在期間の設定
3. 承認権限種別の選択
   - 勤怠承認
   - 工数承認
   - 休暇承認
   - 全権限
4. 代理承認者の選択
5. 通知設定（代理承認者への通知要否）
6. 代理承認設定の保存
7. 関係者への通知（本人、代理承認者、管理者）

### 2.6 一括承認フロー

1. 承認者が一括承認画面にアクセス
2. 承認対象種別の選択
3. 一括承認対象の検索・フィルタリング
   - 期間指定
   - 部門・チーム指定
   - 承認ステータス指定
4. 承認対象一覧の表示
5. 承認対象の選択（全選択または個別選択）
6. 一括承認実行
   - 一括コメント入力（オプション）
   - 承認または差戻し
7. 承認処理結果の表示
8. 次承認者への通知送信
9. 申請者への通知送信

## 3. 主要コンポーネント構成

### 3.1 ApprovalService

承認処理の基本操作を提供するサービスコンポーネントです。

```java
class ApprovalServiceImpl implements ApprovalService {
    private AttendanceSheetRepository attendanceSheetRepository;
    private TimesheetRepository timesheetRepository;
    private LeaveRequestRepository leaveRequestRepository;
    private ApprovalWorkflowRepository workflowRepository;
    private ApprovalStepRepository stepRepository;
    private ApprovalHistoryRepository historyRepository;
    private NotificationService notificationService;
    private AuthorizationService authorizationService;
    private OrganizationService organizationService;
    
    @Override
    public AttendanceSheet approveAttendanceSheet(String sheetId, ApprovalRequest request) {
        // 勤怠シート承認ロジック
    }
    
    @Override
    public AttendanceSheet rejectAttendanceSheet(String sheetId, RejectionRequest request) {
        // 勤怠シート差戻しロジック
    }
    
    @Override
    public Timesheet approveTimesheet(String timesheetId, ApprovalRequest request) {
        // 工数シート承認ロジック
    }
    
    @Override
    public Timesheet rejectTimesheet(String timesheetId, RejectionRequest request) {
        // 工数シート差戻しロジック
    }
    
    @Override
    public LeaveRequest approveLeaveRequest(String requestId, ApprovalRequest request) {
        // 休暇申請承認ロジック
    }
    
    @Override
    public LeaveRequest rejectLeaveRequest(String requestId, RejectionRequest request) {
        // 休暇申請差戻しロジック
    }
    
    @Override
    public List<ApprovalWorkflow> getApprovalWorkflows(ApprovalTargetType targetType, String organizationId) {
        // 承認ワークフロー取得ロジック
    }
    
    @Override
    public List<ApprovalHistory> getApprovalHistory(String targetType, String targetId) {
        // 承認履歴取得ロジック
    }
    
    // その他のメソッド実装
}
```

### 3.2 ApprovalWorkflowRepository

承認ワークフローの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ApprovalWorkflowRepository {
    ApprovalWorkflow save(ApprovalWorkflow workflow);
    Optional<ApprovalWorkflow> findById(String id);
    List<ApprovalWorkflow> findByTargetType(ApprovalTargetType targetType);
    List<ApprovalWorkflow> findByTargetTypeAndOrganizationId(ApprovalTargetType targetType, String organizationId);
    List<ApprovalWorkflow> findByActiveTrue();
    Optional<ApprovalWorkflow> findTopByTargetTypeAndOrganizationIdAndActiveTrueOrderByPriorityDesc(ApprovalTargetType targetType, String organizationId);
}
```

### 3.3 ApprovalStepRepository

承認ステップの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ApprovalStepRepository {
    ApprovalStep save(ApprovalStep step);
    Optional<ApprovalStep> findById(String id);
    List<ApprovalStep> findByWorkflowId(String workflowId);
    List<ApprovalStep> findByWorkflowIdOrderByStepOrder(String workflowId);
    Optional<ApprovalStep> findByWorkflowIdAndStepOrder(String workflowId, int stepOrder);
}
```

### 3.4 ApprovalHistoryRepository

承認履歴の永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ApprovalHistoryRepository {
    ApprovalHistory save(ApprovalHistory history);
    List<ApprovalHistory> findByTargetTypeAndTargetId(String targetType, String targetId);
    List<ApprovalHistory> findByActorIdAndTimestampBetween(String actorId, LocalDateTime start, LocalDateTime end);
    List<ApprovalHistory> findByTargetTypeAndTargetIdOrderByTimestampDesc(String targetType, String targetId);
    long countByTargetTypeAndTargetIdAndAction(String targetType, String targetId, ApprovalAction action);
}
```

### 3.5 ApprovalProxyRepository

代理承認設定の永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ApprovalProxyRepository {
    ApprovalProxy save(ApprovalProxy proxy);
    Optional<ApprovalProxy> findById(String id);
    List<ApprovalProxy> findByUserIdAndActiveTrue(String userId);
    List<ApprovalProxy> findByProxyIdAndActiveTrue(String proxyId);
    List<ApprovalProxy> findByUserIdAndStartDateBeforeAndEndDateAfterAndActiveTrue(String userId, LocalDate currentDate, LocalDate currentDate);
    void deleteById(String id);
}
```

### 3.6 ApprovalWorkflowManager

承認ワークフローの管理を担当するコンポーネントです。

```java
class ApprovalWorkflowManager {
    private ApprovalWorkflowRepository workflowRepository;
    private ApprovalStepRepository stepRepository;
    private OrganizationService organizationService;
    
    public ApprovalWorkflow createWorkflow(ApprovalWorkflowCreateRequest request) {
        // ワークフロー作成ロジック
        return workflow;
    }
    
    public ApprovalWorkflow updateWorkflow(String workflowId, ApprovalWorkflowUpdateRequest request) {
        // ワークフロー更新ロジック
        return workflow;
    }
    
    public ApprovalWorkflow activateWorkflow(String workflowId) {
        // ワークフロー有効化ロジック
        return workflow;
    }
    
    public ApprovalWorkflow deactivateWorkflow(String workflowId) {
        // ワークフロー無効化ロジック
        return workflow;
    }
    
    public ApprovalWorkflow findApplicableWorkflow(ApprovalTargetType targetType, String organizationId) {
        // 適用可能なワークフロー検索ロジック
        return workflow;
    }
}
```

### 3.7 ApprovalExecutor

承認処理の実行を担当するコンポーネントです。

```java
class ApprovalExecutor {
    private ApprovalWorkflowManager workflowManager;
    private ApprovalHistoryRepository historyRepository;
    private ApprovalProxyRepository proxyRepository;
    private NotificationService notificationService;
    
    public <T> T executeApproval(String targetType, String targetId, String approverId, ApprovalRequest request) {
        // 承認実行ロジック
        return approvedTarget;
    }
    
    public <T> T executeRejection(String targetType, String targetId, String rejectorId, RejectionRequest request) {
        // 差戻し実行ロジック
        return rejectedTarget;
    }
    
    public boolean canApprove(String targetType, String targetId, String userId) {
        // 承認可能性確認ロジック
        return canApprove;
    }
    
    public List<ApproverInfo> getNextApprovers(String targetType, String targetId) {
        // 次の承認者取得ロジック
        return approvers;
    }
    
    public BulkApprovalResult executeBulkApproval(BulkApprovalRequest request) {
        // 一括承認実行ロジック
        return result;
    }
}
```

### 3.8 ApprovalProxyManager

代理承認の管理を担当するコンポーネントです。

```java
class ApprovalProxyManager {
    private ApprovalProxyRepository proxyRepository;
    private NotificationService notificationService;
    
    public ApprovalProxy createProxy(ApprovalProxyCreateRequest request) {
        // 代理承認設定作成ロジック
        return proxy;
    }
    
    public ApprovalProxy updateProxy(String proxyId, ApprovalProxyUpdateRequest request) {
        // 代理承認設定更新ロジック
        return proxy;
    }
    
    public void deleteProxy(String proxyId) {
        // 代理承認設定削除ロジック
    }
    
    public List<ApprovalProxy> findActiveProxies(String userId) {
        // 有効な代理承認設定検索ロジック
        return proxies;
    }
    
    public String findActualApproverId(String userId, ApprovalTargetType targetType) {
        // 実際の承認者ID取得ロジック（代理設定考慮）
        return actualApproverId;
    }
}
```

## 4. 例外処理

### 4.1 ApprovalWorkflowNotFoundException

指定された承認ワークフローIDが存在しない場合に発生する例外です。

```java
class ApprovalWorkflowNotFoundException extends ResourceNotFoundException {
    private String workflowId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 ApprovalStepNotFoundException

指定された承認ステップIDが存在しない場合に発生する例外です。

```java
class ApprovalStepNotFoundException extends ResourceNotFoundException {
    private String stepId;
    
    // コンストラクタ、getterなど
}
```

### 4.3 NoApplicableWorkflowException

適用可能な承認ワークフローが見つからない場合に発生する例外です。

```java
class NoApplicableWorkflowException extends BusinessRuleException {
    private ApprovalTargetType targetType;
    private String organizationId;
    
    // コンストラクタ、getterなど
}
```

### 4.4 UnauthorizedApprovalException

承認権限がないユーザーが承認を試みた場合に発生する例外です。

```java
class UnauthorizedApprovalException extends AccessDeniedException {
    private String userId;
    private String targetType;
    private String targetId;
    
    // コンストラクタ、getterなど
}
```

### 4.5 InvalidApprovalStateException

承認対象が適切な状態でない場合に発生する例外です。

```java
class InvalidApprovalStateException extends BusinessRuleException {
    private String targetType;
    private String targetId;
    private String currentState;
    private String expectedState;
    
    // コンストラクタ、getterなど
}
```

### 4.6 ApprovalWorkflowConflictException

承認ワークフロー設定で競合が発生した場合の例外です。

```java
class ApprovalWorkflowConflictException extends BusinessRuleException {
    private ApprovalTargetType targetType;
    private String organizationId;
    private List<String> conflictingWorkflowIds;
    
    // コンストラクタ、getterなど
}
```

## 5. 承認画面の主要機能

### 5.1 承認一覧画面

承認者が自分に割り当てられた承認タスクを確認するための画面です:

- 承認待ちタスク一覧表示
  - 承認種別（勤怠、工数、休暇など）
  - 申請者名
  - 申請日時
  - 対象期間・日付
  - 承認期限
- 承認タスクのフィルタリング
  - 承認種別によるフィルタ
  - 申請者によるフィルタ
  - 期間によるフィルタ
  - 緊急度によるフィルタ
- 承認タスクのソート
  - 申請日時順
  - 承認期限順
  - 緊急度順
- 一括承認機能
  - 複数タスクの選択
  - 一括承認・差戻し
- 承認履歴表示機能
  - 過去の承認実績表示
  - 承認結果の検索

### 5.2 勤怠承認詳細画面

勤怠シートの承認を行うための詳細画面です:

- 勤怠サマリー表示
  - 総勤務日数
  - 総労働時間
  - 残業時間
  - 休暇取得状況
- 日別勤怠詳細表示
  - カレンダー形式での表示
  - 異常値のハイライト表示
- 過去データとの比較表示
  - 前月比
  - 前年同月比
- コメント入力欄
- 承認・差戻しボタン
- 差戻し理由入力欄（差戻し時）
- 前月勤怠データ参照リンク

### 5.3 工数承認詳細画面

工数シートの承認を行うための詳細画面です:

- 工数サマリー表示
  - 案件別工数集計
  - 作業種別別工数集計
  - 請求可能/不可の内訳
- 日別工数詳細表示
  - 案件×日付のマトリクス表示
  - 異常値のハイライト表示
- 勤怠データとの整合性表示
  - 勤怠時間と工数合計の比較
  - 不整合箇所のハイライト表示
- プロジェクト計画との比較表示
  - 計画工数との差異表示
  - 消化率・進捗率の表示
- コメント入力欄
- 承認・差戻しボタン
- 差戻し理由入力欄（差戻し時）
- 関連プロジェクト情報参照リンク

### 5.4 休暇承認詳細画面

休暇申請の承認を行うための詳細画面です:

- 休暇申請詳細表示
  - 申請者情報
  - 休暇種別
  - 期間・日数
  - 申請理由
- 休暇残日数表示
  - 有給休暇残日数
  - 特別休暇残日数
- チーム全体の休暇予定表示
  - カレンダー形式での表示
  - 重複確認機能
- 過去の休暇取得履歴表示
- コメント入力欄
- 承認・差戻しボタン
- 差戻し理由入力欄（差戻し時）
- 代替者の設定機能（必要な場合）

### 5.5 承認ワークフロー設定画面

承認ワークフローを設定するための管理画面です:

- ワークフロー一覧表示
  - 承認対象種別
  - 適用組織
  - ステップ数
  - 有効状態
- 新規ワークフロー作成機能
  - 承認対象種別選択
  - 適用組織選択
  - ワークフロー名入力
  - 説明文入力
  - 有効期間設定
- ステップ設定機能
  - ステップ追加・削除
  - ステップ順序変更
  - 承認者タイプ選択
  - 承認者設定
  - 自動承認条件設定
- ワークフロー有効化・無効化機能
- ワークフロー複製機能
- テスト実行機能
- 競合チェック機能

### 5.6 代理承認設定画面

代理承認者を設定するための画面です:

- 代理設定一覧表示
  - 本人名
  - 代理承認者名
  - 権限種別
  - 有効期間
  - 状態
- 新規代理設定作成機能
  - 本人選択（管理者の場合）
  - 代理承認者選択
  - 権限種別選択
  - 有効期間設定
  - 通知設定
- 代理設定編集機能
- 代理設定有効化・無効化機能
- 代理履歴表示機能
  - 代理承認実績の履歴表示
  - 実行者と本来の承認者の表示

## 6. 承認ワークフローの種類と設定

### 6.1 組織階層ベースの承認ワークフロー

組織構造に基づく標準的な承認ワークフローです。

**例：勤怠承認ワークフロー**

| ステップ | 承認者タイプ | 説明 |
|---------|------------|------|
| 1 | 直属上長 | 申請者の直属上長による一次承認 |
| 2 | 部門管理者 | 部門の管理者による二次承認 |

**例：長期休暇承認ワークフロー**

| ステップ | 承認者タイプ | 説明 |
|---------|------------|------|
| 1 | 直属上長 | 申請者の直属上長による一次承認 |
| 2 | 部門管理者 | 部門の管理者による二次承認 |
| 3 | 人事担当者 | 人事部門による最終承認 |

### 6.2 プロジェクトベースの承認ワークフロー

プロジェクト構造に基づく承認ワークフローです。

**例：工数承認ワークフロー**

| ステップ | 承認者タイプ | 説明 |
|---------|------------|------|
| 1 | プロジェクトマネージャ | プロジェクトマネージャによる工数確認 |
| 2 | 部門管理者 | 技術者の所属部門管理者による確認 |

**例：大規模プロジェクト工数承認ワークフロー**

| ステップ | 承認者タイプ | 説明 |
|---------|------------|------|
| 1 | チームリーダー | チームリーダーによる一次確認 |
| 2 | プロジェクトマネージャ | プロジェクトマネージャによる二次確認 |
| 3 | プロジェクトディレクター | プロジェクトディレクターによる最終承認 |

### 6.3 金額・条件ベースの承認ワークフロー

金額や特定条件に基づき、承認ルートが変わるワークフローです。

**例：残業申請承認ワークフロー**

| 条件 | ステップ | 承認者タイプ |
|-----|---------|------------|
| 20時間以下 | 1 | 直属上長 |
| 20時間超 | 1<br>2 | 直属上長<br>部門長 |
| 40時間超 | 1<br>2<br>3 | 直属上長<br>部門長<br>役員 |

**例：休日出勤承認ワークフロー**

| 条件 | ステップ | 承認者タイプ |
|-----|---------|------------|
| 平日 | 1 | 直属上長 |
| 休日 | 1<br>2 | 直属上長<br>部門長 |
| 祝日 | 1<br>2<br>3 | 直属上長<br>部門長<br>役員 |

### 6.4 自動承認ルール

特定条件を満たす場合に自動的に承認されるルールです。

**例：勤怠自動承認ルール**

| 条件 | 自動承認 |
|-----|---------|
| 残業なし、休日出勤なし | 自動承認 |
| 標準パターンどおりの勤務 | 自動承認 |
| 過去3ヶ月間で修正履歴なし | 直属上長の承認のみで完了 |

**例：工数自動承認ルール**

| 条件 | 自動承認 |
|-----|---------|
| 計画工数との差異5%以内 | プロジェクトマネージャの承認のみで完了 |
| テレワーク対象の内部プロジェクト | 自動承認 |
| 勤怠との整合性100% | チームリーダーの承認のみで完了 |

## 7. 通知管理

### 7.1 承認依頼通知

承認者への承認依頼通知に関する設定です。

| 通知種別 | タイミング | 通知先 | 通知方法 | 内容 |
|---------|-----------|-------|---------|------|
| 新規承認依頼 | 申請提出直後 | 承認者 | システム内通知<br>メール通知 | 承認が必要なことの通知<br>申請者・申請種別・期限の情報 |
| 承認リマインダー | 未処理3営業日後 | 承認者 | システム内通知<br>メール通知 | 未処理の承認がある旨の通知<br>申請一覧と期限情報 |
| 緊急承認依頼 | 期限1営業日前 | 承認者 | システム内通知<br>メール通知<br>SMSなど | 緊急性の高い承認依頼の通知<br>期限切れ間近の警告 |
| 代理承認依頼 | 本人不在時 | 代理承認者 | システム内通知<br>メール通知 | 代理承認の依頼通知<br>本人と代理期間の情報 |

### 7.2 承認結果通知

申請者への承認結果通知に関する設定です。

| 通知種別 | タイミング | 通知先 | 通知方法 | 内容 |
|---------|-----------|-------|---------|------|
| 承認完了通知 | 全承認完了時 | 申請者 | システム内通知<br>メール通知 | 申請が承認された旨の通知<br>承認者・承認日時の情報 |
| 差戻し通知 | 差戻し時 | 申請者 | システム内通知<br>メール通知 | 申請が差し戻された旨の通知<br>差戻し理由とコメント |
| 承認進捗通知 | 承認ステップ完了時 | 申請者 | システム内通知 | 承認プロセスの進捗状況<br>次のステップ情報 |
| 自動承認通知 | 自動承認発生時 | 申請者<br>管理者 | システム内通知 | 自動承認された旨の通知<br>自動承認条件の情報 |

### 7.3 管理者向け通知

管理者への通知に関する設定です。

| 通知種別 | タイミング | 通知先 | 通知方法 | 内容 |
|---------|-----------|-------|---------|------|
| 承認滞留通知 | 5営業日以上未処理 | 管理者 | システム内通知<br>メール通知 | 滞留している承認の一覧<br>承認者・経過日数の情報 |
| 月次締め遅延通知 | 締め日を過ぎても未承認 | 管理者<br>経理担当 | システム内通知<br>メール通知 | 未承認の申請一覧<br>影響範囲の情報 |
| 異常パターン検出通知 | 通常と異なる承認パターン検出時 | 管理者 | システム内通知 | 検出された異常パターンの情報<br>確認依頼 |
| 代理承認実行通知 | 代理承認実行時 | 管理者<br>本人 | システム内通知 | 代理承認が行われた旨の通知<br>代理承認者と対象の情報 |

## 8. レポート機能

### 8.1 承認状況レポート

承認業務の状況を把握するためのレポートです。

- **月次承認状況レポート**
  - 部門別の申請数・承認数
  - 平均承認期間
  - 差戻し率・理由分析
  - 滞留案件の一覧

- **承認者別業務量レポート**
  - 承認者ごとの承認件数
  - 平均処理時間
  - 滞留件数
  - 代理承認件数

- **承認効率性レポート**
  - 承認プロセスの所要時間分析
  - ボトルネック分析
  - 自動承認率
  - 承認フローの最適化提案

### 8.2 監査・コンプライアンスレポート

監査やコンプライアンス確認のためのレポートです。

- **承認監査レポート**
  - 承認ルールの例外適用状況
  - 権限外承認の検出
  - 承認バイパスの検出
  - 異常な承認パターンの検出

- **コンプライアンスチェックレポート**
  - 労働時間関連の承認状況
  - 休日・深夜労働の承認状況
  - 有給休暇取得促進状況
  - 月間残業時間の承認状況

- **承認履歴追跡レポート**
  - 特定申請の承認履歴詳細
  - 承認プロセス全体の可視化
  - コメント・差戻し理由の履歴
  - 承認状態変更の追跡