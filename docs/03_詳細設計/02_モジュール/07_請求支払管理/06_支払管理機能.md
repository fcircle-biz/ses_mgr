# 支払管理機能

本ドキュメントでは、請求支払管理モジュールの支払管理機能の詳細設計を記述します。支払管理機能は、技術者への報酬支払いを管理するための機能群です。

## 1. 概要

支払管理機能は、技術者への支払情報の作成、管理、支払処理を行うための機能です。契約条件や勤怠情報に基づいて支払データを生成し、支払処理の管理とステータス追跡を行います。

### 1.1 主要機能

- 支払情報の作成・更新・削除
- 支払情報の検索・照会
- 支払ステータス管理（予定、確定、支払済み等）
- 勤怠データに基づく支払データの自動生成
- 契約情報に基づく支払条件の設定
- 支払データのエクスポート
- 支払履歴の管理

### 1.2 処理フロー概要

1. 支払情報作成
   - 手動作成：ユーザーによる入力で支払情報を作成
   - 自動生成：月次の勤怠データから支払情報を自動生成

2. 支払情報編集・確認
   - 支払内容の確認
   - 必要に応じた編集

3. 支払確定
   - 支払内容を確定し、編集不可状態に変更
   - 支払番号の採番

4. 支払実行
   - 支払処理の実行
   - 支払日、参照番号の記録

5. 支払取消
   - 必要に応じて支払情報の取消処理

## 2. 機能詳細設計

### 2.1 支払情報管理

#### 2.1.1 支払情報作成機能

**概要**

技術者への支払情報を新規作成する機能です。手動での作成と勤怠データからの自動生成の2つの方法をサポートします。

**処理フロー（手動作成）**

1. ユーザーが支払作成画面にアクセス
2. 技術者の選択
3. 支払期間（年月）の指定
4. 支払予定日の設定
5. 支払金額の入力
6. 支払明細の入力
   - 明細項目名
   - 金額
   - 対象期間
   - 関連契約
7. 支払方法の設定
   - 支払方法種別
   - 銀行口座情報
8. 支払条件の設定
   - 計算方法
   - 源泉徴収税率
   - 控除情報
9. 支払データの保存

**バリデーションルール**

- 技術者は必須
- 支払予定日は必須、現在日以降
- 支払金額は0より大きい値
- 支払明細は最低1件必須
- 支払方法の必須項目（銀行振込の場合は口座情報等）

**エラー処理**

- 技術者が存在しない場合：ResourceNotFoundException
- 支払明細の値が不正な場合：IllegalArgumentException
- 支払金額計算時のエラー：BusinessException

#### 2.1.2 勤怠データからの支払情報自動生成機能

**概要**

月次の勤怠データを元に、技術者毎に支払情報を自動生成する機能です。

**処理フロー**

1. 対象年月の指定
2. 対象技術者の選択（未選択時は全技術者）
3. 対象技術者の契約情報取得
4. 技術者の勤怠データ取得
5. 支払データの構築
   - 技術者情報設定
   - 支払予定日の設定（契約の支払条件から）
   - 支払金額の計算（契約条件と勤怠情報から）
   - 支払明細の自動作成（契約毎の勤怠情報から）
   - 源泉徴収額の計算
6. 支払データの保存

**ビジネスロジック**

- 契約タイプに応じた支払金額計算
  - 固定報酬契約：契約金額をそのまま支払
  - 時間単価契約：実績時間 × 時間単価
  - 日単価契約：実績日数 × 日単価
- 源泉徴収計算：基本支払金額 × 源泉徴収税率
- 最終支払金額：基本支払金額 - 源泉徴収額 - その他控除額 + 追加支払額
- 支払予定日は契約の支払条件に基づいて自動設定
- 勤怠未承認の場合は対象外

**エラー処理**

- 対象契約が存在しない場合：処理をスキップ
- 承認済み勤怠データが存在しない場合：処理をスキップ
- 支払条件が不足している場合：InsufficientPaymentGenerationDataException

#### 2.1.3 支払情報更新機能

**概要**

作成済みの支払情報を更新する機能です。

**処理フロー**

1. 対象支払情報の取得
2. 支払ステータスの確認（下書き状態のみ更新可能）
3. 支払情報の更新
   - 支払予定日の更新
   - 説明の更新
   - 支払方法の更新
4. 支払明細の更新
   - 既存明細の削除
   - 新規明細の作成
5. 支払金額の再計算
6. 更新データの保存

**バリデーションルール**

- 下書き状態の支払のみ更新可能
- 支払明細は最低1件必須
- 更新後も各項目のバリデーションルールを満たすこと

**エラー処理**

- 支払情報が存在しない場合：ResourceNotFoundException
- 支払が下書き状態でない場合：InvalidPaymentStatusException
- 更新データが不正な場合：IllegalArgumentException

#### 2.1.4 支払確定機能

**概要**

支払情報を確定状態に変更し、支払番号を付与する機能です。

**処理フロー**

1. 対象支払情報の取得
2. 支払ステータスの確認（下書き状態のみ確定可能）
3. 支払番号の採番
   - フォーマット：PAY-{年月}-{5桁連番}
   - 例：PAY-202305-00001
4. 支払ステータスを「CONFIRMED」に変更
5. 確定日時の記録
6. 確定情報の保存

**ビジネスロジック**

- 支払番号は年月毎に連番で管理
- 採番後の支払番号は重複不可かつ変更不可
- 確定後の支払情報は編集不可

**エラー処理**

- 支払情報が存在しない場合：ResourceNotFoundException
- 支払が下書き状態でない場合：InvalidPaymentStatusException
- 支払番号採番エラー：SystemException

#### 2.1.5 支払実行機能

**概要**

確定された支払情報を実行済み状態に変更する機能です。

**処理フロー**

1. 対象支払情報の取得
2. 支払ステータスの確認（確定済み状態のみ実行可能）
3. 実行日の記録
4. 参照番号（振込番号等）の記録
5. 支払ステータスを「EXECUTED」に変更
6. 更新情報の保存

**バリデーションルール**

- 確定済み状態の支払のみ実行可能
- 実行日は必須
- 参照番号は任意

**エラー処理**

- 支払情報が存在しない場合：ResourceNotFoundException
- 支払が確定済み状態でない場合：InvalidPaymentStatusException

#### 2.1.6 支払取消機能

**概要**

下書きまたは確定済みの支払情報をキャンセル状態に変更する機能です。

**処理フロー**

1. 対象支払情報の取得
2. 支払ステータスの確認（下書きまたは確定済み状態のみ取消可能）
3. 支払ステータスを「CANCELED」に変更
4. 取消日時と取消理由の記録
5. 取消情報の保存

**バリデーションルール**

- 下書きまたは確定済み状態の支払のみ取消可能
- 実行済みの支払は取消不可
- 取消理由は必須

**エラー処理**

- 支払情報が存在しない場合：ResourceNotFoundException
- 支払が適切な状態でない場合：InvalidPaymentStatusException
- 実行済みの支払を取消しようとした場合：BusinessException

#### 2.1.7 支払情報検索機能

**概要**

条件に基づいて支払情報を検索する機能です。

**検索条件**

- 技術者ID
- 支払ステータス
- 発行日範囲
- 予定支払日範囲
- 実行日範囲
- 支払番号
- 支払金額範囲
- 対象年月

**処理フロー**

1. 検索条件の入力
2. バリデーション
3. 検索条件に基づくクエリ構築
4. データベース検索
5. 検索結果の返却（ページネーション対応）

**ソート条件**

- デフォルト：予定支払日の昇順
- ソート可能項目：発行日、予定支払日、実行日、支払番号、支払金額、ステータス

**エラー処理**

- 検索条件が不正な場合：IllegalArgumentException
- 検索処理エラー：SystemException

### 2.2 支払データエクスポート

#### 2.2.1 銀行振込データエクスポート機能

**概要**

支払情報から銀行振込用のデータをエクスポートする機能です。

**処理フロー**

1. 対象支払情報の指定（複数選択可）
2. 支払ステータスの確認（確定済み状態のみエクスポート可能）
3. 銀行振込データの生成
   - 銀行フォーマットに準拠したデータ構造
   - 必要なヘッダー・フッター情報の追加
4. ファイル生成
5. ダウンロード提供

**出力フォーマット**

- 全銀協フォーマット（固定長テキスト）
- CSV形式（汎用）
- 電子バンキングシステム専用フォーマット（オプション）

**バリデーションルール**

- 確定済み状態の支払のみエクスポート対象
- 支払方法が銀行振込の支払のみエクスポート対象
- 必要な銀行口座情報が揃っていること

**エラー処理**

- 支払情報が存在しない場合：ResourceNotFoundException
- 支払が確定済み状態でない場合：InvalidPaymentStatusException
- 銀行口座情報が不足している場合：InsufficientDataException
- ファイル生成エラー：SystemException

#### 2.2.2 支払一覧エクスポート機能

**概要**

支払情報一覧をエクスポートする機能です。

**処理フロー**

1. 検索条件の指定
2. 出力形式の選択（Excel, CSV等）
3. データ取得
4. 選択形式でのファイル生成
5. ダウンロード提供

**出力項目**

- 支払番号
- 技術者情報
- 支払ステータス
- 発行日
- 予定支払日
- 実行日
- 支払金額
- 支払方法
- 備考

**エラー処理**

- 検索条件が不正な場合：IllegalArgumentException
- ファイル生成エラー：SystemException

### 2.3 契約情報からの支払条件設定

**概要**

契約情報から支払条件を自動設定する機能です。

**処理フロー**

1. 契約IDの指定
2. 契約情報の取得
3. 契約から支払条件の抽出
   - 支払期間種別
   - 計算方法
   - 源泉徴収設定
   - 控除情報
4. 支払条件DTOの作成と返却

**ビジネスロジック**

- 契約に支払条件が設定されていない場合は技術者のデフォルト条件を使用
- 技術者にデフォルト条件がない場合はシステムのデフォルト条件を使用

**エラー処理**

- 契約が存在しない場合：ResourceNotFoundException
- 支払条件の取得に失敗した場合：SystemException

## 3. イベント設計

支払管理機能では、以下のイベントを定義し、他モジュールとの連携を実現します。

### 3.1 発行イベント

| イベント名 | 発行タイミング | 含む情報 | 目的 |
|-----------|--------------|---------|------|
| PaymentCreatedEvent | 支払情報作成時 | 支払ID、技術者ID、作成日時 | 支払情報作成の通知 |
| PaymentConfirmedEvent | 支払確定時 | 支払ID、技術者ID、確定日時 | 後続処理のトリガー |
| PaymentExecutedEvent | 支払実行時 | 支払ID、技術者ID、実行日、金額 | 支払実行の通知 |
| PaymentCanceledEvent | 支払取消時 | 支払ID、技術者ID、取消理由、取消日時 | 関連処理のキャンセル |
| PaymentStatusChangedEvent | 支払ステータス変更時 | 支払ID、旧ステータス、新ステータス、変更日時 | ステータス変更の通知 |

### 3.2 購読イベント

| イベント名 | 発行元 | 処理内容 | 目的 |
|-----------|-------|---------|------|
| TimesheetApprovedEvent | 勤怠工数管理モジュール | 支払情報自動生成の検討 | 勤怠承認に基づく支払情報生成 |
| ContractUpdatedEvent | 契約管理モジュール | 関連する支払条件の更新確認 | 契約情報との整合性維持 |
| EngineerUpdatedEvent | 技術者管理モジュール | 関連する支払方法の更新確認 | 技術者情報との整合性維持 |

## 4. セキュリティ設計

### 4.1 アクセス制御

支払管理機能に対するアクセス制御は以下のように設定します。

| 操作 | 必要権限 | 説明 |
|-----|---------|------|
| 支払情報閲覧 | ROLE_PAYMENT_VIEW | 支払情報の詳細を閲覧する権限 |
| 支払情報一覧 | ROLE_PAYMENT_LIST | 支払情報の一覧を閲覧する権限 |
| 支払情報作成 | ROLE_PAYMENT_CREATE | 新規支払情報を作成する権限 |
| 支払情報更新 | ROLE_PAYMENT_EDIT | 既存支払情報を更新する権限 |
| 支払確定 | ROLE_PAYMENT_CONFIRM | 支払情報を確定する権限 |
| 支払実行 | ROLE_PAYMENT_EXECUTE | 支払を実行済みとしてマークする権限 |
| 支払取消 | ROLE_PAYMENT_CANCEL | 支払情報を取消する権限 |
| 支払自動生成 | ROLE_PAYMENT_GENERATE | 勤怠データから支払情報を自動生成する権限 |
| 支払データエクスポート | ROLE_PAYMENT_EXPORT | 支払データをエクスポートする権限 |

### 4.2 データアクセス制限

支払データの技術者情報保護のため、以下の制限を実装します。

- 技術者本人は自分の支払情報のみ閲覧可能
- 経理担当者は全技術者の支払情報を閲覧・編集可能
- 管理者は全ての操作が可能
- クライアント担当者は支払情報へのアクセス不可

### 4.3 機密情報保護

支払に関する機密情報保護のため、以下の対策を実装します。

- 銀行口座情報はデータベース上で暗号化して保存
- 支払金額・源泉徴収額などの金額情報へのアクセスログ記録
- 個人情報を含むデータのエクスポート時には特別な権限を要求

## 5. エラー処理設計

支払管理機能では、以下のエラーハンドリングを実装します。

| エラーコード | エラー名 | 説明 | HTTP ステータス |
|------------|--------|------|---------------|
| BILLING_ERR_001 | ResourceNotFoundException | 指定されたリソースが存在しない | 404 Not Found |
| BILLING_ERR_003 | InvalidPaymentStatusException | 支払のステータスが期待される状態でない | 409 Conflict |
| BILLING_ERR_005 | AmountMismatchException | 金額の整合性が取れていない | 400 Bad Request |
| BILLING_ERR_006 | DataIntegrityException | データの整合性制約違反 | 409 Conflict |
| BILLING_ERR_008 | InsufficientPaymentGenerationDataException | 支払生成に必要なデータが不足している | 400 Bad Request |
| BILLING_ERR_020 | PaymentExportException | 支払データのエクスポートに失敗 | 500 Internal Server Error |
| BILLING_ERR_021 | PaymentExecutedException | 実行済み支払に対する禁止操作 | 409 Conflict |

## 6. テスト方針

### 6.1 単体テスト

- 支払情報作成処理のバリデーションテスト
- 支払金額計算ロジックのテスト
- 源泉徴収計算ロジックのテスト
- 支払状態遷移テスト
- 支払番号採番処理テスト
- 支払条件自動設定テスト

### 6.2 統合テスト

- 支払情報作成から実行までの一連の処理テスト
- 勤怠データからの支払情報自動生成テスト
- 契約情報と支払条件の連携テスト
- 技術者情報と支払方法の連携テスト
- 銀行振込データのエクスポートテスト

### 6.3 パフォーマンステスト

- 大量支払情報の検索性能テスト
- 月次一括支払情報生成の処理時間テスト
- 銀行振込データ大量エクスポートの処理時間テスト

## 7. 将来拡張性

支払管理機能は以下の拡張性を考慮して設計します。

### 7.1 多様な支払方法対応

将来的な新たな支払方法への対応を考慮します。

- 支払方法を抽象化したインターフェース設計
- 新規支払方法の追加が容易な構造
- 各支払方法に応じたパラメータの柔軟な拡張

### 7.2 多様な源泉徴収対応

税制改正や国際取引に対応するため、柔軟な源泉徴収計算方式を提供します。

- 源泉徴収計算ロジックのプラグイン化
- 国・地域別の源泉徴収ルールの適用
- 税率変更の履歴管理

### 7.3 複数通貨対応

海外技術者への支払いに対応するため、複数通貨対応を考慮します。

- 通貨ごとの設定
- 為替レート管理
- 通貨変換ロジック
- 通貨ごとの出力フォーマット