# 請求支払管理モジュール ドメインモデル

本ドキュメントでは、請求支払管理モジュールのドメインモデルを定義します。請求書・支払・入金情報など、主要なエンティティと値オブジェクト、それらの関係性について説明します。

## 1. エンティティ

### 1.1 Invoice（請求書）

請求書の基本情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 請求書ID | 主キー、UUID形式 |
| invoiceNumber | String | 請求書番号 | 必須、一意制約あり |
| clientId | ID | 顧客ID | 必須、外部キー |
| issueDate | Date | 発行日 | 必須 |
| dueDate | Date | 支払期限日 | 必須 |
| status | InvoiceStatus | 請求書ステータス | 必須 |
| subTotalAmount | Decimal | 小計金額 | 必須、0以上 |
| taxAmount | Decimal | 税額 | 必須、0以上 |
| totalAmount | Decimal | 合計金額 | 必須、0以上 |
| currencyCode | String | 通貨コード | 必須、ISO-4217形式 |
| description | String | 説明 | 任意、最大255文字 |
| remarks | Text | 備考 | 任意 |
| confirmedAt | DateTime | 確定日時 | 任意 |
| canceledAt | DateTime | 取消日時 | 任意 |
| cancelReason | String | 取消理由 | 取消時は必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 請求書は下書き状態で作成され、確定操作により請求書番号が付与される
- 確定後の請求書は編集不可、取消のみ可能
- 入金処理が行われた請求書は取消不可
- 請求書番号は「INV-{年月}-{連番}」の形式で自動生成する
- 合計金額は小計金額と税額の合計と一致する必要がある

### 1.2 InvoiceLineItem（請求書明細）

請求書の明細行を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 明細ID | 主キー、UUID形式 |
| invoiceId | ID | 請求書ID | 必須、外部キー |
| description | String | 明細説明 | 必須、最大255文字 |
| unitPrice | Decimal | 単価 | 必須、0以上 |
| quantity | Decimal | 数量 | 必須、0より大きい |
| unit | String | 単位 | 必須、最大20文字 |
| amount | Decimal | 金額 | 必須、0以上 |
| taxable | Boolean | 課税対象フラグ | 必須 |
| taxRate | Integer | 税率(%) | 課税対象の場合は必須 |
| engineerId | ID | 技術者ID | 任意、外部キー |
| engineerName | String | 技術者名 | 任意 |
| contractId | ID | 契約ID | 任意、外部キー |
| targetYear | Integer | 対象年 | 任意 |
| targetMonth | Integer | 対象月 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 金額は単価×数量で自動計算される
- 課税対象の場合、税率は必須
- 技術者に紐づく請求明細は、対象年月を記録する

### 1.3 BillingCondition（請求条件）

請求書の支払条件や請求先情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 請求条件ID | 主キー、UUID形式 |
| invoiceId | ID | 請求書ID | 必須、外部キー |
| paymentTermDays | Integer | 支払期限日数 | 必須、0以上 |
| billingMethod | String | 請求方法 | 必須 |
| bankName | String | 銀行名 | 任意 |
| bankBranchName | String | 支店名 | 任意 |
| bankAccountType | String | 口座種別 | 任意 |
| bankAccountNumber | String | 口座番号 | 任意 |
| bankAccountName | String | 口座名義 | 任意 |
| billingEmail | String | 請求書送付先メール | 任意、Eメール形式 |
| billingAddressId | ID | 請求書送付先住所ID | 任意、外部キー |
| billingContactName | String | 請求書担当者名 | 任意 |
| billingDepartment | String | 請求書担当部署 | 任意 |
| billingContactEmail | String | 請求書担当者メール | 任意、Eメール形式 |
| billingContactPhone | String | 請求書担当者電話 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 請求方法は「BANK_TRANSFER（振込）」「CREDIT_CARD（カード）」など固定値から選択
- クライアントのデフォルト請求条件から初期値が自動設定される

### 1.4 InvoiceDocument（請求書ドキュメント）

生成された請求書ドキュメントを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | ドキュメントID | 主キー、UUID形式 |
| invoiceId | ID | 請求書ID | 必須、外部キー |
| fileId | ID | ファイルID | 必須、外部キー |
| fileName | String | ファイル名 | 必須 |
| fileType | String | ファイル種別 | 必須、MIME形式 |
| fileSize | Long | ファイルサイズ(bytes) | 必須、0以上 |
| templateId | ID | テンプレートID | 必須、外部キー |
| templateName | String | テンプレート名 | 必須 |
| generatedAt | DateTime | 生成日時 | 必須 |
| generatedBy | ID | 生成者ID | 必須 |
| status | DocumentStatus | ドキュメント状態 | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 請求書ドキュメントは確定済み請求書からのみ生成可能
- 同一請求書から複数のドキュメントを生成可能（再発行など）
- ファイルは共通モジュールのファイル管理機能で管理

### 1.5 InvoiceTemplate（請求書テンプレート）

請求書のテンプレートを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | テンプレートID | 主キー、UUID形式 |
| templateName | String | テンプレート名 | 必須、最大100文字 |
| templateContent | Text | テンプレート内容 | 必須 |
| description | String | 説明 | 任意 |
| isDefault | Boolean | デフォルトフラグ | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- デフォルトフラグがtrueのテンプレートは常に1つだけ存在する
- テンプレート内容はHTMLテンプレート（Thymeleafなど）形式

### 1.6 ClientTemplate（クライアント別テンプレート）

クライアント固有の請求書テンプレート設定を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | ID | 主キー、UUID形式 |
| clientId | ID | クライアントID | 必須、外部キー、一意制約 |
| templateId | ID | テンプレートID | 必須、外部キー |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- クライアントに対して1つだけテンプレートを設定可能

### 1.7 DocumentDelivery（ドキュメント送信履歴）

請求書ドキュメントの送信履歴を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 送信履歴ID | 主キー、UUID形式 |
| documentId | ID | ドキュメントID | 必須、外部キー |
| deliveredAt | DateTime | 送信日時 | 必須 |
| recipients | Text | 送信先リスト | 必須 |
| deliveryMethod | String | 送信方法 | 必須 |
| deliveryStatus | String | 送信状態 | 必須 |
| requestReadReceipt | Boolean | 開封確認要求フラグ | 必須 |
| readAt | DateTime | 開封日時 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |

**ビジネスルール**：
- 送信方法は「EMAIL」「DOWNLOAD」「API」など固定値から選択
- 送信状態は「SENT」「FAILED」「PENDING」など固定値から選択

### 1.8 DocumentView（ドキュメント閲覧履歴）

請求書ドキュメントの閲覧履歴を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 閲覧履歴ID | 主キー、UUID形式 |
| documentId | ID | ドキュメントID | 必須、外部キー |
| viewedAt | DateTime | 閲覧日時 | 必須 |
| viewedBy | ID | 閲覧者ID | 任意 |
| ipAddress | String | IPアドレス | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |

**ビジネスルール**：
- システム内部ユーザーによる閲覧はユーザーIDを記録
- 外部クライアントなど未認証での閲覧はIPアドレスのみ記録

### 1.9 Payment（支払情報）

技術者への支払情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 支払ID | 主キー、UUID形式 |
| paymentNumber | String | 支払番号 | 必須、一意制約 |
| engineerId | ID | 技術者ID | 必須、外部キー |
| issueDate | Date | 発行日 | 必須 |
| scheduledDate | Date | 予定支払日 | 必須 |
| executedDate | Date | 実際支払日 | 任意 |
| status | PaymentStatus | 支払ステータス | 必須 |
| amount | Decimal | 支払金額 | 必須、0以上 |
| currencyCode | String | 通貨コード | 必須、ISO-4217形式 |
| description | String | 説明 | 任意 |
| referenceNumber | String | 参照番号 | 任意 |
| confirmedAt | DateTime | 確定日時 | 任意 |
| canceledAt | DateTime | 取消日時 | 任意 |
| cancelReason | String | 取消理由 | 取消時は必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 支払番号は「PAY-{年月}-{連番}」の形式で自動生成
- 支払ステータスの遷移：DRAFT→CONFIRMED→EXECUTED
- 支払情報は確定後のみ支払実行が可能
- 支払実行後の取消は原則不可

### 1.10 PaymentLineItem（支払明細）

支払の明細行を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 明細ID | 主キー、UUID形式 |
| paymentId | ID | 支払ID | 必須、外部キー |
| description | String | 明細説明 | 必須 |
| amount | Decimal | 金額 | 必須、0以上 |
| targetYear | Integer | 対象年 | 必須 |
| targetMonth | Integer | 対象月 | 必須 |
| contractId | ID | 契約ID | 必須、外部キー |
| contractName | String | 契約名 | 必須 |
| clientId | ID | クライアントID | 必須、外部キー |
| clientName | String | クライアント名 | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 支払明細は常に対象年月と契約を持つ
- 明細の合計金額は支払金額と一致する必要がある

### 1.11 PaymentMethod（支払方法）

支払方法の情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 支払方法ID | 主キー、UUID形式 |
| paymentId | ID | 支払ID | 必須、外部キー、一意制約 |
| type | PaymentMethodType | 支払方法種別 | 必須 |
| bankName | String | 銀行名 | 銀行振込の場合は必須 |
| branchName | String | 支店名 | 銀行振込の場合は必須 |
| accountType | String | 口座種別 | 銀行振込の場合は必須 |
| accountNumber | String | 口座番号 | 銀行振込の場合は必須 |
| accountName | String | 口座名義 | 銀行振込の場合は必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 支払方法種別は「BANK_TRANSFER（銀行振込）」「CASH（現金）」など固定値から選択
- 技術者のプロフィール情報から初期値を自動設定

### 1.12 PaymentCondition（支払条件）

支払の条件を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 支払条件ID | 主キー、UUID形式 |
| paymentId | ID | 支払ID | 必須、外部キー、一意制約 |
| paymentTermType | String | 支払期間種別 | 必須 |
| calculationMethod | String | 計算方法 | 必須 |
| withholdingTaxRate | Decimal | 源泉徴収税率(%) | 必須、0以上100以下 |
| deductions | Text | 控除情報JSON | 任意 |
| additionalPayments | Text | 追加支払情報JSON | 任意 |
| remarks | Text | 備考 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 支払期間種別は「MONTHLY（月次）」「WEEKLY（週次）」など固定値から選択
- 計算方法は「FIXED（固定額）」「TIME_BASED（時間給）」「DAILY_BASED（日給）」など固定値から選択
- 契約情報から初期値を自動設定

### 1.13 Receipt（入金情報）

クライアントからの入金情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 入金ID | 主キー、UUID形式 |
| receiptNumber | String | 入金番号 | 必須、一意制約 |
| clientId | ID | クライアントID | 必須、外部キー |
| receiptDate | Date | 入金日 | 必須 |
| amount | Decimal | 入金金額 | 必須、0より大きい |
| currencyCode | String | 通貨コード | 必須、ISO-4217形式 |
| status | ReceiptStatus | 入金ステータス | 必須 |
| bankName | String | 銀行名 | 任意 |
| accountNumber | String | 口座番号 | 任意 |
| referenceNumber | String | 参照番号 | 任意 |
| description | String | 説明 | 任意 |
| canceledAt | DateTime | 取消日時 | 任意 |
| cancelReason | String | 取消理由 | 取消時は必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 入金番号は「REC-{年月日}-{連番}」の形式で自動生成
- 入金と請求書の紐付けは必須ではない（後から紐付け可能）
- 入金ステータスは「REGISTERED」「ALLOCATED」「CANCELED」など固定値から選択

### 1.14 ReceiptAllocation（入金割当）

入金情報と請求書の紐付けを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 割当ID | 主キー、UUID形式 |
| receiptId | ID | 入金ID | 必須、外部キー |
| invoiceId | ID | 請求書ID | 必須、外部キー |
| allocatedAmount | Decimal | 割当金額 | 必須、0より大きい |
| allocatedAt | DateTime | 割当日時 | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 割当金額の合計は入金金額を超えてはならない
- 請求書への割当金額の合計は請求書の金額を超えてはならない
- 入金取消時は関連する全ての割当を削除する

## 2. 値オブジェクト

### 2.1 InvoiceStatus（請求書ステータス）

請求書の状態を表す列挙型です。

```
enum InvoiceStatus {
    DRAFT,          // 下書き
    CONFIRMED,      // 確定済み
    SENT,           // 送付済み
    PARTIALLY_PAID, // 一部入金
    PAID,           // 入金完了
    CANCELED,       // 取消
    OVERDUE         // 支払期限超過
}
```

### 2.2 DocumentStatus（ドキュメント状態）

請求書ドキュメントの状態を表す列挙型です。

```
enum DocumentStatus {
    GENERATED,  // 生成済み
    SENT,       // 送信済み
    VIEWED,     // 閲覧済み
    ARCHIVED,   // アーカイブ済み
    PURGED      // 削除済み
}
```

### 2.3 PaymentStatus（支払ステータス）

支払情報の状態を表す列挙型です。

```
enum PaymentStatus {
    DRAFT,      // 下書き
    CONFIRMED,  // 確定済み
    EXECUTING,  // 支払処理中
    EXECUTED,   // 支払済み
    CANCELED,   // 取消
    FAILED      // 失敗
}
```

### 2.4 PaymentMethodType（支払方法種別）

支払方法の種別を表す列挙型です。

```
enum PaymentMethodType {
    BANK_TRANSFER,  // 銀行振込
    CASH,           // 現金
    CRYPTO,         // 暗号通貨
    OTHER           // その他
}
```

### 2.5 ReceiptStatus（入金ステータス）

入金情報の状態を表す列挙型です。

```
enum ReceiptStatus {
    REGISTERED,     // 登録済み
    ALLOCATED,      // 割当済み
    CANCELED        // 取消
}
```

### 2.6 ReportType（レポート種別）

レポートの種別を表す列挙型です。

```
enum ReportType {
    SALES,                  // 売上レポート
    ACCOUNTS_RECEIVABLE,    // 未収金レポート
    PAYMENT_SCHEDULE,       // 支払予定レポート
    PROFIT_LOSS,            // 収支レポート
    CUSTOM                  // カスタムレポート
}
```

### 2.7 SortField（ソートフィールド）

検索結果のソート条件を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|------|------|
| field | String | フィールド名 |
| direction | SortDirection | ソート方向 |

```
enum SortDirection {
    ASC,    // 昇順
    DESC    // 降順
}
```

### 2.8 FilterCondition（フィルタ条件）

検索条件のフィルタを表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|------|------|
| field | String | フィールド名 |
| operator | FilterOperator | 演算子 |
| value | Object | 条件値 |

```
enum FilterOperator {
    EQUALS,             // 等しい
    NOT_EQUALS,         // 等しくない
    GREATER_THAN,       // より大きい
    LESS_THAN,          // より小さい
    GREATER_THAN_EQUAL, // 以上
    LESS_THAN_EQUAL,    // 以下
    CONTAINS,           // 含む
    STARTS_WITH,        // で始まる
    ENDS_WITH,          // で終わる
    IN,                 // リストに含まれる
    NOT_IN              // リストに含まれない
}
```

## 3. ドメイン関連図

以下は主要なエンティティ間の関連を示します。

```
Invoice 1 --- * InvoiceLineItem
Invoice 1 --- 1 BillingCondition
Invoice 1 --- * InvoiceDocument
Invoice * --- * Receipt (via ReceiptAllocation)

InvoiceDocument 1 --- * DocumentDelivery
InvoiceDocument 1 --- * DocumentView
InvoiceDocument * --- 1 InvoiceTemplate

InvoiceTemplate 1 --- * ClientTemplate
Client 1 --- 1 ClientTemplate

Payment 1 --- * PaymentLineItem
Payment 1 --- 1 PaymentMethod
Payment 1 --- 1 PaymentCondition
Payment * --- 1 Engineer

Receipt 1 --- * ReceiptAllocation
Receipt * --- 1 Client
```

## 4. 重要なビジネスルール

### 4.1 請求書関連ルール

1. **請求書番号の自動採番**
   - 請求書確定時に自動採番される
   - フォーマット: INV-{年月}-{5桁連番}
   - 例: INV-202305-00001

2. **請求書ステータス遷移**
   - DRAFT → CONFIRMED （確定）
   - CONFIRMED → SENT （送付）
   - CONFIRMED/SENT → PARTIALLY_PAID （一部入金）
   - PARTIALLY_PAID → PAID （入金完了）
   - DRAFT/CONFIRMED/SENT → CANCELED （取消）
   - CONFIRMED/SENT → OVERDUE （支払期限超過）

3. **請求金額計算**
   - 小計金額 = Σ (明細金額)
   - 税額 = Σ (課税対象明細の税額)
   - 合計金額 = 小計金額 + 税額

4. **請求書編集制限**
   - DRAFT状態の請求書のみ編集可能
   - CONFIRMED以降の状態では編集不可（取消のみ可能）
   - 入金処理が紐づいた請求書は取消不可

### 4.2 支払関連ルール

1. **支払番号の自動採番**
   - 支払確定時に自動採番される
   - フォーマット: PAY-{年月}-{5桁連番}
   - 例: PAY-202305-00001

2. **支払ステータス遷移**
   - DRAFT → CONFIRMED （確定）
   - CONFIRMED → EXECUTING （支払処理中）
   - EXECUTING → EXECUTED （支払完了）
   - EXECUTING → FAILED （支払失敗）
   - DRAFT/CONFIRMED → CANCELED （取消）

3. **支払金額計算**
   - 支払基本金額は契約条件と勤怠情報から算出
   - 源泉徴収額 = 支払基本金額 × 源泉徴収税率
   - 最終支払金額 = 支払基本金額 - 源泉徴収額 - その他控除額 + 追加支払額

4. **支払編集制限**
   - DRAFT状態の支払のみ編集可能
   - CONFIRMED以降の状態では編集不可（取消のみ可能）
   - EXECUTED状態の支払は取消不可

### 4.3 入金関連ルール

1. **入金番号の自動採番**
   - 入金登録時に自動採番される
   - フォーマット: REC-{年月日}-{3桁連番}
   - 例: REC-20230501-001

2. **入金割当ルール**
   - 入金金額 ≥ Σ (割当金額)
   - 請求書への割当合計 ≤ 請求書金額
   - 一つの入金を複数の請求書に割り当て可能
   - 一つの請求書に複数の入金を割り当て可能

3. **入金ステータス遷移**
   - REGISTERED → ALLOCATED （割当完了）
   - REGISTERED/ALLOCATED → CANCELED （取消）

4. **請求書入金状態更新**
   - 請求書への割当金額合計 < 請求書金額 → PARTIALLY_PAID
   - 請求書への割当金額合計 ≥ 請求書金額 → PAID