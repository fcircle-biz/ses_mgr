# インターフェース定義

本ドキュメントでは、請求支払管理モジュールが提供するインターフェースと、他モジュールから利用するインターフェースを定義します。

## 1. 提供インターフェース

請求支払管理モジュールは以下のサービスインターフェースを提供します。

### 1.1 InvoiceService

請求書の生成、管理に関する機能を提供するサービスです。

```java
/**
 * 請求管理サービスのインターフェース
 */
public interface InvoiceService {
    
    /**
     * 請求書を新規作成します
     * 
     * @param request 請求書作成リクエスト
     * @return 作成された請求書情報
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws ResourceNotFoundException 関連リソースが見つからない場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    InvoiceDto createInvoice(CreateInvoiceRequest request);
    
    /**
     * 請求書IDに基づいて請求書情報を取得します
     * 
     * @param invoiceId 請求書ID
     * @return 請求書情報
     * @throws ResourceNotFoundException 請求書が見つからない場合
     */
    InvoiceDto getInvoiceById(String invoiceId);
    
    /**
     * 請求条件に基づいて請求書を検索します
     * 
     * @param condition 検索条件
     * @return 請求書情報のリスト
     */
    Page<InvoiceDto> searchInvoices(InvoiceSearchCondition condition);
    
    /**
     * 請求書を更新します
     * 
     * @param invoiceId 請求書ID
     * @param request 更新リクエスト
     * @return 更新された請求書情報
     * @throws ResourceNotFoundException 請求書が見つからない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    InvoiceDto updateInvoice(String invoiceId, UpdateInvoiceRequest request);
    
    /**
     * 請求書を確定します
     * 
     * @param invoiceId 請求書ID
     * @return 確定された請求書情報
     * @throws ResourceNotFoundException 請求書が見つからない場合
     * @throws BusinessException 請求書が確定できない状態の場合
     */
    InvoiceDto confirmInvoice(String invoiceId);
    
    /**
     * 請求書を取消します
     * 
     * @param invoiceId 請求書ID
     * @param reason 取消理由
     * @return 取消された請求書情報
     * @throws ResourceNotFoundException 請求書が見つからない場合
     * @throws BusinessException 請求書が取消できない状態の場合
     */
    InvoiceDto cancelInvoice(String invoiceId, String reason);
    
    /**
     * 勤怠情報から請求書を自動生成します
     * 
     * @param year 年
     * @param month 月
     * @param clientIds 対象クライアントIDリスト（指定しない場合は全クライアント）
     * @return 生成された請求書IDリスト
     * @throws BusinessException 請求書生成条件が揃っていない場合
     */
    List<String> generateInvoicesFromTimesheet(int year, int month, List<String> clientIds);
    
    /**
     * 契約情報から請求条件を自動設定します
     * 
     * @param contractId 契約ID
     * @return 設定された請求条件情報
     * @throws ResourceNotFoundException 契約情報が見つからない場合
     */
    BillingConditionDto setupBillingConditionFromContract(String contractId);
}
```

### 1.2 InvoiceDocumentService

請求書ドキュメントの生成、管理に関する機能を提供するサービスです。

```java
/**
 * 請求書ドキュメント管理サービスのインターフェース
 */
public interface InvoiceDocumentService {
    
    /**
     * 請求書ドキュメントを生成します
     * 
     * @param invoiceId 請求書ID
     * @param templateId テンプレートID（null の場合はデフォルトテンプレート）
     * @return 生成された請求書ドキュメント情報
     * @throws ResourceNotFoundException 請求書またはテンプレートが見つからない場合
     */
    InvoiceDocumentDto generateInvoiceDocument(String invoiceId, String templateId);
    
    /**
     * 請求書ドキュメントを取得します
     * 
     * @param documentId ドキュメントID
     * @return 請求書ドキュメント情報
     * @throws ResourceNotFoundException ドキュメントが見つからない場合
     */
    InvoiceDocumentDto getInvoiceDocument(String documentId);
    
    /**
     * 請求書に紐づく全ての請求書ドキュメントを取得します
     * 
     * @param invoiceId 請求書ID
     * @return 請求書ドキュメント情報のリスト
     * @throws ResourceNotFoundException 請求書が見つからない場合
     */
    List<InvoiceDocumentDto> getInvoiceDocumentsByInvoiceId(String invoiceId);
    
    /**
     * 請求書ドキュメントをダウンロードするためのURLを取得します
     * 
     * @param documentId ドキュメントID
     * @param expirationMinutes URL有効期限（分）
     * @return ダウンロード用URL
     * @throws ResourceNotFoundException ドキュメントが見つからない場合
     */
    String getInvoiceDocumentDownloadUrl(String documentId, int expirationMinutes);
    
    /**
     * 請求書ドキュメントを送信します
     * 
     * @param documentId ドキュメントID
     * @param request 送信リクエスト
     * @return 送信結果
     * @throws ResourceNotFoundException ドキュメントが見つからない場合
     * @throws BusinessException 送信できない状態の場合
     */
    SendDocumentResultDto sendInvoiceDocument(String documentId, SendDocumentRequest request);
}
```

### 1.3 PaymentService

支払管理に関する機能を提供するサービスです。

```java
/**
 * 支払管理サービスのインターフェース
 */
public interface PaymentService {
    
    /**
     * 支払情報を新規作成します
     * 
     * @param request 支払作成リクエスト
     * @return 作成された支払情報
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws ResourceNotFoundException 関連リソースが見つからない場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    PaymentDto createPayment(CreatePaymentRequest request);
    
    /**
     * 支払IDに基づいて支払情報を取得します
     * 
     * @param paymentId 支払ID
     * @return 支払情報
     * @throws ResourceNotFoundException 支払情報が見つからない場合
     */
    PaymentDto getPaymentById(String paymentId);
    
    /**
     * 支払条件に基づいて支払情報を検索します
     * 
     * @param condition 検索条件
     * @return 支払情報のリスト
     */
    Page<PaymentDto> searchPayments(PaymentSearchCondition condition);
    
    /**
     * 支払情報を更新します
     * 
     * @param paymentId 支払ID
     * @param request 更新リクエスト
     * @return 更新された支払情報
     * @throws ResourceNotFoundException 支払情報が見つからない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    PaymentDto updatePayment(String paymentId, UpdatePaymentRequest request);
    
    /**
     * 支払を確定します
     * 
     * @param paymentId 支払ID
     * @return 確定された支払情報
     * @throws ResourceNotFoundException 支払情報が見つからない場合
     * @throws BusinessException 支払が確定できない状態の場合
     */
    PaymentDto confirmPayment(String paymentId);
    
    /**
     * 支払を実行済みとしてマークします
     * 
     * @param paymentId 支払ID
     * @param executedDate 実行日
     * @param referenceNumber 参照番号（振込番号など）
     * @return 更新された支払情報
     * @throws ResourceNotFoundException 支払情報が見つからない場合
     * @throws BusinessException 支払を実行済みにできない状態の場合
     */
    PaymentDto markPaymentAsExecuted(String paymentId, LocalDate executedDate, String referenceNumber);
    
    /**
     * 支払を取消します
     * 
     * @param paymentId 支払ID
     * @param reason 取消理由
     * @return 取消された支払情報
     * @throws ResourceNotFoundException 支払情報が見つからない場合
     * @throws BusinessException 支払が取消できない状態の場合
     */
    PaymentDto cancelPayment(String paymentId, String reason);
    
    /**
     * 勤怠情報から支払情報を自動生成します
     * 
     * @param year 年
     * @param month 月
     * @param engineerIds 対象技術者IDリスト（指定しない場合は全技術者）
     * @return 生成された支払IDリスト
     * @throws BusinessException 支払生成条件が揃っていない場合
     */
    List<String> generatePaymentsFromTimesheet(int year, int month, List<String> engineerIds);
    
    /**
     * 契約情報から支払条件を自動設定します
     * 
     * @param contractId 契約ID
     * @return 設定された支払条件情報
     * @throws ResourceNotFoundException 契約情報が見つからない場合
     */
    PaymentConditionDto setupPaymentConditionFromContract(String contractId);
}
```

### 1.4 ReceiptService

入金管理に関する機能を提供するサービスです。

```java
/**
 * 入金管理サービスのインターフェース
 */
public interface ReceiptService {
    
    /**
     * 入金情報を新規登録します
     * 
     * @param request 入金登録リクエスト
     * @return 登録された入金情報
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws ResourceNotFoundException 関連リソースが見つからない場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    ReceiptDto registerReceipt(RegisterReceiptRequest request);
    
    /**
     * 入金IDに基づいて入金情報を取得します
     * 
     * @param receiptId 入金ID
     * @return 入金情報
     * @throws ResourceNotFoundException 入金情報が見つからない場合
     */
    ReceiptDto getReceiptById(String receiptId);
    
    /**
     * 入金条件に基づいて入金情報を検索します
     * 
     * @param condition 検索条件
     * @return 入金情報のリスト
     */
    Page<ReceiptDto> searchReceipts(ReceiptSearchCondition condition);
    
    /**
     * 入金情報を更新します
     * 
     * @param receiptId 入金ID
     * @param request 更新リクエスト
     * @return 更新された入金情報
     * @throws ResourceNotFoundException 入金情報が見つからない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    ReceiptDto updateReceipt(String receiptId, UpdateReceiptRequest request);
    
    /**
     * 入金情報を請求書に紐付けます
     * 
     * @param receiptId 入金ID
     * @param invoiceIds 請求書IDリスト
     * @return 更新された入金情報
     * @throws ResourceNotFoundException 入金情報または請求書が見つからない場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    ReceiptDto linkReceiptToInvoices(String receiptId, List<String> invoiceIds);
    
    /**
     * 入金情報を取消します
     * 
     * @param receiptId 入金ID
     * @param reason 取消理由
     * @return 取消された入金情報
     * @throws ResourceNotFoundException 入金情報が見つからない場合
     * @throws BusinessException 入金が取消できない状態の場合
     */
    ReceiptDto cancelReceipt(String receiptId, String reason);
    
    /**
     * クライアントの未入金請求書を取得します
     * 
     * @param clientId クライアントID
     * @return 未入金請求書のリスト
     * @throws ResourceNotFoundException クライアントが見つからない場合
     */
    List<InvoiceDto> getUnpaidInvoicesByClient(String clientId);
    
    /**
     * 請求書の入金状況を取得します
     * 
     * @param invoiceId 請求書ID
     * @return 請求書の入金状況情報
     * @throws ResourceNotFoundException 請求書が見つからない場合
     */
    InvoiceReceiptStatusDto getInvoiceReceiptStatus(String invoiceId);
}
```

### 1.5 BillingReportService

請求支払いに関するレポート機能を提供するサービスです。

```java
/**
 * 請求支払レポートサービスのインターフェース
 */
public interface BillingReportService {
    
    /**
     * 売上レポートを生成します
     * 
     * @param year 年
     * @param month 月（0の場合は年次）
     * @param clientId クライアントID（nullの場合は全クライアント）
     * @return 売上レポート情報
     */
    SalesReportDto generateSalesReport(int year, int month, String clientId);
    
    /**
     * 未収金レポートを生成します
     * 
     * @param asOfDate 基準日
     * @param clientId クライアントID（nullの場合は全クライアント）
     * @return 未収金レポート情報
     */
    AccountsReceivableReportDto generateAccountsReceivableReport(LocalDate asOfDate, String clientId);
    
    /**
     * 支払予定レポートを生成します
     * 
     * @param startDate 開始日
     * @param endDate 終了日
     * @param engineerId 技術者ID（nullの場合は全技術者）
     * @return 支払予定レポート情報
     */
    PaymentScheduleReportDto generatePaymentScheduleReport(LocalDate startDate, LocalDate endDate, String engineerId);
    
    /**
     * 収支レポートを生成します
     * 
     * @param year 年
     * @param month 月（0の場合は年次）
     * @return 収支レポート情報
     */
    ProfitLossReportDto generateProfitLossReport(int year, int month);
    
    /**
     * カスタムレポートを作成します
     * 
     * @param request カスタムレポート作成リクエスト
     * @return カスタムレポート情報
     * @throws IllegalArgumentException リクエストが不正な場合
     */
    CustomReportDto createCustomReport(CreateCustomReportRequest request);
    
    /**
     * レポートを指定形式でエクスポートします
     * 
     * @param reportId レポートID
     * @param format エクスポート形式（"PDF", "EXCEL", "CSV"）
     * @return エクスポートされたファイルのダウンロードURL
     * @throws ResourceNotFoundException レポートが見つからない場合
     * @throws IllegalArgumentException 形式が不正な場合
     */
    String exportReport(String reportId, String format);
}
```

## 2. 利用インターフェース

請求支払管理モジュールは、以下の他モジュールが提供するインターフェースを利用します。

### 2.1 契約管理モジュール

```java
// 契約情報取得サービス
public interface ContractService {
    ContractDto getContractById(String contractId);
    List<ContractDto> getContractsByClient(String clientId);
    List<ContractDto> getContractsByEngineer(String engineerId);
}

// 契約条件取得サービス
public interface ContractConditionService {
    BillingConditionDto getBillingCondition(String contractId);
    PaymentConditionDto getPaymentCondition(String contractId);
}
```

### 2.2 勤怠工数管理モジュール

```java
// 勤怠情報取得サービス
public interface TimesheetService {
    List<TimesheetDto> getApprovedTimesheets(int year, int month, String engineerId);
    List<TimesheetSummaryDto> getApprovedTimesheetSummaries(int year, int month, List<String> engineerIds);
    WorkingHoursSummaryDto getWorkingHoursSummary(String engineerId, int year, int month);
}
```

### 2.3 技術者管理モジュール

```java
// 技術者情報取得サービス
public interface EngineerService {
    EngineerDto getEngineerById(String engineerId);
    List<EngineerDto> getEngineersByIds(List<String> engineerIds);
    EngineerBankAccountDto getEngineerBankAccount(String engineerId);
}
```

### 2.4 共通機能モジュール

```java
// ファイル管理サービス
public interface FileManagementService {
    String storeFile(byte[] content, String fileName, String contentType, Map<String, String> metadata);
    byte[] getFileContent(String fileId);
    String generateDownloadUrl(String fileId, int expirationMinutes);
}

// 通知サービス
public interface NotificationService {
    void sendNotification(NotificationType type, String targetUserId, String title, String content, Map<String, Object> parameters);
    void sendEmail(String to, String subject, String body, List<Attachment> attachments);
}

// コード値管理サービス
public interface CodeValueService {
    List<CodeValueDto> getCodeValues(String codeGroupId);
    CodeValueDto getCodeValue(String codeGroupId, String codeId);
}
```

## 3. データ交換モデル

### 3.1 請求関連データモデル

```java
// 請求書DTO
public class InvoiceDto {
    private String invoiceId;
    private String invoiceNumber;
    private String clientId;
    private String clientName;
    private LocalDate issueDate;
    private LocalDate dueDate;
    private InvoiceStatus status;
    private BigDecimal subTotalAmount;
    private BigDecimal taxAmount;
    private BigDecimal totalAmount;
    private String currencyCode;
    private String description;
    private String remarks;
    private List<InvoiceLineItemDto> lineItems;
    private BillingConditionDto billingCondition;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// 請求書明細DTO
public class InvoiceLineItemDto {
    private String lineItemId;
    private String description;
    private BigDecimal unitPrice;
    private BigDecimal quantity;
    private String unit;
    private BigDecimal amount;
    private boolean taxable;
    private Integer taxRate;
    private String engineerId;
    private String engineerName;
    private String contractId;
    private Integer targetYear;
    private Integer targetMonth;
}

// 請求書作成リクエスト
public class CreateInvoiceRequest {
    private String clientId;
    private LocalDate issueDate;
    private LocalDate dueDate;
    private String description;
    private String remarks;
    private String currencyCode;
    private List<InvoiceLineItemRequest> lineItems;
    private BillingConditionRequest billingCondition;
}

// 請求書更新リクエスト
public class UpdateInvoiceRequest {
    private LocalDate issueDate;
    private LocalDate dueDate;
    private String description;
    private String remarks;
    private List<InvoiceLineItemRequest> lineItems;
    private BillingConditionRequest billingCondition;
}

// 請求書検索条件
public class InvoiceSearchCondition {
    private String clientId;
    private List<InvoiceStatus> statuses;
    private LocalDate issueDateFrom;
    private LocalDate issueDateTo;
    private LocalDate dueDateFrom;
    private LocalDate dueDateTo;
    private String invoiceNumber;
    private BigDecimal amountMin;
    private BigDecimal amountMax;
    private Integer year;
    private Integer month;
    private Boolean isPaid;
    private Boolean isOverdue;
    private int page;
    private int size;
    private List<SortField> sortFields;
}
```

### 3.2 請求書ドキュメント関連データモデル

```java
// 請求書ドキュメントDTO
public class InvoiceDocumentDto {
    private String documentId;
    private String invoiceId;
    private String fileName;
    private String fileType;
    private long fileSize;
    private String templateId;
    private String templateName;
    private LocalDateTime generatedAt;
    private String generatedBy;
    private DocumentStatus status;
    private List<DocumentDeliveryDto> deliveryHistory;
}

// ドキュメント送信リクエスト
public class SendDocumentRequest {
    private List<String> emailAddresses;
    private String subject;
    private String body;
    private boolean requestReadReceipt;
}

// ドキュメント送信結果
public class SendDocumentResultDto {
    private String documentId;
    private boolean success;
    private List<String> sentTo;
    private LocalDateTime sentAt;
    private String errorMessage;
}

// ドキュメント配送履歴
public class DocumentDeliveryDto {
    private String deliveryId;
    private LocalDateTime deliveredAt;
    private List<String> recipients;
    private String deliveryMethod;
    private String deliveryStatus;
    private LocalDateTime readAt;
}
```

### 3.3 支払関連データモデル

```java
// 支払DTO
public class PaymentDto {
    private String paymentId;
    private String paymentNumber;
    private String engineerId;
    private String engineerName;
    private LocalDate issueDate;
    private LocalDate scheduledDate;
    private LocalDate executedDate;
    private PaymentStatus status;
    private BigDecimal amount;
    private String currencyCode;
    private String description;
    private String referenceNumber;
    private PaymentMethodDto paymentMethod;
    private PaymentConditionDto paymentCondition;
    private List<PaymentLineItemDto> lineItems;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// 支払明細DTO
public class PaymentLineItemDto {
    private String lineItemId;
    private String description;
    private BigDecimal amount;
    private Integer targetYear;
    private Integer targetMonth;
    private String contractId;
    private String contractName;
    private String clientId;
    private String clientName;
}

// 支払方法DTO
public class PaymentMethodDto {
    private PaymentMethodType type;
    private String bankName;
    private String branchName;
    private String accountType;
    private String accountNumber;
    private String accountName;
}

// 支払作成リクエスト
public class CreatePaymentRequest {
    private String engineerId;
    private LocalDate issueDate;
    private LocalDate scheduledDate;
    private BigDecimal amount;
    private String currencyCode;
    private String description;
    private PaymentMethodRequest paymentMethod;
    private PaymentConditionRequest paymentCondition;
    private List<PaymentLineItemRequest> lineItems;
}

// 支払更新リクエスト
public class UpdatePaymentRequest {
    private LocalDate issueDate;
    private LocalDate scheduledDate;
    private String description;
    private PaymentMethodRequest paymentMethod;
    private List<PaymentLineItemRequest> lineItems;
}

// 支払検索条件
public class PaymentSearchCondition {
    private String engineerId;
    private List<PaymentStatus> statuses;
    private LocalDate issueDateFrom;
    private LocalDate issueDateTo;
    private LocalDate scheduledDateFrom;
    private LocalDate scheduledDateTo;
    private LocalDate executedDateFrom;
    private LocalDate executedDateTo;
    private String paymentNumber;
    private BigDecimal amountMin;
    private BigDecimal amountMax;
    private Integer year;
    private Integer month;
    private int page;
    private int size;
    private List<SortField> sortFields;
}
```

### 3.4 入金関連データモデル

```java
// 入金DTO
public class ReceiptDto {
    private String receiptId;
    private String receiptNumber;
    private String clientId;
    private String clientName;
    private LocalDate receiptDate;
    private BigDecimal amount;
    private String currencyCode;
    private ReceiptStatus status;
    private String bankName;
    private String accountNumber;
    private String referenceNumber;
    private String description;
    private List<ReceiptAllocationDto> allocations;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// 入金割当DTO
public class ReceiptAllocationDto {
    private String allocationId;
    private String invoiceId;
    private String invoiceNumber;
    private BigDecimal allocatedAmount;
    private LocalDateTime allocatedAt;
}

// 入金登録リクエスト
public class RegisterReceiptRequest {
    private String clientId;
    private LocalDate receiptDate;
    private BigDecimal amount;
    private String currencyCode;
    private String bankName;
    private String accountNumber;
    private String referenceNumber;
    private String description;
    private List<ReceiptAllocationRequest> allocations;
}

// 入金更新リクエスト
public class UpdateReceiptRequest {
    private LocalDate receiptDate;
    private String bankName;
    private String referenceNumber;
    private String description;
}

// 入金検索条件
public class ReceiptSearchCondition {
    private String clientId;
    private List<ReceiptStatus> statuses;
    private LocalDate receiptDateFrom;
    private LocalDate receiptDateTo;
    private String receiptNumber;
    private BigDecimal amountMin;
    private BigDecimal amountMax;
    private String invoiceId;
    private int page;
    private int size;
    private List<SortField> sortFields;
}

// 請求書入金状況DTO
public class InvoiceReceiptStatusDto {
    private String invoiceId;
    private String invoiceNumber;
    private BigDecimal totalAmount;
    private BigDecimal receivedAmount;
    private BigDecimal outstandingAmount;
    private boolean fullyPaid;
    private List<ReceiptDto> receipts;
}
```

### 3.5 レポート関連データモデル

```java
// 売上レポートDTO
public class SalesReportDto {
    private String reportId;
    private int year;
    private int month;
    private String clientId;
    private String clientName;
    private BigDecimal totalAmount;
    private BigDecimal taxAmount;
    private BigDecimal netAmount;
    private Map<String, BigDecimal> monthlySales;
    private Map<String, BigDecimal> clientSales;
    private LocalDateTime generatedAt;
}

// 未収金レポートDTO
public class AccountsReceivableReportDto {
    private String reportId;
    private LocalDate asOfDate;
    private String clientId;
    private String clientName;
    private BigDecimal totalReceivableAmount;
    private List<AccountsReceivableDetailDto> details;
    private Map<String, BigDecimal> agingBuckets;
    private LocalDateTime generatedAt;
}

// 支払予定レポートDTO
public class PaymentScheduleReportDto {
    private String reportId;
    private LocalDate startDate;
    private LocalDate endDate;
    private String engineerId;
    private String engineerName;
    private BigDecimal totalScheduledAmount;
    private List<PaymentScheduleDetailDto> details;
    private Map<String, BigDecimal> scheduleDateBuckets;
    private LocalDateTime generatedAt;
}

// 収支レポートDTO
public class ProfitLossReportDto {
    private String reportId;
    private int year;
    private int month;
    private BigDecimal totalRevenue;
    private BigDecimal totalExpense;
    private BigDecimal grossProfit;
    private BigDecimal grossProfitRate;
    private Map<String, BigDecimal> monthlyRevenue;
    private Map<String, BigDecimal> monthlyExpense;
    private Map<String, BigDecimal> monthlyProfit;
    private Map<String, BigDecimal> monthlyProfitRate;
    private LocalDateTime generatedAt;
}

// カスタムレポートDTO
public class CustomReportDto {
    private String reportId;
    private String reportName;
    private String description;
    private ReportType type;
    private Map<String, Object> parameters;
    private List<Map<String, Object>> data;
    private List<ReportColumnDto> columns;
    private Map<String, Object> aggregates;
    private LocalDateTime generatedAt;
}

// レポート列定義DTO
public class ReportColumnDto {
    private String columnId;
    private String columnName;
    private String dataType;
    private String format;
    private boolean sortable;
    private boolean filterable;
    private boolean groupable;
    private boolean visible;
}

// カスタムレポート作成リクエスト
public class CreateCustomReportRequest {
    private String reportName;
    private String description;
    private ReportType type;
    private Map<String, Object> parameters;
    private List<String> columns;
    private List<FilterCondition> filters;
    private List<GroupingField> groupings;
    private List<SortField> sortFields;
}
```

## 4. 例外定義

請求支払管理モジュールでは、以下の例外を定義します。

```java
// リソース未検出例外
public class ResourceNotFoundException extends BusinessException {
    public ResourceNotFoundException(String resourceType, String resourceId) {
        super("BILLING_ERR_001", resourceType + " not found with id: " + resourceId);
    }
}

// 請求書状態不正例外
public class InvalidInvoiceStatusException extends BusinessException {
    public InvalidInvoiceStatusException(String invoiceId, InvoiceStatus currentStatus, InvoiceStatus requiredStatus) {
        super("BILLING_ERR_002", "Invoice " + invoiceId + " has invalid status: " + currentStatus + 
              ", required: " + requiredStatus);
    }
}

// 支払状態不正例外
public class InvalidPaymentStatusException extends BusinessException {
    public InvalidPaymentStatusException(String paymentId, PaymentStatus currentStatus, PaymentStatus requiredStatus) {
        super("BILLING_ERR_003", "Payment " + paymentId + " has invalid status: " + currentStatus + 
              ", required: " + requiredStatus);
    }
}

// 入金状態不正例外
public class InvalidReceiptStatusException extends BusinessException {
    public InvalidReceiptStatusException(String receiptId, ReceiptStatus currentStatus, ReceiptStatus requiredStatus) {
        super("BILLING_ERR_004", "Receipt " + receiptId + " has invalid status: " + currentStatus + 
              ", required: " + requiredStatus);
    }
}

// 金額不一致例外
public class AmountMismatchException extends BusinessException {
    public AmountMismatchException(String message) {
        super("BILLING_ERR_005", message);
    }
}

// データ整合性例外
public class DataIntegrityException extends BusinessException {
    public DataIntegrityException(String message) {
        super("BILLING_ERR_006", message);
    }
}

// 請求書生成条件不足例外
public class InsufficientInvoiceGenerationDataException extends BusinessException {
    public InsufficientInvoiceGenerationDataException(String message) {
        super("BILLING_ERR_007", message);
    }
}

// 支払生成条件不足例外
public class InsufficientPaymentGenerationDataException extends BusinessException {
    public InsufficientPaymentGenerationDataException(String message) {
        super("BILLING_ERR_008", message);
    }
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- 請求書検索・支払検索は500ms以内にレスポンスを返却すること
- 一括請求書生成処理は1クライアントあたり5秒以内に完了すること
- レポート生成は10秒以内に完了すること
- 請求書ドキュメント生成は3秒以内に完了すること

### 5.2 セキュリティ要件

- 請求書・支払情報へのアクセスは認可制御を行い、適切な権限を持つユーザーのみがアクセス可能とすること
- 請求書・支払金額等の重要な金額データの更新は監査ログを記録すること
- 請求書PDF等のドキュメントは暗号化して保存すること
- 銀行口座情報等の機密情報は暗号化して保存すること

### 5.3 可用性要件

- 請求書発行・請求書ドキュメント生成・支払処理の重要機能は99.9%の可用性を確保すること
- 大量データ処理（月次一括生成等）はバックグラウンドジョブとして実行し、処理状況を確認可能とすること
- システム障害時にも請求書データの整合性を確保するため、トランザクション管理を適切に行うこと

### 5.4 運用保守要件

- 請求書・支払データの変更履歴は最低5年間保持すること
- 請求書ドキュメントは最低7年間保存すること
- 月次バッチ処理のスケジュール管理と実行状況監視機能を提供すること
- 重要な処理（請求書確定、支払実行など）のエラー発生時は管理者に通知すること