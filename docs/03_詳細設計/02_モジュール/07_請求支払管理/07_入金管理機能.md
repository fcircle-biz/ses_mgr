# 入金管理機能

本ドキュメントでは、請求支払管理モジュールの入金管理機能の詳細設計を記述します。入金管理機能は、クライアントからの入金情報を管理するための機能群です。

## 1. 概要

入金管理機能は、クライアントからの入金情報を記録し、請求書と紐付けて管理する機能です。入金情報の登録・管理、請求書への割当、未収金管理などの機能を提供します。

### 1.1 主要機能

- 入金情報の登録・更新・取消
- 入金情報の検索・照会
- 入金と請求書の紐付け管理
- 入金ステータス管理（登録済み、割当済み、取消）
- 未入金請求書の管理
- 入金予定日管理と督促管理

### 1.2 処理フロー概要

1. 入金情報登録
   - 手動登録：ユーザーによる入力で入金情報を登録
   - 銀行データ取込：銀行のCSVデータ等から入金情報を一括登録

2. 請求書との紐付け
   - 入金情報と対応する請求書の紐付け
   - 入金額の割当（部分入金、複数請求書への割当等）

3. 入金状況確認
   - 請求書の入金状況確認
   - 未入金請求書の管理

4. 入金取消
   - 必要に応じて入金情報の取消処理

## 2. 機能詳細設計

### 2.1 入金情報管理

#### 2.1.1 入金情報登録機能

**概要**

クライアントからの入金情報を新規登録する機能です。手動での登録と銀行データからの一括登録の2つの方法をサポートします。

**処理フロー（手動登録）**

1. ユーザーが入金登録画面にアクセス
2. クライアントの選択
3. 入金日の設定
4. 入金金額の入力
5. 入金口座情報の入力
6. 参照番号（振込依頼人番号等）の入力
7. 説明の入力
8. 関連請求書の選択と割当金額の指定（任意）
9. 入金データの保存
10. 関連請求書の入金状況更新（割当がある場合）

**処理フロー（銀行データ取込）**

1. ユーザーが銀行データ取込画面にアクセス
2. 銀行データファイル（CSV等）のアップロード
3. データの解析とマッピング
4. 入金情報の抽出
5. クライアント情報との紐付け（振込依頼人名等から）
6. 入金データの一括保存
7. 未紐付け入金の表示

**バリデーションルール**

- クライアントは必須
- 入金日は必須
- 入金金額は0より大きい値
- 割当金額の合計は入金金額を超えてはならない

**エラー処理**

- クライアントが存在しない場合：ResourceNotFoundException
- 入金金額や割当金額が不正な場合：IllegalArgumentException
- 割当金額の合計が入金金額を超える場合：AmountMismatchException

#### 2.1.2 入金と請求書の紐付け機能

**概要**

登録された入金情報と請求書を紐付ける機能です。

**処理フロー**

1. 対象入金情報の取得
2. 入金ステータスの確認（取消状態でないこと）
3. 紐付け対象請求書の選択
4. 各請求書への割当金額の指定
5. 入金割当データの保存
6. 請求書の入金状況更新
   - 割当金額 < 請求金額の場合：PARTIALLY_PAID
   - 割当金額 ≥ 請求金額の場合：PAID
7. 入金ステータスを「ALLOCATED」に更新（全額割当時）

**ビジネスロジック**

- 入金の未割当残額 = 入金金額 - Σ(割当金額)
- 請求書の未入金残額 = 請求金額 - Σ(割当金額)
- 割当金額の合計は入金金額を超えてはならない
- 請求書への割当金額の合計は請求金額を超えてはならない

**エラー処理**

- 入金情報が存在しない場合：ResourceNotFoundException
- 請求書が存在しない場合：ResourceNotFoundException
- 割当金額が不正な場合：IllegalArgumentException
- 割当金額の合計が入金金額を超える場合：AmountMismatchException

#### 2.1.3 入金情報更新機能

**概要**

登録済みの入金情報を更新する機能です。

**処理フロー**

1. 対象入金情報の取得
2. 入金ステータスの確認（割当済みの場合は限定的な更新のみ可能）
3. 入金情報の更新
   - 入金日の更新
   - 参照番号の更新
   - 説明の更新
4. 更新データの保存

**バリデーションルール**

- 入金日は必須
- 割当済みの入金は金額変更不可

**エラー処理**

- 入金情報が存在しない場合：ResourceNotFoundException
- 入金が取消状態の場合：InvalidReceiptStatusException
- 割当済みの入金に対する禁止操作：BusinessException

#### 2.1.4 入金取消機能

**概要**

登録済みの入金情報を取消状態に変更する機能です。

**処理フロー**

1. 対象入金情報の取得
2. 入金ステータスの確認
3. 関連する入金割当の取得
4. 関連請求書の入金状況の巻き戻し
   - PAID → PARTIALLY_PAID または未入金状態
   - PARTIALLY_PAID → 割当額に応じて更新
5. 入金割当データの削除
6. 入金ステータスを「CANCELED」に変更
7. 取消日時と取消理由の記録
8. 取消情報の保存

**バリデーションルール**

- 取消理由は必須

**エラー処理**

- 入金情報が存在しない場合：ResourceNotFoundException
- 入金が既に取消状態の場合：InvalidReceiptStatusException

#### 2.1.5 入金情報検索機能

**概要**

条件に基づいて入金情報を検索する機能です。

**検索条件**

- クライアントID
- 入金ステータス
- 入金日範囲
- 入金番号
- 入金金額範囲
- 請求書ID（紐付けられた特定の請求書）

**処理フロー**

1. 検索条件の入力
2. バリデーション
3. 検索条件に基づくクエリ構築
4. データベース検索
5. 検索結果の返却（ページネーション対応）

**ソート条件**

- デフォルト：入金日の降順
- ソート可能項目：入金日、入金番号、入金金額、ステータス

**エラー処理**

- 検索条件が不正な場合：IllegalArgumentException
- 検索処理エラー：SystemException

### 2.2 未入金管理

#### 2.2.1 未入金請求書取得機能

**概要**

クライアント毎の未入金請求書を取得する機能です。

**処理フロー**

1. クライアントIDの指定
2. 当該クライアントの請求書検索
   - 条件：ステータスが CONFIRMED, SENT, PARTIALLY_PAID
   - 条件：入金済みでない
3. 支払期限順に整列
4. 検索結果の返却

**ビジネスロジック**

- 支払期限切れの判定：現在日 > 支払期限日
- 一部入金判定：請求金額 > 入金割当合計額

**エラー処理**

- クライアントが存在しない場合：ResourceNotFoundException
- 検索処理エラー：SystemException

#### 2.2.2 請求書入金状況取得機能

**概要**

請求書の入金状況詳細を取得する機能です。

**処理フロー**

1. 請求書IDの指定
2. 請求書情報の取得
3. 関連する入金割当情報の取得
4. 各入金情報の取得
5. 入金状況情報の構築
   - 入金済み金額の計算
   - 未入金残額の計算
   - 入金完了フラグの判定
6. 結果の返却

**ビジネスロジック**

- 入金済み金額 = Σ(割当金額)
- 未入金残額 = 請求金額 - 入金済み金額
- 入金完了判定：未入金残額 ≤ 0

**エラー処理**

- 請求書が存在しない場合：ResourceNotFoundException

#### 2.2.3 入金予定日管理機能

**概要**

入金予定日に基づいて請求書を管理する機能です。

**処理フロー**

1. 期間の指定（任意、デフォルトは当月）
2. 入金予定日が指定期間内の請求書検索
3. クライアント別、入金予定日別にグループ化
4. 入金状況の付加
5. 結果の返却

**ビジネスロジック**

- 入金予定日 = 請求書の支払期限日
- 入金予定額 = 請求金額 - 入金済み金額

**エラー処理**

- 検索条件が不正な場合：IllegalArgumentException
- 検索処理エラー：SystemException

#### 2.2.4 督促管理機能

**概要**

支払期限を超過した未入金請求書を管理し、督促を行うための機能です。

**処理フロー**

1. 督促対象請求書の検索
   - 条件：支払期限 < 現在日
   - 条件：未入金または一部入金
2. 督促状況の付加
   - 最終督促日
   - 督促回数
3. クライアント別、超過日数別にグループ化
4. 結果の返却

**督促機能**

- 督促メール送信
  - テンプレートに基づく督促メール作成
  - 未入金請求書情報の埋め込み
  - メール送信
  - 督促履歴の記録
- 督促状況の更新
  - 督促日の記録
  - 督促回数のインクリメント

**エラー処理**

- 督促処理エラー：BusinessException
- メール送信エラー：SystemException

### 2.3 銀行データ連携

#### 2.3.1 銀行入金データ取込機能

**概要**

銀行が提供する入金データ（振込情報等）を取り込む機能です。

**処理フロー**

1. 銀行データファイル（CSV等）のアップロード
2. ファイルフォーマットの検証
3. データの解析
4. 入金情報への変換
   - 入金日の抽出
   - 入金金額の抽出
   - 振込依頼人情報の抽出
   - 口座情報の抽出
   - 参照番号の抽出
5. クライアント情報との紐付け
   - 振込依頼人名からクライアント推定
   - 参照番号から請求書推定
6. 入金データの一括登録
7. 処理結果の返却

**対応フォーマット**

- 全銀協フォーマット（固定長テキスト）
- CSVフォーマット（汎用）
- 銀行固有フォーマット（主要銀行対応）

**エラー処理**

- ファイルフォーマットが不正な場合：IllegalArgumentException
- データ解析エラー：SystemException
- 入金データ登録エラー：DataIntegrityException

#### 2.3.2 自動紐付け機能

**概要**

取り込んだ入金データを自動的に請求書と紐付ける機能です。

**処理フロー**

1. 未割当入金情報の取得
2. 各入金情報に対する紐付け処理
   - 振込依頼人情報からクライアント特定
   - 参照番号から請求書特定
   - 金額マッチングによる請求書特定
3. 確度に応じた処理分岐
   - 高確度：自動紐付け実行
   - 中確度：紐付け候補の提示
   - 低確度：手動紐付け対象としてマーク
4. 紐付けデータの保存
5. 請求書入金状況の更新
6. 処理結果の返却

**マッチングロジック**

- 参照番号完全一致：請求書番号または顧客管理番号との一致
- 金額完全一致：請求金額と入金金額の一致
- 金額部分一致：複数請求書の合計金額と入金金額の一致
- 依頼人名一致：振込依頼人名とクライアント名の類似度

**エラー処理**

- 紐付け処理エラー：SystemException
- データ不整合：DataIntegrityException

## 3. イベント設計

入金管理機能では、以下のイベントを定義し、他モジュールとの連携を実現します。

### 3.1 発行イベント

| イベント名 | 発行タイミング | 含む情報 | 目的 |
|-----------|--------------|---------|------|
| ReceiptRegisteredEvent | 入金情報登録時 | 入金ID、クライアントID、入金日時、金額 | 入金情報登録の通知 |
| ReceiptAllocatedEvent | 入金割当時 | 入金ID、請求書IDリスト、割当金額リスト | 入金割当の通知 |
| ReceiptCanceledEvent | 入金取消時 | 入金ID、取消理由、取消日時 | 関連処理のキャンセル |
| ReceiptStatusChangedEvent | 入金ステータス変更時 | 入金ID、旧ステータス、新ステータス、変更日時 | ステータス変更の通知 |
| InvoicePaidEvent | 請求書入金完了時 | 請求書ID、入金完了日時 | 請求書入金完了の通知 |

### 3.2 購読イベント

| イベント名 | 発行元 | 処理内容 | 目的 |
|-----------|-------|---------|------|
| InvoiceConfirmedEvent | 請求管理機能 | 未入金請求書リストの更新 | 新規確定請求書の追跡 |
| InvoiceCanceledEvent | 請求管理機能 | 関連する入金割当の確認と対応 | 請求書取消との整合性維持 |
| ClientUpdatedEvent | 顧客管理モジュール | 関連する入金情報の更新確認 | クライアント情報との整合性維持 |

## 4. セキュリティ設計

### 4.1 アクセス制御

入金管理機能に対するアクセス制御は以下のように設定します。

| 操作 | 必要権限 | 説明 |
|-----|---------|------|
| 入金情報閲覧 | ROLE_RECEIPT_VIEW | 入金情報の詳細を閲覧する権限 |
| 入金情報一覧 | ROLE_RECEIPT_LIST | 入金情報の一覧を閲覧する権限 |
| 入金情報登録 | ROLE_RECEIPT_CREATE | 新規入金情報を登録する権限 |
| 入金情報更新 | ROLE_RECEIPT_EDIT | 既存入金情報を更新する権限 |
| 入金紐付け | ROLE_RECEIPT_ALLOCATE | 入金と請求書を紐付ける権限 |
| 入金取消 | ROLE_RECEIPT_CANCEL | 入金情報を取消する権限 |
| 銀行データ取込 | ROLE_RECEIPT_IMPORT | 銀行データを取り込む権限 |
| 督促管理 | ROLE_RECEIPT_REMIND | 支払督促を行う権限 |

### 4.2 データアクセス制限

入金データのクライアント情報保護のため、以下の制限を実装します。

- クライアント担当者は自社の入金情報のみ閲覧可能
- 経理担当者は全クライアントの入金情報を閲覧・編集可能
- 管理者は全ての操作が可能
- 技術者は入金情報へのアクセス不可

### 4.3 機密情報保護

入金に関する機密情報保護のため、以下の対策を実装します。

- 銀行口座情報はデータベース上で暗号化して保存
- 入金金額などの金額情報へのアクセスログ記録
- 銀行データファイルの一時的な保存と安全な削除

## 5. エラー処理設計

入金管理機能では、以下のエラーハンドリングを実装します。

| エラーコード | エラー名 | 説明 | HTTP ステータス |
|------------|--------|------|---------------|
| BILLING_ERR_001 | ResourceNotFoundException | 指定されたリソースが存在しない | 404 Not Found |
| BILLING_ERR_004 | InvalidReceiptStatusException | 入金のステータスが期待される状態でない | 409 Conflict |
| BILLING_ERR_005 | AmountMismatchException | 金額の整合性が取れていない | 400 Bad Request |
| BILLING_ERR_006 | DataIntegrityException | データの整合性制約違反 | 409 Conflict |
| BILLING_ERR_030 | ReceiptImportException | 入金データのインポートに失敗 | 400 Bad Request |
| BILLING_ERR_031 | ReceiptAllocationException | 入金割当処理に失敗 | 400 Bad Request |
| BILLING_ERR_032 | DuplicateReceiptException | 重複する入金情報 | 409 Conflict |

## 6. テスト方針

### 6.1 単体テスト

- 入金登録処理のバリデーションテスト
- 入金割当ロジックのテスト
- 入金状態遷移テスト
- 請求書入金状況更新テスト
- 入金番号採番処理テスト

### 6.2 統合テスト

- 入金登録から請求書紐付けまでの一連の処理テスト
- 銀行データ取込から自動紐付けまでの一連の処理テスト
- 入金取消時の関連請求書状態更新テスト
- 入金と請求書モジュール間の連携テスト

### 6.3 パフォーマンステスト

- 大量入金データの検索性能テスト
- 銀行データの一括取込・処理性能テスト
- 未入金請求書検索の処理時間テスト

## 7. 将来拡張性

入金管理機能は以下の拡張性を考慮して設計します。

### 7.1 多様な入金データフォーマット対応

将来的な新たな銀行データフォーマットへの対応を考慮します。

- 入金データパーサーの抽象化とプラグイン構造
- 新規フォーマット追加が容易な設計
- カスタムパーサーの設定機能

### 7.2 自動紐付けアルゴリズムの拡張

より高度な入金自動紐付け機能の拡張を考慮します。

- 機械学習による紐付けパターン学習
- 複合条件によるマッチングルール
- カスタムマッチングルールの設定機能

### 7.3 複数通貨対応

海外クライアントからの入金に対応するため、複数通貨対応を考慮します。

- 通貨ごとの入金管理
- 為替レート適用ロジック
- 通貨変換履歴の管理