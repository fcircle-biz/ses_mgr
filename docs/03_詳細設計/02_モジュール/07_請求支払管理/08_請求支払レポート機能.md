# 請求支払レポート機能

本ドキュメントでは、請求支払管理モジュールの請求支払レポート機能の詳細設計を記述します。この機能は売上、未収金、支払予定、収支等の財務関連レポートを生成するための機能です。

## 1. 概要

請求支払レポート機能は、請求書・入金・支払のデータを集計・分析し、経営判断に必要な各種財務レポートを提供する機能です。定型レポートに加え、カスタムレポートの作成・管理機能も提供します。

### 1.1 主要機能

- 売上レポート生成
- 未収金レポート生成
- 支払予定レポート生成
- 収支レポート生成
- カスタムレポート作成・管理
- レポートデータのエクスポート
- レポートの自動配信

### 1.2 処理フロー概要

1. レポート条件指定
   - レポート種別の選択
   - 期間・対象の指定
   - 表示項目・集計条件の設定

2. データ集計処理
   - 条件に基づくデータ抽出
   - 集計・分析処理

3. レポート生成
   - レポートフォーマットへの適用
   - グラフ・表の生成

4. レポート利用
   - 画面表示
   - エクスポート
   - 配信

## 2. 機能詳細設計

### 2.1 売上レポート

#### 2.1.1 売上レポート生成機能

**概要**

請求データに基づいて期間別・クライアント別等の売上情報を集計し、レポートを生成する機能です。

**処理フロー**

1. レポート条件の指定
   - 年・月の指定（月を0とした場合は年次）
   - クライアントID（任意、未指定時は全クライアント）
2. 請求データの取得
   - 指定期間内に確定された請求書を取得
   - 取消された請求書は除外
3. 集計処理
   - 月次集計（月次レポートの場合）
   - クライアント別集計
   - 案件別集計（オプション）
4. 前年同期比較（オプション）
5. レポートデータの構築
6. レポートID生成と保存
7. 結果の返却

**集計ロジック**

- 月次売上：当該月に確定した請求書の合計金額
- 年次売上：当該年の各月の売上合計
- クライアント別売上：対象期間内の各クライアントの請求金額合計
- 前年同期比：当期売上 ÷ 前年同期売上 × 100

**返却データ**

- 集計期間情報（年・月）
- 対象クライアント情報
- 合計売上金額（税抜、税額、税込）
- 月別売上推移データ（年次の場合）
- クライアント別売上データ
- 前年同期比較データ（要求時）
- グラフ表示用データセット

**エラー処理**

- 期間指定が不正な場合：IllegalArgumentException
- クライアントが存在しない場合：ResourceNotFoundException
- データ取得エラー：SystemException

#### 2.1.2 売上傾向分析機能

**概要**

売上データの推移を分析し、傾向・予測情報を提供する機能です。

**処理フロー**

1. 分析期間の指定（デフォルトは過去12ヶ月）
2. 期間内の月次売上データ取得
3. 傾向分析処理
   - 移動平均の計算
   - 成長率の計算
   - 季節変動の分析
4. 予測処理（オプション）
   - 時系列分析に基づく将来予測
   - 信頼区間の計算
5. 分析結果の構築
6. 結果の返却

**分析ロジック**

- 前月比成長率：当月売上 ÷ 前月売上 - 1
- 前年同月比成長率：当月売上 ÷ 前年同月売上 - 1
- 3ヶ月移動平均：直近3ヶ月の売上平均
- トレンド分析：線形回帰による傾向分析

**返却データ**

- 分析期間情報
- 月次売上推移データ
- 成長率データ
- 移動平均データ
- トレンド分析結果
- 予測データ（要求時）
- グラフ表示用データセット

**エラー処理**

- 期間指定が不正な場合：IllegalArgumentException
- 分析に必要な十分なデータが存在しない場合：InsufficientDataException
- 分析処理エラー：SystemException

### 2.2 未収金レポート

#### 2.2.1 未収金レポート生成機能

**概要**

請求・入金データに基づいて未収金情報を集計し、レポートを生成する機能です。

**処理フロー**

1. レポート条件の指定
   - 基準日の指定（デフォルトは現在日）
   - クライアントID（任意、未指定時は全クライアント）
2. 未入金請求書データの取得
   - 基準日時点で未入金または一部入金の請求書
   - 取消された請求書は除外
3. 集計処理
   - クライアント別集計
   - 期間経過別集計（エイジング分析）
4. レポートデータの構築
5. レポートID生成と保存
6. 結果の返却

**集計ロジック**

- 未収金額：請求金額 - 入金済み金額
- エイジング分析：未収金を支払期限からの経過日数で分類
  - 期限内：支払期限 >= 基準日
  - 1-30日延滞：基準日 - 支払期限 が 1-30日
  - 31-60日延滞：基準日 - 支払期限 が 31-60日
  - 61-90日延滞：基準日 - 支払期限 が 61-90日
  - 90日超延滞：基準日 - 支払期限 が 91日以上

**返却データ**

- 基準日情報
- 対象クライアント情報
- 未収金総額
- クライアント別未収金データ
- エイジングバケット別金額データ
- 未収金詳細リスト（請求書単位）
- グラフ表示用データセット

**エラー処理**

- 基準日指定が不正な場合：IllegalArgumentException
- クライアントが存在しない場合：ResourceNotFoundException
- データ取得エラー：SystemException

#### 2.2.2 回収予定レポート生成機能

**概要**

未収金の回収予定を分析し、将来の入金予測レポートを生成する機能です。

**処理フロー**

1. レポート条件の指定
   - 予測期間の指定（デフォルトは今後3ヶ月）
   - クライアントID（任意、未指定時は全クライアント）
2. 未入金請求書データの取得
3. クライアント別支払履歴データの取得
4. 回収予測処理
   - 支払期限ベースの予測
   - 過去の支払実績ベースの予測
5. レポートデータの構築
6. 結果の返却

**予測ロジック**

- 支払期限ベース：請求書の支払期限日に基づく予測
- 実績ベース：クライアントの過去の支払実績（平均遅延日数等）を考慮した予測

**返却データ**

- 予測期間情報
- 週次・月次の回収予定金額
- クライアント別回収予定データ
- 確度別の回収予測（高・中・低）
- グラフ表示用データセット

**エラー処理**

- 期間指定が不正な場合：IllegalArgumentException
- 予測に必要な十分なデータが存在しない場合：InsufficientDataException

### 2.3 支払予定レポート

#### 2.3.1 支払予定レポート生成機能

**概要**

支払情報に基づいて期間別・技術者別等の支払予定情報を集計し、レポートを生成する機能です。

**処理フロー**

1. レポート条件の指定
   - 期間の指定（開始日・終了日）
   - 技術者ID（任意、未指定時は全技術者）
2. 支払予定データの取得
   - 指定期間内に支払予定日がある支払情報
   - 取消された支払は除外
3. 集計処理
   - 日付別集計
   - 技術者別集計
   - 契約別集計（オプション）
4. レポートデータの構築
5. レポートID生成と保存
6. 結果の返却

**集計ロジック**

- 日付別支払予定額：当該日の支払予定額合計
- 週次支払予定額：当該週の支払予定額合計
- 月次支払予定額：当該月の支払予定額合計
- 技術者別支払予定額：対象期間内の各技術者への支払予定額合計

**返却データ**

- 集計期間情報（開始日・終了日）
- 対象技術者情報
- 総支払予定額
- 日付別支払予定データ
- 技術者別支払予定データ
- 支払予定詳細リスト
- グラフ表示用データセット

**エラー処理**

- 期間指定が不正な場合：IllegalArgumentException
- 技術者が存在しない場合：ResourceNotFoundException
- データ取得エラー：SystemException

#### 2.3.2 支払実績レポート生成機能

**概要**

過去の支払実績を集計し、レポートを生成する機能です。

**処理フロー**

1. レポート条件の指定
   - 期間の指定（開始日・終了日）
   - 技術者ID（任意、未指定時は全技術者）
2. 支払実績データの取得
   - 指定期間内に実行された支払情報
   - 取消された支払は除外
3. 集計処理
   - 月次集計
   - 技術者別集計
   - 契約別集計（オプション）
4. レポートデータの構築
5. 結果の返却

**集計ロジック**

- 月次支払実績：当該月に実行された支払額合計
- 技術者別支払実績：対象期間内の各技術者への支払額合計
- 技術者平均支払額：技術者別支払実績 ÷ 対象期間の月数

**返却データ**

- 集計期間情報（開始日・終了日）
- 対象技術者情報
- 総支払実績額
- 月次支払実績データ
- 技術者別支払実績データ
- 支払実績詳細リスト
- グラフ表示用データセット

**エラー処理**

- 期間指定が不正な場合：IllegalArgumentException
- 技術者が存在しない場合：ResourceNotFoundException
- データ取得エラー：SystemException

### 2.4 収支レポート

#### 2.4.1 収支レポート生成機能

**概要**

請求データと支払データに基づいて収益・費用・利益等の収支情報を集計し、レポートを生成する機能です。

**処理フロー**

1. レポート条件の指定
   - 年・月の指定（月を0とした場合は年次）
2. 売上データ取得
   - 指定期間内に確定された請求書データ
3. 費用データ取得
   - 指定期間内に実行された支払データ
   - その他費用データ（オプション）
4. 収支計算処理
   - 売上集計
   - 費用集計
   - 粗利計算
   - 粗利率計算
5. レポートデータの構築
6. レポートID生成と保存
7. 結果の返却

**計算ロジック**

- 売上：確定請求書の合計金額
- 技術者費用：実行された支払の合計金額
- その他費用：経費等のその他費用（オプション）
- 総費用：技術者費用 + その他費用
- 粗利：売上 - 総費用
- 粗利率：粗利 ÷ 売上 × 100

**返却データ**

- 集計期間情報（年・月）
- 総売上額
- 総費用額
- 粗利額
- 粗利率
- 月別収支推移データ（年次の場合）
- 項目別費用内訳
- グラフ表示用データセット

**エラー処理**

- 期間指定が不正な場合：IllegalArgumentException
- データ取得エラー：SystemException

#### 2.4.2 収益性分析機能

**概要**

収支データに基づいて収益性を分析し、レポートを生成する機能です。

**処理フロー**

1. 分析条件の指定
   - 期間の指定
   - 分析軸の指定（クライアント別、案件別、技術者別等）
2. 収支データの取得
3. 分析処理
   - 分析軸ごとの収支計算
   - 収益性指標の計算
   - ランキング処理
4. レポートデータの構築
5. 結果の返却

**分析ロジック**

- クライアント別収益性：クライアント別の売上、費用、利益、利益率
- 案件別収益性：案件別の売上、費用、利益、利益率
- 技術者別収益性：技術者が関わる案件の売上、技術者への支払、差額
- 収益性ランキング：利益率に基づくランキング

**返却データ**

- 分析期間情報
- 分析軸情報
- 収益性指標データ（分析軸ごと）
- 収益性ランキングデータ
- クロス集計データ
- グラフ表示用データセット

**エラー処理**

- 期間指定が不正な場合：IllegalArgumentException
- 分析に必要な十分なデータが存在しない場合：InsufficientDataException
- 分析処理エラー：SystemException

### 2.5 カスタムレポート

#### 2.5.1 カスタムレポート作成機能

**概要**

ユーザーの要件に合わせたカスタムレポートを作成・保存する機能です。

**処理フロー**

1. レポート定義情報の入力
   - レポート名
   - レポート種別
   - パラメータ設定
2. データソースの選択
   - 請求データ
   - 入金データ
   - 支払データ
   - 複合データ
3. 表示項目の選択
   - 集計項目
   - 表示項目
   - グループ化条件
   - フィルタ条件
   - ソート条件
4. レポートレイアウトの設定
   - テーブル形式
   - グラフ種別
   - 表示オプション
5. レポート定義の保存
6. サンプルデータによるプレビュー生成
7. 結果の返却

**レポート種別**

- 表形式レポート：テーブル形式の詳細データ
- 集計レポート：グループ化と集計関数によるサマリーデータ
- グラフレポート：可視化グラフを中心としたレポート
- クロスタブレポート：行・列のクロス集計
- 複合レポート：複数の形式を組み合わせたレポート

**データ操作**

- グループ化：指定フィールドでのグループ化
- 集計関数：合計、平均、最大、最小、カウント等
- フィルタ：条件に基づくデータのフィルタリング
- ソート：指定フィールドでのソート

**エラー処理**

- レポート定義が不正な場合：IllegalArgumentException
- 選択されたデータソースにアクセスできない場合：AccessDeniedException
- 定義保存エラー：SystemException

#### 2.5.2 カスタムレポート実行機能

**概要**

保存されたカスタムレポート定義に基づいてレポートを実行し、結果を生成する機能です。

**処理フロー**

1. レポートIDの指定
2. 実行パラメータの指定
3. レポート定義の取得
4. データソースからのデータ取得
5. 定義に基づくデータ処理
   - フィルタリング
   - グループ化
   - 集計
   - ソート
6. レポート結果の生成
   - テーブルデータ
   - グラフデータ
   - 集計結果
7. レポートID生成と保存
8. 結果の返却

**処理性能対策**

- 大量データ処理時のページング
- 実行時間の長いレポートの非同期実行
- 結果キャッシュの活用
- 事前集計データの活用

**エラー処理**

- レポート定義が存在しない場合：ResourceNotFoundException
- パラメータが不正な場合：IllegalArgumentException
- データ取得エラー：SystemException
- 処理タイムアウト：TimeoutException

#### 2.5.3 レポートテンプレート管理機能

**概要**

カスタムレポートのテンプレートを管理する機能です。

**処理フロー**

1. テンプレート操作の選択
   - テンプレート作成
   - テンプレート更新
   - テンプレート削除
   - テンプレート一覧取得
2. テンプレート情報の入力
   - テンプレート名
   - 説明
   - レポート定義
   - 共有設定
3. テンプレートの保存
4. 結果の返却

**テンプレート共有設定**

- 個人用：作成者のみ使用可能
- 部門共有：特定部門内で共有
- 全体共有：システム全体で共有

**エラー処理**

- テンプレートが存在しない場合：ResourceNotFoundException
- 権限エラー：AccessDeniedException
- 保存エラー：SystemException

### 2.6 レポートエクスポート・配信

#### 2.6.1 レポートエクスポート機能

**概要**

生成されたレポートを指定形式でエクスポートする機能です。

**処理フロー**

1. レポートIDの指定
2. エクスポート形式の指定
   - PDF
   - Excel
   - CSV
3. レポートデータの取得
4. 指定形式への変換処理
5. ファイル生成
6. ダウンロードURLの生成
7. 結果の返却

**エクスポート形式と特性**

- PDF：印刷向け、レイアウト固定、グラフ・表を含む
- Excel：データ分析向け、ピボットテーブル、数式を含む
- CSV：データ交換向け、プレーンテキスト、他システム連携用

**エラー処理**

- レポートが存在しない場合：ResourceNotFoundException
- 形式指定が不正な場合：IllegalArgumentException
- エクスポート処理エラー：SystemException

#### 2.6.2 レポート自動配信機能

**概要**

レポートを定期的に生成し、指定された宛先に自動配信する機能です。

**処理フロー**

1. 配信設定情報の入力
   - レポートID
   - 配信スケジュール（日次、週次、月次等）
   - 配信先設定
   - 配信形式
2. 配信設定の保存
3. スケジューラーへの登録
4. 配信実行
   - スケジュールに基づくレポート生成
   - 指定形式へのエクスポート
   - 配信処理の実行
   - 配信履歴の記録
5. 結果通知

**配信方法**

- メール配信：添付ファイルまたはリンク
- システム通知：ダッシュボードへの通知
- 共有フォルダ：指定フォルダへの保存

**エラー処理**

- 配信設定が不正な場合：IllegalArgumentException
- レポート生成エラー：ReportGenerationException
- 配信処理エラー：DeliveryException

## 3. イベント設計

請求支払レポート機能では、以下のイベントを定義し、他モジュールとの連携を実現します。

### 3.1 発行イベント

| イベント名 | 発行タイミング | 含む情報 | 目的 |
|-----------|--------------|---------|------|
| ReportGeneratedEvent | レポート生成時 | レポートID、種別、生成日時 | レポート生成の通知 |
| ReportExportedEvent | レポートエクスポート時 | レポートID、形式、エクスポート日時 | エクスポート完了の通知 |
| ReportDeliveredEvent | レポート配信時 | レポートID、配信先、配信日時 | 配信完了の通知 |
| CustomReportCreatedEvent | カスタムレポート作成時 | レポートID、作成者ID、作成日時 | カスタムレポート作成の通知 |

### 3.2 購読イベント

| イベント名 | 発行元 | 処理内容 | 目的 |
|-----------|-------|---------|------|
| InvoiceConfirmedEvent | 請求管理機能 | 売上レポートの更新検討 | 売上データの鮮度確保 |
| PaymentExecutedEvent | 支払管理機能 | 支払実績レポートの更新検討 | 支払データの鮮度確保 |
| ReceiptRegisteredEvent | 入金管理機能 | 未収金レポートの更新検討 | 未収金データの鮮度確保 |
| MonthClosedEvent | 会計モジュール | 月次レポートの自動生成 | 月次締め処理との連携 |

## 4. セキュリティ設計

### 4.1 アクセス制御

請求支払レポート機能に対するアクセス制御は以下のように設定します。

| 操作 | 必要権限 | 説明 |
|-----|---------|------|
| 売上レポート閲覧 | ROLE_REPORT_SALES_VIEW | 売上レポートを閲覧する権限 |
| 未収金レポート閲覧 | ROLE_REPORT_RECEIVABLE_VIEW | 未収金レポートを閲覧する権限 |
| 支払レポート閲覧 | ROLE_REPORT_PAYMENT_VIEW | 支払レポートを閲覧する権限 |
| 収支レポート閲覧 | ROLE_REPORT_PROFIT_VIEW | 収支レポートを閲覧する権限 |
| カスタムレポート作成 | ROLE_REPORT_CUSTOM_CREATE | カスタムレポートを作成する権限 |
| カスタムレポート実行 | ROLE_REPORT_CUSTOM_EXECUTE | カスタムレポートを実行する権限 |
| レポートエクスポート | ROLE_REPORT_EXPORT | レポートをエクスポートする権限 |
| レポート配信設定 | ROLE_REPORT_DELIVERY_MANAGE | レポート配信を設定する権限 |

### 4.2 データアクセス制限

レポートの機密情報保護のため、以下の制限を実装します。

- 役割に応じたレポート閲覧制限
  - 営業担当者：担当クライアントの売上・未収金レポートのみ閲覧可能
  - 技術管理者：担当技術者の支払レポートのみ閲覧可能
  - 経理担当者：全てのレポートを閲覧可能
  - 経営者：全てのレポートを閲覧可能
- 機密データの項目レベルでのマスキング
  - 役割に応じて特定の金額項目を「***」で表示
  - 集計値のみ表示し詳細データを非表示

### 4.3 監査ログ

レポート機能の利用状況を監査するため、以下のログを記録します。

- レポート生成ログ：誰が、いつ、どのレポートを生成したか
- レポート閲覧ログ：誰が、いつ、どのレポートを閲覧したか
- レポートエクスポートログ：誰が、いつ、どのレポートを、どの形式でエクスポートしたか
- カスタムレポート操作ログ：誰が、いつ、どのようなカスタムレポートを作成・編集・削除したか

## 5. エラー処理設計

請求支払レポート機能では、以下のエラーハンドリングを実装します。

| エラーコード | エラー名 | 説明 | HTTP ステータス |
|------------|--------|------|---------------|
| REPORT_ERR_001 | ReportNotFoundException | 指定されたレポートが存在しない | 404 Not Found |
| REPORT_ERR_002 | InvalidReportParameterException | レポートパラメータが不正 | 400 Bad Request |
| REPORT_ERR_003 | ReportGenerationException | レポート生成処理エラー | 500 Internal Server Error |
| REPORT_ERR_004 | ReportExportException | レポートエクスポート処理エラー | 500 Internal Server Error |
| REPORT_ERR_005 | InsufficientDataException | レポート生成に必要なデータが不足 | 400 Bad Request |
| REPORT_ERR_006 | ReportDeliveryException | レポート配信処理エラー | 500 Internal Server Error |
| REPORT_ERR_007 | CustomReportDefinitionException | カスタムレポート定義エラー | 400 Bad Request |
| REPORT_ERR_008 | ReportTimeoutException | レポート処理タイムアウト | 503 Service Unavailable |

## 6. テスト方針

### 6.1 単体テスト

- レポート生成ロジックのテスト
- データ集計ロジックのテスト
- フィルタ・グループ化処理のテスト
- エクスポート処理のテスト
- カスタムレポート定義処理のテスト

### 6.2 統合テスト

- 実データに基づくレポート生成テスト
- レポート生成から配信までの一連の処理テスト
- 大量データでのパフォーマンステスト
- 権限制御テスト

### 6.3 ユーザー受入テスト

- 各種レポートの表示内容の正確性確認
- エクスポートしたレポートの形式・内容確認
- カスタムレポート作成・実行の使いやすさ確認
- レポート配信の正確性確認

## 7. 将来拡張性

請求支払レポート機能は以下の拡張性を考慮して設計します。

### 7.1 高度な分析機能

将来的なビジネスインテリジェンス強化のための拡張ポイントを用意します。

- データウェアハウスとの連携
- OLAPキューブの活用
- 機械学習による予測分析
- 異常検知機能

### 7.2 ダッシュボード機能

経営ダッシュボードとの連携を見据えた拡張性を考慮します。

- ウィジェット形式のレポート部品化
- リアルタイムデータ更新
- インタラクティブなフィルタリング
- ドリルダウン分析

### 7.3 外部システム連携

会計システムなど外部システムとの連携強化を考慮します。

- 標準形式（XBRL等）でのデータエクスポート
- API連携による自動データ同期
- 外部システムのレポート埋め込み