# 技術者基本情報管理機能

## 1. 機能概要

技術者基本情報管理機能は、SES業務システムにおいて、技術者（エンジニア）の基本情報を登録・更新・照会・削除するための機能を提供します。技術者の属性情報（氏名、連絡先、雇用情報など）を一元管理し、他の機能モジュールに技術者基本情報を提供する役割を担います。

### 主な責務
- 技術者の基本情報の登録・更新・削除・照会
- 技術者情報の検証とバリデーション
- 技術者情報の一覧表示と検索
- 技術者情報の変更履歴管理
- 技術者情報へのアクセス制御

## 2. 主要コンポーネント構成

技術者基本情報管理機能は、以下の主要コンポーネントから構成されます。

### 2.1 EngineerController

技術者基本情報のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- REST API経由での技術者情報のCRUD操作の受付
- リクエストのバリデーション
- レスポンスの整形と返却
- エラーハンドリング

### 2.2 EngineerService

技術者基本情報のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- 技術者情報の登録・更新・削除・照会のビジネスロジック実装
- 技術者情報のビジネスルール検証
- トランザクション管理
- ドメインイベントの発行
- 関連モジュールとの連携

### 2.3 EngineerRepository

技術者情報のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- 技術者情報のデータベース操作（CRUD）
- 複雑な検索条件によるクエリ実行
- データベースとのマッピング
- パフォーマンス最適化

### 2.4 EngineerValidator

技術者情報のバリデーションを行うコンポーネントです。

**主な責務:**
- 技術者情報の整合性チェック
- ビジネスルールに基づくバリデーション
- 重複データチェック
- データ型・形式の検証

### 2.5 EngineerEventPublisher

技術者情報の変更に関するイベントを発行するコンポーネントです。

**主な責務:**
- 技術者登録・更新・削除イベントの発行
- イベントデータの構築
- イベント配信の確実性確保

## 3. 処理フロー

技術者基本情報管理機能における主要な処理フローを説明します。

### 3.1 技術者情報登録フロー

1. クライアントが技術者登録APIを呼び出し、技術者情報を送信
2. EngineerControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. EngineerValidatorが技術者情報の詳細バリデーションを実行
   - 必須項目のチェック
   - データ形式の検証（メールアドレス、電話番号など）
   - 重複チェック（社員コードなど）
4. EngineerServiceが技術者情報のビジネスロジックを処理
   - 技術者エンティティの生成
   - ビジネスルールの適用
5. EngineerRepositoryが技術者情報をデータベースに保存
6. EngineerEventPublisherが技術者登録イベントを発行
7. EngineerControllerが結果をクライアントに返却

### 3.2 技術者情報更新フロー

1. クライアントが技術者更新APIを呼び出し、更新対象のIDと更新情報を送信
2. EngineerControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. EngineerServiceが対象の技術者情報をリポジトリから取得
4. 対象技術者が存在しない場合はエラーを返却
5. EngineerValidatorが更新情報の詳細バリデーションを実行
6. EngineerServiceが技術者情報の更新ロジックを処理
   - 更新対象フィールドの判定
   - ビジネスルールの適用
   - 更新履歴の記録
7. EngineerRepositoryが更新された技術者情報をデータベースに保存
8. EngineerEventPublisherが技術者更新イベントを発行
9. EngineerControllerが結果をクライアントに返却

### 3.3 技術者情報照会フロー

1. クライアントが技術者照会APIを呼び出し、技術者IDを指定
2. EngineerControllerがリクエストを受け取り、パラメータをバリデーション
3. EngineerServiceが対象の技術者情報をリポジトリから取得
4. 対象技術者が存在しない場合はエラーを返却
5. 必要に応じて関連情報（部署情報など）を取得して結合
6. EngineerControllerが技術者情報をレスポンスとして整形
7. クライアントに技術者情報を返却

### 3.4 技術者情報一覧取得フロー

1. クライアントが技術者一覧APIを呼び出し、検索条件とページネーション情報を送信
2. EngineerControllerがリクエストを受け取り、パラメータをバリデーション
3. EngineerServiceが検索条件に基づく一覧取得ロジックを実行
4. EngineerRepositoryが検索条件に合致する技術者情報の一覧とカウントを取得
5. 各技術者情報に必要な関連情報を付加
6. EngineerControllerが技術者情報一覧とページネーション情報をレスポンスとして整形
7. クライアントに技術者情報一覧を返却

### 3.5 技術者情報削除フロー（論理削除）

1. クライアントが技術者削除APIを呼び出し、削除対象のIDを送信
2. EngineerControllerがリクエストを受け取り、パラメータをバリデーション
3. EngineerServiceが対象の技術者情報をリポジトリから取得
4. 対象技術者が存在しない場合はエラーを返却
5. 削除前の検証（関連データの確認など）を実行
6. EngineerServiceが技術者情報の論理削除ロジックを処理（ステータスの更新）
7. EngineerRepositoryが更新された技術者情報をデータベースに保存
8. EngineerEventPublisherが技術者削除イベントを発行
9. EngineerControllerが結果をクライアントに返却

## 4. データモデル参照

技術者基本情報管理機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティと値オブジェクトを扱います。

- 技術者 (Engineer) エンティティ
- 住所 (Address) 値オブジェクト
- 金額 (Money) 値オブジェクト

## 5. バリデーションルール

技術者基本情報に適用されるバリデーションルールは以下の通りです。

### 5.1 基本情報バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| employeeCode | 必須、英数字のみ、最大20文字、システム内で一意 |
| lastName, firstName | 必須、最大100文字 |
| lastNameKana, firstNameKana | 必須、カタカナのみ、最大100文字 |
| gender | 必須、定義された列挙値のいずれか |
| birthDate | 必須、過去の日付、年齢が15歳以上65歳以下 |
| emailAddress | 必須、有効なメールアドレス形式、最大256文字 |
| phoneNumber | 必須、有効な電話番号形式（国際形式または国内形式） |

### 5.2 住所バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| postalCode | 必須、有効な郵便番号形式 |
| prefecture | 必須、日本の都道府県名 |
| city | 必須、最大100文字 |
| street | 必須、最大100文字 |
| building | 任意、最大100文字 |

### 5.3 雇用情報バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| companyId | 必須、存在する会社ID |
| departmentId | 必須、存在する部署ID |
| employmentType | 必須、定義された列挙値のいずれか |
| employmentStatus | 必須、定義された列挙値のいずれか |
| joinDate | 必須、過去の日付または現在の日付 |
| leaveDate | 退職の場合必須、joinDateより後の日付 |
| primaryJobType | 必須、定義された列挙値のいずれか |

### 5.4 業務情報バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| yearsOfExperience | 必須、0以上の整数 |
| unitPrice | 必須、0より大きい金額 |
| unitPriceMin | 指定された場合、0より大きく、unitPrice以下の金額 |
| note | 任意、最大1000文字 |

## 6. 例外処理

技術者基本情報管理機能における主な例外処理は以下の通りです。

### 6.1 バリデーション例外

- **InvalidEngineerDataException**: 技術者データが無効な場合にスローされる例外
  - 処理: クライアントにバリデーションエラーの詳細を返却

### 6.2 重複例外

- **DuplicateEmployeeCodeException**: 社員コードが既に存在する場合にスローされる例外
  - 処理: クライアントに重複エラーメッセージを返却

### 6.3 リソース未検出例外

- **EngineerNotFoundException**: 指定されたIDの技術者が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 6.4 ビジネスルール違反例外

- **BusinessRuleViolationException**: ビジネスルールに違反する操作が行われた場合にスローされる例外
  - 処理: クライアントにビジネスルール違反の詳細を返却

### 6.5 データベース例外

- **DataAccessException**: データベースアクセス中にエラーが発生した場合にスローされる例外
  - 処理: ログに詳細を記録し、クライアントに一般的なエラーメッセージを返却

### 6.6 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. バリデーション例外は詳細なエラー情報をクライアントに返却
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. トランザクション管理による整合性の確保

## 7. セキュリティ考慮事項

技術者基本情報管理機能における主なセキュリティ考慮事項は以下の通りです。

### 7.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- 技術者情報の操作には以下の権限が必要
  - 照会: `ENGINEER_VIEW` 権限
  - 登録: `ENGINEER_CREATE` 権限
  - 更新: `ENGINEER_UPDATE` 権限
  - 削除: `ENGINEER_DELETE` 権限
- 部署単位のアクセス制御を適用し、自部署の技術者情報のみアクセス可能とする設定も可能

### 7.2 データ保護

- 個人情報（生年月日、住所など）は保存時に暗号化
- パーソナルデータへのアクセスは監査ログに記録
- レスポンスデータの機密項目はマスキングオプションを提供

### 7.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- SQLインジェクション対策としてパラメータ化クエリを使用
- クロスサイトスクリプティング対策として出力エスケープを実施

### 7.4 監査証跡

- 技術者情報の重要な操作（登録、更新、削除）はすべて監査ログに記録
- 監査ログには以下の情報を含める
  - 操作を行ったユーザーID
  - 操作の種類（登録、更新、削除、照会）
  - 操作の対象（技術者ID）
  - 操作の日時
  - 操作のIPアドレス
  - 変更前後の値（更新の場合）

## 8. パフォーマンス最適化

技術者基本情報管理機能におけるパフォーマンス最適化策は以下の通りです。

### 8.1 データベース最適化

- 頻繁に検索される項目（社員コード、氏名、部署IDなど）にインデックスを作成
- 大量データの一覧取得にはページネーションを必須とする
- N+1問題を回避するためのJOINフェッチ戦略の採用

### 8.2 キャッシング戦略

- 技術者基本情報（変更頻度の低いデータ）のキャッシング
- キャッシュの有効期間: 10分
- 更新操作時のキャッシュ無効化処理

### 8.3 クエリ最適化

- 技術者一覧取得時に必要最小限のフィールドのみを取得
- 複雑な検索条件に対応するための動的クエリビルダーの活用
- 集計クエリの最適化（COUNT最適化など）

### 8.4 バッチ処理

- 一括登録・更新操作はバッチ処理で効率化
- バルクインサート/アップデートの活用
- バッチサイズの最適化（500件単位など）

## 9. 監視とロギング

技術者基本情報管理機能における監視とロギングの方針は以下の通りです。

### 9.1 ロギング方針

- INFO レベル: 通常の操作ログ（技術者登録、更新、削除など）
- WARN レベル: 潜在的な問題（バリデーションエラー、権限不足など）
- ERROR レベル: 例外と障害（データベース接続エラー、未処理例外など）
- DEBUG レベル: 開発・トラブルシューティング用の詳細ログ

### 9.2 監視指標

- API応答時間
- エラー率（4xx, 5xxレスポンス）
- 技術者情報操作の頻度（登録数、更新数、検索数）
- データベースクエリのパフォーマンス
- アクティブセッション数

### 9.3 アラート条件

- API応答時間が閾値（2秒）を超えた場合
- エラー率が閾値（5%）を超えた場合
- 同一IPからの大量リクエスト（DoS対策）
- データベースコネクションプールの枯渇
- ディスク使用率の閾値超過

## 10. インターフェース連携

技術者基本情報管理機能と他モジュールとのインターフェース連携について説明します。

### 10.1 マッチングモジュールとの連携

- 技術者の基本情報・スキル情報をマッチングエンジンに提供
- 稼働可能な技術者の絞り込み条件を受け取り、該当技術者を検索
- マッチング成立時に技術者の稼働状況更新

### 10.2 契約管理モジュールとの連携

- 契約対象の技術者情報を契約書生成に提供
- 契約成立時の技術者稼働情報の更新

### 10.3 勤怠工数管理モジュールとの連携

- 勤怠入力対象者情報の提供
- 勤怠情報と稼働状況の整合性確認

### 10.4 レポーティングモジュールとの連携

- 技術者情報の統計データの提供
- 稼働率・スキル分布等の分析データの提供

## 11. テスト方針

技術者基本情報管理機能のテスト方針は以下の通りです。

### 11.1 単体テスト

- EngineerServiceのすべてのパブリックメソッドに対するテスト
- バリデーションロジックの網羅的テスト
- 例外処理の動作検証

### 11.2 統合テスト

- コントローラーからリポジトリまでの連携テスト
- データベースとの連携テスト（実DBまたはインメモリDB使用）
- イベント発行と受信の連携テスト

### 11.3 API テスト

- すべてのAPIエンドポイントに対する正常系・異常系テスト
- 権限による動作の違いを検証
- パフォーマンステスト（応答時間、同時アクセス）

### 11.4 負荷テスト

- 大量データ（1万件以上）での一覧取得・検索のパフォーマンス
- 同時アクセス（100ユーザー）時の応答性能
- 長時間稼働時のリソース使用状況