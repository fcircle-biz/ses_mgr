# スキルシート管理機能

## 1. 機能概要

スキルシート管理機能は、SES業務システムにおいて技術者のスキルシート（職務経歴書）を作成・管理・共有するための機能です。技術者の基本情報、スキル情報、職務経歴を統合し、案件提案や顧客説明のための標準化されたドキュメントを提供します。

### 主な責務
- スキルシートの自動生成機能
- スキルシートの版管理
- スキルシートテンプレートの管理
- スキルシートの承認フロー管理
- スキルシートのエクスポート機能（PDF、Word等）
- スキルシートの共有と権限管理
- スキルシートの検索機能

## 2. 主要コンポーネント構成

スキルシート管理機能は、以下の主要コンポーネントから構成されます。

### 2.1 SkillSheetController

スキルシート管理のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- スキルシート関連操作のREST APIエンドポイント提供
- リクエストのバリデーション
- レスポンスの整形と返却
- エラーハンドリング

### 2.2 SkillSheetService

スキルシート管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- スキルシートの生成・更新・削除・参照のビジネスロジック実装
- スキルシートの承認フロー管理
- スキルシートのバージョン管理
- スキルシートのエクスポート処理
- ドメインイベントの発行

### 2.3 SkillSheetGenerationService

スキルシートの生成ロジックを実装するサービスコンポーネントです。

**主な責務:**
- テンプレートに基づくスキルシート生成
- 技術者情報の統合
- スキル情報の統合
- 職務経歴の統合と整形
- HTML/DOCXフォーマット処理

### 2.4 SkillSheetRepository

スキルシート情報のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- スキルシート情報のデータベース操作（CRUD）
- スキルシート検索クエリの実行
- バージョン管理のサポート
- データベースとのマッピング

### 2.5 SkillSheetTemplateRepository

スキルシートテンプレートのデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- テンプレート情報のデータベース操作（CRUD）
- テンプレート検索
- テンプレートのアクティブ管理

### 2.6 SkillSheetExportService

スキルシートのエクスポート機能を実装するサービスコンポーネントです。

**主な責務:**
- スキルシートのPDF変換
- スキルシートのWord形式変換
- スキルシートの印刷用フォーマット生成
- マスキング処理（個人情報保護）

### 2.7 SkillSheetShareService

スキルシートの共有機能を実装するサービスコンポーネントです。

**主な責務:**
- 共有リンクの生成と管理
- 共有権限の制御
- 共有期限の管理
- 共有アクセスログの記録

## 3. 処理フロー

スキルシート管理機能における主要な処理フローを説明します。

### 3.1 スキルシート生成フロー

1. クライアントがスキルシート生成APIを呼び出し、技術者IDとテンプレートID、オプション設定を送信
2. SkillSheetControllerがリクエストを受け取り、パラメータをバリデーション
3. SkillSheetGenerationServiceが以下の情報を収集
   - EngineerServiceから技術者基本情報を取得
   - SkillManagementServiceから技術者のスキル情報を取得
   - WorkHistoryServiceから職務経歴情報を取得
   - SkillSheetTemplateRepositoryからテンプレート情報を取得
4. クライアントから指定されたスキル選択やWorkHistory選択に基づいて情報をフィルタリング
5. テンプレートに基づいてスキルシートのHTML内容を生成
   - 基本情報セクションの生成
   - スキルセクションの生成
   - 職務経歴セクションの生成
   - テンプレートスタイルの適用
6. 新しいスキルシートエンティティを作成（バージョン管理考慮）
7. SkillSheetRepositoryがスキルシート情報をデータベースに保存
8. SkillSheetEventPublisherがスキルシート生成イベントを発行
9. SkillSheetControllerが結果をクライアントに返却

### 3.2 スキルシート更新フロー

1. クライアントがスキルシート更新APIを呼び出し、スキルシートIDと更新内容を送信
2. SkillSheetControllerがリクエストを受け取り、パラメータをバリデーション
3. SkillSheetServiceが対象のスキルシート情報をリポジトリから取得
4. 対象スキルシートが存在しない場合はエラーを返却
5. スキルシートの更新権限を確認
6. SkillSheetServiceがスキルシート更新ロジックを処理
   - 承認済みの場合は新バージョン作成
   - 未承認の場合は現バージョン更新
   - 内容の更新と検証
7. SkillSheetRepositoryが更新されたスキルシート情報をデータベースに保存
8. SkillSheetEventPublisherがスキルシート更新イベントを発行
9. SkillSheetControllerが結果をクライアントに返却

### 3.3 スキルシート承認フロー

1. クライアントがスキルシート承認依頼APIを呼び出し、スキルシートIDと承認者ID、依頼メモを送信
2. SkillSheetControllerがリクエストを受け取り、パラメータをバリデーション
3. SkillSheetServiceが対象のスキルシート情報をリポジトリから取得
4. 対象スキルシートが存在しない場合はエラーを返却
5. 承認依頼権限を確認
6. SkillSheetServiceが承認依頼ロジックを処理
   - 承認ステータスを「承認待ち」に更新
   - 承認者情報の記録
   - 承認依頼日時の記録
7. NotificationServiceを通じて承認者に通知
8. SkillSheetRepositoryが更新されたスキルシート情報をデータベースに保存
9. SkillSheetEventPublisherが承認依頼イベントを発行
10. SkillSheetControllerが結果をクライアントに返却

### 3.4 スキルシート承認処理フロー

1. 承認者がスキルシート承認処理APIを呼び出し、スキルシートIDと承認結果、コメントを送信
2. SkillSheetControllerがリクエストを受け取り、パラメータをバリデーション
3. SkillSheetServiceが対象のスキルシート情報をリポジトリから取得
4. 対象スキルシートが存在しない場合はエラーを返却
5. 承認権限を確認
6. SkillSheetServiceが承認処理ロジックを実行
   - 承認の場合: ステータスを「承認済み」に更新、承認者と承認日時を記録
   - 却下の場合: ステータスを「却下」に更新、却下理由を記録
7. NotificationServiceを通じてスキルシート作成者に結果を通知
8. SkillSheetRepositoryが更新されたスキルシート情報をデータベースに保存
9. SkillSheetEventPublisherが承認結果イベントを発行
10. SkillSheetControllerが結果をクライアントに返却

### 3.5 スキルシートエクスポートフロー

1. クライアントがスキルシートエクスポートAPIを呼び出し、スキルシートIDとフォーマット（PDF/Word）、マスキング設定を送信
2. SkillSheetControllerがリクエストを受け取り、パラメータをバリデーション
3. SkillSheetServiceが対象のスキルシート情報をリポジトリから取得
4. 対象スキルシートが存在しない場合はエラーを返却
5. エクスポート権限を確認
6. マスキング設定に基づき個人情報マスキング処理
7. SkillSheetExportServiceが指定フォーマットへの変換処理を実行
   - HTML→PDF変換またはHTML→DOCX変換
   - スタイル適用
   - ヘッダー・フッター設定
   - マスキング適用
8. 生成されたファイルを一時保存
9. FileStorageServiceを通じてファイルを保存し、FileIDを取得
10. ダウンロードURLを生成
11. 操作ログに変換・ダウンロード履歴を記録
12. SkillSheetControllerがダウンロードURLをクライアントに返却

### 3.6 スキルシート共有フロー

1. クライアントがスキルシート共有APIを呼び出し、スキルシートID、共有設定（期限、アクセス制限、マスキング設定）を送信
2. SkillSheetControllerがリクエストを受け取り、パラメータをバリデーション
3. SkillSheetServiceが対象のスキルシート情報をリポジトリから取得
4. 対象スキルシートが存在しない場合はエラーを返却
5. 共有権限を確認
6. SkillSheetShareServiceが共有処理を実行
   - 一意の共有リンクID生成
   - 共有設定の記録（有効期限、アクセス制限、マスキング設定）
   - マスキング処理が必要な場合はマスキング済みバージョンを生成
7. 共有リンク情報をデータベースに保存
8. SkillSheetEventPublisherが共有イベントを発行
9. 共有URLをクライアントに返却

## 4. データモデル参照

スキルシート管理機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティを扱います。

- スキルシート (SkillSheet) エンティティ
- 職務経歴 (WorkHistory) エンティティ

## 5. バリデーションルール

スキルシート管理機能に適用されるバリデーションルールは以下の通りです。

### 5.1 スキルシート生成バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| engineerId | 必須、存在する技術者ID |
| templateId | 必須、存在するテンプレートID |
| title | 必須、最大100文字 |
| selectedWorkHistory | 任意、存在する職務経歴IDのリスト |
| selectedSkills | 任意、存在するスキルIDのリスト |
| additionalNote | 任意、最大1000文字 |

### 5.2 スキルシート更新バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| skillSheetId | 必須、存在するスキルシートID |
| title | 任意、最大100文字 |
| content | 任意、HTML形式の文字列、最大サイズ5MB |
| isPublic | 任意、真偽値 |

### 5.3 スキルシート承認依頼バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| skillSheetId | 必須、存在するスキルシートID |
| approverId | 必須、存在するユーザーID、承認権限を持つユーザー |
| requestNote | 任意、最大500文字 |
| requestDeadline | 任意、現在日以降の日付 |

### 5.4 スキルシート共有バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| skillSheetId | 必須、存在するスキルシートID |
| expirationDays | 必須、1-90の整数値 |
| allowDownload | 必須、真偽値 |
| maskPersonalInfo | 必須、真偽値 |

## 6. 例外処理

スキルシート管理機能における主な例外処理は以下の通りです。

### 6.1 バリデーション例外

- **InvalidSkillSheetDataException**: スキルシートデータが無効な場合にスローされる例外
  - 処理: クライアントにバリデーションエラーの詳細を返却

### 6.2 リソース未検出例外

- **SkillSheetNotFoundException**: 指定されたIDのスキルシートが存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **TemplateNotFoundException**: 指定されたIDのテンプレートが存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 6.3 権限例外

- **SkillSheetAccessDeniedException**: スキルシートへのアクセス権限がない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

- **ApprovalAccessDeniedException**: 承認操作の権限がない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

### 6.4 ビジネスルール違反例外

- **SkillSheetWorkflowException**: スキルシートの承認フローに関するビジネスルール違反の場合にスローされる例外
  - 処理: クライアントにビジネスルール違反の詳細を返却

### 6.5 変換処理例外

- **SkillSheetExportException**: スキルシートのエクスポート処理中にエラーが発生した場合にスローされる例外
  - 処理: ログに詳細を記録し、クライアントにエラーメッセージを返却

### 6.6 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. スキルシート生成・エクスポート中のエラーは詳細なエラー情報をログに記録し、クライアントには概要のみ返却
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. トランザクション管理による整合性の確保

## 7. セキュリティ考慮事項

スキルシート管理機能における主なセキュリティ考慮事項は以下の通りです。

### 7.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- スキルシート操作には以下の権限が必要
  - スキルシート照会: `SKILLSHEET_VIEW` 権限
  - スキルシート生成・更新: `SKILLSHEET_MANAGE` 権限
  - スキルシート承認: `SKILLSHEET_APPROVE` 権限
  - スキルシートテンプレート管理: `SKILLSHEET_TEMPLATE_MANAGE` 権限
- 部署単位のアクセス制御を適用し、自部署の技術者のスキルシートのみ管理可能とする設定も可能

### 7.2 データ保護

- スキルシートに含まれる個人情報は適切にマスキング可能
- マスキング設定のプリセット管理（社内用、顧客提案用など）
- 共有リンクへのアクセス制限（IPアドレス制限、アクセスパスワードなど）
- 共有リンクの有効期限設定

### 7.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- HTMLコンテンツは安全なタグのみ許可（XSS対策）
- SQLインジェクション対策としてパラメータ化クエリを使用

### 7.4 監査証跡

- スキルシートの操作（生成、更新、承認、共有、エクスポート）はすべて監査ログに記録
- 監査ログには以下の情報を含める
  - 操作を行ったユーザーID
  - 操作の種類（生成、更新、承認、共有、エクスポート）
  - 操作の対象（スキルシートID、技術者ID）
  - 操作の日時
  - 操作のIPアドレス
  - 共有設定（共有の場合）
  - エクスポート形式とマスキング設定（エクスポートの場合）

## 8. パフォーマンス最適化

スキルシート管理機能におけるパフォーマンス最適化策は以下の通りです。

### 8.1 データベース最適化

- 頻繁に検索される項目（技術者ID、承認状態など）にインデックスを作成
- スキルシートコンテンツの効率的な保存（圧縮など）
- バージョン管理の効率化（差分保存など）

### 8.2 キャッシング戦略

- スキルシートテンプレート（変更頻度の低いデータ）のキャッシング
- 承認済みスキルシートのキャッシング
- キャッシュの有効期間: テンプレートは60分、スキルシートは10分
- エクスポート済みファイルのキャッシング（同一設定での再エクスポート高速化）

### 8.3 レンダリング最適化

- スキルシート生成処理の最適化
- HTMLレンダリングの効率化
- PDF/DOCX変換処理の最適化（サーバーリソース管理）
- 重たい処理の非同期実行

### 8.4 バッチ処理

- 定期的な不要ファイルのクリーンアップ
- 期限切れ共有リンクの無効化
- 未完了スキルシートの自動リマインダー

## 9. 監視とロギング

スキルシート管理機能における監視とロギングの方針は以下の通りです。

### 9.1 ロギング方針

- INFO レベル: 通常の操作ログ（スキルシート生成、更新、承認など）
- WARN レベル: 潜在的な問題（バリデーションエラー、権限不足など）
- ERROR レベル: 例外と障害（変換エラー、未処理例外など）
- DEBUG レベル: 開発・トラブルシューティング用の詳細ログ

### 9.2 監視指標

- スキルシート生成・エクスポートの処理時間
- エラー率（4xx, 5xxレスポンス）
- スキルシート操作の頻度（生成数、更新数、承認数、エクスポート数）
- 共有リンクのアクセス状況
- ストレージ使用量

### 9.3 アラート条件

- スキルシート生成処理時間が閾値（5秒）を超えた場合
- エクスポート処理時間が閾値（10秒）を超えた場合
- エラー率が閾値（5%）を超えた場合
- 未承認スキルシートが一定期間（7日）放置された場合
- ストレージ使用量が閾値を超えた場合

## 10. テンプレート管理

スキルシート管理機能におけるテンプレート管理機能について説明します。

### 10.1 テンプレート構造

- HTMLベースのテンプレート構造
- 置換タグシステム（`{{engineer.name}}`など）
- セクション定義（基本情報、スキル一覧、職務経歴など）
- スタイル定義（CSS）
- 印刷用スタイルシート

### 10.2 テンプレート種類

- 標準テンプレート（システム提供）
- 部署別カスタムテンプレート
- 顧客別カスタムテンプレート
- 用途別テンプレート（詳細版、概要版など）

### 10.3 テンプレート管理機能

- テンプレートの登録・更新・削除
- テンプレートのプレビュー機能
- テンプレートのインポート/エクスポート
- テンプレートのバージョン管理
- デフォルトテンプレートの設定

## 11. エクスポート機能

スキルシート管理機能におけるエクスポート機能について説明します。

### 11.1 PDFエクスポート

- HTMLからPDFへの変換
- ページレイアウト設定（A4、レターなど）
- ヘッダー・フッター設定
- フォント埋め込み
- 目次生成
- ブックマーク設定
- セキュリティ設定（印刷制限など）

### 11.2 Wordエクスポート

- HTMLからDOCXへの変換
- スタイル適用
- 目次生成
- 編集可能領域の設定
- 画像・テーブルの最適化

### 11.3 マスキング機能

- 個人情報マスキング（名前、連絡先など）
- 会社情報マスキング（クライアント名など）
- マスキングレベル設定（完全・部分）
- マスキングプリセット管理

### 11.4 一括エクスポート

- 複数技術者のスキルシート一括エクスポート
- ZIP形式でのまとめダウンロード
- 命名規則の設定

## 12. 承認フロー管理

スキルシート管理機能における承認フロー管理について説明します。

### 12.1 承認フロー設計

- 承認ステータスの管理（下書き、承認待ち、承認済み、却下）
- 承認者の設定と通知
- 承認期限の設定と通知
- 承認コメントの管理
- 承認履歴の記録

### 12.2 多段階承認対応

- 複数承認者の設定
- 承認順序の定義
- 承認権限の委譲機能
- 承認代理機能

### 12.3 承認関連通知

- 承認依頼通知
- 承認期限リマインダー
- 承認結果通知
- 承認者変更通知

## 13. 共有管理機能

スキルシート管理機能における共有管理機能について説明します。

### 13.1 共有リンク生成

- 一意のリンクID生成
- 有効期限設定
- アクセス制限設定（IPアドレス、パスワードなど）
- アクセス権限設定（閲覧のみ、ダウンロード可など）

### 13.2 共有履歴管理

- 共有リンク一覧表示
- 共有状態監視（アクセス回数、最終アクセス日時）
- 共有リンクの無効化
- アクセスログの記録

### 13.3 外部システム連携

- メール送信機能
- チャットツール連携（Slack、Teamsなど）
- SalesforceなどのCRMとの連携
- 顧客ポータルとの連携