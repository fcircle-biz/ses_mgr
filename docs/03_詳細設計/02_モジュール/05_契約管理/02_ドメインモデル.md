# 契約管理 ドメインモデル

## 1. エンティティ定義

### 1.1 Contract（契約）

契約の基本情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 契約ID | 主キー、UUID形式 |
| contractNumber | String | 契約番号 | 必須、一意 |
| contractType | ContractType | 契約種別 | 必須 |
| projectId | String | 案件ID | 必須、案件管理モジュールの案件IDと紐付け |
| engineerId | String | 技術者ID | 条件付き必須（SES契約の場合） |
| clientId | String | 取引先ID | 必須 |
| startDate | Date | 契約開始日 | 必須 |
| endDate | Date | 契約終了日 | 任意 |
| status | ContractStatus | 契約ステータス | 必須 |
| amount | Decimal | 契約金額 | 必須 |
| paymentTerms | PaymentTerms | 支払条件 | 必須 |
| createdBy | String | 作成者ID | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedBy | String | 更新者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| approvedBy | String | 承認者ID | 任意 |
| approvedAt | DateTime | 承認日時 | 任意 |
| executedAt | DateTime | 締結日時 | 任意 |
| description | String | 契約概要 | 任意 |
| tags | List\<String\> | タグ | 任意 |

**ビジネスルール**：
- 契約番号は「CNT-{YYYYMM}-{5桁連番}」の形式で自動生成される
- 契約終了日は契約開始日より後の日付でなければならない
- 締結済み（EXECUTED）の契約は編集できない（改定契約の作成が必要）

### 1.2 ContractDocument（契約書類）

契約に関連する書類を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 書類ID | 主キー、UUID形式 |
| contractId | String | 契約ID | 必須、Contractのidと紐付け |
| documentType | DocumentType | 書類種別 | 必須 |
| templateId | String | テンプレートID | 任意、ContractTemplateのidと紐付け |
| version | Integer | バージョン | 必須、1以上 |
| fileId | String | ファイルID | 必須、ファイル管理モジュールのファイルIDと紐付け |
| filename | String | ファイル名 | 必須 |
| contentType | String | コンテンツタイプ | 必須 |
| status | DocumentStatus | 書類ステータス | 必須 |
| createdBy | String | 作成者ID | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedBy | String | 更新者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| isExecutedCopy | Boolean | 締結済み原本フラグ | 必須 |

**ビジネスルール**：
- 新しいバージョンが作成されると、自動的にバージョン番号がインクリメントされる
- 締結済み原本（isExecutedCopy=true）の書類は変更不可
- 各契約には、必ず一つ以上の CONTRACT_MAIN タイプの書類が存在する

### 1.3 ElectronicSignature（電子署名）

契約の電子署名に関する情報を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 署名ID | 主キー、UUID形式 |
| contractId | String | 契約ID | 必須、Contractのidと紐付け |
| documentId | String | 書類ID | 必須、ContractDocumentのidと紐付け |
| signatureRequestId | String | 署名依頼ID | 必須、外部電子署名サービスの依頼IDと紐付け |
| status | SignatureStatus | 署名ステータス | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| completedAt | DateTime | 完了日時 | 任意 |
| expiresAt | DateTime | 有効期限 | 任意 |

**ビジネスルール**：
- 署名完了後は、署名済み文書を取得し、新しいContractDocumentとして保存する
- 署名の有効期限が切れた場合、自動的にステータスが EXPIRED に変更される

### 1.4 SignatureSigner（署名者）

電子署名の署名者を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | 署名者ID | 主キー、UUID形式 |
| signatureId | String | 署名ID | 必須、ElectronicSignatureのidと紐付け |
| email | String | メールアドレス | 必須 |
| name | String | 氏名 | 必須 |
| organization | String | 組織名 | 必須 |
| title | String | 役職 | 任意 |
| signingOrder | Integer | 署名順序 | 必須、0以上 |
| status | SignerStatus | 署名者ステータス | 必須 |
| signedAt | DateTime | 署名日時 | 任意 |
| notifiedAt | DateTime | 通知日時 | 任意 |
| reminderSentAt | DateTime | リマインダー送信日時 | 任意 |

**ビジネスルール**：
- 署名順序が指定された場合、その順序に従って署名依頼が送信される
- 署名順序が同じ署名者は、並行して署名依頼を受け取る

### 1.5 ContractTemplate（契約テンプレート）

契約書のテンプレートを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | テンプレートID | 主キー、UUID形式 |
| name | String | テンプレート名 | 必須 |
| description | String | 説明 | 任意 |
| contractType | ContractType | 契約種別 | 必須 |
| version | Integer | バージョン | 必須、1以上 |
| fileId | String | ファイルID | 必須、ファイル管理モジュールのファイルIDと紐付け |
| contentType | String | コンテンツタイプ | 必須 |
| status | TemplateStatus | ステータス | 必須 |
| variables | List\<TemplateVariable\> | テンプレート変数 | 任意 |
| createdBy | String | 作成者ID | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedBy | String | 更新者ID | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| isDefault | Boolean | デフォルトフラグ | 必須 |

**ビジネスルール**：
- 各契約種別につき、最大1つのテンプレートがデフォルト（isDefault=true）として設定可能
- 新しいバージョンが作成されると、自動的にバージョン番号がインクリメントされる
- ACTIVE状態のテンプレートのみが契約書作成に使用可能

### 1.6 ContractReview（契約レビュー）

契約のレビュープロセスを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|-----|------|------|
| id | String | レビューID | 主キー、UUID形式 |
| contractId | String | 契約ID | 必須、Contractのidと紐付け |
| documentId | String | 書類ID | 必須、ContractDocumentのidと紐付け |
| reviewerId | String | レビュアーID | 必須 |
| reviewerName | String | レビュアー名 | 必須 |
| status | ReviewStatus | レビューステータス | 必須 |
| comments | String | コメント | 任意 |
| requestedAt | DateTime | 依頼日時 | 必須 |
| completedAt | DateTime | 完了日時 | 任意 |
| dueDate | Date | 期限日 | 任意 |

**ビジネスルール**：
- レビュー完了後、全レビュアーが承認した場合のみ契約ステータスが REVIEW_COMPLETED に更新される
- 一人でも差し戻しを行った場合、契約ステータスは DRAFT に戻る

## 2. 値オブジェクト定義

### 2.1 PaymentTerms（支払条件）

契約の支払条件を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| paymentMethod | PaymentMethod | 支払方法 |
| paymentCycle | PaymentCycle | 支払サイクル |
| paymentDueDays | Integer | 支払期限日数 |
| invoiceTimingDays | Integer | 請求書発行基準日 |

### 2.2 TemplateVariable（テンプレート変数）

契約テンプレート内の変数を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| name | String | 変数名 |
| description | String | 説明 |
| type | VariableType | 変数タイプ |
| required | Boolean | 必須フラグ |
| defaultValue | String | デフォルト値 |
| options | List\<String\> | 選択肢（ENUM型の場合） |

### 2.3 SignatureCertificate（署名証明書）

電子署名の証明書情報を表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| provider | String | 署名プロバイダ |
| certificateId | String | 証明書ID |
| issuedAt | DateTime | 発行日時 |
| algorithm | String | 署名アルゴリズム |
| verificationData | String | 検証データ |

### 2.4 AuditLog（監査ログ）

契約に関する監査ログを表す値オブジェクトです。

| 属性名 | 型 | 説明 |
|-------|-----|------|
| timestamp | DateTime | タイムスタンプ |
| userId | String | ユーザーID |
| userName | String | ユーザー名 |
| action | AuditAction | 操作種別 |
| details | String | 詳細情報 |
| ipAddress | String | IPアドレス |

## 3. 列挙型定義

### 3.1 ContractStatus（契約ステータス）

```
enum ContractStatus {
    DRAFT,               // 下書き
    REVIEW_IN_PROGRESS,  // レビュー中
    REVIEW_COMPLETED,    // レビュー完了
    APPROVAL_PENDING,    // 承認待ち
    APPROVED,            // 承認済み
    SIGNATURE_PENDING,   // 署名中
    EXECUTED,            // 締結済み
    EXPIRED,             // 期限切れ
    TERMINATED,          // 解約
    RENEWED,             // 更新済み
    CANCELLED            // 取消
}
```

### 3.2 ContractType（契約種別）

```
enum ContractType {
    SES_CONTRACT,         // SES契約（準委任）
    OUTSOURCING_CONTRACT, // 業務委託契約（請負）
    DISPATCH_CONTRACT,    // 派遣契約
    NDA,                  // 秘密保持契約
    FRAMEWORK_AGREEMENT,  // 基本契約
    AMENDMENT,            // 契約変更合意書
    OTHER                 // その他
}
```

### 3.3 DocumentType（書類種別）

```
enum DocumentType {
    CONTRACT_MAIN,       // 本契約書
    AMENDMENT,           // 変更合意書
    APPENDIX,            // 別紙・付属書類
    TERMS_AND_CONDITIONS,// 約款
    SPECIFICATION,       // 仕様書
    NDA,                 // 秘密保持契約書
    OTHER                // その他
}
```

### 3.4 DocumentStatus（書類ステータス）

```
enum DocumentStatus {
    DRAFT,               // 下書き
    FINAL,               // 確定版
    SUPERSEDED,          // 旧版（新バージョンに置き換え）
    SIGNED,              // 署名済み
    ARCHIVED             // アーカイブ
}
```

### 3.5 SignatureStatus（署名ステータス）

```
enum SignatureStatus {
    CREATED,             // 作成済み
    SENT,                // 送信済み
    IN_PROGRESS,         // 署名中
    COMPLETED,           // 完了
    DECLINED,            // 拒否
    EXPIRED,             // 期限切れ
    CANCELLED            // 取消
}
```

### 3.6 SignerStatus（署名者ステータス）

```
enum SignerStatus {
    PENDING,             // 待機中
    NOTIFIED,            // 通知済み
    VIEWED,              // 閲覧済み
    SIGNED,              // 署名済み
    DECLINED,            // 拒否
    EXPIRED              // 期限切れ
}
```

### 3.7 ReviewStatus（レビューステータス）

```
enum ReviewStatus {
    PENDING,             // 未対応
    IN_PROGRESS,         // レビュー中
    APPROVED,            // 承認
    REJECTED,            // 差戻し
    CANCELLED            // 取消
}
```

### 3.8 PaymentMethod（支払方法）

```
enum PaymentMethod {
    BANK_TRANSFER,       // 銀行振込
    CREDIT_CARD,         // クレジットカード
    DIRECT_DEBIT,        // 口座振替
    OTHER                // その他
}
```

### 3.9 PaymentCycle（支払サイクル）

```
enum PaymentCycle {
    MONTHLY,             // 月次
    QUARTERLY,           // 四半期
    SEMI_ANNUALLY,       // 半年
    ANNUALLY,            // 年次
    MILESTONE,           // マイルストーン
    OTHER                // その他
}
```

### 3.10 VariableType（変数タイプ）

```
enum VariableType {
    TEXT,                // テキスト
    NUMBER,              // 数値
    DATE,                // 日付
    ENUM,                // 列挙型（選択肢）
    BOOLEAN,             // 真偽値
    RICH_TEXT            // リッチテキスト
}
```

### 3.11 AuditAction（監査操作）

```
enum AuditAction {
    CREATE,              // 作成
    VIEW,                // 閲覧
    UPDATE,              // 更新
    DELETE,              // 削除
    APPROVE,             // 承認
    REJECT,              // 拒否
    SIGN,                // 署名
    DOWNLOAD,            // ダウンロード
    EXPORT,              // エクスポート
    SEND,                // 送信
    CANCEL               // 取消
}
```

### 3.12 TemplateStatus（テンプレートステータス）

```
enum TemplateStatus {
    DRAFT,               // 下書き
    ACTIVE,              // 有効
    INACTIVE,            // 無効
    ARCHIVED             // アーカイブ
}
```

## 4. ドメイン関連図

```
Contract 1 --- * ContractDocument
Contract 1 --- * ElectronicSignature
Contract 1 --- * ContractReview
ElectronicSignature 1 --- * SignatureSigner
ContractDocument 0..1 --- 1 ContractTemplate
```

## 5. 重要なビジネスルール

### 5.1 契約作成ルール

- 契約の作成は、契約テンプレートをベースに行うことが推奨される
- 契約番号は一意でなければならず、システムが自動的に採番する
- 同一案件に対して複数の契約を作成できるが、同一種別の有効な契約は一つのみ許容される

### 5.2 契約承認ワークフロールール

- 契約は所定のレビュー・承認プロセスを経てから署名のために送付される
- 契約金額に応じて承認者レベルが変わる（階層的承認ルール）
  - 100万円未満：課長承認
  - 100万円以上500万円未満：部長承認
  - 500万円以上：役員承認
- レビュアーと承認者は兼任してはならない（職務分掌）

### 5.3 電子署名ルール

- 電子署名は法的に有効な方法で行われなければならない
- 署名プロセスでは、すべての署名者に署名の機会が与えられ、署名の順序が指定されている場合はその順序に従う
- 署名者は署名前に契約書の内容を確認する機会を与えられる
- 署名が完了した契約書は改変できないように保護される

### 5.4 契約更新・終了ルール

- 期間満了の30日前になると、契約更新の通知が自動的に送信される
- 契約更新時には新たな契約書が作成され、既存の契約との関連性が保持される
- 契約終了時（期間満了、解約など）には、関連する業務プロセス（請求停止など）に自動的に通知される

### 5.5 契約書保管ルール

- 締結済み契約書は電子保管され、法定保存期間に基づいて管理される
- 契約書へのアクセスは権限を持つユーザーのみに制限され、すべてのアクセスは監査ログに記録される
- 保管された契約書は改ざん防止のための技術的措置が施される