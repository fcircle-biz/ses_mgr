# 契約書ドキュメント機能

## 1. 機能概要

契約書ドキュメント機能は、契約テンプレートを基にした契約書の生成、管理、バージョニングなどを行います。契約書のデジタル作成から編集、最終化、エクスポートまでの一連の処理をサポートし、一貫性のある高品質な契約書の作成を実現します。また、付属文書の管理や契約書のプレビュー、変換など、契約書ドキュメントに関する様々な機能を提供します。

## 2. 処理フロー

### 2.1 契約書生成フロー

1. 契約書生成リクエストの受け取り（契約ID、テンプレートID、カスタマイズパラメータ等）
2. 契約情報と関連リソース（案件、技術者、取引先情報等）の取得
3. テンプレートの取得
4. テンプレート変数と取得データのマッピング
5. テンプレートエンジンによる契約書の生成
6. 生成した契約書のファイル保存（ファイル管理モジュール連携）
7. 契約書ドキュメントメタデータの作成と永続化
8. 契約書ドキュメント生成イベントの発行
9. 生成された契約書ドキュメント情報の返却

### 2.2 契約書取得フロー

1. ドキュメントID受け取り
2. ドキュメントメタデータの取得
3. アクセス権限の確認
4. 関連するファイルの取得（ファイル管理モジュール連携）
5. ドキュメント取得イベントの記録
6. 契約書ドキュメント情報の返却

### 2.3 契約書一覧取得フロー

1. 契約IDと文書タイプの受け取り
2. 契約の存在確認とアクセス権限の確認
3. 契約に関連する契約書ドキュメントの検索
4. タイプによるフィルタリング（指定された場合）
5. ソート処理（バージョン、作成日時等）
6. 契約書ドキュメント一覧の返却

### 2.4 契約書更新フロー

1. ドキュメントIDと更新内容の受け取り
2. ドキュメントの取得と更新可能状態の確認
3. 更新内容のバリデーション
4. 新バージョンの作成（現バージョン+1）
5. 更新内容に基づく契約書の再生成または編集
6. 生成/編集した契約書のファイル保存
7. 新バージョンのドキュメントメタデータの作成と永続化
8. 旧バージョンのステータス更新（SUPERSEDED）
9. 契約書ドキュメント更新イベントの発行
10. 更新された契約書ドキュメント情報の返却

### 2.5 契約書ダウンロードフロー

1. ドキュメントIDと出力形式の受け取り
2. ドキュメントの取得とアクセス権限の確認
3. 関連するファイルの取得
4. 要求された形式への変換（必要な場合）
5. ダウンロードイベントの記録
6. ドキュメントのバイナリデータの返却

### 2.6 契約書比較フロー

1. 比較対象の2つのドキュメントIDの受け取り
2. 両ドキュメントの取得とアクセス権限の確認
3. ドキュメント内容の取得
4. 差分比較処理の実行
5. 比較結果のレンダリング
6. 比較結果の返却

## 3. 主要コンポーネント構成

### 3.1 ContractDocumentService

契約書ドキュメントの生成、管理機能を提供するサービスコンポーネントです。

```java
interface ContractDocumentService {
    ContractDocument generateContractDocument(String contractId, DocumentGenerateRequest request);
    ContractDocument getContractDocument(String documentId);
    List<ContractDocument> getContractDocuments(String contractId, DocumentType type);
    ContractDocument updateContractDocument(String documentId, DocumentUpdateRequest request);
    byte[] downloadContractDocument(String documentId, String format);
    DocumentComparisonResult compareContractDocuments(String documentId1, String documentId2);
    List<ContractDocument> getDocumentVersionHistory(String documentId);
    ContractDocument finalizeDocument(String documentId);
}
```

### 3.2 ContractDocumentRepository

契約書ドキュメントエンティティの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ContractDocumentRepository {
    ContractDocument save(ContractDocument document);
    Optional<ContractDocument> findById(String id);
    List<ContractDocument> findByContractId(String contractId);
    List<ContractDocument> findByContractIdAndDocumentType(String contractId, DocumentType type);
    List<ContractDocument> findByContractIdAndDocumentTypeOrderByVersionDesc(
        String contractId, DocumentType type);
    Optional<ContractDocument> findByContractIdAndDocumentTypeAndVersion(
        String contractId, DocumentType type, Integer version);
    List<ContractDocument> findByFileId(String fileId);
}
```

### 3.3 DocumentGenerator

契約書を生成するコンポーネントです。

```java
interface DocumentGenerator {
    DocumentGenerationResult generateDocument(
        String templateId, Map<String, Object> variables, DocumentGenerationOptions options);
    DocumentGenerationResult regenerateDocument(
        String documentId, Map<String, Object> variables, DocumentGenerationOptions options);
    DocumentGenerationResult customizeDocument(
        String documentId, DocumentCustomizationRequest customization);
}
```

### 3.4 DocumentTemplateEngine

テンプレートとデータから契約書を生成するエンジンコンポーネントです。

```java
interface DocumentTemplateEngine {
    byte[] processTemplate(String templateContent, Map<String, Object> data, OutputFormat format);
    Map<String, Object> extractVariables(String templateContent);
    boolean validateTemplate(String templateContent, List<String> requiredVariables);
    String evaluateCondition(String condition, Map<String, Object> data);
}
```

### 3.5 DocumentFormatConverter

契約書の形式変換を行うコンポーネントです。

```java
interface DocumentFormatConverter {
    byte[] convertFormat(byte[] content, String sourceFormat, String targetFormat);
    boolean isConversionSupported(String sourceFormat, String targetFormat);
    List<String> getSupportedFormats();
    byte[] extractText(byte[] content, String format);
}
```

### 3.6 DocumentDataProvider

契約書生成に必要なデータを収集するコンポーネントです。

```java
interface DocumentDataProvider {
    Map<String, Object> getContractData(String contractId);
    Map<String, Object> getProjectData(String projectId);
    Map<String, Object> getEngineerData(String engineerId);
    Map<String, Object> getClientData(String clientId);
    Map<String, Object> getOrganizationData();
    Map<String, Object> getLegalTermsData(ContractType contractType);
    Map<String, Object> getPaymentTermsData(PaymentTerms paymentTerms);
}
```

### 3.7 DocumentEventPublisher

契約書ドキュメント関連イベントを発行するコンポーネントです。

```java
interface DocumentEventPublisher {
    void publishDocumentGenerated(ContractDocument document);
    void publishDocumentUpdated(ContractDocument document, String changeType);
    void publishDocumentViewed(String documentId, String userId);
    void publishDocumentDownloaded(String documentId, String userId, String format);
    void publishDocumentFinalized(ContractDocument document);
}
```

## 4. 例外処理

### 4.1 DocumentNotFoundException

指定されたドキュメントIDが存在しない場合に発生する例外です。

```java
class DocumentNotFoundException extends ResourceNotFoundException {
    private String documentId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 DocumentGenerationException

ドキュメント生成中にエラーが発生した場合の例外です。

```java
class DocumentGenerationException extends ApplicationException {
    private String contractId;
    private String templateId;
    private String failureReason;
    private Map<String, String> missingVariables;
    
    // コンストラクタ、getterなど
}
```

### 4.3 DocumentUpdateNotAllowedException

更新不可能な状態のドキュメントを更新しようとした場合に発生する例外です。

```java
class DocumentUpdateNotAllowedException extends BusinessRuleException {
    private String documentId;
    private DocumentStatus currentStatus;
    
    // コンストラクタ、getterなど
}
```

### 4.4 FormatConversionException

ドキュメント形式の変換に失敗した場合に発生する例外です。

```java
class FormatConversionException extends ApplicationException {
    private String sourceFormat;
    private String targetFormat;
    private String failureReason;
    
    // コンストラクタ、getterなど
}
```

### 4.5 TemplateProcessingException

テンプレート処理中にエラーが発生した場合の例外です。

```java
class TemplateProcessingException extends ApplicationException {
    private String templateId;
    private String errorLocation;
    private String errorMessage;
    
    // コンストラクタ、getterなど
}
```

## 5. テンプレート処理詳細

契約書の生成は、テンプレートエンジンによるテンプレート処理を核として行われます。

### 5.1 サポートされるテンプレート構文

テンプレートエンジンは以下の構文をサポートします：

- **変数置換**: `{{variable_name}}` 形式の変数を対応する値に置換
- **条件分岐**: `{{#if condition}} content {{else}} alternative content {{/if}}`
- **繰り返し**: `{{#each items}} content using {{this.property}} {{/each}}`
- **セクション制御**: `{{#section name}} content {{/section}}` （特定セクションの表示/非表示）
- **フォーマット関数**: `{{formatDate variable format}}` のような関数を使用したフォーマット変換
- **ネスト変数**: `{{client.address.postalCode}}` のようなドット記法でのプロパティアクセス

### 5.2 変数マッピング

テンプレート処理では、以下のカテゴリの変数が利用可能です：

- **契約基本情報**: 契約番号、契約種別、開始日、終了日など
- **案件情報**: 案件名、案件概要、作業場所、必要スキルなど
- **技術者情報**: 氏名、スキル、経験年数など（SES契約の場合）
- **取引先情報**: 会社名、住所、代表者名、担当者名など
- **自社情報**: 会社名、住所、代表者名、担当者名など
- **支払条件**: 支払方法、支払サイクル、支払期限日数など
- **法的条項**: 契約種別に応じた標準的な法的条項

### 5.3 条件付きセクション

契約書には、条件によって表示/非表示を切り替えるセクションを含めることができます：

- **技術者情報セクション**: SES契約の場合のみ表示
- **秘密保持条項**: 秘密保持契約が別途ある場合は簡略化された条項を表示
- **知的財産権条項**: 契約種別に応じて異なる内容を表示
- **損害賠償条項**: 契約金額に応じた上限金額を表示

### 5.4 出力フォーマット

テンプレートエンジンは以下の出力フォーマットをサポートします：

- **HTML**: 画面表示用のHTML
- **PDF**: 保存・印刷用のPDF
- **DOCX**: 編集可能なWord文書
- **TEXT**: プレーンテキスト形式

## 6. ドキュメントバージョン管理

契約書ドキュメントの変更履歴を管理するためのバージョン管理機能を提供します。

### 6.1 バージョン付与ルール

- 契約書ドキュメントの初回生成時にはバージョン1が割り当てられる
- 既存ドキュメントの更新時には、自動的にバージョン番号がインクリメントされる
- 同一契約・同一ドキュメントタイプのドキュメントで、バージョン番号は連番で管理される
- 最新バージョンのみが「現行版」として扱われ、それ以前のバージョンは「過去版」となる

### 6.2 バージョン変更時のステータス管理

- 新バージョンが作成されると、旧バージョンは自動的に「SUPERSEDED」ステータスに変更される
- 「FINAL」ステータスのドキュメントは原則として更新不可だが、新バージョン作成は可能
- 「SIGNED」ステータスのドキュメントは更新不可であり、参照のみ可能

### 6.3 バージョン履歴表示

- 特定のドキュメントIDに関連する全バージョンを取得する機能
- バージョン間の差分を視覚的に表示する機能
- 特定バージョンへの復元機能（新バージョンとして作成）

## 7. ドキュメント保護機能

契約書ドキュメントの改ざん防止や不正アクセス防止のための保護機能を提供します。

### 7.1 閲覧制御

- ドキュメントへのアクセスは権限を持つユーザーのみに制限
- 閲覧イベントは監査ログに記録
- 特に重要な契約書には追加の閲覧制限（特定ロールのみ）を設定可能

### 7.2 編集制御

- 下書き状態のドキュメントのみ編集可能
- レビュー中、署名中、署名済みのドキュメントは編集不可
- 編集権限は限定されたユーザーのみに付与

### 7.3 最終化後の保護

- 最終化（FINAL状態）されたドキュメントは内容の変更不可
- 署名済みドキュメントはデジタル署名によって保護
- 署名済みドキュメントの整合性はチェックサムによる検証が可能