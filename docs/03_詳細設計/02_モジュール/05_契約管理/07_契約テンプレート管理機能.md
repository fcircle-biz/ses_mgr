# 契約テンプレート管理機能

## 1. 機能概要

契約テンプレート管理機能は、様々な契約種別に対応する契約書のテンプレートを作成、管理、更新するための機能を提供します。契約書の雛形となるテンプレートを一元管理し、テンプレート変数の定義、バージョン管理、条件付きテキストの制御などを行うことで、一貫性のある高品質な契約書の作成を支援します。さらに、テンプレートのインポート・エクスポート、アクセス制御など、テンプレート管理に必要な機能を実装します。

## 2. 処理フロー

### 2.1 テンプレート作成フロー

1. テンプレート作成リクエストの受け取り（テンプレート名、契約種別、ファイル等）
2. リクエストデータのバリデーション
3. テンプレートファイルの解析とテンプレート変数の抽出
4. テンプレートファイルの保存（ファイル管理モジュール連携）
5. テンプレートメタデータの作成と永続化
6. デフォルト設定の処理（isDefault=trueの場合）
7. テンプレート作成イベントの発行
8. 作成されたテンプレート情報の返却

### 2.2 テンプレート取得フロー

1. テンプレートIDの受け取り
2. テンプレートメタデータの取得
3. アクセス権限の確認
4. 関連するファイルの取得（必要な場合）
5. テンプレート情報の返却

### 2.3 テンプレート検索フロー

1. 検索条件の受け取り（契約種別、ステータス、キーワード等）
2. 検索条件のバリデーション
3. アクセス権限の確認
4. 検索条件によるテンプレートの検索
5. ソート処理（名前、作成日等）
6. テンプレート一覧の返却

### 2.4 テンプレート更新フロー

1. テンプレートIDと更新内容の受け取り
2. テンプレートの取得と更新可能状態の確認
3. 更新内容のバリデーション
4. ファイル更新がある場合：
   a. 新しいテンプレートファイルの解析とテンプレート変数の抽出
   b. ファイルの保存
5. テンプレートメタデータの更新
6. バージョン管理（必要に応じて新バージョンとして保存）
7. テンプレート更新イベントの発行
8. 更新されたテンプレート情報の返却

### 2.5 デフォルトテンプレート設定フロー

1. テンプレートIDと契約種別の受け取り
2. テンプレートの取得と有効性確認
3. 契約種別の一致確認
4. 現在のデフォルトテンプレートの取得（存在する場合）
5. 現在のデフォルトテンプレートのデフォルト解除
6. 新しいテンプレートをデフォルトに設定
7. テンプレートの永続化
8. デフォルト設定変更イベントの発行
9. 更新されたテンプレート情報の返却

### 2.6 テンプレート変数管理フロー

1. テンプレートIDと変数定義リクエストの受け取り
2. テンプレートの取得と変数管理可能状態の確認
3. 変数定義のバリデーション
4. テンプレート変数の更新または追加
5. テンプレートメタデータの永続化
6. テンプレート変数更新イベントの発行
7. 更新されたテンプレート情報の返却

## 3. 主要コンポーネント構成

### 3.1 ContractTemplateService

契約テンプレートの管理機能を提供するサービスコンポーネントです。

```java
interface ContractTemplateService {
    ContractTemplate createContractTemplate(TemplateCreateRequest request);
    ContractTemplate getContractTemplate(String templateId);
    ContractTemplate updateContractTemplate(String templateId, TemplateUpdateRequest request);
    List<ContractTemplate> searchContractTemplates(TemplateSearchRequest request);
    ContractTemplate setDefaultTemplate(String templateId, ContractType contractType);
    ContractTemplate updateTemplateVariables(String templateId, List<TemplateVariable> variables);
    ContractTemplate activateTemplate(String templateId);
    ContractTemplate deactivateTemplate(String templateId);
    byte[] exportTemplate(String templateId, String format);
    ContractTemplate importTemplate(TemplateImportRequest request);
}
```

### 3.2 ContractTemplateRepository

契約テンプレートエンティティの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ContractTemplateRepository {
    ContractTemplate save(ContractTemplate template);
    Optional<ContractTemplate> findById(String id);
    List<ContractTemplate> findByContractType(ContractType contractType);
    Optional<ContractTemplate> findByContractTypeAndIsDefaultTrue(ContractType contractType);
    List<ContractTemplate> findByContractTypeAndStatus(ContractType contractType, TemplateStatus status);
    List<ContractTemplate> findByNameContainingIgnoreCaseAndStatus(String name, TemplateStatus status);
    List<ContractTemplate> findByCreatedByAndStatus(String userId, TemplateStatus status);
}
```

### 3.3 TemplateParser

テンプレートファイルを解析し、テンプレート変数を抽出するコンポーネントです。

```java
interface TemplateParser {
    TemplateParseResult parseTemplate(byte[] templateContent, String contentType);
    List<String> extractVariables(byte[] templateContent, String contentType);
    List<String> extractSections(byte[] templateContent, String contentType);
    List<String> extractConditions(byte[] templateContent, String contentType);
    ValidationResult validateTemplate(byte[] templateContent, String contentType);
}
```

### 3.4 TemplateVariableManager

テンプレート変数の管理を担当するコンポーネントです。

```java
interface TemplateVariableManager {
    List<TemplateVariable> createVariablesFromNames(List<String> variableNames);
    List<TemplateVariable> mergeVariables(List<TemplateVariable> existing, List<TemplateVariable> updated);
    Map<String, Object> createDefaultValues(List<TemplateVariable> variables);
    ValidationResult validateVariables(List<TemplateVariable> variables);
    List<TemplateVariable> getSystemVariables(ContractType contractType);
}
```

### 3.5 TemplateEventPublisher

テンプレート関連イベントを発行するコンポーネントです。

```java
interface TemplateEventPublisher {
    void publishTemplateCreated(ContractTemplate template);
    void publishTemplateUpdated(ContractTemplate template, String updateType);
    void publishDefaultTemplateChanged(ContractType contractType, String oldTemplateId, String newTemplateId);
    void publishTemplateStatusChanged(ContractTemplate template, TemplateStatus oldStatus);
    void publishTemplateVariablesUpdated(ContractTemplate template);
}
```

### 3.6 TemplateAccessController

テンプレートへのアクセス制御を担当するコンポーネントです。

```java
interface TemplateAccessController {
    boolean canAccessTemplate(String userId, String templateId);
    boolean canModifyTemplate(String userId, String templateId);
    boolean canActivateTemplate(String userId, String templateId);
    boolean canSetDefaultTemplate(String userId, ContractType contractType);
    Set<String> getAccessibleTemplateIds(String userId);
}
```

### 3.7 TemplateImportExportService

テンプレートのインポート・エクスポートを担当するコンポーネントです。

```java
interface TemplateImportExportService {
    byte[] exportTemplatePackage(String templateId);
    ImportResult importTemplatePackage(byte[] packageData, String fileName);
    TemplateCompatibilityResult checkTemplateCompatibility(String templateId, ContractType targetType);
    List<String> getSupportedImportFormats();
    List<String> getSupportedExportFormats();
}
```

## 4. 例外処理

### 4.1 TemplateNotFoundException

指定されたテンプレートIDが存在しない場合に発生する例外です。

```java
class TemplateNotFoundException extends ResourceNotFoundException {
    private String templateId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 TemplateParseException

テンプレートファイルの解析に失敗した場合に発生する例外です。

```java
class TemplateParseException extends ApplicationException {
    private String contentType;
    private String errorLocation;
    private String errorMessage;
    
    // コンストラクタ、getterなど
}
```

### 4.3 InvalidTemplateStateException

テンプレートが特定の操作を行うのに適切な状態でない場合に発生する例外です。

```java
class InvalidTemplateStateException extends BusinessRuleException {
    private String templateId;
    private TemplateStatus currentStatus;
    private String operation;
    
    // コンストラクタ、getterなど
}
```

### 4.4 TemplateAccessDeniedException

テンプレートへのアクセス権限がない場合に発生する例外です。

```java
class TemplateAccessDeniedException extends AccessDeniedException {
    private String templateId;
    private String userId;
    private String requiredPermission;
    
    // コンストラクタ、getterなど
}
```

### 4.5 TemplateImportException

テンプレートのインポートに失敗した場合に発生する例外です。

```java
class TemplateImportException extends ApplicationException {
    private String fileName;
    private String importFormat;
    private String failureReason;
    
    // コンストラクタ、getterなど
}
```

## 5. テンプレート変数管理詳細

テンプレートで使用される変数を定義、管理する機能です。

### 5.1 変数タイプ

以下の変数タイプをサポートします：

- **TEXT**: 一般的なテキスト（例：契約件名、担当者名）
- **NUMBER**: 数値（例：契約金額、稼働時間）
- **DATE**: 日付（例：契約開始日、終了日）
- **ENUM**: 列挙型の選択肢（例：契約種別、支払方法）
- **BOOLEAN**: 真偽値（例：リモートワーク可否、機密情報アクセス有無）
- **RICH_TEXT**: 書式付きテキスト（例：業務内容、特記事項）

### 5.2 変数メタデータ

各変数には以下のメタデータを設定できます：

- **name**: 変数名（例：`contract_title`）
- **displayName**: 表示名（例：「契約件名」）
- **description**: 説明（例：「契約の正式名称を入力してください」）
- **type**: 変数タイプ（TEXT, NUMBER, DATE など）
- **required**: 必須フラグ
- **defaultValue**: デフォルト値
- **validationRules**: バリデーションルール（正規表現、最小/最大値など）
- **options**: ENUM型の場合の選択肢一覧
- **group**: 変数グループ（基本情報、料金情報など）

### 5.3 システム変数

システムによって自動的に提供される変数：

- **システム日時変数**: `{{current_date}}`, `{{current_year}}` など
- **組織情報変数**: `{{company_name}}`, `{{company_address}}` など
- **署名関連変数**: `{{signer1_name}}`, `{{signature_date}}` など
- **連番変数**: `{{page_number}}`, `{{section_number}}` など

### 5.4 変数のグループ化

テンプレート変数は以下のグループに分類されます：

- **基本情報**: 契約番号、契約名、契約種別など
- **期間情報**: 契約開始日、終了日、更新条件など
- **料金情報**: 契約金額、支払条件、消費税など
- **当事者情報**: 自社情報、取引先情報、代表者など
- **案件情報**: 案件名、作業場所、作業内容など
- **技術者情報**: 氏名、スキル、稼働条件など（SES契約の場合）
- **法的条項**: 守秘義務、知的財産権、損害賠償など

## 6. テンプレートバージョン管理

契約テンプレートのバージョンを管理する機能です。

### 6.1 バージョン付与ルール

- テンプレートの初回作成時にはバージョン1が割り当てられる
- テンプレート内容（ファイル）を更新する場合、自動的にバージョン番号がインクリメントされる
- 同一テンプレートで、バージョン番号は連番で管理される

### 6.2 バージョン履歴管理

- 過去バージョンのテンプレートは保存され、参照可能
- 各バージョンの作成日時、作成者、変更内容を記録
- バージョン間の差分表示機能
- 特定バージョンへの復元機能（新バージョンとして作成）

### 6.3 テンプレート移行管理

- 旧バージョンのテンプレートを使用して作成された契約の継続管理
- バージョンアップ時の変数マッピング定義
- テンプレート更新の影響範囲の分析機能

## 7. 条件付きテキスト機能

契約書内の特定のテキストを条件に応じて表示/非表示切り替える機能です。

### 7.1 条件式

以下の条件式をサポートします：

- **変数比較**: `{{#if amount > 1000000}}` のような変数値と定数の比較
- **変数存在確認**: `{{#if engineer}}` のような変数の存在確認
- **論理演算**: `{{#if isRemote && location == "Tokyo"}}` のようなAND, OR, NOTの組み合わせ
- **否定条件**: `{{#unless isConfidential}}` のような否定条件

### 7.2 条件付きセクション

条件付きで表示/非表示を切り替えるセクション定義：

```
{{#if contractType == "SES_CONTRACT"}}
第X条 技術者の稼働条件
  技術者は、以下の条件で稼働するものとする。
  1. 稼働場所: {{workLocation}}
  2. 稼働時間: {{workingHours}}時間/日
  ...
{{/if}}
```

### 7.3 代替テキスト

条件によって異なるテキストを表示する代替テキスト定義：

```
{{#if amount > 1000000}}
第X条 前払い金
  甲は、本契約締結後7日以内に、契約金額の30%を前払い金として乙に支払うものとする。
{{else}}
第X条 支払条件
  甲は、乙の請求に基づき、毎月末締めの翌月末日までに契約金額を支払うものとする。
{{/if}}
```

### 7.4 繰り返しセクション

配列データを繰り返し表示するセクション定義：

```
第X条 成果物
  本契約における成果物は以下の通りとする。
  {{#each deliverables}}
  {{@index+1}}. {{name}}: {{description}}（納品期限: {{dueDate}}）
  {{/each}}
```

## 8. テンプレートアクセス管理

契約テンプレートへのアクセスを制御する機能です。

### 8.1 テンプレート権限

以下の権限レベルを定義します：

- **閲覧権限**: テンプレートの閲覧のみ可能
- **使用権限**: テンプレートを使用して契約書を作成可能
- **編集権限**: テンプレートの内容を編集可能
- **管理権限**: テンプレートの状態変更、デフォルト設定等が可能

### 8.2 権限制御ルール

テンプレートへのアクセス制御は以下のルールに基づきます：

- **公開テンプレート**: 全ユーザーが閲覧・使用可能
- **部門テンプレート**: 特定部門のユーザーのみ閲覧・使用可能
- **個人テンプレート**: 作成者のみ閲覧・使用可能
- **編集権限**: 法務担当者と作成者のみ付与
- **管理権限**: 法務管理者のみ付与

### 8.3 テンプレート状態管理

テンプレートには以下の状態があります：

- **DRAFT**: 下書き状態（使用不可）
- **ACTIVE**: 有効状態（使用可能）
- **INACTIVE**: 無効状態（使用不可）
- **ARCHIVED**: アーカイブ状態（参照のみ可能）

各状態の遷移は以下のルールに従います：

- DRAFT → ACTIVE: 承認プロセスを経て公開
- ACTIVE → INACTIVE: 一時的に使用停止
- INACTIVE → ACTIVE: 再有効化
- ACTIVE/INACTIVE → ARCHIVED: 完全に使用終了