# トランザクションログ機能

## 1. 概要

トランザクションログ機能は、SES管理システム内のトランザクション実行に関する情報を記録し、追跡可能性を確保するための機能です。本機能は、トランザクションのライフサイクル、パフォーマンス、例外発生などの情報を収集・保存し、運用監視やトラブルシューティング、監査証跡として活用することを目的とします。

記録されたトランザクションログは、システムの健全性評価、パフォーマンス分析、障害解析、不正アクセスの検知、監査対応など、様々な運用管理活動を支援します。

## 2. 機能構成

トランザクションログ機能は以下のコンポーネントで構成されます：

### 2.1 コンポーネント構成図

```
+----------------------------------+
| トランザクション実行サービス       |
|  - TransactionManager            |
|  - DistributedTransactionManager |
+----------------------------------+
             |
             | イベント発行
             v
+----------------------------------+
| トランザクションイベントリスナー    |
|  - TransactionListener           |
|  - TransactionSynchronization    |
+----------------------------------+
             |
             | ログエントリ生成
             v
+----------------------------------+
| トランザクションログサービス        |
|  - TransactionLogService         |
|  - LogFormatter                  |
+----------------------------------+
             |
             | 永続化
             v
+----------------------------------+
| ログストレージ                    |
|  - DatabaseLogRepository         |
|  - FileLogRepository             |
+----------------------------------+
```

### 2.2 主要コンポーネント

1. **TransactionLogService（トランザクションログサービス）**
   - トランザクションログの記録
   - ログレベルの制御
   - ログエントリのフォーマット管理

2. **TransactionListener（トランザクションリスナー）**
   - トランザクションイベントの捕捉
   - トランザクション状態変化の検知
   - TransactionLogServiceへのログエントリ転送

3. **TransactionLogRepository（トランザクションログリポジトリ）**
   - ログデータの永続化
   - ログ検索機能の提供
   - 保存期間管理

4. **LogFormatter（ログフォーマッター）**
   - ログエントリの標準フォーマット
   - イベント種別ごとのフォーマット
   - データ量最適化

5. **TransactionLogAnalyzer（トランザクションログ分析器）**
   - ログデータの集計・分析
   - パフォーマンス指標の抽出
   - 異常パターンの検出

## 3. ログ記録機能

### 3.1 トランザクションイベント取得

#### 3.1.1 イベント種別

| イベント種別 | 説明 | 優先度 |
|------------|------|-------|
| TRANSACTION_BEGIN | トランザクション開始 | NORMAL |
| TRANSACTION_COMMIT | トランザクションコミット | NORMAL |
| TRANSACTION_ROLLBACK | トランザクションロールバック | HIGH |
| TRANSACTION_TIMEOUT | トランザクションタイムアウト | HIGH |
| TRANSACTION_SUSPEND | トランザクション一時停止 | LOW |
| TRANSACTION_RESUME | トランザクション再開 | LOW |
| DISTRIBUTED_TX_BEGIN | 分散トランザクション開始 | NORMAL |
| DISTRIBUTED_TX_PREPARE | 分散トランザクション準備 | NORMAL |
| DISTRIBUTED_TX_COMMIT | 分散トランザクションコミット | NORMAL |
| DISTRIBUTED_TX_ROLLBACK | 分散トランザクションロールバック | HIGH |
| DISTRIBUTED_TX_PHASE_CHANGE | 分散トランザクションフェーズ変更 | NORMAL |
| TX_RESOURCE_ACQUIRED | トランザクションリソース取得 | LOW |
| TX_RESOURCE_RELEASED | トランザクションリソース解放 | LOW |
| TX_ERROR | トランザクションエラー | HIGH |

#### 3.1.2 イベント取得メカニズム

1. **トランザクションマネージャーフック**
   - トランザクション操作メソッドのエントリ/イグジットで自動捕捉
   - TransactionSynchronizationの実装
   - アスペクト指向によるイベント捕捉

2. **明示的イベント通知**
   - トランザクション処理内からの明示的イベント発行
   - カスタムイベントの追加
   - ビジネスコンテキスト情報の付加

### 3.2 ログエントリ構造

```java
public class TransactionLogEntry {
    // 基本情報
    private String logId;                // ログエントリ一意識別子
    private String transactionId;        // トランザクションID
    private LocalDateTime timestamp;     // 記録時刻
    private String eventType;            // イベント種別
    private TransactionStatus status;    // トランザクション状態
    private LogLevel logLevel;           // ログレベル
    
    // トランザクション情報
    private boolean isDistributed;       // 分散トランザクションフラグ
    private String distributedTxId;      // 分散トランザクションID（該当時）
    private String transactionName;      // トランザクション名
    private TransactionDefinition definition; // トランザクション定義
    private long executionTimeMillis;    // 実行時間（ミリ秒）
    
    // コンテキスト情報
    private String applicationName;      // アプリケーション名
    private String moduleName;           // モジュール名
    private String className;            // クラス名
    private String methodName;           // メソッド名
    private String userId;               // 実行ユーザーID
    
    // リソース情報
    private List<String> resourceIds;    // 関連リソースID
    private Map<String, Object> resourceStats; // リソース統計情報
    
    // エラー情報
    private String errorCode;            // エラーコード
    private String errorMessage;         // エラーメッセージ
    private String stackTrace;           // スタックトレース（必要な場合）
    
    // メタデータ
    private Map<String, Object> metadata; // カスタムメタデータ
    
    // getterとsetterメソッド
}
```

### 3.3 ログレベル管理

#### 3.3.1 ログレベル定義

```java
public enum LogLevel {
    TRACE(0, "詳細なデバッグ情報"),
    DEBUG(1, "デバッグ情報"),
    INFO(2, "一般的な情報"),
    WARN(3, "警告情報"),
    ERROR(4, "エラー情報"),
    FATAL(5, "致命的エラー情報");
    
    private final int level;
    private final String description;
    
    // コンストラクタ、getter
}
```

#### 3.3.2 ログレベル制御

1. **グローバル設定**
   - システム全体のデフォルトログレベル
   - 環境ごとの設定（開発、テスト、本番）
   - 動的な変更機能

2. **モジュール別設定**
   - 機能モジュールごとのログレベル設定
   - 業務重要度に応じた調整

3. **イベント種別による調整**
   - イベント種別ごとのデフォルトログレベル
   - 優先度ベースの記録判断

### 3.4 ログフォーマット

#### 3.4.1 標準フォーマット

1. **構造化ログフォーマット**
   - JSON形式でのログ出力
   - 標準フィールドの定義
   - 拡張フィールドの許容

2. **テキストフォーマット**
   - 人間可読なテキスト形式
   - フィールド区切り文字の標準化
   - 固定フォーマットと可変フォーマット

#### 3.4.2 フォーマット例

**JSON形式**:
```json
{
  "logId": "TXL-20250514-123456",
  "transactionId": "TX-98765432",
  "timestamp": "2025-05-14T13:45:30.123Z",
  "eventType": "TRANSACTION_COMMIT",
  "status": "COMMITTED",
  "logLevel": "INFO",
  "isDistributed": false,
  "transactionName": "createEngineerProfile",
  "applicationName": "SESManager",
  "moduleName": "EngineerManagement",
  "className": "jp.co.example.sesapp.engineer.service.EngineerService",
  "methodName": "createEngineerProfile",
  "userId": "admin123",
  "executionTimeMillis": 354,
  "resourceIds": ["DB_MAIN", "FILE_STORAGE"],
  "metadata": {
    "engineerId": "ENG-20250514-001",
    "operationType": "CREATE"
  }
}
```

**テキスト形式**:
```
[2025-05-14 13:45:30.123] [INFO] [TX-98765432] TRANSACTION_COMMIT - トランザクション完了 (実行時間: 354ms) - createEngineerProfile - ユーザー: admin123 - リソース: [DB_MAIN, FILE_STORAGE]
```

## 4. ログ永続化機能

### 4.1 ストレージ戦略

#### 4.1.1 ストレージ種別

1. **データベースストレージ**
   - リレーショナルデータベースへの保存
   - インデックス最適化
   - クエリパフォーマンス確保

2. **ファイルストレージ**
   - ローテーション機能付きファイル出力
   - 圧縮アーカイブ
   - 保存期間管理

3. **分散ログストレージ**
   - 大規模システム向けの分散ログ保存
   - シャーディング
   - 高可用性確保

#### 4.1.2 データ保持ポリシー

| データ種別 | 保持期間 | ストレージ種別 | アーカイブ方針 |
|----------|---------|--------------|-------------|
| 通常トランザクション | 30日 | データベース | 90日後に削除 |
| エラートランザクション | 90日 | データベース | 1年後に削除 |
| 重要業務トランザクション | 1年 | データベース+ファイル | 5年間アーカイブ |
| 監査対象トランザクション | 5年 | データベース+ファイル | 10年間アーカイブ |

### 4.2 パフォーマンス最適化

#### 4.2.1 ログバッファリング

1. **非同期ロギング**
   - メモリバッファによる一時保持
   - バッチ書き込み
   - 定期的なフラッシュ

2. **バッファ設定**
   - バッファサイズ: 1000エントリまたは10MB
   - フラッシュ間隔: 5秒
   - 緊急フラッシュ条件: ERROR以上のログレベル

#### 4.2.2 書き込みパフォーマンス

1. **書き込み最適化**
   - バルクインサート
   - 接続プーリング
   - 書き込み専用コネクション

2. **オーバーヘッド管理**
   - ログ生成オーバーヘッド: < 1ms
   - ログ書き込みオーバーヘッド: 非同期処理で分離
   - ディスクI/O最適化

### 4.3 データアクセス

#### 4.3.1 検索インターフェース

```java
public interface TransactionLogRepository {
    /**
     * トランザクションIDによるログエントリ検索
     * @param transactionId トランザクションID
     * @return 該当するログエントリリスト
     */
    List<TransactionLogEntry> findByTransactionId(String transactionId);
    
    /**
     * 期間指定によるログエントリ検索
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @param criteria 検索条件
     * @param pageable ページネーション情報
     * @return 該当するログエントリのページ
     */
    Page<TransactionLogEntry> findByTimeRange(
        LocalDateTime startTime, 
        LocalDateTime endTime, 
        TransactionLogCriteria criteria, 
        Pageable pageable
    );
    
    /**
     * エラーログの検索
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @param errorCodes エラーコード（指定があれば）
     * @param pageable ページネーション情報
     * @return エラーログエントリのページ
     */
    Page<TransactionLogEntry> findErrorLogs(
        LocalDateTime startTime, 
        LocalDateTime endTime, 
        List<String> errorCodes, 
        Pageable pageable
    );
    
    /**
     * トランザクション実行統計の取得
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @param groupBy グループ化キー（モジュール、メソッドなど）
     * @return 統計情報
     */
    List<TransactionStatistics> getTransactionStatistics(
        LocalDateTime startTime, 
        LocalDateTime endTime, 
        String groupBy
    );
}
```

#### 4.3.2 クエリパフォーマンス

1. **インデックス戦略**
   - 主要検索フィールドのインデックス化
   - 複合インデックスの活用
   - インデックス使用状況の監視

2. **クエリ最適化**
   - 大量データ取得のページネーション
   - 必要な列のみの取得
   - クエリ実行計画の最適化

## 5. ログ分析機能

### 5.1 リアルタイム監視

#### 5.1.1 監視メトリクス

1. **基本メトリクス**
   - トランザクション数（総数、成功、失敗）
   - 平均実行時間
   - エラー率
   - アクティブトランザクション数

2. **パフォーマンスメトリクス**
   - 95パーセンタイル実行時間
   - 最長実行トランザクション
   - リソース使用効率
   - コミット/ロールバック比率

#### 5.1.2 アラート条件

| アラート名 | 条件 | 重大度 | アクション |
|----------|------|-------|----------|
| 高エラー率 | 5分間でエラー率 > 10% | 重大 | 管理者通知、自動診断 |
| 長時間トランザクション | 単一TX > 30秒 | 警告 | ログ記録、監視強化 |
| トランザクションスパイク | 通常の3倍以上のTX/分 | 警告 | リソース監視、原因調査 |
| リソース枯渇 | コネクションプール使用率 > 90% | 重大 | スケーリング、管理者通知 |
| デッドロック検出 | デッドロックイベント発生 | 警告 | トランザクションログ分析 |

### 5.2 統計分析

#### 5.2.1 集計レポート

1. **定期レポート**
   - 日次/週次/月次統計
   - トレンド分析
   - リソース使用パターン

2. **カスタムレポート**
   - モジュール別パフォーマンス
   - ユーザー別アクティビティ
   - エラーパターン分析

#### 5.2.2 統計データモデル

```java
public class TransactionStatistics {
    // 集計キー
    private String groupKey;          // グループ化キー（モジュール、メソッド等）
    private LocalDateTime periodStart; // 期間開始
    private LocalDateTime periodEnd;   // 期間終了
    
    // 基本統計
    private long totalCount;          // トランザクション総数
    private long successCount;        // 成功数
    private long failureCount;        // 失敗数
    private double successRate;       // 成功率
    
    // 時間統計
    private double avgExecutionTimeMs; // 平均実行時間（ミリ秒）
    private double minExecutionTimeMs; // 最小実行時間
    private double maxExecutionTimeMs; // 最大実行時間
    private double medianExecutionTimeMs; // 中央値実行時間
    private double p95ExecutionTimeMs;   // 95パーセンタイル実行時間
    
    // リソース統計
    private Map<String, ResourceUsageStats> resourceUsage; // リソース使用統計
    
    // エラー統計
    private Map<String, Integer> errorCounts; // エラーコード別カウント
    private String mostFrequentError;        // 最も頻発したエラー
    
    // getter, setterメソッド
}
```

### 5.3 異常検知

#### 5.3.1 検知メカニズム

1. **パターン認識**
   - 既知のエラーパターン検出
   - 異常な時間パターン検出
   - リソース競合パターン検出

2. **機械学習活用**
   - 正常パターンの学習
   - 異常値検出
   - 予測モデルによる事前警告

#### 5.3.2 分析アクション

1. **根本原因分析**
   - 関連トランザクションの抽出
   - コンテキスト情報の相関
   - エラーチェーンの追跡

2. **対策推奨**
   - 類似事例のマッチング
   - 解決パターンの提案
   - リソース調整推奨

## 6. 監査対応機能

### 6.1 監査ログフィルタリング

#### 6.1.1 監査対象操作

| 業務領域 | 監査対象トランザクション | 記録レベル |
|---------|----------------------|----------|
| 契約管理 | 契約書作成、承認、締結 | 詳細 |
| 請求支払 | 請求書発行、支払い処理 | 詳細 |
| 技術者管理 | 重要個人情報変更 | 詳細 |
| ユーザー管理 | 権限変更、ユーザー作成 | 詳細 |
| 一般業務 | その他のデータ変更 | 標準 |
| 参照操作 | データ参照のみ | 最小限 |

#### 6.1.2 監査ログ記録ポリシー

1. **詳細記録ポリシー**
   - トランザクション全フェーズの記録
   - 変更前後の値の記録（重要フィールド）
   - 実行コンテキストの完全な記録
   - 関連リソースアクセスの記録

2. **標準記録ポリシー**
   - トランザクション主要イベントの記録
   - 変更の概要記録
   - 基本的な実行コンテキスト

3. **最小限記録ポリシー**
   - トランザクション開始・終了イベントのみ
   - 基本的なアクセス情報

### 6.2 監査レポート生成

#### 6.2.1 標準監査レポート

1. **アクセス監査レポート**
   - ユーザー別アクセスログ
   - 時間帯別アクセスパターン
   - 異常アクセスフラグ

2. **変更監査レポート**
   - エンティティ種別別変更履歴
   - 重要データ変更履歴
   - 承認フロー履歴

3. **コンプライアンスレポート**
   - 規制要件対応状況
   - アクセス制御有効性
   - データ保護状況

#### 6.2.2 カスタム監査クエリ

```java
public interface AuditLogQueryService {
    /**
     * 特定ユーザーのアクション履歴検索
     * @param userId ユーザーID
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @param actionTypes アクション種別（指定あれば）
     * @return 監査ログエントリリスト
     */
    List<AuditLogEntry> queryUserActions(
        String userId, 
        LocalDateTime startTime, 
        LocalDateTime endTime, 
        List<String> actionTypes
    );
    
    /**
     * 特定エンティティの変更履歴検索
     * @param entityType エンティティ種別
     * @param entityId エンティティID
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @return 監査ログエントリリスト
     */
    List<AuditLogEntry> queryEntityChanges(
        String entityType, 
        String entityId, 
        LocalDateTime startTime, 
        LocalDateTime endTime
    );
    
    /**
     * 特定フィールドの変更履歴検索
     * @param entityType エンティティ種別
     * @param fieldName フィールド名
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @return 監査ログエントリリスト
     */
    List<AuditLogEntry> queryFieldChanges(
        String entityType, 
        String fieldName, 
        LocalDateTime startTime, 
        LocalDateTime endTime
    );
}
```

### 6.3 証跡保全機能

#### 6.3.1 改ざん防止

1. **ハッシュチェーン**
   - 各ログエントリのハッシュ化
   - 前エントリのハッシュを含めたチェーン形成
   - 定期的なハッシュ検証

2. **デジタル署名**
   - 監査ログのバッチ署名
   - タイムスタンプ認証
   - 署名検証機能

#### 6.3.2 エクスポート機能

1. **標準フォーマット**
   - CSV/Excel形式
   - PDF形式（署名付き）
   - 構造化JSONフォーマット

2. **エクスポート制御**
   - アクセス権限検証
   - エクスポート操作の監査記録
   - 匿名化オプション（必要に応じて）

## 7. 運用管理機能

### 7.1 設定管理

#### 7.1.1 設定パラメータ

| パラメータ | 説明 | デフォルト値 | 変更可否 |
|----------|------|------------|---------|
| logLevel | グローバルログレベル | INFO | 実行時変更可 |
| bufferSize | ログバッファサイズ | 1000 | 再起動必要 |
| flushInterval | バッファフラッシュ間隔(ms) | 5000 | 実行時変更可 |
| retentionDays | ログ保持日数 | 30 | 実行時変更可 |
| maxQueryResults | 最大クエリ結果数 | 10000 | 実行時変更可 |
| performanceLoggingEnabled | パフォーマンスログ有効化 | true | 実行時変更可 |
| extendedLoggingForModules | 拡張ログ対象モジュール | [] | 実行時変更可 |

#### 7.1.2 設定インターフェース

```java
public interface TransactionLogConfigService {
    /**
     * 現在の設定を取得
     * @return ログ設定
     */
    TransactionLogConfig getConfiguration();
    
    /**
     * 設定を更新
     * @param config 新しい設定
     * @return 更新結果
     */
    ConfigUpdateResult updateConfiguration(TransactionLogConfig config);
    
    /**
     * モジュール別設定を取得
     * @param moduleName モジュール名
     * @return モジュール設定
     */
    ModuleLogConfig getModuleConfiguration(String moduleName);
    
    /**
     * モジュール別設定を更新
     * @param moduleName モジュール名
     * @param config 新しい設定
     * @return 更新結果
     */
    ConfigUpdateResult updateModuleConfiguration(String moduleName, ModuleLogConfig config);
}
```

### 7.2 ストレージ管理

#### 7.2.1 保守タスク

1. **自動パージ**
   - 保持期間超過ログの削除
   - 段階的なパージ（古いものから）
   - アーカイブ前の確認

2. **アーカイブ**
   - 長期保存対象ログのアーカイブ
   - 圧縮保存
   - オフライン保管

#### 7.2.2 ストレージ監視

1. **容量モニタリング**
   - 使用容量の追跡
   - 増加率の分析
   - 警告閾値の設定

2. **パフォーマンス監視**
   - 書き込み速度
   - 読み取り応答時間
   - ディスクI/O負荷

### 7.3 トラブルシューティング支援

#### 7.3.1 診断ツール

1. **ログエクスプローラ**
   - トランザクション検索・表示
   - コンテキスト情報の展開
   - 関連トランザクションの追跡

2. **パターン分析器**
   - 類似エラーパターンの検索
   - 時系列相関分析
   - ボトルネック特定

#### 7.3.2 サポート情報出力

1. **診断パッケージ生成**
   - 特定期間のログ抽出
   - システム設定情報
   - 関連メトリクスデータ

2. **匿名化オプション**
   - 個人情報の自動マスキング
   - 機密データの除外
   - 匿名化ポリシーの設定