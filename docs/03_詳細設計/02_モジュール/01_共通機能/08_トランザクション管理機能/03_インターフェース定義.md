# トランザクション管理機能インターフェース定義

## 1. 概要

トランザクション管理機能が提供するインターフェースおよび依存するインターフェースを定義します。これらのインターフェースは、SES管理システム内の各業務モジュールがトランザクション管理機能を利用するための標準化された方法を提供します。

## 2. 提供インターフェース

トランザクション管理機能は以下のインターフェースを他のモジュールに提供します：

### 2.1 TransactionManager インターフェース

トランザクションの基本操作を提供するインターフェースです。

```java
public interface TransactionManager {
    /**
     * 新しいトランザクションを開始する
     * @param definition トランザクション定義
     * @return トランザクションステータス
     */
    TransactionStatus begin(TransactionDefinition definition);
    
    /**
     * 現在のトランザクションをコミットする
     * @param status トランザクションステータス
     */
    void commit(TransactionStatus status);
    
    /**
     * 現在のトランザクションをロールバックする
     * @param status トランザクションステータス
     */
    void rollback(TransactionStatus status);
    
    /**
     * 現在アクティブなトランザクションがあるか確認する
     * @return トランザクションがアクティブな場合はtrue
     */
    boolean isActive();
    
    /**
     * 現在のトランザクションステータスを取得する
     * @return 現在のトランザクションステータス、トランザクションがない場合はnull
     */
    TransactionStatus getCurrentTransactionStatus();
    
    /**
     * セーブポイントを作成する
     * @param status 現在のトランザクションステータス
     * @param savepointName セーブポイント名
     * @return 作成されたセーブポイント
     */
    Object createSavepoint(TransactionStatus status, String savepointName);
    
    /**
     * 指定したセーブポイントまでロールバックする
     * @param status 現在のトランザクションステータス
     * @param savepoint セーブポイント
     */
    void rollbackToSavepoint(TransactionStatus status, Object savepoint);
    
    /**
     * セーブポイントを解放する
     * @param status 現在のトランザクションステータス
     * @param savepoint セーブポイント
     */
    void releaseSavepoint(TransactionStatus status, Object savepoint);
}
```

### 2.2 TransactionTemplate インターフェース

トランザクション内での処理を簡潔に記述するためのテンプレートインターフェースです。

```java
public interface TransactionTemplate {
    /**
     * トランザクション内で処理を実行する
     * @param action 実行する処理
     * @return 処理結果
     */
    <T> T execute(TransactionCallback<T> action);
    
    /**
     * 読み取り専用トランザクション内で処理を実行する
     * @param action 実行する処理
     * @return 処理結果
     */
    <T> T executeReadOnly(TransactionCallback<T> action);
    
    /**
     * トランザクション定義を設定する
     * @param definition トランザクション定義
     */
    void setTransactionDefinition(TransactionDefinition definition);
}
```

### 2.3 TransactionCallback インターフェース

トランザクション内で実行する処理を定義するコールバックインターフェースです。

```java
public interface TransactionCallback<T> {
    /**
     * トランザクション内で実行される処理
     * @param status 現在のトランザクションステータス
     * @return 処理結果
     */
    T doInTransaction(TransactionStatus status);
}
```

### 2.4 DistributedTransactionManager インターフェース

分散トランザクションを管理するインターフェースです。

```java
public interface DistributedTransactionManager {
    /**
     * 分散トランザクションを開始する
     * @param participants 参加サービスリスト
     * @param timeout タイムアウト（秒）
     * @return 分散トランザクションコンテキスト
     */
    DistributedTransactionContext beginDistributedTransaction(List<String> participants, int timeout);
    
    /**
     * 分散トランザクションの準備フェーズを実行する（2PCの第1フェーズ）
     * @param context 分散トランザクションコンテキスト
     * @return 準備結果（すべての参加者が準備完了ならtrue）
     */
    boolean prepareDistributedTransaction(DistributedTransactionContext context);
    
    /**
     * 分散トランザクションをコミットする（2PCの第2フェーズ）
     * @param context 分散トランザクションコンテキスト
     * @return コミット結果
     */
    DistributedTransactionResult commitDistributedTransaction(DistributedTransactionContext context);
    
    /**
     * 分散トランザクションをロールバックする
     * @param context 分散トランザクションコンテキスト
     */
    void rollbackDistributedTransaction(DistributedTransactionContext context);
    
    /**
     * 分散トランザクションの状態を取得する
     * @param transactionId 分散トランザクションID
     * @return トランザクション状態
     */
    DistributedTransactionStatus getDistributedTransactionStatus(String transactionId);
    
    /**
     * 補償トランザクションを実行する
     * @param context 分散トランザクションコンテキスト
     * @return 補償実行結果
     */
    CompensationResult executeCompensation(DistributedTransactionContext context);
}
```

### 2.5 TransactionSynchronization インターフェース

トランザクションの前後に処理を追加するためのインターフェースです。

```java
public interface TransactionSynchronization {
    /**
     * トランザクション開始前に呼び出される
     * @param transactionId トランザクションID
     */
    void beforeTransaction(String transactionId);
    
    /**
     * トランザクションコミット前に呼び出される
     * @param transactionId トランザクションID
     */
    void beforeCommit(String transactionId);
    
    /**
     * トランザクションコミット後に呼び出される
     * @param transactionId トランザクションID
     */
    void afterCommit(String transactionId);
    
    /**
     * トランザクションロールバック前に呼び出される
     * @param transactionId トランザクションID
     */
    void beforeRollback(String transactionId);
    
    /**
     * トランザクションロールバック後に呼び出される
     * @param transactionId トランザクションID
     */
    void afterRollback(String transactionId);
    
    /**
     * トランザクション完了後（コミットまたはロールバック後）に呼び出される
     * @param transactionId トランザクションID
     */
    void afterCompletion(String transactionId);
}
```

### 2.6 TransactionEventPublisher インターフェース

トランザクション関連イベントを発行するインターフェースです。

```java
public interface TransactionEventPublisher {
    /**
     * トランザクション開始イベントを発行する
     * @param transactionId トランザクションID
     * @param attributes トランザクション属性
     */
    void publishTransactionBeginEvent(String transactionId, Map<String, Object> attributes);
    
    /**
     * トランザクションコミットイベントを発行する
     * @param transactionId トランザクションID
     * @param executionTime 実行時間（ミリ秒）
     */
    void publishTransactionCommitEvent(String transactionId, long executionTime);
    
    /**
     * トランザクションロールバックイベントを発行する
     * @param transactionId トランザクションID
     * @param cause ロールバック原因
     */
    void publishTransactionRollbackEvent(String transactionId, Throwable cause);
    
    /**
     * トランザクションタイムアウトイベントを発行する
     * @param transactionId トランザクションID
     * @param timeoutDuration タイムアウト時間（ミリ秒）
     */
    void publishTransactionTimeoutEvent(String transactionId, long timeoutDuration);
}
```

### 2.7 TransactionLogService インターフェース

トランザクションログを管理するインターフェースです。

```java
public interface TransactionLogService {
    /**
     * トランザクションログを記録する
     * @param log トランザクションログエントリ
     */
    void logTransaction(TransactionLog log);
    
    /**
     * トランザクションIDに基づいてログを検索する
     * @param transactionId トランザクションID
     * @return 関連するトランザクションログのリスト
     */
    List<TransactionLog> findLogsByTransactionId(String transactionId);
    
    /**
     * 期間内のトランザクションログを検索する
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @return 該当するトランザクションログのリスト
     */
    List<TransactionLog> findLogsByTimeRange(LocalDateTime startTime, LocalDateTime endTime);
    
    /**
     * 特定の操作に関するトランザクションログを検索する
     * @param operation トランザクション操作
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @return 該当するトランザクションログのリスト
     */
    List<TransactionLog> findLogsByOperation(String operation, LocalDateTime startTime, LocalDateTime endTime);
    
    /**
     * エラーが発生したトランザクションのログを検索する
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @return エラーがあるトランザクションログのリスト
     */
    List<TransactionLog> findErrorLogs(LocalDateTime startTime, LocalDateTime endTime);
}
```

## 3. 要求インターフェース

トランザクション管理機能が他のモジュールやシステムコンポーネントに要求するインターフェースです：

### 3.1 DataSourceProvider インターフェース

データソースを提供するインターフェースです。

```java
public interface DataSourceProvider {
    /**
     * 指定した名前のデータソースを取得する
     * @param name データソース名
     * @return データソース
     */
    DataSource getDataSource(String name);
    
    /**
     * 利用可能なすべてのデータソース名を取得する
     * @return データソース名のリスト
     */
    List<String> getAllDataSourceNames();
    
    /**
     * デフォルトのデータソースを取得する
     * @return デフォルトデータソース
     */
    DataSource getDefaultDataSource();
}
```

### 3.2 ConnectionManager インターフェース

データベース接続を管理するインターフェースです。

```java
public interface ConnectionManager {
    /**
     * 新しい接続を取得する
     * @param dataSourceName データソース名
     * @return データベース接続
     */
    Connection getConnection(String dataSourceName);
    
    /**
     * 接続をリリースする
     * @param connection リリースする接続
     */
    void releaseConnection(Connection connection);
    
    /**
     * 接続のトランザクション設定を構成する
     * @param connection 構成する接続
     * @param isolation 分離レベル
     * @param readOnly 読み取り専用フラグ
     */
    void configureConnection(Connection connection, int isolation, boolean readOnly);
}
```

### 3.3 AuditService インターフェース

監査記録を管理するインターフェースです。

```java
public interface AuditService {
    /**
     * トランザクション監査イベントを記録する
     * @param eventType イベント種別
     * @param transactionId トランザクションID
     * @param userId 実行ユーザーID
     * @param details 詳細情報
     */
    void recordTransactionAuditEvent(String eventType, String transactionId, String userId, Map<String, Object> details);
    
    /**
     * トランザクションイベントの監査証跡を検索する
     * @param transactionId トランザクションID
     * @return 監査証跡エントリのリスト
     */
    List<AuditEntry> findAuditTrailByTransactionId(String transactionId);
}
```

### 3.4 SystemClock インターフェース

システム時刻を提供するインターフェースです。

```java
public interface SystemClock {
    /**
     * 現在のシステム時刻を取得する
     * @return 現在の日時
     */
    LocalDateTime now();
    
    /**
     * 現在のシステム時刻をエポックミリ秒で取得する
     * @return 現在のエポックミリ秒
     */
    long currentTimeMillis();
    
    /**
     * 指定したタイムゾーンでの現在時刻を取得する
     * @param zoneId タイムゾーンID
     * @return 指定タイムゾーンでの現在時刻
     */
    LocalDateTime nowAt(ZoneId zoneId);
}
```

## 4. データ交換モデル

トランザクション管理機能が扱うデータモデルの定義です：

### 4.1 TransactionDefinition（トランザクション定義）

```java
public class TransactionDefinition {
    private String name;              // トランザクション名
    private TransactionPropagation propagation; // 伝播方式
    private TransactionIsolation isolation;     // 分離レベル
    private int timeout;             // タイムアウト（秒）
    private boolean readOnly;        // 読み取り専用フラグ
    private Set<Class<?>> rollbackFor;     // ロールバック対象例外
    private Set<Class<?>> noRollbackFor;   // ロールバック対象外例外
    
    // getter, setterメソッド
}
```

### 4.2 TransactionStatus（トランザクションステータス）

```java
public class TransactionStatus {
    private String transactionId;     // トランザクションID
    private boolean newTransaction;   // 新規トランザクションフラグ
    private boolean rollbackOnly;     // ロールバック専用フラグ
    private boolean completed;        // 完了フラグ
    private Object suspendedResources; // 一時停止リソース
    private List<Object> savepoints;  // セーブポイントリスト
    private LocalDateTime startTime;  // 開始時刻
    
    // getter, setterメソッド
    
    /**
     * トランザクションをロールバック専用にマークする
     */
    public void setRollbackOnly();
    
    /**
     * トランザクションがロールバック専用かを確認する
     * @return ロールバック専用ならtrue
     */
    public boolean isRollbackOnly();
    
    /**
     * トランザクションが完了しているかを確認する
     * @return 完了していればtrue
     */
    public boolean isCompleted();
}
```

### 4.3 DistributedTransactionContext（分散トランザクションコンテキスト）

```java
public class DistributedTransactionContext {
    private String distributedTransactionId; // 分散トランザクションID
    private List<String> participantIds;     // 参加サービスID
    private String coordinatorId;           // コーディネータID
    private Map<String, TransactionStatus> participantStatuses; // 参加者状態
    private DistributedTransactionStatus status; // 全体状態
    private LocalDateTime startTime;        // 開始時刻
    private int timeout;                   // タイムアウト（秒）
    private Map<String, Object> metadata;  // メタデータ
    
    // getter, setterメソッド
}
```

### 4.4 DistributedTransactionResult（分散トランザクション結果）

```java
public class DistributedTransactionResult {
    private String distributedTransactionId; // 分散トランザクションID
    private boolean success;               // 成功フラグ
    private Map<String, Boolean> participantResults; // 参加者ごとの結果
    private List<String> failedParticipants; // 失敗した参加者
    private String errorMessage;           // エラーメッセージ
    private LocalDateTime completionTime;  // 完了時刻
    private long executionTimeMillis;      // 実行時間（ミリ秒）
    
    // getter, setterメソッド
}
```

### 4.5 TransactionLog（トランザクションログ）

```java
public class TransactionLog {
    private String logId;             // ログID
    private String transactionId;     // トランザクションID
    private LocalDateTime timestamp;  // タイムスタンプ
    private String operation;         // 操作（開始、コミット、ロールバックなど）
    private String status;            // ステータス
    private long executionTimeMillis; // 実行時間（ミリ秒）
    private List<String> resourceIds; // リソースID
    private String userId;            // ユーザーID
    private String errorMessage;      // エラーメッセージ
    private Map<String, Object> metadata; // メタデータ
    
    // getter, setterメソッド
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

1. **トランザクション操作のレイテンシ**:
   - トランザクション開始: < 5ms（追加オーバーヘッド）
   - トランザクションコミット: < 10ms（追加オーバーヘッド）
   - トランザクションロールバック: < 15ms（追加オーバーヘッド）

2. **スループット**:
   - 単一サーバーでの同時トランザクション数: 1000トランザクション/秒以上
   - 分散トランザクション: 100トランザクション/秒以上

3. **リソース使用量**:
   - トランザクションコンテキスト当たりのメモリ使用量: < 10KB
   - アイドルトランザクションのリソース保持: 最小限化

### 5.2 セキュリティ要件

1. **トランザクション操作の認可**:
   - トランザクション操作（特に管理操作）は適切な認可チェックを行う
   - ユーザーコンテキストの追跡と監査ログへの記録

2. **データ保護**:
   - トランザクションログ内の機密データの保護
   - トランザクションIDの外部漏洩防止

### 5.3 信頼性要件

1. **データ整合性**:
   - ACID特性の保証（単一トランザクション）
   - 分散トランザクションでの結果整合性の保証

2. **障害回復**:
   - システム障害時のトランザクション状態回復
   - インプロセストランザクション検出と修復

3. **監視と診断**:
   - アクティブトランザクションの監視
   - 長時間実行トランザクションの検出と通知
   - トランザクション失敗の原因分析支援

### 5.4 運用要件

1. **設定可能性**:
   - トランザクションタイムアウトの設定
   - ロールバックポリシーのカスタマイズ
   - トランザクションログレベルの設定

2. **監視とアラート**:
   - 異常トランザクション（長時間実行、高頻度失敗）の検出
   - トランザクションパフォーマンス指標の提供

3. **トレーサビリティ**:
   - トランザクションのエンドツーエンド追跡
   - 関連するビジネスオペレーションとの紐付け

## 6. 利用モジュール

以下のモジュールがトランザクション管理機能を利用します：

| モジュール | 利用インターフェース | 用途 |
|----------|-------------------|------|
| 技術者管理 | TransactionTemplate | 技術者情報の一貫した更新 |
| 案件管理 | TransactionManager | 案件情報と関連データの整合性確保 |
| マッチング | TransactionTemplate | マッチング処理の整合性確保 |
| 契約管理 | DistributedTransactionManager | 契約処理と電子署名の整合性確保 |
| 勤怠工数管理 | TransactionTemplate | 勤怠データと工数データの整合性確保 |
| 請求支払管理 | DistributedTransactionManager | 請求処理と入金処理の整合性確保 |
| レポーティング | TransactionTemplate (readOnly) | レポートデータの一貫した読み取り |
| 認証認可機能 | TransactionTemplate | ユーザー・権限データの整合性確保 |
| ロギング機能 | TransactionSynchronization | トランザクションと連動したログ記録 |