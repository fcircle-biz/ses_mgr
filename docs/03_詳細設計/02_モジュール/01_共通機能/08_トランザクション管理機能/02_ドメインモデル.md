# トランザクション管理機能ドメインモデル

## 1. 概要

トランザクション管理機能のドメインモデルは、システム内でのトランザクション操作と状態を表現する中心的な概念モデルを定義します。本モデルは、トランザクションの境界、属性、状態、およびそれらの関係性を明確にし、一貫したトランザクション管理を実現するための基盤となります。

## 2. 主要エンティティ

### 2.1 TransactionContext（トランザクションコンテキスト）

トランザクションの実行コンテキストを表現するエンティティです。

**属性：**
- `transactionId`: トランザクションを一意に識別するID
- `startTime`: トランザクション開始時刻
- `timeoutDuration`: タイムアウト時間（ミリ秒）
- `status`: 現在のトランザクション状態（TransactionStatus型）
- `propagationBehavior`: 伝播方式（TransactionPropagation型）
- `isolationLevel`: 分離レベル（TransactionIsolation型）
- `readOnly`: 読み取り専用フラグ
- `resourceManagers`: 関連するリソースマネージャのリスト
- `userContext`: 実行ユーザーコンテキスト（監査用）

**ビジネスルール：**
- トランザクションIDは必ずシステムグローバルで一意であること
- タイムアウト時間が経過した場合、トランザクションは自動的にロールバックされること
- 読み取り専用トランザクションでは更新操作が禁止されること

### 2.2 TransactionResource（トランザクションリソース）

トランザクションが管理する個別のリソース（データベース接続など）を表現します。

**属性：**
- `resourceId`: リソースの一意識別子
- `resourceType`: リソースの種類（データベース、メッセージキューなど）
- `resourceName`: リソースの名前
- `connectionDetails`: 接続情報（抽象表現）
- `status`: 現在のリソース状態（準備完了、コミット済みなど）

**ビジネスルール：**
- リソースは明示的に解放されるか、トランザクション完了時に自動的に解放されること
- 同一トランザクション内では同一リソースの複数接続は最適化されること

### 2.3 TransactionLog（トランザクションログ）

トランザクションの実行履歴を記録するエンティティです。

**属性：**
- `logId`: ログエントリの一意識別子
- `transactionId`: 関連するトランザクションID
- `timestamp`: ログ記録時刻
- `operation`: 実行された操作（開始、コミット、ロールバックなど）
- `status`: 操作結果ステータス
- `executionTime`: 実行時間（ミリ秒）
- `resourceIds`: 関連するリソースIDリスト
- `metadata`: 追加メタデータ（JSONなど）
- `errorDetails`: エラー詳細情報（例外発生時）

**ビジネスルール：**
- すべてのトランザクション操作は監査のためにログに記録されること
- ログエントリは不変であり、作成後に変更できないこと

### 2.4 DistributedTransaction（分散トランザクション）

複数のサービスまたはリソースにまたがるトランザクションを表現します。

**属性：**
- `distributedTransactionId`: 分散トランザクションID
- `coordinatorId`: コーディネーターのサービスID
- `participantIds`: 参加サービスIDのリスト
- `status`: 現在の分散トランザクション状態
- `startTime`: 開始時刻
- `timeout`: タイムアウト設定
- `compensationStrategy`: 補償戦略情報
- `metadata`: トランザクションメタデータ

**ビジネスルール：**
- すべての参加者が準備完了状態になるまでコミットを実行しないこと
- タイムアウト後は定義された補償戦略に従って処理すること
- コーディネーターの障害時にはリカバリプロセスが実行されること

## 3. 値オブジェクト

### 3.1 TransactionPropagation（トランザクション伝播方式）

トランザクションの伝播方法を定義する列挙型です。

**値：**
- `REQUIRED`: 既存トランザクションがあれば参加し、なければ新規作成
- `REQUIRES_NEW`: 常に新しいトランザクションを作成
- `SUPPORTS`: 既存トランザクションがあれば参加し、なければトランザクションなしで実行
- `NOT_SUPPORTED`: トランザクションなしで実行（既存トランザクションは一時停止）
- `MANDATORY`: 既存トランザクションが必須（なければ例外）
- `NEVER`: トランザクションなしで実行（既存トランザクションがあれば例外）
- `NESTED`: 既存トランザクション内にネストされたトランザクションを作成

### 3.2 TransactionIsolation（トランザクション分離レベル）

データベーストランザクションの分離レベルを定義する列挙型です。

**値：**
- `READ_UNCOMMITTED`: コミットされていない変更の読み取りを許可
- `READ_COMMITTED`: コミットされた変更のみ読み取り可能
- `REPEATABLE_READ`: トランザクション中の再読み取りで同じ結果を保証
- `SERIALIZABLE`: 最も厳格な分離レベル、直列化可能

### 3.3 TransactionStatus（トランザクション状態）

トランザクションの現在の状態を表す列挙型です。

**値：**
- `ACTIVE`: アクティブなトランザクション
- `PREPARING`: コミット準備中（2PC用）
- `PREPARED`: コミット準備完了
- `COMMITTING`: コミット処理中
- `COMMITTED`: コミット完了
- `ROLLING_BACK`: ロールバック処理中
- `ROLLED_BACK`: ロールバック完了
- `UNKNOWN`: 状態不明（障害発生時など）
- `TIMED_OUT`: タイムアウト発生

### 3.4 TransactionDefinition（トランザクション定義）

トランザクションの属性を定義する値オブジェクトです。

**属性：**
- `name`: トランザクション名
- `propagation`: 伝播方式
- `isolation`: 分離レベル
- `timeout`: タイムアウト（秒）
- `readOnly`: 読み取り専用フラグ
- `rollbackFor`: ロールバック対象例外クラスリスト
- `noRollbackFor`: ロールバック対象外例外クラスリスト

## 4. ドメイン関連図

```
TransactionContext 1 --- * TransactionResource : 管理する
TransactionContext 1 --- * TransactionLog : 記録される
TransactionContext ---- TransactionDefinition : 定義される
DistributedTransaction 1 --- * TransactionContext : 調整する
```

## 5. 重要なビジネスルール

### 5.1 トランザクション整合性ルール

- 単一のトランザクションは原子性（すべて成功するか、すべて失敗するか）を保証すること
- トランザクション内のすべてのリソースは最終的に同じ状態（コミットまたはロールバック）となること
- ネストされたトランザクションでは、内部トランザクションの失敗は外部トランザクションに伝播可能であること
- 読み取り専用トランザクションではデータ変更操作を許可しないこと

### 5.2 トランザクション境界ルール

- トランザクション境界は明示的に定義され、適切な粒度で設計されること
- 長時間実行トランザクションは避け、タイムアウト制限を適用すること
- 分散トランザクションでは結果整合性または補償トランザクションによる一貫性確保を保証すること

### 5.3 例外処理ルール

- チェック例外はデフォルトではロールバックを引き起こさないこと
- 非チェック例外（RuntimeException）はデフォルトでロールバックを引き起こすこと
- ロールバックポリシーはトランザクション定義で明示的にカスタマイズ可能であること

### 5.4 監査とトレーサビリティルール

- すべてのトランザクション操作（開始、コミット、ロールバック）はログに記録されること
- トランザクションログはトランザクションID、実行ユーザー、タイムスタンプを含むこと
- 障害分析のために十分な情報がログに記録されること

## 6. ドメインサービス

### 6.1 TransactionDomainService

トランザクションのライフサイクル管理を行うドメインサービスです。

**主要機能：**
- トランザクションコンテキストの作成と管理
- トランザクション状態の遷移制御
- トランザクションリソースの追跡
- タイムアウト監視と制御

### 6.2 DistributedTransactionDomainService

分散トランザクションを管理するドメインサービスです。

**主要機能：**
- 分散トランザクションの調整
- 参加サービスとの通信
- 二相コミットプロトコルの実装
- 補償トランザクションの実行

### 6.3 TransactionLogDomainService

トランザクションログの管理を行うドメインサービスです。

**主要機能：**
- トランザクションイベントのログ記録
- ログの保存と検索
- 監査証跡の提供
- パフォーマンス統計の収集