# 通知機能 - インターフェース定義

## 1. インターフェース概要

通知機能モジュールは、システム全体に通知機能を提供するための複数のインターフェースを定義しています。これらのインターフェースにより、他のモジュールは通知を作成・管理し、ユーザーは通知を受信・操作することができます。

## 2. 提供インターフェース

### 2.1 NotificationService

通知の基本機能を提供するサービスインターフェースです。

#### インターフェース概要
- 通知の作成、取得、更新、削除の機能を提供する
- テンプレートベースの通知生成をサポートする
- ユーザーの通知リストの取得と管理を行う

#### メソッド

- **createNotification**
  - 説明: 新規通知を作成する
  - パラメータ:
    - type: NotificationType - 通知タイプ
    - recipients: List<User> - 受信者リスト
    - title: String - 通知タイトル
    - body: String - 通知本文
    - metadata: Map<String, Object> - メタデータ（省略可）
    - sender: User - 送信者（省略可）
  - 戻り値: List<Notification> - 作成された通知のリスト
  - 例外:
    - InvalidArgumentException - パラメータが不正な場合

- **createNotificationFromTemplate**
  - 説明: テンプレートを使用して通知を作成する
  - パラメータ:
    - templateKey: String - テンプレートキー
    - recipients: List<User> - 受信者リスト
    - parameters: Map<String, Object> - テンプレート変数
    - sender: User - 送信者（省略可）
  - 戻り値: List<Notification> - 作成された通知のリスト
  - 例外:
    - TemplateNotFoundException - テンプレートが存在しない場合
    - InvalidTemplateException - テンプレート変数が不足している場合

- **getUserNotifications**
  - 説明: ユーザーの通知リストを取得する
  - パラメータ:
    - username: String - ユーザー名
    - type: NotificationType - 通知タイプでフィルタリング（省略可）
    - readStatus: Boolean - 既読状態でフィルタリング（省略可）
    - pageable: Pageable - ページング情報
  - 戻り値: Page<Notification> - 通知のページング結果

- **getNotificationById**
  - 説明: 特定の通知を取得する
  - パラメータ:
    - id: UUID - 通知ID
    - username: String - ユーザー名（アクセス制御用）
  - 戻り値: Notification - 通知オブジェクト
  - 例外:
    - NotificationNotFoundException - 通知が存在しない場合
    - AccessDeniedException - ユーザーがアクセス権を持たない場合

- **markAsRead**
  - 説明: 通知を既読に設定する
  - パラメータ:
    - id: UUID - 通知ID
    - username: String - ユーザー名（アクセス制御用）
  - 戻り値: Notification - 更新された通知
  - 例外:
    - NotificationNotFoundException - 通知が存在しない場合
    - AccessDeniedException - ユーザーがアクセス権を持たない場合

- **markAllAsRead**
  - 説明: 全ての通知を既読に設定する
  - パラメータ:
    - username: String - ユーザー名
    - type: NotificationType - 通知タイプ（省略可）
  - 戻り値: int - 更新された通知の数

- **deleteNotification**
  - 説明: 通知を削除する
  - パラメータ:
    - id: UUID - 通知ID
    - username: String - ユーザー名（アクセス制御用）
  - 例外:
    - NotificationNotFoundException - 通知が存在しない場合
    - AccessDeniedException - ユーザーがアクセス権を持たない場合

- **getNotificationStream**
  - 説明: 通知のリアルタイムストリームを取得する
  - パラメータ:
    - username: String - ユーザー名
  - 戻り値: Flux<Notification> - 通知のリアクティブストリーム

- **archiveExpiredNotifications**
  - 説明: 期限切れの通知をアーカイブする
  - 戻り値: int - アーカイブされた通知の数

### 2.2 DeliveryService

通知の配信方法を管理するサービスインターフェースです。

#### インターフェース概要
- 通知の配信チャネル（アプリ内、メール）を管理する
- テンプレートの適用と変数置換を行う
- メール通知の送信を担当する

#### メソッド

- **sendEmailNotification**
  - 説明: メール通知を送信する
  - パラメータ:
    - notification: Notification - 送信する通知
  - 例外:
    - EmailDeliveryException - メール送信に失敗した場合

- **pushInAppNotification**
  - 説明: アプリ内通知をプッシュする
  - パラメータ:
    - notification: Notification - プッシュする通知

- **determineDeliveryChannels**
  - 説明: ユーザーと通知タイプに基づいて配信チャネルを決定する
  - パラメータ:
    - user: User - ユーザー
    - type: NotificationType - 通知タイプ
  - 戻り値: Set<DeliveryChannel> - 配信チャネルのセット

- **applyTemplate**
  - 説明: テンプレートに変数を適用する
  - パラメータ:
    - template: String - テンプレート文字列
    - parameters: Map<String, Object> - 変数マップ
  - 戻り値: String - 変数適用後の文字列
  - 例外:
    - TemplateProcessingException - テンプレート処理に失敗した場合

### 2.3 NotificationPreferenceService

ユーザーの通知設定を管理するサービスインターフェースです。

#### インターフェース概要
- ユーザーごとの通知設定を管理する
- 通知タイプごとの設定を提供する
- デフォルト設定の適用を行う

#### メソッド

- **getUserPreferences**
  - 説明: ユーザーの全通知設定を取得する
  - パラメータ:
    - username: String - ユーザー名
  - 戻り値: List<NotificationPreference> - 通知設定のリスト

- **updatePreference**
  - 説明: 通知設定を更新する
  - パラメータ:
    - username: String - ユーザー名
    - type: NotificationType - 通知タイプ
    - appEnabled: boolean - アプリ内通知の有効フラグ
    - emailEnabled: boolean - メール通知の有効フラグ
    - retentionDays: int - 保持期間（日数）
  - 戻り値: NotificationPreference - 更新された設定
  - 例外:
    - InvalidPreferenceException - 設定が不正な場合

- **resetToDefaults**
  - 説明: 設定をデフォルト値にリセットする
  - パラメータ:
    - username: String - ユーザー名

- **getPreference**
  - 説明: 特定の通知タイプの設定を取得する
  - パラメータ:
    - username: String - ユーザー名
    - type: NotificationType - 通知タイプ
  - 戻り値: NotificationPreference - 通知設定

### 2.4 NotificationTemplateService

通知テンプレートを管理するサービスインターフェースです。

#### インターフェース概要
- テンプレートの登録、取得、更新、削除を管理する
- テンプレートの検証を行う

#### メソッド

- **getTemplateByKey**
  - 説明: テンプレートキーによるテンプレート取得
  - パラメータ:
    - templateKey: String - テンプレートキー
  - 戻り値: NotificationTemplate - 通知テンプレート
  - 例外:
    - TemplateNotFoundException - テンプレートが存在しない場合

- **createTemplate**
  - 説明: 新規テンプレートを作成する
  - パラメータ:
    - templateKey: String - テンプレートキー
    - titleTemplate: String - タイトルテンプレート
    - bodyTemplate: String - 本文テンプレート
    - notificationType: NotificationType - 通知タイプ
    - metadataTemplate: String - メタデータテンプレート（省略可）
  - 戻り値: NotificationTemplate - 作成されたテンプレート
  - 例外:
    - TemplateAlreadyExistsException - 同じキーのテンプレートが既に存在する場合
    - InvalidTemplateException - テンプレートが不正な場合

- **updateTemplate**
  - 説明: テンプレートを更新する
  - パラメータ:
    - templateKey: String - テンプレートキー
    - titleTemplate: String - タイトルテンプレート
    - bodyTemplate: String - 本文テンプレート
    - notificationType: NotificationType - 通知タイプ
    - metadataTemplate: String - メタデータテンプレート（省略可）
  - 戻り値: NotificationTemplate - 更新されたテンプレート
  - 例外:
    - TemplateNotFoundException - テンプレートが存在しない場合
    - InvalidTemplateException - テンプレートが不正な場合

- **deleteTemplate**
  - 説明: テンプレートを削除する
  - パラメータ:
    - templateKey: String - テンプレートキー
  - 例外:
    - TemplateNotFoundException - テンプレートが存在しない場合

- **validateTemplate**
  - 説明: テンプレートの変数と構文を検証する
  - パラメータ:
    - template: String - テンプレート文字列
  - 戻り値: List<String> - 必要な変数のリスト
  - 例外:
    - InvalidTemplateException - テンプレートが不正な場合

## 3. 要求インターフェース

### 3.1 EmailService

メール送信機能を提供するインターフェースです。

#### インターフェース概要
- メールの作成と送信を担当する
- テンプレートベースのメール送信をサポートする
- 送信状態の追跡を行う

#### 主要メソッド

- **sendEmail**
  - 説明: メールを送信する
  - パラメータ:
    - to: String - 宛先メールアドレス
    - subject: String - 件名
    - body: String - 本文
    - isHtml: boolean - HTML形式かどうか
  - 戻り値: String - メッセージID

- **sendTemplatedEmail**
  - 説明: テンプレートを使用してメールを送信する
  - パラメータ:
    - to: String - 宛先メールアドレス
    - templateName: String - テンプレート名
    - variables: Map<String, Object> - テンプレート変数
  - 戻り値: String - メッセージID

### 3.2 UserService

ユーザー情報管理機能を提供するインターフェースです。

#### インターフェース概要
- ユーザー情報の取得と検証を行う
- ユーザーの検索と権限のチェックを提供する

#### 主要メソッド

- **getUserById**
  - 説明: IDによるユーザー取得
  - パラメータ:
    - userId: String - ユーザーID
  - 戻り値: User - ユーザー情報
  - 例外:
    - UserNotFoundException - ユーザーが存在しない場合

- **getUserByUsername**
  - 説明: ユーザー名によるユーザー取得
  - パラメータ:
    - username: String - ユーザー名
  - 戻り値: User - ユーザー情報
  - 例外:
    - UserNotFoundException - ユーザーが存在しない場合

- **getUsersWithRole**
  - 説明: 特定ロールを持つユーザーの取得
  - パラメータ:
    - role: String - ロール名
  - 戻り値: List<User> - ユーザーリスト

- **validateUser**
  - 説明: ユーザー存在確認と権限検証
  - パラメータ:
    - username: String - ユーザー名
    - permission: String - 必要な権限（省略可）
  - 戻り値: boolean - ユーザーが存在し、指定された権限を持つ場合はtrue

### 3.3 EventPublisher

イベント発行機能を提供するインターフェースです。

#### インターフェース概要
- アプリケーションイベントの発行機能を提供する
- 非同期イベント処理をサポートする

#### 主要メソッド

- **publishEvent**
  - 説明: イベントを発行する
  - パラメータ:
    - event: Object - 発行するイベント

- **publishEventAsync**
  - 説明: イベントを非同期で発行する
  - パラメータ:
    - event: Object - 発行するイベント
  - 戻り値: CompletableFuture<Void> - 完了フューチャー

## 4. データ交換モデル

### 4.1 通知DTOクラス

#### NotificationDto

通知のデータ転送オブジェクトです。

```
public class NotificationDto {
    private UUID id;
    private String type;
    private String title;
    private String body;
    private Map<String, Object> metadata;
    private UserDto sender;
    private UserDto recipient;
    private boolean read;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    // getters, setters
}
```

#### NotificationRequestDto

通知作成リクエストのデータ転送オブジェクトです。

```
public class NotificationRequestDto {
    private String type;
    private List<String> recipientUsernames;
    private String title;
    private String body;
    private Map<String, Object> metadata;
    private String senderUsername;
    // getters, setters
}
```

#### TemplatedNotificationRequestDto

テンプレートベースの通知作成リクエストのデータ転送オブジェクトです。

```
public class TemplatedNotificationRequestDto {
    private String templateKey;
    private List<String> recipientUsernames;
    private Map<String, Object> parameters;
    private String senderUsername;
    // getters, setters
}
```

### 4.2 通知設定DTOクラス

#### NotificationPreferenceDto

通知設定のデータ転送オブジェクトです。

```
public class NotificationPreferenceDto {
    private String notificationType;
    private boolean appEnabled;
    private boolean emailEnabled;
    private int retentionDays;
    // getters, setters
}
```

#### PreferenceUpdateRequestDto

通知設定更新リクエストのデータ転送オブジェクトです。

```
public class PreferenceUpdateRequestDto {
    private boolean appEnabled;
    private boolean emailEnabled;
    private int retentionDays;
    // getters, setters, validation
}
```

### 4.3 通知テンプレートDTOクラス

#### NotificationTemplateDto

通知テンプレートのデータ転送オブジェクトです。

```
public class NotificationTemplateDto {
    private String templateKey;
    private String titleTemplate;
    private String bodyTemplate;
    private String notificationType;
    private String metadataTemplate;
    private boolean active;
    // getters, setters
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- 通知作成: レスポンスタイム 100ms以内
- 通知一覧取得: 1000件の通知を200ms以内
- リアルタイム通知配信: 作成から配信までのレイテンシ 500ms以内
- 同時接続ユーザー数: SSEストリーム同時接続 最大5000
- 通知のバッチ処理: 1分あたり10000件の処理能力

### 5.2 セキュリティ要件

- 通知アクセス制御: ユーザーは自分宛の通知のみアクセス可能
- メタデータサニタイゼーション: ユーザー入力由来のメタデータはエスケープ処理
- テンプレート検証: インジェクション対策のための入力検証
- 通知コンテンツの機密性: 機密情報はメール通知に含めない
- アクセスログ: 通知の操作に関するセキュリティログを記録

### 5.3 可用性要件

- サービス稼働率: 99.9%以上
- 障害復旧時間: 5分以内（通知機能単体障害の場合）
- データバックアップ: 日次バックアップ、30日保持
- リアルタイム通知の代替手段: SSE障害時にはポーリングへのフォールバック
- アーカイブ機能: 古い通知は自動アーカイブし、システムパフォーマンスを維持