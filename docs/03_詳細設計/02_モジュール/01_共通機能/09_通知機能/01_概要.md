# 通知機能 - 概要

## 1. 目的と責務

通知機能は、SES業務システム全体で発生するイベントや情報をユーザーに伝達するための基盤機能です。主に以下の責務を担います：

- **リアルタイム情報提供**: システム内のイベントをタイムリーにユーザーに伝達する
- **アクション喚起**: ユーザーが対応すべきタスクを明確に通知する
- **重要事項の見落とし防止**: 締切や期限など重要事項を通知して見落としを防ぐ
- **業務連携の効率化**: 複数の関係者間でのコミュニケーションを効率化する
- **システム状態の通知**: メンテナンスなどのシステム状態を適切に伝達する

## 2. 通知の種類

システムでは以下の4種類の通知をサポートします：

1. **システム通知**: システムからの一般的なお知らせ（メンテナンス情報など）
2. **タスク通知**: ユーザーによるアクションが必要なタスク（承認依頼、提案依頼など）
3. **アラート通知**: 緊急性の高い重要な通知（契約期限、支払期限など）
4. **イベント通知**: 特定のイベントに関する情報（案件登録、技術者アサインなど）

## 3. 通知のライフサイクル

各通知は以下のライフサイクルを持ちます：

1. **作成**: システムの各機能から通知が生成される
2. **配信**: 関連するユーザーに通知が配信される
3. **既読処理**: ユーザーが通知を確認すると既読状態になる
4. **削除/アーカイブ**: ユーザーによる削除または一定期間経過後の自動アーカイブ

## 4. 全体アーキテクチャ

通知機能は以下のコンポーネントで構成されます：

```
[業務モジュール] --イベント発行--> [通知サービス] --保存--> [通知ストレージ]
                                |
                                ↓
              [メール配信] <-- [配信エンジン] --> [WebSocket/SSE]
                                |
                                ↓
                        [通知REST API] <---- [フロントエンド]
```

### 4.1 コンポーネント説明

1. **通知サービス（NotificationService）**
   - 通知の作成、保存、取得、更新、削除を担当
   - 業務モジュールからイベントを受信し通知に変換
   - メール通知とアプリ内通知の統合管理

2. **配信エンジン（DeliveryEngine）**
   - 通知の配信方法（メール、アプリ内通知）を決定
   - リアルタイム通知のためのWebSocketまたはSSE管理
   - 通知テンプレートの適用と書式設定

3. **通知ストレージ（NotificationRepository）**
   - 通知の永続化と検索を担当
   - ユーザーごとの通知状態管理
   - 通知の保持期間管理

4. **通知REST API（NotificationController）**
   - フロントエンドへの通知情報提供
   - 通知の既読/未読処理
   - 通知のフィルタリングと検索

5. **イベントリスナー（NotificationEventListener）**
   - 業務モジュールからのイベントをリッスン
   - イベントを適切な通知タイプに変換
   - ターゲットユーザーの決定

## 5. 通知生成パターン

通知は以下の2つの方法で生成されます：

### 5.1 イベント駆動型

業務モジュールがイベントを発行し、`NotificationEventListener`がイベントをキャッチして通知を生成します。

設計例：
```
// イベント発行
applicationEventPublisher.publishEvent(new ProjectCreatedEvent(project));

// イベントリスナー
@EventListener
public void handleProjectCreatedEvent(ProjectCreatedEvent event) {
    Project project = event.getProject();
    notificationService.createNotification(
        NotificationType.EVENT,
        project.getAssignedUsers(),
        "新規案件が登録されました",
        String.format("「%s」という新しい案件が登録されました。", project.getName()),
        createMetadata(project)
    );
}
```

### 5.2 直接呼び出し型

業務モジュールが`NotificationService`を直接呼び出し、通知の詳細情報を直接指定します。

設計例：
```
notificationService.createNotification(
    NotificationType.TASK,
    targetUsers,
    "請求書の承認依頼があります",
    String.format("案件「%s」の請求書が発行され、あなたの承認待ちです。", invoice.getProjectName()),
    metadata
);
```

## 6. リアルタイム通知の実装

リアルタイム通知は以下の方法で実装します：

### 6.1 Server-Sent Events (SSE)方式

長期HTTP接続を利用した単方向通信を採用します。ブラウザ標準APIでサポートされており、追加ライブラリ不要です。バックエンドではSpring WebFluxを利用したFlux<ServerSentEvent>の実装を行います。

設計例：
```
@GetMapping(value = "/notifications/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<ServerSentEvent<NotificationDto>> streamNotifications(
        @AuthenticationPrincipal UserDetails user) {
    return notificationService.getNotificationStream(user.getUsername())
        .map(notification -> ServerSentEvent.builder(NotificationDto.from(notification))
            .id(notification.getId().toString())
            .event("notification")
            .build());
}
```

### 6.2 WebSocket方式（代替実装）

双方向通信が必要な場合に限り、STOMP over WebSocketを利用した実装を検討します。ただし、接続管理の複雑さがあるためSSEを優先します。