# ユーザー管理機能 - 権限管理

## 1. 機能概要

権限管理機能は、SES業務システムにおける権限の定義、グループ化、ロールへの割り当て、アクセスレベル設定を担当します。システム内のリソース（機能・データ）に対する操作権限を細かく制御し、適切なアクセス制御を実現します。

## 2. 主要コンポーネント構成

権限管理機能は以下のコンポーネントで構成されます：

### 2.1 コンポーネント構成図

```
                   ┌────────────────────┐
                   │ PermissionController │
                   └──────────┬─────────┘
                              │
                              ▼
  ┌───────────────┐   ┌────────────────────┐   ┌──────────────────┐
  │  RoleService  │◄──┤  PermissionService  │──►│  AuditLogService  │
  └───────────────┘   └──────────┬─────────┘   └──────────────────┘
                                 │
                                 ▼
                  ┌─────────────────────────┐
                  │  PermissionRepository   │
                  └─────────────────────────┘
                                 │
                                 ▼
                  ┌─────────────────────────┐
                  │ RolePermissionRepository │
                  └─────────────────────────┘
```

### 2.2 コンポーネント説明

- **PermissionController**: 権限管理のRESTful APIエンドポイントを提供
- **PermissionService**: 権限管理のビジネスロジックを実装
- **PermissionRepository**: 権限データのデータアクセス層
- **RolePermissionRepository**: ロールと権限の関連データのデータアクセス層
- **外部依存**: RoleService（ロール管理機能）、AuditLogService（監査ログ機能）

## 3. 処理フロー

### 3.1 権限一覧取得フロー

```
1. 管理者が権限管理画面にアクセス
2. PermissionController.getAllPermissions() APIが呼び出される
3. PermissionService.findAll() メソッドが実行される
   3.1. PermissionRepository経由でデータベースから権限一覧を取得
   3.2. 取得結果をDTOに変換
4. 権限一覧をクライアントに返却
```

### 3.2 権限グループ階層取得フロー

```
1. 管理者がロール編集画面で権限設定タブを開く
2. PermissionController.getPermissionGroups() APIが呼び出される
3. PermissionService.findAllGroups() メソッドが実行される
   3.1. PermissionRepository経由でデータベースから権限を取得
   3.2. リソースタイプ/リソース名/アクションによるグループ化
   3.3. 階層構造のDTOに変換
4. 権限グループ階層をクライアントに返却
```

### 3.3 ロール権限取得フロー

```
1. 管理者がロール編集画面で特定ロールの権限設定を表示
2. PermissionController.getRolePermissions() APIが呼び出される
3. PermissionService.findByRoleId() メソッドが実行される
   3.1. RolePermissionRepository経由でロールに割り当てられた権限を取得
   3.2. 関連する権限情報を結合
   3.3. 取得結果をDTOに変換
4. ロール権限情報をクライアントに返却
```

### 3.4 ロール権限更新フロー

```
1. 管理者がロール編集画面で権限設定を変更
2. PermissionController.updateRolePermissions() APIが呼び出される
3. PermissionService.updateRolePermissions() メソッドが実行される
   3.1. トランザクション開始
   3.2. ロールの存在確認
   3.3. 既存のロール権限設定を取得
   3.4. 権限設定を更新（追加/変更/削除）
   3.5. AuditLogService経由で監査ログ記録
   3.6. トランザクション終了
4. 更新結果をクライアントに返却
```

## 4. 実装詳細

### 4.1 PermissionController 実装

```java
@RestController
@RequestMapping("/api/v1/admin/permissions")
public class PermissionController {

    private final PermissionService permissionService;
    
    @Autowired
    public PermissionController(PermissionService permissionService) {
        this.permissionService = permissionService;
    }
    
    @GetMapping
    public List<PermissionDTO> getAllPermissions() {
        return permissionService.findAll();
    }
    
    @GetMapping("/groups")
    public List<PermissionGroupDTO> getPermissionGroups() {
        return permissionService.findAllGroups();
    }
    
    @GetMapping("/resource-types/{resourceType}")
    public List<PermissionDTO> getPermissionsByResourceType(@PathVariable String resourceType) {
        return permissionService.findByResourceType(resourceType);
    }
    
    @GetMapping("/roles/{roleId}")
    public List<RolePermissionDTO> getRolePermissions(@PathVariable UUID roleId) {
        return permissionService.findByRoleId(roleId);
    }
    
    @PutMapping("/roles/{roleId}")
    public ResponseEntity<Void> updateRolePermissions(
            @PathVariable UUID roleId,
            @RequestBody List<RolePermissionUpdateDTO> permissions) {
        permissionService.updateRolePermissions(roleId, permissions);
        return ResponseEntity.ok().build();
    }
}
```

### 4.2 PermissionServiceImpl 実装

```java
@Service
public class PermissionServiceImpl implements PermissionService {

    private final PermissionRepository permissionRepository;
    private final RolePermissionRepository rolePermissionRepository;
    private final RoleRepository roleRepository;
    private final AuditLogService auditLogService;
    
    @Autowired
    public PermissionServiceImpl(
            PermissionRepository permissionRepository,
            RolePermissionRepository rolePermissionRepository,
            RoleRepository roleRepository,
            AuditLogService auditLogService) {
        this.permissionRepository = permissionRepository;
        this.rolePermissionRepository = rolePermissionRepository;
        this.roleRepository = roleRepository;
        this.auditLogService = auditLogService;
    }
    
    @Override
    @Transactional(readOnly = true)
    public List<PermissionDTO> findAll() {
        List<Permission> permissions = permissionRepository.findAll();
        return permissions.stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }
    
    @Override
    @Transactional(readOnly = true)
    public List<PermissionGroupDTO> findAllGroups() {
        List<Permission> permissions = permissionRepository.findAll();
        Map<String, PermissionGroupDTO> groupMap = new HashMap<>();
        
        // リソースタイプごとにグループ化
        for (Permission permission : permissions) {
            String resourceType = permission.getResourceType();
            PermissionGroupDTO group = groupMap.computeIfAbsent(resourceType, type -> {
                PermissionGroupDTO newGroup = new PermissionGroupDTO();
                newGroup.setResourceType(type);
                newGroup.setDisplayName(formatDisplayName(type));
                newGroup.setResources(new ArrayList<>());
                return newGroup;
            });
            
            // リソース名ごとにグループ化
            String resourceName = permission.getResourceName();
            PermissionResourceDTO resource = findOrCreateResource(group, resourceName);
            
            // アクション追加
            PermissionActionDTO action = new PermissionActionDTO();
            action.setPermissionId(permission.getId());
            action.setAction(permission.getAction());
            action.setDisplayName(formatActionDisplayName(permission.getAction()));
            resource.getActions().add(action);
        }
        
        return new ArrayList<>(groupMap.values());
    }
    
    @Override
    @Transactional(readOnly = true)
    public List<RolePermissionDTO> findByRoleId(UUID roleId) {
        // ロールの存在確認
        if (!roleRepository.existsById(roleId)) {
            throw new EntityNotFoundException("Role not found with id: " + roleId);
        }
        
        List<RolePermission> rolePermissions = rolePermissionRepository.findByRoleId(roleId);
        List<RolePermissionDTO> result = new ArrayList<>();
        
        for (RolePermission rolePermission : rolePermissions) {
            Permission permission = permissionRepository.findById(rolePermission.getPermissionId())
                    .orElseThrow(() -> new EntityNotFoundException("Permission not found with id: " + rolePermission.getPermissionId()));
            
            RolePermissionDTO dto = new RolePermissionDTO();
            dto.setPermissionId(permission.getId());
            dto.setPermissionName(permission.getName());
            dto.setResourceType(permission.getResourceType());
            dto.setResourceName(permission.getResourceName());
            dto.setAction(permission.getAction());
            dto.setAccessLevel(rolePermission.getAccessLevel());
            
            result.add(dto);
        }
        
        return result;
    }
    
    @Override
    @Transactional(readOnly = true)
    public List<PermissionDTO> findByResourceType(String resourceType) {
        List<Permission> permissions = permissionRepository.findByResourceType(resourceType);
        return permissions.stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }
    
    @Override
    @Transactional
    public void updateRolePermissions(UUID roleId, List<RolePermissionUpdateDTO> permissions) {
        // ロールの存在確認
        Role role = roleRepository.findById(roleId)
                .orElseThrow(() -> new EntityNotFoundException("Role not found with id: " + roleId));
        
        // 既存の権限設定取得
        List<RolePermission> existingPermissions = rolePermissionRepository.findByRoleId(roleId);
        Map<UUID, RolePermission> existingPermissionMap = existingPermissions.stream()
                .collect(Collectors.toMap(RolePermission::getPermissionId, Function.identity()));
        
        // 更新対象権限の検証
        Set<UUID> validPermissionIds = new HashSet<>();
        for (RolePermissionUpdateDTO updateDTO : permissions) {
            if (!permissionRepository.existsById(updateDTO.getPermissionId())) {
                throw new EntityNotFoundException("Permission not found with id: " + updateDTO.getPermissionId());
            }
            validPermissionIds.add(updateDTO.getPermissionId());
        }
        
        // トランザクション内で権限設定を更新
        List<RolePermission> updatedPermissions = new ArrayList<>();
        for (RolePermissionUpdateDTO updateDTO : permissions) {
            RolePermission rolePermission = existingPermissionMap.get(updateDTO.getPermissionId());
            
            if (rolePermission == null) {
                // 新規追加
                rolePermission = new RolePermission();
                rolePermission.setRoleId(roleId);
                rolePermission.setPermissionId(updateDTO.getPermissionId());
            }
            
            // アクセスレベル更新
            rolePermission.setAccessLevel(updateDTO.getAccessLevel());
            updatedPermissions.add(rolePermission);
        }
        
        // 追加・更新された権限設定を保存
        rolePermissionRepository.saveAll(updatedPermissions);
        
        // 削除対象の権限設定を特定して削除
        List<UUID> permissionsToRemove = existingPermissionMap.keySet().stream()
                .filter(permId -> !validPermissionIds.contains(permId))
                .collect(Collectors.toList());
        
        for (UUID permissionId : permissionsToRemove) {
            rolePermissionRepository.deleteByRoleIdAndPermissionId(roleId, permissionId);
        }
        
        // 監査ログ記録
        Map<String, Object> details = new HashMap<>();
        details.put("roleId", role.getRoleId());
        details.put("roleName", role.getName());
        details.put("permissionCount", updatedPermissions.size());
        details.put("addedCount", updatedPermissions.size() - existingPermissions.size() + permissionsToRemove.size());
        details.put("removedCount", permissionsToRemove.size());
        
        auditLogService.recordAuditLog(
                "UPDATE_ROLE_PERMISSIONS",
                "ROLE_PERMISSION",
                role.getId().toString(),
                SecurityContextHolder.getContext().getAuthentication().getPrincipal().getUserId(),
                details
        );
    }
    
    // Helper methods
    
    private PermissionDTO convertToDTO(Permission permission) {
        PermissionDTO dto = new PermissionDTO();
        dto.setId(permission.getId());
        dto.setPermissionId(permission.getPermissionId());
        dto.setName(permission.getName());
        dto.setDescription(permission.getDescription());
        dto.setResourceType(permission.getResourceType());
        dto.setResourceName(permission.getResourceName());
        dto.setAction(permission.getAction());
        return dto;
    }
    
    private PermissionResourceDTO findOrCreateResource(PermissionGroupDTO group, String resourceName) {
        // 既存のリソースを検索
        for (PermissionResourceDTO resource : group.getResources()) {
            if (resource.getResourceName().equals(resourceName)) {
                return resource;
            }
        }
        
        // 存在しない場合は新規作成
        PermissionResourceDTO newResource = new PermissionResourceDTO();
        newResource.setResourceName(resourceName);
        newResource.setDisplayName(formatDisplayName(resourceName));
        newResource.setActions(new ArrayList<>());
        group.getResources().add(newResource);
        return newResource;
    }
    
    private String formatDisplayName(String name) {
        // リソースタイプ/リソース名の表示用フォーマット
        // 例: "USER_MANAGEMENT" -> "ユーザー管理"
        
        // これは実際のシステムでは、メッセージリソースや
        // 対応表から取得するのが望ましい。ここでは簡略化のため省略。
        return name;
    }
    
    private String formatActionDisplayName(String action) {
        // アクションの表示名フォーマット
        // 例: "READ" -> "閲覧"
        switch (action) {
            case "READ":
                return "閲覧";
            case "WRITE":
                return "編集";
            case "EXECUTE":
                return "実行";
            default:
                return action;
        }
    }
}
```

### 4.3 PermissionRepository 実装

```java
public interface PermissionRepository extends JpaRepository<Permission, UUID> {
    
    List<Permission> findByResourceType(String resourceType);
    
    List<Permission> findByResourceTypeAndResourceName(String resourceType, String resourceName);
    
    Optional<Permission> findByPermissionId(String permissionId);
    
    boolean existsByPermissionId(String permissionId);
}
```

### 4.4 RolePermissionRepository 実装

```java
public interface RolePermissionRepository extends JpaRepository<RolePermission, Long> {
    
    List<RolePermission> findByRoleId(UUID roleId);
    
    List<RolePermission> findByPermissionId(UUID permissionId);
    
    Optional<RolePermission> findByRoleIdAndPermissionId(UUID roleId, UUID permissionId);
    
    void deleteByRoleId(UUID roleId);
    
    void deleteByRoleIdAndPermissionId(UUID roleId, UUID permissionId);
}
```

## 5. 権限定義の実装

システムの権限は以下のように階層的に設計し、リソースタイプ（機能グループ）、リソース名（機能）、アクション（操作）の組み合わせで定義します。

### 5.1 権限階層

```
リソースタイプ（機能グループ）
└── リソース名（機能）
    └── アクション（操作）
```

例：
```
ユーザー管理
└── ユーザーアカウント
    ├── 閲覧
    ├── 編集
    └── 削除
```

### 5.2 システム権限初期化

```java
@Component
public class PermissionInitializer {
    
    private final PermissionRepository permissionRepository;
    
    @Autowired
    public PermissionInitializer(PermissionRepository permissionRepository) {
        this.permissionRepository = permissionRepository;
    }
    
    @PostConstruct
    @Transactional
    public void initializePermissions() {
        // ユーザー管理権限
        createPermissionGroup("USER_MANAGEMENT", "ユーザー管理", "ユーザー管理機能に関する権限");
        
        // ユーザー管理 > ユーザーアカウント
        createPermission(
                "USER_MANAGEMENT", "USER_ACCOUNT", "ユーザーアカウント",
                "ユーザーアカウント管理に関する権限", "READ");
        createPermission(
                "USER_MANAGEMENT", "USER_ACCOUNT", "ユーザーアカウント",
                "ユーザーアカウント管理に関する権限", "WRITE");
        createPermission(
                "USER_MANAGEMENT", "USER_ACCOUNT", "ユーザーアカウント",
                "ユーザーアカウント管理に関する権限", "EXECUTE");
        
        // ユーザー管理 > ロール管理
        createPermission(
                "USER_MANAGEMENT", "ROLE", "ロール管理",
                "ロール管理に関する権限", "READ");
        createPermission(
                "USER_MANAGEMENT", "ROLE", "ロール管理",
                "ロール管理に関する権限", "WRITE");
        createPermission(
                "USER_MANAGEMENT", "ROLE", "ロール管理",
                "ロール管理に関する権限", "EXECUTE");
        
        // 案件管理権限
        createPermissionGroup("PROJECT_MANAGEMENT", "案件管理", "案件管理機能に関する権限");
        
        // 案件管理 > 案件情報
        createPermission(
                "PROJECT_MANAGEMENT", "PROJECT_INFO", "案件情報",
                "案件情報の管理に関する権限", "READ");
        createPermission(
                "PROJECT_MANAGEMENT", "PROJECT_INFO", "案件情報",
                "案件情報の管理に関する権限", "WRITE");
        
        // 技術者管理権限
        createPermissionGroup("ENGINEER_MANAGEMENT", "技術者管理", "技術者管理機能に関する権限");
        
        // 技術者管理 > 技術者情報
        createPermission(
                "ENGINEER_MANAGEMENT", "ENGINEER_INFO", "技術者情報",
                "技術者情報の管理に関する権限", "READ");
        createPermission(
                "ENGINEER_MANAGEMENT", "ENGINEER_INFO", "技術者情報",
                "技術者情報の管理に関する権限", "WRITE");
        
        // 以下、その他のモジュールの権限定義
        // マッチング機能
        // 契約管理
        // 勤怠工数管理
        // 請求支払管理
        // レポーティング
        // システム管理
    }
    
    private void createPermissionGroup(String resourceType, String displayName, String description) {
        // 権限グループの作成はメタデータ作成のみで、実際のテーブルには関係ない場合もある
        // このサンプルでは簡略化のため、特に処理は行わない
    }
    
    private void createPermission(String resourceType, String resourceName, String displayName, 
                                 String description, String action) {
        // 権限IDは "{resourceType}:{resourceName}:{action}" の形式で作成
        String permissionId = resourceType + ":" + resourceName + ":" + action;
        
        // 既に存在する場合は作成しない
        if (permissionRepository.existsByPermissionId(permissionId)) {
            return;
        }
        
        Permission permission = new Permission();
        permission.setId(UUID.randomUUID());
        permission.setPermissionId(permissionId);
        permission.setName(displayName + "の" + getActionDisplayName(action));
        permission.setDescription(description);
        permission.setResourceType(resourceType);
        permission.setResourceName(resourceName);
        permission.setAction(action);
        
        permissionRepository.save(permission);
    }
    
    private String getActionDisplayName(String action) {
        switch (action) {
            case "READ":
                return "閲覧";
            case "WRITE":
                return "編集";
            case "EXECUTE":
                return "実行";
            default:
                return action;
        }
    }
}
```

## 6. 例外処理

権限管理機能では、以下の例外処理を実装します：

### 6.1 例外クラス

```java
// 例外クラスは他の機能と共通で使用
public class EntityNotFoundException extends RuntimeException { /* ... */ }
public class BusinessRuleException extends RuntimeException { /* ... */ }
public class ValidationException extends RuntimeException { /* ... */ }
```

### 6.2 例外ハンドリング

```java
// 例外ハンドラーは他の機能と共通で使用
@ControllerAdvice
public class GlobalExceptionHandler { /* ... */ }
```

## 7. セキュリティ対策

### 7.1 権限管理のセキュリティ

- システム定義の権限は変更・削除不可
- 権限設定操作の監査ログ記録
- ロールの権限変更はシステム管理者、セキュリティ管理者のみ許可

### 7.2 アクセスレベル設計

アクセスレベルは以下の4段階で定義し、詳細な権限制御を実現します：

```java
public enum AccessLevel {
    NONE,    // アクセス不可
    READ,    // 閲覧のみ可能
    WRITE,   // 閲覧・編集可能
    ADMIN    // 管理者権限（すべての操作可能）
}
```

### 7.3 権限チェックロジック

権限チェックは以下の手順で実行されます：

1. ユーザーのロール取得
2. ロールに割り当てられた権限取得
3. リクエストされた操作に必要な権限を特定
4. ユーザーが当該権限を持つかをチェック
5. アクセスレベルが操作に必要なレベル以上かをチェック

```java
@Component
public class PermissionChecker {
    
    private final UserRoleService userRoleService;
    private final PermissionService permissionService;
    
    @Autowired
    public PermissionChecker(UserRoleService userRoleService, PermissionService permissionService) {
        this.userRoleService = userRoleService;
        this.permissionService = permissionService;
    }
    
    /**
     * ユーザーが特定の権限を持っているか確認する
     * @param userId ユーザーID
     * @param resourceType リソースタイプ
     * @param resourceName リソース名
     * @param action アクション
     * @param requiredLevel 必要なアクセスレベル
     * @return 権限を持っている場合はtrue
     */
    public boolean hasPermission(UUID userId, String resourceType, String resourceName, 
                                String action, AccessLevel requiredLevel) {
        // ユーザーのロールを取得
        List<RoleDTO> userRoles = userRoleService.findRolesByUserId(userId);
        
        // 各ロールの権限をチェック
        for (RoleDTO role : userRoles) {
            List<RolePermissionDTO> rolePermissions = permissionService.findByRoleId(role.getId());
            
            // 必要な権限を持っているかチェック
            for (RolePermissionDTO permission : rolePermissions) {
                if (permission.getResourceType().equals(resourceType) &&
                    permission.getResourceName().equals(resourceName) &&
                    permission.getAction().equals(action)) {
                    
                    // アクセスレベルが必要なレベル以上かチェック
                    if (permission.getAccessLevel().ordinal() >= requiredLevel.ordinal()) {
                        return true;
                    }
                }
            }
        }
        
        return false;
    }
}
```

## 8. UI設計

### 8.1 権限グループツリービュー

権限設定画面では、権限をツリービューで階層的に表示し、直感的な設定を可能にします。

```
□ ユーザー管理
  □ ユーザーアカウント
    ☑ 閲覧 [アクセスレベル: 編集]
    ☑ 編集 [アクセスレベル: 編集]
    ☐ 実行 [アクセスレベル: なし]
  □ ロール管理
    ☑ 閲覧 [アクセスレベル: 閲覧]
    ☐ 編集 [アクセスレベル: なし]
    ☐ 実行 [アクセスレベル: なし]
□ 案件管理
  □ 案件情報
    ☑ 閲覧 [アクセスレベル: 編集]
    ☑ 編集 [アクセスレベル: 編集]
...
```

### 8.2 権限バルク操作

複数の権限を一括で設定できる操作を提供します：

- 「すべて選択/解除」ボタン
- 「閲覧権限のみを付与」ボタン
- 「編集権限を付与」ボタン
- リソースタイプ単位での一括設定

### 8.3 権限検索・フィルタリング

権限の検索・フィルタリング機能を提供します：

- リソースタイプによるフィルタリング
- 権限名による検索
- 付与済み権限のみ表示

## 9. テスト方針

### 9.1 単体テスト

- PermissionServiceの各メソッドの正常系テスト
- PermissionServiceの各メソッドの異常系テスト（例外発生パターン）
- 権限階層構造の構築ロジックのテスト
- アクセスレベルチェックロジックのテスト

### 9.2 結合テスト

- PermissionControllerとPermissionServiceの連携テスト
- PermissionServiceとRepositoryの連携テスト
- PermissionCheckerと他サービスの連携テスト

### 9.3 シナリオテスト

- ロール作成→権限設定→権限検証の一連のフロー
- 複雑な権限設定（複数リソース、複数アクション）のテスト
- 権限設定変更の反映確認テスト