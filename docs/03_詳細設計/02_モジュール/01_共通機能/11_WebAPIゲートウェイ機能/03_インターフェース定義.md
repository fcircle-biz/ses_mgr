# WebAPIゲートウェイ機能 インターフェース定義

## 1. 概要

本ドキュメントでは、WebAPIゲートウェイ機能が提供するインターフェースと、外部から要求するインターフェースについて定義します。これらのインターフェースを通じて、WebAPIゲートウェイは他のモジュールとの連携を実現します。

## 2. 提供インターフェース

WebAPIゲートウェイ機能が提供する主要なインターフェースを以下に定義します。

### 2.1 ApiGatewayService

APIゲートウェイの設定と管理機能を提供するインターフェースです。

```java
public interface ApiGatewayService {
    /**
     * ルート定義の登録・更新
     * @param routeDefinition 登録・更新するルート定義
     * @return 登録・更新されたルート定義
     * @throws DuplicateRouteException 同一IDのルートが既に存在する場合
     * @throws InvalidRouteDefinitionException ルート定義が不正な場合
     */
    RouteDefinition registerRoute(RouteDefinition routeDefinition);
    
    /**
     * ルート定義の取得
     * @param routeId ルート定義ID
     * @return 指定IDのルート定義。存在しない場合はOptional.empty()
     */
    Optional<RouteDefinition> getRoute(String routeId);
    
    /**
     * 全ルート定義の取得
     * @return 全てのルート定義のリスト
     */
    List<RouteDefinition> getAllRoutes();
    
    /**
     * ルート定義の削除
     * @param routeId 削除するルート定義ID
     * @return 削除された場合true、存在しない場合false
     */
    boolean deleteRoute(String routeId);
    
    /**
     * ルート定義の有効/無効切り替え
     * @param routeId ルート定義ID
     * @param enabled 有効にする場合true、無効にする場合false
     * @return 更新後のルート定義。存在しない場合はOptional.empty()
     */
    Optional<RouteDefinition> setRouteEnabled(String routeId, boolean enabled);
    
    /**
     * APIクライアントの登録・更新
     * @param apiClient 登録・更新するAPIクライアント
     * @return 登録・更新されたAPIクライアント
     * @throws DuplicateClientException 同一IDのクライアントが既に存在する場合
     * @throws InvalidClientException クライアント定義が不正な場合
     */
    ApiClient registerClient(ApiClient apiClient);
    
    /**
     * APIクライアントの取得
     * @param clientId クライアントID
     * @return 指定IDのAPIクライアント。存在しない場合はOptional.empty()
     */
    Optional<ApiClient> getClient(String clientId);
    
    /**
     * 全APIクライアントの取得
     * @return 全てのAPIクライアントのリスト
     */
    List<ApiClient> getAllClients();
    
    /**
     * APIクライアントの削除
     * @param clientId 削除するクライアントID
     * @return 削除された場合true、存在しない場合false
     */
    boolean deleteClient(String clientId);
    
    /**
     * APIキーの再生成
     * @param clientId クライアントID
     * @return 再生成されたAPIキー。クライアントが存在しない場合はOptional.empty()
     */
    Optional<ApiKey> regenerateApiKey(String clientId);
    
    /**
     * APIキーの無効化
     * @param clientId クライアントID
     * @return 無効化が成功した場合true、クライアントが存在しない場合false
     */
    boolean revokeApiKey(String clientId);
    
    /**
     * ゲートウェイ設定のリロード
     * 設定変更を実行中のゲートウェイに反映します
     * @return リロードが成功した場合true
     */
    boolean reloadConfiguration();
}
```

### 2.2 MetricsService

APIメトリクスと監視データの参照機能を提供するインターフェースです。

```java
public interface MetricsService {
    /**
     * ルート別の集計メトリクスを取得
     * @param routeId ルート定義ID
     * @param startTime 開始時間
     * @param endTime 終了時間
     * @return メトリクスデータ
     */
    ApiMetrics getRouteMetrics(String routeId, LocalDateTime startTime, LocalDateTime endTime);
    
    /**
     * クライアント別の集計メトリクスを取得
     * @param clientId クライアントID
     * @param startTime 開始時間
     * @param endTime 終了時間
     * @return メトリクスデータ
     */
    ApiMetrics getClientMetrics(String clientId, LocalDateTime startTime, LocalDateTime endTime);
    
    /**
     * 全体の集計メトリクスを取得
     * @param startTime 開始時間
     * @param endTime 終了時間
     * @return メトリクスデータ
     */
    ApiMetrics getGlobalMetrics(LocalDateTime startTime, LocalDateTime endTime);
    
    /**
     * 時系列メトリクスを取得
     * @param metricName メトリクス名（requests, errors, latency等）
     * @param routeId ルート定義ID（nullの場合全ルート）
     * @param interval 集計間隔（分）
     * @param startTime 開始時間
     * @param endTime 終了時間
     * @return 時系列メトリクスデータ
     */
    List<TimeSeriesMetric> getTimeSeriesMetrics(
        String metricName, 
        String routeId, 
        int interval, 
        LocalDateTime startTime, 
        LocalDateTime endTime
    );
    
    /**
     * エラーレポートを取得
     * @param startTime 開始時間
     * @param endTime 終了時間
     * @param limit 最大件数
     * @return エラー情報リスト
     */
    List<ErrorReport> getErrors(
        LocalDateTime startTime, 
        LocalDateTime endTime, 
        int limit
    );
    
    /**
     * ゲートウェイの状態を取得
     * @return ゲートウェイ状態情報
     */
    GatewayStatus getGatewayStatus();
}
```

### 2.3 GatewayFilter

リクエスト/レスポンス処理フィルターを実装するためのインターフェースです。

```java
public interface GatewayFilter {
    /**
     * フィルター名を取得
     * @return フィルター名
     */
    String getName();
    
    /**
     * フィルター順序を取得
     * @return フィルター順序（小さい値が先に実行）
     */
    int getOrder();
    
    /**
     * リクエスト前処理
     * @param context フィルターコンテキスト
     * @return 後続処理を継続する場合true、中断する場合false
     */
    boolean preProcess(FilterContext context);
    
    /**
     * レスポンス後処理
     * @param context フィルターコンテキスト
     */
    void postProcess(FilterContext context);
}
```

### 2.4 ApiClientValidator

APIクライアントの検証を行うインターフェースです。

```java
public interface ApiClientValidator {
    /**
     * APIキーに基づくクライアント検証
     * @param apiKey APIキー文字列
     * @return 検証結果（成功時はクライアント情報を含む）
     */
    ValidationResult validateApiKey(String apiKey);
    
    /**
     * JWTトークンに基づくクライアント検証
     * @param jwtToken JWTトークン文字列
     * @return 検証結果（成功時はクライアント情報とユーザー情報を含む）
     */
    ValidationResult validateJwtToken(String jwtToken);
    
    /**
     * IPアドレス制限チェック
     * @param clientId クライアントID
     * @param ipAddress IPアドレス
     * @return 許可されている場合true
     */
    boolean isIpAllowed(String clientId, String ipAddress);
    
    /**
     * スコープ権限チェック
     * @param clientId クライアントID
     * @param requiredScope 要求スコープ
     * @return 許可されている場合true
     */
    boolean hasScope(String clientId, String requiredScope);
}
```

## 3. 要求インターフェース

WebAPIゲートウェイ機能が他のモジュールに要求する主要なインターフェースを以下に定義します。

### 3.1 AuthenticationService

認証認可機能モジュールが提供する認証サービスのインターフェースです。

```java
public interface AuthenticationService {
    /**
     * ユーザー認証
     * @param credentials 認証情報
     * @return 認証結果（成功時はトークンとユーザー情報を含む）
     */
    AuthenticationResult authenticate(Credentials credentials);
    
    /**
     * トークン検証
     * @param token 認証トークン
     * @return 検証結果（成功時はユーザー情報を含む）
     */
    TokenValidationResult validateToken(String token);
    
    /**
     * トークン更新
     * @param refreshToken リフレッシュトークン
     * @return 更新結果（成功時は新しいトークンを含む）
     */
    TokenRefreshResult refreshToken(String refreshToken);
    
    /**
     * トークン無効化
     * @param token 無効化するトークン
     * @return 無効化が成功した場合true
     */
    boolean revokeToken(String token);
}
```

### 3.2 AuthorizationService

認証認可機能モジュールが提供する認可サービスのインターフェースです。

```java
public interface AuthorizationService {
    /**
     * アクセス権限チェック
     * @param principal 認証済みプリンシパル
     * @param resource アクセス対象リソース
     * @param action 実行アクション
     * @return 許可される場合true
     */
    boolean isAuthorized(Principal principal, String resource, String action);
    
    /**
     * ロールベースのアクセス権限チェック
     * @param principal 認証済みプリンシパル
     * @param requiredRoles 要求ロール（いずれか一つでも所持していれば許可）
     * @return 許可される場合true
     */
    boolean hasAnyRole(Principal principal, Set<String> requiredRoles);
    
    /**
     * スコープベースのアクセス権限チェック
     * @param principal 認証済みプリンシパル
     * @param requiredScope 要求スコープ
     * @return 許可される場合true
     */
    boolean hasScope(Principal principal, String requiredScope);
}
```

### 3.3 LoggingService

ロギング機能モジュールが提供するロギングサービスのインターフェースです。

```java
public interface LoggingService {
    /**
     * APIアクセスログの記録
     * @param accessLog APIアクセスログ情報
     */
    void logApiAccess(ApiAccessLog accessLog);
    
    /**
     * APIエラーログの記録
     * @param errorLog APIエラーログ情報
     */
    void logApiError(ApiErrorLog errorLog);
    
    /**
     * セキュリティ監査ログの記録
     * @param auditLog セキュリティ監査ログ情報
     */
    void logSecurityAudit(SecurityAuditLog auditLog);
}
```

### 3.4 ErrorHandlingService

エラー処理機能モジュールが提供するエラー処理サービスのインターフェースです。

```java
public interface ErrorHandlingService {
    /**
     * 標準エラーレスポンスの生成
     * @param exception 発生した例外
     * @param request 元のリクエスト情報
     * @return 標準化されたエラーレスポンス
     */
    ErrorResponse createErrorResponse(Exception exception, GatewayRequest request);
    
    /**
     * エラーの分類
     * @param exception 発生した例外
     * @return エラー分類情報
     */
    ErrorClassification classifyError(Exception exception);
    
    /**
     * エラーコードの解決
     * @param exception 発生した例外
     * @return エラーコード
     */
    String resolveErrorCode(Exception exception);
}
```

### 3.5 CacheService

キャッシュ機能モジュールが提供するキャッシュサービスのインターフェースです。

```java
public interface CacheService {
    /**
     * キャッシュからデータを取得
     * @param <T> データ型
     * @param key キャッシュキー
     * @param type データ型
     * @return キャッシュされたデータ。存在しない場合はOptional.empty()
     */
    <T> Optional<T> get(String key, Class<T> type);
    
    /**
     * キャッシュにデータを格納
     * @param <T> データ型
     * @param key キャッシュキー
     * @param value キャッシュするデータ
     * @param ttl 有効期間（秒）。0以下の場合は無期限
     */
    <T> void put(String key, T value, long ttl);
    
    /**
     * キャッシュからデータを削除
     * @param key キャッシュキー
     * @return 削除された場合true
     */
    boolean remove(String key);
    
    /**
     * キャッシュの有効性チェック
     * @param key キャッシュキー
     * @return キャッシュが存在し有効な場合true
     */
    boolean isValid(String key);
    
    /**
     * 特定パターンのキーに一致するキャッシュをすべて削除
     * @param pattern キーパターン
     * @return 削除されたキャッシュのキー数
     */
    int removeByPattern(String pattern);
}
```

## 4. データ交換モデル

WebAPIゲートウェイ機能のインターフェースで使用されるデータ交換モデル（DTO）を以下に定義します。

### 4.1 提供インターフェース用DTO

#### 4.1.1 RouteDefinitionDTO

```java
public class RouteDefinitionDTO {
    private String id;                          // ルートID
    private String path;                        // パスパターン
    private String method;                      // HTTPメソッド
    private String targetService;               // 転送先サービス
    private List<PredicateDTO> predicates;      // 条件定義
    private List<FilterDTO> filters;            // フィルター定義
    private Integer order;                      // 優先順位
    private Boolean enabled;                    // 有効フラグ
    private Map<String, String> metadata;       // メタデータ
}
```

#### 4.1.2 ApiClientDTO

```java
public class ApiClientDTO {
    private String clientId;                    // クライアントID
    private String name;                        // クライアント名
    private String apiKey;                      // APIキー（マスク済み）
    private String status;                      // 状態
    private RateLimitDTO rateLimit;             // レート制限
    private List<String> allowedIPs;            // 許可IP
    private Set<String> allowedScopes;          // 許可スコープ
    private LocalDateTime createdAt;            // 作成日時
    private LocalDateTime updatedAt;            // 更新日時
}
```

#### 4.1.3 ApiMetricsDTO

```java
public class ApiMetricsDTO {
    private String routeId;                     // ルートID
    private String clientId;                    // クライアントID
    private LocalDateTime startTime;            // 集計開始時間
    private LocalDateTime endTime;              // 集計終了時間
    private Long requestCount;                  // リクエスト数
    private Long errorCount;                    // エラー数
    private Double errorRate;                   // エラー率
    private Long averageLatency;                // 平均レイテンシー(ms)
    private Long p95Latency;                    // 95パーセンタイルレイテンシー(ms)
    private Long dataTransferred;               // 転送データ量(bytes)
    private Map<Integer, Long> statusCodes;     // ステータスコード別件数
    private Map<String, Long> topPaths;         // 上位アクセスパス
}
```

#### 4.1.4 GatewayStatusDTO

```java
public class GatewayStatusDTO {
    private String version;                     // ゲートウェイバージョン
    private String status;                      // 状態（ACTIVE/DEGRADED/DOWN）
    private LocalDateTime startTime;            // 起動時間
    private Long uptime;                        // 稼働時間（秒）
    private Integer activeRoutes;               // アクティブルート数
    private Integer activeFilters;              // アクティブフィルター数
    private List<String> activeServers;         // アクティブサーバー
    private Map<String, String> serverStatuses; // サーバー状態
    private Map<String, Object> metrics;        // 各種メトリクス値
}
```

### 4.2 要求インターフェース用DTO

#### 4.2.1 ApiAccessLogDTO

```java
public class ApiAccessLogDTO {
    private String requestId;                   // リクエストID
    private LocalDateTime timestamp;            // タイムスタンプ
    private String clientId;                    // クライアントID
    private String userId;                      // ユーザーID
    private String clientIp;                    // クライアントIP
    private String method;                      // HTTPメソッド
    private String path;                        // リクエストパス
    private String routeId;                     // ルートID
    private Integer statusCode;                 // ステータスコード
    private Long responseTime;                  // レスポンス時間(ms)
    private Long requestSize;                   // リクエストサイズ(bytes)
    private Long responseSize;                  // レスポンスサイズ(bytes)
    private String userAgent;                   // UserAgent
    private Map<String, String> metadata;       // その他メタデータ
}
```

#### 4.2.2 ApiErrorLogDTO

```java
public class ApiErrorLogDTO {
    private String requestId;                   // リクエストID
    private LocalDateTime timestamp;            // タイムスタンプ
    private String clientId;                    // クライアントID
    private String userId;                      // ユーザーID
    private String clientIp;                    // クライアントIP
    private String method;                      // HTTPメソッド
    private String path;                        // リクエストパス
    private String routeId;                     // ルートID
    private Integer statusCode;                 // ステータスコード
    private String errorCode;                   // エラーコード
    private String errorMessage;                // エラーメッセージ
    private String stackTrace;                  // スタックトレース
    private Map<String, String> metadata;       // その他メタデータ
}
```

#### 4.2.3 SecurityAuditLogDTO

```java
public class SecurityAuditLogDTO {
    private String requestId;                   // リクエストID
    private LocalDateTime timestamp;            // タイムスタンプ
    private String clientId;                    // クライアントID
    private String userId;                      // ユーザーID
    private String clientIp;                    // クライアントIP
    private String eventType;                   // イベントタイプ
    private String resource;                    // リソース
    private String action;                      // アクション
    private Boolean success;                    // 成功フラグ
    private String reason;                      // 理由（失敗時）
    private Map<String, String> metadata;       // その他メタデータ
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

| インターフェース | メソッド | 応答時間(95%) | スループット(最大) | 備考 |
|---------------|---------|------------|-----------------|------|
| ApiGatewayService | registerRoute | 200ms | 10req/sec | 運用管理系であり高負荷想定外 |
| ApiGatewayService | getRoute | 50ms | 100req/sec | キャッシュ適用 |
| ApiGatewayService | reloadConfiguration | 500ms | 1req/sec | 運用管理系で頻度低 |
| MetricsService | getRouteMetrics | 200ms | 50req/sec | データ量により変動 |
| MetricsService | getTimeSeriesMetrics | 500ms | 20req/sec | 期間・粒度により変動 |

### 5.2 トランザクション要件

| インターフェース | メソッド | トランザクション | 分離レベル | 備考 |
|---------------|---------|--------------|-----------|------|
| ApiGatewayService | registerRoute | 必須 | READ_COMMITTED | ルート定義更新のアトミック性確保 |
| ApiGatewayService | deleteRoute | 必須 | READ_COMMITTED | ルート定義削除と関連設定の整合性 |
| ApiGatewayService | registerClient | 必須 | READ_COMMITTED | クライアント情報登録の整合性 |
| MetricsService | 全メソッド | 不要 | READ_COMMITTED | 読み取り専用処理 |

### 5.3 セキュリティ要件

| インターフェース | メソッド | 権限 | 備考 |
|---------------|---------|------|------|
| ApiGatewayService | 全メソッド | ADMIN | システム管理者のみアクセス可能 |
| MetricsService | 全メソッド | ADMIN, MONITOR | システム管理者および監視担当者がアクセス可能 |
| GatewayFilter | 全メソッド | システム内部利用 | 外部からの直接呼び出し不可 |
| ApiClientValidator | 全メソッド | システム内部利用 | 外部からの直接呼び出し不可 |

### 5.4 可用性要件

WebAPIゲートウェイ機能全体として、以下の可用性要件を満たす必要があります。

- **稼働率**: 99.95%以上（月間ダウンタイム約22分以内）
- **SPOF（単一障害点）**: 可能な限り排除、冗長構成推奨
- **バックアップ**: 設定情報は日次バックアップ
- **災害対策**: 地理的分散配置を考慮した設計
- **ヘルスチェック**: 1分間隔の稼働確認と自動通知