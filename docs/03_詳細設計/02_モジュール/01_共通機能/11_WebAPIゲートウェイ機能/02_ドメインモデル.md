# WebAPIゲートウェイ機能 ドメインモデル

## 1. 概要

WebAPIゲートウェイのドメインモデルは、APIリクエストの処理とルーティングに関わるコアエンティティと値オブジェクトを定義します。これらのモデルは、APIゲートウェイの設定、リクエスト/レスポンス処理、セキュリティ、監視などの機能を実現するための基盤となります。

## 2. エンティティ

### 2.1 RouteDefinition（ルート定義）

ルート定義は、特定のリクエストパターンを対象バックエンドサービスにマッピングするための設定を表します。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| id | String | ルート定義の一意識別子 | 必須、一意 |
| path | String | マッチするURLパスパターン | 必須、有効なパスパターン |
| method | HttpMethod | HTTPメソッド（GET, POST等） | 任意（nullの場合は全メソッド） |
| targetService | String | 転送先サービスID | 必須 |
| predicates | List<RoutePredicate> | 一致条件のリスト | 1つ以上必須 |
| filters | List<RouteFilter> | 適用するフィルターのリスト | 任意 |
| order | Integer | ルーティング優先度（小さい値が優先） | デフォルト値:0 |
| enabled | Boolean | 有効/無効フラグ | デフォルト値:true |
| metadata | Map<String, String> | 追加メタデータ | 任意 |

```
class RouteDefinition {
    String id;
    String path;
    HttpMethod method;
    String targetService;
    List<RoutePredicate> predicates;
    List<RouteFilter> filters;
    Integer order;
    Boolean enabled;
    Map<String, String> metadata;

    boolean matches(HttpServletRequest request);
}
```

### 2.2 ApiClient（APIクライアント）

APIを利用するクライアントアプリケーションの情報を表します。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| clientId | String | クライアントの一意識別子 | 必須、一意 |
| name | String | クライアント名称 | 必須 |
| apiKey | ApiKey | APIキー情報 | 必須 |
| status | ClientStatus | 状態（ACTIVE/INACTIVE/BLOCKED） | 必須 |
| rateLimit | RateLimit | レート制限設定 | 必須 |
| allowedIPs | List<String> | アクセス許可IP | 任意 |
| allowedScopes | Set<String> | 許可されたスコープ | 任意 |
| createdAt | LocalDateTime | 作成日時 | 必須、自動設定 |
| updatedAt | LocalDateTime | 更新日時 | 必須、自動設定 |

```
class ApiClient {
    String clientId;
    String name;
    ApiKey apiKey;
    ClientStatus status;
    RateLimit rateLimit;
    List<String> allowedIPs;
    Set<String> allowedScopes;
    LocalDateTime createdAt;
    LocalDateTime updatedAt;

    boolean hasScope(String scope);
    boolean isIpAllowed(String ipAddress);
    boolean isActive();
}
```

### 2.3 ApiMetrics（APIメトリクス）

API使用状況に関するメトリクスデータを表します。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| id | String | メトリクスレコードの一意識別子 | 必須、一意 |
| routeId | String | ルート定義ID | 必須 |
| clientId | String | API実行クライアントID | 任意 |
| timestamp | LocalDateTime | 記録時間 | 必須 |
| requestCount | Long | リクエスト数 | 0以上 |
| errorCount | Long | エラー数 | 0以上 |
| averageLatency | Long | 平均レイテンシー(ms) | 0以上 |
| p95Latency | Long | 95パーセンタイルレイテンシー(ms) | 0以上 |
| dataTransferred | Long | 転送データ量(bytes) | 0以上 |

```
class ApiMetrics {
    String id;
    String routeId;
    String clientId;
    LocalDateTime timestamp;
    Long requestCount;
    Long errorCount;
    Long averageLatency;
    Long p95Latency;
    Long dataTransferred;

    double getErrorRate();
    boolean isHealthy();
}
```

## 3. 値オブジェクト

### 3.1 ApiKey（APIキー）

APIへのアクセスに使用する認証キー情報です。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| keyValue | String | APIキー値 | 必須、一意 |
| expiresAt | LocalDateTime | 有効期限 | 任意 |
| lastUsedAt | LocalDateTime | 最終使用日時 | 任意 |
| revoked | Boolean | 失効フラグ | デフォルト値:false |

```
class ApiKey {
    String keyValue;
    LocalDateTime expiresAt;
    LocalDateTime lastUsedAt;
    Boolean revoked;

    boolean isValid();
    boolean isExpired();
}
```

### 3.2 RoutePredicate（ルート述語）

リクエストがルートに一致するかどうかを判定する条件を表します。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| type | PredicateType | 述語タイプ（PATH/HEADER/QUERY_PARAM等） | 必須 |
| name | String | 判定対象の名前（ヘッダー名など） | 条件によって必須 |
| value | String | 期待値 | 必須 |
| matchType | MatchType | 一致条件（EXACT/PREFIX/REGEX等） | 必須 |

```
class RoutePredicate {
    PredicateType type;
    String name;
    String value;
    MatchType matchType;

    boolean matches(HttpServletRequest request);
}
```

### 3.3 RouteFilter（ルートフィルター）

リクエスト/レスポンス処理に適用するフィルターを表します。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| type | FilterType | フィルタータイプ（REWRITE_PATH/ADD_HEADER等） | 必須 |
| name | String | 対象名（ヘッダー名など） | 条件によって必須 |
| value | String | 設定値 | 条件によって必須 |
| order | Integer | 適用順序（小さい値が優先） | デフォルト値:0 |
| applyTo | FilterApplyTo | 適用対象（REQUEST/RESPONSE/BOTH） | 必須 |

```
class RouteFilter {
    FilterType type;
    String name;
    String value;
    Integer order;
    FilterApplyTo applyTo;

    void apply(GatewayRequest request, GatewayResponse response);
}
```

### 3.4 RateLimit（レート制限）

APIリクエストの頻度制限を表します。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| limit | Integer | 制限数 | 1以上 |
| duration | Integer | 期間（秒） | 1以上 |
| limitType | RateLimitType | 制限タイプ（IP/CLIENT/USER等） | 必須 |

```
class RateLimit {
    Integer limit;
    Integer duration;
    RateLimitType limitType;

    boolean isExceeded(String key, Integer requestCount);
    long getRemainingLimit(String key);
}
```

### 3.5 GatewayRequest（ゲートウェイリクエスト）

内部的に扱われるリクエスト情報です。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| id | String | リクエスト一意識別子 | 必須、一意 |
| path | String | リクエストパス | 必須 |
| method | HttpMethod | HTTPメソッド | 必須 |
| headers | Map<String, List<String>> | HTTPヘッダー | 必須 |
| queryParams | Map<String, List<String>> | クエリパラメータ | 任意 |
| body | byte[] | リクエストボディ | 任意 |
| clientIp | String | クライアントIP | 必須 |
| timestamp | LocalDateTime | リクエスト時刻 | 必須 |
| attributes | Map<String, Object> | リクエスト属性 | 任意 |

```
class GatewayRequest {
    String id;
    String path;
    HttpMethod method;
    Map<String, List<String>> headers;
    Map<String, List<String>> queryParams;
    byte[] body;
    String clientIp;
    LocalDateTime timestamp;
    Map<String, Object> attributes;

    boolean hasHeader(String name);
    String getHeader(String name);
    void addHeader(String name, String value);
}
```

### 3.6 GatewayResponse（ゲートウェイレスポンス）

内部的に扱われるレスポンス情報です。

| 属性 | 型 | 説明 | 制約 |
|-----|------|------|------|
| statusCode | Integer | HTTPステータスコード | 必須 |
| headers | Map<String, List<String>> | HTTPヘッダー | 必須 |
| body | byte[] | レスポンスボディ | 任意 |
| timestamp | LocalDateTime | レスポンス時刻 | 必須 |
| processingTime | Long | 処理時間(ms) | 必須 |

```
class GatewayResponse {
    Integer statusCode;
    Map<String, List<String>> headers;
    byte[] body;
    LocalDateTime timestamp;
    Long processingTime;

    boolean isSuccess();
    boolean isClientError();
    boolean isServerError();
    void addHeader(String name, String value);
}
```

## 4. 列挙型

### 4.1 ClientStatus（クライアント状態）

```
enum ClientStatus {
    ACTIVE,    // アクティブ、利用可能
    INACTIVE,  // 非アクティブ、一時的に利用不可
    BLOCKED    // ブロック、セキュリティ上の理由で利用不可
}
```

### 4.2 PredicateType（述語タイプ）

```
enum PredicateType {
    PATH,          // パスベース
    HEADER,        // ヘッダーベース
    QUERY_PARAM,   // クエリパラメータベース
    METHOD,        // HTTPメソッドベース
    HOST,          // ホストベース
    COOKIE,        // クッキーベース
    IP_ADDRESS,    // IPアドレスベース
    DATETIME       // 日時ベース
}
```

### 4.3 MatchType（一致タイプ）

```
enum MatchType {
    EXACT,     // 完全一致
    PREFIX,    // 前方一致
    SUFFIX,    // 後方一致
    REGEX,     // 正規表現
    CONTAINS   // 部分一致
}
```

### 4.4 FilterType（フィルタータイプ）

```
enum FilterType {
    ADD_HEADER,        // ヘッダー追加
    REMOVE_HEADER,     // ヘッダー削除
    REWRITE_PATH,      // パス書き換え
    ADD_QUERY_PARAM,   // クエリパラメータ追加
    REMOVE_QUERY_PARAM,// クエリパラメータ削除
    SET_STATUS,        // ステータス設定
    RETRY,             // リトライ
    CIRCUIT_BREAKER,   // サーキットブレーカー
    RATE_LIMITER,      // レート制限
    TIMEOUT,           // タイムアウト
    CACHING,           // キャッシュ
    REQUEST_LOGGING,   // リクエストロギング
    RESPONSE_LOGGING   // レスポンスロギング
}
```

### 4.5 FilterApplyTo（フィルター適用対象）

```
enum FilterApplyTo {
    REQUEST,   // リクエストのみ
    RESPONSE,  // レスポンスのみ
    BOTH       // 両方
}
```

### 4.6 RateLimitType（レート制限タイプ）

```
enum RateLimitType {
    IP,        // IPアドレスベース
    CLIENT,    // クライアントIDベース
    USER,      // ユーザーIDベース
    ENDPOINT   // エンドポイントベース
}
```

## 5. ドメインサービス

### 5.1 RouteMatchingService（ルート一致サービス）

指定されたリクエストに最も適合するルート定義を特定するサービスです。

```
interface RouteMatchingService {
    RouteDefinition findMatchingRoute(GatewayRequest request);
    List<RouteDefinition> getAllRoutes();
    RouteDefinition getRouteById(String routeId);
}
```

### 5.2 RateLimitingService（レート制限サービス）

リクエストのレート制限を管理するサービスです。

```
interface RateLimitingService {
    boolean allowRequest(String key, RateLimit limit);
    long getRemainingQuota(String key, RateLimit limit);
    void recordRequest(String key, RateLimit limit);
}
```

### 5.3 MetricsCollectionService（メトリクス収集サービス）

API利用に関するメトリクスを収集するサービスです。

```
interface MetricsCollectionService {
    void recordRequest(GatewayRequest request, GatewayResponse response, RouteDefinition route);
    ApiMetrics getMetricsForRoute(String routeId, LocalDateTime from, LocalDateTime to);
    ApiMetrics getMetricsForClient(String clientId, LocalDateTime from, LocalDateTime to);
}
```

## 6. 集約（Aggregates）

### 6.1 RouteConfiguration（ルート設定集約）

- **ルート集合**：RouteDefinition、RoutePredicateとRouteFilterで構成されるルート設定一式
- **責務**：全APIルートの定義と管理
- **集約ルート**：RouteDefinition
- **境界内のエンティティ**：RouteDefinition
- **境界内の値オブジェクト**：RoutePredicate、RouteFilter

### 6.2 ClientManagement（クライアント管理集約）

- **クライアント集合**：ApiClient、ApiKey、RateLimitで構成されるクライアント管理一式
- **責務**：APIクライアントの登録と管理
- **集約ルート**：ApiClient
- **境界内のエンティティ**：ApiClient
- **境界内の値オブジェクト**：ApiKey、RateLimit

### 6.3 MetricsAggregation（メトリクス集約）

- **メトリクス集合**：ApiMetricsの集計とレポート
- **責務**：APIメトリクスの収集と分析
- **集約ルート**：ApiMetrics
- **境界内のエンティティ**：ApiMetrics
- **境界内の値オブジェクト**：なし