# WebAPIゲートウェイ機能 リクエスト処理機能

## 1. 概要

リクエスト処理機能は、WebAPIゲートウェイに到着したクライアントリクエストを検証、変換、拡張し、バックエンドサービスへの転送準備を行う機能です。この機能により、バックエンドサービスが処理すべきリクエストの標準化、正規化、およびセキュリティチェックを一元的に実施し、バックエンドの負担軽減と一貫性のあるAPI体験を提供します。

## 2. リクエスト処理機能の責務

リクエスト処理機能は以下の主要な責務を持ちます：

1. **リクエスト検証**: 構文的・意味的な正当性の検証
2. **リクエスト変換**: フォーマットの標準化と正規化
3. **リクエスト拡張**: コンテキスト情報の追加
4. **セキュリティチェック**: 基本的なセキュリティルールの適用
5. **前処理フィルター**: 条件に基づく処理の適用

## 3. コンポーネント構成

リクエスト処理機能は以下のコンポーネントで構成されます：

### 3.1 RequestValidator

リクエストの構文的・意味的な検証を行うコンポーネントです。

**主要機能**:
- スキーマベースのバリデーション（JSON Schema等）
- 必須パラメータの存在チェック
- データ型チェック
- フォーマットチェック（日付、メール等）
- 値範囲チェック
- カスタムバリデーションルールの適用

```java
public interface RequestValidator {
    ValidationResult validate(GatewayRequest request, ValidationRules rules);
    ValidationRules getValidationRulesForRoute(String routeId);
}
```

### 3.2 RequestTransformer

リクエストの形式変換を行うコンポーネントです。

**主要機能**:
- パスパラメータの正規化
- クエリパラメータの変換・正規化
- ヘッダーの追加・変更・削除
- ボディ形式の変換（XML→JSON等）
- データフォーマットの標準化

```java
public interface RequestTransformer {
    GatewayRequest transform(GatewayRequest request, List<TransformationRule> rules);
    List<TransformationRule> getTransformationRulesForRoute(String routeId);
}
```

### 3.3 RequestEnricher

コンテキスト情報を追加してリクエストを拡張するコンポーネントです。

**主要機能**:
- ユーザーコンテキスト情報の追加
- トレーシングIDの追加
- タイムスタンプの追加
- リクエスト識別子の生成と追加
- カスタムメタデータの追加

```java
public interface RequestEnricher {
    GatewayRequest enrich(GatewayRequest request, EnrichmentContext context);
    EnrichmentContext createContext(GatewayRequest request, AuthContext authContext);
}
```

### 3.4 SecurityChecker

基本的なセキュリティチェックを行うコンポーネントです。

**主要機能**:
- 入力サニタイゼーション
- SQLインジェクション対策
- XSS対策
- CSRFトークン検証
- 不審なパターンの検出

```java
public interface SecurityChecker {
    SecurityCheckResult checkSecurity(GatewayRequest request, SecurityPolicy policy);
    SecurityPolicy getSecurityPolicyForRoute(String routeId);
}
```

### 3.5 RequestFilterChain

リクエスト処理の流れを制御するフィルターチェーンです。

**主要機能**:
- フィルターの順次適用
- 条件付き処理
- エラーハンドリング
- 処理の中断制御

```java
public interface RequestFilterChain {
    FilterResult applyFilters(GatewayRequest request, List<RequestFilter> filters);
    void registerFilter(RequestFilter filter, int order);
}
```

## 4. 処理フロー

### 4.1 基本的なリクエスト処理フロー

```
1. リクエスト受信
   ↓
2. RequestValidator.validate()でリクエスト検証
   ↓ 
3. ValidationResult確認 - エラーならエラーレスポンス返却
   ↓
4. RequestTransformer.transform()でリクエスト変換
   ↓
5. SecurityChecker.checkSecurity()でセキュリティチェック
   ↓
6. SecurityCheckResult確認 - エラーならエラーレスポンス返却
   ↓
7. RequestEnricher.enrich()でリクエスト拡張
   ↓
8. RequestFilterChain.applyFilters()でフィルター適用
   ↓
9. フィルター結果確認 - 中断指示ならその結果を返却
   ↓
10. 処理済みリクエストをルーティング機能へ渡す
```

### 4.2 フィルター処理フロー

```
1. フィルターチェーン開始
   ↓
2. フィルター#1実行
   ↓
3. 継続判定 - 中断ならその結果を返却
   ↓
4. フィルター#2実行
   ↓
5. 継続判定 - 中断ならその結果を返却
   ↓
   ...
6. 最終フィルター実行
   ↓
7. 処理済みリクエスト返却
```

## 5. リクエスト処理ルールの設計

### 5.1 バリデーションルール

バリデーションルールは以下の要素で構成されます：

**基本バリデーション**:
- **required**: 必須パラメータ定義
- **type**: データ型制約（string, number, boolean等）
- **format**: フォーマット制約（email, date, uuid等）
- **enum**: 列挙型制約（許可値リスト）
- **pattern**: 正規表現制約
- **minLength/maxLength**: 文字列長制約
- **minimum/maximum**: 数値範囲制約

**パス別バリデーション**:
- URIパスごとに異なるバリデーションルールを定義
- HTTPメソッドごとに異なるルールを定義

**カスタムバリデーション**:
- 業務ルールに基づく複合バリデーション
- 依存関係を持つフィールド間のバリデーション

### 5.2 変換ルール

変換ルールは以下の要素で構成されます：

**パラメータ変換**:
- **rename**: パラメータ名の変更（oldName → newName）
- **reformat**: パラメータ形式の変更（日付形式等）
- **cast**: データ型の変換
- **default**: デフォルト値の設定
- **remove**: 不要パラメータの削除

**ヘッダー変換**:
- **add**: ヘッダーの追加
- **modify**: ヘッダー値の変更
- **remove**: ヘッダーの削除
- **copy**: 他ヘッダーからの値コピー

**ボディ変換**:
- **contentType**: コンテンツタイプの変換
- **structure**: 構造の変換（フィールド再配置等）
- **encoding**: エンコーディング変換

### 5.3 拡張ルール

拡張ルールは以下の要素で構成されます：

**コンテキスト追加**:
- **userContext**: ユーザー情報の追加
- **tenantContext**: テナント情報の追加
- **sessionContext**: セッション情報の追加

**システム情報追加**:
- **requestId**: リクエスト識別子の生成と追加
- **timestamp**: 処理時刻の追加
- **correlationId**: 関連処理の相関ID追加
- **source**: リクエスト送信元情報の追加

**ルーティング情報**:
- **targetService**: 転送先サービス情報の追加
- **serviceVersion**: サービスバージョン情報の追加

### 5.4 セキュリティルール

セキュリティルールは以下の要素で構成されます：

**入力検証**:
- **sanitization**: 危険な文字のエスケープ
- **sqlInjection**: SQLインジェクション対策パターン
- **xssProtection**: XSS対策パターン

**アクセス制御**:
- **csrfToken**: CSRFトークン検証ルール
- **referrerCheck**: リファラーチェックルール
- **originCheck**: オリジン検証ルール

**不正検知**:
- **maliciousPatterns**: 不審なパターン検出ルール
- **payloadSizeLimit**: ペイロードサイズ制限
- **parameterCountLimit**: パラメータ数制限

## 6. 主要ユースケース

### 6.1 JSONスキーマによるリクエスト検証

JSONデータの構造と値を検証します。

**設定例**:
```json
{
  "routeId": "api-projects-create",
  "validationRules": {
    "schema": {
      "type": "object",
      "required": ["name", "clientId", "startDate", "endDate"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 3,
          "maxLength": 100
        },
        "clientId": {
          "type": "string",
          "format": "uuid"
        },
        "description": {
          "type": "string",
          "maxLength": 500
        },
        "startDate": {
          "type": "string",
          "format": "date"
        },
        "endDate": {
          "type": "string",
          "format": "date"
        },
        "budget": {
          "type": "number",
          "minimum": 0
        },
        "status": {
          "type": "string",
          "enum": ["DRAFT", "ACTIVE", "COMPLETED", "CANCELLED"]
        }
      }
    }
  }
}
```

**挙動**:
- リクエストボディがスキーマに準拠 → 検証成功
- 必須フィールド欠落、型違反等 → 400 Bad Requestエラーと詳細を返却

### 6.2 リクエストパラメータの正規化

異なるクライアントからの様々な形式のパラメータを標準形式に変換します。

**設定例**:
```json
{
  "routeId": "api-search-engineers",
  "transformationRules": [
    {
      "type": "RENAME_PARAMETER",
      "target": "QUERY",
      "oldName": "q",
      "newName": "query"
    },
    {
      "type": "RENAME_PARAMETER",
      "target": "QUERY",
      "oldName": "s",
      "newName": "skills"
    },
    {
      "type": "REFORMAT_DATE",
      "target": "QUERY",
      "name": "available_from",
      "sourceFormat": ["yyyy-MM-dd", "MM/dd/yyyy"],
      "targetFormat": "yyyy-MM-dd"
    },
    {
      "type": "DEFAULT_VALUE",
      "target": "QUERY",
      "name": "page",
      "defaultValue": "0"
    },
    {
      "type": "DEFAULT_VALUE",
      "target": "QUERY",
      "name": "size",
      "defaultValue": "20"
    }
  ]
}
```

**挙動**:
- `/api/v1/engineers?q=java&s=spring&available_from=05/15/2025` →
- `/api/v1/engineers?query=java&skills=spring&available_from=2025-05-15&page=0&size=20`

### 6.3 認証情報の拡張

ユーザー認証情報をリクエストに追加します。

**設定例**:
```json
{
  "routeId": "api-contracts-management",
  "enrichmentRules": [
    {
      "type": "ADD_USER_CONTEXT",
      "mode": "HEADER",
      "fields": ["userId", "userName", "roles", "tenantId"]
    },
    {
      "type": "ADD_REQUEST_ID",
      "mode": "HEADER",
      "headerName": "X-Request-ID"
    },
    {
      "type": "ADD_TIMESTAMP",
      "mode": "HEADER",
      "headerName": "X-Request-Time",
      "format": "yyyy-MM-dd'T'HH:mm:ss.SSSZ"
    }
  ]
}
```

**挙動**:
- 認証済みユーザーからのリクエスト →
- 以下のヘッダーが追加されたリクエストがバックエンドに転送
  ```
  X-User-ID: 12345
  X-User-Name: John Doe
  X-User-Roles: ADMIN,MANAGER
  X-Tenant-ID: T789
  X-Request-ID: req-1234567890abcdef
  X-Request-Time: 2025-05-11T14:30:45.123+0900
  ```

### 6.4 XSS対策フィルター

リクエストパラメータのXSS脆弱性を検出・対策します。

**設定例**:
```json
{
  "routeId": "api-comments-create",
  "securityRules": {
    "xssProtection": {
      "enabled": true,
      "mode": "SANITIZE",
      "targets": ["body.content", "query.comment"]
    }
  }
}
```

**挙動**:
- `body.content`が`<script>alert('XSS');</script>テスト`を含む →
- サニタイズされた`&lt;script&gt;alert('XSS');&lt;/script&gt;テスト`に変換
- または設定によっては拒否し400 Bad Requestを返却

## 7. エラーハンドリング

リクエスト処理機能におけるエラーハンドリングは以下のように設計されています：

### 7.1 バリデーションエラー

- **形式エラー**: JSONフォーマットエラー等の構文エラーの場合、400 Bad Requestを返却
- **制約違反**: バリデーションルールに違反する場合、違反箇所と理由を含む422 Unprocessable Entityを返却
- **複合エラー**: 複数のエラーがある場合、すべてのエラーをリストにして返却

### 7.2 変換エラー

- **変換失敗**: データ型変換や日付形式変換に失敗した場合、400 Bad Requestを返却
- **欠落項目**: 必須項目が欠落している場合、400 Bad Requestを返却
- **非互換性**: 変換ルールと入力データの互換性がない場合、422 Unprocessable Entityを返却

### 7.3 セキュリティエラー

- **不正検出**: 悪意のあるパターンが検出された場合、403 Forbiddenを返却
- **CSRFエラー**: CSRFトークン検証失敗時、403 Forbiddenを返却
- **サイズ制限違反**: ペイロードサイズ超過時、413 Payload Too Largeを返却

### 7.4 エラーレスポンス形式

エラーレスポンスは統一された形式で返却されます：

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "リクエストパラメータが不正です",
    "details": [
      {
        "field": "name",
        "message": "3文字以上100文字以下で入力してください",
        "code": "SIZE_CONSTRAINT"
      },
      {
        "field": "startDate",
        "message": "日付形式が不正です（yyyy-MM-dd形式で入力）",
        "code": "FORMAT_ERROR"
      }
    ],
    "requestId": "req-1234567890abcdef",
    "timestamp": "2025-05-11T14:30:45.123+0900"
  }
}
```

## 8. 監視とメトリクス

### 8.1 収集メトリクス

リクエスト処理機能は以下のメトリクスを収集します：

| メトリクス名 | 種類 | 説明 |
|------------|------|------|
| gateway.request.validation.total | カウンター | バリデーション実行回数 |
| gateway.request.validation.errors | カウンター | バリデーションエラー数 |
| gateway.request.transformation.total | カウンター | 変換処理実行回数 |
| gateway.request.transformation.errors | カウンター | 変換エラー数 |
| gateway.request.security.total | カウンター | セキュリティチェック実行回数 |
| gateway.request.security.violations | カウンター | セキュリティ違反検出数 |
| gateway.request.processing.time | ヒストグラム | リクエスト処理時間分布 |

### 8.2 アラート条件

以下の条件に基づいてアラートを発行します：

| アラート名 | 条件 | 重要度 | アクション |
|-----------|------|-------|----------|
| HighValidationErrorRate | バリデーションエラー率が10%超 | 中 | クライアントアプリの問題調査 |
| SecurityViolationSpike | セキュリティ違反が急増（過去平均の3倍以上） | 高 | 不正アクセス調査 |
| RequestProcessingLatency | 処理時間が100ms超 | 中 | パフォーマンス調査 |

## 9. パフォーマンス最適化

### 9.1 最適化手法

リクエスト処理機能のパフォーマンスを最適化するために以下の手法を採用しています：

1. **バリデーションスキーマキャッシュ**: 頻繁に使用されるバリデーションスキーマをキャッシュ
2. **段階的バリデーション**: 軽量な検証から開始し、必要に応じて詳細検証を実施
3. **並列処理**: 互いに独立した検証ルールの並列実行
4. **早期失敗**: 重大なエラーを早期に検出して後続処理をスキップ
5. **バッファリング最適化**: 大きなリクエストボディの効率的な処理

### 9.2 スケーラビリティ考慮点

1. **ステートレス設計**: 状態を持たない設計によるスケールアウト容易性
2. **設定の動的更新**: 再起動なしでのルール更新による可用性確保
3. **カスタムルールのホットデプロイ**: 新しいバリデーション/変換ルールの動的追加
4. **リソース使用量制御**: 大量リクエスト時のリソース消費制限

## 10. 今後の拡張性

リクエスト処理機能は以下の拡張性を考慮して設計されています：

1. **プラグイン機構**: カスタムバリデータ、トランスフォーマーのプラグイン形式での追加
2. **ルール言語**: 宣言的なルール定義のためのDSL（ドメイン特化言語）対応
3. **スクリプト統合**: JavaScript等のスクリプトによるカスタムロジック実装
4. **機械学習統合**: 異常検知や自動分類のための機械学習モデル統合
5. **API分析**: リクエストパターン分析とリアルタイムフィードバック