# 通知機能 - 通知管理機能

## 1. 機能概要

通知管理機能は、通知の検索、表示、ステータス管理、設定管理など、通知のライフサイクル全体を管理する機能です。主に以下の責務を担います：

- 通知の検索と取得
- 通知の既読/未読管理
- 通知の削除とアーカイブ
- ユーザーごとの通知設定の管理
- 通知テンプレートの管理
- 通知統計情報の集計と分析

## 2. コンポーネント構成

### 2.1 NotificationRepository

通知の永続化と検索を担当するリポジトリコンポーネントです。

#### 責務
- 通知の保存と取得
- 検索条件に基づく通知の検索
- 通知のバッチ処理と集計

#### 主要メソッド

- ユーザーの通知を取得
- 未読通知を取得
- 特定タイプの通知を取得
- 複合条件での検索
- 未読通知数の取得
- 特定期間の通知検索
- キーワード検索
- メタデータ値による検索
- 古い通知をアーカイブ
- 期限切れ通知を削除

#### クエリ最適化

- インデックス設計
  - recipient_username, created_at（降順）のインデックス
  - recipient_username, type, read のインデックス
  - recipient_username, archived のインデックス

- クエリチューニング
  - 頻繁にアクセスされる未読通知など頻出パターンのキャッシュ
  - 全文検索用の専用インデックス（タイトル、本文）
  - メタデータ用のJSON型インデックス

### 2.2 NotificationPreferenceRepository

通知設定の永続化と取得を担当するリポジトリコンポーネントです。

#### 責務
- ユーザーごとの通知設定の管理
- 通知タイプごとの設定管理
- デフォルト設定の提供

#### 主要メソッド

- ユーザーの全通知設定を取得
- 特定タイプの通知設定を取得
- ユーザーのアプリ内通知が有効な通知タイプを取得
- ユーザーのメール通知が有効な通知タイプを取得
- 既存の設定がない場合はデフォルト設定を使用
- デフォルト設定を作成

### 2.3 NotificationTemplateRepository

通知テンプレートの管理を担当するリポジトリコンポーネントです。

#### 責務
- テンプレートの保存と取得
- テンプレートの検索
- テンプレートの有効/無効管理

#### 主要メソッド

- キーでテンプレートを検索
- 通知タイプによるテンプレート検索
- 有効なテンプレートのみ取得
- 通知タイプと有効フラグによる検索
- テンプレートキーの存在確認
- キーワードによるテンプレート検索

## 3. 通知管理機能の実装

### 3.1 通知のステータス管理

通知の状態遷移を管理する機能です。

#### 通知ステータス

通知は以下の状態を持ちます：

1. **作成済み (CREATED)**: 通知が作成されたが、まだ配信されていない状態
2. **配信済み (DELIVERED)**: 通知が配信され、ユーザーがアクセス可能になった状態
3. **既読 (READ)**: ユーザーが通知を閲覧した状態
4. **アーカイブ済み (ARCHIVED)**: 一定期間経過後、またはユーザーによってアーカイブされた状態
5. **削除済み (DELETED)**: ユーザーによって削除された状態

#### 状態遷移の実装方針

- 通知を既読にする機能
  - アクセス権チェック
  - 既に既読の場合は何もしない
  - 既読状態に更新して保存

- 全ての未読通知を既読にする機能
  - タイプ指定があれば特定タイプのみ対象
  - 通知が存在しない場合は何もしない
  - 一括で既読状態に更新

- 通知をアーカイブする機能
  - アクセス権チェック
  - アーカイブ状態に更新して保存

- 通知を削除する機能（論理削除）
  - アクセス権チェック
  - 削除状態に更新して保存

- 期限切れの通知を自動アーカイブする機能
  - 通知タイプごとに保持期間を設定
  - 期限切れした通知をアーカイブ

### 3.2 通知の検索と取得

ユーザーの通知を検索し取得する機能です。

#### 主要機能

- ユーザーの通知を取得（フィルタリング・ページング対応）
  - タイプ、既読状態、キーワード、期間によるフィルタリング
  - ページングとソート機能
  - 削除済み通知は除外

- 通知詳細の取得
  - アクセス権チェック
  - 未読の場合は既読にマーク
  - 詳細情報をDTOに変換して返却

- エンティティ参照による通知検索
  - 特定のエンティティ（案件、契約など）に関連する通知を検索
  - メタデータの entityType, entityId による検索

- 通知の統計情報を取得
  - 未読通知数
  - タイプ別の未読通知数
  - 最新通知日時
  - 今日の通知数

### 3.3 通知設定の管理

ユーザーごとの通知設定を管理する機能です。

#### 主要機能

- ユーザーの通知設定を取得
  - 全ての通知タイプに対する設定を取得
  - 存在しない場合はデフォルト設定を作成

- 通知設定を更新
  - ユーザーの存在確認
  - 入力値の検証
  - 既存の設定を取得または新規作成
  - 設定を更新して保存

- デフォルト設定にリセット
  - ユーザーの存在確認
  - 既存の設定を削除
  - タイプごとのデフォルト設定を作成して保存

- 特定タイプの通知設定を取得
  - 存在しない場合はデフォルト設定を返却

#### デフォルト設定の方針

- システム通知: アプリ内通知のみ、保持期間90日
- タスク通知: アプリ内通知とメール通知、保持期間90日
- アラート通知: アプリ内通知とメール通知、保持期間180日
- イベント通知: アプリ内通知のみ、保持期間60日

### 3.4 テンプレート管理

通知テンプレートを管理する機能です。

#### 主要機能

- テンプレートの取得
  - テンプレートキーによる取得
  - 存在しない場合は例外をスロー

- テンプレートの作成
  - キーの重複チェック
  - テンプレートの検証
  - 新規テンプレートの作成と保存

- テンプレートの更新
  - 既存テンプレートの取得
  - テンプレートの検証
  - テンプレートの更新と保存

- テンプレートの削除
  - 既存テンプレートの取得
  - テンプレートの削除

- テンプレートの検証
  - 必須項目の確認（タイトル、本文）
  - タイトルと本文の長さ制限
  - テンプレート構文の検証
  - メタデータのJSON形式検証

## 4. 統計と分析

### 4.1 通知統計情報

通知の統計情報を集計し分析する機能です。

#### 統計情報の項目

- 全体統計
  - 総通知数
  - 未読通知数
  - 今日の通知数
  - 最新通知日時
  - 既読率（パーセンテージ）

- タイプごとの統計
  - タイプ別総通知数
  - タイプ別未読通知数

- 時間帯別統計
  - 時間帯別通知数（1日を24時間に分割）
  - 曜日別通知数

- 配信チャネル統計
  - アプリ内通知数
  - メール通知数

- 重要度別統計
  - 重要度レベル別通知数

#### 統計情報取得機能

- ユーザーの通知統計を取得
  - 基本統計情報
  - 既読率の計算
  - タイプ別統計
  - 時間帯別・曜日別統計
  - 配信チャネル統計
  - 重要度別統計

- 全体の通知統計情報（管理者向け）
  - 全体統計
  - タイプ別統計
  - 月別統計
  - ユーザーごとの平均値と中央値
  - 最もアクティブなユーザーと送信者
  - 重要度別統計

- 特定期間の通知統計
  - 期間内の総通知数と既読数
  - タイプ別の通知数
  - 既読率の計算
  - 日別統計情報

### 4.2 ダッシュボード用データ生成

管理者向けダッシュボードのデータを生成する機能です。

#### ダッシュボード提供情報

- ダッシュボード概要データ
  - 今日の通知数と既読率
  - 今週の通知数と既読率
  - 今月の通知数と既読率
  - 通知タイプ別の内訳
  - 前月との比較

- 週間レポート
  - 日別統計
  - 総通知数と1日平均
  - 全体の既読率
  - 最もアクティブな日
  - 最もアクティブなユーザーと送信者
  - 通知タイプ別の内訳

- ユーザーごとの通知活動レポート
  - 期間中の総通知数
  - 既読率
  - 通知タイプ別の内訳
  - 最も多い通知タイプ
  - 日別統計
  - 平均応答時間（通知の作成から既読までの平均時間）