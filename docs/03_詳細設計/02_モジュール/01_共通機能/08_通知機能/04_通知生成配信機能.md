# 通知機能 - 通知生成配信機能

## 1. 機能概要

通知生成配信機能は、さまざまな通知を生成し、適切な配信チャネルを通じてユーザーに配信することを担当します。この機能は以下の責務を持ちます：

- 業務イベントからの通知生成
- テンプレートベースの通知フォーマット
- 複数の配信チャネル（アプリ内通知、メール通知）の管理
- リアルタイム通知のためのストリーミング提供

## 2. コンポーネント構成

### 2.1 NotificationFactory

通知の生成を担当するファクトリーコンポーネントです。

#### 責務
- 通知エンティティの生成
- 通知メタデータの構築
- テンプレートからの通知生成

#### 主要メソッド

- 通知の生成
- テンプレートからの通知生成
- メタデータの構築

#### 実装の詳細

- パラメータのバリデーションを徹底的に行い、不正な通知が生成されないようにする
- テンプレートからの生成時は、必要なパラメータが欠けていないか検証する
- 通知の作成日時は自動的に設定し、既読フラグはデフォルトで未読（false）にする
- メタデータはJSON形式で扱い、シリアライズ/デシリアライズが容易な構造にする

### 2.2 NotificationEventListener

システム内の各種イベントをリッスンし、通知に変換するコンポーネントです。

#### 責務
- 業務イベントのリスニング
- イベントから通知への変換
- 通知サービスへの通知作成依頼

#### 実装のパターン

通知が必要なイベントの例：

1. **案件管理モジュール**
   - 案件登録イベント → 営業担当者への通知
   - 案件内容更新イベント → 担当者への通知
   - 案件期限接近イベント → プロジェクトマネージャーへの通知

2. **技術者管理モジュール**
   - 技術者登録イベント → 営業担当者への通知
   - 稼働状況変更イベント → リソース管理者への通知
   - スキルシート更新イベント → マッチングチームへの通知

3. **契約管理モジュール**
   - 契約書作成イベント → 承認者への通知
   - 署名完了イベント → 関係者への通知
   - 契約期限接近イベント → 担当者への通知

4. **請求・支払管理モジュール**
   - 請求書発行イベント → 承認者への通知
   - 支払期限接近イベント → 経理担当への通知
   - 入金確認イベント → 営業担当者への通知

### 2.3 DeliveryEngine

通知の配信方法を決定し、配信を実行するコンポーネントです。

#### 責務
- 配信チャネルの決定
- アプリ内通知の配信
- メール通知の送信
- テンプレートの適用

#### 主要メソッド

- 通知の配信
- 配信チャネルの決定
- アプリ内通知の配信
- メール通知の送信
- テンプレート適用

#### 実装の詳細

- ユーザーの通知設定に基づいて配信チャネルを決定する
- アプリ内通知はデータベースに保存し、WebSocketやSSEで即時配信する
- メール通知は非同期で処理し、失敗時はリトライ機構を設ける
- テンプレートエンジンにはThymeleafなどのテンプレートエンジンを使用する

### 2.4 NotificationStreamManager

リアルタイム通知のストリーミングを管理するコンポーネントです。

#### 責務
- SSEセッションの管理
- ユーザーごとの通知ストリームの提供
- 通知のリアルタイム配信

#### 主要メソッド

- ユーザーの通知ストリームを取得
- 新しい通知をストリームに発行
- アクティブなセッションを管理
- セッション統計を取得

#### 実装の詳細

- Spring WebFluxのFluxを使用したリアクティブストリーミング
- ユーザーごとにSink（データシンク）を管理
- 通知発生時に対象ユーザーのSinkにデータをプッシュ
- セッション切断時のクリーンアップ処理
- スケーラビリティのための分散イベントバス（例：Redis PubSub）の利用

## 3. 通知テンプレート管理

### 3.1 テンプレートエンジン

通知テンプレートの処理を担当するコンポーネントです。

#### 責務
- テンプレートの解析と変数置換
- テンプレートの検証
- テンプレートのキャッシュ管理

#### 主要メソッド

- テンプレート処理
- テンプレート検証
- テンプレートの必須変数を抽出
- キャッシュ管理

#### 実装の詳細

- 変数構文：`${variable}` 形式での変数参照をサポート
- 条件分岐：`#{if condition}...#{else}...#{endif}` のような条件ブロックをサポート
- ループ処理：`#{for item in items}...#{endfor}` のようなループ構文をサポート
- エスケープ処理：HTMLエスケープやJSONエスケープの自動適用
- キャッシュ：頻繁に使用されるテンプレートのパース結果をキャッシュ

### 3.2 標準テンプレート

システムに標準で組み込まれる通知テンプレートです。

#### システム通知テンプレート

```
【テンプレートキー】system_maintenance
【タイトル】システムメンテナンスのお知らせ
【本文】
${date}に${duration}時間のシステムメンテナンスを実施いたします。
メンテナンス時間中はシステムをご利用いただけません。
ご不便をおかけしますが、ご理解いただきますようお願いいたします。

■メンテナンス日時
${date} ${startTime}～${endTime}

■影響範囲
${scope}

#{if reason}
■メンテナンス理由
${reason}
#{endif}
```

#### タスク通知テンプレート

```
【テンプレートキー】task_approval_request
【タイトル】${entityType}の承認依頼があります
【本文】
${requesterName}より${entityType}「${entityName}」の承認依頼が届いています。
内容をご確認の上、承認または差し戻しをお願いいたします。

■承認期限: ${dueDate}
■リンク: ${actionUrl}

#{if comment}
■依頼者コメント
${comment}
#{endif}
```

#### アラート通知テンプレート

```
【テンプレートキー】alert_contract_expiration
【タイトル】契約期限が近づいています
【本文】
契約「${contractName}」の期限が${daysRemaining}日後に迫っています。
更新手続きが必要な場合は、早めのご対応をお願いいたします。

■契約情報
契約先: ${clientName}
契約期間: ${startDate}～${endDate}
契約担当: ${managerName}

■詳細リンク
${actionUrl}
```

#### イベント通知テンプレート

```
【テンプレートキー】event_engineer_assigned
【タイトル】技術者が案件にアサインされました
【本文】
技術者「${engineerName}」が案件「${projectName}」にアサインされました。

■アサイン情報
案件名: ${projectName}
顧客名: ${clientName}
アサイン期間: ${startDate}～${endDate}
#{if role}役割: ${role}#{endif}

■詳細リンク
${actionUrl}
```

## 4. メール通知の実装

### 4.1 メールテンプレート

メール通知で使用するHTMLテンプレート形式です。

#### 基本構造

メールテンプレートには以下の要素を含みます：
- ヘッダー部分（タイトル）
- コンテンツ部分（本文）
- アクションボタン（オプション）
- フッター部分（著作権情報など）

## 5. リアルタイム通知の実装

### 5.1 Server-Sent Events（SSE）の実装方針

SSEを使用したリアルタイム通知の実装方針：

- ユーザー認証に基づく通知ストリームの提供
- セッション管理による接続追跡
- キープアライブメッセージによる接続維持
- 通知発生時のリアルタイム配信

### 5.2 WebSocket 実装（代替方式）

双方向通信が必要な場合のWebSocket実装方針：

- セッション確立時のユーザー認証
- ユーザーごとのセッション管理
- セッション切断時のクリーンアップ
- 通知データのJSON形式での送信

## 6. 通知配信の最適化

### 6.1 バッチ処理

大量の通知を効率的に処理するためのバッチ処理機能：

- 未配信通知の定期的な処理
- 期限切れ通知のアーカイブ処理
- バッチサイズによる処理の最適化

### 6.2 優先度に基づく配信

通知の優先度に基づいて配信を管理する機能：

- 高優先度、通常優先度、低優先度の区分
- 優先度に応じた処理リソースの割り当て
- 優先度に基づく配信順序の制御