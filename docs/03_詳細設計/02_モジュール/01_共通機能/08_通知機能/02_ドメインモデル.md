# 通知機能 - ドメインモデル

## 1. エンティティ

### 1.1 通知（Notification）

通知の基本情報を管理するエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | UUID | 通知の一意識別子 | 主キー |
| type | NotificationType | 通知の種類 | NOT NULL |
| title | String | 通知のタイトル | NOT NULL, 最大100文字 |
| body | String | 通知の本文 | NOT NULL, 最大1000文字 |
| metadata | Map<String, Object> | 通知に関連するメタデータ | JSON形式 |
| sender | User | 通知の送信者 | 省略可 |
| recipient | User | 通知の受信者 | NOT NULL |
| read | boolean | 既読フラグ | NOT NULL, デフォルトfalse |
| createdAt | LocalDateTime | 作成日時 | NOT NULL |
| updatedAt | LocalDateTime | 更新日時 | 省略可 |
| expiresAt | LocalDateTime | 有効期限 | 省略可 |

#### ビジネスルール

- 通知の本文は最大1000文字までとする
- メタデータには、通知に関連する追加情報（案件ID、ドキュメントURLなど）を格納する
- システム通知（System）の場合は送信者（sender）は省略可能
- 有効期限（expiresAt）が設定されている場合、その日時を過ぎると自動的にアーカイブされる

#### 関連

- 送信者（sender）は0または1のユーザーと関連する
- 受信者（recipient）は1人のユーザーと関連する

### 1.2 通知設定（NotificationPreference）

ユーザーごとの通知設定を管理するエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | Long | 設定の一意識別子 | 主キー |
| user | User | 設定の所有ユーザー | NOT NULL |
| notificationType | NotificationType | 通知タイプ | NOT NULL |
| appEnabled | boolean | アプリ内通知の有効フラグ | NOT NULL, デフォルトtrue |
| emailEnabled | boolean | メール通知の有効フラグ | NOT NULL, デフォルトtrue |
| retentionDays | int | 保持期間（日数） | NOT NULL, デフォルト90 |

#### ビジネスルール

- ユーザーと通知タイプの組み合わせは一意とする
- 保持期間は最低7日から最大365日までの範囲とする
- アプリ内通知とメール通知の両方を無効にすることはできない

#### 関連

- 各設定は1人のユーザーと関連する

### 1.3 通知テンプレート（NotificationTemplate）

再利用可能な通知テンプレートを管理するエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | Long | テンプレートの一意識別子 | 主キー |
| templateKey | String | テンプレートのキー | NOT NULL, UNIQUE |
| titleTemplate | String | タイトルテンプレート | NOT NULL |
| bodyTemplate | String | 本文テンプレート | NOT NULL, 最大2000文字 |
| notificationType | NotificationType | 通知タイプ | NOT NULL |
| metadataTemplate | String | メタデータテンプレート | JSON形式 |
| active | boolean | 有効フラグ | NOT NULL, デフォルトtrue |

#### ビジネスルール

- テンプレートキー（templateKey）はシステム内で一意とする
- テンプレートには${variable}形式の変数を含めることができる
- メタデータテンプレートはJSON形式で保存され、変数置換がサポートされる

#### 関連

- テンプレートは複数の通知の生成に使用される

## 2. 値オブジェクト

### 2.1 通知タイプ（NotificationType）

通知の種類を表す列挙型です。

#### 値

| 値 | 説明 |
|-----|------|
| SYSTEM | システム通知（メンテナンス情報など） |
| TASK | タスク通知（承認依頼、提案依頼など） |
| ALERT | アラート通知（契約期限、支払期限など） |
| EVENT | イベント通知（案件登録、技術者アサインなど） |

### 2.2 配信チャネル（DeliveryChannel）

通知の配信方法を表す列挙型です。

#### 値

| 値 | 説明 |
|-----|------|
| APP | アプリ内通知 |
| EMAIL | メール通知 |

### 2.3 通知メタデータ（NotificationMetadata）

通知に関連する追加情報を表す値オブジェクトです。

#### 属性

様々な種類の通知にカスタマイズ可能ですが、一般的に以下の属性を含みます：

- actionUrl: 通知に関連するページのURL
- entityType: 関連エンティティの種類（案件、契約など）
- entityId: 関連エンティティのID
- importance: 重要度（high, medium, low）
- icon: 通知に表示するアイコン
- expiresAt: 通知の有効期限

## 3. ドメインサービス

### 3.1 通知サービス（NotificationService）

通知の操作を行うドメインサービスです。

#### 主要操作

- 通知の作成、取得、更新、削除
- テンプレートを使用した通知生成
- ユーザーの通知一覧取得
- 通知の既読/未読管理

### 3.2 配信サービス（DeliveryService）

通知の配信を行うドメインサービスです。

#### 主要操作

- 配信チャネルの決定
- メール通知の送信
- アプリ内通知のプッシュ
- テンプレートの適用と変数置換

### 3.3 通知設定サービス（NotificationPreferenceService）

ユーザーの通知設定を管理するドメインサービスです。

#### 主要操作

- 設定の取得と更新
- デフォルト設定の適用
- 通知タイプごとの設定管理

## 4. 集約

### 4.1 通知集約

通知（Notification）を集約ルートとし、メタデータを含みます。

### 4.2 通知設定集約

通知設定（NotificationPreference）を集約ルートとします。

### 4.3 通知テンプレート集約

通知テンプレート（NotificationTemplate）を集約ルートとします。