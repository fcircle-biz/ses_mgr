# エラー処理機能のインターフェース定義

## 1. 概要

エラー処理機能は、アプリケーション全体でのエラーハンドリングを統一し、適切なエラーレスポンスの生成、ログ記録、および例外管理を行うためのサービスを提供します。本ドキュメントでは、エラー処理機能が提供するインターフェースと、それを利用するためのAPI仕様を定義します。

## 2. 提供インターフェース一覧

| インターフェース名 | 概要 | 利用モジュール |
|-----------------|------|-------------|
| ExceptionHandlingService | 例外の集約処理と変換を提供 | 全モジュール |
| ErrorCodeRegistry | エラーコードの一元管理と参照を提供 | 全モジュール |
| ErrorResponseBuilder | エラーレスポンスの構築を提供 | Web/API層 |
| ErrorLogger | エラーログの記録と管理を提供 | 全モジュール |

## 3. 要求インターフェース一覧

| インターフェース名 | 提供モジュール | 概要 |
|-----------------|--------------|------|
| MessageSource | Spring Framework | メッセージの国際化と解決に利用 |
| LoggingService | ロギング機能 | ログの出力と管理に利用 |
| TraceIdProvider | 分散トレース機能 | トレースIDの取得に利用 |

## 4. インターフェース詳細

### 4.1 ExceptionHandlingService インターフェース

例外の捕捉と処理を一元管理するサービスインターフェースです。

```java
/**
 * 例外の捕捉と処理を一元管理するサービスインターフェース
 */
public interface ExceptionHandlingService {
    /**
     * 例外をハンドリングしてエラー情報を生成します
     * @param exception 捕捉した例外
     * @param request 現在のリクエスト情報
     * @return 生成されたエラー情報
     */
    ErrorInfo handleException(Throwable exception, RequestContext request);
    
    /**
     * 入力検証エラーをハンドリングしてエラー情報を生成します
     * @param bindingResult 入力検証結果
     * @param request 現在のリクエスト情報
     * @return 生成されたエラー情報
     */
    ErrorInfo handleValidationError(BindingResult bindingResult, RequestContext request);
    
    /**
     * アクセス拒否例外をハンドリングしてエラー情報を生成します
     * @param exception アクセス拒否例外
     * @param request 現在のリクエスト情報
     * @return 生成されたエラー情報
     */
    ErrorInfo handleAccessDeniedException(AccessDeniedException exception, RequestContext request);
    
    /**
     * 認証関連の例外をハンドリングしてエラー情報を生成します
     * @param exception 認証例外
     * @param request 現在のリクエスト情報
     * @return 生成されたエラー情報
     */
    ErrorInfo handleAuthenticationException(AuthenticationException exception, RequestContext request);
    
    /**
     * 業務例外をハンドリングしてエラー情報を生成します
     * @param exception 業務例外
     * @param request 現在のリクエスト情報
     * @return 生成されたエラー情報
     */
    ErrorInfo handleBusinessException(BusinessException exception, RequestContext request);
    
    /**
     * システム例外をハンドリングしてエラー情報を生成します
     * @param exception システム例外
     * @param request 現在のリクエスト情報
     * @return 生成されたエラー情報
     */
    ErrorInfo handleSystemException(SystemException exception, RequestContext request);
}
```

#### 内部クラス: RequestContext

```java
/**
 * リクエスト情報を保持するクラス
 */
public class RequestContext {
    private final String path;           // リクエストパス
    private final String method;         // HTTPメソッド
    private final String userAgent;      // ユーザーエージェント
    private final String clientIp;       // クライアントIP
    private final Map<String, String> headers; // リクエストヘッダー
    private final String userId;         // ユーザーID（認証済みの場合）
    private final String traceId;        // トレースID
    
    // コンストラクタ、ゲッター、ビルダー
}
```

### 4.2 ErrorCodeRegistry インターフェース

エラーコードを一元管理し、検索・参照機能を提供するインターフェースです。

```java
/**
 * エラーコードを一元管理し、検索・参照機能を提供するインターフェース
 */
public interface ErrorCodeRegistry {
    /**
     * エラーコードに対応するメッセージを取得します
     * @param code エラーコード
     * @param locale ロケール
     * @param args メッセージ引数
     * @return ローカライズされたメッセージ
     */
    String getMessage(ErrorCode code, Locale locale, Object... args);
    
    /**
     * エラーコードが所属するカテゴリを取得します
     * @param code エラーコード
     * @return エラーカテゴリ
     */
    String getCategory(ErrorCode code);
    
    /**
     * エラーコードの重大度を取得します
     * @param code エラーコード
     * @return エラー重大度
     */
    ErrorSeverity getSeverity(ErrorCode code);
    
    /**
     * エラーコードに対応するHTTPステータスコードを取得します
     * @param code エラーコード
     * @return HTTPステータスコード
     */
    HttpStatus getHttpStatus(ErrorCode code);
    
    /**
     * エラーコードがユーザーに公開可能かどうかを判定します
     * @param code エラーコード
     * @return ユーザーに公開可能な場合はtrue
     */
    boolean isPublic(ErrorCode code);
    
    /**
     * エラーコード情報をすべて取得します
     * @return エラーコード情報のリスト
     */
    List<ErrorCodeInfo> getAllErrorCodes();
    
    /**
     * カテゴリでエラーコード情報を検索します
     * @param category カテゴリ
     * @return 該当するエラーコード情報のリスト
     */
    List<ErrorCodeInfo> findByCategory(String category);
    
    /**
     * 重大度でエラーコード情報を検索します
     * @param severity 重大度
     * @return 該当するエラーコード情報のリスト
     */
    List<ErrorCodeInfo> findBySeverity(ErrorSeverity severity);
}
```

### 4.3 ErrorResponseBuilder インターフェース

エラー情報からAPIレスポンスを構築するインターフェースです。

```java
/**
 * エラー情報からAPIレスポンスを構築するインターフェース
 */
public interface ErrorResponseBuilder {
    /**
     * エラー情報からエラーレスポンスを構築します
     * @param errorInfo エラー情報
     * @param locale ロケール
     * @return エラーレスポンス
     */
    ErrorResponse buildErrorResponse(ErrorInfo errorInfo, Locale locale);
    
    /**
     * 入力検証エラー情報からバリデーションエラーレスポンスを構築します
     * @param errorInfo エラー情報
     * @param bindingResult 入力検証結果
     * @param locale ロケール
     * @return バリデーションエラーレスポンス
     */
    ValidationErrorResponse buildValidationErrorResponse(
            ErrorInfo errorInfo, BindingResult bindingResult, Locale locale);
    
    /**
     * エラー情報からHTTPレスポンスエンティティを構築します
     * @param errorInfo エラー情報
     * @param locale ロケール
     * @return HTTPレスポンスエンティティ
     */
    ResponseEntity<ErrorResponse> buildResponseEntity(ErrorInfo errorInfo, Locale locale);
    
    /**
     * エラー情報からHTTPレスポンスエンティティを構築します（バリデーションエラー用）
     * @param errorInfo エラー情報
     * @param bindingResult 入力検証結果
     * @param locale ロケール
     * @return HTTPレスポンスエンティティ
     */
    ResponseEntity<ValidationErrorResponse> buildValidationResponseEntity(
            ErrorInfo errorInfo, BindingResult bindingResult, Locale locale);
}
```

### 4.4 ErrorLogger インターフェース

エラー情報のログ記録を行うインターフェースです。

```java
/**
 * エラー情報のログ記録を行うインターフェース
 */
public interface ErrorLogger {
    /**
     * エラー情報をログに記録します
     * @param errorInfo エラー情報
     * @param exception 例外（オプション）
     */
    void logError(ErrorInfo errorInfo, Throwable exception);
    
    /**
     * 重大なエラーを記録し、通知を送信します
     * @param errorInfo エラー情報
     * @param exception 例外（オプション）
     */
    void logCriticalError(ErrorInfo errorInfo, Throwable exception);
    
    /**
     * エラー情報をデータベースに永続化します
     * @param errorInfo エラー情報
     * @param exception 例外（オプション）
     * @return 永続化されたエラーログのID
     */
    Long persistErrorLog(ErrorInfo errorInfo, Throwable exception);
    
    /**
     * 指定された条件に基づいてエラーログを検索します
     * @param criteria 検索条件
     * @return エラーログのリスト
     */
    List<ErrorLogEntity> searchErrorLogs(ErrorLogSearchCriteria criteria);
    
    /**
     * エラー統計情報を取得します
     * @param startTime 開始時刻
     * @param endTime 終了時刻
     * @return エラー統計情報
     */
    ErrorStatistics getErrorStatistics(LocalDateTime startTime, LocalDateTime endTime);
}
```

#### 内部クラス: ErrorLogSearchCriteria

```java
/**
 * エラーログの検索条件を表すクラス
 */
public class ErrorLogSearchCriteria {
    private String errorCode;             // エラーコード
    private String category;              // カテゴリ
    private String severity;              // 重大度
    private String traceId;               // トレースID
    private String userId;                // ユーザーID
    private String path;                  // リクエストパス
    private LocalDateTime startTime;      // 検索開始時刻
    private LocalDateTime endTime;        // 検索終了時刻
    private Integer maxResults;           // 最大取得件数
    private String sortBy;                // ソート項目
    private boolean ascending;            // 昇順/降順
    
    // コンストラクタ、ゲッター、セッター、ビルダー
}
```

#### 内部クラス: ErrorStatistics

```java
/**
 * エラー統計情報を表すクラス
 */
public class ErrorStatistics {
    private Map<String, Long> countByCategory;    // カテゴリ別件数
    private Map<String, Long> countBySeverity;    // 重大度別件数
    private Map<String, Long> countByErrorCode;   // エラーコード別件数
    private Map<String, Long> countByPath;        // パス別件数
    private Long totalCount;                      // 合計件数
    private LocalDateTime periodStart;            // 集計期間開始
    private LocalDateTime periodEnd;              // 集計期間終了
    
    // コンストラクタ、ゲッター
}
```

## 5. グローバル例外ハンドラー

Spring MVCの`@ControllerAdvice`を利用したグローバル例外ハンドラーの実装例です。

```java
/**
 * グローバル例外ハンドラー
 */
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    private final ExceptionHandlingService exceptionHandlingService;
    private final ErrorResponseBuilder errorResponseBuilder;
    private final ErrorLogger errorLogger;
    
    @Autowired
    public GlobalExceptionHandler(
            ExceptionHandlingService exceptionHandlingService,
            ErrorResponseBuilder errorResponseBuilder,
            ErrorLogger errorLogger) {
        this.exceptionHandlingService = exceptionHandlingService;
        this.errorResponseBuilder = errorResponseBuilder;
        this.errorLogger = errorLogger;
    }
    
    /**
     * 入力検証例外のハンドリング
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ValidationErrorResponse> handleValidationExceptions(
            MethodArgumentNotValidException ex, 
            WebRequest request, 
            Locale locale) {
        
        RequestContext context = createRequestContext(request);
        ErrorInfo errorInfo = exceptionHandlingService.handleValidationError(
                ex.getBindingResult(), context);
        
        errorLogger.logError(errorInfo, ex);
        
        return errorResponseBuilder.buildValidationResponseEntity(
                errorInfo, ex.getBindingResult(), locale);
    }
    
    /**
     * 業務例外のハンドリング
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(
            BusinessException ex, 
            WebRequest request, 
            Locale locale) {
        
        RequestContext context = createRequestContext(request);
        ErrorInfo errorInfo = exceptionHandlingService.handleBusinessException(ex, context);
        
        errorLogger.logError(errorInfo, ex);
        
        return errorResponseBuilder.buildResponseEntity(errorInfo, locale);
    }
    
    /**
     * システム例外のハンドリング
     */
    @ExceptionHandler(SystemException.class)
    public ResponseEntity<ErrorResponse> handleSystemException(
            SystemException ex, 
            WebRequest request, 
            Locale locale) {
        
        RequestContext context = createRequestContext(request);
        ErrorInfo errorInfo = exceptionHandlingService.handleSystemException(ex, context);
        
        errorLogger.logCriticalError(errorInfo, ex);
        
        return errorResponseBuilder.buildResponseEntity(errorInfo, locale);
    }
    
    /**
     * 認証例外のハンドリング
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ErrorResponse> handleAuthenticationException(
            AuthenticationException ex, 
            WebRequest request, 
            Locale locale) {
        
        RequestContext context = createRequestContext(request);
        ErrorInfo errorInfo = exceptionHandlingService.handleAuthenticationException(ex, context);
        
        errorLogger.logError(errorInfo, ex);
        
        return errorResponseBuilder.buildResponseEntity(errorInfo, locale);
    }
    
    /**
     * アクセス拒否例外のハンドリング
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ErrorResponse> handleAccessDeniedException(
            AccessDeniedException ex, 
            WebRequest request, 
            Locale locale) {
        
        RequestContext context = createRequestContext(request);
        ErrorInfo errorInfo = exceptionHandlingService.handleAccessDeniedException(ex, context);
        
        errorLogger.logError(errorInfo, ex);
        
        return errorResponseBuilder.buildResponseEntity(errorInfo, locale);
    }
    
    /**
     * 未処理の例外のハンドリング
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleUnknownException(
            Exception ex, 
            WebRequest request, 
            Locale locale) {
        
        RequestContext context = createRequestContext(request);
        ErrorInfo errorInfo = exceptionHandlingService.handleException(ex, context);
        
        errorLogger.logCriticalError(errorInfo, ex);
        
        return errorResponseBuilder.buildResponseEntity(errorInfo, locale);
    }
    
    /**
     * WebRequestからRequestContextを作成するヘルパーメソッド
     */
    private RequestContext createRequestContext(WebRequest webRequest) {
        // WebRequestから必要な情報を抽出してRequestContextを作成
        // 実装省略
        return new RequestContext.Builder()
                .path(getPath(webRequest))
                .method(getMethod(webRequest))
                .userAgent(getUserAgent(webRequest))
                .clientIp(getClientIp(webRequest))
                .headers(getHeaders(webRequest))
                .userId(getUserId(webRequest))
                .traceId(getTraceId(webRequest))
                .build();
    }
    
    // RequestContext作成のためのヘルパーメソッド（実装省略）
    private String getPath(WebRequest request) { /* 実装省略 */ return ""; }
    private String getMethod(WebRequest request) { /* 実装省略 */ return ""; }
    private String getUserAgent(WebRequest request) { /* 実装省略 */ return ""; }
    private String getClientIp(WebRequest request) { /* 実装省略 */ return ""; }
    private Map<String, String> getHeaders(WebRequest request) { /* 実装省略 */ return new HashMap<>(); }
    private String getUserId(WebRequest request) { /* 実装省略 */ return ""; }
    private String getTraceId(WebRequest request) { /* 実装省略 */ return ""; }
}
```

## 6. 機能の利用方法

### 6.1 例外スローによるエラー処理の例

業務ロジック内で適切な例外をスローする例です。

```java
@Service
public class EngineerServiceImpl implements EngineerService {
    
    @Autowired
    private EngineerRepository engineerRepository;
    
    @Override
    public Engineer findEngineerById(UUID engineerId) {
        return engineerRepository.findById(engineerId)
                .orElseThrow(() -> new ResourceNotFoundException(
                        "engineer", 
                        engineerId, 
                        ErrorCode.ENGINEER_NOT_FOUND));
    }
    
    @Override
    public Engineer createEngineer(EngineerCreateRequest request) {
        // 重複チェック
        if (engineerRepository.existsByEmail(request.getEmail())) {
            throw new DuplicateResourceException(
                    "engineer", 
                    request.getEmail(), 
                    ErrorCode.DUPLICATE_ENGINEER,
                    Map.of("email", request.getEmail()));
        }
        
        // 業務ルールチェック
        if (!isValidEngineerData(request)) {
            throw new BusinessRuleViolationException(
                    "ENGINEER_RULE_001",
                    ErrorCode.INVALID_ENGINEER_DATA,
                    Map.of("request", request));
        }
        
        // 以下、正常処理
        Engineer engineer = new Engineer();
        // ...
        return engineerRepository.save(engineer);
    }
    
    private boolean isValidEngineerData(EngineerCreateRequest request) {
        // 業務ルールに基づく検証ロジック
        return true;
    }
}
```

### 6.2 コントローラーでのバリデーションの例

コントローラーでの入力バリデーション設定例です。

```java
@RestController
@RequestMapping("/api/v1/engineers")
public class EngineerController {
    
    @Autowired
    private EngineerService engineerService;
    
    @PostMapping
    public ResponseEntity<EngineerResponse> createEngineer(
            @Valid @RequestBody EngineerCreateRequest request) {
        Engineer engineer = engineerService.createEngineer(request);
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(EngineerResponse.from(engineer));
    }
    
    @GetMapping("/{engineerId}")
    public ResponseEntity<EngineerResponse> getEngineer(
            @PathVariable UUID engineerId) {
        Engineer engineer = engineerService.findEngineerById(engineerId);
        return ResponseEntity.ok(EngineerResponse.from(engineer));
    }
}
```

### 6.3 リクエストDTOのバリデーション設定例

```java
public class EngineerCreateRequest {
    
    @NotBlank(message = "名前は必須です")
    private String name;
    
    @NotBlank(message = "メールアドレスは必須です")
    @Email(message = "有効なメールアドレスを入力してください")
    private String email;
    
    @NotBlank(message = "電話番号は必須です")
    @Pattern(regexp = "^\\d{10,11}$", message = "有効な電話番号を入力してください")
    private String phoneNumber;
    
    @NotNull(message = "スキルセットは必須です")
    @Size(min = 1, message = "1つ以上のスキルを設定してください")
    private List<SkillRequest> skills;
    
    // ゲッター、セッター
}
```

## 7. シーケンス図

### 7.1 バリデーションエラー処理シーケンス

```
Client                Controller               GlobalExceptionHandler    ExceptionHandlingService    ErrorResponseBuilder    ErrorLogger
  |                       |                              |                        |                        |                   |
  | POST /api/engineers   |                              |                        |                        |                   |
  |---------------------->|                              |                        |                        |                   |
  |                       |                              |                        |                        |                   |
  |                       | @Valid validation fails      |                        |                        |                   |
  |                       |------------------------------>|                        |                        |                   |
  |                       |                              |                        |                        |                   |
  |                       |                              | handleValidationExceptions                      |                   |
  |                       |                              |------------------------>|                        |                   |
  |                       |                              |                        | handleValidationError  |                   |
  |                       |                              |                        |------------------------>|                   |
  |                       |                              |                        |                        | logError          |
  |                       |                              |                        |                        |------------------>|
  |                       |                              |                        |                        |                   |
  |                       |                              |                        | return ErrorInfo       |                   |
  |                       |                              |<------------------------|                        |                   |
  |                       |                              |                        |                        |                   |
  |                       |                              | buildValidationResponseEntity                   |                   |
  |                       |                              |------------------------------------------------>|                   |
  |                       |                              |                        |                        |                   |
  |                       |                              |                       return ResponseEntity      |                   |
  |                       |                              |<------------------------------------------------|                   |
  |                       |                              |                        |                        |                   |
  | HTTP 400 Bad Request  |                              |                        |                        |                   |
  |<----------------------|<-----------------------------|                        |                        |                   |
  |                       |                              |                        |                        |                   |
```

### 7.2 業務例外処理シーケンス

```
Client                Controller               EngineerService           GlobalExceptionHandler    ExceptionHandlingService    ErrorResponseBuilder    ErrorLogger
  |                       |                              |                        |                        |                   |
  | GET /api/engineers/123|                              |                        |                        |                   |
  |---------------------->|                              |                        |                        |                   |
  |                       |                              |                        |                        |                   |
  |                       | findEngineerById(123)        |                        |                        |                   |
  |                       |----------------------------->|                        |                        |                   |
  |                       |                              |                        |                        |                   |
  |                       |                              | throw ResourceNotFoundException                 |                   |
  |                       |                              |------------------------>|                        |                   |
  |                       |                              |                        |                        |                   |
  |                       |                              |                        | handleBusinessException |                   |
  |                       |                              |                        |------------------------>|                   |
  |                       |                              |                        |                        | logError          |
  |                       |                              |                        |                        |------------------>|
  |                       |                              |                        |                        |                   |
  |                       |                              |                        | return ErrorInfo       |                   |
  |                       |                              |                        |<------------------------|                   |
  |                       |                              |                        |                        |                   |
  |                       |                              |                        | buildResponseEntity    |                   |
  |                       |                              |                        |------------------------>|                   |
  |                       |                              |                        |                        |                   |
  |                       |                              |                       return ResponseEntity      |                   |
  |                       |                              |                        |<------------------------|                   |
  |                       |                              |                        |                        |                   |
  | HTTP 404 Not Found    |                              |                        |                        |                   |
  |<----------------------|<-----------------------------|<-----------------------|                        |                   |
  |                       |                              |                        |                        |                   |
```

## 8. API仕様

### 8.1 エラーレスポンスフォーマット

標準的なエラーレスポンスの例です。

```json
{
  "code": "E10001",
  "message": "認証に失敗しました",
  "traceId": "abc123xyz456",
  "timestamp": "2025-05-14T10:15:30.123Z",
  "path": "/api/v1/auth/login"
}
```

### 8.2 バリデーションエラーレスポンスフォーマット

入力検証エラーレスポンスの例です。

```json
{
  "code": "E11001",
  "message": "入力内容にエラーがあります",
  "traceId": "abc123xyz456",
  "timestamp": "2025-05-14T10:15:30.123Z",
  "path": "/api/v1/engineers",
  "fieldErrors": [
    {
      "field": "email",
      "message": "有効なメールアドレスを入力してください",
      "code": "Email",
      "rejectedValue": "invalid-email"
    },
    {
      "field": "phoneNumber",
      "message": "有効な電話番号を入力してください",
      "code": "Pattern",
      "rejectedValue": "123"
    }
  ]
}
```

## 9. 設定パラメータ

エラー処理機能で利用可能な主な設定パラメータです。

| パラメータ名 | 説明 | デフォルト値 |
|--------------|------|-------------|
| app.error.include-stacktrace | スタックトレースを含めるかどうか | never (本番), always (開発) |
| app.error.include-debug-details | デバッグ詳細を含めるかどうか | false (本番), true (開発) |
| app.error.log-level | エラーログレベル | ERROR |
| app.error.critical-log-level | 重大エラーログレベル | ERROR |
| app.error.notification.enabled | エラー通知の有効化 | true |
| app.error.notification.threshold | 通知するエラーの閾値（重大度） | ERROR |

## 10. 後方互換性と拡張性

### 10.1 エラーコードの拡張方法

新しいエラーコードを追加する際は以下の手順で行います。

1. `ErrorCode` 列挙型に新しいエラーコードを定義
2. 対応するメッセージを各言語のプロパティファイルに追加
3. エラーコードのカテゴリと重大度を設定

### 10.2 例外クラスの拡張方法

新しい例外クラスを追加する際は以下の手順で行います。

1. 適切な基底例外クラスを継承した例外クラスを定義
2. 例外クラスに必要な情報を保持するフィールドを追加
3. `ExceptionHandlingService` に対応するハンドラーメソッドを追加
4. `GlobalExceptionHandler` に対応する例外ハンドリングメソッドを追加

## 11. まとめ

エラー処理機能は以下のインターフェースを提供します：

1. **ExceptionHandlingService**: 例外の捕捉と変換処理
2. **ErrorCodeRegistry**: エラーコードの管理と参照
3. **ErrorResponseBuilder**: エラーレスポンスの構築
4. **ErrorLogger**: エラー情報のログ記録と管理

これらのインターフェースを活用することで、アプリケーション全体での一貫したエラー処理、適切なエラーレスポンスの生成、効果的なエラーログ記録が実現できます。