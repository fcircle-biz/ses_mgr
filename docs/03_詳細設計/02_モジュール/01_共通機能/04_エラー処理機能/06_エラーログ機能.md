# エラーログ機能

## 1. 目的と概要

エラーログ機能は、システム内で発生したエラー情報を一元的に記録・管理し、効率的なトラブルシューティングを可能にする基盤を提供します。本機能により、発生したエラーの詳細な情報を構造化された形式で保存し、分析や監視を容易にします。

主な目的は以下の通りです：

- エラー情報の一元的かつ構造化された記録
- エラーの傾向分析と早期検知のためのデータ提供
- トラブルシューティングの効率化
- システム品質向上のための基礎データ収集
- 運用監視との連携による問題の早期発見

## 2. 機能要件

### 2.1 エラーログ記録

- 各種エラー（業務例外、システム例外、認証例外など）の詳細情報記録
- エラーコード、メッセージ、発生時刻、リクエストパス、トレースIDなどの基本情報記録
- コンテキスト情報（ユーザーID、セッションID、リクエストパラメータなど）の記録
- 環境に応じたログ詳細度の制御（本番環境では機密情報を除外するなど）
- エラー重大度（INFO, WARNING, ERROR, CRITICAL）に応じた記録レベルの分け

### 2.2 エラーログ検索・参照

- エラーコード、カテゴリ、時間範囲、ユーザーIDなどによるログ検索
- トレースIDを用いた関連するエラーの横断的検索
- エラーログの詳細表示と関連情報の参照
- 時系列でのエラー発生状況の可視化

### 2.3 エラー統計・分析

- エラーカテゴリ別、コード別、重大度別の発生数集計
- 時間帯別のエラー発生傾向分析
- 特定のエラーの発生頻度監視
- エラー発生の相関関係分析（特定の操作と関連するエラーなど）

### 2.4 通知連携

- 重大エラー発生時の自動通知（メール、Slack、社内チャットツールなど）
- エラー発生頻度の閾値超過時の通知
- 通知ルールのカスタマイズ（通知するエラータイプ、閾値設定など）

## 3. アーキテクチャ設計

### 3.1 モジュール構成

エラーログ機能は以下のコンポーネントで構成されます：

```
                +------------------+
                |                  |
                | ErrorLogger API  |
                |                  |
                +--------+---------+
                         |
         +---------------+---------------+
         |                               |
+--------v---------+           +---------v--------+
|                  |           |                  |
| Log Persistence  |           | Log Formatter    |
|                  |           |                  |
+--------+---------+           +---------+--------+
         |                               |
+--------v---------+           +---------v--------+
|                  |           |                  |
| Log Repository   |           | Notification     |
|                  |           | Service          |
+------------------+           +------------------+
```

- **ErrorLogger API**: エラーログ機能の公開インターフェース
- **Log Formatter**: エラー情報を構造化されたログ形式に変換
- **Log Persistence**: エラーログの永続化を担当
- **Log Repository**: エラーログの検索・参照機能を提供
- **Notification Service**: 通知連携を担当

### 3.2 データモデル

エラーログエンティティの主な属性：

| 属性名 | 型 | 説明 |
|--------|-----|------|
| id | Long | エラーログID |
| errorCode | String | エラーコード |
| message | String | エラーメッセージ |
| detail | String | 詳細情報 |
| traceId | String | 分散トレースID |
| requestId | String | リクエストID |
| userId | String | ユーザーID |
| path | String | リクエストパス |
| method | String | HTTPメソッド |
| category | String | エラーカテゴリ |
| severity | String | エラー重大度 |
| stackTrace | String | スタックトレース（開発環境のみ） |
| additionalData | JSON | 追加コンテキスト情報 |
| createdAt | DateTime | エラー発生時刻 |

### 3.3 フロー設計

#### エラーログ記録フロー

1. エラーハンドラーがエラーを検知
2. ErrorLoggerサービスにエラー情報を渡す
3. エラー情報をログ形式に変換
4. ログストレージに永続化
5. 重大度に応じて通知サービスに連携

```
+----------------+     +-----------------+     +-----------------+
| Error Handler  |---->| ErrorLogger     |---->| Log Formatter   |
+----------------+     +-----------------+     +-----------------+
                                |                      |
                                v                      v
                       +------------------+    +------------------+
                       | Log Persistence  |    | Log Appender     |
                       +------------------+    +------------------+
                                |                      |
                                v                      v
                       +------------------+    +------------------+
                       | Database         |    | Log Files        |
                       +------------------+    +------------------+
```

## 4. インターフェース設計

### 4.1 ErrorLogger インターフェース

エラー情報をログに記録するための主要インターフェースです。

主要メソッド：
- logError: 通常のエラー情報をログに記録
- logCriticalError: 重大なエラーを記録し、通知を送信
- persistErrorLog: エラー情報をデータベースに永続化
- searchErrorLogs: 指定条件に基づくエラーログの検索
- getErrorStatistics: エラー統計情報の取得

### 4.2 ErrorLogSearchCriteria クラス

エラーログ検索条件を表現するクラスです。

主要属性：
- errorCode: エラーコード
- category: カテゴリ
- severity: 重大度
- traceId: トレースID
- userId: ユーザーID
- path: リクエストパス
- startTime/endTime: 検索期間
- maxResults: 最大取得件数
- sortBy/ascending: ソート条件

### 4.3 ErrorStatistics クラス

エラー統計情報を表現するクラスです。

主要属性：
- countByCategory: カテゴリ別件数
- countBySeverity: 重大度別件数
- countByErrorCode: エラーコード別件数
- countByPath: パス別件数
- totalCount: 合計件数
- periodStart/periodEnd: 集計期間

## 5. ログフォーマット設計

### 5.1 JSON形式ログ

エラーログはJSON形式で記録され、以下の構造を持ちます：

```json
{
  "timestamp": "2025-05-14T10:15:30.123Z",
  "level": "ERROR",
  "thread": "http-nio-8080-exec-1",
  "logger": "com.example.errorhandling.ExceptionHandlerAdvice",
  "message": "Request processing failed",
  "error": {
    "code": "E10001",
    "type": "AuthenticationException",
    "message": "Authentication failed",
    "path": "/api/v1/auth/login",
    "traceId": "4f8d3e2c1a0b9876",
    "userId": "user123",
    "data": {
      "requestId": "req-456",
      "clientIp": "192.168.1.100"
    }
  },
  "request": {
    "method": "POST",
    "path": "/api/v1/auth/login",
    "remoteAddr": "192.168.1.100",
    "userAgent": "Mozilla/5.0 ..."
  }
}
```

### 5.2 環境別ログレベル設定

環境に応じたログレベル設定：

| 環境 | エラーログレベル | スタックトレース | 詳細情報 | 通知 |
|------|--------------|--------------|----------|------|
| 開発 | DEBUG以上 | 含む | 全て含む | 重大なエラーのみ |
| テスト | INFO以上 | 含む | 全て含む | 重大なエラーのみ |
| ステージング | INFO以上 | 含む | 機密情報除外 | 全エラー |
| 本番 | WARN以上 | 含まない | 機密情報除外 | 全エラー |

## 6. セキュリティ設計

### 6.1 機密情報の取り扱い

エラーログに含めるべきでない機密情報：

- パスワードやトークンなどの認証情報
- クレジットカード番号、銀行口座情報などの金融情報
- 個人を特定可能な情報（氏名、住所、電話番号など）
- セッション識別子やセキュリティトークン

### 6.2 ログのマスキング処理

機密情報をマスキングする方針：

- 正規表現に基づく自動マスキング
- 特定パラメータ名に対するマスキング（password, token, secretなど）
- マスキングパターンの設定ファイルによる管理

### 6.3 アクセス制御

エラーログへのアクセス制御：

- エラーログ参照画面への権限設定
- ログの詳細情報へのアクセス制限
- スタックトレースなど技術的詳細情報の表示制限

## 7. 運用設計

### 7.1 ログローテーション

- 日次でのログファイルローテーション
- 古いログの圧縮アーカイブ
- 保存期間に基づく自動削除（30日間など）

### 7.2 監視連携

- 重大エラーの発生時のアラート設定
- エラー発生率の監視（一定期間内のエラー数増加検知）
- 特定エラーコードの監視（セキュリティ関連エラーなど）

### 7.3 バックアップ

- エラーログデータベースの定期バックアップ
- バックアップの自動検証
- リカバリ手順の整備

## 8. パフォーマンス設計

### 8.1 非同期ログ処理

- リクエスト処理のパフォーマンスに影響を与えないよう、エラーログ記録を非同期処理
- 専用スレッドプールによるログ処理
- バッファリングによるI/O効率の向上

### 8.2 インデックス設計

エラーログデータベースのインデックス設計：

| インデックス名 | カラム | 目的 |
|--------------|-------|------|
| idx_error_log_code | error_code | エラーコードによる検索 |
| idx_error_log_category | category | カテゴリによる検索 |
| idx_error_log_created_at | created_at | 時間範囲による検索 |
| idx_error_log_trace_id | trace_id | トレースIDによる検索 |
| idx_error_log_user_id | user_id | ユーザーIDによる検索 |
| idx_error_log_path | path | パスによる検索 |

### 8.3 クエリ最適化

- 大量データに対する効率的なクエリ設計
- ページング処理の実装
- 集計クエリのキャッシュ

## 9. 拡張性設計

### 9.1 カスタムハンドラー

- プラグイン形式でのカスタムエラーハンドラー追加
- 業務ドメイン固有のエラー処理拡張機能

### 9.2 外部システム連携

- 外部ログ分析システムとの連携
- SIEM（セキュリティ情報イベント管理）システムとの統合
- エラー分析ダッシュボードとの連携

## 10. まとめ

エラーログ機能は、システム全体で発生するエラーを一元的に記録・管理し、効率的なトラブルシューティングと問題解決をサポートします。構造化されたログフォーマット、柔軟な検索機能、統計分析機能を提供することで、システムの安定運用と品質向上に貢献します。また、セキュリティやパフォーマンスに配慮した設計により、本番環境での信頼性の高い運用を実現します。