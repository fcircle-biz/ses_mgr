# エラー処理機能のドメインモデル

## 1. ドメインモデルの概要

エラー処理機能のドメインモデルは、システム内で発生する様々なエラーと例外を統一的に表現し、処理するための概念モデルを定義します。このモデルにより、エラー情報の一貫した表現、分類、操作が可能となり、エラー処理の標準化と品質向上を実現します。

## 2. 主要なドメインオブジェクト

### 2.1 エラー情報（ErrorInfo）

エラーの基本情報を表すドメインオブジェクトです。

```java
public class ErrorInfo {
    private String code;              // エラーコード
    private ErrorSeverity severity;   // エラーの重大度
    private String message;           // エラーメッセージ
    private String detail;            // 詳細情報
    private Map<String, Object> data; // 付加情報
    private String traceId;           // トレースID
    private LocalDateTime timestamp;  // 発生時刻
    
    // コンストラクタ、ゲッター、セッター
}
```

### 2.2 エラーカテゴリ（ErrorCategory）

エラーの分類を表す列挙型です。

```java
public enum ErrorCategory {
    VALIDATION("validation", "入力検証エラー"),
    BUSINESS("business", "業務ロジックエラー"),
    SYSTEM("system", "システムエラー"),
    SECURITY("security", "セキュリティエラー"),
    INTEGRATION("integration", "外部連携エラー"),
    DATABASE("database", "データベースエラー"),
    UNKNOWN("unknown", "不明なエラー");
    
    private final String code;
    private final String description;
    
    // コンストラクタ、ゲッター
}
```

### 2.3 エラー重大度（ErrorSeverity）

エラーの重大度を表す列挙型です。

```java
public enum ErrorSeverity {
    INFO("info", "情報"),
    WARNING("warning", "警告"),
    ERROR("error", "エラー"),
    CRITICAL("critical", "致命的");
    
    private final String code;
    private final String description;
    
    // コンストラクタ、ゲッター
}
```

### 2.4 エラーコード（ErrorCode）

システム内で発生するエラーを一意に識別するエラーコードを定義します。

```java
public enum ErrorCode {
    // 認証・認可エラー (10000-10999)
    AUTHENTICATION_FAILED(10001, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.UNAUTHORIZED),
    INVALID_CREDENTIALS(10002, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.UNAUTHORIZED),
    TOKEN_EXPIRED(10003, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.UNAUTHORIZED),
    INSUFFICIENT_PERMISSIONS(10004, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.FORBIDDEN),
    
    // バリデーションエラー (11000-11999)
    VALIDATION_ERROR(11001, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.BAD_REQUEST),
    INVALID_PARAMETER(11002, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.BAD_REQUEST),
    MISSING_REQUIRED_FIELD(11003, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.BAD_REQUEST),
    
    // 業務ロジックエラー (20000-29999)
    // - 技術者管理 (20000-20999)
    ENGINEER_NOT_FOUND(20001, ErrorCategory.BUSINESS, ErrorSeverity.WARNING, HttpStatus.NOT_FOUND),
    DUPLICATE_ENGINEER(20002, ErrorCategory.BUSINESS, ErrorSeverity.WARNING, HttpStatus.CONFLICT),
    
    // 他のビジネスエラーコード...
    
    // システムエラー (90000-99999)
    INTERNAL_SERVER_ERROR(90001, ErrorCategory.SYSTEM, ErrorSeverity.ERROR, HttpStatus.INTERNAL_SERVER_ERROR),
    DATABASE_ERROR(90002, ErrorCategory.DATABASE, ErrorSeverity.ERROR, HttpStatus.INTERNAL_SERVER_ERROR),
    EXTERNAL_SERVICE_ERROR(90003, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.SERVICE_UNAVAILABLE),
    UNEXPECTED_ERROR(99999, ErrorCategory.UNKNOWN, ErrorSeverity.CRITICAL, HttpStatus.INTERNAL_SERVER_ERROR);
    
    private final int code;
    private final ErrorCategory category;
    private final ErrorSeverity severity;
    private final HttpStatus httpStatus;
    
    // コンストラクタ、ゲッター
    
    public String getFullCode() {
        return "E" + code;
    }
}
```

### 2.5 APIエラーレスポンス（ErrorResponse）

APIのクライアントに返却するエラーレスポンスを表すドメインオブジェクトです。

```java
public class ErrorResponse {
    private String code;              // エラーコード
    private String message;           // ユーザー向けメッセージ
    private String detail;            // 詳細情報（開発環境のみ）
    private String traceId;           // トレースID
    private String timestamp;         // 発生時刻（ISO 8601形式）
    private String path;              // エラーが発生したパス
    private Map<String, Object> data; // 付加情報
    
    // コンストラクタ、ゲッター、ビルダーパターン実装
    
    public static final class Builder {
        // ビルダーパターンの実装
    }
}
```

### 2.6 バリデーションエラーレスポンス（ValidationErrorResponse）

入力検証エラーに特化したレスポンスを表すドメインオブジェクトです。

```java
public class ValidationErrorResponse extends ErrorResponse {
    private List<FieldError> fieldErrors;  // フィールド単位のエラー情報
    
    // コンストラクタ、ゲッター、ビルダーパターン実装
    
    public static final class Builder extends ErrorResponse.Builder {
        // ビルダーパターンの実装
    }
}

public class FieldError {
    private String field;           // エラーが発生したフィールド名
    private String message;         // エラーメッセージ
    private String code;            // エラーコード
    private Object rejectedValue;   // 拒否された値
    
    // コンストラクタ、ゲッター
}
```

## 3. 例外クラス階層

### 3.1 基本例外クラス

アプリケーション全体で使用する基本例外クラスを定義します。

```java
/**
 * アプリケーション全体の基本例外クラス
 */
public abstract class ApplicationException extends RuntimeException {
    private final ErrorCode errorCode;
    private final Map<String, Object> data;
    
    // コンストラクタ、ゲッター
}
```

### 3.2 業務例外

業務ロジックで発生する例外を表すクラスです。

```java
/**
 * 業務ロジックで発生する例外の基底クラス
 */
public class BusinessException extends ApplicationException {
    // コンストラクタ
}

/**
 * リソースが見つからない場合の例外
 */
public class ResourceNotFoundException extends BusinessException {
    private final String resourceType;
    private final Object resourceId;
    
    // コンストラクタ、ゲッター
}

/**
 * 重複データが存在する場合の例外
 */
public class DuplicateResourceException extends BusinessException {
    private final String resourceType;
    private final Object resourceId;
    
    // コンストラクタ、ゲッター
}

/**
 * 業務ルール違反の例外
 */
public class BusinessRuleViolationException extends BusinessException {
    private final String ruleId;
    
    // コンストラクタ、ゲッター
}
```

### 3.3 システム例外

システム内部で発生する例外を表すクラスです。

```java
/**
 * システム内部で発生する例外の基底クラス
 */
public class SystemException extends ApplicationException {
    // コンストラクタ
}

/**
 * データベース操作に関する例外
 */
public class DatabaseException extends SystemException {
    private final String operationType;
    private final String tableName;
    
    // コンストラクタ、ゲッター
}

/**
 * 外部サービス連携に関する例外
 */
public class IntegrationException extends SystemException {
    private final String serviceName;
    private final String operationType;
    
    // コンストラクタ、ゲッター
}

/**
 * 設定不足や不正に関する例外
 */
public class ConfigurationException extends SystemException {
    private final String configName;
    
    // コンストラクタ、ゲッター
}
```

### 3.4 セキュリティ例外

認証・認可に関する例外を表すクラスです。

```java
/**
 * セキュリティに関する例外の基底クラス
 */
public class SecurityException extends ApplicationException {
    // コンストラクタ
}

/**
 * 認証に失敗した場合の例外
 */
public class AuthenticationException extends SecurityException {
    // コンストラクタ
}

/**
 * 権限不足の場合の例外
 */
public class AuthorizationException extends SecurityException {
    private final List<String> requiredPermissions;
    
    // コンストラクタ、ゲッター
}

/**
 * トークンの有効期限切れの例外
 */
public class TokenExpiredException extends SecurityException {
    private final String tokenType;
    
    // コンストラクタ、ゲッター
}
```

## 4. 値オブジェクト

### 4.1 エラーコード情報（ErrorCodeInfo）

エラーコードに関する詳細情報を保持する値オブジェクトです。

```java
public class ErrorCodeInfo {
    private final ErrorCode code;
    private final String category;
    private final ErrorSeverity severity;
    private final HttpStatus httpStatus;
    private final boolean isPublic;  // ユーザーに公開可能かどうか
    
    // コンストラクタ、ゲッター
    
    public boolean isUserVisible() {
        return isPublic;
    }
}
```

### 4.2 エラーコンテキスト（ErrorContext）

エラーが発生した際のコンテキスト情報を保持する値オブジェクトです。

```java
public class ErrorContext {
    private final String requestId;
    private final String traceId;
    private final String userId;
    private final String requestPath;
    private final String requestMethod;
    private final LocalDateTime timestamp;
    private final Map<String, Object> attributes;
    
    // コンストラクタ、ゲッター、ビルダーパターン実装
    
    public static final class Builder {
        // ビルダーパターンの実装
    }
}
```

## 5. エンティティとリポジトリ

### 5.1 エラーログエンティティ（ErrorLogEntity）

エラーログデータを表すエンティティです。

```java
@Entity
@Table(name = "error_logs")
public class ErrorLogEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "error_code", nullable = false)
    private String errorCode;
    
    @Column(name = "message", nullable = false)
    private String message;
    
    @Column(name = "detail", columnDefinition = "TEXT")
    private String detail;
    
    @Column(name = "trace_id")
    private String traceId;
    
    @Column(name = "request_id")
    private String requestId;
    
    @Column(name = "user_id")
    private String userId;
    
    @Column(name = "path")
    private String path;
    
    @Column(name = "method")
    private String method;
    
    @Column(name = "category", nullable = false)
    private String category;
    
    @Column(name = "severity", nullable = false)
    private String severity;
    
    @Column(name = "stack_trace", columnDefinition = "TEXT")
    private String stackTrace;
    
    @Column(name = "additional_data", columnDefinition = "JSON")
    private String additionalData;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    // コンストラクタ、ゲッター、セッター
}
```

### 5.2 エラーログリポジトリ（ErrorLogRepository）

エラーログの永続化と検索を行うリポジトリのインターフェースです。

```java
public interface ErrorLogRepository extends JpaRepository<ErrorLogEntity, Long> {
    List<ErrorLogEntity> findByErrorCode(String errorCode);
    
    List<ErrorLogEntity> findByCategory(String category);
    
    List<ErrorLogEntity> findBySeverity(String severity);
    
    List<ErrorLogEntity> findByCreatedAtBetween(LocalDateTime startTime, LocalDateTime endTime);
    
    List<ErrorLogEntity> findByTraceId(String traceId);
    
    List<ErrorLogEntity> findByUserId(String userId);
    
    @Query("SELECT e FROM ErrorLogEntity e WHERE e.path LIKE %:pathPattern%")
    List<ErrorLogEntity> findByPathPattern(String pathPattern);
    
    @Query(value = "SELECT category, COUNT(*) as count FROM error_logs " +
            "WHERE created_at BETWEEN :startTime AND :endTime " +
            "GROUP BY category", nativeQuery = true)
    List<Object[]> countByCategory(LocalDateTime startTime, LocalDateTime endTime);
    
    @Query(value = "SELECT severity, COUNT(*) as count FROM error_logs " +
            "WHERE created_at BETWEEN :startTime AND :endTime " +
            "GROUP BY severity", nativeQuery = true)
    List<Object[]> countBySeverity(LocalDateTime startTime, LocalDateTime endTime);
}
```

## 6. ドメインモデル図

```
+-------------------+      +-------------------+      +-------------------+
|   ErrorInfo       |      |   ErrorCode       |      |  ErrorResponse    |
+-------------------+      +-------------------+      +-------------------+
| - code            |<-----| - code            |----->| - code            |
| - severity        |      | - category        |      | - message         |
| - message         |      | - severity        |      | - detail          |
| - detail          |      | - httpStatus      |      | - traceId         |
| - data            |      |                   |      | - timestamp       |
| - traceId         |      +-------------------+      | - path            |
| - timestamp       |                                 | - data            |
+-------------------+                                 +-------------------+
        ^                                                     ^
        |                                                     |
        |                                                     |
+-------------------+                                 +-------------------+
| ApplicationException                               | ValidationErrorResponse
+-------------------+                                 +-------------------+
| - errorCode       |                                 | - fieldErrors     |
| - data            |                                 |                   |
+-------------------+                                 +-------------------+
        ^
        |
        +-----------------+---------------------+
        |                 |                     |
+-------------------+ +-------------------+ +-------------------+
| BusinessException | | SystemException   | | SecurityException |
+-------------------+ +-------------------+ +-------------------+
        ^                     ^                     ^
        |                     |                     |
        |                     |                     |
+-------------------+ +-------------------+ +-------------------+
| - ResourceNotFound| | - Database        | | - Authentication  |
| - Duplicate       | | - Integration     | | - Authorization   |
| - RuleViolation   | | - Configuration   | | - TokenExpired    |
+-------------------+ +-------------------+ +-------------------+
```

## 7. まとめ

エラー処理機能のドメインモデルは以下の要素で構成されています：

1. エラー情報を表すドメインオブジェクト（ErrorInfo, ErrorResponse）
2. エラーの分類（ErrorCategory, ErrorSeverity, ErrorCode）
3. アプリケーション全体で使用する例外クラス階層
4. エラーに関連する値オブジェクト（ErrorCodeInfo, ErrorContext）
5. エラーログの永続化に関するエンティティとリポジトリ

これらのドメインモデルを活用することで、エラーの発生から記録、ユーザーへのレスポンス生成までを一貫して扱うことができ、システム全体での統一的なエラー処理が実現できます。