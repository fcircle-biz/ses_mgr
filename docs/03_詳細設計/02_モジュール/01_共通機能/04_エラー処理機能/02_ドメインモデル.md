# エラー処理機能のドメインモデル

## 1. ドメインモデルの概要

エラー処理機能のドメインモデルは、Spring Frameworkの標準機能を活用して、システム内で発生する様々なエラーと例外を統一的に表現し、処理するための概念モデルを定義します。このモデルにより、Spring の RFC 7807 互換のエラー情報の一貫した表現、分類、操作が可能となり、エラー処理の標準化と品質向上を実現します。

## 2. 主要なドメインオブジェクト

### 2.1 Problem詳細（ProblemDetail）

Spring 6のRFC 7807実装である`ProblemDetail`クラスを活用して、エラー情報を標準的に表現します。

```java
// Spring 6が提供するProblemDetailクラスを拡張して用いる
public class AppProblemDetail extends ProblemDetail {
    // RFC 7807標準のフィールド（ProblemDetailによって提供済み）:
    // - type: URI
    // - title: エラータイトル
    // - status: HTTPステータスコード
    // - detail: 詳細メッセージ
    // - instance: 特定のリソースURI
    
    // RFC 7807では任意の追加属性が許可されており、
    // Spring 6のProblemDetail.setProperty()を使用して拡張可能
    
    /**
     * Springの標準ProblemDetailから作成
     */
    public static AppProblemDetail from(ProblemDetail problemDetail) {
        AppProblemDetail appProblemDetail = new AppProblemDetail();
        appProblemDetail.setType(problemDetail.getType());
        appProblemDetail.setTitle(problemDetail.getTitle());
        appProblemDetail.setStatus(problemDetail.getStatus());
        appProblemDetail.setDetail(problemDetail.getDetail());
        appProblemDetail.setInstance(problemDetail.getInstance());
        appProblemDetail.setProperties(problemDetail.getProperties());
        return appProblemDetail;
    }
    
    /**
     * エラーコードを設定
     */
    public AppProblemDetail withErrorCode(ErrorCode errorCode) {
        this.setProperty("code", errorCode.getFullCode());
        this.setProperty("category", errorCode.getCategory().getCode());
        this.setProperty("severity", errorCode.getSeverity().getCode());
        return this;
    }
    
    /**
     * トレースIDを設定
     */
    public AppProblemDetail withTraceId(String traceId) {
        this.setProperty("traceId", traceId);
        return this;
    }
    
    /**
     * タイムスタンプを設定
     */
    public AppProblemDetail withTimestamp(OffsetDateTime timestamp) {
        this.setProperty("timestamp", timestamp.toString());
        return this;
    }
    
    /**
     * リクエストパスを設定
     */
    public AppProblemDetail withPath(String path) {
        this.setProperty("path", path);
        return this;
    }
    
    /**
     * HTTP メソッドを設定
     */
    public AppProblemDetail withMethod(String method) {
        this.setProperty("method", method);
        return this;
    }
}
```

### 2.2 エラーカテゴリ（ErrorCategory）

エラーの分類を表す列挙型です。

```java
public enum ErrorCategory {
    VALIDATION("validation", "入力検証エラー"),
    BUSINESS("business", "業務ロジックエラー"),
    SYSTEM("system", "システムエラー"),
    SECURITY("security", "セキュリティエラー"),
    INTEGRATION("integration", "外部連携エラー"),
    DATABASE("database", "データベースエラー"),
    UNKNOWN("unknown", "不明なエラー");
    
    private final String code;
    private final String description;
    
    // コンストラクタ、ゲッター
}
```

### 2.3 エラー重大度（ErrorSeverity）

エラーの重大度を表す列挙型です。

```java
public enum ErrorSeverity {
    INFO("info", "情報"),
    WARNING("warning", "警告"),
    ERROR("error", "エラー"),
    CRITICAL("critical", "致命的");
    
    private final String code;
    private final String description;
    
    // コンストラクタ、ゲッター
}
```

### 2.4 エラーコード（ErrorCode）

システム内で発生するエラーを一意に識別するエラーコードを定義します。

```java
public enum ErrorCode {
    // 認証・認可エラー (10000-10999)
    AUTHENTICATION_ERROR(10001, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.UNAUTHORIZED),
    INVALID_CREDENTIALS(10002, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.UNAUTHORIZED),
    TOKEN_EXPIRED(10003, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.UNAUTHORIZED),
    ACCESS_DENIED(10004, ErrorCategory.SECURITY, ErrorSeverity.ERROR, HttpStatus.FORBIDDEN),
    
    // バリデーションエラー (11000-11999)
    VALIDATION_ERROR(11001, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.BAD_REQUEST),
    INVALID_PARAMETER(11002, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.BAD_REQUEST),
    MISSING_REQUIRED_FIELD(11003, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.BAD_REQUEST),
    
    // 入力形式エラー (12000-12999)
    METHOD_NOT_ALLOWED(12001, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.METHOD_NOT_ALLOWED),
    UNSUPPORTED_MEDIA_TYPE(12002, ErrorCategory.VALIDATION, ErrorSeverity.WARNING, HttpStatus.UNSUPPORTED_MEDIA_TYPE),
    
    // 業務ロジックエラー (20000-29999)
    // - リソース関連 (20000-20999)
    RESOURCE_NOT_FOUND(20001, ErrorCategory.BUSINESS, ErrorSeverity.WARNING, HttpStatus.NOT_FOUND),
    DUPLICATE_RESOURCE(20002, ErrorCategory.BUSINESS, ErrorSeverity.WARNING, HttpStatus.CONFLICT),
    CONCURRENT_MODIFICATION(20003, ErrorCategory.BUSINESS, ErrorSeverity.WARNING, HttpStatus.CONFLICT),
    
    // - その他業務エラー (21000-21999)
    BUSINESS_RULE_VIOLATION(21001, ErrorCategory.BUSINESS, ErrorSeverity.ERROR, HttpStatus.UNPROCESSABLE_ENTITY),
    OPERATION_NOT_ALLOWED(21002, ErrorCategory.BUSINESS, ErrorSeverity.ERROR, HttpStatus.FORBIDDEN),
    
    // データベースエラー (30000-30999)
    DATABASE_ERROR(30001, ErrorCategory.DATABASE, ErrorSeverity.ERROR, HttpStatus.INTERNAL_SERVER_ERROR),
    DATABASE_CONSTRAINT_VIOLATION(30002, ErrorCategory.DATABASE, ErrorSeverity.ERROR, HttpStatus.CONFLICT),
    
    // 外部連携エラー (40000-40999)
    INTEGRATION_ERROR(40001, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.BAD_GATEWAY),
    INTEGRATION_RESOURCE_NOT_FOUND(40002, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.NOT_FOUND),
    INTEGRATION_TIMEOUT(40003, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.GATEWAY_TIMEOUT),
    INTEGRATION_AUTHENTICATION_ERROR(40004, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.UNAUTHORIZED),
    INTEGRATION_AUTHORIZATION_ERROR(40005, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.FORBIDDEN),
    INTEGRATION_CLIENT_ERROR(40006, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.BAD_GATEWAY),
    INTEGRATION_SERVER_ERROR(40007, ErrorCategory.INTEGRATION, ErrorSeverity.ERROR, HttpStatus.BAD_GATEWAY),
    
    // システムエラー (90000-99999)
    INTERNAL_SERVER_ERROR(90001, ErrorCategory.SYSTEM, ErrorSeverity.ERROR, HttpStatus.INTERNAL_SERVER_ERROR),
    CONFIGURATION_ERROR(90002, ErrorCategory.SYSTEM, ErrorSeverity.ERROR, HttpStatus.INTERNAL_SERVER_ERROR),
    SERVICE_UNAVAILABLE(90003, ErrorCategory.SYSTEM, ErrorSeverity.ERROR, HttpStatus.SERVICE_UNAVAILABLE),
    UNEXPECTED_ERROR(99999, ErrorCategory.UNKNOWN, ErrorSeverity.CRITICAL, HttpStatus.INTERNAL_SERVER_ERROR);
    
    private final int code;
    private final ErrorCategory category;
    private final ErrorSeverity severity;
    private final HttpStatus httpStatus;
    
    // コンストラクタ、ゲッター
    
    public String getFullCode() {
        return "E" + code;
    }
    
    public String getDefaultTitle() {
        return name().replace('_', ' ').toLowerCase();
    }
}
```

### 2.5 バリデーションエラー情報（ValidationError）

バリデーションエラーの詳細情報を表すクラスです。

```java
/**
 * バリデーションエラー情報を表すクラス
 */
public class ValidationError {
    private final String field;
    private final String message;
    private final String code;
    private final Object rejectedValue;
    
    // コンストラクタ、ゲッター
    
    /**
     * Spring ValidationのFieldErrorからインスタンスを作成
     */
    public static ValidationError fromFieldError(FieldError fieldError, MessageSource messageSource, Locale locale) {
        String message = messageSource.getMessage(fieldError, locale);
        String code = fieldError.getCode();
        
        return new ValidationError(
                fieldError.getField(),
                message,
                code,
                fieldError.getRejectedValue()
        );
    }
}
```

## 3. 例外クラス階層

Spring Frameworkとの統合を考慮した例外クラス階層を定義します。

### 3.1 基本例外クラス

アプリケーション全体で使用する基本例外クラスを定義します。

```java
/**
 * アプリケーション全体の基本例外クラス
 */
public abstract class ApplicationException extends RuntimeException {
    private final ErrorCode errorCode;
    private final Map<String, Object> data;
    
    // コンストラクタ、ゲッター
}
```

### 3.2 業務例外

業務ロジックで発生する例外を表すクラスです。

```java
/**
 * 業務ロジックで発生する例外の基底クラス
 */
public class BusinessException extends ApplicationException {
    // コンストラクタ
}

/**
 * リソースが見つからない場合の例外
 */
public class ResourceNotFoundException extends BusinessException {
    private final String resourceType;
    private final String resourceId;
    
    // コンストラクタ、ゲッター
}

/**
 * 重複データが存在する場合の例外
 */
public class DuplicateResourceException extends BusinessException {
    private final String resourceType;
    private final String constraintName;
    
    // コンストラクタ、ゲッター
}

/**
 * 楽観的ロックの競合が発生した場合の例外
 */
public class ConcurrentModificationException extends BusinessException {
    private final String resourceType;
    private final String resourceId;
    
    // コンストラクタ、ゲッター
}

/**
 * 業務ルール違反の例外
 */
public class BusinessRuleViolationException extends BusinessException {
    private final String ruleId;
    
    // コンストラクタ、ゲッター
}
```

### 3.3 システム例外

システム内部で発生する例外を表すクラスです。

```java
/**
 * システム内部で発生する例外の基底クラス
 */
public class SystemException extends ApplicationException {
    // コンストラクタ
}

/**
 * データベース操作に関する例外
 */
public class DatabaseException extends SystemException {
    private final String operationType;
    private final String tableName;
    
    // コンストラクタ、ゲッター
}

/**
 * 外部サービス連携に関する例外 - Spring WebClient/RestClient例外のラッパー
 */
public class IntegrationException extends SystemException {
    private final String serviceName;
    
    // コンストラクタ、ゲッター
}

/**
 * 設定不足や不正に関する例外
 */
public class ConfigurationException extends SystemException {
    private final String configName;
    
    // コンストラクタ、ゲッター
}
```

### 3.4 セキュリティ例外

Spring Securityとの統合を考慮した認証・認可に関する例外を表すクラスです。

```java
/**
 * アプリケーション固有の認証例外
 * Spring Security AuthenticationExceptionを拡張
 */
public class ApplicationAuthenticationException 
        extends org.springframework.security.core.AuthenticationException {
    
    private final ErrorCode errorCode;
    private final Map<String, Object> data;
    
    // コンストラクタ、ゲッター
}

/**
 * アプリケーション固有のアクセス拒否例外
 * Spring Security AccessDeniedExceptionを拡張
 */
public class ApplicationAccessDeniedException 
        extends org.springframework.security.access.AccessDeniedException {
    
    private final ErrorCode errorCode;
    private final Map<String, Object> data;
    private final List<String> requiredPermissions;
    
    // コンストラクタ、ゲッター
}
```

## 4. Spring特有のドメインオブジェクト

### 4.1 ProblemDetailFactory

Spring 6の`ProblemDetail`を生成するファクトリーインターフェースと実装クラスです。

```java
/**
 * ProblemDetailを生成するファクトリーのインターフェース
 */
public interface ProblemDetailFactory {
    /**
     * 例外からProblemDetailを生成
     */
    ProblemDetail createFromException(
            Throwable exception, 
            HttpStatusCode status, 
            WebRequest request,
            Locale locale);
    
    /**
     * 例外と指定されたエラーコードからProblemDetailを生成
     */
    ProblemDetail createFromExceptionAndErrorCode(
            Throwable exception,
            ErrorCode errorCode,
            HttpStatusCode status,
            WebRequest request,
            Locale locale);
}

/**
 * ProblemDetailFactoryの実装クラス
 */
@Component
public class ProblemDetailFactoryImpl implements ProblemDetailFactory {
    private final MessageSource messageSource;
    private final TraceContextProvider traceContextProvider;
    private final Clock clock;
    
    // コンストラクタ、DI...
    
    @Override
    public ProblemDetail createFromException(
            Throwable exception, 
            HttpStatusCode status, 
            WebRequest request, 
            Locale locale) {
        
        // 例外クラスからエラーコードを推測
        ErrorCode errorCode = determineErrorCode(exception);
        
        return createFromExceptionAndErrorCode(
                exception, errorCode, status, request, locale);
    }
    
    @Override
    public ProblemDetail createFromExceptionAndErrorCode(
            Throwable exception,
            ErrorCode errorCode,
            HttpStatusCode status,
            WebRequest request,
            Locale locale) {
        
        // ProblemDetailの基本情報を設定
        ProblemDetail problemDetail = ProblemDetail.forStatus(status);
        
        // ... 実装の詳細 ...
        
        return problemDetail;
    }
}
```

### 4.2 エラーイベント（ErrorEvent）

Spring ApplicationEventを活用したエラーイベントの実装です。

```java
/**
 * エラー発生時に発行されるイベント
 */
public class ErrorEvent extends ApplicationEvent {
    private final HttpServletRequest request;
    private final ProblemDetail problemDetail;
    
    public ErrorEvent(Throwable source, HttpServletRequest request, ProblemDetail problemDetail) {
        super(source);
        this.request = request;
        this.problemDetail = problemDetail;
    }
    
    /**
     * 元の例外を取得
     */
    @Override
    public Throwable getSource() {
        return (Throwable) super.getSource();
    }
    
    // ゲッターメソッド...
}
```

### 4.3 トレースコンテキストプロバイダー（TraceContextProvider）

分散トレーシングのトレースIDを提供するクラスです。

```java
/**
 * トレースIDプロバイダー
 */
@Component
public class TraceContextProvider {
    /**
     * 現在のトレースIDを取得
     */
    public String getCurrentTraceId() {
        // Spring Cloud Sleuthまたは対応するトレーシングライブラリと統合
        return Span.current().getSpanContext().getTraceId();
    }
}
```

## 5. エンティティとリポジトリ

Spring Data JDBCと統合したエラーログのエンティティとリポジトリ定義です。

### 5.1 エラーログエンティティ（ErrorLog）

```java
/**
 * エラーログエンティティ
 */
@Table("error_logs")
public class ErrorLog {
    @Id
    private Long id;
    
    private String errorCode;
    private String errorCategory;
    private String errorSeverity;
    private String errorTitle;
    private String errorDetail;
    private String traceId;
    private String path;
    private String method;
    private String userAgent;
    private String ipAddress;
    private String userId;
    private String exceptionType;
    private String exceptionMessage;
    private String stackTrace;
    private OffsetDateTime timestamp;
    
    // ゲッター、セッター
}
```

### 5.2 エラーログリポジトリ（ErrorLogRepository）

```java
/**
 * エラーログリポジトリ
 */
public interface ErrorLogRepository extends CrudRepository<ErrorLog, Long>, PagingAndSortingRepository<ErrorLog, Long> {
    List<ErrorLog> findByErrorCode(String errorCode);
    
    List<ErrorLog> findByErrorCategory(String category);
    
    List<ErrorLog> findByErrorSeverity(String severity);
    
    List<ErrorLog> findByTimestampBetween(OffsetDateTime startTime, OffsetDateTime endTime);
    
    List<ErrorLog> findByTraceId(String traceId);
    
    List<ErrorLog> findByUserId(String userId);
    
    @Query("SELECT * FROM error_logs WHERE path LIKE :pathPattern")
    List<ErrorLog> findByPathPattern(String pathPattern);
    
    // エラーメトリクス用クエリ
    @Query("SELECT error_category, COUNT(*) FROM error_logs " +
            "WHERE timestamp BETWEEN :startTime AND :endTime " +
            "GROUP BY error_category")
    List<CategoryCount> countByCategory(OffsetDateTime startTime, OffsetDateTime endTime);
    
    @Query("SELECT error_severity, COUNT(*) FROM error_logs " +
            "WHERE timestamp BETWEEN :startTime AND :endTime " +
            "GROUP BY error_severity")
    List<SeverityCount> countBySeverity(OffsetDateTime startTime, OffsetDateTime endTime);
    
    // プロジェクション
    interface CategoryCount {
        String getErrorCategory();
        long getCount();
    }
    
    interface SeverityCount {
        String getErrorSeverity();
        long getCount();
    }
}
```

## 6. エラー処理のSpring特有の機能

### 6.1 ErrorAttributesカスタマイザー

Spring Bootの`ErrorAttributes`をカスタマイズするクラスです。

```java
/**
 * ErrorAttributesカスタマイザー
 */
@Component
public class AppErrorAttributesCustomizer implements ErrorAttributesCustomizer {
    
    private final TraceContextProvider traceContextProvider;
    private final Clock clock;
    
    // コンストラクタ、DI...
    
    @Override
    public void customize(Map<String, Object> errorAttributes) {
        // エラー情報にトレースIDを追加
        String traceId = traceContextProvider.getCurrentTraceId();
        if (traceId != null) {
            errorAttributes.put("traceId", traceId);
        }
        
        // タイムスタンプをISO 8601形式に変換
        if (errorAttributes.containsKey("timestamp")) {
            Instant timestamp = (Instant) errorAttributes.get("timestamp");
            errorAttributes.put("timestamp", OffsetDateTime.ofInstant(timestamp, clock.getZone()).toString());
        }
    }
}
```

### 6.2 メッセージソースキャッシュ

Spring Cacheを活用したエラーメッセージキャッシュです。

```java
/**
 * キャッシュを活用したメッセージソースラッパー
 */
@Component
public class CachedMessageSource {
    
    private final MessageSource delegate;
    
    // コンストラクタ、DI...
    
    /**
     * キャッシュを利用したメッセージ解決
     */
    @Cacheable(cacheNames = "errorMessages", key = "#code + '_' + #locale")
    public String getMessage(String code, Locale locale) {
        return delegate.getMessage(code, null, code, locale);
    }
}
```

## 7. ドメインモデル図

```
+-------------------+      +-------------------+      +-------------------+
|   ProblemDetail   |      |   ErrorCode       |      |  ErrorEvent       |
+-------------------+      +-------------------+      +-------------------+
| - type            |<-----| - code            |      | - source(Exception)|
| - title           |      | - category        |      | - request         |
| - status          |      | - severity        |      | - problemDetail   |
| - detail          |      | - httpStatus      |      |                   |
| - instance        |      |                   |      +-------------------+
| + properties      |      +-------------------+
+-------------------+                |
        ^                            |
        |                            V
        |                   +-------------------+
+-------------------+       | ApplicationException
| ProblemDetailFactory      +-------------------+
+-------------------+       | - errorCode       |
| - createFromException     | - data            |
| - createFromExceptionAndErrorCode |           |
+-------------------+       +-------------------+
                                    ^
                                    |
                +-------------------+-------------------+
                |                   |                   |
      +-----------------+  +-------------------+  +--------------------+
      | BusinessException |  | SystemException   |  | Spring Security    |
      +-----------------+  +-------------------+  | Exceptions          |
          /     |    \              |    \         +--------------------+
         /      |     \             |     \              |        |
+-------------+ | +------------+ +--------+ +--------+ +---------+ +--------+
| ResourceNotFound | | Duplicate   | | Database | | Integration | | Auth     | | Access  |
+-------------+ | +------------+ +--------+ +--------+ +---------+ +--------+
                |
      +--------------------+
      | Business Rule      |
      +--------------------+
```

## 8. まとめ

Spring標準機能を活用したエラー処理機能のドメインモデルは以下の要素で構成されます：

1. **Spring 6のProblemDetail**：RFC 7807準拠のエラーレスポンス表現
2. **エラーの分類**：ErrorCategory、ErrorSeverity、ErrorCode
3. **Springと統合された例外クラス階層**：Spring Securityの例外拡張を含む
4. **Spring特有のドメインオブジェクト**：ProblemDetailFactory、ErrorEvent
5. **Spring Data JDBCと統合したリポジトリ**：ErrorLogRepository
6. **Spring Bootとの統合**：ErrorAttributesCustomizer、CachedMessageSource

これらのドメインモデルを活用することで、Spring Frameworkの標準機能をベースとした一貫性のあるエラー処理が実現でき、APIのクライアントに対して標準的で理解しやすいエラーレスポンスを提供することができます。