# エラー処理機能の概要

## 1. 目的

エラー処理機能はSES業務システムにおいて発生するさまざまな例外や異常状態を適切に処理し、ユーザーにわかりやすいフィードバックを提供するとともに、開発者・運用者が問題を迅速に特定して対応できるようにする基盤的な共通機能です。以下の目的を持ちます：

- エラーの種類に応じた適切なユーザー体験の提供
- 例外発生時の一貫したエラー表示とハンドリング
- エラーの種類と原因の明確な識別
- エラー情報の効率的な記録と監視
- エラー情報を活用したトラブルシューティングの効率化
- 複数モジュールでのエラー処理の標準化と一元化
- Spring標準機能を活用した保守性と拡張性の確保

## 2. 主要機能

### 2.1 統一エラーモデル

- Spring 6/Boot 3のProblemDetailを活用したRFC 7807準拠のエラーモデル
- エラーコードの一元管理
- エラーメッセージのユーザー向け最適化とMessageSourceによる国際化
- エラー情報の階層化
- エラー情報に付加情報（リクエスト情報、トレースIDなど）の関連付け
- エラー情報のフォーマット変換機能

### 2.2 例外ハンドリング

- @ControllerAdvice/@RestControllerAdviceによる集中型例外ハンドリング
- @ExceptionHandlerによる例外タイプ別ハンドリング
- ResponseEntityExceptionHandlerを活用した標準MVC例外のハンドリング
- Bean ValidationとSpring Validationの統合による入力検証
- ビジネス例外の処理
- システム例外の処理
- Spring Securityとの統合によるセキュリティ例外の処理

### 2.3 エラーログ機能

- Spring AOPを活用した横断的エラーロギング
- ApplicationEventを利用したイベント駆動エラー処理
- トレースIDによる追跡（MDC連携）
- Spring Boot Actuatorによるエラーメトリクス収集
- 致命的エラーの通知機能

## 3. アーキテクチャの概要と特徴

エラー処理機能は以下のような方針とアーキテクチャ特徴を持ちます：

- Spring標準機能を活用した宣言的な例外ハンドリング
- 集中型APIエラーハンドリングによるコントローラーの簡素化
- 例外処理ロジックの分離と再利用性の向上
- ビジネスロジックとエラー処理を明確に区別する設計
- データアクセス例外の自動変換による持続性層の抽象化
- 適応性のあるエラーレスポンス設計

## 4. 処理フロー

### 4.1 APIバリデーションエラーの処理フロー

1. クライアントからの無効なリクエストがAPIコントローラーに到達
2. @Valid/@Validatedによる入力バリデーションが失敗し例外が発生（MethodArgumentNotValidException）
3. @ExceptionHandlerで定義されたハンドラーメソッドが例外をキャッチ
4. ProblemDetailに基づくエラーレスポンスを生成
5. 適切なHTTPステータスコード（400）と詳細なエラー情報を返却
6. エラーイベントを発行し、リスナーによりエラー情報をログに記録

### 4.2 ビジネスロジックのエラー処理フロー

1. サービスで業務上の例外的な状態が発生
2. サービスは業務の性質に合った適切な例外をスロー
3. 例外（ResourceNotFoundExceptionなど）が発生
4. @ExceptionHandlerで定義されたハンドラーメソッドが業務例外をキャッチ
5. MessageSourceを使用して国際化されたエラーメッセージでProblemDetailを生成
6. 適切なHTTPステータスコード（404など）と詳細なエラー情報を返却
7. エラーイベントを発行し、リスナーによりエラー情報を適切なレベルでログに記録

### 4.3 システム例外の処理フロー

1. データベース接続エラーなどのシステム例外が発生
2. @Repositoryによりデータアクセス例外が抽象化された例外に自動変換される
3. @ExceptionHandlerで定義されたハンドラーメソッドがシステム例外をキャッチ
4. 機密情報を含まないユーザー向けのProblemDetailを生成
5. エラー詳細は内部のみに記録しユーザーには公開しない
6. 適切なHTTPステータスコード（500など）と一般的なエラー情報を返却
7. エラーイベントを発行し、リスナーによりエラー情報を高い重要度でログに記録
8. Spring Event機能を使用して重要なエラーの通知を発行

### 4.4 セキュリティ例外の処理フロー

1. ユーザーがアクセス権のないリソースにアクセス
2. Spring Securityの認可チェックによりAccessDeniedException発生
3. AuthenticationEntryPoint/AccessDeniedHandlerで例外を初期処理
4. @ExceptionHandlerで定義されたハンドラーメソッドが例外をキャッチ
5. 適切なメッセージを含むProblemDetailを生成
6. 適切なHTTPステータスコード（401/403など）と一般的なエラー情報を返却
7. エラーイベントを発行し、リスナーによりアクセスの試みと詳細情報をセキュリティログに記録

## 5. 非機能要件

- エラー処理メカニズムの高可用性と信頼性
- エラー処理自体の性能とシステムへの影響（非同期処理の活用）
- エラー処理情報のセキュリティ確保
- エラー処理のユーザー体験の最適化
- Spring Boot Actuatorを活用したエラーメトリクスのモニタリング

## 6. コンポーネント構成図

エラー処理機能は以下のSpring標準機能を活用したコンポーネントで構成されます：

```
+-------------------+                +------------------------+
| Spring MVC        |                | Spring Boot Web        |
| Framework         |                | Auto-configuration     |
+--------+----------+                +-----------+------------+
         |                                       |
         v                                       v
+------------------+     +----------------------+     +-------------------+
| @RestController  +---->| @RestControllerAdvice |<----+ Spring Security  |
|                  |     |                      |     | Integration      |
+------------------+     +----------+-----------+     +-------------------+
                                    |
                                    v
+-----------------+      +----------+-----------+      +-------------------+
| Bean Validation |----->|                      |      | ProblemDetail     |
| Framework       |      | ResponseEntity       |----->| RFC 7807          |
+-----------------+      | ExceptionHandler     |      | Response          |
                         |                      |      +-------------------+
+-----------------+      |                      |
| Spring Data     |----->|                      |      +-------------------+
| Exceptions      |      +----------+-----------+      | ApplicationEvent  |
+-----------------+                 |                  | Publisher         |
                                    |                  +--------+----------+
+-----------------+                 |                           |
| Custom Business |                 |                           v
| Exceptions      |---------------->+                  +-------------------+
+-----------------+                                    | Error Logging     |
                                                       | Event Listeners   |
                                                       +-------------------+
                                                                |
                                                                v
                                                       +-------------------+
                                                       | Spring Boot       |
                                                       | Actuator Metrics  |
                                                       +-------------------+
```

主要コンポーネントの役割：

- **@RestControllerAdvice**：Spring標準の集中例外ハンドリングを提供
- **ResponseEntityExceptionHandler**：MVC標準例外の基本ハンドリングを提供
- **ProblemDetail**：RFC 7807準拠の標準エラーレスポンスを生成
- **ApplicationEventPublisher**：エラーイベントの発行を担当
- **Error Logging Event Listeners**：エラーイベントのサブスクライブとログ記録
- **Spring Boot Actuator**：エラーメトリクスの収集と監視を担当

## 7. 技術要素

### 7.1 利用技術

- Spring Boot 3.2.x標準の例外処理機能
- Spring 6のProblemDetail実装
- Spring AOPを活用した横断的関心事の分離
- Spring Eventsを活用したイベント駆動アーキテクチャ
- Spring Boot Actuatorによるメトリクス収集
- Jakarta Bean Validationによる入力検証

### 7.2 パフォーマンス

- 非同期イベント処理（@Async）によるエラーログ記録
- エラー処理による処理時間への影響を最小限に抑える設計
- Caffeine Cacheを活用したエラーメッセージのキャッシング
- 重大度に応じたログレベル制御

### 7.3 セキュリティ

- エラー詳細情報の外部公開制限（環境別制御）
- Spring Security統合によるセキュリティ例外の標準化
- エラー情報に機密情報を含めないための検証仕組み
- セキュリティ関連例外の特別な処理
- トレースIDの活用による監視と追跡性の向上

## 8. Spring標準機能の活用

Spring Frameworkが提供する標準機能を活用することで、保守性と拡張性の高いエラー処理機能を実現します：

### 8.1 例外ハンドリング

- @ControllerAdvice/@RestControllerAdviceによる集中型例外ハンドリング
- @ExceptionHandlerによる例外タイプ別ハンドリング
- ResponseEntityExceptionHandlerの継承による標準例外処理
- Spring MVCのResponeStatusExceptionの活用

### 8.2 エラーレスポンス生成

- Spring 6のProblemDetail実装によるRFC 7807準拠のエラーレスポンス
- MessageSourceを活用した国際化エラーメッセージ
- Spring Boot提供のDefaultErrorAttributesのカスタマイズ

### 8.3 データアクセス例外処理

- @Repositoryによるデータアクセス例外の自動変換
- Spring Dataのオプティミスティックロック例外処理
- Spring Transactionalによるトランザクション管理との連携

### 8.4 バリデーション処理

- Bean ValidationとSpring Validationの統合
- @Validと@Validatedによる入力検証
- BindingResultに基づくフィールドエラー処理

### 8.5 ログ記録と通知

- Spring AOPを活用した横断的ログ記録
- Spring Eventsを活用したイベント駆動ログ記録
- @Asyncによる非同期処理
- Spring Boot Actuatorによるエラーメトリクス収集

### 8.6 セキュリティ連携

- Spring SecurityのAuthenticationEntryPoint連携
- AccessDeniedHandlerによるアクセス拒否処理
- Spring Securityフィルタチェーンとの統合