# コード値管理機能 - インターフェース定義

## 1. インターフェース概要

コード値管理機能は、SES業務システム全体に対してコード値（マスタデータ）を提供するための標準的なインターフェースを定義します。本インターフェースは、参照機能と管理機能の2つの主要な責務に分かれています。

## 2. 提供インターフェース

### 2.1 CodeService

**目的**: コード値参照のための主要インターフェース。システム全体のあらゆるモジュールがコード値を参照するために使用します。

**責務**:
- コードカテゴリの取得
- コード値の検索・取得
- 階層構造化されたコード値の取得
- コード値名称マッピングの提供
- キャッシュ管理

#### メソッド一覧

**findAllCategories**
- **目的**: システムで利用可能なすべてのコードカテゴリを取得する
- **引数**: なし
- **戻り値**: コードカテゴリDTOのリスト

**findByCategory**
- **目的**: 指定されたカテゴリに属するコード値の一覧を取得する
- **引数**:
  - categoryId: カテゴリID
  - keyword: 検索キーワード（任意）
  - parentCode: 親コード（任意、階層構造の場合）
  - activeOnly: 有効なコード値のみ取得するフラグ（デフォルトtrue）
- **戻り値**: コード値DTOのリスト
- **例外**: カテゴリが存在しない場合に EntityNotFoundException

**findByCode**
- **目的**: 指定されたカテゴリとコードの組み合わせによるコード値の詳細情報を取得する
- **引数**:
  - categoryId: カテゴリID
  - code: コード値
- **戻り値**: コード値詳細DTO
- **例外**: コード値が存在しない場合に EntityNotFoundException

**getCodeValueTree**
- **目的**: 階層構造を持つコード値の階層ツリーを取得する
- **引数**:
  - categoryId: カテゴリID
  - activeOnly: 有効なコード値のみ取得するフラグ（デフォルトtrue）
- **戻り値**: 階層構造化されたコード値のツリー
- **例外**: カテゴリが存在しない場合に EntityNotFoundException

**getCodeNameMap**
- **目的**: 指定されたカテゴリIDとコード値一覧から名称マッピングを取得する
- **引数**:
  - categoryId: カテゴリID
  - codes: コード値のリスト
- **戻り値**: コード値と名称のマッピング
- **例外**: カテゴリが存在しない場合に EntityNotFoundException

**refreshCache**
- **目的**: コード値のキャッシュを更新する
- **引数**:
  - categoryId: カテゴリID（nullの場合は全カテゴリ）
- **戻り値**: なし

### 2.2 AdminCodeService

**目的**: コード値管理のための管理用インターフェース。主にシステム管理機能から使用されます。

**責務**:
- コードカテゴリの作成・更新・削除
- コード値の作成・更新・削除
- コード値の有効/無効管理
- コード値の一括インポート・エクスポート
- 変更履歴の取得

#### メソッド一覧

**createCategory**
- **目的**: 新しいコードカテゴリを作成する
- **引数**: 作成用DTO
- **戻り値**: 作成されたコードカテゴリDTO
- **例外**:
  - カテゴリIDが既に存在する場合に DuplicateEntityException
  - バリデーションエラーの場合に ValidationException

**updateCategory**
- **目的**: コードカテゴリを更新する
- **引数**:
  - id: カテゴリID
  - categoryDTO: 更新用DTO
- **戻り値**: 更新されたコードカテゴリDTO
- **例外**:
  - カテゴリが存在しない場合に EntityNotFoundException
  - バリデーションエラーの場合に ValidationException

**deleteCategory**
- **目的**: コードカテゴリを削除する
- **引数**: id: カテゴリID
- **例外**:
  - カテゴリが存在しない場合に EntityNotFoundException
  - 削除できないカテゴリの場合またはコード値が存在する場合に BusinessRuleException

**createCodeValue**
- **目的**: 新しいコード値を作成する
- **引数**:
  - categoryId: カテゴリID
  - codeValueDTO: 作成用DTO
- **戻り値**: 作成されたコード値DTO
- **例外**:
  - カテゴリが存在しない場合に EntityNotFoundException
  - コード値が既に存在する場合に DuplicateEntityException
  - バリデーションエラーの場合に ValidationException

**updateCodeValue**
- **目的**: コード値を更新する
- **引数**:
  - categoryId: カテゴリID
  - code: コード値
  - codeValueDTO: 更新用DTO
- **戻り値**: 更新されたコード値DTO
- **例外**:
  - コード値が存在しない場合に EntityNotFoundException
  - バリデーションエラーの場合に ValidationException

**deleteCodeValue**
- **目的**: コード値を削除する
- **引数**:
  - categoryId: カテゴリID
  - code: コード値
- **例外**:
  - コード値が存在しない場合に EntityNotFoundException
  - 削除できないコード値の場合または参照されている場合に BusinessRuleException

**toggleCodeValueActive**
- **目的**: コード値の有効/無効を切り替える
- **引数**:
  - categoryId: カテゴリID
  - code: コード値
  - active: 有効/無効フラグ
- **戻り値**: 更新されたコード値DTO
- **例外**: コード値が存在しない場合に EntityNotFoundException

**importCodeValues**
- **目的**: CSVファイルからコード値を一括インポートする
- **引数**:
  - categoryId: カテゴリID
  - inputStream: CSVファイルの入力ストリーム
  - mode: インポートモード（追加/更新/全置換）
- **戻り値**: インポート結果
- **例外**:
  - カテゴリが存在しない場合に EntityNotFoundException
  - CSVフォーマットエラーの場合に ValidationException

**exportCodeValues**
- **目的**: コード値をCSVファイルにエクスポートする
- **引数**:
  - categoryId: カテゴリID
  - outputStream: 出力ストリーム
- **例外**: カテゴリが存在しない場合に EntityNotFoundException

**getCodeValueHistory**
- **目的**: コード値の変更履歴を取得する
- **引数**:
  - categoryId: カテゴリID
  - code: コード値
  - pageable: ページング情報
- **戻り値**: コード値履歴DTOのページング結果

## 3. 要求インターフェース

### 3.1 AuditLogService

**目的**: ロギング機能モジュールから提供される監査ログサービスを利用するためのインターフェース

**提供モジュール**: ロギング機能

**主要メソッド**:
- **recordAuditLog**: 監査ログを記録
- **searchAuditLogs**: 監査ログを検索

**使用目的と文脈**:
- コード値の作成、更新、削除操作の監査ログ記録
- コード値カテゴリの作成、更新、削除操作の監査ログ記録
- コード値の一括インポート操作のサマリーログ記録

**依存度**: 中
- 監査ログ記録はコード値管理機能の主要な処理ではないが、操作追跡のために重要

### 3.2 CacheService

**目的**: 共通インフラから提供されるキャッシュサービスを利用するためのインターフェース

**提供モジュール**: 共通インフラ

**主要メソッド**:
- **get**: キャッシュから値を取得
- **put**: キャッシュに値を設定
- **remove**: キャッシュから特定のキーの値を削除
- **clear**: 指定キャッシュを全てクリア
- **containsKey**: キャッシュに特定のキーが存在するか確認

**使用目的と文脈**:
- コード値データのキャッシング
- カテゴリごとのキャッシュ管理
- コード値更新時のキャッシュ更新

**依存度**: 高
- コード値は頻繁に参照されるため、パフォーマンス向上のためにキャッシュが重要

## 4. データ交換モデル

### 4.1 コードカテゴリ関連データモデル

**CodeCategoryDTO（コードカテゴリDTO）**
- id: カテゴリID (String)
- name: カテゴリ名 (String)
- description: 説明 (String)
- sortOrder: 表示順 (Integer)
- codeCount: コード値の件数 (Integer)
- createdAt: 作成日時 (LocalDateTime)
- updatedAt: 更新日時 (LocalDateTime)

**CodeCategoryCreateDTO（コードカテゴリ作成DTO）**
- id: カテゴリID (String)
- name: カテゴリ名 (String)
- description: 説明 (String)
- sortOrder: 表示順 (Integer)

**CodeCategoryUpdateDTO（コードカテゴリ更新DTO）**
- name: カテゴリ名 (String)
- description: 説明 (String)
- sortOrder: 表示順 (Integer)

### 4.2 コード値関連データモデル

**CodeValueDTO（コード値基本DTO）**
- code: コード値 (String)
- name: 名称 (String)
- description: 説明 (String)
- sortOrder: 表示順 (Integer)
- isActive: 有効フラグ (boolean)
- attributes: 追加属性 (Map<String, Object>)
- parentCode: 親コード値 (String)

**CodeValueDetailDTO（コード値詳細DTO）**
- category: 所属カテゴリ (CodeCategoryDTO)
- code: コード値 (String)
- name: 名称 (String)
- description: 説明 (String)
- sortOrder: 表示順 (Integer)
- isActive: 有効フラグ (boolean)
- attributes: 追加属性 (Map<String, Object>)
- parentCode: 親コード値 (String)
- childCodes: 子コード値リスト (List<String>)
- createdAt: 作成日時 (LocalDateTime)
- updatedAt: 更新日時 (LocalDateTime)

**CodeValueTreeDTO（コード値ツリーDTO）**
- code: コード値 (String)
- name: 名称 (String)
- isActive: 有効フラグ (boolean)
- children: 子ノードリスト (List<CodeValueTreeDTO>)

**CodeValueCreateDTO（コード値作成DTO）**
- code: コード値 (String)
- name: 名称 (String)
- description: 説明 (String)
- sortOrder: 表示順 (Integer)
- isActive: 有効フラグ (boolean)
- attributes: 追加属性 (Map<String, Object>)
- parentCode: 親コード値 (String)

**CodeValueUpdateDTO（コード値更新DTO）**
- name: 名称 (String)
- description: 説明 (String)
- sortOrder: 表示順 (Integer)
- isActive: 有効フラグ (boolean)
- attributes: 追加属性 (Map<String, Object>)
- parentCode: 親コード値 (String)

**CodeValueHistoryDTO（コード値履歴DTO）**
- id: 履歴ID (UUID)
- categoryId: カテゴリID (String)
- code: コード値 (String)
- operationType: 操作タイプ (Enum)
- beforeValue: 変更前の値 (Map<String, Object>)
- afterValue: 変更後の値 (Map<String, Object>)
- operatedBy: 操作者 (String)
- operatedAt: 操作日時 (LocalDateTime)

### 4.3 インポート・エクスポート関連データモデル

**ImportMode（インポートモードEnum）**
- ADD: 新規追加のみ
- UPDATE: 既存データの更新のみ
- REPLACE: 既存データを全て削除して置き換え

**ImportResult（インポート結果DTO）**
- total: 処理対象件数 (int)
- success: 成功件数 (int)
- error: エラー件数 (int)
- summary: 処理サマリー (String)
- errors: エラー詳細リスト (List<ImportError>)
- errorReportUrl: エラーレポートURL (String)

**ImportError（インポートエラーDTO）**
- line: 行番号 (int)
- code: エラーコード (String)
- reason: エラー理由 (String)

## 5. 非機能要件

### 5.1 パフォーマンス要件

- コード値一覧取得: レスポンス時間100ms以内（キャッシュ使用時）
- コード値詳細取得: レスポンス時間50ms以内（キャッシュ使用時）
- コード値更新後のキャッシュ更新: 500ms以内
- コード値一括インポート: 1,000件/5秒以内

### 5.2 キャッシュ戦略

- コード値はカテゴリ単位でキャッシュ
- キャッシュの有効期限: 60分（デフォルト）
- コード値更新時にカテゴリのキャッシュをクリア
- アプリケーション起動時に全カテゴリのキャッシュを事前ロード（オプション）

### 5.3 トランザクション管理

- コード値登録・更新・削除: REQUIRED
- コード値の一括インポート: REQUIRED
- コード値参照操作: SUPPORTS（読み取りのみの場合）または NOT_SUPPORTED（キャッシュからの読み取りの場合）

### 5.4 スレッドセーフティ

- コード値キャッシュは並行アクセスに対応
- コード値更新操作は楽観的ロックを使用して競合を検出
- 一括インポート処理中は当該カテゴリへの他の更新操作をブロック