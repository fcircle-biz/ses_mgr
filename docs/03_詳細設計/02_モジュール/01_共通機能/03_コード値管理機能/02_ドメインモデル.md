# コード値管理機能 - ドメインモデル

## 1. エンティティ定義

### 1.1 CodeCategory（コードカテゴリ）

システム内で管理されるコード値のカテゴリを表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | String | ○ | カテゴリID（一意識別子） |
| name | String | ○ | カテゴリ名称 |
| description | String |  | カテゴリの説明 |
| sortOrder | Integer | ○ | 表示順序 |
| createdAt | DateTime | ○ | 作成日時 |
| updatedAt | DateTime | ○ | 更新日時 |

#### バリデーションルール

- `id`: 英小文字、数字、アンダースコアのみ許可、3〜32文字（例：job_type, skill, project_status）
- `name`: 1〜50文字
- `description`: 最大200文字
- `sortOrder`: 1以上の整数

#### ビジネスルール

- カテゴリIDは一度作成すると変更不可
- システム定義のカテゴリは削除不可

### 1.2 CodeValue（コード値）

特定のカテゴリに属するコード値を表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| categoryId | String | ○ | カテゴリID（外部キー） |
| code | String | ○ | コード値（カテゴリ内で一意） |
| name | String | ○ | 表示名称 |
| description | String |  | 説明文 |
| sortOrder | Integer | ○ | 表示順序 |
| isActive | Boolean | ○ | 有効/無効フラグ |
| attributes | JSON |  | 追加属性（カテゴリ固有の属性） |
| parentCode | String |  | 親コード（階層構造の場合） |
| createdAt | DateTime | ○ | 作成日時 |
| updatedAt | DateTime | ○ | 更新日時 |

#### バリデーションルール

- `code`: 英数字とハイフン、アンダースコアのみ許可、1〜32文字
- `name`: 1〜100文字
- `description`: 最大500文字
- `sortOrder`: 1以上の整数
- `parentCode`: 同一カテゴリ内に存在するコード値であること

#### ビジネスルール

- カテゴリIDとコードの組み合わせで一意性を確保
- 階層構造の場合、循環参照（循環的な親子関係）は許可しない
- システム定義の基本コード値は削除不可
- 他のエンティティから参照されているコード値は削除不可（無効化のみ可能）
- 親コードが無効の場合、子コードも自動的に無効とみなす

### 1.3 CodeValueHistory（コード値履歴）

コード値の変更履歴を記録するエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | 履歴ID（一意識別子） |
| categoryId | String | ○ | カテゴリID |
| code | String | ○ | コード値 |
| operationType | OperationType | ○ | 操作種別（作成/更新/削除/無効化） |
| beforeValue | JSON |  | 変更前の値 |
| afterValue | JSON |  | 変更後の値 |
| operatedBy | String | ○ | 操作者ID |
| operatedAt | DateTime | ○ | 操作日時 |

#### バリデーションルール

- `id`: 有効なUUID形式
- `operatedBy`: 有効なユーザーID

#### ビジネスルール

- コード値の全ての変更履歴を保持
- 履歴データは削除しない

## 2. 値オブジェクト定義

### 2.1 CodeValueId（コード値ID）

コード値の複合主キーを表す値オブジェクトです。

```java
public class CodeValueId implements Serializable {
    private String categoryId;
    private String code;
    
    // コンストラクタ、equals、hashCodeメソッド
}
```

### 2.2 CodeValueAttributes（コード値追加属性）

コード値の追加属性を表す値オブジェクトです。カテゴリによって異なる属性を持ちます。

#### 職種（job_type）の追加属性例

```java
public class JobTypeAttributes {
    private String abbreviation;     // 略称
    private String skillLevel;       // 想定スキルレベル
    private String gradeRange;       // 想定グレード範囲
    private String yearsExperience;  // 想定経験年数
}
```

#### スキル（skill）の追加属性例

```java
public class SkillAttributes {
    private String category;           // スキルカテゴリ
    private String popularity;         // 人気度/需要
    private List<String> resources;    // 学習リソースリンク
}
```

### 2.3 OperationType（操作種別）

コード値履歴の操作種別を表す列挙型です。

```java
public enum OperationType {
    CREATE,     // 作成
    UPDATE,     // 更新
    DELETE,     // 削除
    ACTIVATE,   // 有効化
    DEACTIVATE  // 無効化
}
```

## 3. ドメイン関連図

```
CodeCategory 1 --- * CodeValue
      |
      |
      * CodeValueHistory
```

- `CodeCategory` は複数の `CodeValue` を持つ（1対多）
- `CodeValue` は同一カテゴリ内で親子関係を持つことができる（自己参照）
- `CodeValueHistory` はコード値の変更履歴を記録

## 4. 重要なビジネスルール

### 4.1 コード値の一意性と整合性

- カテゴリIDとコードの組み合わせで一意性を確保する
- コード値の参照整合性を確保する（存在しないカテゴリIDは参照不可）
- カテゴリIDは一度作成すると変更不可

### 4.2 階層構造の管理

- 親子関係は同一カテゴリ内でのみ許可
- 循環参照（A→B→C→A）は禁止
- 階層の深さは最大3階層までに制限（カテゴリに依存）
- 親コードが削除または無効化された場合、子コードも同様に処理

### 4.3 コード値のライフサイクル管理

- 新規作成時は有効状態で作成
- 更新は名称、説明、属性、親コード、ソート順が対象
- コードは一度作成すると変更不可
- 削除対象のコード値が参照されている場合は無効化のみ許可
- 無効化されたコード値は参照可能だが、新規データ作成時の選択肢には表示しない

### 4.4 システム定義コード値の保護

- システム定義のコード値カテゴリは削除不可
- システム定義の基本コード値は削除不可
- システム定義コード値の一部属性は変更制限あり

### 4.5 一括インポートルール

- インポートモードは追加（add）、更新（update）、全置換（replace）の3種類
- 追加モードでは既存コードとの重複チェックを実施
- 更新モードでは存在しないコードはスキップ
- 全置換モードではカテゴリ内の全コード値を削除して置き換え（システム定義値を除く）
- インポート時のバリデーションエラーは詳細なエラーレポートで報告

## 5. 主要コード値カテゴリ設計

### 5.1 職種マスタ（job_type）

```json
{
  "PM": {
    "name": "プロジェクトマネージャ",
    "description": "プロジェクト全体の管理と調整を担当",
    "attributes": {
      "abbreviation": "PM",
      "skillLevel": "senior",
      "gradeRange": "G4-G6"
    }
  },
  "SE": {
    "name": "システムエンジニア",
    "description": "システム設計、開発を担当",
    "attributes": {
      "abbreviation": "SE",
      "skillLevel": "middle",
      "gradeRange": "G3-G5"
    }
  },
  "PG": {
    "name": "プログラマ",
    "description": "プログラム開発を担当",
    "attributes": {
      "abbreviation": "PG",
      "skillLevel": "junior",
      "gradeRange": "G1-G3"
    }
  }
}
```

### 5.2 スキル階層マスタ（skill）

```
Programming Language（親）
  |- Java
  |   |- Java 8
  |   |- Java 11
  |   |- Java 17
  |- Python
  |   |- Python 2
  |   |- Python 3
  |- JavaScript
  |   |- TypeScript
  |   |- React
  |   |- Vue.js
  |- C#
  |- PHP
```

### 5.3 案件ステータスマスタ（project_status）

```json
{
  "OPEN": {
    "name": "募集中",
    "description": "募集中の案件",
    "attributes": {
      "color": "#4caf50",
      "allowEdit": true
    }
  },
  "IN_PROGRESS": {
    "name": "提案中",
    "description": "候補者提案中の案件",
    "attributes": {
      "color": "#2196f3",
      "allowEdit": true
    }
  },
  "CONTRACTED": {
    "name": "契約成立",
    "description": "契約が成立した案件",
    "attributes": {
      "color": "#673ab7",
      "allowEdit": false
    }
  },
  "COMPLETED": {
    "name": "完了",
    "description": "完了した案件",
    "attributes": {
      "color": "#9e9e9e",
      "allowEdit": false
    }
  },
  "CANCELLED": {
    "name": "キャンセル",
    "description": "キャンセルされた案件",
    "attributes": {
      "color": "#f44336",
      "allowEdit": false
    }
  }
}
```