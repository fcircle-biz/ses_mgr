# 検索機能 ドメインモデル

## 1. 概要

検索機能のドメインモデルは、様々なリソースタイプに対する検索操作と検索結果、検索履歴管理などの概念を定義します。本ドメインモデルでは、検索クエリと検索結果を中心として、様々な検索関連の概念とその相互関係を表現します。

## 2. 主要エンティティ

### 2.1 SearchQuery（検索クエリ）

ユーザーが入力した検索条件を表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | UUID | クエリの一意識別子 | 必須 |
| keywordQuery | String | キーワード検索文字列 | - |
| resourceTypes | List\<String\> | 検索対象のリソースタイプリスト | - |
| filters | Map\<String, Object\> | フィルタ条件 | - |
| sortField | String | ソートフィールド | - |
| sortOrder | SortOrder | ソート順序 | - |
| page | Integer | ページ番号（0始まり） | 0以上、デフォルト0 |
| pageSize | Integer | ページサイズ | 1以上100以下、デフォルト20 |
| groupByResourceType | Boolean | リソースタイプごとにグループ化するかどうか | デフォルトfalse |
| createdAt | ZonedDateTime | 作成日時 | 必須 |
| createdBy | UUID | 作成者ID | 必須 |

### 2.2 SearchResult（検索結果）

検索クエリの実行結果を表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | UUID | 検索結果の一意識別子 | 必須 |
| queryId | UUID | 実行された検索クエリのID | 必須 |
| totalHits | Long | 検索ヒット総数 | 0以上 |
| executionTimeMs | Long | 検索実行時間（ミリ秒） | 0以上 |
| groupedResults | Map\<String, ResourceTypeResult\> | リソースタイプごとの結果 | - |
| items | List\<SearchResultItem\> | 検索結果アイテム | - |
| facets | Map\<String, List\<FacetValue\>\> | ファセット情報 | - |
| currentPage | Integer | 現在のページ番号 | 0以上 |
| pageSize | Integer | ページサイズ | 1以上 |
| totalPages | Integer | 総ページ数 | 0以上 |
| timestamp | ZonedDateTime | 結果生成日時 | 必須 |

### 2.3 SearchResultItem（検索結果アイテム）

検索結果の個々のアイテムを表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | String | リソースの一意識別子 | 必須 |
| resourceType | String | リソースタイプ | 必須 |
| title | String | タイトル | 必須 |
| subtitle | String | サブタイトル | - |
| description | String | 説明 | - |
| url | String | リソースのURL | - |
| highlights | Map\<String, List\<String\>\> | ハイライト情報 | - |
| attributes | Map\<String, Object\> | リソース固有の属性 | - |
| score | Float | 関連度スコア | 0以上1以下 |

### 2.4 ResourceTypeResult（リソースタイプ別結果）

特定のリソースタイプに対する検索結果を表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| resourceType | String | リソースタイプ | 必須 |
| displayName | String | 表示名 | 必須 |
| totalHits | Long | このタイプのヒット総数 | 0以上 |
| items | List\<SearchResultItem\> | 検索結果アイテム | - |
| facets | Map\<String, List\<FacetValue\>\> | このタイプのファセット情報 | - |

### 2.5 SearchHistory（検索履歴）

ユーザーの検索履歴を表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | UUID | 検索履歴の一意識別子 | 必須 |
| userId | UUID | ユーザーID | 必須 |
| queryId | UUID | 検索クエリID | 必須 |
| resultCount | Integer | 検索結果数 | 0以上 |
| searchedAt | ZonedDateTime | 検索実行日時 | 必須 |
| query | SearchQuery | 検索クエリ（埋め込み） | 必須 |

### 2.6 SavedSearch（保存済み検索）

ユーザーが保存した検索条件を表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | UUID | 保存済み検索の一意識別子 | 必須 |
| name | String | 検索条件の名前 | 必須、1〜50文字 |
| description | String | 説明 | 0〜255文字 |
| userId | UUID | 所有者ID | 必須 |
| query | SearchQuery | 検索クエリ（埋め込み） | 必須 |
| isShared | Boolean | 共有フラグ | デフォルトfalse |
| createdAt | ZonedDateTime | 作成日時 | 必須 |
| updatedAt | ZonedDateTime | 更新日時 | 必須 |

### 2.7 SearchSuggestion（検索サジェスト）

検索サジェスト候補を表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | UUID | サジェストの一意識別子 | 必須 |
| keyword | String | サジェストキーワード | 必須、1〜100文字 |
| type | SuggestionType | サジェストタイプ | 必須 |
| weight | Integer | 重み（表示順序） | 必須、0以上 |
| resourceType | String | 関連リソースタイプ | - |
| frequency | Integer | 出現頻度 | 必須、0以上 |
| lastUsedAt | ZonedDateTime | 最終使用日時 | 必須 |

### 2.8 PopularSearch（人気の検索）

多くのユーザーに使用されている検索キーワードを表すエンティティです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | UUID | 人気検索の一意識別子 | 必須 |
| keyword | String | 検索キーワード | 必須、1〜100文字 |
| count | Integer | 検索回数 | 必須、1以上 |
| resourceTypes | List\<String\> | 一般的に検索されるリソースタイプ | - |
| period | Period | 集計期間 | 必須 |
| updatedAt | ZonedDateTime | 更新日時 | 必須 |

## 3. 値オブジェクト

### 3.1 SortOrder（ソート順序）

検索結果のソート順序を表す列挙型です。

#### 列挙値

- ASC: 昇順
- DESC: 降順

### 3.2 FacetValue（ファセット値）

検索結果のファセット情報の値を表す値オブジェクトです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| value | String | ファセット値 | 必須 |
| displayName | String | 表示名 | 必須 |
| count | Integer | 件数 | 0以上 |
| selected | Boolean | 選択済みかどうか | デフォルトfalse |

### 3.3 SuggestionType（サジェストタイプ）

検索サジェストのタイプを表す列挙型です。

#### 列挙値

- HISTORY: 検索履歴に基づくサジェスト
- POPULAR: 人気の検索に基づくサジェスト
- INDEX: インデックスに基づくサジェスト
- CONTEXT: コンテキストに基づくサジェスト

### 3.4 Period（期間）

集計期間を表す列挙型です。

#### 列挙値

- DAILY: 日次
- WEEKLY: 週次
- MONTHLY: 月次
- YEARLY: 年次

### 3.5 FilterOperator（フィルタ演算子）

フィルタ条件の演算子を表す列挙型です。

#### 列挙値

- EQUAL: 等しい
- NOT_EQUAL: 等しくない
- GREATER_THAN: より大きい
- LESS_THAN: より小さい
- GREATER_THAN_OR_EQUAL: 以上
- LESS_THAN_OR_EQUAL: 以下
- IN: いずれかに一致
- NOT_IN: いずれにも一致しない
- CONTAINS: 含む
- NOT_CONTAINS: 含まない
- STARTS_WITH: で始まる
- ENDS_WITH: で終わる
- BETWEEN: 範囲内
- EXISTS: 存在する
- NOT_EXISTS: 存在しない

### 3.6 FilterCriteria（フィルタ条件）

検索のフィルタ条件を表す値オブジェクトです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| field | String | フィールド名 | 必須 |
| operator | FilterOperator | 演算子 | 必須 |
| value | Object | 比較値 | - |
| values | List\<Object\> | 複数比較値（IN等で使用） | - |
| lowerBound | Object | 下限値（BETWEEN等で使用） | - |
| upperBound | Object | 上限値（BETWEEN等で使用） | - |

## 4. ドメイン関連図

```
SearchQuery ──────┐
                  │
                  ▼
             SearchResult
                  │
                  ├───────────────────────┐
                  │                       │
                  ▼                       ▼
          SearchResultItem       ResourceTypeResult
                                         │
                                         ▼
                                     FacetValue
                  
SearchHistory ──── SearchQuery
                  
SavedSearch ──────┘

SearchSuggestion

PopularSearch
```

## 5. 重要なビジネスルール

### 5.1 検索権限ルール

- ユーザーは自身がアクセス権限を持つリソースのみを検索結果として受け取る
- 検索クエリの実行前に権限フィルタを適用する
- 権限のないリソースは検索インデックスから除外するのではなく、検索時にフィルタリングする

### 5.2 検索結果ランキングルール

検索結果のランキング（スコア計算）は以下の要素に基づいて行われます：

1. キーワードマッチング（最重要）
   - タイトルフィールドへの完全一致：最高スコア
   - タイトルフィールドへの部分一致：高スコア
   - 説明フィールドへの一致：中スコア
   - その他フィールドへの一致：低スコア

2. フィールド重み付け
   - タイトル：3.0
   - サブタイトル：2.0
   - 説明：1.5
   - スキル/タグ：1.2
   - その他：1.0

3. 鮮度（最終更新日）
   - 3ヶ月以内：1.5倍
   - 1年以内：1.2倍
   - 1年超：1.0倍

4. ユーザー関連性
   - ユーザーが以前閲覧したリソース：1.3倍
   - ユーザーの所属組織関連リソース：1.2倍

### 5.3 検索履歴保持ルール

1. 検索履歴は以下の条件で保持されます：
   - 個人ユーザー：最大100件、6ヶ月間
   - 管理者：統計目的で最大1000件、1年間

2. 検索履歴の自動削除は以下のタイミングで行われます：
   - 最大件数超過時：古いものから削除
   - 保持期間経過時：期間経過したものを一括削除

3. ユーザーは自分の検索履歴を手動で削除可能

### 5.4 インデックス更新ルール

1. リアルタイム更新
   - 新規作成：即時インデックス化（5分以内）
   - 更新：即時インデックス更新（5分以内）
   - 削除：即時インデックス削除（5分以内）

2. バッチ更新
   - 大量データ変更時：バッチプロセスで一括更新
   - 定期インデックス再構築：日次（低負荷時間帯）

3. 更新エラー処理
   - 3回まで自動リトライ
   - リトライ失敗時はエラーログに記録し管理者通知

### 5.5 日本語検索ルール

1. 形態素解析
   - 日本語テキストを適切な単位で分割
   - 名詞、動詞、形容詞などの意味を持つ要素を抽出

2. 表記ゆれ対応
   - ひらがな/カタカナ/漢字の異表記を同一視
   - 全角/半角文字の正規化
   - 英数字の大文字/小文字の同一視

3. 同義語対応
   - 同義語辞書に基づく検索クエリ拡張
   - 「エンジニア」と「技術者」など業界用語の同一視

### 5.6 検索サジェストルール

1. サジェスト候補の生成基準
   - 3文字以上の入力で候補表示開始
   - 最大10件の候補を表示
   - 候補は関連度順にソート

2. サジェストソース優先順位
   - ユーザー自身の検索履歴（最優先）
   - システム全体の人気検索キーワード
   - インデックス内の頻出キーワード
   - コンテキスト依存キーワード

3. 不適切な候補の除外
   - NGワードリストに基づく除外
   - 検索ヒット数0件のキーワードは候補から除外

## 6. インターフェース概要

ドメインモデルの観点から見た主要なインターフェースの概要です。詳細は「インターフェース定義」ドキュメントを参照してください。

### 6.1 SearchService

```java
public interface SearchService {
    SearchResult search(SearchQuery query);
    SearchResult globalSearch(String keyword, List<String> resourceTypes, int page, int pageSize);
    SearchResult filterSearch(String resourceType, Map<String, Object> filters, 
                             String sortField, SortOrder sortOrder, int page, int pageSize);
}
```

### 6.2 SearchHistoryService

```java
public interface SearchHistoryService {
    void saveSearchHistory(UUID userId, SearchQuery query, int resultCount);
    List<SearchHistory> getUserSearchHistory(UUID userId, int limit);
    void deleteSearchHistory(UUID userId, UUID historyId);
    void deleteAllSearchHistory(UUID userId);
}
```

### 6.3 SavedSearchService

```java
public interface SavedSearchService {
    SavedSearch createSavedSearch(SavedSearch savedSearch);
    SavedSearch updateSavedSearch(UUID id, SavedSearch savedSearch);
    void deleteSavedSearch(UUID id);
    SavedSearch getSavedSearch(UUID id);
    List<SavedSearch> getUserSavedSearches(UUID userId);
}
```

### 6.4 SearchSuggestionService

```java
public interface SearchSuggestionService {
    List<SearchSuggestion> getSuggestions(String prefix, SuggestionType type, 
                                        String resourceType, int limit);
    List<PopularSearch> getPopularSearches(Period period, int limit);
}
```