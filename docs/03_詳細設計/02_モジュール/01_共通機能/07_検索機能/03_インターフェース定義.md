# 検索機能 インターフェース定義

## 1. インターフェース概要

検索機能モジュールは、システム全体に検索機能を提供するための複数のインターフェースを定義しています。これらのインターフェースを通じて、他のモジュールは検索操作を実行し、検索結果を取得することができます。また、検索履歴の管理や検索候補の提案などの機能もサポートします。

### 1.1 設計方針

- **統一性**: 様々なリソースタイプに対して一貫した検索インターフェースを提供
- **拡張性**: 新しいリソースタイプや検索機能の追加が容易な設計
- **疎結合**: 業務モジュールとの依存関係を最小限に抑えた設計
- **パフォーマンス**: 大量データに対する高速な検索を実現する非同期処理
- **安全性**: 権限に基づく適切なアクセス制御の実施

### 1.2 パッケージ構成

```
jp.co.sesmanager.common.search
  ├── api          // 公開REST APIコントローラー（Spring MVC）
  ├── dto          // データ転送オブジェクト
  ├── service      // サービスインターフェースと実装
  ├── exception    // 例外クラス
  ├── event        // Spring Applicationイベント関連
  └── config       // Spring Configuration
```

## 2. 提供インターフェース

### 2.1 SearchService

検索の実行と結果の取得を行うための主要インターフェースです。Spring Data Elasticsearchを活用して実装されます。

```java
/**
 * 検索サービスのインターフェース
 * Spring Data Elasticsearchを活用した検索機能を提供
 */
@Service
public interface SearchService {
    /**
     * 検索クエリを実行して結果を取得
     * @param query 検索クエリDTO
     * @return 検索結果DTO
     * @throws SearchException 検索実行時のエラー
     */
    SearchResultDto search(SearchQueryDto query);
    
    /**
     * キーワードによる全文検索を実行
     * @param keyword 検索キーワード
     * @param resourceTypes 検索対象のリソースタイプ（nullの場合は全リソースタイプ）
     * @param page ページ番号（0始まり）
     * @param pageSize ページサイズ
     * @return 検索結果DTO
     * @throws SearchException 検索実行時のエラー
     */
    SearchResultDto globalSearch(String keyword, List<String> resourceTypes, 
                             int page, int pageSize);
    
    /**
     * 特定のリソースタイプに対してフィルタ検索を実行
     * @param resourceType リソースタイプ
     * @param filters フィルタ条件
     * @param sortField ソートフィールド
     * @param sortOrder ソート順序
     * @param page ページ番号（0始まり）
     * @param pageSize ページサイズ
     * @return 検索結果DTO
     * @throws SearchException 検索実行時のエラー
     */
    SearchResultDto filterSearch(String resourceType, Map<String, Object> filters, 
                              String sortField, SortOrder sortOrder, 
                              int page, int pageSize);
    
    /**
     * 検索を非同期で実行
     * @param query 検索クエリDTO
     * @return 検索結果の非同期取得用CompletableFuture
     */
    CompletableFuture<SearchResultDto> searchAsync(SearchQueryDto query);
    
    /**
     * 検索の実行状態を取得
     * @param searchId 検索ID
     * @return 検索状態
     */
    SearchStatus getSearchStatus(String searchId);
    
    /**
     * 進行中の検索をキャンセル
     * @param searchId 検索ID
     * @return キャンセル成功の場合はtrue
     */
    boolean cancelSearch(String searchId);
}
```

### 2.2 SearchHistoryService

ユーザーの検索履歴を管理するためのインターフェースです。Spring Data JDBCを使用して検索履歴をデータベースに保存します。

```java
/**
 * 検索履歴サービスのインターフェース
 * Spring Data JDBCによる検索履歴の永続化を行う
 */
@Service
public interface SearchHistoryService {
    /**
     * 検索履歴を保存
     * @param userId ユーザーID
     * @param query 検索クエリ
     * @param resultCount 検索結果件数
     * @return 作成された検索履歴のID
     * @throws HistoryPersistenceException 履歴保存時のエラー
     */
    UUID saveSearchHistory(UUID userId, SearchQueryDto query, int resultCount);
    
    /**
     * 特定のユーザーの検索履歴を取得
     * @param userId ユーザーID
     * @param limit 取得する最大件数
     * @return 検索履歴DTOのリスト
     * @throws HistoryRetrievalException 履歴取得時のエラー
     */
    List<SearchHistoryDto> getUserSearchHistory(UUID userId, int limit);
    
    /**
     * 特定の検索履歴を削除
     * @param userId ユーザーID
     * @param historyId 検索履歴ID
     * @throws HistoryDeletionException 履歴削除時のエラー
     */
    void deleteSearchHistory(UUID userId, UUID historyId);
    
    /**
     * ユーザーの全検索履歴を削除
     * @param userId ユーザーID
     * @throws HistoryDeletionException 履歴削除時のエラー
     */
    void deleteAllSearchHistory(UUID userId);
    
    /**
     * 人気の検索キーワードを取得
     * @param days 集計期間(日数)
     * @param limit 取得する最大件数
     * @return 人気の検索キーワードと件数のマップ
     */
    Map<String, Integer> getPopularSearchKeywords(int days, int limit);
}
```

### 2.3 SavedSearchService

ユーザーが保存した検索条件を管理するためのインターフェースです。Spring Data JDBCを使用して検索条件をデータベースに保存します。

```java
/**
 * 保存済み検索サービスのインターフェース
 * Spring Data JDBCによる検索条件の永続化と管理を行う
 */
@Service
public interface SavedSearchService {
    /**
     * 保存済み検索を作成
     * @param savedSearch 保存する検索条件
     * @return 作成された保存済み検索
     * @throws SavedSearchException 検索条件保存時のエラー
     */
    SavedSearchDto createSavedSearch(SavedSearchDto savedSearch);
    
    /**
     * 保存済み検索を更新
     * @param id 保存済み検索ID
     * @param savedSearch 更新内容
     * @return 更新された保存済み検索
     * @throws SavedSearchException 検索条件更新時のエラー
     */
    SavedSearchDto updateSavedSearch(UUID id, SavedSearchDto savedSearch);
    
    /**
     * 保存済み検索を削除
     * @param id 保存済み検索ID
     * @throws SavedSearchException 検索条件削除時のエラー
     */
    void deleteSavedSearch(UUID id);
    
    /**
     * 保存済み検索を取得
     * @param id 保存済み検索ID
     * @return 保存済み検索
     * @throws SavedSearchNotFoundException 検索条件取得時のエラー
     */
    SavedSearchDto getSavedSearch(UUID id);
    
    /**
     * ユーザーの保存済み検索一覧を取得
     * @param userId ユーザーID
     * @return 保存済み検索のリスト
     */
    List<SavedSearchDto> getUserSavedSearches(UUID userId);
    
    /**
     * 共有されている保存済み検索一覧を取得
     * @return 共有されている保存済み検索のリスト
     */
    List<SavedSearchDto> getSharedSavedSearches();
}
```

### 2.4 SearchSuggestionService

検索候補を提供するためのインターフェースです。Spring Cacheを活用して頻繁に使用されるサジェスト結果をキャッシュします。

```java
/**
 * 検索サジェストサービスのインターフェース
 * Spring Cacheを活用した効率的なサジェスト提供
 */
@Service
public interface SearchSuggestionService {
    /**
     * 検索プレフィックスに基づくサジェストを提供
     * @param prefix 検索プレフィックス
     * @param type サジェストのタイプ（履歴、人気、インデックス、コンテキスト）
     * @param resourceType リソースタイプ（特定のリソースタイプに限定する場合）
     * @param limit 取得最大件数
     * @return サジェスト候補のリスト
     * @throws SuggestionException サジェスト取得時のエラー
     */
    @Cacheable(value = "suggestionCache", key = "#prefix + '_' + #type + '_' + #resourceType + '_' + #limit")
    List<SearchSuggestionDto> getSuggestions(String prefix, SuggestionType type, 
                                        String resourceType, int limit);
    
    /**
     * ユーザーの検索履歴に基づくサジェストを提供
     * @param userId ユーザーID
     * @param prefix 検索プレフィックス
     * @param limit 取得最大件数
     * @return サジェスト候補のリスト
     */
    List<SearchSuggestionDto> getUserHistorySuggestions(UUID userId, String prefix, int limit);
    
    /**
     * 人気の検索ワードに基づくサジェストを提供
     * @param period 集計期間("daily", "weekly", "monthly")
     * @param limit 取得最大件数
     * @return 人気の検索のリスト
     */
    @Cacheable(value = "popularSearchCache", key = "#period + '_' + #limit")
    List<PopularSearchDto> getPopularSearches(String period, int limit);
}
```

### 2.5 SearchIndexService

検索インデックスを管理するためのインターフェースです。Spring Data Elasticsearchを活用してインデックスを管理します。

```java
/**
 * 検索インデックス管理サービスのインターフェース
 * Spring Data Elasticsearchによるインデックス管理を行う
 */
@Service
public interface SearchIndexService {
    /**
     * 特定のリソースをインデックスに追加または更新
     * @param resourceType リソースタイプ
     * @param resourceId リソースID
     * @param indexData インデックス化するデータ
     * @throws IndexingException インデックス更新時のエラー
     */
    void indexResource(String resourceType, String resourceId, Map<String, Object> indexData);
    
    /**
     * 特定のリソースをインデックスから削除
     * @param resourceType リソースタイプ
     * @param resourceId リソースID
     * @throws IndexingException インデックス削除時のエラー
     */
    void removeFromIndex(String resourceType, String resourceId);
    
    /**
     * 指定したリソースタイプのインデックスを再構築
     * @param resourceType リソースタイプ
     * @return インデックス再構築のジョブID
     * @throws IndexRebuildException インデックス再構築時のエラー
     */
    String rebuildIndex(String resourceType);
    
    /**
     * インデックス再構築ジョブの状態を取得
     * @param jobId ジョブID
     * @return 進行状況(0.0〜1.0)
     */
    double getIndexingProgress(String jobId);
    
    /**
     * 非同期でインデックスを最適化
     * @param resourceType リソースタイプ
     * @return 完了を表すCompletableFuture
     */
    CompletableFuture<Void> optimizeIndex(String resourceType);
    
    /**
     * 利用可能なすべてのインデックスの情報を取得
     * @return インデックスメタデータのリスト
     * @throws MetadataRetrievalException メタデータ取得時のエラー
     */
    List<IndexMetadataDto> getIndexMetadata();
    
    /**
     * 同義語辞書を更新
     * @param synonymMappings 同義語マッピング
     * @throws SynonymUpdateException 同義語辞書更新時のエラー
     */
    void updateSynonyms(Map<String, List<String>> synonymMappings);
}
```

## 3. 要求インターフェース

### 3.1 AuthenticationService

認証と権限情報を取得するためのインターフェースです。認証認可モジュールから提供されます。Spring Securityと統合して利用します。

```java
/**
 * 認証・認可サービスのインターフェース
 * Spring Securityと統合して認証・認可情報を提供
 */
public interface AuthenticationService {
    /**
     * 現在のユーザーコンテキスト情報を取得
     * @return ユーザーコンテキスト情報
     */
    UserContext getCurrentUserContext();
    
    /**
     * 指定されたユーザーが特定のリソースにアクセスできるかどうかを判定
     * @param userId ユーザーID
     * @param resourceType リソースタイプ
     * @param resourceId リソースID
     * @param permission 必要な権限
     * @return アクセス可能な場合はtrue
     */
    boolean canAccessResource(UUID userId, String resourceType, String resourceId, String permission);
    
    /**
     * 現在のユーザーが特定のリソースタイプに対する検索権限を持っているかを判定
     * @param resourceType リソースタイプ
     * @return 検索権限がある場合はtrue
     */
    boolean canSearchResourceType(String resourceType);
    
    /**
     * 指定されたユーザーがアクセス可能なリソースタイプの一覧を取得
     * @param userId ユーザーID
     * @return アクセス可能なリソースタイプのリスト
     */
    List<String> getAccessibleResourceTypes(UUID userId);
}
```

### 3.2 ResourceDataProvider

各業務モジュールが検索対象データを提供するためのインターフェースです。各業務モジュールはこのインターフェースを実装します。Spring EventListenerを活用して実装します。

```java
/**
 * リソースデータプロバイダーのインターフェース
 * 各業務モジュールが実装し、検索対象データを提供
 */
public interface ResourceDataProvider {
    /**
     * このプロバイダーが提供するリソースタイプを返す
     * @return リソースタイプ識別子
     */
    String getResourceType();
    
    /**
     * リソースタイプの表示名を返す
     * @return リソースタイプの表示名
     */
    String getResourceTypeDisplayName();
    
    /**
     * インデックス対象のフィールド情報を提供
     * @return フィールド名とその型のマッピング
     */
    Map<String, Class<?>> getIndexFieldInfo();
    
    /**
     * 全リソースデータをストリーミングで提供
     * @param consumer データを受け取るコンシューマー
     */
    void streamAllResources(Consumer<Map<String, Object>> consumer);
    
    /**
     * 指定されたIDのリソースデータを取得
     * @param resourceId リソースID
     * @return リソースデータのマップ
     */
    Map<String, Object> getResourceById(String resourceId);
    
    /**
     * 指定された期間に更新されたリソースIDのリストを取得
     * @param startTimestamp 開始タイムスタンプ
     * @param endTimestamp 終了タイムスタンプ
     * @return 更新されたリソースIDのリスト
     */
    List<String> getUpdatedResourceIds(LocalDateTime startTimestamp, LocalDateTime endTimestamp);
    
    /**
     * 指定されたユーザーがアクセス可能なリソースIDのリストを取得
     * @param userId ユーザーID
     * @return アクセス可能なリソースIDのリスト
     */
    List<String> getAccessibleResourceIds(UUID userId);
    
    /**
     * リソースのハイライト対象フィールドを返す
     * @return ハイライト対象フィールドのリスト
     */
    List<String> getHighlightFields();
}
```

### 3.3 EntityChangeNotifier

業務エンティティの変更通知を受け取るためのインターフェースです。Spring ApplicationEventを利用して実装します。

```java
/**
 * エンティティ変更通知のインターフェース
 * Spring ApplicationEventを活用してエンティティ変更を通知
 */
public interface EntityChangeNotifier {
    /**
     * エンティティ作成イベントを通知
     * @param entityType エンティティタイプ
     * @param entityId エンティティID
     * @param attributes エンティティの属性
     */
    void notifyCreated(String entityType, String entityId, Map<String, Object> attributes);
    
    /**
     * エンティティ更新イベントを通知
     * @param entityType エンティティタイプ
     * @param entityId エンティティID
     * @param updatedAttributes 更新された属性
     */
    void notifyUpdated(String entityType, String entityId, Map<String, Object> updatedAttributes);
    
    /**
     * エンティティ削除イベントを通知
     * @param entityType エンティティタイプ
     * @param entityId エンティティID
     */
    void notifyDeleted(String entityType, String entityId);
}
```

## 4. データ交換モデル

### 4.1 SearchQueryDto

検索クエリを表すデータ転送オブジェクトです。Spring Data Elasticsearchのクエリに変換されます。

```java
/**
 * 検索クエリを表すDTO
 * Spring Data Elasticsearchのクエリに変換される
 */
@Data
@Builder
public class SearchQueryDto {
    /**
     * 検索クエリID
     */
    private UUID id;
    
    /**
     * キーワード検索クエリ
     */
    @Size(max = 500)
    private String keywordQuery;
    
    /**
     * 検索対象のリソースタイプリスト
     */
    private List<String> resourceTypes;
    
    /**
     * フィルタ条件のマップ
     */
    private Map<String, Object> filters;
    
    /**
     * ソートフィールド名
     */
    private String sortField;
    
    /**
     * ソート順序
     */
    private SortOrder sortOrder;
    
    /**
     * ページ番号(0始まり)
     */
    @Min(0)
    private int page;
    
    /**
     * ページサイズ(1〜100)
     */
    @Min(1)
    @Max(100)
    private int pageSize;
    
    /**
     * リソースタイプでグループ化するかのフラグ
     */
    private boolean groupByResourceType;
    
    /**
     * 検索履歴に保存するかのフラグ
     */
    private boolean saveToHistory;
}
```

### 4.2 SearchResultDto

検索結果を表すデータ転送オブジェクトです。Spring Data Elasticsearchの検索結果から変換されます。

```java
/**
 * 検索結果を表すDTO
 * Spring Data Elasticsearchの検索結果から変換される
 */
@Data
public class SearchResultDto {
    /**
     * 検索結果ID
     */
    private UUID id;
    
    /**
     * 対応する検索クエリID
     */
    private UUID queryId;
    
    /**
     * 検索にマッチした総件数
     */
    private long totalHits;
    
    /**
     * 検索実行時間(ミリ秒)
     */
    private long executionTimeMs;
    
    /**
     * リソースタイプ別の検索結果
     */
    private Map<String, ResourceTypeResultDto> groupedResults;
    
    /**
     * 検索結果アイテムのリスト
     */
    private List<SearchResultItemDto> items;
    
    /**
     * ファセット情報のマップ
     */
    private Map<String, List<FacetValueDto>> facets;
    
    /**
     * 現在のページ番号
     */
    private int currentPage;
    
    /**
     * ページサイズ
     */
    private int pageSize;
    
    /**
     * 総ページ数
     */
    private int totalPages;
    
    /**
     * 検索実行日時
     */
    private ZonedDateTime timestamp;
}
```

### 4.3 SearchResultItemDto

検索結果の個々のアイテムを表すデータ転送オブジェクトです。

```java
/**
 * 検索結果の個々のアイテムを表すDTO
 */
@Data
public class SearchResultItemDto {
    /**
     * アイテムID
     */
    private String id;
    
    /**
     * リソースタイプ
     */
    private String resourceType;
    
    /**
     * タイトル
     */
    private String title;
    
    /**
     * サブタイトル
     */
    private String subtitle;
    
    /**
     * 説明
     */
    private String description;
    
    /**
     * リソースへのURL
     */
    private String url;
    
    /**
     * ハイライト情報
     */
    private Map<String, List<String>> highlights;
    
    /**
     * リソースの属性マップ
     */
    private Map<String, Object> attributes;
    
    /**
     * 検索結果スコア
     */
    private float score;
}
```

### 4.4 ResourceTypeResultDto

特定のリソースタイプに対する検索結果を表すデータ転送オブジェクトです。

```java
/**
 * 特定のリソースタイプに対する検索結果を表すDTO
 */
@Data
public class ResourceTypeResultDto {
    /**
     * リソースタイプ
     */
    private String resourceType;
    
    /**
     * 表示名
     */
    private String displayName;
    
    /**
     * このリソースタイプにマッチした総件数
     */
    private long totalHits;
    
    /**
     * 検索結果アイテムのリスト
     */
    private List<SearchResultItemDto> items;
    
    /**
     * このリソースタイプのファセット情報
     */
    private Map<String, List<FacetValueDto>> facets;
}
```

### 4.5 FacetValueDto

検索結果のファセット情報の値を表すデータ転送オブジェクトです。

```java
/**
 * 検索結果のファセット情報の値を表すDTO
 */
@Data
public class FacetValueDto {
    /**
     * ファセット値
     */
    private String value;
    
    /**
     * 表示名
     */
    private String displayName;
    
    /**
     * 該当するアイテム数
     */
    private int count;
    
    /**
     * 選択状態
     */
    private boolean selected;
}
```

### 4.6 SearchHistoryDto

ユーザーの検索履歴を表すデータ転送オブジェクトです。Spring Data JDBCエンティティから変換されます。

```java
/**
 * ユーザーの検索履歴を表すDTO
 * Spring Data JDBCエンティティから変換される
 */
@Data
public class SearchHistoryDto {
    /**
     * 検索履歴ID
     */
    private UUID id;
    
    /**
     * ユーザーID
     */
    private UUID userId;
    
    /**
     * キーワード検索クエリ
     */
    private String keywordQuery;
    
    /**
     * 検索対象のリソースタイプリスト
     */
    private List<String> resourceTypes;
    
    /**
     * フィルタ条件
     */
    private Map<String, Object> filters;
    
    /**
     * 検索結果件数
     */
    private int resultCount;
    
    /**
     * 検索実行日時
     */
    private ZonedDateTime searchedAt;
}
```

### 4.7 SavedSearchDto

ユーザーが保存した検索条件を表すデータ転送オブジェクトです。Spring Data JDBCエンティティから変換されます。

```java
/**
 * ユーザーが保存した検索条件を表すDTO
 * Spring Data JDBCエンティティから変換される
 */
@Data
public class SavedSearchDto {
    /**
     * 保存済み検索ID
     */
    private UUID id;
    
    /**
     * 検索条件の名前(1〜50文字)
     */
    @NotBlank
    @Size(min = 1, max = 50)
    private String name;
    
    /**
     * 検索条件の説明(最大255文字)
     */
    @Size(max = 255)
    private String description;
    
    /**
     * ユーザーID
     */
    private UUID userId;
    
    /**
     * 保存された検索クエリ
     */
    @NotNull
    private SearchQueryDto query;
    
    /**
     * 共有フラグ
     */
    private boolean isShared;
    
    /**
     * 作成日時
     */
    private ZonedDateTime createdAt;
    
    /**
     * 更新日時
     */
    private ZonedDateTime updatedAt;
}
```

### 4.8 SearchSuggestionDto

検索サジェスト候補を表すデータ転送オブジェクトです。Spring Cacheと連携します。

```java
/**
 * 検索サジェスト候補を表すDTO
 * Spring Cacheによりキャッシュされる
 */
@Data
@Cacheable
public class SearchSuggestionDto {
    /**
     * キーワード
     */
    private String keyword;
    
    /**
     * サジェストのタイプ
     */
    private SuggestionType type;
    
    /**
     * リソースタイプ
     */
    private String resourceType;
    
    /**
     * 出現頻度
     */
    private int frequency;
    
    /**
     * 表示テキスト
     */
    private String displayText;
}
```

### 4.9 PopularSearchDto

人気の検索キーワードを表すデータ転送オブジェクトです。Spring Cacheと連携します。

```java
/**
 * 人気の検索キーワードを表すDTO
 * Spring Cacheによりキャッシュされる
 */
@Data
@Cacheable
public class PopularSearchDto {
    /**
     * キーワード
     */
    private String keyword;
    
    /**
     * 検索回数
     */
    private int count;
    
    /**
     * 関連するリソースタイプリスト
     */
    private List<String> resourceTypes;
    
    /**
     * 集計期間
     */
    private String period;
}
```

### 4.10 IndexMetadataDto

検索インデックスのメタデータを表すデータ転送オブジェクトです。Spring Data Elasticsearchから取得したインデックス情報から変換されます。

```java
/**
 * 検索インデックスのメタデータを表すDTO
 * Spring Data Elasticsearchから取得した情報に基づく
 */
@Data
public class IndexMetadataDto {
    /**
     * インデックス名
     */
    private String name;
    
    /**
     * リソースタイプ
     */
    private String resourceType;
    
    /**
     * インデックス内のドキュメント数
     */
    private long documentCount;
    
    /**
     * インデックスサイズ(バイト)
     */
    private long sizeInBytes;
    
    /**
     * インデックス作成日時
     */
    private ZonedDateTime createdAt;
    
    /**
     * 最終更新日時
     */
    private ZonedDateTime lastUpdatedAt;
    
    /**
     * フィールドタイプのマップ
     */
    private Map<String, String> fieldTypes;
    
    /**
     * インデックスの状態
     */
    private String status;
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

#### 5.1.1 応答時間

- **検索API応答時間**:
  - 通常検索: 平均1秒以内、最大3秒
  - キーワード検索: 平均1.5秒以内、最大4秒
  - サジェスト: 平均100ms以内、最大200ms

- **スループット**:
  - ピーク時処理能力: 20 TPS（トランザクション/秒）
  - 通常時処理能力: 5 TPS

#### 5.1.2 リソース利用

- **メモリ使用**:
  - 検索サービス: 最大2GB
  - インデックスサービス: 最大4GB

- **CPU使用**:
  - 検索処理中: 最大4コア
  - インデックス更新中: 最大2コア

#### 5.1.3 キャッシュ戦略

- **検索結果キャッシュ**:
  - Spring Cacheによる実装
  - 有効期間: 5分
  - 最大エントリ数: 1000
  - キャッシュヒット率目標: 50%以上

- **サジェストキャッシュ**:
  - Spring Cacheによる実装
  - 有効期間: 1時間
  - 最大エントリ数: 10000

### 5.2 トランザクション要件

#### 5.2.1 検索処理の原子性

- 検索処理自体は@Transactionalアノテーションの対象外
- 検索履歴・保存済み検索の登録/更新/削除は@Transactionalアノテーションにより原子的に実行

#### 5.2.2 インデックス更新の整合性

- リソース変更の検知から5分以内にインデックス反映
- 更新処理の失敗時は@Retryableによりリトライ（3回まで自動リトライ）
- インデックス更新中の検索は更新前のインデックスを使用（Elasticsearchのエイリアス機能を活用）

#### 5.2.3 権限反映のタイミング

- 権限変更はSpring ApplicationEventを通じて通知
- 権限変更は5分以内に検索結果に反映
- 権限拡大: 即時反映
- 権限縮小: 最大5分の遅延を許容

### 5.3 セキュリティ要件

#### 5.3.1 認証・認可

- 全APIは@PreAuthorizeにより認証済みユーザーのみアクセス可能
- 検索結果はユーザーの権限に基づきフィルタリング（@PostFilter）
- 管理者機能（インデックス管理など）は@PreAuthorize("hasRole('ADMIN')")により管理者ロールのみアクセス可能

#### 5.3.2 データ保護

- 検索クエリと結果はSpring Securityの適切な設定により保護
- 機密データのインデックス化を回避（@JsonIgnoreなどを活用）
- 検索履歴にセンシティブな情報を含めない（ヘルパーメソッドでサニタイズ）

#### 5.3.3 監査

- 以下の操作をSpring Actuatorによる監査ログに記録
  - 検索履歴の削除
  - 保存済み検索の共有設定変更
  - インデックス再構築
  - 同義語辞書更新

### 5.4 可用性要件

#### 5.4.1 稼働率

- 検索サービス: 99.9%（月間最大43分のダウンタイム）
- インデックス更新: 99.5%（月間最大3.7時間のダウンタイム）

#### 5.4.2 障害対策

- 検索エンジンの冗長化（Spring Data Elasticsearchクラスタ設定）
- インデックス更新の非同期処理化（@Async）
- 検索サービス障害時もCircuit Breakerによりシステムの他機能は継続動作
- インデックス破損時の自動再構築（Spring Data Elasticsearchのインデックス管理機能）

#### 5.4.3 バックアップ・リカバリ

- インデックスの日次バックアップ（Spring Batchジョブ）
- インデックス復旧時間: 1時間以内（Spring Data Elasticsearchのインデックス管理機能）
- 検索履歴・保存済み検索のデータはSpring Data JDBCによる通常のDBバックアップに含める