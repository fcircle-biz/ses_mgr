# 検索機能 インターフェース定義

## 1. インターフェース概要

検索機能モジュールは、システム全体に検索機能を提供するための複数のインターフェースを定義しています。これらのインターフェースを通じて、他のモジュールは検索操作を実行し、検索結果を取得することができます。また、検索履歴の管理や検索候補の提案などの機能もサポートします。

### 1.1 設計方針

- **統一性**: 様々なリソースタイプに対して一貫した検索インターフェースを提供
- **拡張性**: 新しいリソースタイプや検索機能の追加が容易な設計
- **疎結合**: 業務モジュールとの依存関係を最小限に抑えた設計
- **パフォーマンス**: 大量データに対する高速な検索を実現する非同期処理
- **安全性**: 権限に基づく適切なアクセス制御の実施

### 1.2 パッケージ構成

```
jp.co.sesmanager.common.search
  ├── api          // 公開API
  ├── dto          // データ転送オブジェクト
  ├── service      // サービスインターフェース
  ├── exception    // 例外クラス
  ├── event        // イベント関連
  └── config       // 設定クラス
```

## 2. 提供インターフェース

### 2.1 SearchService

検索の実行と結果の取得を行うための主要インターフェースです。

**SearchService インターフェース**

検索の実行と結果の取得を行うための主要インターフェースです。

**主要メソッド**

- **search**: 検索クエリを実行して結果を取得
  - 引数: 検索クエリDTO
  - 戻り値: 検索結果DTO
  - 例外: 検索実行時のエラー

- **globalSearch**: キーワードによる全文検索を実行
  - 引数: 検索キーワード、検索対象のリソースタイプ、ページ番号、ページサイズ
  - 戻り値: 検索結果DTO
  - 例外: 検索実行時のエラー

- **filterSearch**: 特定のリソースタイプに対してフィルタ検索を実行
  - 引数: リソースタイプ、フィルタ条件、ソートフィールド、ソート順序、ページ番号、ページサイズ
  - 戻り値: 検索結果DTO
  - 例外: 検索実行時のエラー

- **searchAsync**: 検索を非同期で実行
  - 引数: 検索クエリDTO
  - 戻り値: 検索結果の非同期取得用Future

- **getSearchStatus**: 検索の実行状態を取得
  - 引数: 検索ID
  - 戻り値: 検索状態

- **cancelSearch**: 進行中の検索をキャンセル
  - 引数: 検索ID
  - 戻り値: キャンセル成功の場合はtrue
```

### 2.2 SearchHistoryService

ユーザーの検索履歴を管理するためのインターフェースです。

**SearchHistoryService インターフェース**

ユーザーの検索履歴を管理するためのインターフェースです。

**主要メソッド**

- **saveSearchHistory**: 検索履歴を保存
  - 引数: ユーザーID、検索クエリ、検索結果件数
  - 戻り値: 作成された検索履歴のID
  - 例外: 履歴保存時のエラー

- **getUserSearchHistory**: 特定のユーザーの検索履歴を取得
  - 引数: ユーザーID、取得する最大件数
  - 戻り値: 検索履歴DTOのリスト
  - 例外: 履歴取得時のエラー

- **deleteSearchHistory**: 特定の検索履歴を削除
  - 引数: ユーザーID、検索履歴ID
  - 例外: 履歴削除時のエラー

- **deleteAllSearchHistory**: ユーザーの全検索履歴を削除
  - 引数: ユーザーID
  - 例外: 履歴削除時のエラー

- **getPopularSearchKeywords**: 人気の検索キーワードを取得
  - 引数: 集計期間(日数)、取得する最大件数
  - 戻り値: 人気の検索キーワードと件数のマップ
```

### 2.3 SavedSearchService

ユーザーが保存した検索条件を管理するためのインターフェースです。

**SavedSearchService インターフェース**

ユーザーが保存した検索条件を管理するためのインターフェースです。

**主要メソッド**

- **createSavedSearch**: 保存済み検索を作成
  - 引数: 保存する検索条件
  - 戻り値: 作成された保存済み検索
  - 例外: 検索条件保存時のエラー

- **updateSavedSearch**: 保存済み検索を更新
  - 引数: 保存済み検索ID、更新内容
  - 戻り値: 更新された保存済み検索
  - 例外: 検索条件更新時のエラー

- **deleteSavedSearch**: 保存済み検索を削除
  - 引数: 保存済み検索ID
  - 例外: 検索条件削除時のエラー

- **getSavedSearch**: 保存済み検索を取得
  - 引数: 保存済み検索ID
  - 戻り値: 保存済み検索
  - 例外: 検索条件取得時のエラー

- **getUserSavedSearches**: ユーザーの保存済み検索一覧を取得
  - 引数: ユーザーID
  - 戻り値: 保存済み検索のリスト
  - 例外: 検索条件取得時のエラー

- **getSharedSavedSearches**: 共有されている保存済み検索一覧を取得
  - 戻り値: 共有されている保存済み検索のリスト
  - 例外: 検索条件取得時のエラー
```

### 2.4 SearchSuggestionService

検索候補を提供するためのインターフェースです。

**SearchSuggestionService インターフェース**

検索候補を提供するためのインターフェースです。

**主要メソッド**

- **getSuggestions**: 検索プレフィックスに基づくサジェストを提供
  - 引数: 検索プレフィックス、サジェストのタイプ、リソースタイプ、取得最大件数
  - 戻り値: サジェスト候補のリスト
  - 例外: サジェスト取得時のエラー

- **getUserHistorySuggestions**: ユーザーの検索履歴に基づくサジェストを提供
  - 引数: ユーザーID、検索プレフィックス、取得最大件数
  - 戻り値: サジェスト候補のリスト
  - 例外: サジェスト取得時のエラー

- **getPopularSearches**: 人気の検索ワードに基づくサジェストを提供
  - 引数: 集計期間("daily", "weekly", "monthly")、取得最大件数
  - 戻り値: 人気の検索のリスト
  - 例外: サジェスト取得時のエラー
```

### 2.5 SearchIndexService

検索インデックスを管理するためのインターフェースです。

**SearchIndexService インターフェース**

検索インデックスを管理するためのインターフェースです。

**主要メソッド**

- **indexResource**: 特定のリソースをインデックスに追加または更新
  - 引数: リソースタイプ、リソースID、インデックス化するデータ
  - 例外: インデックス更新時のエラー

- **removeFromIndex**: 特定のリソースをインデックスから削除
  - 引数: リソースタイプ、リソースID
  - 例外: インデックス削除時のエラー

- **rebuildIndex**: 指定したリソースタイプのインデックスを再構築
  - 引数: リソースタイプ
  - 戻り値: インデックス再構築のジョブID
  - 例外: インデックス再構築時のエラー

- **getIndexingProgress**: インデックス再構築ジョブの状態を取得
  - 引数: ジョブID
  - 戻り値: 進行状況(0.0〜1.0)
  - 例外: 状態取得時のエラー

- **optimizeIndex**: 非同期でインデックスを最適化
  - 引数: リソースタイプ
  - 戻り値: 完了を表すFuture

- **getIndexMetadata**: 利用可能なすべてのインデックスの情報を取得
  - 戻り値: インデックスメタデータのリスト
  - 例外: メタデータ取得時のエラー

- **updateSynonyms**: 同義語辞書を更新
  - 引数: 同義語マッピング
  - 例外: 同義語辞書更新時のエラー
```

## 3. 要求インターフェース

### 3.1 AuthenticationService

認証と権限情報を取得するためのインターフェースです。認証認可モジュールから提供されます。

**AuthenticationService インターフェース**

認証と権限情報を取得するためのインターフェースです。認証認可モジュールから提供されます。

**主要メソッド**

- **getCurrentUserContext**: 現在のユーザーコンテキスト情報を取得
  - 戻り値: ユーザーコンテキスト情報

- **canAccessResource**: 指定されたユーザーが特定のリソースにアクセスできるかどうかを判定
  - 引数: ユーザーID、リソースタイプ、リソースID、必要な権限
  - 戻り値: アクセス可能な場合はtrue

- **canSearchResourceType**: 現在のユーザーが特定のリソースタイプに対する検索権限を持っているかを判定
  - 引数: リソースタイプ
  - 戻り値: 検索権限がある場合はtrue

- **getAccessibleResourceTypes**: 指定されたユーザーがアクセス可能なリソースタイプの一覧を取得
  - 引数: ユーザーID
  - 戻り値: アクセス可能なリソースタイプのリスト
```

### 3.2 ResourceDataProvider

各業務モジュールが検索対象データを提供するためのインターフェースです。各業務モジュールはこのインターフェースを実装します。

**ResourceDataProvider インターフェース**

各業務モジュールが検索対象データを提供するためのインターフェースです。各業務モジュールはこのインターフェースを実装します。

**主要メソッド**

- **getResourceType**: このプロバイダーが提供するリソースタイプを返す
  - 戻り値: リソースタイプ識別子

- **getResourceTypeDisplayName**: リソースタイプの表示名を返す
  - 戻り値: リソースタイプの表示名

- **getIndexFieldInfo**: インデックス対象のフィールド情報を提供
  - 戻り値: フィールド名とその型のマッピング

- **streamAllResources**: 全リソースデータをストリーミングで提供
  - 引数: データを受け取るコンシューマー

- **getResourceById**: 指定されたIDのリソースデータを取得
  - 引数: リソースID
  - 戻り値: リソースデータのマップ

- **getUpdatedResourceIds**: 指定された期間に更新されたリソースIDのリストを取得
  - 引数: 開始タイムスタンプ、終了タイムスタンプ
  - 戻り値: 更新されたリソースIDのリスト

- **getAccessibleResourceIds**: 指定されたユーザーがアクセス可能なリソースIDのリストを取得
  - 引数: ユーザーID
  - 戻り値: アクセス可能なリソースIDのリスト

- **getHighlightFields**: リソースのハイライト対象フィールドを返す
  - 戻り値: ハイライト対象フィールドのリスト
```

### 3.3 EntityChangeNotifier

業務エンティティの変更通知を受け取るためのインターフェースです。

**EntityChangeNotifier インターフェース**

業務エンティティの変更通知を受け取るためのインターフェースです。

**主要メソッド**

- **notifyCreated**: エンティティ作成イベントを通知
  - 引数: エンティティタイプ、エンティティID、エンティティの属性

- **notifyUpdated**: エンティティ更新イベントを通知
  - 引数: エンティティタイプ、エンティティID、更新された属性

- **notifyDeleted**: エンティティ削除イベントを通知
  - 引数: エンティティタイプ、エンティティID
```

## 4. データ交換モデル

### 4.1 SearchQueryDto

検索クエリを表すデータ転送オブジェクトです。

**SearchQueryDto** - 検索クエリを表すデータ転送オブジェクト

**主要属性**
- **id**: 検索クエリID
- **keywordQuery**: キーワード検索クエリ
- **resourceTypes**: 検索対象のリソースタイプリスト
- **filters**: フィルタ条件のマップ
- **sortField**: ソートフィールド名
- **sortOrder**: ソート順序
- **page**: ページ番号(0始まり)
- **pageSize**: ページサイズ(1〜100)
- **groupByResourceType**: リソースタイプでグループ化するかのフラグ
- **saveToHistory**: 検索履歴に保存するかのフラグ
```

### 4.2 SearchResultDto

検索結果を表すデータ転送オブジェクトです。

**SearchResultDto** - 検索結果を表すデータ転送オブジェクト

**主要属性**
- **id**: 検索結果ID
- **queryId**: 対応する検索クエリID
- **totalHits**: 検索にマッチした総件数
- **executionTimeMs**: 検索実行時間(ミリ秒)
- **groupedResults**: リソースタイプ別の検索結果
- **items**: 検索結果アイテムのリスト
- **facets**: ファセット情報のマップ
- **currentPage**: 現在のページ番号
- **pageSize**: ページサイズ
- **totalPages**: 総ページ数
- **timestamp**: 検索実行日時
```

### 4.3 SearchResultItemDto

検索結果の個々のアイテムを表すデータ転送オブジェクトです。

**SearchResultItemDto** - 検索結果の個々のアイテムを表すデータ転送オブジェクト

**主要属性**
- **id**: アイテムID
- **resourceType**: リソースタイプ
- **title**: タイトル
- **subtitle**: サブタイトル
- **description**: 説明
- **url**: リソースへのURL
- **highlights**: ハイライト情報
- **attributes**: リソースの属性マップ
- **score**: 検索結果スコア
```

### 4.4 ResourceTypeResultDto

特定のリソースタイプに対する検索結果を表すデータ転送オブジェクトです。

**ResourceTypeResultDto** - 特定のリソースタイプに対する検索結果を表すデータ転送オブジェクト

**主要属性**
- **resourceType**: リソースタイプ
- **displayName**: 表示名
- **totalHits**: このリソースタイプにマッチした総件数
- **items**: 検索結果アイテムのリスト
- **facets**: このリソースタイプのファセット情報
```

### 4.5 FacetValueDto

検索結果のファセット情報の値を表すデータ転送オブジェクトです。

**FacetValueDto** - 検索結果のファセット情報の値を表すデータ転送オブジェクト

**主要属性**
- **value**: ファセット値
- **displayName**: 表示名
- **count**: 該当するアイテム数
- **selected**: 選択状態
```

### 4.6 SearchHistoryDto

ユーザーの検索履歴を表すデータ転送オブジェクトです。

**SearchHistoryDto** - ユーザーの検索履歴を表すデータ転送オブジェクト

**主要属性**
- **id**: 検索履歴ID
- **userId**: ユーザーID
- **keywordQuery**: キーワード検索クエリ
- **resourceTypes**: 検索対象のリソースタイプリスト
- **filters**: フィルタ条件
- **resultCount**: 検索結果件数
- **searchedAt**: 検索実行日時
```

### 4.7 SavedSearchDto

ユーザーが保存した検索条件を表すデータ転送オブジェクトです。

**SavedSearchDto** - ユーザーが保存した検索条件を表すデータ転送オブジェクト

**主要属性**
- **id**: 保存済み検索ID
- **name**: 検索条件の名前(1〜50文字)
- **description**: 検索条件の説明(最大255文字)
- **userId**: ユーザーID
- **query**: 保存された検索クエリ
- **isShared**: 共有フラグ
- **createdAt**: 作成日時
- **updatedAt**: 更新日時
```

### 4.8 SearchSuggestionDto

検索サジェスト候補を表すデータ転送オブジェクトです。

**SearchSuggestionDto** - 検索サジェスト候補を表すデータ転送オブジェクト

**主要属性**
- **keyword**: キーワード
- **type**: サジェストのタイプ
- **resourceType**: リソースタイプ
- **frequency**: 出現頻度
- **displayText**: 表示テキスト
```

### 4.9 PopularSearchDto

人気の検索キーワードを表すデータ転送オブジェクトです。

**PopularSearchDto** - 人気の検索キーワードを表すデータ転送オブジェクト

**主要属性**
- **keyword**: キーワード
- **count**: 検索回数
- **resourceTypes**: 関連するリソースタイプリスト
- **period**: 集計期間
```

### 4.10 IndexMetadataDto

検索インデックスのメタデータを表すデータ転送オブジェクトです。

**IndexMetadataDto** - 検索インデックスのメタデータを表すデータ転送オブジェクト

**主要属性**
- **name**: インデックス名
- **resourceType**: リソースタイプ
- **documentCount**: インデックス内のドキュメント数
- **sizeInBytes**: インデックスサイズ(バイト)
- **createdAt**: インデックス作成日時
- **lastUpdatedAt**: 最終更新日時
- **fieldTypes**: フィールドタイプのマップ
- **status**: インデックスの状態
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

#### 5.1.1 応答時間

- **検索API応答時間**:
  - 通常検索: 平均1秒以内、最大3秒
  - キーワード検索: 平均1.5秒以内、最大4秒
  - サジェスト: 平均100ms以内、最大200ms

- **スループット**:
  - ピーク時処理能力: 20 TPS（トランザクション/秒）
  - 通常時処理能力: 5 TPS

#### 5.1.2 リソース利用

- **メモリ使用**:
  - 検索サービス: 最大2GB
  - インデックスサービス: 最大4GB

- **CPU使用**:
  - 検索処理中: 最大4コア
  - インデックス更新中: 最大2コア

#### 5.1.3 キャッシュ戦略

- **検索結果キャッシュ**:
  - 有効期間: 5分
  - 最大エントリ数: 1000
  - キャッシュヒット率目標: 50%以上

- **サジェストキャッシュ**:
  - 有効期間: 1時間
  - 最大エントリ数: 10000

### 5.2 トランザクション要件

#### 5.2.1 検索処理の原子性

- 検索処理自体はトランザクション管理対象外
- 検索履歴・保存済み検索の登録/更新/削除は原子的に実行

#### 5.2.2 インデックス更新の整合性

- リソース変更の検知から5分以内にインデックス反映
- 更新処理の失敗時はリトライキューに登録（3回まで自動リトライ）
- インデックス更新中の検索は更新前のインデックスを使用

#### 5.2.3 権限反映のタイミング

- 権限変更は5分以内に検索結果に反映
- 権限拡大: 即時反映
- 権限縮小: 最大5分の遅延を許容

### 5.3 セキュリティ要件

#### 5.3.1 認証・認可

- 全APIは認証済みユーザーのみアクセス可能
- 検索結果はユーザーの権限に基づきフィルタリング
- 管理者機能（インデックス管理など）は管理者ロールのみアクセス可能

#### 5.3.2 データ保護

- 検索クエリと結果はHTTPS通信で暗号化
- 機密データのインデックス化を回避（パスワード、個人情報など）
- 検索履歴にセンシティブな情報を含めない

#### 5.3.3 監査

- 以下の操作を監査ログに記録
  - 検索履歴の削除
  - 保存済み検索の共有設定変更
  - インデックス再構築
  - 同義語辞書更新

### 5.4 可用性要件

#### 5.4.1 稼働率

- 検索サービス: 99.9%（月間最大43分のダウンタイム）
- インデックス更新: 99.5%（月間最大3.7時間のダウンタイム）

#### 5.4.2 障害対策

- 検索エンジンの冗長化（クラスタ構成）
- インデックス更新の非同期処理化
- 検索サービス障害時もシステムの他機能は継続動作
- インデックス破損時の自動再構築

#### 5.4.3 バックアップ・リカバリ

- インデックスの日次バックアップ
- インデックス復旧時間: 1時間以内
- 検索履歴・保存済み検索のデータは通常のDBバックアップに含める

