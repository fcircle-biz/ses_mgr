# 検索機能 概要

## 1. 目的と責務

検索機能モジュールは、SES業務システム全体を横断的に検索し、ユーザーが必要とする情報に素早くアクセスできるようにすることを目的としています。本モジュールは以下の責務を持ちます：

- システム全体のデータを対象とした統一的な検索機能の提供
- 多様な検索方式（キーワード検索、フィルタ検索）のサポート
- 検索結果の適切な整理と表示
- ユーザーの検索履歴管理と効率的な再検索のサポート
- 検索インデックスの管理と最新状態の維持
- 検索性能の最適化と大量データへの対応

## 2. 主要機能

### 2.1 全文検索（Global Search）

全文検索は、システム全体を横断して任意のキーワードに基づいて情報を検索する機能です。

- 単一の検索ボックスからシステム全体の情報を検索
- 検索結果はリソースタイプ（案件、技術者、契約など）ごとにグループ化
- 関連度に基づいた検索結果のランキング
- 検索キーワードのハイライト表示
- 複数キーワードの組み合わせ検索（AND, OR, NOT演算子）
- フレーズ検索やワイルドカード検索のサポート

### 2.2 フィルタ検索（Filter Search）

フィルタ検索は、特定のリソースタイプに対して複数の条件を組み合わせて検索する機能です。

- 複数の検索条件（フィルタ）の組み合わせによる絞り込み
- リソースタイプごとに最適化されたフィルタセット
- 動的なファセット集計と表示
- 検索条件の保存と再利用
- ソート機能（複数フィールド、昇順/降順）
- ページング機能

### 2.3 検索履歴管理（Search History）

ユーザーの検索履歴を管理し、効率的な再検索を支援する機能です。

- ユーザーごとの検索履歴の記録
- 検索クエリと検索結果数の保存
- 検索履歴からの再検索
- 検索履歴の削除
- 人気の検索キーワード集計

### 2.4 検索サジェスト（Search Suggestion）

ユーザーの入力に応じて検索候補を提案する機能です。

- 入力中のテキストに基づく候補表示
- 過去の検索履歴に基づくサジェスト
- 人気の検索キーワードのサジェスト
- コンテキストに応じたサジェスト（現在の画面や状況に関連する候補）

### 2.5 検索インデックス管理（Search Index Management）

検索のためのインデックスを管理し、最新の状態を維持する機能です。

- 検索対象データの変更検知と自動インデックス更新
- 定期的なインデックス再構築
- インデックスの最適化
- 負荷分散と高可用性の確保

## 3. システム内の位置づけ

検索機能モジュールは、システム全体の共通基盤として、他のすべてのモジュールと連携します。主要なモジュールとの関係は以下の通りです：

- **認証認可モジュール**：ユーザーの認証情報と権限に基づいた検索結果のフィルタリング
- **技術者管理モジュール**：技術者情報の検索と技術者データのインデックス管理
- **案件管理モジュール**：案件情報の検索と案件データのインデックス管理
- **契約管理モジュール**：契約情報の検索と契約データのインデックス管理
- **請求支払管理モジュール**：請求・支払情報の検索とデータのインデックス管理
- **ファイル管理モジュール**：添付ファイル内容の検索とファイルデータのインデックス管理

検索モジュールは、各業務モジュールのデータを参照しますが、データの作成・更新・削除は行いません。業務データの変更は各モジュールが担当し、変更通知を受けて検索インデックスを更新する設計となります。

## 4. アーキテクチャ概要

### 4.1 全体アーキテクチャ

検索機能は、以下の層からなるアーキテクチャで構成されます：

```
[ユーザーインターフェース層]
    │
    ▼
[アプリケーション層] ─────┐
    │                   │
    ▼                   ▼
[検索サービス層]    [インデックス管理層]
    │                   │
    ▼                   ▼
[検索エンジン層] ◄────── [データ同期層]
                        │
                        ▼
                [業務データ層]
```

各層の役割：

1. **ユーザーインターフェース層**：検索フォーム、結果表示、フィルタUI等を提供
2. **アプリケーション層**：検索リクエストの受付と結果の整形
3. **検索サービス層**：検索ロジックの実装、結果のフィルタリング、権限制御
4. **インデックス管理層**：検索インデックスの作成と更新
5. **検索エンジン層**：高速な検索処理の実行（Spring Data Elastic）
6. **データ同期層**：業務データの変更検知と検索エンジンへの反映
7. **業務データ層**：業務モジュールが管理するデータストア

### 4.2 テクノロジースタック

| コンポーネント | 採用技術 | バージョン | 用途 |
|--------------|---------|-----------|------|
| 検索エンジン | Elasticsearch | 8.x | 全文検索、インデックス管理 |
| 検索クライアント | Spring Data Elasticsearch | 5.x | Elasticsearchとの連携 |
| ユーザーインターフェース | Thymeleaf + Bootstrap | 5.x | 検索UI、結果表示 |
| API | Spring Boot + REST | 3.2.x | 検索APIの提供 |
| データベース | Spring Data JDBC + PostgreSQL | 16.x | 検索履歴等の保存 |
| キャッシュ | Spring Cache + Redis | 7.x | 検索結果のキャッシュ |
| メッセージング | Spring Cloud Stream + Apache Kafka | 3.x | データ変更イベントの伝達 |

### 4.3 検索プロセスフロー

検索処理の基本的なフローは以下の通りです：

1. **クエリ入力**：ユーザーが検索クエリを入力
2. **クエリ前処理**：
   - キーワード分析
   - クエリ拡張（同義語展開等）
   - アクセス権限フィルターの付加
3. **検索実行**：
   - Elasticsearchへの検索リクエスト発行
   - 複数インデックスに対する並列検索
4. **結果後処理**：
   - アクセス権限に基づくフィルタリング
   - 結果のグループ化
   - ハイライト処理
   - スニペット生成
5. **結果表示**：
   - ページング処理
   - ファセット情報の表示
   - 検索結果の表示

### 4.4 インデックス更新フロー

検索インデックスの更新フローは以下の通りです：

1. **変更検知**：
   - Spring Data JDBCイベントリスナー
   - Spring ApplicationEventの活用
   - Spring Cloud Stream変更イベント
2. **変更イベント発行**：
   - Spring Cloud Streamを使用した変更通知
3. **インデックス更新**：
   - Spring Data Elasticsearchによるインデックス更新
4. **定期的な完全再構築**：
   - Spring Batchによる全インデックスの再構築
   - 非同期処理でシステム負荷を最小化

## 5. ユースケース一覧

### 5.1 全文検索関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| GS1 | キーワード検索 | 単一または複数のキーワードによる全文検索 | 高 |
| GS2 | 検索結果表示 | グループ化された検索結果の表示 | 高 |
| GS3 | 詳細検索 | 高度な演算子を使用した複雑な検索 | 中 |
| GS4 | ハイライト表示 | 検索結果内のキーワードハイライト | 中 |
| GS5 | スニペット表示 | 検索結果の前後コンテキスト表示 | 中 |

### 5.2 フィルタ検索関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| FS1 | 複合条件検索 | 複数の検索条件を組み合わせた検索 | 高 |
| FS2 | ファセット表示 | 検索結果に基づくファセット情報の表示 | 高 |
| FS3 | 検索条件保存 | 検索条件の保存と名前付け | 中 |
| FS4 | 検索条件共有 | 他のユーザーとの検索条件の共有 | 低 |
| FS5 | 動的フィルタ表示 | コンテキストに応じたフィルタの動的表示 | 中 |

### 5.3 検索履歴関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| SH1 | 検索履歴記録 | 検索クエリと結果の履歴保存 | 高 |
| SH2 | 検索履歴表示 | ユーザーの検索履歴一覧表示 | 高 |
| SH3 | 検索履歴から再検索 | 過去の検索条件を使った再検索 | 中 |
| SH4 | 検索履歴削除 | 特定の検索履歴の削除 | 中 |
| SH5 | 検索傾向分析 | 検索履歴に基づく傾向分析（管理者向け） | 低 |

### 5.4 検索サジェスト関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| SS1 | キーワードサジェスト | 入力中のキーワードに基づく候補表示 | 高 |
| SS2 | 履歴ベースサジェスト | 過去の検索履歴に基づく候補表示 | 中 |
| SS3 | 人気キーワードサジェスト | 人気の検索キーワードの候補表示 | 中 |
| SS4 | コンテキスト依存サジェスト | 現在の画面や状況に応じた候補表示 | 低 |

### 5.5 インデックス管理関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| IM1 | インデックス更新 | データ変更に基づくインデックス更新 | 高 |
| IM2 | インデックス完全再構築 | 全データからのインデックス再構築 | 高 |
| IM3 | インデックス最適化 | パフォーマンス向上のためのインデックス最適化 | 中 |
| IM4 | インデックス監視 | インデックスの状態と健全性の監視 | 中 |
| IM5 | 同義語辞書更新 | 検索精度向上のための同義語辞書の更新 | 低 |

## 6. 非機能要件

### 6.1 性能要件

- **応答時間**：
  - 全文検索：平均1秒以内
  - フィルタ検索：平均500ms以内
  - サジェスト表示：100ms以内
- **スループット**：
  - ピーク時20検索/秒の処理
  - 同時ユーザー100人の同時検索をサポート
- **スケーラビリティ**：
  - 1000万レコードの検索に対応
  - 年間50%のデータ増加に対応

### 6.2 可用性要件

- **稼働率**：99.9%以上（計画停止を除く）
- **障害復旧**：
  - RTO（目標復旧時間）：30分以内
  - RPO（目標復旧ポイント）：5分以内
- **バックアップ**：
  - インデックスの日次バックアップ
  - 検索履歴の週次バックアップ

### 6.3 セキュリティ要件

- **認証・認可**：
  - すべての検索APIは認証必須
  - ユーザーの権限に基づいた検索結果のフィルタリング
- **機密情報保護**：
  - 機密データのインデックス除外またはマスキング
  - 検索ログからの個人情報の除去
- **監査ログ**：
  - セキュリティ関連の検索操作のログ記録

### 6.4 運用・保守要件

- **監視**：
  - 検索エンジン健全性の常時監視
  - 検索パフォーマンスの監視と警告
- **メンテナンス**：
  - 週次でのインデックス最適化
  - 月次でのインデックス完全再構築
- **構成管理**：
  - インデックススキーマのバージョン管理
  - 同義語辞書の変更管理