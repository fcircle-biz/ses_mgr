# ロギング機能 ドメインモデル

## 1. 概要

ロギング機能のドメインモデルは、ログデータの構造と特性を定義し、様々なログタイプ間の関係性を表現します。本ドメインモデルでは、ログエントリを中心として、アプリケーションログ、監査ログ、パフォーマンスログ、トレース情報の各概念を整理します。

## 2. 主要エンティティ

### 2.1 LogEntry（ログエントリ）

ログエントリは、システム内で記録される個々のログイベントを表します。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| id | String | ログエントリの一意識別子 | UUID形式、必須 |
| timestamp | DateTime | ログ記録日時 | ISO 8601形式、必須 |
| level | LogLevel | ログレベル | 必須 |
| processId | String | アプリケーションのプロセスID | - |
| threadId | String | 処理スレッドの識別子 | - |
| loggerName | String | ログを出力したクラス/モジュール名 | 必須 |
| message | String | ログメッセージ本文 | 必須 |
| exception | String | 例外情報とスタックトレース | オプション |
| applicationName | String | アプリケーション名 | 必須 |
| environmentName | String | 実行環境（dev/test/prod） | 必須 |
| hostName | String | ホスト名 | - |
| traceInfo | TraceInfo | 分散トレース情報 | オプション |

### 2.2 ApplicationLog（アプリケーションログ）

アプリケーションの動作状況、警告、エラーなどを記録するログです。LogEntryを継承します。

#### 属性（LogEntryに追加）

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| sourceClass | String | ソースコードのクラス名 | - |
| sourceMethod | String | ソースコードのメソッド名 | - |
| sourceLineNumber | Integer | ソースコードの行番号 | - |
| contextData | Map<String, String> | コンテキスト情報 | - |

### 2.3 AuditLog（監査ログ）

セキュリティ関連操作や重要なビジネス操作を記録するログです。LogEntryを継承します。

#### 属性（LogEntryに追加）

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| userId | String | 操作を実行したユーザーID | 必須 |
| username | String | 操作を実行したユーザー名 | - |
| action | String | 実行された操作種別 | 必須 |
| targetType | String | 操作対象のリソース種別 | 必須 |
| targetId | String | 操作対象のリソースID | - |
| status | String | 操作結果のステータス | 必須(SUCCESS/FAILURE) |
| clientIp | String | クライアントIPアドレス | - |
| sessionId | String | セッション識別子 | - |
| roles | List<String> | ユーザーのロール一覧 | - |
| details | String | 操作の詳細情報 | - |

### 2.4 PerformanceLog（パフォーマンスログ）

処理時間、リソース使用量などを記録するログです。LogEntryを継承します。

#### 属性（LogEntryに追加）

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| className | String | 計測対象のクラス名 | 必須 |
| methodName | String | 計測対象のメソッド名 | 必須 |
| durationMs | Long | 処理時間（ミリ秒） | 必須、0以上 |
| status | String | 処理結果ステータス | 必須(SUCCESS/ERROR) |
| thresholdMs | Long | 警告閾値（ミリ秒） | オプション |
| cpuUsage | Double | CPU使用率（%） | オプション |
| memoryUsage | Long | メモリ使用量（バイト） | オプション |
| recordCount | Integer | 処理レコード数 | オプション |

### 2.5 AccessLog（アクセスログ）

API呼び出し、リソースアクセスなどを記録するログです。LogEntryを継承します。

#### 属性（LogEntryに追加）

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| requestId | String | リクエスト識別子 | 必須 |
| httpMethod | String | HTTPメソッド | 必須(GET/POST/PUT/DELETE等) |
| requestUri | String | リクエストURI | 必須 |
| statusCode | Integer | HTTPステータスコード | 必須 |
| userId | String | アクセスユーザーID | オプション |
| clientIp | String | クライアントIPアドレス | - |
| userAgent | String | ユーザーエージェント | - |
| responseTimeMs | Long | レスポンス時間（ミリ秒） | 必須、0以上 |
| contentLength | Long | レスポンスサイズ（バイト） | オプション |

## 3. 値オブジェクト

### 3.1 LogLevel（ログレベル）

ログの重要度レベルを表す列挙型です。

#### 列挙値

- ERROR: エラー状態で、対応が必要
- WARN: 警告状態だが処理は継続可能
- INFO: 通常の動作状況
- DEBUG: 開発時の詳細情報
- TRACE: 最も詳細なデバッグ情報

### 3.2 TraceInfo（トレース情報）

分散トレーシングの情報を保持する値オブジェクトです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| traceId | String | トレースID | 必須、UUID形式 |
| spanId | String | スパンID | 必須 |
| parentSpanId | String | 親スパンID | オプション |
| sampled | Boolean | サンプリング対象かどうか | 必須 |
| baggage | Map<String, String> | トレース伝播用の追加情報 | - |

### 3.3 AuditAction（監査アクション）

監査ログで使用する操作の種類を表す列挙型です。

#### 列挙値

- CREATE: リソース作成操作
- READ: リソース参照操作
- UPDATE: リソース更新操作
- DELETE: リソース削除操作
- LOGIN: ログイン操作
- LOGOUT: ログアウト操作
- GRANT: 権限付与操作
- REVOKE: 権限剥奪操作
- CONFIGURE: 設定変更操作
- APPROVE: 承認操作
- REJECT: 却下操作

### 3.4 LoggingMarker（ロギングマーカー）

特定のログ出力にマーキングを行うための値オブジェクトです。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|-------|---|------|------|
| name | String | マーカー名 | 必須 |
| parent | LoggingMarker | 親マーカー | オプション |

#### 主要なマーカー定義

- AUDIT: 監査ログ用マーカー
- PERFORMANCE: パフォーマンスログ用マーカー
- SECURITY: セキュリティ関連ログ用マーカー
- BUSINESS: ビジネスロジック関連ログ用マーカー
- EXTERNAL: 外部システム連携関連ログ用マーカー

## 4. ドメイン関連図

```
LogEntry
  ├── ApplicationLog
  ├── AuditLog
  ├── PerformanceLog
  └── AccessLog

LogLevel <-- LogEntry

TraceInfo <-- LogEntry

AuditAction <-- AuditLog

LoggingMarker -- LogEntry
```

## 5. 重要なビジネスルール

### 5.1 ログレベル判定ルール

- ERROR: ユーザーまたは運用担当者の対応が必要な状況で使用
- WARN: 潜在的な問題があるが、システムは動作を継続できる状況で使用
- INFO: 通常の状態変化や重要なイベントの記録に使用
- DEBUG: 開発時のトラブルシューティング情報として使用
- TRACE: 詳細なデバッグ情報として使用（本番環境ではデフォルトで無効）

### 5.2 監査ログ記録ルール

1. 以下の操作は必ず監査ログとして記録すること
   - ユーザー認証（成功/失敗）
   - ユーザー権限変更
   - マスターデータの変更
   - 契約情報の変更
   - 請求・支払情報の変更
   - システム設定の変更

2. 監査ログには必ず以下の情報を含めること
   - 操作を実行したユーザー
   - 操作の種類
   - 操作対象
   - 操作結果
   - 操作日時

3. 監査ログの保持期間は以下のとおり
   - 認証関連: 2年間
   - 権限変更: 2年間
   - 重要データ操作: 1年間
   - その他の操作: 3ヶ月間

### 5.3 パフォーマンスログしきい値ルール

1. パフォーマンスログの警告しきい値
   - Web API: 500ミリ秒超過で警告
   - データベース操作: 200ミリ秒超過で警告
   - バッチ処理: 個別に設定（デフォルトなし）

2. 重大パフォーマンス問題の閾値
   - Web API: 2000ミリ秒超過でエラーレベルで記録
   - データベース操作: 1000ミリ秒超過でエラーレベルで記録

### 5.4 ログローテーションルール

1. ログローテーションはサイズベースと時間ベースの複合条件で実施
   - 1ファイルあたり最大サイズ: 100MB
   - ローテーション頻度: 日次
   - 保持ファイル数: ログ種別により異なる（デフォルト30日分）

2. ログファイル命名規則
   - アプリケーションログ: `application-{yyyy-MM-dd}.log`
   - 監査ログ: `audit-{yyyy-MM-dd}.log`
   - パフォーマンスログ: `performance-{yyyy-MM-dd}.log`
   - アクセスログ: `access-{yyyy-MM-dd}.log`

### 5.5 センシティブ情報ルール

1. 以下の情報は絶対にログに記録しないこと
   - パスワード（平文/ハッシュ値）
   - トークン（認証/リフレッシュ）
   - 暗号鍵
   - クレジットカード番号
   - 個人番号（マイナンバー）

2. 以下の情報はマスキング処理を行った上でログに記録可能
   - メールアドレス（例: a***@example.com）
   - 電話番号（例: 090-****-1234）
   - 氏名（例: 山田 *）

## 6. インターフェース概要

ロギング機能が他のコンポーネントに提供するインターフェースの概要です。詳細は「インターフェース定義」ドキュメントを参照してください。

### 6.1 LoggingFacade

アプリケーションからログを出力するための主要インターフェースです。

```java
public interface LoggingFacade {
    void error(String message, Object... args);
    void error(String message, Throwable t, Object... args);
    void warn(String message, Object... args);
    void info(String message, Object... args);
    void debug(String message, Object... args);
    void trace(String message, Object... args);
    boolean isEnabled(LogLevel level);
}
```

### 6.2 AuditLogger

監査ログを記録するための専用インターフェースです。

```java
public interface AuditLogger {
    void logAuditEvent(AuditAction action, String targetType, String targetId);
    void logAuditEvent(AuditAction action, String targetType, String targetId, String details);
    void logAuditEvent(AuditAction action, String targetType, String targetId, 
                      String details, AuditStatus status);
}
```

### 6.3 PerformanceLogger

パフォーマンス情報を記録するためのインターフェースです。

```java
public interface PerformanceLogger {
    void recordExecutionTime(String methodName, long durationMs);
    void recordExecutionTime(String className, String methodName, long durationMs);
    void recordExecutionTime(String className, String methodName, long durationMs, boolean success);
    void recordExecutionTime(String className, String methodName, long durationMs, 
                           long thresholdMs, boolean success);
}
```

### 6.4 TracingContext

分散トレーシング情報を管理するインターフェースです。

```java
public interface TracingContext {
    String getCurrentTraceId();
    String getCurrentSpanId();
    void createChildSpan(String spanName);
    void closeCurrentSpan();
    void addBaggageItem(String key, String value);
    String getBaggageItem(String key);
}
```