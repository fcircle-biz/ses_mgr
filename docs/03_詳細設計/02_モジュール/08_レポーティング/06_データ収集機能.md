# データ収集機能

## 1. 機能概要

データ収集機能は、レポーティングモジュールの核となる機能で、各業務モジュールからデータを収集し、分析・可視化に適した形式に変換・蓄積します。SES事業の多岐にわたるデータソースから必要なデータを効率的に取得し、統合的な分析基盤を提供します。

### 1.1 主要機能

- 各業務モジュールからのデータ抽出
- データ変換・加工・正規化
- データウェアハウス管理
- 集計テーブル・ビュー管理
- データ更新スケジュール管理
- データ品質チェック

### 1.2 ユースケース

- 日次/週次/月次の各種分析データの自動集計
- 複数モジュールにまたがるデータの統合
- 高速なレポート生成のためのデータ事前集計
- 履歴データの保持と時系列分析
- データ整合性の検証と品質保証

## 2. 機能詳細

### 2.1 データ抽出機能

#### 2.1.1 トランザクションデータ抽出

業務モジュールからトランザクションデータを抽出する機能です。

**機能仕様**:
- 抽出対象業務モジュール：
  - 技術者管理
  - 案件管理
  - マッチング
  - 契約管理
  - 勤怠工数管理
  - 請求支払管理
- 抽出方式：
  - API連携
  - データベース直接アクセス
  - イベント購読
- 増分データ抽出（前回抽出からの差分）
- 全量データ抽出（定期リフレッシュ用）
- データ抽出ログ記録

**処理フロー**:
1. 抽出設定確認
2. 前回抽出情報取得（増分抽出の場合）
3. データソース接続
4. データ抽出クエリ実行
5. 抽出データの一時保存
6. 抽出ログ記録

**例外処理**:
- データソース接続エラー処理
- 抽出クエリエラー処理
- 大量データ抽出時のメモリ対策
- タイムアウト発生時のリトライ制御

#### 2.1.2 マスタデータ抽出

各種マスタデータを抽出・同期する機能です。

**機能仕様**:
- 抽出対象マスタ：
  - 技術者マスタ
  - 案件マスタ
  - 顧客マスタ
  - スキルマスタ
  - コード値マスタ
  - 組織マスタ
- 全量同期（差分管理が困難なマスタ）
- 差分同期（変更検知可能なマスタ）
- マスタ依存関係の考慮

**処理フロー**:
1. マスタ同期スケジュール確認
2. 同期対象マスタの選定
3. マスタデータ取得
4. 変更検出（差分同期の場合）
5. マスタデータ更新

**例外処理**:
- マスタデータ不整合検出時の対応
- 参照整合性違反の検出と修正
- 同期エラーのロギングと通知

#### 2.1.3 外部データ取込

外部システムからのデータを取り込む機能です。

**機能仕様**:
- 取込対象外部データ：
  - 他社システムデータ
  - エクスポートファイル（CSV, Excel等）
  - 外部API
- データマッピング定義
- スケジュール取込
- 手動取込
- 取込ログ記録

**処理フロー**:
1. データソース接続/ファイル読込
2. データフォーマット検証
3. マッピング変換処理
4. データ整合性チェック
5. 取込実行
6. 実行ログ記録

**例外処理**:
- データフォーマットエラー検出
- マッピングエラー処理
- 重複データ検出と対応
- 取込失敗時のロールバック

### 2.2 データ変換・加工機能

#### 2.2.1 データクレンジング

抽出データのクリーニングと正規化を行う機能です。

**機能仕様**:
- データフォーマット標準化
- 欠損値処理
  - デフォルト値設定
  - 補完処理
  - 除外処理
- 異常値検出と修正
- 重複データ排除
- コード値統一

**処理フロー**:
1. クレンジングルール適用
2. フォーマットチェック・変換
3. 欠損値・異常値処理
4. 重複排除処理
5. クレンジング結果ログ記録

**例外処理**:
- クレンジング不可能データのマーキング
- 重大な品質問題検出時の通知
- データ変換エラー記録

#### 2.2.2 データ変換・集計

分析に適した形式へのデータ変換と事前集計を行う機能です。

**機能仕様**:
- ディメンション（分析軸）変換：
  - 日付ディメンション（年、四半期、月、週、日）
  - 組織ディメンション（部門、チーム）
  - 顧客ディメンション（顧客区分、業種、地域）
  - 技術者ディメンション（スキル、経験、稼働状況）
  - 案件ディメンション（案件種別、ステータス、優先度）
- メジャー（測定値）計算：
  - 売上集計
  - 粗利集計
  - 稼働率集計
  - 案件状況集計
- 集計レベル設定：
  - 詳細レベル
  - 日次集計
  - 月次集計
  - 四半期集計
  - 年次集計

**処理フロー**:
1. 変換ルール読込
2. ディメンション変換
3. メジャー計算
4. 階層別集計
5. データ出力

**例外処理**:
- 計算エラー検出と対応
- パフォーマンス監視（長時間実行検出）
- リソース使用状況監視

#### 2.2.3 データマージ

複数ソースからのデータを統合する機能です。

**機能仕様**:
- 異なるデータソースの結合
- キー項目による関連付け
- 結合タイプ設定：
  - 内部結合
  - 外部結合
  - 完全外部結合
- 整合性チェック

**処理フロー**:
1. マージ対象データ特定
2. キー項目確認
3. 結合条件設定
4. マージ処理実行
5. 結果検証

**例外処理**:
- キー不一致データの検出と対応
- 整合性エラー処理
- 大量データマージ時のリソース管理

### 2.3 データウェアハウス管理機能

#### 2.3.1 データモデル管理

分析用データモデルを定義・管理する機能です。

**機能仕様**:
- データモデル定義：
  - ファクトテーブル定義
  - ディメンションテーブル定義
  - リレーションシップ定義
- スキーマ管理：
  - スタースキーマ
  - スノーフレークスキーマ
- バージョン管理
- テーブル・カラム定義

**処理フロー**:
1. データモデル定義
2. スキーマ生成・変更
3. インデックス最適化
4. パーティション設定
5. アクセス権限設定

**例外処理**:
- スキーマ変更時の互換性維持
- 不要テーブル・カラムの廃止管理

#### 2.3.2 ETL管理

ETL（Extract, Transform, Load）プロセスを管理する機能です。

**機能仕様**:
- ETLジョブ定義：
  - ジョブ名、説明
  - 依存関係
  - スケジュール設定
  - 実行条件
- ETLフロー管理：
  - フロー定義
  - 処理順序
  - 条件分岐
- 実行モニタリング：
  - 実行状況監視
  - エラー検出
  - パフォーマンス監視

**処理フロー**:
1. ジョブスケジュール確認
2. 前提条件確認
3. ジョブ実行
4. 進捗状況監視
5. 完了通知

**例外処理**:
- 前提ジョブ失敗時の対応
- リソース不足時の実行制御
- タイムアウト管理
- 障害発生時の再実行制御

#### 2.3.3 集計テーブル管理

事前集計データを管理する機能です。

**機能仕様**:
- 集計テーブル定義：
  - 集計対象
  - 集計レベル
  - 更新頻度
- インクリメンタル更新：
  - 差分データのみ集計
- 集計テーブル再構築：
  - 全量データからの再集計
- 集計結果検証

**処理フロー**:
1. 更新対象集計テーブル特定
2. 更新方式決定（インクリメンタル/フル）
3. 集計処理実行
4. 検証処理
5. 集計テーブル切替

**例外処理**:
- 集計整合性エラー検出
- パフォーマンス異常時の対応
- バックアップと復旧

### 2.4 データ品質管理機能

#### 2.4.1 データ整合性チェック

データ整合性を検証する機能です。

**機能仕様**:
- 整合性ルール定義：
  - 参照整合性
  - ビジネスルール整合性
  - クロスチェック
- 検証実行：
  - 定期検証
  - オンデマンド検証
  - 変更後検証
- 違反データの検出と記録

**処理フロー**:
1. 検証ルール読込
2. 対象データ特定
3. 整合性チェック実行
4. 違反データ特定
5. 検証結果レポート

**例外処理**:
- 大量違反データ検出時の対応
- クリティカルな整合性違反の緊急通知

#### 2.4.2 データ品質モニタリング

データ品質を継続的に監視する機能です。

**機能仕様**:
- 品質メトリクス定義：
  - 完全性（欠損率）
  - 正確性
  - 一貫性
  - 適時性
- 品質スコアリング
- トレンド分析
- 閾値アラート

**処理フロー**:
1. メトリクス計測
2. スコア計算
3. 閾値チェック
4. トレンド分析
5. レポート生成

**例外処理**:
- スコア急落時の緊急通知
- 継続的な品質低下傾向の検出

#### 2.4.3 データ修復・補正

品質問題が検出されたデータを修復する機能です。

**機能仕様**:
- 自動修復ルール：
  - 標準値置換
  - 計算値補完
  - 前回値引継
- 手動修正支援：
  - 修正候補提示
  - 修正履歴管理
- 修復ログ記録

**処理フロー**:
1. 修復対象データ特定
2. 修復方法決定
3. 修復処理実行
4. 修復結果検証
5. 修復ログ記録

**例外処理**:
- 修復不能データの管理
- 修復による二次的影響の検出

### 2.5 アーカイブ・履歴管理機能

#### 2.5.1 履歴データ管理

データの履歴を保持・管理する機能です。

**機能仕様**:
- 履歴保持方針：
  - 詳細データ：3ヶ月
  - 日次集計：1年
  - 月次集計：5年
  - 年次集計：10年
- 履歴データ構造：
  - スナップショット方式
  - 変更差分方式
- 履歴参照機能

**処理フロー**:
1. 履歴保持対象特定
2. 履歴データ生成
3. 保持期間チェック
4. 期限切れデータアーカイブ

**例外処理**:
- ストレージ容量監視
- 履歴データ破損検出

#### 2.5.2 データアーカイブ

不要となったデータをアーカイブする機能です。

**機能仕様**:
- アーカイブ基準：
  - 経過期間
  - 利用頻度
  - データ重要度
- アーカイブ方式：
  - コールドストレージ移行
  - 圧縮アーカイブ
  - 要約アーカイブ
- アーカイブカタログ管理

**処理フロー**:
1. アーカイブ対象選定
2. アーカイブ前検証
3. アーカイブ処理実行
4. カタログ更新
5. 原データ削除（必要に応じて）

**例外処理**:
- アーカイブ処理失敗時の対応
- カタログ不整合の検出と修復

## 3. 非機能要件

### 3.1 性能要件

- ETL処理時間：
  - 日次処理：2時間以内
  - 週次処理：4時間以内
  - 月次処理：8時間以内
- データロード速度：
  - 1時間あたり100万行以上
- 集計処理速度：
  - 日次集計：30分以内
  - 月次集計：2時間以内
- リソース使用上限：
  - CPU使用率：70%以下
  - メモリ使用率：80%以下
  - ディスクI/O：実行中70%以下

### 3.2 可用性要件

- ETL処理成功率：99.9%
- システム稼働率：99.5%
- 障害復旧時間：2時間以内（RTO）
- データ損失許容範囲：24時間以内（RPO）
- バックアップ頻度：日次

### 3.3 セキュリティ要件

- データアクセス制御
- 個人情報の匿名化・マスキング
- センシティブデータの暗号化
- 操作ログ・アクセスログの記録
- ETL処理の認証・認可

### 3.4 拡張性要件

- 新規データソース追加の容易性
- データ量増加への対応（年間30%増）
- 処理パフォーマンスのスケーラビリティ
- 分析項目の柔軟な追加

## 4. インターフェース詳細

### 4.1 提供インターフェース

#### DataCollectionService

データ収集・ETL処理を制御するインターフェースです。

```
public interface DataCollectionService {
    // ETLジョブ実行
    JobExecutionId executeJob(JobId jobId, JobParameters parameters);
    
    // ETLジョブ実行状況取得
    JobExecutionStatus getJobStatus(JobExecutionId executionId);
    
    // ETLジョブ停止
    void stopJob(JobExecutionId executionId);
    
    // ETLジョブ一覧取得
    List<JobDefinition> getJobDefinitions();
    
    // ETLジョブ定義取得
    JobDefinition getJobDefinition(JobId jobId);
    
    // ETLジョブスケジュール設定
    void scheduleJob(JobId jobId, JobSchedule schedule);
    
    // ETLジョブ実行履歴取得
    SearchResult<JobExecutionHistory> getJobExecutionHistory(
        JobId jobId, HistorySearchCriteria criteria, Pageable pageable);
}
```

#### DataQualityService

データ品質管理機能を提供するインターフェースです。

```
public interface DataQualityService {
    // 整合性チェック実行
    ValidationId validateData(ValidationRequest request);
    
    // 整合性チェック結果取得
    ValidationResult getValidationResult(ValidationId validationId);
    
    // 品質メトリクス取得
    QualityMetrics getQualityMetrics(QualityMetricsRequest request);
    
    // 品質トレンド取得
    QualityTrend getQualityTrend(QualityTrendRequest request);
    
    // データ修復実行
    RepairId repairData(RepairRequest request);
    
    // データ修復結果取得
    RepairResult getRepairResult(RepairId repairId);
}
```

#### DataWarehouseQueryService

データウェアハウスへのクエリインターフェースを提供します。

```
public interface DataWarehouseQueryService {
    // ファクトデータ取得
    FactData getFactData(FactQuery query);
    
    // ディメンションデータ取得
    DimensionData getDimensionData(DimensionQuery query);
    
    // 集計データ取得
    AggregationData getAggregationData(AggregationQuery query);
    
    // カスタムクエリ実行
    QueryResult executeCustomQuery(CustomQuery query);
    
    // メタデータ取得
    MetadataInfo getMetadata(MetadataRequest request);
}
```

### 4.2 必要インターフェース

データ収集機能が他モジュールから利用するインターフェースです。

#### ModuleDataExportService（各業務モジュール）

```
public interface ModuleDataExportService {
    // トランザクションデータ抽出
    DataExportResult exportTransactionData(DataExportRequest request);
    
    // マスタデータ抽出
    DataExportResult exportMasterData(DataExportRequest request);
    
    // 変更データ取得（CDC）
    ChangeDataResult getChangeData(ChangeDataRequest request);
    
    // データエクスポート状態取得
    ExportStatus getExportStatus(ExportId exportId);
}
```

#### SchedulerService（システム共通）

```
public interface SchedulerService {
    // スケジュール登録
    ScheduleId registerSchedule(JobSchedule schedule);
    
    // スケジュール更新
    void updateSchedule(ScheduleId scheduleId, JobSchedule schedule);
    
    // スケジュール削除
    void deleteSchedule(ScheduleId scheduleId);
}
```

#### NotificationService（通知モジュール）

```
public interface NotificationService {
    // ETL処理完了通知
    void sendEtlCompletionNotification(EtlCompletionNotification notification);
    
    // データ品質アラート通知
    void sendDataQualityAlertNotification(DataQualityAlertNotification notification);
}
```

#### LoggingService（ロギングモジュール）

```
public interface LoggingService {
    // ETL処理ログ記録
    void logEtlExecution(EtlExecutionLog log);
    
    // データ品質ログ記録
    void logDataQuality(DataQualityLog log);
    
    // エラーログ記録
    void logError(ErrorLog log);
}
```

## 5. 例外処理

### 5.1 ビジネス例外

| 例外クラス | 説明 | HTTPステータス |
|------------|------|---------------|
| `JobNotFoundException` | 指定されたジョブが存在しない | 404 Not Found |
| `JobExecutionNotFoundException` | 指定された実行IDが存在しない | 404 Not Found |
| `ValidationRuleNotFoundException` | 指定された検証ルールが存在しない | 404 Not Found |
| `InvalidJobParametersException` | 無効なジョブパラメータ | 400 Bad Request |
| `InvalidQueryException` | 無効なクエリ | 400 Bad Request |
| `JobAlreadyRunningException` | ジョブ既に実行中 | 409 Conflict |
| `DataAccessPermissionDeniedException` | データアクセス権限エラー | 403 Forbidden |

### 5.2 システム例外

| 例外クラス | 説明 | HTTPステータス |
|------------|------|---------------|
| `JobExecutionTimeoutException` | ジョブ実行タイムアウト | 504 Gateway Timeout |
| `DataSourceConnectionException` | データソース接続エラー | 503 Service Unavailable |
| `EtlProcessingException` | ETL処理エラー | 500 Internal Server Error |
| `DataIntegrityException` | データ整合性エラー | 500 Internal Server Error |
| `ResourceExhaustionException` | リソース枯渇エラー | 503 Service Unavailable |

## 6. セキュリティ

### 6.1 認証・認可

- ETL処理・データアクセスの認証・認可
- ロール別アクセス制御：
  - データ管理者：全機能・全データへのアクセス
  - レポート作成者：集計データへのアクセス
  - 一般ユーザー：承認された集計データのみアクセス
- センシティブデータ保護：
  - 個人情報の匿名化
  - 機密データの暗号化
  - アクセス制限

### 6.2 監査ログ

以下の操作ログを記録します：

- ETLジョブの実行・変更
- データアクセス
- データ修正・補正
- 整合性検証実行
- アーカイブ処理

## 7. 運用設計

### 7.1 パフォーマンス最適化

- ETLパイプラインの最適化：
  - パーティショニング
  - 並列処理
  - インクリメンタル処理
- インデックス最適化
- クエリ最適化
- キャッシュ戦略

### 7.2 監視設計

- ETL処理の監視：
  - 実行状況
  - 処理時間
  - 成功率
- データ品質の監視：
  - 品質メトリクス
  - 違反データ数
  - 修復状況
- リソース使用状況監視：
  - CPU/メモリ使用率
  - ディスク使用量
  - クエリパフォーマンス

### 7.3 障害対策

- 障害検知：
  - ETL処理失敗の検知
  - データ品質異常の検知
  - パフォーマンス低下の検知
- 障害対応：
  - 自動リトライ
  - 段階的エスカレーション
  - 手動介入手順
- 障害復旧：
  - データリカバリ
  - 処理再実行
  - 整合性回復

## 8. 拡張性

### 8.1 データソース拡張

- 新規データソース追加手順
- データソースアダプタ機構
- ETLパイプライン拡張

### 8.2 処理能力拡張

- スケールアウト戦略
- 処理並列化
- 分散処理対応

### 8.3 データモデル拡張

- データモデル・スキーマの拡張手順
- 後方互換性の維持方針
- リファクタリングアプローチ