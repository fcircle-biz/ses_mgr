# レポート管理機能

## 1. 機能概要

レポート管理機能は、SES事業に関する各種レポートの作成、保存、配布、および管理を行うための機能群です。標準レポートの提供と、ユーザーによるカスタムレポート作成をサポートします。

### 1.1 主要機能

- 標準レポートの提供（売上レポート、粗利レポート、稼働率レポートなど）
- レポートの作成・編集・削除
- レポートの実行・表示
- レポートの出力・配布（PDF, Excel, CSV形式など）
- レポート実行スケジュール設定
- レポート共有と権限管理

### 1.2 ユースケース

- 経営者が月次の売上・利益レポートを確認する
- 営業担当者が案件別の粗利レポートを作成する
- プロジェクトマネージャが技術者の稼働率レポートを定期的に受け取る
- 経理担当者が請求・支払状況レポートを出力する
- 管理者が部門別のKPI達成状況をレポート化する

## 2. 機能詳細

### 2.1 標準レポート管理機能

#### 2.1.1 標準レポート定義

システムで提供する標準レポートを定義・管理する機能です。

**機能仕様**:
- 標準レポートタイプ：
  - 売上レポート（期間別、顧客別、案件別）
  - 粗利レポート（期間別、顧客別、案件別）
  - 技術者稼働率レポート（部門別、スキル別）
  - 案件状況レポート（ステータス別、時系列）
  - 請求支払状況レポート（期日別、顧客別）
- 各レポートの項目定義
- レポートフォーマット設定
- レポートパラメータ定義

**処理フロー**:
1. システム初期化時に標準レポート定義をロード
2. リポジトリへの登録
3. 標準レポート一覧の提供

**例外処理**:
- 定義データ不整合時の初期化エラー処理
- 欠落データのデフォルト値設定

#### 2.1.2 標準レポート実行

標準レポートを実行しデータを取得・表示する機能です。

**機能仕様**:
- レポートパラメータ入力画面表示
- パラメータバリデーション
- レポートデータ取得処理
- レポート表示処理（表形式、グラフ形式）
- インタラクティブ操作（ソート、フィルタ、ドリルダウン）

**処理フロー**:
1. レポート選択
2. パラメータ入力画面表示
3. パラメータ入力と検証
4. レポート実行処理
5. データ取得と集計
6. レポート表示

**例外処理**:
- パラメータバリデーションエラー処理
- データ取得エラー処理
- 大量データ処理時のタイムアウト対策

### 2.2 カスタムレポート管理機能

#### 2.2.1 カスタムレポート作成

ユーザーがカスタムレポートを新規作成する機能です。

**機能仕様**:
- レポート名、説明、カテゴリの設定
- データソース選択（テーブル、ビュー、API）
- レポート項目の選択と設定
  - 表示項目の選択
  - 計算項目の定義
  - 集計関数の設定（合計、平均、最大、最小など）
- フィルター条件の設定
- ソート条件の設定
- グループ化設定
- レポートレイアウト設計
  - テーブルレイアウト
  - グラフレイアウト（棒グラフ、折れ線グラフ、円グラフなど）
  - 複合レイアウト

**処理フロー**:
1. カスタムレポート作成画面表示
2. レポート基本情報入力
3. データソース選択と項目設定
4. レポート条件設定
5. レポートレイアウト設計
6. プレビュー表示
7. 保存処理

**例外処理**:
- 無効なデータソース参照時のエラー処理
- 無効な計算式のバリデーション
- 過負荷となる集計処理の制限

#### 2.2.2 カスタムレポート編集

既存のカスタムレポートを編集する機能です。

**機能仕様**:
- レポート基本情報の変更
- データソース・項目設定の変更
- 条件設定の変更
- レイアウト設計の変更
- 編集履歴の記録

**処理フロー**:
1. 編集対象レポート選択
2. 現在の設定読み込み
3. 編集操作
4. プレビュー確認
5. 変更保存

**例外処理**:
- 同時編集の競合制御
- 編集権限チェック
- システムレポートの保護（編集制限）

#### 2.2.3 カスタムレポート削除

不要となったカスタムレポートを削除する機能です。

**機能仕様**:
- レポート論理削除
- 削除情報の記録（削除者、削除日時）
- 関連データ（スケジュール設定など）の整合性維持

**処理フロー**:
1. 削除対象レポート選択
2. 削除確認ダイアログ表示
3. 削除処理実行
4. 関連データ処理
5. 完了通知

**例外処理**:
- システム標準レポート削除防止
- 共有レポート削除時の権限チェック

### 2.3 レポート出力・配布機能

#### 2.3.1 レポート出力

レポートを各種形式で出力する機能です。

**機能仕様**:
- 出力形式：
  - PDF形式
  - Excel形式
  - CSV形式
  - HTML形式
- 出力オプション設定：
  - ページレイアウト（用紙サイズ、向き）
  - ヘッダー・フッター設定
  - グラフ品質設定
  - データフォーマット設定
- 大量データ分割出力対応

**処理フロー**:
1. 出力対象レポート表示
2. 出力形式・オプション選択
3. 出力処理実行
4. 進捗状況表示
5. 出力ファイル生成
6. ダウンロード提供

**例外処理**:
- 大量データ出力時のメモリ使用量制御
- 出力処理タイムアウト対策
- 不完全なデータ出力の防止

#### 2.3.2 レポート配布スケジュール設定

レポートを定期的に自動実行し配布するスケジュール機能です。

**機能仕様**:
- 配布スケジュール設定：
  - 日次/週次/月次/四半期/年次
  - 実行日時指定
  - 繰り返しパターン設定
- 配布先設定：
  - メール配布
  - システム内通知
  - 共有フォルダ保存
- レポートパラメータ事前設定
- 配布形式設定（PDF, Excel, CSV）
- 配布履歴管理

**処理フロー**:
1. スケジュール設定画面表示
2. スケジュールと配布先設定
3. レポートパラメータ設定
4. スケジュール保存
5. スケジューラへの登録

**例外処理**:
- 無効なスケジュール設定の検証
- 配布先アドレス検証
- スケジュール重複時の実行順序制御

#### 2.3.3 レポート自動配布実行

スケジュールに従ってレポートを自動実行・配布する機能です。

**機能仕様**:
- スケジュール監視と起動
- バックグラウンド処理による負荷分散
- レポート実行・出力処理
- 配布処理（メール送信、通知、保存）
- 実行履歴記録

**処理フロー**:
1. スケジュール到達検知
2. 実行パラメータ取得
3. バックグラウンドジョブ起動
4. レポート実行・出力処理
5. 配布処理
6. 実行結果記録

**例外処理**:
- 実行失敗時のリトライ制御
- 配布失敗時の代替処理
- 長時間実行の監視とタイムアウト処理

### 2.4 レポートアクセス制御機能

#### 2.4.1 レポート共有設定

レポートを他ユーザーと共有するための設定機能です。

**機能仕様**:
- 共有範囲設定：
  - 非公開（作成者のみ）
  - 特定ユーザー
  - 特定グループ/ロール
  - 全社公開
- 権限レベル設定：
  - 閲覧のみ
  - 編集可能
  - 配布権限
  - フルコントロール
- 共有レポートリスト管理

**処理フロー**:
1. 共有設定画面表示
2. 共有範囲・権限設定
3. 保存処理
4. 共有通知（オプション）

**例外処理**:
- 権限整合性チェック
- 機密データを含むレポート共有時の追加確認

#### 2.4.2 レポートアクセス権限管理

レポートへのアクセス権限を管理する機能です。

**機能仕様**:
- レポートごとのアクセス権限チェック
- データレベルのアクセス制御（ユーザー/グループに応じたデータフィルタリング）
- アクセス履歴の記録と監査
- 権限委譲機能

**処理フロー**:
1. レポートアクセス要求
2. 権限チェック処理
3. アクセス可否判定
4. データフィルタリング適用
5. アクセス履歴記録

**例外処理**:
- 権限不足時のエラーメッセージ表示
- アクセス拒否ログ記録
- 権限変更の監査証跡保存

### 2.5 レポートデータキャッシュ管理機能

#### 2.5.1 レポートデータキャッシュ制御

頻繁に実行されるレポートのデータをキャッシュし、レスポンス向上を図る機能です。

**機能仕様**:
- キャッシュポリシー設定：
  - キャッシュ有効期間
  - キャッシュ対象条件
  - 更新タイミング
- 定期的なキャッシュ更新処理
- キャッシュ無効化トリガー
- キャッシュヒット率監視

**処理フロー**:
1. レポート実行要求受信
2. キャッシュ適用可否判定
3. キャッシュ検索
4. キャッシュヒット時はキャッシュデータ返却
5. キャッシュミス時はデータ取得と新規キャッシュ登録

**例外処理**:
- キャッシュデータ不整合検出時の再生成
- キャッシュサイズ超過時のLRU破棄処理
- システムリソース枯渇時のキャッシュ制限

## 3. 非機能要件

### 3.1 性能要件

- 標準レポート表示レスポンスタイム：3秒以内（95パーセンタイル）
- カスタムレポート表示レスポンスタイム：5秒以内（95パーセンタイル）
- 大量データレポート（1万行超）の生成時間：30秒以内
- レポート出力処理時間：
  - PDF：10秒以内（100ページ以内）
  - Excel：15秒以内（1万行以内）
  - CSV：5秒以内（10万行以内）
- 同時レポート実行数：30セッション

### 3.2 可用性要件

- サービス稼働率：99.5%
- スケジュールレポート実行の信頼性：99.9%
- バックグラウンド処理による長時間レポート生成のサポート
- レポート生成失敗時の自動リトライ機能

### 3.3 セキュリティ要件

- レポートアクセス権限の厳格な管理
- 機密データ（売上・利益等）表示時の追加認証
- 出力ファイルの暗号化オプション
- 全操作履歴のログ記録と監査証跡

### 3.4 拡張性要件

- カスタムレポートテンプレートの追加容易性
- 外部データソースとの連携拡張性
- 出力形式の拡張性
- データ変換プラグイン対応

## 4. インターフェース詳細

### 4.1 提供インターフェース

#### ReportManagementService

レポート管理機能を提供するインターフェースです。ドメインモデルで定義した `ReportManagementService` の実装詳細となります。

```
public interface ReportManagementService {
    // 標準レポート一覧取得
    List<StandardReportDefinition> getStandardReportDefinitions();
    
    // 標準レポート定義取得
    StandardReportDefinition getStandardReportDefinition(ReportDefinitionId definitionId);
    
    // カスタムレポート作成
    ReportId createCustomReport(CreateCustomReportRequest request);
    
    // カスタムレポート更新
    void updateCustomReport(ReportId reportId, UpdateCustomReportRequest request);
    
    // カスタムレポート削除
    void deleteCustomReport(ReportId reportId);
    
    // レポート検索
    SearchResult<ReportSummary> searchReports(ReportSearchCriteria criteria, Pageable pageable);
    
    // レポート詳細取得
    ReportDetail getReportDetail(ReportId reportId);
    
    // レポート共有設定更新
    void updateReportSharingSettings(ReportId reportId, SharingSettings settings);
    
    // レポートカテゴリ一覧取得
    List<ReportCategory> getReportCategories();
}
```

#### ReportExecutionService

レポート実行機能を提供するインターフェースです。

```
public interface ReportExecutionService {
    // レポート実行（同期）
    ReportExecutionResult executeReport(ReportId reportId, ReportParameters parameters);
    
    // レポート実行（非同期）
    ExecutionId executeReportAsync(ReportId reportId, ReportParameters parameters);
    
    // 非同期実行状況確認
    ExecutionStatus getExecutionStatus(ExecutionId executionId);
    
    // 実行結果取得
    ReportExecutionResult getExecutionResult(ExecutionId executionId);
    
    // レポート出力
    OutputId generateReportOutput(ExecutionId executionId, OutputFormat format, 
                                OutputOptions options);
    
    // 出力ファイル取得
    OutputFile getOutputFile(OutputId outputId);
    
    // レポート実行履歴取得
    SearchResult<ExecutionHistory> getExecutionHistory(ReportId reportId, 
                                                    HistorySearchCriteria criteria,
                                                    Pageable pageable);
}
```

#### ReportScheduleService

レポートスケジュール配布機能を提供するインターフェースです。

```
public interface ReportScheduleService {
    // スケジュール設定作成
    ScheduleId createSchedule(ReportId reportId, ScheduleSettings settings);
    
    // スケジュール設定更新
    void updateSchedule(ScheduleId scheduleId, ScheduleSettings settings);
    
    // スケジュール設定削除
    void deleteSchedule(ScheduleId scheduleId);
    
    // スケジュール一時停止
    void pauseSchedule(ScheduleId scheduleId);
    
    // スケジュール再開
    void resumeSchedule(ScheduleId scheduleId);
    
    // スケジュール即時実行
    ExecutionId executeScheduleNow(ScheduleId scheduleId);
    
    // レポートのスケジュール一覧取得
    List<ScheduleSummary> getSchedules(ReportId reportId);
    
    // スケジュール詳細取得
    ScheduleDetail getScheduleDetail(ScheduleId scheduleId);
    
    // スケジュール実行履歴取得
    SearchResult<ScheduleExecutionHistory> getScheduleExecutionHistory(
        ScheduleId scheduleId, HistorySearchCriteria criteria, Pageable pageable);
}
```

### 4.2 必要インターフェース

レポート管理機能が他モジュールから利用するインターフェースです。

#### DataAccessService（各業務モジュール）

```
public interface DataAccessService {
    // 集計データ取得
    AggregationData getAggregationData(AggregationQuery query);
    
    // マスタデータ取得
    ReferenceData getReferenceData(ReferenceQuery query);
    
    // 生データ取得
    RawData getRawData(RawDataQuery query);
}
```

#### AuthorizationService（認証認可モジュール）

```
public interface AuthorizationService {
    // リソースアクセス権限チェック
    boolean hasPermission(UserId userId, ResourceId resourceId, Permission permission);
    
    // データフィルタリングポリシー取得
    DataFilteringPolicy getDataFilteringPolicy(UserId userId, ResourceType resourceType);
}
```

#### NotificationService（通知モジュール）

```
public interface NotificationService {
    // レポート配布通知
    void sendReportDistributionNotification(ReportDistributionNotification notification);
    
    // レポート共有通知
    void sendReportSharingNotification(ReportSharingNotification notification);
}
```

#### FileStorageService（ファイル管理モジュール）

```
public interface FileStorageService {
    // レポート出力ファイル保存
    FileId storeReportFile(byte[] content, FileMetadata metadata);
    
    // レポートファイル取得
    ReportFile getReportFile(FileId fileId);
    
    // レポートファイル削除
    void deleteReportFile(FileId fileId);
}
```

## 5. 例外処理

### 5.1 ビジネス例外

| 例外クラス | 説明 | HTTPステータス |
|------------|------|---------------|
| `ReportNotFoundException` | 指定されたレポートが存在しない | 404 Not Found |
| `ReportDefinitionNotFoundException` | 指定されたレポート定義が存在しない | 404 Not Found |
| `ExecutionNotFoundException` | 指定された実行IDが存在しない | 404 Not Found |
| `ScheduleNotFoundException` | 指定されたスケジュールが存在しない | 404 Not Found |
| `InvalidReportDefinitionException` | 無効なレポート定義 | 400 Bad Request |
| `InvalidScheduleSettingsException` | 無効なスケジュール設定 | 400 Bad Request |
| `ReportPermissionDeniedException` | レポートアクセス権限エラー | 403 Forbidden |
| `OutputGenerationFailedException` | 出力生成失敗 | 500 Internal Server Error |

### 5.2 システム例外

| 例外クラス | 説明 | HTTPステータス |
|------------|------|---------------|
| `ReportExecutionTimeoutException` | レポート実行タイムアウト | 504 Gateway Timeout |
| `DataSourceUnavailableException` | データソース接続不可 | 503 Service Unavailable |
| `ReportServiceInternalException` | レポートサービス内部エラー | 500 Internal Server Error |
| `OutputServiceInternalException` | 出力サービス内部エラー | 500 Internal Server Error |

## 6. セキュリティ

### 6.1 認証・認可

- レポートアクセスは認証済みユーザーのみ許可
- レポートごとに閲覧・編集・実行・配布権限を設定
- データレベルセキュリティによる表示データフィルタリング
- センシティブデータ（個人情報、財務情報等）へのアクセス制限

### 6.2 監査ログ

以下の操作ログを記録します：

- レポートの作成・編集・削除
- レポートの実行
- レポートの出力・配布
- スケジュール設定の変更
- レポート共有設定の変更
- レポートアクセス（閲覧）

## 7. 運用設計

### 7.1 パフォーマンスチューニング

- レポートデータのキャッシュ戦略
- バックグラウンド処理による負荷分散
- 大量データ処理時のページング対応
- インデックス最適化

### 7.2 監視設計

- レポート実行パフォーマンスの監視
- スケジュール実行成功率の監視
- 出力処理のエラー率監視
- リソース使用状況監視（メモリ、CPU、ディスク）

### 7.3 メンテナンス設計

- 不要レポート出力ファイルの自動クリーンアップ
- 実行履歴の保持期間設定と古いデータの削除
- キャッシュデータの定期的なリフレッシュ
- インデックスの最適化とメンテナンス

## 8. 拡張性

### 8.1 カスタムデータソース対応

- 外部データソース連携機構
- カスタムデータ変換処理
- 異種データソースの統合クエリ

### 8.2 外部システム連携

- 外部BIツールとのデータ連携
- 他システムからのレポートAPI呼び出し
- クラウドストレージとの連携（出力ファイル保存）