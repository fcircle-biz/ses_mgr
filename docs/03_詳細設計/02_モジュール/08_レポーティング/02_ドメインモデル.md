# レポーティングモジュール ドメインモデル

本ドキュメントでは、レポーティングモジュールのドメインモデルを定義します。ダッシュボード、レポート、KPI、データソースなどの主要なエンティティと値オブジェクト、それらの関係性について説明します。

## 1. エンティティ

### 1.1 Dashboard（ダッシュボード）

ユーザー固有のダッシュボード設定を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | ダッシュボードID | 主キー、UUID形式 |
| name | String | ダッシュボード名 | 必須、最大100文字 |
| userId | ID | 所有ユーザーID | 必須、外部キー |
| layoutConfig | JSON | レイアウト設定 | 必須 |
| isDefault | Boolean | デフォルト設定フラグ | 必須 |
| isPublic | Boolean | 公開フラグ | 必須 |
| description | String | 説明 | 任意、最大500文字 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- ユーザーごとにデフォルトのダッシュボードは1つのみ設定可能
- 公開設定されたダッシュボードは他ユーザーが参照可能
- ダッシュボードのレイアウトはグリッドベースで設定

### 1.2 Widget（ウィジェット）

ダッシュボード上に配置される可視化コンポーネントを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | ウィジェットID | 主キー、UUID形式 |
| dashboardId | ID | ダッシュボードID | 必須、外部キー |
| title | String | ウィジェットタイトル | 必須、最大100文字 |
| type | WidgetType | ウィジェット種別 | 必須 |
| dataSourceId | ID | データソースID | 必須、外部キー |
| queryConfig | JSON | クエリ設定 | 必須 |
| displayConfig | JSON | 表示設定 | 必須 |
| positionConfig | JSON | 位置・サイズ設定 | 必須 |
| refreshInterval | Integer | 更新間隔(秒) | 必須、0以上 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- ウィジェットの種別によって必要な設定項目が異なる
- 位置設定はグリッド座標で指定（x, y, width, height）
- 更新間隔が0の場合は自動更新しない

### 1.3 KpiDefinition（KPI定義）

システムで管理するKPI指標の定義を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | KPI定義ID | 主キー、UUID形式 |
| code | String | KPIコード | 必須、一意制約 |
| name | String | KPI名称 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| category | KpiCategory | カテゴリ | 必須 |
| calculationFormula | String | 計算式 | 必須 |
| unit | String | 単位 | 必須、最大20文字 |
| displayFormat | String | 表示形式 | 必須 |
| sortOrder | Integer | 表示順 | 必須 |
| isActive | Boolean | 有効フラグ | 必須 |
| targetDirection | TargetDirection | 目標方向 | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- KPIコードは一意のコード体系で管理
- 計算式はシステム内部で解釈可能な形式で記述
- 目標方向は「増加が望ましい」「減少が望ましい」「範囲内が望ましい」のいずれか

### 1.4 KpiTarget（KPI目標）

KPI指標の目標値を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | KPI目標ID | 主キー、UUID形式 |
| kpiId | ID | KPI定義ID | 必須、外部キー |
| targetType | TargetType | 目標タイプ | 必須 |
| targetYear | Integer | 対象年 | 必須 |
| targetQuarter | Integer | 対象四半期 | 四半期目標の場合は必須 |
| targetMonth | Integer | 対象月 | 月次目標の場合は必須 |
| targetValue | Decimal | 目標値 | 必須 |
| minValue | Decimal | 最小許容値 | 範囲目標の場合は必須 |
| maxValue | Decimal | 最大許容値 | 範囲目標の場合は必須 |
| departmentId | ID | 部門ID | 任意、外部キー |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 目標タイプに応じて必須項目が変わる（年次/四半期/月次）
- 部門IDが指定されない場合は全社目標
- KPIの目標方向が「範囲内」の場合は、minValueとmaxValueが必須

### 1.5 KpiAchievement（KPI実績）

KPI指標の実績値を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | KPI実績ID | 主キー、UUID形式 |
| kpiId | ID | KPI定義ID | 必須、外部キー |
| targetId | ID | KPI目標ID | 任意、外部キー |
| achievementYear | Integer | 実績年 | 必須 |
| achievementQuarter | Integer | 実績四半期 | 四半期実績の場合は必須 |
| achievementMonth | Integer | 実績月 | 月次実績の場合は必須 |
| achievementValue | Decimal | 実績値 | 必須 |
| achievementPercentage | Decimal | 達成率(%) | 必須 |
| departmentId | ID | 部門ID | 任意、外部キー |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |

**ビジネスルール**：
- 達成率は目標値に対する実績値の割合（目標値がない場合は別途計算方法を定義）
- 部門IDが指定されない場合は全社実績
- 実績データは自動計算または手動入力で作成される

### 1.6 Report（レポート定義）

システムで提供するレポートの定義を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | レポート定義ID | 主キー、UUID形式 |
| code | String | レポートコード | 必須、一意制約 |
| name | String | レポート名称 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| category | ReportCategory | カテゴリ | 必須 |
| type | ReportType | レポート種別 | 必須 |
| templatePath | String | テンプレートパス | 必須 |
| parameterConfig | JSON | パラメータ設定 | 必須 |
| displayConfig | JSON | 表示設定 | 必須 |
| permissions | JSON | 権限設定 | 必須 |
| isBuiltIn | Boolean | ビルトインフラグ | 必須 |
| isActive | Boolean | 有効フラグ | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- ビルトインレポートはシステム提供の標準レポート（削除不可）
- レポートコードは一意のコード体系で管理
- 権限設定はロールベースの参照権限設定

### 1.7 ReportExecution（レポート実行履歴）

レポートの実行履歴を表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | 実行履歴ID | 主キー、UUID形式 |
| reportId | ID | レポート定義ID | 必須、外部キー |
| executionStartTime | DateTime | 実行開始時間 | 必須 |
| executionEndTime | DateTime | 実行終了時間 | 任意 |
| status | ExecutionStatus | 実行ステータス | 必須 |
| parameters | JSON | 実行パラメータ | 必須 |
| outputFormat | String | 出力形式 | 必須 |
| outputPath | String | 出力パス | 任意 |
| errorMessage | String | エラーメッセージ | 任意 |
| executedBy | ID | 実行者ID | 必須 |
| scheduleId | ID | スケジュールID | 任意、外部キー |
| createdAt | DateTime | 作成日時 | 必須 |

**ビジネスルール**：
- スケジュールIDが設定されている場合はスケジュール実行
- 実行ステータスは「待機中」「実行中」「完了」「エラー」「キャンセル」のいずれか
- 実行時間が長い場合は非同期処理で実行

### 1.8 ReportSchedule（レポートスケジュール）

レポートの自動実行スケジュールを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | スケジュールID | 主キー、UUID形式 |
| reportId | ID | レポート定義ID | 必須、外部キー |
| name | String | スケジュール名称 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| cronExpression | String | クーロン式 | 必須 |
| parameters | JSON | 実行パラメータ | 必須 |
| outputFormat | String | 出力形式 | 必須 |
| isActive | Boolean | 有効フラグ | 必須 |
| startDate | Date | 開始日 | 必須 |
| endDate | Date | 終了日 | 任意 |
| nextRunDate | DateTime | 次回実行日時 | 必須 |
| lastRunDate | DateTime | 最終実行日時 | 任意 |
| recipients | JSON | 配信先設定 | 任意 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- クーロン式は標準的な形式で記述（分 時 日 月 曜日）
- 配信先設定にはメールアドレス、ユーザーID、部門IDなどを指定可能
- スケジュール実行時に、指定された出力形式でレポートを生成し配信

### 1.9 DataSource（データソース）

レポートやウィジェットのデータソースを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | データソースID | 主キー、UUID形式 |
| name | String | データソース名 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| type | DataSourceType | データソース種別 | 必須 |
| connectionDetails | JSON | 接続情報 | 必須 |
| queryText | String | クエリテキスト | 必須 |
| parameters | JSON | パラメータ設定 | 必須 |
| cacheEnabled | Boolean | キャッシュ有効フラグ | 必須 |
| cacheTimeToLive | Integer | キャッシュ有効期間(秒) | キャッシュ有効時は必須 |
| isBuiltIn | Boolean | ビルトインフラグ | 必須 |
| permissions | JSON | 権限設定 | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- ビルトインデータソースはシステム提供の標準データソース（削除不可）
- データソース種別によって必要な接続情報が異なる
- キャッシュが有効な場合、指定された期間データをキャッシュする

### 1.10 ForecastModel（予測モデル）

予測分析で使用するモデルを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | モデルID | 主キー、UUID形式 |
| name | String | モデル名 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| type | ForecastType | 予測タイプ | 必須 |
| target | String | 予測対象 | 必須 |
| algorithm | String | アルゴリズム | 必須 |
| parameters | JSON | モデルパラメータ | 必須 |
| dataSourceId | ID | データソースID | 必須、外部キー |
| trainingConfig | JSON | 学習設定 | 必須 |
| lastTrainedAt | DateTime | 最終学習日時 | 任意 |
| accuracy | Decimal | 精度 | 任意 |
| isActive | Boolean | 有効フラグ | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 予測タイプには「時系列予測」「回帰予測」「分類予測」などがある
- 学習設定には特徴量、期間、データ前処理方法などを指定
- 精度は学習実行時に算出される（0-1の値で、1が最高精度）

### 1.11 ForecastScenario（予測シナリオ）

予測分析のシナリオを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | シナリオID | 主キー、UUID形式 |
| name | String | シナリオ名 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| modelId | ID | モデルID | 必須、外部キー |
| parameters | JSON | シナリオパラメータ | 必須 |
| variables | JSON | 変数設定 | 必須 |
| startDate | Date | 開始日 | 必須 |
| endDate | Date | 終了日 | 必須 |
| resultSummary | JSON | 結果サマリー | 任意 |
| isBaseline | Boolean | ベースラインフラグ | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 各予測モデルに対してベースラインとなるシナリオを1つ設定可能
- ベースラインシナリオは削除不可
- 変数設定は予測モデルの変数に対する値の設定

### 1.12 CustomReport（カスタムレポート）

ユーザー定義のカスタムレポートを表すエンティティです。

| 属性名 | 型 | 説明 | 制約 |
|-------|------|------|------|
| id | ID | カスタムレポートID | 主キー、UUID形式 |
| name | String | レポート名称 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| category | ReportCategory | カテゴリ | 必須 |
| dataSourceIds | JSON | データソースIDリスト | 必須 |
| queryConfig | JSON | クエリ設定 | 必須 |
| filterConfig | JSON | フィルター設定 | 必須 |
| visualConfig | JSON | 可視化設定 | 必須 |
| isPublic | Boolean | 公開フラグ | 必須 |
| permissions | JSON | 権限設定 | 必須 |
| createdAt | DateTime | 作成日時 | 必須 |
| updatedAt | DateTime | 更新日時 | 必須 |
| createdBy | ID | 作成者ID | 必須 |
| updatedBy | ID | 更新者ID | 必須 |

**ビジネスルール**：
- 公開設定されたカスタムレポートは他ユーザーが参照可能
- 権限設定はロールベースの参照権限設定
- クエリ設定はビジュアルクエリビルダーで構築されたクエリ定義

## 2. 値オブジェクト

### 2.1 WidgetType（ウィジェット種別）

ダッシュボードウィジェットの種別を表す列挙型です。

```
enum WidgetType {
    KPI_CARD,        // KPI指標カード
    LINE_CHART,      // 折れ線グラフ
    BAR_CHART,       // 棒グラフ
    PIE_CHART,       // 円グラフ
    TABLE,           // テーブル
    HEAT_MAP,        // ヒートマップ
    GAUGE,           // ゲージ
    COUNTER,         // カウンター
    TEXT,            // テキスト
    ALERT            // アラート
}
```

### 2.2 KpiCategory（KPIカテゴリ）

KPI指標のカテゴリを表す列挙型です。

```
enum KpiCategory {
    SALES,           // 売上
    PROFIT,          // 利益
    UTILIZATION,     // 稼働率
    CUSTOMER,        // 顧客
    HR,              // 人事
    OPERATION,       // 業務
    QUALITY,         // 品質
    FINANCE          // 財務
}
```

### 2.3 TargetDirection（目標方向）

KPI指標の目標方向を表す列挙型です。

```
enum TargetDirection {
    HIGHER_BETTER,   // 高いほど良い
    LOWER_BETTER,    // 低いほど良い
    RANGE_OPTIMAL    // 範囲内が最適
}
```

### 2.4 TargetType（目標タイプ）

KPI目標のタイプを表す列挙型です。

```
enum TargetType {
    YEARLY,          // 年次
    QUARTERLY,       // 四半期
    MONTHLY          // 月次
}
```

### 2.5 ReportCategory（レポートカテゴリ）

レポートのカテゴリを表す列挙型です。

```
enum ReportCategory {
    SALES,           // 売上
    PROFIT,          // 利益
    UTILIZATION,     // 稼働率
    CUSTOMER,        // 顧客
    PROJECT,         // 案件
    ENGINEER,        // 技術者
    FINANCE,         // 財務
    ADMIN,           // 管理
    CUSTOM           // カスタム
}
```

### 2.6 ReportType（レポート種別）

レポートの種別を表す列挙型です。

```
enum ReportType {
    TABLE,           // テーブル形式
    CHART,           // グラフ形式
    DASHBOARD,       // ダッシュボード形式
    DOCUMENT,        // ドキュメント形式
    COMPOSITE        // 複合形式
}
```

### 2.7 ExecutionStatus（実行ステータス）

レポート実行のステータスを表す列挙型です。

```
enum ExecutionStatus {
    WAITING,         // 待機中
    RUNNING,         // 実行中
    COMPLETED,       // 完了
    FAILED,          // 失敗
    CANCELED         // キャンセル
}
```

### 2.8 DataSourceType（データソース種別）

データソースの種別を表す列挙型です。

```
enum DataSourceType {
    DATABASE,        // データベース
    REST_API,        // REST API
    CSV_FILE,        // CSVファイル
    EXCEL_FILE,      // Excelファイル
    MODULE_DATA,     // モジュールデータ
    CUSTOM_QUERY     // カスタムクエリ
}
```

### 2.9 ForecastType（予測タイプ）

予測分析のタイプを表す列挙型です。

```
enum ForecastType {
    TIME_SERIES,     // 時系列予測
    REGRESSION,      // 回帰予測
    CLASSIFICATION,  // 分類予測
    ANOMALY_DETECTION // 異常検知
}
```

### 2.10 ChartType（グラフ種別）

可視化で使用するグラフ種別を表す列挙型です。

```
enum ChartType {
    LINE,            // 折れ線グラフ
    BAR,             // 棒グラフ
    STACKED_BAR,     // 積み上げ棒グラフ
    PIE,             // 円グラフ
    SCATTER,         // 散布図
    RADAR,           // レーダーチャート
    HEAT_MAP,        // ヒートマップ
    BUBBLE,          // バブルチャート
    COMBO,           // 複合グラフ
    AREA             // エリアチャート
}
```

### 2.11 OutputFormat（出力形式）

レポートの出力形式を表す列挙型です。

```
enum OutputFormat {
    PDF,             // PDF
    EXCEL,           // Excel
    CSV,             // CSV
    HTML,            // HTML
    JSON,            // JSON
    IMAGE            // 画像
}
```

## 3. ドメイン関連図

以下は主要なエンティティ間の関連を示します。

```
Dashboard 1 --- * Widget
Widget * --- 1 DataSource

KpiDefinition 1 --- * KpiTarget
KpiDefinition 1 --- * KpiAchievement
KpiTarget 1 --- * KpiAchievement

Report 1 --- * ReportExecution
Report 1 --- * ReportSchedule
ReportSchedule 1 --- * ReportExecution

Report * --- * DataSource
DataSource 1 --- * Widget

ForecastModel 1 --- * ForecastScenario
ForecastModel 1 --- 1 DataSource

CustomReport * --- * DataSource
```

## 4. 重要なビジネスルール

### 4.1 KPI関連ルール

1. **KPI達成率の計算ルール**
   - 目標方向が「高いほど良い」の場合: 達成率 = 実績値 ÷ 目標値 × 100%
   - 目標方向が「低いほど良い」の場合: 達成率 = 目標値 ÷ 実績値 × 100%
   - 目標方向が「範囲内が最適」の場合:
     - 実績値が範囲内: 達成率 = 100%
     - 実績値が範囲外: 近い方の境界値との差に基づいて計算

2. **KPI表示色の決定ルール**
   - 達成率 >= 100%: 緑色（目標達成）
   - 80% <= 達成率 < 100%: 黄色（警告）
   - 達成率 < 80%: 赤色（要注意）
   - 目標方向によって色の適用が逆になる場合あり

3. **KPI階層ルール**
   - 全社KPIと部門KPIの階層関係を定義
   - 全社KPIは部門KPIの集計結果として自動計算可能な場合と、独立して計算する場合がある

### 4.2 レポート関連ルール

1. **レポートアクセス制御ルール**
   - レポートごとに閲覧可能なロールを設定
   - 機密性の高いレポート（粗利情報など）は特定ロールのみアクセス可能
   - 公開フラグがtrueのレポートは適切な権限を持つすべてのユーザーが閲覧可能

2. **レポート実行ルール**
   - 大量データを扱うレポートは非同期実行
   - 実行時間の長いレポートはバックグラウンドジョブとして処理
   - 実行履歴は一定期間保持（標準30日）

3. **レポート配信ルール**
   - スケジュール配信は指定された形式で生成
   - 配信先は個人またはグループで指定可能
   - セキュリティ要件に応じてZIP暗号化などの対策を実施

### 4.3 データソース関連ルール

1. **データアクセス制御ルール**
   - データソースごとにアクセス権限を設定
   - 機密データへのアクセスは監査ログを記録
   - 個人情報を含むデータは匿名化処理を実施

2. **データキャッシュルール**
   - キャッシュ有効のデータソースは指定された期間データをキャッシュ
   - リアルタイム性が求められるダッシュボードではキャッシュ無効も可能
   - 大量データを扱うレポートは前処理済みデータをキャッシュ

3. **クエリ実行ルール**
   - クエリのタイムアウト設定（デフォルト30秒）
   - 過負荷を防ぐためのクエリ複雑性制限
   - パラメータ化されたクエリの使用を強制

### 4.4 予測分析ルール

1. **予測モデル学習ルール**
   - 予測モデルは定期的（週次/月次）に再学習
   - 学習データは自動的に取得・前処理
   - 精度が基準値を下回る場合はアラート通知

2. **予測シナリオルール**
   - ベースラインシナリオは常に1つ存在
   - シナリオ変数の変動範囲に制限あり
   - 同一モデルに対して最大10シナリオまで作成可能