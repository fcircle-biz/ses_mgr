# ADR-002: Spring Data JDBCの採用

## ステータス
承認

## 作成日
2025-05-08

## 作成者
XXXX (xxxx@example.com)

## コンテキスト
SES業務システムのデータアクセス層の実装方法を決定する必要がある。システムはリレーショナルデータベース（PostgreSQL）を使用し、Java 21ベースのバックエンドで実装する。データアクセスフレームワークの選択は、開発効率、保守性、パフォーマンス、そして長期的なシステム品質に大きな影響を与える。

当初はJavaでのO/Rマッパーの事実上の標準であるJPA（Hibernate実装）の採用が検討されていたが、一般的なJPAの利用におけるいくつかの課題（N+1問題の発生しやすさ、エンティティの複雑なライフサイクル管理、LazyLoading時の問題など）を考慮し、代替案を検討している。

考慮すべき点：
- 開発効率と生産性
- オブジェクト関係マッピング（ORM）の複雑さ
- 学習曲線
- パフォーマンス特性
- バグ発生リスク
- 保守性
- 将来的な拡張性

## 決定
データアクセス層の実装技術として「Spring Data JDBC」を採用する。主な理由と実装方針は以下の通り：

1. **単純な永続化モデル**:
   - エンティティは単一のアグリゲートとして扱われる
   - Hibernateのようなセッション管理やキャッシュ機能を持たず、明示的なCRUD操作が行われる
   - 参照の単方向性により、オブジェクトグラフの複雑化を抑制

2. **SQL制御の柔軟性**:
   - 基本的なCRUD操作は自動生成されるが、複雑なクエリは`@Query`で明示的に記述可能
   - 必要に応じてネイティブSQLを使用できる

3. **実装方針**:
   - リポジトリインターフェースはドメインレイヤーに定義し、実装はインフラレイヤーに配置
   - 複雑なクエリはカスタムリポジトリメソッドに分離
   - 集約ルート（Aggregate Root）パターンの適用
   - 必要に応じてQueryDSLを組み合わせて使用

4. **データベースマイグレーション**:
   - Flywayを使用したバージョン管理されたデータベーススキーマ変更

## 結果
この決定による影響と結果：

### メリット
- **シンプルなメンタルモデル**: JPAの複雑なエンティティライフサイクル、Lazy/Eager Loading、キャッシュなどを理解する必要がない
- **N+1問題の回避**: 集約ルートの概念により、オブジェクトグラフの取得が明示的になり、N+1問題が発生しにくい
- **パフォーマンス**: 複雑なユースケースでもSQL最適化が容易、予測可能な振る舞い
- **DDDとの親和性**: 集約の概念がフレームワークレベルでサポートされている
- **テスト容易性**: 依存関係が少なく、テストが容易

### デメリット
- **手動マッピング**: 複雑な関連を持つオブジェクトでは手動マッピングが必要になる場合がある
- **LazyLoadingの欠如**: 必要に応じて明示的なクエリを書く必要がある
- **SQLの記述量増加**: 複雑な条件では生SQLまたはQueryDSLを使用する必要がある

### トレードオフ
- **自動化 vs 制御**: 高度な自動化（JPA）ではなく、より明示的な制御を選択
- **抽象化 vs 具体性**: データアクセスコードが若干冗長になる可能性があるが、挙動が明確で理解しやすい
- **生産性 vs パフォーマンス**: 短期的には若干の生産性低下の可能性があるが、長期的にはパフォーマンスと保守性に優れる

## 代替案
検討した他の選択肢：

### 1. JPA (Hibernate)
- **メリット**:
  - 広く採用されており、豊富なドキュメントとコミュニティサポート
  - 複雑なオブジェクト関係のマッピング機能
  - LazyLoading、キャッシュなどの高度な機能
- **デメリット**:
  - 複雑なエンティティライフサイクル
  - N+1問題が発生しやすい
  - パフォーマンスチューニングが難しい場合がある
  - 学習曲線が急
- **不採用理由**:
  - 複雑なデータアクセスパターンでのパフォーマンス懸念
  - 予測しにくい挙動によるバグ発生リスク
  - DDD集約の概念との不一致

### 2. MyBatis
- **メリット**:
  - SQLの完全な制御
  - シンプルな設計
  - パフォーマンスに優れる
- **デメリット**:
  - XMLベースの設定が冗長になりがち
  - Spring Data JDBCと比較して型安全性が低い
  - モダンなフレームワークとの統合が複雑になる可能性
- **不採用理由**:
  - Spring BootおよびSpringエコシステムとの統合がSpring Data JDBCほど緊密でない
  - 型安全性とコード生産性の観点からSpring Data JDBCが優位

### 3. jOOQ
- **メリット**:
  - 型安全なSQL構築
  - 高度なSQLサポート
  - 優れたパフォーマンス
- **デメリット**:
  - 有料ライセンスがある（商用データベース使用時）
  - 生成コードに依存
  - Spring Data JDBCよりセットアップが複雑
- **不採用理由**:
  - Spring Data JDBCで十分な機能とパフォーマンスが得られる
  - ライセンスコストと設定の複雑さを避ける
  - 必要に応じて一部機能で組み合わせて使用する選択肢は残す

## 参照情報
- [Spring Data JDBC Reference Documentation](https://docs.spring.io/spring-data/jdbc/docs/current/reference/html/)
- [DDD Aggregates and @Embedded with Spring Data JDBC](https://spring.io/blog/2018/09/24/spring-data-jdbc-references-and-aggregates)
- [JPA vs JDBC Performance Comparison](https://www.baeldung.com/jpa-vs-jdbc-performance)
- [Effective Aggregate Design by Vaughn Vernon](https://dddcommunity.org/library/vernon_2011/)