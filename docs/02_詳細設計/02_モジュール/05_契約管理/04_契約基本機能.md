# 契約基本機能

## 1. 機能概要

契約基本機能は、契約の作成、管理、検索、およびライフサイクル管理を行うための中核機能を提供します。契約の新規作成からステータス管理、契約期間の管理、契約終了処理までを一貫して扱うことで、契約プロセスの効率化と適切な契約管理を実現します。

## 2. 処理フロー

### 2.1 契約作成フロー

1. 契約作成リクエストの受け取り（契約種別、案件ID、技術者ID、開始日等）
2. 関連リソースの存在確認（案件情報、技術者情報等）
3. 契約番号の採番
4. 契約基本情報の生成
5. デフォルトステータス（DRAFT）の設定
6. 契約エンティティの永続化
7. 契約作成イベントの発行
8. 作成された契約情報の返却

### 2.2 契約更新フロー

1. 契約更新リクエストの受け取り（契約ID、更新内容）
2. 対象契約の取得と編集可能性の確認
3. 更新内容のバリデーション
4. 契約情報の更新
5. 契約エンティティの永続化
6. 契約更新イベントの発行
7. 更新された契約情報の返却

### 2.3 契約検索フロー

1. 検索条件の受け取り（契約種別、ステータス、日付範囲等）
2. 検索条件のバリデーション
3. アクセス権限の確認（ユーザーが閲覧可能な契約のみに絞り込み）
4. 検索条件による契約の検索
5. ページネーション処理
6. 検索結果の返却

### 2.4 契約ステータス更新フロー

1. ステータス更新リクエストの受け取り（契約ID、新ステータス、コメント）
2. 対象契約の取得と現在のステータスの確認
3. ステータス遷移の可否判定（ステータス遷移ルールに基づく）
4. ステータス更新処理
5. 日時情報の更新（承認日時、締結日時等）
6. 契約エンティティの永続化
7. ステータス変更イベントの発行
8. 更新された契約情報の返却

### 2.5 契約レビュー依頼フロー

1. レビュー依頼リクエストの受け取り（契約ID、レビュアーリスト、期限日等）
2. 対象契約の取得とレビュー可能状態の確認
3. レビュアーの存在確認と権限確認
4. レビュー依頼エンティティの作成
5. 契約ステータスの更新（REVIEW_IN_PROGRESS）
6. レビュー依頼と契約エンティティの永続化
7. レビュー依頼通知の送信
8. 作成されたレビュー依頼リストの返却

### 2.6 契約レビュー完了フロー

1. レビュー完了リクエストの受け取り（レビューID、結果ステータス、コメント）
2. 対象レビューの取得と処理可能状態の確認
3. レビュー情報の更新（ステータス、コメント、完了日時）
4. レビューエンティティの永続化
5. 同一契約の他のレビューステータス確認
   a. 全レビュー完了の場合、契約全体のレビュー完了処理
   b. 差し戻しがある場合、契約ステータスをDRAFTに戻す
6. ステータス変更通知の送信
7. 更新されたレビュー情報の返却

### 2.7 契約期間延長フロー

1. 契約期間延長リクエストの受け取り（契約ID、新終了日）
2. 対象契約の取得と期間延長可能状態の確認
3. 新終了日のバリデーション（開始日より後であることの確認等）
4. 契約終了日の更新
5. 契約エンティティの永続化
6. 期間延長イベントの発行
7. 更新された契約情報の返却

### 2.8 契約終了フロー

1. 契約終了リクエストの受け取り（契約ID、終了理由）
2. 対象契約の取得と終了可能状態の確認
3. 契約ステータスの更新（TERMINATEDまたはEXPIRED）
4. 契約終了日時の記録
5. 契約エンティティの永続化
6. 契約終了イベントの発行
7. 更新された契約情報の返却

## 3. 主要コンポーネント構成

### 3.1 ContractService

契約の基本操作を提供するサービスコンポーネントです。

```java
interface ContractService {
    Contract createContract(ContractCreateRequest request);
    Contract getContract(String contractId);
    Contract updateContract(String contractId, ContractUpdateRequest request);
    Page<Contract> searchContracts(ContractSearchRequest request, Pageable pageable);
    Contract updateContractStatus(String contractId, ContractStatus newStatus, String comment);
    List<ContractReview> requestContractReview(String contractId, ContractReviewRequest request);
    ContractReview completeContractReview(String reviewId, ReviewStatus status, String comment);
    Contract extendContractPeriod(String contractId, Date newEndDate);
    Contract terminateContract(String contractId, String reason);
}
```

### 3.2 ContractRepository

契約エンティティの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ContractRepository {
    Contract save(Contract contract);
    Optional<Contract> findById(String id);
    Page<Contract> findAll(Specification<Contract> spec, Pageable pageable);
    List<Contract> findByProjectId(String projectId);
    List<Contract> findByEngineerId(String engineerId);
    List<Contract> findByClientId(String clientId);
    List<Contract> findByStatusIn(List<ContractStatus> statuses);
    List<Contract> findByStartDateBeforeAndEndDateAfterAndStatus(Date date1, Date date2, ContractStatus status);
    long countByContractTypeAndStatus(ContractType contractType, ContractStatus status);
}
```

### 3.3 ContractReviewRepository

契約レビューエンティティの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ContractReviewRepository {
    ContractReview save(ContractReview review);
    Optional<ContractReview> findById(String id);
    List<ContractReview> findByContractId(String contractId);
    List<ContractReview> findByContractIdAndStatus(String contractId, ReviewStatus status);
    List<ContractReview> findByReviewerId(String reviewerId);
    List<ContractReview> findByReviewerIdAndStatus(String reviewerId, ReviewStatus status);
}
```

### 3.4 ContractNumberGenerator

契約番号を生成するコンポーネントです。

```java
interface ContractNumberGenerator {
    String generateContractNumber(ContractType contractType);
    boolean isContractNumberUnique(String contractNumber);
}
```

### 3.5 ContractStatusManager

契約ステータスの遷移管理を担当するコンポーネントです。

```java
interface ContractStatusManager {
    boolean canTransition(ContractStatus currentStatus, ContractStatus newStatus);
    void validateTransition(Contract contract, ContractStatus newStatus);
    List<ContractStatus> getNextPossibleStatuses(ContractStatus currentStatus);
    void performStatusTransition(Contract contract, ContractStatus newStatus, String comment);
}
```

### 3.6 ContractEventPublisher

契約関連イベントを発行するコンポーネントです。

```java
interface ContractEventPublisher {
    void publishContractCreated(Contract contract);
    void publishContractUpdated(Contract contract, String fieldName);
    void publishContractStatusChanged(Contract contract, ContractStatus oldStatus, ContractStatus newStatus);
    void publishContractReviewRequested(List<ContractReview> reviews);
    void publishContractReviewCompleted(ContractReview review);
    void publishContractTerminated(Contract contract, String reason);
}
```

### 3.7 ContractValidator

契約データの検証を行うコンポーネントです。

```java
interface ContractValidator {
    ValidationResult validateForCreation(ContractCreateRequest request);
    ValidationResult validateForUpdate(Contract contract, ContractUpdateRequest request);
    ValidationResult validateForStatusChange(Contract contract, ContractStatus newStatus);
    ValidationResult validateForReview(Contract contract, ContractReviewRequest request);
    ValidationResult validateForTermination(Contract contract, String reason);
}
```

## 4. 例外処理

### 4.1 ContractNotFoundException

指定された契約IDが存在しない場合に発生する例外です。

```java
class ContractNotFoundException extends ResourceNotFoundException {
    private String contractId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 ContractReviewNotFoundException

指定されたレビューIDが存在しない場合に発生する例外です。

```java
class ContractReviewNotFoundException extends ResourceNotFoundException {
    private String reviewId;
    
    // コンストラクタ、getterなど
}
```

### 4.3 InvalidContractStateException

契約が特定の操作を行うのに適切な状態でない場合に発生する例外です。

```java
class InvalidContractStateException extends BusinessRuleException {
    private String contractId;
    private ContractStatus currentStatus;
    private String operation;
    
    // コンストラクタ、getterなど
}
```

### 4.4 InvalidStatusTransitionException

無効なステータス遷移が要求された場合に発生する例外です。

```java
class InvalidStatusTransitionException extends BusinessRuleException {
    private String contractId;
    private ContractStatus currentStatus;
    private ContractStatus requestedStatus;
    private List<ContractStatus> allowedNextStatuses;
    
    // コンストラクタ、getterなど
}
```

### 4.5 ContractValidationException

契約データのバリデーションエラーが発生した場合の例外です。

```java
class ContractValidationException extends ValidationException {
    private Map<String, String> validationErrors;
    
    // コンストラクタ、getterなど
}
```

## 5. 契約ステータス遷移ルール

契約ステータスの遷移は、以下のルールに基づいて管理されます。

### 5.1 ステータス遷移マトリックス

| 現在のステータス | 遷移可能なステータス |
|---------------|-------------------|
| DRAFT | REVIEW_IN_PROGRESS, CANCELLED |
| REVIEW_IN_PROGRESS | REVIEW_COMPLETED, DRAFT, CANCELLED |
| REVIEW_COMPLETED | APPROVAL_PENDING, DRAFT, CANCELLED |
| APPROVAL_PENDING | APPROVED, DRAFT, CANCELLED |
| APPROVED | SIGNATURE_PENDING, DRAFT, CANCELLED |
| SIGNATURE_PENDING | EXECUTED, DRAFT, CANCELLED |
| EXECUTED | EXPIRED, TERMINATED, RENEWED |
| EXPIRED | - |
| TERMINATED | - |
| RENEWED | - |
| CANCELLED | - |

### 5.2 ステータス遷移時の自動アクション

特定のステータス遷移時には、以下の自動アクションが実行されます。

- **DRAFT → REVIEW_IN_PROGRESS**: レビュアーへの通知送信
- **REVIEW_COMPLETED → APPROVAL_PENDING**: 承認者への通知送信
- **APPROVAL_PENDING → APPROVED**: 承認日時の記録
- **APPROVED → SIGNATURE_PENDING**: 署名依頼の準備
- **SIGNATURE_PENDING → EXECUTED**: 締結日時の記録、契約データの固定化
- **EXECUTED → EXPIRED**: 契約期間の終了処理、関連システムへの通知
- **EXECUTED → TERMINATED**: 契約終了処理、関連システムへの通知
- **EXECUTED → RENEWED**: 更新契約との関連付け

## 6. 契約検索機能詳細

契約検索機能は、様々な検索条件を組み合わせて契約を柔軟に検索できる機能を提供します。

### 6.1 検索条件

- **契約種別**: 単一または複数の契約種別を指定
- **ステータス**: 単一または複数のステータスを指定
- **関連リソース**: 案件ID、技術者ID、取引先IDなどを指定
- **日付範囲**: 契約開始日、契約終了日、作成日などの日付範囲を指定
- **キーワード**: 契約の説明やタグに含まれるキーワードを指定
- **金額範囲**: 契約金額の範囲を指定

### 6.2 検索結果のソート

- 契約番号
- 作成日時
- 更新日時
- 契約開始日
- 契約終了日
- 契約金額
- ステータス

### 6.3 セキュリティフィルタリング

検索結果は、ユーザーのアクセス権限に基づいてフィルタリングされます。

- 一般ユーザー: 自分が担当する契約のみ閲覧可能
- 部門管理者: 自部門の契約を閲覧可能
- 法務担当者: 全ての契約を閲覧可能
- システム管理者: 全ての契約を閲覧可能

## 7. 契約レビュー機能詳細

契約レビュー機能は、複数のレビュアーによる契約内容の確認と承認を管理します。

### 7.1 レビューワークフロー

1. レビュー依頼の作成: 契約作成者がレビュアーを指定し、レビュー依頼を送信
2. レビュー通知: レビュアーへのメール通知とシステム内通知
3. レビュー実施: レビュアーが契約内容を確認し、承認または差し戻しを実施
4. レビュー完了判定:
   - 全レビュアーが承認した場合: レビュー完了、次のステップ（承認待ち）へ移行
   - 一人でも差し戻した場合: 契約は下書き状態に戻る

### 7.2 レビュー権限

- 法務レビュー: 契約書の法的観点からのレビュー（必須）
- 財務レビュー: 契約金額や支払条件などの財務的観点からのレビュー（一定金額以上で必須）
- 技術レビュー: 技術的な条件や仕様のレビュー（SES契約、業務委託契約で必須）
- 部門レビュー: 部門の業務観点からのレビュー（任意）

### 7.3 レビュー期限管理

- 各レビューには期限日を設定可能
- 期限切れが近づくとリマインダー通知を送信
- 期限切れのレビューは期限超過としてマーク
- 全レビュー完了または期限切れまでの進捗状況を視覚的に表示