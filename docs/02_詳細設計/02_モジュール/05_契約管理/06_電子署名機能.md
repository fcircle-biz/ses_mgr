# 電子署名機能

## 1. 機能概要

電子署名機能は、契約書の電子的な締結プロセスを実現するための機能を提供します。複数の関係者間で、法的に有効な電子署名を用いて契約書に署名し、デジタル環境で契約を締結するワークフローを管理します。署名依頼の送信から署名の収集、署名の検証、署名済み文書の保管まで、電子契約締結に必要な一連の機能を実装します。

## 2. 処理フロー

### 2.1 署名依頼作成フロー

1. 署名依頼リクエストの受け取り（契約ID、ドキュメントID、署名者情報等）
2. 契約とドキュメントの存在確認と署名可能状態の確認
3. 署名者情報のバリデーション
4. 電子署名エンティティの作成
5. 電子署名サービスへの署名依頼作成リクエスト送信
6. 署名依頼IDの受け取りと保存
7. 契約ステータスの更新（SIGNATURE_PENDING）
8. 電子署名エンティティの永続化
9. 署名依頼イベントの発行
10. 署名依頼情報の返却

### 2.2 署名ステータス確認フロー

1. 署名IDの受け取り
2. 電子署名エンティティの取得
3. 電子署名サービスからの署名状況の取得
4. 署名者ステータスの更新
5. 全署名者の署名完了確認
   a. 全署名者完了の場合は署名完了処理の実行
   b. 未完了の場合は現在の状態を返却
6. 電子署名エンティティの永続化
7. 署名ステータス更新イベントの発行
8. 更新された署名情報の返却

### 2.3 署名完了処理フロー

1. 署名IDの取得
2. 電子署名エンティティの取得
3. 電子署名サービスからの署名済み文書の取得
4. 署名済み文書のファイル保存
5. 署名済み契約書ドキュメントエンティティの作成
6. 契約ステータスの更新（EXECUTED）
7. 署名日時の記録
8. 関連エンティティの永続化
9. 署名完了イベントの発行
10. 署名完了情報の返却

### 2.4 署名依頼キャンセルフロー

1. 署名IDとキャンセル理由の受け取り
2. 電子署名エンティティの取得とキャンセル可能状態の確認
3. 電子署名サービスへの署名依頼キャンセルリクエスト送信
4. 電子署名エンティティのステータス更新（CANCELLED）
5. 契約ステータスの更新（元のステータスに戻す）
6. 電子署名エンティティの永続化
7. 署名キャンセルイベントの発行
8. 更新された署名情報の返却

### 2.5 署名リマインダー送信フロー

1. 署名IDと署名者IDの受け取り
2. 電子署名エンティティの取得と署名者の確認
3. 電子署名サービスへのリマインダー送信リクエスト
4. 署名者エンティティのリマインダー送信日時更新
5. 電子署名エンティティの永続化
6. リマインダー送信イベントの発行
7. 更新された署名者情報の返却

### 2.6 署名検証フロー

1. ドキュメントIDの受け取り
2. 契約書ドキュメントの取得
3. 関連する電子署名情報の取得
4. 電子署名サービスへの検証リクエスト送信
5. 署名の検証結果の受け取り
6. 検証イベントの記録
7. 検証結果の返却

## 3. 主要コンポーネント構成

### 3.1 ElectronicSignatureService

電子署名機能を提供するサービスコンポーネントです。

```java
interface ElectronicSignatureService {
    ElectronicSignature createSignatureRequest(String contractId, String documentId, SignatureRequest request);
    ElectronicSignature getSignatureStatus(String signatureId);
    ElectronicSignature cancelSignatureRequest(String signatureId, String reason);
    SignatureSigner sendSignatureReminder(String signatureId, String signerId);
    SignatureVerificationResult verifySignedDocument(String documentId);
    List<SignatureAuditEvent> getSignatureAuditTrail(String signatureId);
    ElectronicSignature processSignatureCallback(SignatureCallbackData callbackData);
}
```

### 3.2 ElectronicSignatureRepository

電子署名エンティティの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ElectronicSignatureRepository {
    ElectronicSignature save(ElectronicSignature signature);
    Optional<ElectronicSignature> findById(String id);
    List<ElectronicSignature> findByContractId(String contractId);
    Optional<ElectronicSignature> findBySignatureRequestId(String signatureRequestId);
    List<ElectronicSignature> findByStatus(SignatureStatus status);
    List<ElectronicSignature> findByContractIdAndStatus(String contractId, SignatureStatus status);
}
```

### 3.3 SignatureSignerRepository

署名者エンティティの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface SignatureSignerRepository {
    SignatureSigner save(SignatureSigner signer);
    Optional<SignatureSigner> findById(String id);
    List<SignatureSigner> findBySignatureId(String signatureId);
    List<SignatureSigner> findBySignatureIdAndStatus(String signatureId, SignerStatus status);
    Optional<SignatureSigner> findBySignatureIdAndEmail(String signatureId, String email);
}
```

### 3.4 ElectronicSignatureProvider

外部電子署名サービスとの連携を担当するコンポーネントです。

```java
interface ElectronicSignatureProvider {
    SignatureRequestResult createSignatureRequest(SignatureRequestData requestData);
    SignatureStatusResult getSignatureStatus(String signatureRequestId);
    SignedDocumentResult getSignedDocument(String signatureRequestId);
    void cancelSignatureRequest(String signatureRequestId, String reason);
    void sendReminderToSigner(String signatureRequestId, String signerEmail);
    SignatureVerificationResult verifySignature(byte[] signedDocument);
    List<SignatureAuditEvent> getAuditTrail(String signatureRequestId);
}
```

### 3.5 SignatureCallbackHandler

電子署名サービスからのコールバック処理を担当するコンポーネントです。

```java
interface SignatureCallbackHandler {
    void handleSignatureCompleted(String signatureRequestId);
    void handleSignatureDeclined(String signatureRequestId, String signerEmail, String reason);
    void handleSignatureExpired(String signatureRequestId);
    void handleSignerViewed(String signatureRequestId, String signerEmail);
    void handleSignerSigned(String signatureRequestId, String signerEmail);
}
```

### 3.6 SignatureEventPublisher

電子署名関連イベントを発行するコンポーネントです。

```java
interface SignatureEventPublisher {
    void publishSignatureRequested(ElectronicSignature signature);
    void publishSignatureCompleted(ElectronicSignature signature);
    void publishSignatureDeclined(ElectronicSignature signature, String signerEmail, String reason);
    void publishSignatureExpired(ElectronicSignature signature);
    void publishSignatureCancelled(ElectronicSignature signature, String reason);
    void publishSignerSigned(SignatureSigner signer);
    void publishReminderSent(SignatureSigner signer);
}
```

### 3.7 SignatureValidator

電子署名リクエストのバリデーションを行うコンポーネントです。

```java
interface SignatureValidator {
    ValidationResult validateSignatureRequest(String contractId, String documentId, SignatureRequest request);
    ValidationResult validateSignatureCancel(String signatureId);
    ValidationResult validateReminderSend(String signatureId, String signerId);
}
```

## 4. 例外処理

### 4.1 SignatureNotFoundException

指定された署名IDが存在しない場合に発生する例外です。

```java
class SignatureNotFoundException extends ResourceNotFoundException {
    private String signatureId;
    
    // コンストラクタ、getterなど
}
```

### 4.2 SignerNotFoundException

指定された署名者IDが存在しない場合に発生する例外です。

```java
class SignerNotFoundException extends ResourceNotFoundException {
    private String signerId;
    private String signatureId;
    
    // コンストラクタ、getterなど
}
```

### 4.3 SignatureServiceException

電子署名サービスとの連携中にエラーが発生した場合の例外です。

```java
class SignatureServiceException extends ExternalServiceException {
    private String signatureRequestId;
    private String operation;
    private String errorCode;
    private String errorMessage;
    
    // コンストラクタ、getterなど
}
```

### 4.4 InvalidSignatureStateException

署名が特定の操作を行うのに適切な状態でない場合に発生する例外です。

```java
class InvalidSignatureStateException extends BusinessRuleException {
    private String signatureId;
    private SignatureStatus currentStatus;
    private String operation;
    
    // コンストラクタ、getterなど
}
```

### 4.5 SignatureVerificationException

署名の検証に失敗した場合に発生する例外です。

```java
class SignatureVerificationException extends ApplicationException {
    private String documentId;
    private String verificationErrorCode;
    private String verificationErrorMessage;
    
    // コンストラクタ、getterなど
}
```

## 5. 署名ワークフロー詳細

署名ワークフローは、署名者の署名順序や署名方法を管理します。

### 5.1 署名順序制御

署名要求では、署名者に署名順序（signingOrder）を設定できます：

- **並行署名（同時署名）**: 全署名者に同時に署名依頼を送信し、任意の順序で署名可能
- **順次署名**: 署名順序に従って、前の署名者が署名を完了した後に次の署名者に依頼を送信
- **グループ署名**: 同じ署名順序の署名者グループ内では並行署名、グループ間では順次署名

### 5.2 署名ステータスの遷移

署名全体のステータス（SignatureStatus）は以下の遷移をします：

- **CREATED → SENT**: 署名依頼作成後、署名者への依頼送信時
- **SENT → IN_PROGRESS**: いずれかの署名者が署名プロセスを開始した時
- **IN_PROGRESS → COMPLETED**: 全署名者の署名が完了した時
- **SENT/IN_PROGRESS → DECLINED**: いずれかの署名者が署名を拒否した時
- **SENT/IN_PROGRESS → EXPIRED**: 署名期限が切れた時
- **SENT/IN_PROGRESS → CANCELLED**: 依頼者が署名依頼をキャンセルした時

署名者個別のステータス（SignerStatus）は以下の遷移をします：

- **PENDING → NOTIFIED**: 署名依頼が送信された時
- **NOTIFIED → VIEWED**: 署名者が署名依頼を閲覧した時
- **VIEWED → SIGNED**: 署名者が署名を完了した時
- **NOTIFIED/VIEWED → DECLINED**: 署名者が署名を拒否した時
- **NOTIFIED/VIEWED → EXPIRED**: 署名期限が切れた時

### 5.3 署名リマインダー管理

未署名の署名者に対してリマインダーを送信する機能を提供します：

- 自動リマインダー: 設定された間隔（例：3日ごと）で自動送信
- 手動リマインダー: 管理者が特定の署名者に対して送信
- リマインダーの頻度制限: 1日1回までなど、過度な通知を防止

### 5.4 署名期限管理

署名依頼には期限を設定できます：

- デフォルト期限: 30日間（設定可能）
- 期限切れアラート: 期限切れの数日前に通知
- 期限切れ処理: 期限切れ時に自動的にステータスを更新
- 期限延長: 管理者による期限の延長機能

## 6. 電子署名方式

本システムでは、法的に有効な以下の電子署名方式をサポートします。

### 6.1 デジタル署名

公開鍵暗号方式を使用した電子署名：

- PKI（公開鍵基盤）ベースの署名
- デジタル証明書による本人確認
- タイムスタンプによる署名時刻の証明
- 文書のハッシュ値を暗号化して署名を生成

### 6.2 クリック承認方式

メール認証とクリック承認による簡易的な電子署名：

- メールアドレス確認による本人確認
- IPアドレスや端末情報の記録
- クリック操作の監査証跡
- 署名日時のタイムスタンプ

### 6.3 署名の法的有効性確保

署名の法的有効性を確保するための要件：

- 署名者の本人確認（メール認証+ワンタイムパスワード等）
- 署名意思の明示的な確認
- 契約書の改変防止（ハッシュ値による整合性検証）
- 完全な監査証跡の記録
- 署名時刻の正確な記録（タイムスタンプ）

## 7. 署名監査証跡

署名プロセスの法的証明のために、詳細な監査証跡を記録します。

### 7.1 記録される監査情報

以下の情報が記録されます：

- 署名者情報（氏名、メールアドレス、組織、役職）
- 署名日時（タイムスタンプ付き）
- IPアドレス
- デバイス情報（OSやブラウザ）
- 署名プロセスの各ステップ（通知送信、閲覧、署名など）
- 認証情報（認証方法、認証日時）
- ドキュメントのハッシュ値（改ざん検知用）

### 7.2 監査証跡の保護

監査証跡データの保護方法：

- 改ざん防止（ブロックチェーン技術や耐タンパー記録の利用）
- 暗号化保存
- アクセス制限（監査権限を持つユーザーのみアクセス可能）
- 長期保存（法定保存期間に応じた保存）

### 7.3 監査レポート

監査証跡データの表示・エクスポート機能：

- 署名プロセスの完全なタイムライン表示
- 署名者ごとの詳細活動履歴
- 監査証明書のPDF出力
- 法的証拠としての監査レポート生成