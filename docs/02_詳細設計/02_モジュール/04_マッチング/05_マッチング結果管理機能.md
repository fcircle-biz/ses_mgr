# マッチング結果管理機能

## 1. 機能概要

マッチング結果管理機能は、案件と技術者のマッチング結果を永続化し、管理するための機能を提供します。マッチング検索で生成された結果の保存、履歴管理、分析機能を含み、過去のマッチング結果を参照して意思決定を支援します。また、マッチング結果の集計・分析を行い、マッチングアルゴリズムの改善にも役立てます。

## 2. 処理フロー

### 2.1 マッチング結果保存フロー

1. マッチング結果の受け取り
2. 結果データの検証
3. 重複チェック（同一案件-技術者の組み合わせ）
4. 既存結果がある場合は更新、ない場合は新規作成
5. 永続化処理
6. 関連するマッチング検索履歴との関連付け
7. 保存結果の返却

### 2.2 マッチング結果取得フロー

1. マッチング結果IDの受け取り
2. リポジトリからの結果取得
3. 権限チェック
4. 結果が存在しない場合は例外処理
5. 結果の返却

### 2.3 案件別マッチング結果取得フロー

1. 案件IDとページネーション情報の受け取り
2. 権限チェック
3. リポジトリからの結果取得
4. ソートとページング処理
5. 結果の返却

### 2.4 技術者別マッチング結果取得フロー

1. 技術者IDとページネーション情報の受け取り
2. 権限チェック
3. リポジトリからの結果取得
4. ソートとページング処理
5. 結果の返却

### 2.5 マッチング結果分析フロー

1. 分析条件の受け取り
2. 対象となるマッチング結果の取得
3. 統計処理の実行
4. 傾向分析の実行
5. 分析結果の集計
6. 結果の返却

## 3. 主要コンポーネント構成

### 3.1 MatchingResultService

マッチング結果管理機能の主要サービスインターフェースです。

```java
interface MatchingResultService {
    MatchingResult getMatchingResult(String resultId);
    List<MatchingResult> getMatchingResultsForProject(String projectId, Pageable pageable);
    List<MatchingResult> getMatchingResultsForEngineer(String engineerId, Pageable pageable);
    MatchingResult saveMatchingResult(MatchingResult result);
    void invalidateMatchingResult(String resultId, String reason);
    MatchingAnalysis analyzeMatchingResults(MatchingAnalysisRequest request);
}
```

### 3.2 MatchingResultRepository

マッチング結果を永続化するためのリポジトリです。

```java
interface MatchingResultRepository {
    MatchingResult save(MatchingResult result);
    Optional<MatchingResult> findById(String id);
    List<MatchingResult> findByProjectId(String projectId, Pageable pageable);
    List<MatchingResult> findByEngineerId(String engineerId, Pageable pageable);
    List<MatchingResult> findByProjectIdAndEngineerId(String projectId, String engineerId);
    List<MatchingResult> findByMatchingScoreGreaterThan(double score, Pageable pageable);
    List<MatchingResult> findByCreatedBetween(LocalDateTime start, LocalDateTime end, Pageable pageable);
}
```

### 3.3 MatchingResultValidator

マッチング結果のデータを検証するコンポーネントです。

```java
interface MatchingResultValidator {
    ValidationResult validate(MatchingResult result);
    boolean isDuplicate(MatchingResult result);
}
```

### 3.4 MatchingResultAnalyzer

マッチング結果の分析を行うコンポーネントです。

```java
interface MatchingResultAnalyzer {
    MatchingAnalysis analyzeByProject(String projectId, LocalDateTime startDate, LocalDateTime endDate);
    MatchingAnalysis analyzeByEngineer(String engineerId, LocalDateTime startDate, LocalDateTime endDate);
    MatchingAnalysis analyzeBySkill(String skillId, LocalDateTime startDate, LocalDateTime endDate);
    MatchingAnalysis analyzeByIndustry(String industryId, LocalDateTime startDate, LocalDateTime endDate);
    MatchingAnalysis analyzeOverall(LocalDateTime startDate, LocalDateTime endDate);
}
```

### 3.5 MatchingResultNotifier

マッチング結果に関する通知を送信するコンポーネントです。

```java
interface MatchingResultNotifier {
    void notifyHighMatchingScore(MatchingResult result, List<String> recipientIds);
    void notifyMatchingResultUpdate(MatchingResult oldResult, MatchingResult newResult, List<String> recipientIds);
    void notifyMatchingResultInvalidation(MatchingResult result, String reason, List<String> recipientIds);
}
```

## 4. 例外処理

### 4.1 MatchingResultNotFoundException

指定されたマッチング結果IDが存在しない場合に発生する例外です。

```java
class MatchingResultNotFoundException extends ResourceNotFoundException {
    // コンストラクタ、getterなど
}
```

### 4.2 DuplicateMatchingResultException

同一の案件-技術者の組み合わせで重複するマッチング結果が存在する場合に発生する例外です。

```java
class DuplicateMatchingResultException extends BusinessRuleException {
    private String existingResultId;
    
    // コンストラクタ、getterなど
}
```

### 4.3 InvalidMatchingResultDataException

マッチング結果のデータが不正な場合に発生する例外です。

```java
class InvalidMatchingResultDataException extends ValidationException {
    // コンストラクタ、getterなど
}
```

## 5. マッチング結果分析機能詳細

### 5.1 時系列分析

1. 期間ごとのマッチングスコア平均値の変化
2. 期間ごとのマッチング件数の変化
3. 期間ごとの高マッチ率の変化
4. 時系列トレンドの検出

### 5.2 スキル別分析

1. スキルごとのマッチングスコア分布
2. 不足スキルの特定と頻度分析
3. スキルレベルのギャップ分析
4. スキル重要度別の充足率分析

### 5.3 業界別分析

1. 業界ごとのマッチングスコア分布
2. 業界経験のギャップ分析
3. 業界別の技術者充足率分析
4. 業界間のスキル移転可能性分析

### 5.4 勤務条件分析

1. 単価帯ごとのマッチング分布
2. 勤務地条件の一致率分析
3. 稼働時期のギャップ分析
4. リモートワーク条件の一致率分析

### 5.5 総合分析

1. マッチング要素間の相関分析
2. マッチングスコアの分布分析
3. 成約率との相関分析
4. マッチングアルゴリズム改善のための提案生成

## 6. マッチング結果履歴管理

### 6.1 履歴保持ポリシー

1. 全てのマッチング結果は基本的に2年間保持
2. 提案が作成されたマッチング結果は5年間保持
3. 成約に至ったマッチング結果は契約期間終了後5年間保持
4. 分析目的で一部の結果を匿名化して長期保存

### 6.2 履歴管理機能

1. 過去のマッチング結果の閲覧
2. 特定条件での履歴検索
3. 結果の比較機能
4. 履歴のエクスポート機能
5. 定期的な履歴データのアーカイブ処理

### 6.3 マッチング結果変更追跡

1. マッチング結果の変更履歴の記録
2. 変更内容（スコア、詳細情報など）の差分管理
3. 変更理由の記録
4. 変更者情報の記録
5. 変更履歴の閲覧機能