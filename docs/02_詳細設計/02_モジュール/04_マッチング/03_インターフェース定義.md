# マッチング機能 インターフェース定義

## 1. インターフェース概要

マッチング機能モジュールは、案件と技術者のマッチング検索、マッチング結果の管理、提案の作成・管理、提案書の生成・管理などの機能を他モジュールに提供します。これらのインターフェースにより、営業担当者は案件に適した技術者を検索し、提案・契約までのプロセスを効率的に進めることができます。また、マッチング機能モジュール自身は技術者情報や案件情報を取得するために、技術者管理モジュールや案件管理モジュールなどのサービスを利用します。

## 2. 提供インターフェース

### 2.1 MatchingSearchService

案件と技術者のマッチング検索機能を提供するインターフェースです。

#### 2.1.1 searchEngineersForProject

```java
List<MatchingResult> searchEngineersForProject(
    String projectId, 
    SearchCriteria criteria, 
    Pageable pageable, 
    boolean saveSearch
);
```

- **説明**: 指定された案件IDまたは検索条件に基づいて、マッチングする技術者を検索します
- **パラメータ**:
  - projectId: 案件ID（nullの場合はcriteriaを使用）
  - criteria: 検索条件（projectIdがnullの場合に必須）
  - pageable: ページネーション情報
  - saveSearch: 検索履歴を保存するかどうか
- **戻り値**: マッチング結果のリスト
- **例外**:
  - ResourceNotFoundException: 指定されたprojectIdが存在しない場合
  - ValidationException: 検索条件が不正な場合
- **使用コンテキスト**: 営業担当者が案件に適した技術者を検索する際に使用されます。案件管理モジュールからも呼び出され、案件詳細画面での技術者推薦機能を実現します。

#### 2.1.2 searchProjectsForEngineer

```java
List<MatchingResult> searchProjectsForEngineer(
    String engineerId, 
    SearchCriteria criteria, 
    Pageable pageable, 
    boolean saveSearch
);
```

- **説明**: 指定された技術者IDまたは検索条件に基づいて、マッチングする案件を検索します
- **パラメータ**:
  - engineerId: 技術者ID（nullの場合はcriteriaを使用）
  - criteria: 検索条件（engineerIdがnullの場合に必須）
  - pageable: ページネーション情報
  - saveSearch: 検索履歴を保存するかどうか
- **戻り値**: マッチング結果のリスト
- **例外**:
  - ResourceNotFoundException: 指定されたengineerIdが存在しない場合
  - ValidationException: 検索条件が不正な場合
- **使用コンテキスト**: 技術者管理部門が特定の技術者に適した案件を探す際に使用されます。技術者管理モジュールからも呼び出され、技術者詳細画面での案件推薦機能を実現します。

#### 2.1.3 getSearchParameters

```java
Map<String, List<SearchParameter>> getSearchParameters(String category, String query);
```

- **説明**: マッチング検索で使用可能なパラメータ（スキル、業界、資格など）のリストを取得します
- **パラメータ**:
  - category: パラメータカテゴリ（"skills", "industries", "qualifications", "locations", "all"）
  - query: 検索クエリ（部分一致検索）
- **戻り値**: カテゴリ別のパラメータリスト
- **使用コンテキスト**: 検索画面で検索条件を入力する際のオートコンプリート機能や選択肢の表示に使用されます。

#### 2.1.4 getSearchHistory

```java
Page<MatchingSearch> getSearchHistory(
    MatchingSearchType type, 
    Pageable pageable
);
```

- **説明**: 過去に実行したマッチング検索の履歴を取得します
- **パラメータ**:
  - type: 検索タイプ（PROJECT_TO_ENGINEERS, ENGINEER_TO_PROJECTS, null=全て）
  - pageable: ページネーション情報
- **戻り値**: 検索履歴のページ
- **使用コンテキスト**: 検索履歴画面で過去の検索条件を再利用する際に使用されます。

### 2.2 MatchingResultService

マッチング結果の管理機能を提供するインターフェースです。

#### 2.2.1 getMatchingResult

```java
MatchingResult getMatchingResult(String resultId);
```

- **説明**: 指定されたIDのマッチング結果を取得します
- **パラメータ**:
  - resultId: マッチング結果ID
- **戻り値**: マッチング結果
- **例外**:
  - ResourceNotFoundException: 指定されたresultIdが存在しない場合
- **使用コンテキスト**: マッチング結果の詳細を表示する際に使用されます。提案作成時にもマッチング結果の詳細情報を参照するために使用されます。

#### 2.2.2 getMatchingResultsForProject

```java
List<MatchingResult> getMatchingResultsForProject(
    String projectId, 
    Pageable pageable
);
```

- **説明**: 指定された案件IDに関連するマッチング結果を取得します
- **パラメータ**:
  - projectId: 案件ID
  - pageable: ページネーション情報
- **戻り値**: マッチング結果のリスト
- **例外**:
  - ResourceNotFoundException: 指定されたprojectIdが存在しない場合
- **使用コンテキスト**: 案件管理モジュールから呼び出され、案件の詳細画面でマッチング履歴を表示する際に使用されます。

#### 2.2.3 getMatchingResultsForEngineer

```java
List<MatchingResult> getMatchingResultsForEngineer(
    String engineerId, 
    Pageable pageable
);
```

- **説明**: 指定された技術者IDに関連するマッチング結果を取得します
- **パラメータ**:
  - engineerId: 技術者ID
  - pageable: ページネーション情報
- **戻り値**: マッチング結果のリスト
- **例外**:
  - ResourceNotFoundException: 指定されたengineerIdが存在しない場合
- **使用コンテキスト**: 技術者管理モジュールから呼び出され、技術者の詳細画面でマッチング履歴を表示する際に使用されます。

#### 2.2.4 saveMatchingResult

```java
MatchingResult saveMatchingResult(MatchingResult result);
```

- **説明**: マッチング結果を保存します
- **パラメータ**:
  - result: 保存するマッチング結果
- **戻り値**: 保存されたマッチング結果
- **例外**:
  - ValidationException: マッチング結果が不正な場合
- **使用コンテキスト**: 主にシステム内部で使用され、マッチング検索の実行時に結果を保存するために使用されます。

### 2.3 ProposalService

技術者提案の作成・管理機能を提供するインターフェースです。

#### 2.3.1 createProposal

```java
Proposal createProposal(
    String projectId, 
    String engineerId, 
    String matchingResultId,
    ProposalCreateRequest request
);
```

- **説明**: 新しい提案を作成します
- **パラメータ**:
  - projectId: 案件ID
  - engineerId: 技術者ID
  - matchingResultId: マッチング結果ID
  - request: 提案作成リクエスト（単価、稼働開始日、備考など）
- **戻り値**: 作成された提案
- **例外**:
  - ResourceNotFoundException: 指定されたID（projectId, engineerId, matchingResultId）が存在しない場合
  - ValidationException: リクエストが不正な場合
  - BusinessRuleException: ビジネスルール違反の場合（例：同一期間での重複提案）
- **使用コンテキスト**: 営業担当者が案件に対して技術者を提案する際に使用されます。案件管理モジュールの案件詳細画面や技術者管理モジュールの技術者詳細画面から呼び出されます。

#### 2.3.2 updateProposalStatus

```java
Proposal updateProposalStatus(
    String proposalId, 
    ProposalStatus newStatus, 
    String notes
);
```

- **説明**: 提案のステータスを更新します
- **パラメータ**:
  - proposalId: 提案ID
  - newStatus: 新しいステータス
  - notes: 更新に関するメモ
- **戻り値**: 更新された提案
- **例外**:
  - ResourceNotFoundException: 指定されたproposalIdが存在しない場合
  - ValidationException: 不正なステータス遷移の場合
- **使用コンテキスト**: 提案の進捗管理において、各段階（提案中→面談→成約など）で状態を更新する際に使用されます。

#### 2.3.3 getProposal

```java
Proposal getProposal(String proposalId);
```

- **説明**: 指定されたIDの提案を取得します
- **パラメータ**:
  - proposalId: 提案ID
- **戻り値**: 提案
- **例外**:
  - ResourceNotFoundException: 指定されたproposalIdが存在しない場合
- **使用コンテキスト**: 提案の詳細を表示する際に使用されます。契約管理モジュールからも呼び出され、提案から契約への移行時に提案情報を参照します。

#### 2.3.4 getProposalsForProject

```java
List<Proposal> getProposalsForProject(
    String projectId, 
    List<ProposalStatus> statuses, 
    Pageable pageable
);
```

- **説明**: 指定された案件IDに関連する提案を取得します
- **パラメータ**:
  - projectId: 案件ID
  - statuses: フィルタするステータスのリスト（nullの場合は全てのステータス）
  - pageable: ページネーション情報
- **戻り値**: 提案のリスト
- **例外**:
  - ResourceNotFoundException: 指定されたprojectIdが存在しない場合
- **使用コンテキスト**: 案件管理モジュールから呼び出され、案件の詳細画面で提案一覧を表示する際に使用されます。

#### 2.3.5 getProposalsForEngineer

```java
List<Proposal> getProposalsForEngineer(
    String engineerId, 
    List<ProposalStatus> statuses, 
    Pageable pageable
);
```

- **説明**: 指定された技術者IDに関連する提案を取得します
- **パラメータ**:
  - engineerId: 技術者ID
  - statuses: フィルタするステータスのリスト（nullの場合は全てのステータス）
  - pageable: ページネーション情報
- **戻り値**: 提案のリスト
- **例外**:
  - ResourceNotFoundException: 指定されたengineerIdが存在しない場合
- **使用コンテキスト**: 技術者管理モジュールから呼び出され、技術者の詳細画面で提案一覧を表示する際に使用されます。

### 2.4 ProposalDocumentService

提案書の生成・管理機能を提供するインターフェースです。

#### 2.4.1 generateProposalDocument

```java
ProposalDocument generateProposalDocument(
    String proposalId, 
    DocumentType type, 
    DocumentGenerateRequest request
);
```

- **説明**: 提案に関連する書類を生成します
- **パラメータ**:
  - proposalId: 提案ID
  - type: 書類タイプ
  - request: 書類生成リクエスト（テンプレートID、カスタマイズパラメータなど）
- **戻り値**: 生成された書類
- **例外**:
  - ResourceNotFoundException: 指定されたproposalIdが存在しない場合
  - ValidationException: リクエストが不正な場合
- **使用コンテキスト**: 提案を作成する際に、技術者のスキルシートや提案書を自動生成するために使用されます。提案詳細画面の書類生成機能から呼び出されます。

#### 2.4.2 getProposalDocument

```java
ProposalDocument getProposalDocument(String documentId);
```

- **説明**: 指定されたIDの提案書類を取得します
- **パラメータ**:
  - documentId: 書類ID
- **戻り値**: 提案書類
- **例外**:
  - ResourceNotFoundException: 指定されたdocumentIdが存在しない場合
- **使用コンテキスト**: 提案書の詳細を表示する際や、ダウンロードする際に使用されます。

#### 2.4.3 getProposalDocumentsForProposal

```java
List<ProposalDocument> getProposalDocumentsForProposal(
    String proposalId, 
    DocumentType type
);
```

- **説明**: 指定された提案IDに関連する書類を取得します
- **パラメータ**:
  - proposalId: 提案ID
  - type: 書類タイプ（nullの場合は全てのタイプ）
- **戻り値**: 提案書類のリスト
- **例外**:
  - ResourceNotFoundException: 指定されたproposalIdが存在しない場合
- **使用コンテキスト**: 提案詳細画面で提案に関連する書類一覧を表示する際に使用されます。

#### 2.4.4 updateProposalDocument

```java
ProposalDocument updateProposalDocument(
    String documentId, 
    DocumentUpdateRequest request
);
```

- **説明**: 提案書類を更新します
- **パラメータ**:
  - documentId: 書類ID
  - request: 更新リクエスト（名前、メタデータなど）
- **戻り値**: 更新された書類
- **例外**:
  - ResourceNotFoundException: 指定されたdocumentIdが存在しない場合
  - ValidationException: リクエストが不正な場合
- **使用コンテキスト**: 提案書の内容を更新する際に使用されます。提案書編集画面から呼び出されます。

## 3. 要求インターフェース

### 3.1 EngineerProfileService（技術者管理モジュール）

技術者の基本情報、スキル情報を取得するためのインターフェースです。

#### 3.1.1 getEngineerProfile

```java
EngineerProfile getEngineerProfile(String engineerId);
```

- **説明**: 指定された技術者IDの基本情報を取得します
- **パラメータ**:
  - engineerId: 技術者ID
- **戻り値**: 技術者プロファイル
- **例外**:
  - ResourceNotFoundException: 指定されたengineerIdが存在しない場合
- **目的と使用文脈**: マッチング検索やスコア計算時に、技術者の基本情報（氏名、経験年数など）を取得するために使用します。提案作成時にも技術者情報を取得するために使用されます。

#### 3.1.2 getEngineerSkills

```java
List<EngineerSkill> getEngineerSkills(String engineerId);
```

- **説明**: 指定された技術者IDのスキル情報を取得します
- **パラメータ**:
  - engineerId: 技術者ID
- **戻り値**: 技術者スキルのリスト
- **例外**:
  - ResourceNotFoundException: 指定されたengineerIdが存在しない場合
- **目的と使用文脈**: マッチングスコア計算時に、技術者のスキルレベルと案件のスキル要件を比較するために使用します。

#### 3.1.3 getEngineerAvailability

```java
EngineerAvailability getEngineerAvailability(String engineerId);
```

- **説明**: 指定された技術者IDの稼働可能状況を取得します
- **パラメータ**:
  - engineerId: 技術者ID
- **戻り値**: 技術者の稼働可能状況
- **例外**:
  - ResourceNotFoundException: 指定されたengineerIdが存在しない場合
- **目的と使用文脈**: マッチング検索時に、技術者の稼働可能時期と案件の期間を比較するために使用します。提案作成時にも技術者の稼働状況を確認するために使用されます。

### 3.2 ProjectService（案件管理モジュール）

案件の基本情報、要件情報を取得するためのインターフェースです。

#### 3.2.1 getProject

```java
Project getProject(String projectId);
```

- **説明**: 指定された案件IDの基本情報を取得します
- **パラメータ**:
  - projectId: 案件ID
- **戻り値**: 案件情報
- **例外**:
  - ResourceNotFoundException: 指定されたprojectIdが存在しない場合
- **目的と使用文脈**: マッチング検索やスコア計算時に、案件の基本情報（案件名、期間、場所など）を取得するために使用します。提案作成時にも案件情報を取得するために使用されます。

#### 3.2.2 getProjectRequirements

```java
ProjectRequirements getProjectRequirements(String projectId);
```

- **説明**: 指定された案件IDの要件情報を取得します
- **パラメータ**:
  - projectId: 案件ID
- **戻り値**: 案件要件情報
- **例外**:
  - ResourceNotFoundException: 指定されたprojectIdが存在しない場合
- **目的と使用文脈**: マッチングスコア計算時に、案件のスキル要件と技術者のスキルを比較するために使用します。

### 3.3 FileStorageService（共通機能）

ファイルの保存・取得を行うためのインターフェースです。

#### 3.3.1 storeFile

```java
String storeFile(byte[] content, String fileName, String contentType, Map<String, String> metadata);
```

- **説明**: ファイルを保存します
- **パラメータ**:
  - content: ファイル内容
  - fileName: ファイル名
  - contentType: コンテンツタイプ
  - metadata: メタデータ
- **戻り値**: 保存されたファイルのID
- **目的と使用文脈**: 提案書や技術者スキルシートなどの書類を保存するために使用します。生成された書類のPDFデータなどを保存し、IDを取得して提案書類情報に関連付けます。

#### 3.3.2 getFile

```java
FileContent getFile(String fileId);
```

- **説明**: 指定されたIDのファイルを取得します
- **パラメータ**:
  - fileId: ファイルID
- **戻り値**: ファイル内容
- **例外**:
  - ResourceNotFoundException: 指定されたfileIdが存在しない場合
- **目的と使用文脈**: 提案書やスキルシートなどの書類を表示・ダウンロードする際に使用します。

### 3.4 NotificationService（共通機能）

通知の送信を行うためのインターフェースです。

#### 3.4.1 sendNotification

```java
void sendNotification(NotificationRequest request);
```

- **説明**: 通知を送信します
- **パラメータ**:
  - request: 通知リクエスト（受信者、タイトル、内容、タイプなど）
- **目的と使用文脈**: マッチング結果の通知や提案ステータスの変更通知を送信するために使用します。例えば、高マッチ度の技術者が見つかった場合や提案が成約した場合に関係者に通知します。

## 4. データ交換モデル

マッチング機能モジュールで使用される主要なデータ交換モデル（DTO）を定義します。

### 4.1 SearchCriteriaDTO

```java
class SearchCriteriaDTO {
    List<SkillCriteriaDTO> skills;
    List<ExperienceCriteriaDTO> experience;
    List<QualificationCriteriaDTO> qualifications;
    WorkLocationCriteriaDTO workLocation;
    WorkConditionCriteriaDTO workConditions;
}
```

### 4.2 MatchingResultDTO

```java
class MatchingResultDTO {
    String id;
    String projectId;
    String projectName;
    String engineerId;
    String engineerName;
    BigDecimal matchingScore;
    MatchingDetailsDTO matchingDetails;
    String status;
    LocalDateTime created;
    LocalDateTime lastUpdated;
}
```

### 4.3 MatchingDetailsDTO

```java
class MatchingDetailsDTO {
    SkillMatchResultDTO skills;
    ExperienceMatchResultDTO experience;
    QualificationMatchResultDTO qualifications;
    WorkLocationMatchResultDTO workLocation;
    WorkConditionMatchResultDTO workConditions;
}
```

### 4.4 ProposalCreateRequestDTO

```java
class ProposalCreateRequestDTO {
    Integer rate;
    LocalDate workStartDate;
    LocalDate workEndDate;
    String notes;
}
```

### 4.5 ProposalDTO

```java
class ProposalDTO {
    String id;
    String projectId;
    ProjectSummaryDTO project;
    String engineerId;
    EngineerSummaryDTO engineer;
    String matchingResultId;
    LocalDate proposalDate;
    String status;
    Integer rate;
    LocalDate workStartDate;
    LocalDate workEndDate;
    String notes;
    List<ProposalDocumentDTO> documents;
    List<ProposalHistoryDTO> history;
    LocalDateTime created;
    UserDTO createdBy;
    LocalDateTime lastUpdated;
    UserDTO lastUpdatedBy;
}
```

### 4.6 DocumentGenerateRequestDTO

```java
class DocumentGenerateRequestDTO {
    String templateId;
    Map<String, Object> parameters;
    Boolean includeCompanyProfile;
    Boolean includeSkillDetails;
    String customNote;
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- マッチング検索は3秒以内に結果を返すこと
- マッチング結果の保存は1秒以内に完了すること
- 提案書生成は5秒以内に完了すること
- 同時に100ユーザーの検索リクエストを処理できること

### 5.2 セキュリティ要件

- マッチング結果へのアクセスは認可されたユーザーのみに制限すること
- 提案書には適切なアクセス制御を適用し、関係者のみがアクセス可能にすること
- 技術者の個人情報を含む検索結果は暗号化して保存すること
- 全ての外部インターフェース呼び出しはTLS 1.2以上で暗号化すること

### 5.3 トランザクション要件

- マッチング検索は読み取り専用トランザクションで実行すること
- 提案作成・更新は完全なACIDトランザクションで実行すること
- 提案ステータス更新時は関連する通知送信も同一トランザクション内で行うこと