# マッチングモジュール ドメインモデル

## 1. エンティティ

### 1.1 マッチング結果 (MatchingResult)

マッチング結果エンティティは、案件と技術者のマッチング結果情報を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| matchingId | Long | マッチングID | 主キー、自動採番 |
| projectId | Long | 案件ID | FK(projects)、必須 |
| engineerId | Long | 技術者ID | FK(engineers)、必須 |
| requirementId | Long | 要員要件ID | FK(resource_requirements)、任意 |
| matchingScore | Double | マッチング度 | 必須、0.0-100.0の範囲 |
| statusId | Long | ステータスID | FK(matching_statuses)、必須 |
| matchingDate | Date | マッチング日 | 必須、自動設定 |
| expirationDate | Date | 有効期限 | 任意、matchingDateより後の日付 |
| assignmentStartDate | Date | アサイン開始予定日 | 任意 |
| assignmentEndDate | Date | アサイン終了予定日 | 任意、assignmentStartDateより後の日付 |
| proposedRate | Money | 提案単価 | 任意、値オブジェクト |
| suggestedBy | Long | 提案者ID | FK(users)、必須 |
| approvedBy | Long | 承認者ID | FK(users)、任意 |
| memo | String | メモ | 任意、最大1000文字 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- マッチング度は0.0〜100.0の範囲で、スキル要件、経験、条件等の一致度に基づいて算出
- 案件と技術者の組み合わせは一意であるが、異なる要員要件に対しては複数のマッチング結果が存在可能
- 有効期限を過ぎたマッチング結果は自動的に無効化される
- アサイン開始予定日と終了予定日は、案件の期間内である必要がある

### 1.2 マッチングステータス (MatchingStatus)

マッチングステータスエンティティは、マッチング結果の状態を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| statusId | Long | ステータスID | 主キー、自動採番 |
| statusCode | String | ステータスコード | 必須、一意、最大50文字 |
| statusName | String | ステータス名 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| displayOrder | Integer | 表示順 | 必須、0以上の整数 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| color | String | 表示色 | 任意、HEX形式(#RRGGBB) |
| allowedNextStatuses | String | 遷移可能な次ステータス | カンマ区切りのステータスコード |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |

**ビジネスルール：**
- ステータスコードは一意であり、マッチングのワークフローを表現する
- allowedNextStatusesに指定されたステータスにのみ遷移可能
- ステータスの追加・変更は管理者のみ実行可能

### 1.3 マッチング詳細 (MatchingDetail)

マッチング詳細エンティティは、マッチング結果の詳細情報（スキル評価など）を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| detailId | Long | 詳細ID | 主キー、自動採番 |
| matchingId | Long | マッチングID | FK(matching_results)、必須 |
| itemType | ItemType | 項目種別 | 必須（列挙型） |
| itemKey | String | 項目キー | 必須、最大100文字 |
| itemName | String | 項目名 | 必須、最大100文字 |
| requiredValue | String | 要求値 | 必須、最大200文字 |
| actualValue | String | 実際値 | 必須、最大200文字 |
| matchLevel | Integer | マッチレベル | 必須、0-5の整数 |
| weight | Double | 重み | 必須、0.0-10.0の範囲、デフォルト1.0 |
| contribution | Double | 貢献度 | 必須、0.0-100.0の範囲 |
| memo | String | メモ | 任意、最大500文字 |

**ビジネスルール：**
- マッチレベルは0（不一致）〜5（完全一致）の整数値
- 貢献度はマッチレベルと重みに基づいて算出され、全体のマッチング度への寄与率を表す
- 項目種別によって、要求値と実際値の比較ロジックが異なる

### 1.4 提案 (Proposal)

提案エンティティは、マッチング結果に基づく顧客への提案情報を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| proposalId | Long | 提案ID | 主キー、自動採番 |
| proposalCode | String | 提案コード | 必須、一意、自動生成 |
| projectId | Long | 案件ID | FK(projects)、必須 |
| proposalType | ProposalType | 提案種別 | 必須（列挙型） |
| statusId | Long | ステータスID | FK(proposal_statuses)、必須 |
| title | String | 提案タイトル | 必須、最大200文字 |
| proposalDate | Date | 提案日 | 必須 |
| validUntil | Date | 有効期限 | 任意、proposalDateより後の日付 |
| totalAmount | Money | 提案総額 | 任意、値オブジェクト |
| customerContactId | Long | 顧客担当者ID | FK(customer_contacts)、任意 |
| salesRepId | Long | 営業担当者ID | FK(users)、必須 |
| description | String | 提案概要 | 任意、最大2000文字 |
| termsAndConditions | String | 提案条件 | 任意、最大2000文字 |
| internalNote | String | 社内メモ | 任意、最大1000文字 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- 提案コードは「P-YYYYMMDD-NNNN」形式で自動生成される
- 提案種別により必須項目や検証ルールが異なる
- 有効期限を過ぎた提案は自動的に期限切れステータスに変更される
- 提案総額は提案技術者の単価と期間から自動計算される場合がある

### 1.5 提案ステータス (ProposalStatus)

提案ステータスエンティティは、提案の状態を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| statusId | Long | ステータスID | 主キー、自動採番 |
| statusCode | String | ステータスコード | 必須、一意、最大50文字 |
| statusName | String | ステータス名 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| displayOrder | Integer | 表示順 | 必須、0以上の整数 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| color | String | 表示色 | 任意、HEX形式(#RRGGBB) |
| allowedNextStatuses | String | 遷移可能な次ステータス | カンマ区切りのステータスコード |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |

**ビジネスルール：**
- ステータスコードは一意であり、提案のワークフローを表現する
- allowedNextStatusesに指定されたステータスにのみ遷移可能
- ステータスの追加・変更は管理者のみ実行可能

### 1.6 提案技術者 (ProposalEngineer)

提案技術者エンティティは、提案に含まれる技術者情報を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| proposalEngineerId | Long | 提案技術者ID | 主キー、自動採番 |
| proposalId | Long | 提案ID | FK(proposals)、必須 |
| matchingId | Long | マッチングID | FK(matching_results)、必須 |
| engineerId | Long | 技術者ID | FK(engineers)、必須 |
| requirementId | Long | 要員要件ID | FK(resource_requirements)、任意 |
| position | String | ポジション | 必須、最大100文字 |
| proposedRate | Money | 提案単価 | 必須、値オブジェクト |
| assignmentStartDate | Date | アサイン開始予定日 | 必須 |
| assignmentEndDate | Date | アサイン終了予定日 | 必須、assignmentStartDateより後の日付 |
| workRate | Integer | 稼働率 | 必須、0-100の整数、デフォルト100 |
| skillSheetId | Long | スキルシートID | FK(skill_sheets)、任意 |
| note | String | 備考 | 任意、最大500文字 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |

**ビジネスルール：**
- 同一提案内での技術者の重複は不可
- アサイン開始・終了予定日は案件期間内である必要がある
- 提案単価は技術者の標準単価を下回る場合、承認が必要
- 稼働率は案件の条件に合致している必要がある

### 1.7 提案書 (ProposalDocument)

提案書エンティティは、提案に添付される提案書ドキュメントを表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| documentId | Long | ドキュメントID | 主キー、自動採番 |
| proposalId | Long | 提案ID | FK(proposals)、必須 |
| documentType | DocumentType | ドキュメント種別 | 必須（列挙型） |
| title | String | タイトル | 必須、最大200文字 |
| version | String | バージョン | 必須、最大20文字 |
| content | Clob | 内容 | 必須 |
| fileId | Long | ファイルID | FK(files)、任意 |
| templateId | Long | テンプレートID | FK(proposal_templates)、任意 |
| isDefault | Boolean | 既定フラグ | 必須、デフォルトfalse |
| approvalStatus | ApprovalStatus | 承認状態 | 必須（列挙型） |
| approvedBy | Long | 承認者ID | 承認済の場合必須、FK(users) |
| approvedAt | Timestamp | 承認日時 | 承認済の場合必須 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- 既定フラグが立っている提案書は提案につき1つのみ
- 承認状態が「承認済」の場合、承認者と承認日時は必須
- 版数管理のため、同一タイトルの提案書は異なるバージョンとして保存される
- 提案書の内容はHTMLまたはマークダウン形式で保存され、エクスポート時にPDFやWord形式に変換される

### 1.8 マッチング検索条件 (MatchingSearchCriteria)

マッチング検索条件エンティティは、保存されたマッチング検索条件を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| criteriaId | Long | 条件ID | 主キー、自動採番 |
| criteriaName | String | 条件名 | 必須、最大100文字 |
| criteriaType | CriteriaType | 条件種別 | 必須（列挙型） |
| userId | Long | ユーザーID | FK(users)、必須 |
| targetId | Long | 対象ID | 条件種別に応じて案件IDまたは技術者ID、任意 |
| criteriaJson | String | 条件JSON | 必須、JSON形式の検索条件 |
| description | String | 説明 | 任意、最大500文字 |
| isShared | Boolean | 共有フラグ | 必須、デフォルトfalse |
| lastUsedAt | Timestamp | 最終使用日時 | 任意 |
| isActive | Boolean | 有効フラグ | 必須、デフォルトtrue |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |
| createdBy | Long | 作成者ID | 必須、FK(users) |
| updatedBy | Long | 更新者ID | 必須、FK(users) |

**ビジネスルール：**
- 条件種別によって対象IDの意味が異なる（案件からの検索、技術者からの検索）
- 共有フラグがtrueの場合、他のユーザーも検索条件を参照可能
- 検索条件はJSON形式で保存し、UI表示時に解析される

## 2. 値オブジェクト

### 2.1 金額 (Money)

金額は通貨付きの金額を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| amount | BigDecimal | 金額 | 必須、0以上 |
| currency | Currency | 通貨 | 必須（列挙型） |

### 2.2 マッチング条件 (MatchingCondition)

マッチング条件は技術者または案件の検索条件を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| targetType | TargetType | 対象種別 | 必須（技術者/案件） |
| skillCriteria | List<SkillCriteria> | スキル条件リスト | 任意 |
| experienceCriteria | ExperienceCriteria | 経験条件 | 任意 |
| locationCriteria | LocationCriteria | 勤務地条件 | 任意 |
| rateCriteria | RateCriteria | 単価条件 | 任意 |
| availabilityCriteria | AvailabilityCriteria | 稼働条件 | 任意 |
| customCriteria | Map<String, Object> | カスタム条件 | 任意 |

### 2.3 スキル条件 (SkillCriteria)

スキル条件はマッチングにおけるスキル要件を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| skillId | Long | スキルID | 必須 |
| minLevel | Integer | 最低レベル | 必須、1-5の整数 |
| preferredLevel | Integer | 希望レベル | 任意、minLevel以上、最大5 |
| isRequired | Boolean | 必須フラグ | 必須、デフォルトtrue |
| weight | Double | 重み | 必須、0.0-10.0の範囲、デフォルト1.0 |

### 2.4 経験条件 (ExperienceCriteria)

経験条件はマッチングにおける経験要件を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| minYears | Integer | 最低経験年数 | 任意、0以上 |
| jobTypes | List<JobType> | 職種リスト | 任意 |
| domains | List<String> | 業務領域リスト | 任意 |
| projectTypes | List<String> | 案件種別リスト | 任意 |
| weight | Double | 重み | 必須、0.0-10.0の範囲、デフォルト1.0 |

### 2.5 勤務地条件 (LocationCriteria)

勤務地条件はマッチングにおける勤務地要件を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| locations | List<String> | 勤務地リスト | 任意 |
| workStyles | List<WorkStyle> | 勤務形態リスト | 任意 |
| maxCommutingTime | Integer | 最大通勤時間（分） | 任意、0以上 |
| weight | Double | 重み | 必須、0.0-10.0の範囲、デフォルト1.0 |

### 2.6 単価条件 (RateCriteria)

単価条件はマッチングにおける単価要件を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| minRate | Money | 最低単価 | 任意、値オブジェクト |
| maxRate | Money | 最高単価 | 任意、minRate以上、値オブジェクト |
| targetRate | Money | 目標単価 | 任意、値オブジェクト |
| billingTypes | List<BillingType> | 請求種別リスト | 任意 |
| weight | Double | 重み | 必須、0.0-10.0の範囲、デフォルト1.0 |

### 2.7 稼働条件 (AvailabilityCriteria)

稼働条件はマッチングにおける稼働要件を表現する値オブジェクトです。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| startDate | Date | 開始日 | 任意 |
| endDate | Date | 終了日 | 任意、startDateより後の日付 |
| minWorkRate | Integer | 最低稼働率 | 任意、0-100の整数 |
| availabilityTypes | List<AvailabilityType> | 稼働状態リスト | 任意 |
| weight | Double | 重み | 必須、0.0-10.0の範囲、デフォルト1.0 |

## 3. 列挙型

### 3.1 項目種別 (ItemType)
- SKILL: スキル
- EXPERIENCE: 経験
- CERTIFICATION: 資格
- LOCATION: 勤務地
- RATE: 単価
- AVAILABILITY: 稼働状況
- WORK_STYLE: 勤務形態
- CUSTOM: カスタム項目

### 3.2 提案種別 (ProposalType)
- RESOURCE: 人材提案
- PROJECT: プロジェクト提案
- SOLUTION: ソリューション提案
- MIXED: 複合提案

### 3.3 ドキュメント種別 (DocumentType)
- PROPOSAL: 提案書
- SKILL_SHEET: スキルシート
- PRICE_QUOTE: 見積書
- COVER_LETTER: 送付状
- SUPPLEMENT: 補足資料

### 3.4 承認状態 (ApprovalStatus)
- DRAFT: 下書き
- PENDING: 承認待ち
- APPROVED: 承認済
- REJECTED: 却下

### 3.5 条件種別 (CriteriaType)
- PROJECT_TO_ENGINEER: 案件から技術者検索
- ENGINEER_TO_PROJECT: 技術者から案件検索
- CUSTOM: カスタム検索

### 3.6 対象種別 (TargetType)
- ENGINEER: 技術者
- PROJECT: 案件

### 3.7 通貨 (Currency)
- JPY: 日本円
- USD: 米ドル
- EUR: ユーロ
- GBP: 英ポンド
- CNY: 中国元

### 3.8 職種 (JobType)
- PROGRAMMER: プログラマー
- SYSTEM_ENGINEER: システムエンジニア
- PROJECT_MANAGER: プロジェクトマネージャー
- INFRASTRUCTURE_ENGINEER: インフラエンジニア
- DATABASE_ENGINEER: データベースエンジニア
- NETWORK_ENGINEER: ネットワークエンジニア
- SECURITY_ENGINEER: セキュリティエンジニア
- QA_ENGINEER: QAエンジニア
- UI_UX_DESIGNER: UI/UXデザイナー
- DATA_SCIENTIST: データサイエンティスト
- DEVOPS_ENGINEER: DevOpsエンジニア

### 3.9 勤務形態 (WorkStyle)
- ONSITE: オンサイト
- REMOTE: リモート
- HYBRID: ハイブリッド
- FLEXIBLE: 柔軟対応可

### 3.10 請求種別 (BillingType)
- FIXED: 固定
- TIME_AND_MATERIAL: T&M（実績に応じた精算）
- MILESTONE: マイルストーン
- SUBSCRIPTION: サブスクリプション

### 3.11 稼働状態 (AvailabilityType)
- AVAILABLE: 待機中
- ASSIGNED: 稼働中
- PARTIALLY_AVAILABLE: 一部稼働可能
- TRAINING: 研修中
- LEAVE: 休暇中
- PLANNED_ASSIGNMENT: アサイン予定

## 4. ドメインサービス

### 4.1 マッチングエンジンサービス (MatchingEngineService)

マッチングエンジンサービスは、技術者と案件のマッチングを実行するドメインサービスです。

**主要メソッド:**
- findEngineersForProject(Long projectId, MatchingCondition condition)
- findProjectsForEngineer(Long engineerId, MatchingCondition condition)
- calculateMatchingScore(Long engineerId, Long projectId, MatchingCondition condition)
- evaluateMatchingDetails(Long engineerId, Long projectId, MatchingCondition condition)
- recommendMatchings(MatchingRecommendationCriteria criteria)

### 4.2 提案管理サービス (ProposalManagementService)

提案管理サービスは、提案情報を管理するドメインサービスです。

**主要メソッド:**
- createProposal(Proposal proposal, List<Long> matchingIds)
- updateProposalStatus(Long proposalId, Long statusId, String comment)
- approveProposal(Long proposalId, Long approverId, String comment)
- calculateProposalAmount(Long proposalId)
- checkProposalValidity(Long proposalId)
- archiveProposal(Long proposalId)

### 4.3 提案書生成サービス (ProposalDocumentGenerationService)

提案書生成サービスは、提案書を生成するドメインサービスです。

**主要メソッド:**
- generateProposalDocument(Long proposalId, Long templateId)
- updateProposalDocument(Long documentId, String content)
- exportProposalDocument(Long documentId, DocumentFormat format)
- approveProposalDocument(Long documentId, Long approverId, String comment)
- mergeSkillSheets(Long proposalId)
- generateCoverLetter(Long proposalId)

### 4.4 マッチング分析サービス (MatchingAnalysisService)

マッチング分析サービスは、マッチングデータを分析するドメインサービスです。

**主要メソッド:**
- analyzeMatchingTrends(Date startDate, Date endDate)
- calculateSuccessRate(MatchingAnalysisCriteria criteria)
- identifyTopSkillDemands(MatchingAnalysisCriteria criteria)
- generateMatchingReport(MatchingReportCriteria criteria)
- predictMatchingOutcome(Long matchingId)
- recommendOptimalRate(Long matchingId)

## 5. 集約

マッチングモジュールでは、以下の集約を定義します。

### 5.1 マッチング結果集約

マッチング結果を中心とした集約です。

**ルート：** マッチング結果 (MatchingResult)
**含まれるエンティティ：**
- マッチング詳細 (MatchingDetail)

### 5.2 提案集約

提案を中心とした集約です。

**ルート：** 提案 (Proposal)
**含まれるエンティティ：**
- 提案技術者 (ProposalEngineer)
- 提案書 (ProposalDocument)

### 5.3 マッチング検索条件集約

マッチング検索条件を中心とした集約です。

**ルート：** マッチング検索条件 (MatchingSearchCriteria)

## 6. ドメインイベント

### 6.1 マッチング作成イベント (MatchingCreatedEvent)

新しいマッチング結果が作成された際に発行されるイベントです。

**属性:**
- matchingId: 作成されたマッチングID
- projectId: 案件ID
- engineerId: 技術者ID
- matchingScore: マッチング度
- createdBy: 作成者ID
- timestamp: イベント発生時刻

### 6.2 マッチングステータス変更イベント (MatchingStatusChangedEvent)

マッチング結果のステータスが変更された際に発行されるイベントです。

**属性:**
- matchingId: マッチングID
- projectId: 案件ID
- engineerId: 技術者ID
- previousStatusId: 変更前のステータスID
- newStatusId: 変更後のステータスID
- changedBy: 変更者ID
- timestamp: イベント発生時刻

### 6.3 提案作成イベント (ProposalCreatedEvent)

新しい提案が作成された際に発行されるイベントです。

**属性:**
- proposalId: 作成された提案ID
- proposalCode: 提案コード
- projectId: 案件ID
- salesRepId: 営業担当者ID
- engineerIds: 提案技術者IDリスト
- timestamp: イベント発生時刻

### 6.4 提案ステータス変更イベント (ProposalStatusChangedEvent)

提案のステータスが変更された際に発行されるイベントです。

**属性:**
- proposalId: 提案ID
- proposalCode: 提案コード
- previousStatusId: 変更前のステータスID
- newStatusId: 変更後のステータスID
- changedBy: 変更者ID
- timestamp: イベント発生時刻

### 6.5 提案書承認イベント (ProposalDocumentApprovedEvent)

提案書が承認された際に発行されるイベントです。

**属性:**
- documentId: 提案書ID
- proposalId: 提案ID
- approvedBy: 承認者ID
- version: 提案書のバージョン
- timestamp: イベント発生時刻