# マッチング機能モジュール - インターフェース設計

## 1. インターフェース設計概要

マッチング機能モジュールは、Web画面とREST APIの2種類のインターフェースを提供します。ユーザーインターフェースは主に社内ユーザー向けのWeb画面として実装し、システム間連携のためのREST APIを提供します。

### 1.1 インターフェース一覧

| インターフェース | 種類 | 目的 |
|----------------|------|------|
| マッチング検索画面 | Web | 案件または技術者に対するマッチング検索 |
| マッチング結果一覧画面 | Web | マッチング結果の表示と比較 |
| マッチング詳細画面 | Web | 個別マッチングの詳細情報表示 |
| 提案管理画面 | Web | 提案の作成・管理 |
| 提案詳細画面 | Web | 提案詳細情報の表示と状態変更 |
| マッチングAPI | REST | 外部システムからのマッチング操作 |
| 提案API | REST | 外部システムからの提案管理 |

## 2. Web画面インターフェース

### 2.1 マッチング検索画面

マッチング検索のためのユーザーインターフェースを提供します。

#### 機能

- 案件に対する技術者マッチング検索
- 技術者に対する案件マッチング検索
- 検索条件の保存・再利用
- バッチマッチング処理の実行

#### 画面設計

```
+--------------------------------------------------+
|  マッチング検索                                    |
+--------------------------------------------------+
|  検索条件:                                        |
|  [ ] 案件ベース検索  [x] 技術者ベース検索           |
|                                                  |
|  技術者ID: [________] [技術者検索]                |
|                                                  |
|  条件設定:                                        |
|  ┌──────────────────────────────────────────┐   |
|  │ 最低スコア: [70]                          │   |
|  │ 希望勤務地: [東京都] [神奈川県] [在宅] [+] │   |
|  │ 案件種別:   [SI開発] [保守運用] [+]        │   |
|  │ 単価範囲:   [60] 万円 ～ [100] 万円       │   |
|  │                                          │   |
|  │ [詳細条件]                                │   |
|  └──────────────────────────────────────────┘   |
|                                                  |
|  [条件保存] [検索条件読込]                        |
|                                                  |
|  [  検索実行  ]                                   |
+--------------------------------------------------+
```

#### ControllerメソッドAPI

```java
@Controller
@RequestMapping("/matching")
public class MatchingController {

    @GetMapping("/search")
    public String searchForm(Model model) {
        // マッチング検索フォーム表示
        model.addAttribute("searchDTO", new MatchingSearchDTO());
        model.addAttribute("savedQueries", matchingQueryService.getSavedQueries());
        return "matching/search";
    }
    
    @PostMapping("/search")
    public String search(@Valid MatchingSearchDTO searchDTO, BindingResult result, Model model) {
        if (result.hasErrors()) {
            model.addAttribute("savedQueries", matchingQueryService.getSavedQueries());
            return "matching/search";
        }
        
        // 検索条件をセッションに保存
        sessionService.saveSearchCriteria("matchingSearch", searchDTO);
        
        // 検索条件に基づいて転送先を決定
        if (searchDTO.getProjectId() != null) {
            return "redirect:/matching/results?projectId=" + searchDTO.getProjectId();
        } else if (searchDTO.getEngineerId() != null) {
            return "redirect:/matching/results?engineerId=" + searchDTO.getEngineerId();
        } else {
            return "redirect:/matching/results";
        }
    }
    
    @PostMapping("/search/save")
    @ResponseBody
    public ApiResponse saveSearchQuery(@RequestBody MatchingSearchDTO searchDTO,
                                     @RequestParam String queryName) {
        try {
            UUID queryId = matchingQueryService.saveQuery(queryName, searchDTO);
            return new ApiResponse(true, "検索条件を保存しました", queryId);
        } catch (Exception e) {
            return new ApiResponse(false, "保存に失敗しました: " + e.getMessage());
        }
    }
    
    @GetMapping("/search/queries/{id}")
    @ResponseBody
    public MatchingSearchDTO getSearchQuery(@PathVariable UUID id) {
        return matchingQueryService.getQuery(id);
    }
}
```

### 2.2 マッチング結果一覧画面

マッチング検索結果の一覧を表示します。

#### 機能

- マッチング結果の一覧表示
- スコアによるソート
- フィルタリング
- 複数候補の比較
- 一括提案作成

#### 画面設計

```
+--------------------------------------------------+
|  マッチング結果一覧                                |
+--------------------------------------------------+
|  検索条件: 技術者「山田太郎」に対するマッチング      |
|  [条件変更]                                      |
|                                                  |
|  表示順: [スコア(高→低)▼]  絞込み: [すべて▼]       |
|  [ ] 常駐のみ表示  [ ] 稼働可能のみ表示            |
|                                                  |
|  ┌─────┬────────────┬──────┬────────┬────────┐   |
|  │ 選択 │ 案件名     │ スコア│  単価  │ 勤務地 │   |
|  ├─────┼────────────┼──────┼────────┼────────┤   |
|  │ [x] │ A社システム │ 95% │ 80万円 │ 東京都 │   |
|  │ [ ] │ B社保守運用 │ 82% │ 65万円 │ 在宅   │   |
|  │ [x] │ C社開発案件 │ 78% │ 85万円 │ 横浜市 │   |
|  │ [ ] │ D社改修案件 │ 65% │ 75万円 │ 千葉県 │   |
|  └─────┴────────────┴──────┴────────┴────────┘   |
|                                                  |
|  [選択項目を比較] [提案作成] [お気に入り登録]       |
|                                                  |
|  1-10件表示（全24件） [<] [1] [2] [3] [>]         |
+--------------------------------------------------+
```

#### ControllerメソッドAPI

```java
@Controller
@RequestMapping("/matching")
public class MatchingController {

    @GetMapping("/results")
    public String results(Model model,
                         @RequestParam(required = false) UUID projectId,
                         @RequestParam(required = false) UUID engineerId,
                         @RequestParam(defaultValue = "0") int page,
                         @RequestParam(defaultValue = "10") int size,
                         @RequestParam(defaultValue = "score,desc") String sort) {
        
        // セッションから検索条件を取得
        MatchingSearchDTO searchDTO = sessionService.getSearchCriteria("matchingSearch");
        if (searchDTO == null) {
            searchDTO = new MatchingSearchDTO();
        }
        
        // パラメータでセッション情報を上書き
        if (projectId != null) {
            searchDTO.setProjectId(projectId);
        }
        if (engineerId != null) {
            searchDTO.setEngineerId(engineerId);
        }
        
        // ソート条件の解析
        String[] sortParams = sort.split(",");
        String sortField = sortParams[0];
        String direction = sortParams.length > 1 ? sortParams[1] : "asc";
        
        // ページング情報の作成
        Pageable pageable = PageRequest.of(
            page, size, 
            Sort.by(direction.equals("asc") ? Sort.Direction.ASC : Sort.Direction.DESC, sortField)
        );
        
        // 検索の実行
        Page<MatchingResultDTO> results = matchingService.searchMatching(searchDTO, pageable);
        
        // 関連情報の取得
        if (projectId != null) {
            model.addAttribute("project", projectService.getProjectById(projectId));
        }
        if (engineerId != null) {
            model.addAttribute("engineer", engineerService.getEngineerById(engineerId));
        }
        
        model.addAttribute("results", results);
        model.addAttribute("searchDTO", searchDTO);
        model.addAttribute("sortField", sortField);
        model.addAttribute("sortDirection", direction);
        
        return "matching/results";
    }
    
    @PostMapping("/results/compare")
    public String compareResults(@RequestParam List<UUID> resultIds, Model model) {
        List<MatchingResultDTO> selectedResults = matchingService.getMatchingResultsByIds(resultIds);
        model.addAttribute("results", selectedResults);
        return "matching/compare";
    }
    
    @PostMapping("/results/favorite")
    @ResponseBody
    public ApiResponse toggleFavorite(@RequestParam UUID resultId) {
        try {
            matchingService.toggleFavorite(resultId);
            return new ApiResponse(true, "お気に入り状態を変更しました");
        } catch (Exception e) {
            return new ApiResponse(false, "処理に失敗しました: " + e.getMessage());
        }
    }
}
```

### 2.3 マッチング詳細画面

マッチングの詳細情報を表示します。

#### 機能

- マッチングスコアの詳細表示
- カテゴリ別スコアのグラフ表示
- メモ機能
- 提案作成

#### 画面設計

```
+--------------------------------------------------+
|  マッチング詳細                                   |
+--------------------------------------------------+
|  技術者: 山田太郎                                 |
|  案件: A社システム開発                            |
|                                                  |
|  総合マッチングスコア                             |
|  [███████████████████████_____] 85%               |
|                                                  |
|  カテゴリ別スコア:                                |
|  スキル適合度:    [████████████████________] 75%   |
|  経験年数:       [████████████████████████] 100%  |
|  稼働状況:       [███████████████___________] 70%  |
|  勤務地:         [████████████████████______] 90%  |
|                                                  |
|  詳細評価:                                        |
|  ┌──────────────────────────────────────────┐   |
|  │ 【スキルマッチング】                       │   |
|  │ ・Java(レベル4): 一致                     │   |
|  │ ・Spring Boot(レベル3): 一致              │   |
|  │ ・AWS(レベル2): 一致                      │   |
|  │ ・PostgreSQL(レベル3): 一致               │   |
|  │ ・React: 要件あり、スキルなし             │   |
|  └──────────────────────────────────────────┘   |
|                                                  |
|  メモ:                                           |
|  [                                          ]   |
|  [  保存  ]                                      |
|                                                  |
|  [お気に入り登録] [提案作成] [戻る]                |
+--------------------------------------------------+
```

#### ControllerメソッドAPI

```java
@Controller
@RequestMapping("/matching")
public class MatchingController {

    @GetMapping("/result/{id}")
    public String resultDetail(@PathVariable UUID id, Model model) {
        // マッチング結果の取得
        MatchingResultDTO result = matchingService.getMatchingResultById(id);
        
        // 関連データの取得
        ProjectDTO project = projectService.getProjectById(result.getProjectId());
        EngineerDTO engineer = engineerService.getEngineerById(result.getEngineerId());
        
        // スキル詳細評価の取得
        SkillMatchingDetailDTO skillMatching = 
            matchingService.getSkillMatchingDetail(result.getProjectId(), result.getEngineerId());
        
        model.addAttribute("result", result);
        model.addAttribute("project", project);
        model.addAttribute("engineer", engineer);
        model.addAttribute("skillMatching", skillMatching);
        
        return "matching/detail";
    }
    
    @PostMapping("/result/{id}/memo")
    @ResponseBody
    public ApiResponse saveMemo(@PathVariable UUID id, @RequestParam String memo) {
        try {
            matchingService.updateMatchingResultMemo(id, memo);
            return new ApiResponse(true, "メモを保存しました");
        } catch (Exception e) {
            return new ApiResponse(false, "保存に失敗しました: " + e.getMessage());
        }
    }
    
    @PostMapping("/result/{id}/recalculate")
    public String recalculateMatching(@PathVariable UUID id, RedirectAttributes redirectAttributes) {
        try {
            MatchingResultDTO result = matchingService.recalculateMatching(id);
            redirectAttributes.addFlashAttribute("message", "マッチングスコアを再計算しました");
            return "redirect:/matching/result/" + id;
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "再計算に失敗しました: " + e.getMessage());
            return "redirect:/matching/result/" + id;
        }
    }
}
```

### 2.4 提案管理画面

提案の一覧表示と管理機能を提供します。

#### 機能

- 提案一覧表示
- 提案状態フィルタリング
- 提案状態変更
- 提案書ダウンロード

#### 画面設計

```
+--------------------------------------------------+
|  提案管理                                         |
+--------------------------------------------------+
|  状態: [すべて▼]  検索: [________________]        |
|                                                  |
|  ┌──────┬────────────┬──────────┬──────┬────────┐|
|  │提案番号│案件名     │技術者名  │状態  │提案日  ||
|  ├──────┼────────────┼──────────┼──────┼────────┤|
|  │PRO-.. │A社システム│山田太郎  │検討中│05/01  ||
|  │PRO-.. │B社運用   │鈴木次郎  │承認 │04/28  ||
|  │PRO-.. │C社開発   │佐藤三郎  │提出済│04/25  ||
|  │PRO-.. │D社改修   │田中四郎  │却下 │04/20  ||
|  └──────┴────────────┴──────────┴──────┴────────┘|
|                                                  |
|  1-10件表示（全24件） [<] [1] [2] [3] [>]         |
|                                                  |
|  [新規提案作成]                                   |
+--------------------------------------------------+
```

#### ControllerメソッドAPI

```java
@Controller
@RequestMapping("/proposals")
public class ProposalController {

    @GetMapping
    public String list(Model model,
                      @RequestParam(required = false) ProposalStatus status,
                      @RequestParam(required = false) String keyword,
                      @RequestParam(defaultValue = "0") int page,
                      @RequestParam(defaultValue = "10") int size) {
        
        // ページング情報
        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "proposalDate"));
        
        // 提案の検索
        Page<ProposalDTO> proposals = proposalService.findProposals(status, keyword, pageable);
        
        model.addAttribute("proposals", proposals);
        model.addAttribute("status", status);
        model.addAttribute("keyword", keyword);
        model.addAttribute("statusList", ProposalStatus.values());
        
        return "proposals/list";
    }
    
    @GetMapping("/new")
    public String createForm(Model model, @RequestParam(required = false) UUID matchingResultId) {
        ProposalDTO proposalDTO = new ProposalDTO();
        
        // マッチング結果からの提案作成の場合
        if (matchingResultId != null) {
            MatchingResultDTO result = matchingService.getMatchingResultById(matchingResultId);
            if (result != null) {
                proposalDTO.setProjectId(result.getProjectId());
                proposalDTO.setEngineerId(result.getEngineerId());
                proposalDTO.setMatchingScore(result.getMatchingScore());
                
                // 関連情報の取得
                ProjectDTO project = projectService.getProjectById(result.getProjectId());
                EngineerDTO engineer = engineerService.getEngineerById(result.getEngineerId());
                
                model.addAttribute("project", project);
                model.addAttribute("engineer", engineer);
            }
        }
        
        model.addAttribute("proposalDTO", proposalDTO);
        model.addAttribute("matchingResultId", matchingResultId);
        
        return "proposals/create";
    }
    
    @PostMapping
    public String create(@Valid ProposalDTO proposalDTO, BindingResult result, Model model) {
        if (result.hasErrors()) {
            if (proposalDTO.getProjectId() != null) {
                model.addAttribute("project", projectService.getProjectById(proposalDTO.getProjectId()));
            }
            if (proposalDTO.getEngineerId() != null) {
                model.addAttribute("engineer", engineerService.getEngineerById(proposalDTO.getEngineerId()));
            }
            return "proposals/create";
        }
        
        // 提案の作成
        ProposalDTO createdProposal = proposalService.createProposal(proposalDTO);
        
        return "redirect:/proposals/" + createdProposal.getId();
    }
}
```

### 2.5 提案詳細画面

提案の詳細情報と状態管理機能を提供します。

#### 機能

- 提案詳細情報表示
- 提案状態変更
- 提案書ダウンロード/プレビュー
- フィードバック管理

#### 画面設計

```
+--------------------------------------------------+
|  提案詳細                                         |
+--------------------------------------------------+
|  提案番号: PRO-202304-0025                        |
|  状態: 検討中                                     |
|                                                  |
|  ┌───────────────────┐ ┌───────────────────────┐ |
|  │ 案件情報          │ │ 技術者情報            │ |
|  │ 案件名: A社システム │ │ 氏名: 山田太郎        │ |
|  │ 単価: 80万円/月   │ │ スキル: Java, Spring  │ |
|  │ 期間: 6ヶ月       │ │ 経験: 5年             │ |
|  │ 勤務地: 東京都     │ │ 稼働可能日: 即日       │ |
|  └───────────────────┘ └───────────────────────┘ |
|                                                  |
|  マッチングスコア: 85%                            |
|                                                  |
|  提案書: [表示] [ダウンロード]                     |
|                                                  |
|  フィードバック:                                  |
|  [顧客より単価の再交渉希望あり。80→75万で検討中]    |
|  [   追加   ]                                     |
|                                                  |
|  回答期限: 2023-05-15                             |
|                                                  |
|  ┌──────────────────────────────────────────┐    |
|  │ [承認] [却下] [取消]                      │    |
|  └──────────────────────────────────────────┘    |
+--------------------------------------------------+
```

#### ControllerメソッドAPI

```java
@Controller
@RequestMapping("/proposals")
public class ProposalController {

    @GetMapping("/{id}")
    public String detail(@PathVariable UUID id, Model model) {
        // 提案の取得
        ProposalDTO proposal = proposalService.getProposalById(id);
        
        // 関連データの取得
        ProjectDTO project = projectService.getProjectById(proposal.getProjectId());
        EngineerDTO engineer = engineerService.getEngineerById(proposal.getEngineerId());
        List<ProposalFeedbackDTO> feedbacks = proposalService.getFeedbacksForProposal(id);
        
        model.addAttribute("proposal", proposal);
        model.addAttribute("project", project);
        model.addAttribute("engineer", engineer);
        model.addAttribute("feedbacks", feedbacks);
        
        // 状態変更の権限チェック
        model.addAttribute("canApprove", proposalAuthService.canApproveProposal(id));
        model.addAttribute("canReject", proposalAuthService.canRejectProposal(id));
        model.addAttribute("canCancel", proposalAuthService.canCancelProposal(id));
        
        return "proposals/detail";
    }
    
    @GetMapping("/{id}/document")
    public ResponseEntity<Resource> downloadDocument(@PathVariable UUID id) {
        // 提案書のダウンロード
        ProposalDTO proposal = proposalService.getProposalById(id);
        
        if (proposal.getProposalDocumentId() == null) {
            return ResponseEntity.notFound().build();
        }
        
        Resource resource = documentService.getDocumentResource(proposal.getProposalDocumentId());
        return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"proposal-" + proposal.getProposalNumber() + ".pdf\"")
            .body(resource);
    }
    
    @PostMapping("/{id}/feedback")
    public String addFeedback(@PathVariable UUID id, 
                             @Valid ProposalFeedbackDTO feedbackDTO,
                             RedirectAttributes redirectAttributes) {
        try {
            proposalService.addFeedback(id, feedbackDTO);
            redirectAttributes.addFlashAttribute("message", "フィードバックを追加しました");
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "フィードバック追加に失敗しました: " + e.getMessage());
        }
        
        return "redirect:/proposals/" + id;
    }
    
    @PostMapping("/{id}/status/approve")
    public String approve(@PathVariable UUID id, 
                         @Valid ProposalApprovalDTO approvalDTO,
                         RedirectAttributes redirectAttributes) {
        try {
            proposalService.approveProposal(id, approvalDTO);
            redirectAttributes.addFlashAttribute("message", "提案を承認しました");
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "承認に失敗しました: " + e.getMessage());
        }
        
        return "redirect:/proposals/" + id;
    }
    
    @PostMapping("/{id}/status/reject")
    public String reject(@PathVariable UUID id, 
                        @Valid ProposalRejectionDTO rejectionDTO,
                        RedirectAttributes redirectAttributes) {
        try {
            proposalService.rejectProposal(id, rejectionDTO);
            redirectAttributes.addFlashAttribute("message", "提案を却下しました");
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "却下に失敗しました: " + e.getMessage());
        }
        
        return "redirect:/proposals/" + id;
    }
    
    @PostMapping("/{id}/status/cancel")
    public String cancel(@PathVariable UUID id, 
                        @RequestParam String reason,
                        RedirectAttributes redirectAttributes) {
        try {
            proposalService.cancelProposal(id, reason);
            redirectAttributes.addFlashAttribute("message", "提案を取り消しました");
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "取消に失敗しました: " + e.getMessage());
        }
        
        return "redirect:/proposals/" + id;
    }
}
```

## 3. REST APIインターフェース

### 3.1 マッチング検索API

マッチング検索のためのREST APIを提供します。

#### エンドポイント

```
POST /api/matching/search
```

#### リクエスト

```json
{
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "minimumScore": 70.0,
  "skillIds": [
    "550e8400-e29b-41d4-a716-446655440001",
    "550e8400-e29b-41d4-a716-446655440002"
  ],
  "experienceYears": 3,
  "favoriteOnly": false
}
```

#### レスポンス

```json
{
  "content": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440003",
      "projectId": "550e8400-e29b-41d4-a716-446655440000",
      "projectName": "A社システム開発",
      "engineerId": "550e8400-e29b-41d4-a716-446655440004",
      "engineerName": "山田太郎",
      "matchingScore": 85.5,
      "scoreDetails": {
        "skills": 80.0,
        "experience": 95.0,
        "availability": 70.0,
        "location": 90.0
      },
      "calculatedAt": "2023-05-08T10:30:00Z",
      "favorite": false
    },
    // ... more results
  ],
  "pageable": {
    "sort": {
      "sorted": true,
      "unsorted": false
    },
    "pageNumber": 0,
    "pageSize": 10,
    "offset": 0,
    "paged": true,
    "unpaged": false
  },
  "totalPages": 3,
  "totalElements": 24,
  "last": false,
  "first": true,
  "sort": {
    "sorted": true,
    "unsorted": false
  },
  "number": 0,
  "numberOfElements": 10,
  "size": 10,
  "empty": false
}
```

#### 実装

```java
@RestController
@RequestMapping("/api/matching")
public class MatchingRestController {

    private final MatchingService matchingService;
    
    @Autowired
    public MatchingRestController(MatchingService matchingService) {
        this.matchingService = matchingService;
    }

    @PostMapping("/search")
    public ResponseEntity<Page<MatchingResultDTO>> search(
            @RequestBody MatchingSearchDTO searchDTO, 
            Pageable pageable) {
        Page<MatchingResultDTO> results = matchingService.searchMatching(searchDTO, pageable);
        return ResponseEntity.ok(results);
    }
}
```

### 3.2 案件別マッチング結果API

特定の案件に対するマッチング結果を取得するAPIです。

#### エンドポイント

```
GET /api/matching/projects/{projectId}/results
```

#### レスポンス

```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440003",
    "projectId": "550e8400-e29b-41d4-a716-446655440000",
    "projectName": "A社システム開発",
    "engineerId": "550e8400-e29b-41d4-a716-446655440004",
    "engineerName": "山田太郎",
    "matchingScore": 85.5,
    "scoreDetails": {
      "skills": 80.0,
      "experience": 95.0,
      "availability": 70.0,
      "location": 90.0
    },
    "calculatedAt": "2023-05-08T10:30:00Z",
    "favorite": false
  },
  // ... more results
]
```

#### 実装

```java
@RestController
@RequestMapping("/api/matching")
public class MatchingRestController {

    @GetMapping("/projects/{projectId}/results")
    public ResponseEntity<List<MatchingResultDTO>> getResultsByProject(
            @PathVariable UUID projectId) {
        List<MatchingResultDTO> results = matchingService.findMatchingResultsByProject(projectId);
        return ResponseEntity.ok(results);
    }
}
```

### 3.3 技術者別マッチング結果API

特定の技術者に対するマッチング結果を取得するAPIです。

#### エンドポイント

```
GET /api/matching/engineers/{engineerId}/results
```

#### レスポンス

```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440003",
    "projectId": "550e8400-e29b-41d4-a716-446655440000",
    "projectName": "A社システム開発",
    "engineerId": "550e8400-e29b-41d4-a716-446655440004",
    "engineerName": "山田太郎",
    "matchingScore": 85.5,
    "scoreDetails": {
      "skills": 80.0,
      "experience": 95.0,
      "availability": 70.0,
      "location": 90.0
    },
    "calculatedAt": "2023-05-08T10:30:00Z",
    "favorite": false
  },
  // ... more results
]
```

#### 実装

```java
@RestController
@RequestMapping("/api/matching")
public class MatchingRestController {

    @GetMapping("/engineers/{engineerId}/results")
    public ResponseEntity<List<MatchingResultDTO>> getResultsByEngineer(
            @PathVariable UUID engineerId) {
        List<MatchingResultDTO> results = matchingService.findMatchingResultsByEngineer(engineerId);
        return ResponseEntity.ok(results);
    }
}
```

### 3.4 マッチング結果詳細API

マッチング結果の詳細情報を取得するAPIです。

#### エンドポイント

```
GET /api/matching/results/{id}
```

#### レスポンス

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440003",
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "projectName": "A社システム開発",
  "engineerId": "550e8400-e29b-41d4-a716-446655440004",
  "engineerName": "山田太郎",
  "matchingScore": 85.5,
  "scoreDetails": {
    "skills": 80.0,
    "experience": 95.0,
    "availability": 70.0,
    "location": 90.0
  },
  "calculatedAt": "2023-05-08T10:30:00Z",
  "favorite": false,
  "memo": "候補者として検討中",
  "skillMatchingDetails": [
    {
      "skillId": "550e8400-e29b-41d4-a716-446655440001",
      "skillName": "Java",
      "required": true,
      "engineerLevel": 4,
      "matched": true
    },
    // ... more skill details
  ]
}
```

#### 実装

```java
@RestController
@RequestMapping("/api/matching")
public class MatchingRestController {

    @GetMapping("/results/{id}")
    public ResponseEntity<MatchingResultDetailDTO> getResultById(@PathVariable UUID id) {
        MatchingResultDTO result = matchingService.getMatchingResultById(id);
        
        if (result == null) {
            return ResponseEntity.notFound().build();
        }
        
        // 詳細情報の付加
        MatchingResultDetailDTO detailDTO = new MatchingResultDetailDTO(result);
        detailDTO.setSkillMatchingDetails(
            matchingService.getSkillMatchingDetail(result.getProjectId(), result.getEngineerId())
        );
        
        return ResponseEntity.ok(detailDTO);
    }
}
```

### 3.5 お気に入り登録API

マッチング結果をお気に入り登録/解除するAPIです。

#### エンドポイント

```
POST /api/matching/results/{id}/favorite
```

#### レスポンス

```
204 No Content
```

#### 実装

```java
@RestController
@RequestMapping("/api/matching")
public class MatchingRestController {

    @PostMapping("/results/{id}/favorite")
    public ResponseEntity<Void> toggleFavorite(@PathVariable UUID id) {
        matchingService.toggleFavorite(id);
        return ResponseEntity.noContent().build();
    }
}
```

### 3.6 提案作成API

提案を作成するAPIです。

#### エンドポイント

```
POST /api/proposals
```

#### リクエスト

```json
{
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "engineerId": "550e8400-e29b-41d4-a716-446655440004",
  "proposalDate": "2023-05-08",
  "responseDeadline": "2023-05-15",
  "salesPersonId": "550e8400-e29b-41d4-a716-446655440005",
  "generateDocument": true
}
```

#### レスポンス

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440006",
  "proposalNumber": "PRO-202305-0001",
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "projectName": "A社システム開発",
  "engineerId": "550e8400-e29b-41d4-a716-446655440004",
  "engineerName": "山田太郎",
  "status": "DRAFT",
  "statusDisplayName": "下書き",
  "proposalDate": "2023-05-08",
  "proposalDocumentId": "550e8400-e29b-41d4-a716-446655440007",
  "salesPersonId": "550e8400-e29b-41d4-a716-446655440005",
  "salesPersonName": "営業 一郎",
  "responseDeadline": "2023-05-15",
  "expired": false
}
```

#### 実装

```java
@RestController
@RequestMapping("/api/proposals")
public class ProposalRestController {

    private final ProposalService proposalService;
    
    @Autowired
    public ProposalRestController(ProposalService proposalService) {
        this.proposalService = proposalService;
    }

    @PostMapping
    public ResponseEntity<ProposalDTO> createProposal(
            @RequestBody @Valid ProposalCreateDTO proposalDTO) {
        ProposalDTO createdProposal = proposalService.createProposal(proposalDTO);
        return ResponseEntity.status(HttpStatus.CREATED).body(createdProposal);
    }
}
```

### 3.7 提案一覧取得API

提案の一覧を取得するAPIです。

#### エンドポイント

```
GET /api/proposals
```

#### パラメータ

- `status` - 提案状態によるフィルタリング（オプション）
- `page` - ページ番号（デフォルト: 0）
- `size` - ページサイズ（デフォルト: 10）
- `sort` - ソート順（例: `proposalDate,desc`）

#### レスポンス

```json
{
  "content": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440006",
      "proposalNumber": "PRO-202305-0001",
      "projectId": "550e8400-e29b-41d4-a716-446655440000",
      "projectName": "A社システム開発",
      "engineerId": "550e8400-e29b-41d4-a716-446655440004",
      "engineerName": "山田太郎",
      "status": "IN_REVIEW",
      "statusDisplayName": "検討中",
      "proposalDate": "2023-05-08",
      "proposalDocumentId": "550e8400-e29b-41d4-a716-446655440007",
      "salesPersonId": "550e8400-e29b-41d4-a716-446655440005",
      "salesPersonName": "営業 一郎",
      "responseDeadline": "2023-05-15",
      "expired": false
    },
    // ... more proposals
  ],
  "pageable": {
    // ... pagination info
  },
  "totalPages": 3,
  "totalElements": 24,
  // ... more page info
}
```

#### 実装

```java
@RestController
@RequestMapping("/api/proposals")
public class ProposalRestController {

    @GetMapping
    public ResponseEntity<Page<ProposalDTO>> getProposals(
            @RequestParam(required = false) ProposalStatus status,
            Pageable pageable) {
        Page<ProposalDTO> proposals = proposalService.findProposals(status, pageable);
        return ResponseEntity.ok(proposals);
    }
}
```

### 3.8 提案状態更新API

提案の状態を更新するAPIです。

#### エンドポイント

```
PATCH /api/proposals/{id}/status
```

#### リクエスト

```json
{
  "status": "ACCEPTED",
  "comment": "顧客との最終調整が完了しました",
  "createContract": true
}
```

#### レスポンス

```
204 No Content
```

#### 実装

```java
@RestController
@RequestMapping("/api/proposals")
public class ProposalRestController {

    @PatchMapping("/{id}/status")
    public ResponseEntity<Void> updateProposalStatus(
            @PathVariable UUID id, 
            @RequestBody ProposalStatusUpdateDTO statusUpdate) {
        
        ProposalStatus newStatus = ProposalStatus.valueOf(statusUpdate.getStatus());
        
        switch (newStatus) {
            case ACCEPTED:
                ProposalApprovalDTO approvalDTO = new ProposalApprovalDTO();
                approvalDTO.setComments(statusUpdate.getComment());
                approvalDTO.setCreateContract(statusUpdate.isCreateContract());
                proposalService.approveProposal(id, approvalDTO);
                break;
                
            case REJECTED:
                ProposalRejectionDTO rejectionDTO = new ProposalRejectionDTO();
                rejectionDTO.setReason(statusUpdate.getComment());
                proposalService.rejectProposal(id, rejectionDTO);
                break;
                
            case CANCELED:
                proposalService.cancelProposal(id, statusUpdate.getComment());
                break;
                
            default:
                // 他の状態更新
                proposalService.updateProposalStatus(id, newStatus, statusUpdate.getComment());
        }
        
        return ResponseEntity.noContent().build();
    }
}
```

## 4. エラーハンドリング

### 4.1 REST APIエラー応答

REST APIでのエラーハンドリングを統一的に行います。

```java
@RestControllerAdvice
public class ApiExceptionHandler {

    @ExceptionHandler(EntityNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleEntityNotFound(EntityNotFoundException ex) {
        ErrorResponse error = new ErrorResponse(
            HttpStatus.NOT_FOUND.value(),
            "Resource not found",
            ex.getMessage()
        );
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
    }
    
    @ExceptionHandler(IllegalStateException.class)
    public ResponseEntity<ErrorResponse> handleIllegalState(IllegalStateException ex) {
        ErrorResponse error = new ErrorResponse(
            HttpStatus.BAD_REQUEST.value(),
            "Invalid operation",
            ex.getMessage()
        );
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationErrors(MethodArgumentNotValidException ex) {
        Map<String, String> fieldErrors = ex.getBindingResult().getFieldErrors().stream()
            .collect(Collectors.toMap(
                FieldError::getField,
                FieldError::getDefaultMessage,
                (existing, replacement) -> existing + ", " + replacement
            ));
        
        ErrorResponse error = new ErrorResponse(
            HttpStatus.BAD_REQUEST.value(),
            "Validation failed",
            "There were validation errors in your request",
            fieldErrors
        );
        
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGeneralException(Exception ex) {
        ErrorResponse error = new ErrorResponse(
            HttpStatus.INTERNAL_SERVER_ERROR.value(),
            "Internal server error",
            "An unexpected error occurred"
        );
        // エラーのログ記録
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }
}
```

### 4.2 Web画面エラーハンドリング

Web画面でのエラーハンドリングを行います。

```java
@ControllerAdvice
public class WebErrorHandler {

    @ExceptionHandler(EntityNotFoundException.class)
    public String handleEntityNotFound(EntityNotFoundException ex, Model model) {
        model.addAttribute("errorCode", 404);
        model.addAttribute("errorMessage", ex.getMessage());
        return "error/not-found";
    }
    
    @ExceptionHandler(AccessDeniedException.class)
    public String handleAccessDenied(AccessDeniedException ex, Model model) {
        model.addAttribute("errorCode", 403);
        model.addAttribute("errorMessage", "この操作を行う権限がありません");
        return "error/access-denied";
    }
    
    @ExceptionHandler(Exception.class)
    public String handleGeneralException(Exception ex, Model model) {
        model.addAttribute("errorCode", 500);
        model.addAttribute("errorMessage", "予期せぬエラーが発生しました");
        model.addAttribute("errorDetail", ex.getMessage());
        // エラーのログ記録
        return "error/general";
    }
}
```

## 5. セキュリティ設計

### 5.1 アクセス制御設定

マッチング機能モジュールのアクセス制御設定です。

```java
@Configuration
@EnableWebSecurity
public class MatchingSecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                // Web画面のアクセス制御
                .requestMatchers("/matching/**").hasAnyRole("ADMIN", "MATCHING", "SALES")
                .requestMatchers("/proposals").hasAnyRole("ADMIN", "MATCHING", "SALES")
                .requestMatchers("/proposals/*/status/approve").hasAnyRole("ADMIN", "SALES_MANAGER")
                .requestMatchers("/proposals/*/status/reject").hasAnyRole("ADMIN", "SALES_MANAGER", "SALES")
                
                // REST APIのアクセス制御
                .requestMatchers("/api/matching/**").hasAnyRole("ADMIN", "MATCHING", "SALES", "API_USER")
                .requestMatchers("/api/proposals").hasAnyRole("ADMIN", "MATCHING", "SALES", "API_USER")
                .requestMatchers("/api/proposals/*/status").hasAnyRole("ADMIN", "SALES_MANAGER", "API_ADMIN")
                
                .anyRequest().authenticated()
            )
            .csrf(csrf -> csrf
                .ignoringRequestMatchers("/api/**") // API呼び出しではCSRF保護を無効化
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            // その他のセキュリティ設定
            // ...
            ;
        
        return http.build();
    }
}
```

### 5.2 メソッドレベルのセキュリティ

サービスメソッドレベルでのアクセス制御です。

```java
@Service
public class MatchingServiceImpl implements MatchingService {

    @PreAuthorize("hasAnyRole('ADMIN', 'MATCHING', 'SALES')")
    @Override
    public Page<MatchingResultDTO> searchMatching(MatchingSearchDTO searchDTO, Pageable pageable) {
        // 実装
    }
    
    @PreAuthorize("hasAnyRole('ADMIN', 'MATCHING')")
    @Override
    public MatchingResultDTO calculateSingleMatching(UUID projectId, UUID engineerId) {
        // 実装
    }
}

@Service
public class ProposalServiceImpl implements ProposalService {

    @PreAuthorize("hasAnyRole('ADMIN', 'MATCHING', 'SALES')")
    @Override
    public ProposalDTO createProposal(ProposalDTO proposalDTO) {
        // 実装
    }
    
    @PreAuthorize("hasAnyRole('ADMIN', 'SALES_MANAGER') or " +
                 "(hasRole('SALES') and @proposalSecurityService.isProposalCreator(#proposalId))")
    @Override
    public void cancelProposal(UUID proposalId, String reason) {
        // 実装
    }
    
    @PreAuthorize("hasAnyRole('ADMIN', 'SALES_MANAGER')")
    @Override
    public ProposalDTO approveProposal(UUID proposalId, ProposalApprovalDTO approvalDTO) {
        // 実装
    }
}
```

## 6. 画面遷移設計

### 6.1 マッチング機能の画面遷移図

```
+-------------------+     +----------------------+
| マッチング検索画面 |---->| マッチング結果一覧画面 |
|                   |     |                      |
+-------------------+     +----------------------+
                                   |
                                   +----------------+
                                   |                |
                                   v                v
                          +----------------------+  +-------------------+
                          | マッチング結果詳細画面 |  | マッチング比較画面 |
                          |                      |  |                   |
                          +----------------------+  +-------------------+
                                   |
                                   v
                          +-------------------+
                          | 提案作成画面      |
                          |                   |
                          +-------------------+
                                   |
                                   v
                          +-------------------+
                          | 提案一覧画面      |
                          |                   |
                          +-------------------+
                                   |
                                   v
                          +-------------------+
                          | 提案詳細画面      |
                          |                   |
                          +-------------------+
                                   |
                                   v
                          +-------------------+
                          | 提案状態変更画面  |
                          |                   |
                          +-------------------+
```

### 6.2 マッチング検索からの提案作成フロー

1. マッチング検索画面で検索条件を入力
2. マッチング結果一覧画面で候補者を確認
3. マッチング結果詳細画面でスコア詳細を確認
4. 提案作成画面で提案情報を入力
5. 提案詳細画面で提案状態を確認
6. 提案状態変更（承認/却下/取消）

## 7. エラー処理フロー

### 7.1 入力検証エラー

```
+-------------------+     +----------------------+
| フォーム入力      |---->| 入力検証            |
|                   |     |                      |
+-------------------+     +----------------------+
                                   |
                                   | [エラーあり]
                                   v
                          +----------------------+
                          | エラーメッセージ表示 |
                          | 同一画面でフォーム再表示|
                          +----------------------+
```

### 7.2 処理エラー

```
+-------------------+     +----------------------+
| アクション実行    |---->| 処理実行            |
|                   |     |                      |
+-------------------+     +----------------------+
                                   |
                                   | [エラー発生]
                                   v
                          +----------------------+
                          | エラーページ表示    |
                          | またはエラーメッセージ|
                          +----------------------+
```

## 8. 国際化対応

### 8.1 メッセージリソース設計

```properties
# messages_ja.properties
matching.search.title=マッチング検索
matching.search.button=検索する
matching.results.title=マッチング結果
matching.result.score=マッチングスコア
proposal.status.draft=下書き
proposal.status.submitted=提出済
proposal.status.in_review=検討中
proposal.status.accepted=承認
proposal.status.rejected=却下
proposal.status.canceled=取消

# messages_en.properties
matching.search.title=Matching Search
matching.search.button=Search
matching.results.title=Matching Results
matching.result.score=Matching Score
proposal.status.draft=Draft
proposal.status.submitted=Submitted
proposal.status.in_review=In Review
proposal.status.accepted=Accepted
proposal.status.rejected=Rejected
proposal.status.canceled=Canceled
```

### 8.2 ロケール検出と切り替え

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Bean
    public LocaleResolver localeResolver() {
        SessionLocaleResolver resolver = new SessionLocaleResolver();
        resolver.setDefaultLocale(Locale.JAPANESE);
        return resolver;
    }
    
    @Bean
    public LocaleChangeInterceptor localeChangeInterceptor() {
        LocaleChangeInterceptor interceptor = new LocaleChangeInterceptor();
        interceptor.setParamName("lang");
        return interceptor;
    }
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(localeChangeInterceptor());
    }
}
```

## 9. レスポンシブデザイン対応

### 9.1 モバイル対応設計

Web画面はレスポンシブデザインで実装し、様々なデバイスからのアクセスに対応します。

```html
<!-- Thymeleafテンプレート例 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{matching.search.title}">マッチング検索</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/matching.css">
</head>
<body>
    <div class="container">
        <h1 th:text="#{matching.search.title}">マッチング検索</h1>
        
        <div class="row">
            <div class="col-md-12">
                <form th:action="@{/matching/search}" method="post" th:object="${searchDTO}">
                    <!-- 検索フォーム -->
                    <div class="mb-3">
                        <label for="searchType" class="form-label">検索タイプ</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" th:field="*{searchType}" id="projectBased" value="PROJECT">
                            <label class="form-check-label" for="projectBased">案件ベース検索</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" th:field="*{searchType}" id="engineerBased" value="ENGINEER">
                            <label class="form-check-label" for="engineerBased">技術者ベース検索</label>
                        </div>
                    </div>
                    
                    <!-- その他のフォーム要素 -->
                    
                    <button type="submit" class="btn btn-primary" th:text="#{matching.search.button}">検索</button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/matching.js"></script>
</body>
</html>
```

### 9.2 CSS設計方針

```css
/* matching.css */

/* レスポンシブブレークポイント */
/* SM: 576px以上 */
/* MD: 768px以上 */
/* LG: 992px以上 */
/* XL: 1200px以上 */

/* ベーススタイル（モバイルファースト） */
.matching-score {
    font-size: 1.2rem;
    font-weight: bold;
}

.matching-card {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.score-bar {
    height: 20px;
    background-color: #e9ecef;
    border-radius: 0.25rem;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.score-fill {
    height: 100%;
    background-color: #28a745;
}

/* タブレット以上 */
@media (min-width: 768px) {
    .matching-comparison {
        display: flex;
        flex-wrap: wrap;
    }
    
    .comparison-item {
        flex: 1 0 45%;
        margin: 0.5rem;
    }
}

/* デスクトップ以上 */
@media (min-width: 992px) {
    .matching-filters {
        display: flex;
        justify-content: space-between;
    }
    
    .filter-section {
        flex: 1 0 auto;
        margin-right: 1rem;
    }
    
    .comparison-item {
        flex: 1 0 30%;
    }
}
```

## 10. パフォーマンス最適化

### 10.1 データ取得の最適化

```java
@Service
public class MatchingServiceImpl implements MatchingService {

    // N+1問題を回避するために最適化したクエリ
    @Override
    public Page<MatchingResultDTO> searchMatching(MatchingSearchDTO searchDTO, Pageable pageable) {
        // 検索結果の取得
        Page<MatchingResult> results = matchingResultRepository.findBySearchCriteria(
            searchDTO.getProjectId(),
            searchDTO.getEngineerId(),
            searchDTO.getMinimumScore(),
            searchDTO.getSkillIds(),
            searchDTO.getExperienceYears(),
            searchDTO.getLocation(),
            searchDTO.getProjectTypes(),
            searchDTO.getFavoriteOnly(),
            pageable
        );
        
        // プロジェクトIDとエンジニアIDのリストを抽出
        Set<UUID> projectIds = results.getContent().stream()
            .map(MatchingResult::getProjectId)
            .collect(Collectors.toSet());
            
        Set<UUID> engineerIds = results.getContent().stream()
            .map(MatchingResult::getEngineerId)
            .collect(Collectors.toSet());
        
        // 一括データ取得
        Map<UUID, ProjectDTO> projectMap = projectService.getProjectsByIds(projectIds)
            .stream()
            .collect(Collectors.toMap(ProjectDTO::getId, p -> p));
            
        Map<UUID, EngineerDTO> engineerMap = engineerService.getEngineersByIds(engineerIds)
            .stream()
            .collect(Collectors.toMap(EngineerDTO::getId, e -> e));
        
        // DTOへの変換（関連情報を含む）
        return results.map(entity -> {
            MatchingResultDTO dto = matchingMapper.toDto(entity);
            
            // 関連情報の設定
            ProjectDTO project = projectMap.get(entity.getProjectId());
            if (project != null) {
                dto.setProjectName(project.getProjectName());
            }
            
            EngineerDTO engineer = engineerMap.get(entity.getEngineerId());
            if (engineer != null) {
                dto.setEngineerName(engineer.getFullName());
            }
            
            return dto;
        });
    }
}
```

### 10.2 キャッシュ設定

```java
@Configuration
@EnableCaching
public class CacheConfig {

    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
            .expireAfterWrite(1, TimeUnit.HOURS)
            .maximumSize(1000)
        );
        cacheManager.setCacheNames(Arrays.asList(
            "matchingResults",
            "proposals",
            "projectDetails",
            "engineerDetails"
        ));
        return cacheManager;
    }
}

@Service
public class MatchingServiceImpl implements MatchingService {

    @Cacheable(value = "matchingResults", key = "#id")
    @Override
    public MatchingResultDTO getMatchingResultById(UUID id) {
        MatchingResult result = matchingResultRepository.findById(id)
            .orElseThrow(() -> new EntityNotFoundException("Matching result not found: " + id));
        return matchingMapper.toDto(result);
    }
    
    @CacheEvict(value = "matchingResults", key = "#id")
    @Override
    public void toggleFavorite(UUID id) {
        // お気に入り状態の切り替え
    }
}
```

## 11. 監視と運用

### 11.1 ログ設計

```java
@Slf4j
@Service
public class MatchingServiceImpl implements MatchingService {

    @Override
    public MatchingResultDTO calculateSingleMatching(UUID projectId, UUID engineerId) {
        log.info("Starting matching calculation for project {} and engineer {}", projectId, engineerId);
        
        try {
            // 処理
            MatchingResultDTO result = doCalculateMatching(projectId, engineerId);
            
            log.info("Completed matching calculation: score={}", result.getMatchingScore());
            return result;
        } catch (Exception e) {
            log.error("Error during matching calculation: {}", e.getMessage(), e);
            throw e;
        }
    }
}
```

### 11.2 メトリクス設計

```java
@Service
public class MatchingMetricsService {

    private final MeterRegistry meterRegistry;
    
    @Autowired
    public MatchingMetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    public void recordMatchingCalculation(double durationMs, double score) {
        // 処理時間の記録
        meterRegistry.timer("matching.calculation.duration").record(durationMs, TimeUnit.MILLISECONDS);
        
        // スコア分布の記録
        meterRegistry.summary("matching.score.distribution").record(score);
    }
    
    public void incrementProposalCounter(ProposalStatus status) {
        meterRegistry.counter("proposals.count", "status", status.name()).increment();
    }
    
    public void recordProposalProcessingTime(ProposalStatus fromStatus, ProposalStatus toStatus, long durationDays) {
        meterRegistry.timer("proposal.processing.time", 
                          "from", fromStatus.name(), 
                          "to", toStatus.name())
                    .record(durationDays, TimeUnit.DAYS);
    }
}
```