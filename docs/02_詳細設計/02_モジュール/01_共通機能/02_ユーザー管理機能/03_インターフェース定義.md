# ユーザー管理機能 - インターフェース定義

## 1. インターフェース概要

ユーザー管理機能は、SES業務システム全体でユーザー、ロール、権限を管理するための一連のインターフェースを提供します。これらのインターフェースは、他のモジュールからユーザー情報にアクセスするための標準的な方法を定義します。

## 2. 提供インターフェース

### 2.1 UserService

**目的**: ユーザーアカウントの操作を提供するサービスインターフェース

**責務**:
- ユーザーの検索・取得
- ユーザーの作成・更新・管理
- パスワード管理
- アカウント状態管理
- 多要素認証設定管理

#### メソッド一覧

**findAll**
- **目的**: 検索条件に基づいてユーザー一覧を取得する
- **引数**: 検索条件、ページング情報
- **戻り値**: ユーザーDTOのページング結果

**findById**
- **目的**: IDに基づいてユーザー詳細を取得する
- **引数**: ユーザーID (UUID)
- **戻り値**: ユーザーDTO
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

**findByUserId**
- **目的**: ログインIDに基づいてユーザー詳細を取得する
- **引数**: ユーザーID（ログインID）
- **戻り値**: ユーザーDTO
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

**findByEmail**
- **目的**: メールアドレスに基づいてユーザー詳細を取得する
- **引数**: メールアドレス
- **戻り値**: ユーザーDTO
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

**create**
- **目的**: 新規ユーザーを作成する
- **引数**: 作成用DTO
- **戻り値**: 作成されたユーザーDTO
- **例外**:
  - ユーザーIDまたはメールアドレスが既に使用されている場合に DuplicateEntityException
  - バリデーションエラーがある場合に ValidationException

**update**
- **目的**: ユーザー情報を更新する
- **引数**: ユーザーID、更新用DTO
- **戻り値**: 更新されたユーザーDTO
- **例外**:
  - ユーザーが存在しない場合に EntityNotFoundException
  - メールアドレスが他のユーザーと重複する場合に DuplicateEntityException
  - バリデーションエラーがある場合に ValidationException

**updateStatus**
- **目的**: ユーザーのステータスを更新する
- **引数**: ユーザーID、新しいステータス
- **例外**:
  - ユーザーが存在しない場合に EntityNotFoundException
  - ビジネスルール違反（最後の管理者を無効化など）の場合に BusinessRuleException

**resetPassword**
- **目的**: ユーザーのパスワードをリセットする
- **引数**: ユーザーID
- **戻り値**: 一時パスワード
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

**unlockAccount**
- **目的**: ユーザーのアカウントロックを解除する
- **引数**: ユーザーID
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

**bulkUpdateStatus**
- **目的**: 複数ユーザーのステータスを一括更新する
- **引数**: ユーザーIDリスト、新しいステータス
- **例外**: ビジネスルール違反の場合に BusinessRuleException

**changePassword**
- **目的**: ユーザーのパスワードを変更する
- **引数**: ユーザーID、現在のパスワード、新しいパスワード
- **例外**:
  - ユーザーが存在しない場合に EntityNotFoundException
  - 現在のパスワードが一致しない場合に AuthenticationException
  - 新しいパスワードがポリシーに違反する場合に ValidationException

**updateMfaSettings**
- **目的**: ユーザーの多要素認証設定を更新する
- **引数**: ユーザーID、有効/無効フラグ
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

### 2.2 RoleService

**目的**: ロール定義の操作を提供するサービスインターフェース

**責務**:
- ロールの検索・取得
- ロールの作成・更新・削除
- ロールの複製

#### メソッド一覧

**findAll**
- **目的**: ロール一覧を取得する
- **引数**: ページング情報
- **戻り値**: ロールDTOのページング結果

**findById**
- **目的**: IDに基づいてロール詳細を取得する
- **引数**: ロールID (UUID)
- **戻り値**: ロールDTO
- **例外**: ロールが存在しない場合に EntityNotFoundException

**findByRoleId**
- **目的**: ロールIDに基づいてロール詳細を取得する
- **引数**: ロールID文字列
- **戻り値**: ロールDTO
- **例外**: ロールが存在しない場合に EntityNotFoundException

**create**
- **目的**: 新しいロールを作成する
- **引数**: 作成用DTO
- **戻り値**: 作成されたロールDTO
- **例外**:
  - ロールIDが既に使用されている場合に DuplicateEntityException
  - バリデーションエラーがある場合に ValidationException

**update**
- **目的**: ロール情報を更新する
- **引数**: ロールID、更新用DTO
- **戻り値**: 更新されたロールDTO
- **例外**:
  - ロールが存在しない場合に EntityNotFoundException
  - バリデーションエラーがある場合に ValidationException

**delete**
- **目的**: ロールを削除する
- **引数**: ロールID
- **例外**:
  - ロールが存在しない場合に EntityNotFoundException
  - 削除できないシステムロールの場合に BusinessRuleException

**clone**
- **目的**: 既存のロールを複製して新しいロールを作成する
- **引数**: 複製元ロールID、新しいロールID、新しいロール名
- **戻り値**: 作成されたロールDTO
- **例外**:
  - 複製元ロールが存在しない場合に EntityNotFoundException
  - 新しいロールIDが既に使用されている場合に DuplicateEntityException

**findByRoleType**
- **目的**: ロールタイプに基づいてロール一覧を取得する
- **引数**: ロールタイプ
- **戻り値**: ロールDTOのリスト

### 2.3 PermissionService

**目的**: 権限定義の操作を提供するサービスインターフェース

**責務**:
- 権限の検索・取得
- 権限グループの取得
- ロール権限の管理

#### メソッド一覧

**findAll**
- **目的**: 全ての権限を取得する
- **戻り値**: 権限DTOのリスト

**findAllGroups**
- **目的**: 権限グループの階層構造を取得する
- **戻り値**: 権限グループDTOのリスト

**findByRoleId**
- **目的**: ロールに割り当てられた権限を取得する
- **引数**: ロールID
- **戻り値**: ロール権限DTOのリスト
- **例外**: ロールが存在しない場合に EntityNotFoundException

**updateRolePermissions**
- **目的**: ロールの権限を更新する
- **引数**: ロールID、権限更新DTOのリスト
- **例外**:
  - ロールまたは権限が存在しない場合に EntityNotFoundException
  - バリデーションエラーがある場合に ValidationException

**findByResourceType**
- **目的**: リソースタイプに基づいて権限を取得する
- **引数**: リソースタイプ
- **戻り値**: 権限DTOのリスト

### 2.4 UserRoleService

**目的**: ユーザーとロールの関連付け操作を提供するサービスインターフェース

**責務**:
- ユーザーロールの検索・取得
- ユーザーへのロール割り当て
- ロールに関連するユーザーの管理
- ユーザーロール割り当ての履歴管理

#### メソッド一覧

**findRolesByUserId**
- **目的**: ユーザーに割り当てられたロールを取得する
- **引数**: ユーザーID
- **戻り値**: ロールDTOのリスト
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

**updateUserRoles**
- **目的**: ユーザーのロールを更新する
- **引数**: ユーザーID、ロールIDのリスト
- **例外**:
  - ユーザーまたはロールが存在しない場合に EntityNotFoundException
  - ビジネスルール違反の場合に BusinessRuleException

**assignRoleToUser**
- **目的**: ユーザーにロールを割り当てる
- **引数**: ユーザーID、ロールID、有効期限（任意）
- **例外**:
  - ユーザーまたはロールが存在しない場合に EntityNotFoundException
  - 既に割り当てられている場合に DuplicateEntityException

**removeRoleFromUser**
- **目的**: ユーザーからロールを削除する
- **引数**: ユーザーID、ロールID
- **例外**:
  - ユーザーまたはロールが存在しない場合に EntityNotFoundException
  - 最後の管理者ロールを削除しようとした場合に BusinessRuleException

**findUsersByRoleId**
- **目的**: ロールが割り当てられたユーザーを取得する
- **引数**: ロールID、ページング情報
- **戻り値**: ユーザーDTOのページング結果
- **例外**: ロールが存在しない場合に EntityNotFoundException

**bulkAssignRolesToUsers**
- **目的**: 複数ユーザーに複数ロールを一括割り当てる
- **引数**: ユーザーIDのリスト、ロールIDのリスト
- **例外**: ユーザーまたはロールが存在しない場合に EntityNotFoundException

**bulkRemoveRolesFromUsers**
- **目的**: 複数ユーザーから複数ロールを一括削除する
- **引数**: ユーザーIDのリスト、ロールIDのリスト
- **例外**: ビジネスルール違反の場合に BusinessRuleException

**getUserRoleHistory**
- **目的**: ユーザーロール割り当ての履歴を取得する
- **引数**: ユーザーID、ページング情報
- **戻り値**: ユーザーロール履歴DTOのページング結果
- **例外**: ユーザーが存在しない場合に EntityNotFoundException

## 3. 要求インターフェース

### 3.1 AuthenticationService

**目的**: 認証認可機能モジュールから提供される認証サービスを利用するためのインターフェース

**提供モジュール**: 認証認可機能

**主要メソッド**:
- **authenticate**: ユーザーIDとパスワードによる認証を行い、結果を返却
- **validateToken**: トークンの検証を行い、有効性を確認
- **checkPassword**: ユーザーIDとパスワードの照合を行い、一致するか確認
- **getUserFromToken**: トークンからユーザープリンシパル情報を取得

**使用目的と文脈**:
- ユーザーパスワード検証時の照合処理
- アカウントロック解除時の認証情報更新
- パスワードリセット時の認証情報更新

**依存度**: 高
- パスワード関連の操作は認証サービスと密接に連携

### 3.2 NotificationService

**目的**: 通知機能モジュールから提供される通知サービスを利用するためのインターフェース

**提供モジュール**: 通知機能

**主要メソッド**:
- **sendEmail**: 指定された宛先にメール通知を送信
- **sendSystemNotification**: ユーザーIDを指定してシステム内通知を送信

**使用目的と文脈**:
- パスワードリセット時の通知メール送信
- アカウント作成時の初期パスワード通知
- アカウントロック/ロック解除時の通知
- ロール割り当て変更時の通知

**依存度**: 中
- 通知は重要だが、通知失敗がユーザー管理機能の主要操作を妨げるべきではない

### 3.3 AuditLogService

**目的**: ロギング機能モジュールから提供される監査ログサービスを利用するためのインターフェース

**提供モジュール**: ロギング機能

**主要メソッド**:
- **recordAuditLog**: 監査ログを記録
- **searchAuditLogs**: 監査ログを検索

**使用目的と文脈**:
- セキュリティに関わる操作（ロール割り当て、権限変更）の監査ログ記録
- アカウント作成、編集、ステータス変更の監査証跡
- パスワードリセット、アカウントロック解除などのセキュリティイベント記録

**依存度**: 中
- 監査ログは重要だが、ログ記録失敗がユーザー管理機能の主要操作を妨げるべきではない

## 4. データ交換モデル

### 4.1 ユーザー関連データモデル

**UserDTO（ユーザー詳細DTO）**
- id: ユーザーID (UUID)
- userId: ログインID (String)
- email: メールアドレス (String)
- name: 氏名 (String)
- department: 部署 (String)
- position: 役職 (String)
- phone: 電話番号 (String)
- mfaEnabled: 多要素認証有効フラグ (boolean)
- status: ユーザーステータス (Enum)
- lastLoginAt: 最終ログイン日時 (LocalDateTime)
- passwordExpiresAt: パスワード有効期限 (LocalDateTime)
- createdAt: 作成日時 (LocalDateTime)
- updatedAt: 更新日時 (LocalDateTime)

**UserCreateDTO（ユーザー作成DTO）**
- userId: ログインID (String)
- email: メールアドレス (String)
- name: 氏名 (String)
- department: 部署 (String)
- position: 役職 (String)
- phone: 電話番号 (String)
- initialPassword: 初期パスワード (String)
- mfaEnabled: 多要素認証有効フラグ (boolean)
- status: ユーザーステータス (Enum)

**UserUpdateDTO（ユーザー更新DTO）**
- email: メールアドレス (String)
- name: 氏名 (String)
- department: 部署 (String)
- position: 役職 (String)
- phone: 電話番号 (String)
- mfaEnabled: 多要素認証有効フラグ (boolean)

**UserSearchCriteria（ユーザー検索条件）**
- userId: ログインID (String)
- name: 氏名 (String)
- email: メールアドレス (String)
- roleId: ロールID (UUID)
- status: ユーザーステータス (Enum)
- department: 部署 (String)

### 4.2 ロール関連データモデル

**RoleDTO（ロール詳細DTO）**
- id: ロールID (UUID)
- roleId: ロールID文字列 (String)
- name: ロール名 (String)
- description: 説明 (String)
- roleType: ロールタイプ (Enum)
- createdAt: 作成日時 (LocalDateTime)
- updatedAt: 更新日時 (LocalDateTime)
- userCount: このロールが割り当てられたユーザー数 (int)

**RoleCreateDTO（ロール作成DTO）**
- roleId: ロールID文字列 (String)
- name: ロール名 (String)
- description: 説明 (String)
- roleType: ロールタイプ (Enum)

**RoleUpdateDTO（ロール更新DTO）**
- name: ロール名 (String)
- description: 説明 (String)

### 4.3 権限関連データモデル

**PermissionDTO（権限詳細DTO）**
- id: 権限ID (UUID)
- permissionId: 権限ID文字列 (String)
- name: 権限名 (String)
- description: 説明 (String)
- resourceType: リソースタイプ (String)
- resourceName: リソース名 (String)
- action: アクション (String)

**PermissionGroupDTO（権限グループDTO）**
- resourceType: リソースタイプ (String)
- displayName: 表示名 (String)
- resources: 権限リソースDTOのリスト (List)

**PermissionResourceDTO（権限リソースDTO）**
- resourceName: リソース名 (String)
- displayName: 表示名 (String)
- actions: 権限アクションDTOのリスト (List)

**PermissionActionDTO（権限アクションDTO）**
- permissionId: 権限ID (UUID)
- action: アクション (String)
- displayName: 表示名 (String)

**RolePermissionDTO（ロール権限DTO）**
- permissionId: 権限ID (UUID)
- permissionName: 権限名 (String)
- resourceType: リソースタイプ (String)
- resourceName: リソース名 (String)
- action: アクション (String)
- accessLevel: アクセスレベル (Enum)

**RolePermissionUpdateDTO（ロール権限更新DTO）**
- permissionId: 権限ID (UUID)
- accessLevel: アクセスレベル (Enum)

### 4.4 ユーザーロール関連データモデル

**UserRoleHistoryDTO（ユーザーロール履歴DTO）**
- id: 履歴ID (UUID)
- userId: ユーザーID (UUID)
- userName: ユーザー名 (String)
- roleId: ロールID (UUID)
- roleName: ロール名 (String)
- operationType: 操作タイプ (Enum)
- performedBy: 操作者ID (UUID)
- performedByName: 操作者名 (String)
- performedAt: 操作日時 (LocalDateTime)
- reason: 理由 (String)

## 5. 非機能要件

### 5.1 パフォーマンス要件

- ユーザー一覧取得: 1000件/秒のスループット
- ユーザー詳細取得: 100ms以内のレスポンス時間
- ロール・権限更新: 500ms以内のレスポンス時間
- 一括操作: 最大1000ユーザーまでのバッチ処理をサポート

### 5.2 トランザクション管理

- ユーザー作成・更新: REQUIRED
- ロール作成・更新: REQUIRED
- 権限設定: REQUIRED
- ユーザーロール割り当て: REQUIRED
- 一括操作: REQUIRED

### 5.3 セキュリティ要件

- 全APIは適切な認証・認可チェック後にアクセス可能
- パスワード関連操作はセキュアなチャネルでのみ実行
- 権限変更はセキュリティ監査ログに記録
- センシティブ情報（パスワードハッシュなど）は暗号化して保存

### 5.4 可用性要件

- 稼働率: 99.9%
- 障害時の最大許容データ損失: 5分
- リカバリポイント目標 (RPO): 5分
- リカバリ時間目標 (RTO): 15分