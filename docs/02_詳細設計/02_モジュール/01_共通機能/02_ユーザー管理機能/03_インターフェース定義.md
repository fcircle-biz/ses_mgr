# ユーザー管理機能 - インターフェース定義

## 1. インターフェース概要

ユーザー管理機能は、SES業務システム全体でユーザー、ロール、権限を管理するための一連のインターフェースを提供します。これらのインターフェースは、他のモジュールからユーザー情報にアクセスするための標準的な方法を定義します。

## 2. 提供インターフェース

### 2.1 UserService

ユーザーアカウントの操作を提供するサービスインターフェースです。

```java
public interface UserService {
    /**
     * 検索条件に基づいてユーザー一覧を取得する
     * @param criteria 検索条件
     * @param pageable ページング情報
     * @return ユーザーDTOのページング結果
     */
    Page<UserDTO> findAll(UserSearchCriteria criteria, Pageable pageable);
    
    /**
     * IDに基づいてユーザー詳細を取得する
     * @param id ユーザーID
     * @return ユーザーDTO
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    UserDTO findById(UUID id);
    
    /**
     * ユーザーIDに基づいてユーザー詳細を取得する
     * @param userId ユーザーID（ログインID）
     * @return ユーザーDTO
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    UserDTO findByUserId(String userId);
    
    /**
     * メールアドレスに基づいてユーザー詳細を取得する
     * @param email メールアドレス
     * @return ユーザーDTO
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    UserDTO findByEmail(String email);
    
    /**
     * 新規ユーザーを作成する
     * @param userCreateDTO 作成用DTO
     * @return 作成されたユーザーDTO
     * @throws DuplicateEntityException ユーザーIDまたはメールアドレスが既に使用されている場合
     * @throws ValidationException バリデーションエラーがある場合
     */
    UserDTO create(UserCreateDTO userCreateDTO);
    
    /**
     * ユーザー情報を更新する
     * @param id ユーザーID
     * @param userUpdateDTO 更新用DTO
     * @return 更新されたユーザーDTO
     * @throws EntityNotFoundException ユーザーが存在しない場合
     * @throws DuplicateEntityException メールアドレスが他のユーザーと重複する場合
     * @throws ValidationException バリデーションエラーがある場合
     */
    UserDTO update(UUID id, UserUpdateDTO userUpdateDTO);
    
    /**
     * ユーザーのステータスを更新する
     * @param id ユーザーID
     * @param status 新しいステータス
     * @throws EntityNotFoundException ユーザーが存在しない場合
     * @throws BusinessRuleException ビジネスルール違反（最後の管理者を無効化など）の場合
     */
    void updateStatus(UUID id, UserStatus status);
    
    /**
     * ユーザーのパスワードをリセットする
     * @param id ユーザーID
     * @return 一時パスワード
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    String resetPassword(UUID id);
    
    /**
     * ユーザーのアカウントロックを解除する
     * @param id ユーザーID
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    void unlockAccount(UUID id);
    
    /**
     * 複数ユーザーのステータスを一括更新する
     * @param ids ユーザーIDリスト
     * @param status 新しいステータス
     * @throws BusinessRuleException ビジネスルール違反の場合
     */
    void bulkUpdateStatus(List<UUID> ids, UserStatus status);
    
    /**
     * ユーザーのパスワードを変更する
     * @param id ユーザーID
     * @param currentPassword 現在のパスワード
     * @param newPassword 新しいパスワード
     * @throws EntityNotFoundException ユーザーが存在しない場合
     * @throws AuthenticationException 現在のパスワードが一致しない場合
     * @throws ValidationException 新しいパスワードがポリシーに違反する場合
     */
    void changePassword(UUID id, String currentPassword, String newPassword);
    
    /**
     * ユーザーの多要素認証設定を更新する
     * @param id ユーザーID
     * @param enabled 有効/無効
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    void updateMfaSettings(UUID id, boolean enabled);
}
```

### 2.2 RoleService

ロール定義の操作を提供するサービスインターフェースです。

```java
public interface RoleService {
    /**
     * ロール一覧を取得する
     * @param pageable ページング情報
     * @return ロールDTOのページング結果
     */
    Page<RoleDTO> findAll(Pageable pageable);
    
    /**
     * IDに基づいてロール詳細を取得する
     * @param id ロールID
     * @return ロールDTO
     * @throws EntityNotFoundException ロールが存在しない場合
     */
    RoleDTO findById(UUID id);
    
    /**
     * ロールIDに基づいてロール詳細を取得する
     * @param roleId ロールID文字列
     * @return ロールDTO
     * @throws EntityNotFoundException ロールが存在しない場合
     */
    RoleDTO findByRoleId(String roleId);
    
    /**
     * 新しいロールを作成する
     * @param roleCreateDTO 作成用DTO
     * @return 作成されたロールDTO
     * @throws DuplicateEntityException ロールIDが既に使用されている場合
     * @throws ValidationException バリデーションエラーがある場合
     */
    RoleDTO create(RoleCreateDTO roleCreateDTO);
    
    /**
     * ロール情報を更新する
     * @param id ロールID
     * @param roleUpdateDTO 更新用DTO
     * @return 更新されたロールDTO
     * @throws EntityNotFoundException ロールが存在しない場合
     * @throws ValidationException バリデーションエラーがある場合
     */
    RoleDTO update(UUID id, RoleUpdateDTO roleUpdateDTO);
    
    /**
     * ロールを削除する
     * @param id ロールID
     * @throws EntityNotFoundException ロールが存在しない場合
     * @throws BusinessRuleException 削除できないシステムロールの場合
     */
    void delete(UUID id);
    
    /**
     * 既存のロールを複製して新しいロールを作成する
     * @param id 複製元ロールID
     * @param newRoleId 新しいロールID
     * @param newRoleName 新しいロール名
     * @return 作成されたロールDTO
     * @throws EntityNotFoundException 複製元ロールが存在しない場合
     * @throws DuplicateEntityException 新しいロールIDが既に使用されている場合
     */
    RoleDTO clone(UUID id, String newRoleId, String newRoleName);
    
    /**
     * ロールタイプに基づいてロール一覧を取得する
     * @param roleType ロールタイプ
     * @return ロールDTOのリスト
     */
    List<RoleDTO> findByRoleType(RoleType roleType);
}
```

### 2.3 PermissionService

権限定義の操作を提供するサービスインターフェースです。

```java
public interface PermissionService {
    /**
     * 全ての権限を取得する
     * @return 権限DTOのリスト
     */
    List<PermissionDTO> findAll();
    
    /**
     * 権限グループの階層構造を取得する
     * @return 権限グループDTOのリスト
     */
    List<PermissionGroupDTO> findAllGroups();
    
    /**
     * ロールに割り当てられた権限を取得する
     * @param roleId ロールID
     * @return ロール権限DTOのリスト
     * @throws EntityNotFoundException ロールが存在しない場合
     */
    List<RolePermissionDTO> findByRoleId(UUID roleId);
    
    /**
     * ロールの権限を更新する
     * @param roleId ロールID
     * @param permissions 権限更新DTOのリスト
     * @throws EntityNotFoundException ロールまたは権限が存在しない場合
     * @throws ValidationException バリデーションエラーがある場合
     */
    void updateRolePermissions(UUID roleId, List<RolePermissionUpdateDTO> permissions);
    
    /**
     * リソースタイプに基づいて権限を取得する
     * @param resourceType リソースタイプ
     * @return 権限DTOのリスト
     */
    List<PermissionDTO> findByResourceType(String resourceType);
}
```

### 2.4 UserRoleService

ユーザーとロールの関連付け操作を提供するサービスインターフェースです。

```java
public interface UserRoleService {
    /**
     * ユーザーに割り当てられたロールを取得する
     * @param userId ユーザーID
     * @return ロールDTOのリスト
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    List<RoleDTO> findRolesByUserId(UUID userId);
    
    /**
     * ユーザーのロールを更新する
     * @param userId ユーザーID
     * @param roleIds ロールIDのリスト
     * @throws EntityNotFoundException ユーザーまたはロールが存在しない場合
     * @throws BusinessRuleException ビジネスルール違反の場合
     */
    void updateUserRoles(UUID userId, List<UUID> roleIds);
    
    /**
     * ユーザーにロールを割り当てる
     * @param userId ユーザーID
     * @param roleId ロールID
     * @param expiresAt 有効期限（任意）
     * @throws EntityNotFoundException ユーザーまたはロールが存在しない場合
     * @throws DuplicateEntityException 既に割り当てられている場合
     */
    void assignRoleToUser(UUID userId, UUID roleId, LocalDateTime expiresAt);
    
    /**
     * ユーザーからロールを削除する
     * @param userId ユーザーID
     * @param roleId ロールID
     * @throws EntityNotFoundException ユーザーまたはロールが存在しない場合
     * @throws BusinessRuleException 最後の管理者ロールを削除しようとした場合
     */
    void removeRoleFromUser(UUID userId, UUID roleId);
    
    /**
     * ロールが割り当てられたユーザーを取得する
     * @param roleId ロールID
     * @param pageable ページング情報
     * @return ユーザーDTOのページング結果
     * @throws EntityNotFoundException ロールが存在しない場合
     */
    Page<UserDTO> findUsersByRoleId(UUID roleId, Pageable pageable);
    
    /**
     * 複数ユーザーに複数ロールを一括割り当てる
     * @param userIds ユーザーIDのリスト
     * @param roleIds ロールIDのリスト
     * @throws EntityNotFoundException ユーザーまたはロールが存在しない場合
     */
    void bulkAssignRolesToUsers(List<UUID> userIds, List<UUID> roleIds);
    
    /**
     * 複数ユーザーから複数ロールを一括削除する
     * @param userIds ユーザーIDのリスト
     * @param roleIds ロールIDのリスト
     * @throws BusinessRuleException ビジネスルール違反の場合
     */
    void bulkRemoveRolesFromUsers(List<UUID> userIds, List<UUID> roleIds);
    
    /**
     * ユーザーロール割り当ての履歴を取得する
     * @param userId ユーザーID
     * @param pageable ページング情報
     * @return ユーザーロール履歴DTOのページング結果
     * @throws EntityNotFoundException ユーザーが存在しない場合
     */
    Page<UserRoleHistoryDTO> getUserRoleHistory(UUID userId, Pageable pageable);
}
```

## 3. 要求インターフェース

### 3.1 AuthenticationService

認証認可機能モジュールから提供される認証サービスを利用します。

```java
// 認証認可機能モジュールが提供するインターフェース（参照のみ）
public interface AuthenticationService {
    AuthenticationResult authenticate(String userId, String password);
    boolean validateToken(String token);
    boolean checkPassword(UUID userId, String password);
    UserPrincipal getUserFromToken(String token);
}
```

**使用目的と文脈**:
- ユーザーパスワード検証時の照合処理
- アカウントロック解除時の認証情報更新
- パスワードリセット時の認証情報更新

**依存度**: 高
- パスワード関連の操作は認証サービスと密接に連携

### 3.2 NotificationService

通知機能モジュールから提供される通知サービスを利用します。

```java
// 通知機能モジュールが提供するインターフェース（参照のみ）
public interface NotificationService {
    void sendEmail(String to, String subject, String body, Map<String, Object> templateParams);
    void sendSystemNotification(UUID userId, String title, String message, NotificationType type);
}
```

**使用目的と文脈**:
- パスワードリセット時の通知メール送信
- アカウント作成時の初期パスワード通知
- アカウントロック/ロック解除時の通知
- ロール割り当て変更時の通知

**依存度**: 中
- 通知は重要だが、通知失敗がユーザー管理機能の主要操作を妨げるべきではない

### 3.3 AuditLogService

ロギング機能モジュールから提供される監査ログサービスを利用します。

```java
// ロギング機能モジュールが提供するインターフェース（参照のみ）
public interface AuditLogService {
    void recordAuditLog(String action, String resourceType, String resourceId, 
                       UUID performedBy, Map<String, Object> details);
    Page<AuditLogDTO> searchAuditLogs(AuditLogSearchCriteria criteria, Pageable pageable);
}
```

**使用目的と文脈**:
- セキュリティに関わる操作（ロール割り当て、権限変更）の監査ログ記録
- アカウント作成、編集、ステータス変更の監査証跡
- パスワードリセット、アカウントロック解除などのセキュリティイベント記録

**依存度**: 中
- 監査ログは重要だが、ログ記録失敗がユーザー管理機能の主要操作を妨げるべきではない

## 4. データ交換モデル

### 4.1 ユーザー関連DTO

```java
// ユーザー詳細DTO
public class UserDTO {
    private UUID id;
    private String userId;
    private String email;
    private String name;
    private String department;
    private String position;
    private String phone;
    private boolean mfaEnabled;
    private UserStatus status;
    private LocalDateTime lastLoginAt;
    private LocalDateTime passwordExpiresAt;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    // getters, setters
}

// ユーザー作成DTO
public class UserCreateDTO {
    private String userId;
    private String email;
    private String name;
    private String department;
    private String position;
    private String phone;
    private String initialPassword;
    private boolean mfaEnabled;
    private UserStatus status;
    // getters, setters, validation
}

// ユーザー更新DTO
public class UserUpdateDTO {
    private String email;
    private String name;
    private String department;
    private String position;
    private String phone;
    private boolean mfaEnabled;
    // getters, setters, validation
}

// ユーザー検索条件
public class UserSearchCriteria {
    private String userId;
    private String name;
    private String email;
    private UUID roleId;
    private UserStatus status;
    private String department;
    // getters, setters
}
```

### 4.2 ロール関連DTO

```java
// ロール詳細DTO
public class RoleDTO {
    private UUID id;
    private String roleId;
    private String name;
    private String description;
    private RoleType roleType;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private int userCount;  // このロールが割り当てられたユーザー数
    // getters, setters
}

// ロール作成DTO
public class RoleCreateDTO {
    private String roleId;
    private String name;
    private String description;
    private RoleType roleType;
    // getters, setters, validation
}

// ロール更新DTO
public class RoleUpdateDTO {
    private String name;
    private String description;
    // getters, setters, validation
}
```

### 4.3 権限関連DTO

```java
// 権限詳細DTO
public class PermissionDTO {
    private UUID id;
    private String permissionId;
    private String name;
    private String description;
    private String resourceType;
    private String resourceName;
    private String action;
    // getters, setters
}

// 権限グループDTO
public class PermissionGroupDTO {
    private String resourceType;
    private String displayName;
    private List<PermissionResourceDTO> resources;
    // getters, setters
}

// 権限リソースDTO
public class PermissionResourceDTO {
    private String resourceName;
    private String displayName;
    private List<PermissionActionDTO> actions;
    // getters, setters
}

// 権限アクションDTO
public class PermissionActionDTO {
    private UUID permissionId;
    private String action;
    private String displayName;
    // getters, setters
}

// ロール権限DTO
public class RolePermissionDTO {
    private UUID permissionId;
    private String permissionName;
    private String resourceType;
    private String resourceName;
    private String action;
    private AccessLevel accessLevel;
    // getters, setters
}

// ロール権限更新DTO
public class RolePermissionUpdateDTO {
    private UUID permissionId;
    private AccessLevel accessLevel;
    // getters, setters, validation
}
```

### 4.4 ユーザーロール関連DTO

```java
// ユーザーロール履歴DTO
public class UserRoleHistoryDTO {
    private UUID id;
    private UUID userId;
    private String userName;
    private UUID roleId;
    private String roleName;
    private OperationType operationType;
    private UUID performedBy;
    private String performedByName;
    private LocalDateTime performedAt;
    private String reason;
    // getters, setters
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- ユーザー一覧取得: 1000件/秒のスループット
- ユーザー詳細取得: 100ms以内のレスポンス時間
- ロール・権限更新: 500ms以内のレスポンス時間
- 一括操作: 最大1000ユーザーまでのバッチ処理をサポート

### 5.2 トランザクション管理

- ユーザー作成・更新: REQUIRED
- ロール作成・更新: REQUIRED
- 権限設定: REQUIRED
- ユーザーロール割り当て: REQUIRED
- 一括操作: REQUIRED

### 5.3 セキュリティ要件

- 全APIは適切な認証・認可チェック後にアクセス可能
- パスワード関連操作はセキュアなチャネルでのみ実行
- 権限変更はセキュリティ監査ログに記録
- センシティブ情報（パスワードハッシュなど）は暗号化して保存

### 5.4 可用性要件

- 稼働率: 99.9%
- 障害時の最大許容データ損失: 5分
- リカバリポイント目標 (RPO): 5分
- リカバリ時間目標 (RTO): 15分