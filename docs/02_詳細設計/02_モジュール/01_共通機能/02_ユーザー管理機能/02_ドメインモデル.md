# ユーザー管理機能 - ドメインモデル

## 1. エンティティ定義

### 1.1 User（ユーザー）

システムを利用するユーザーアカウントを表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | ユーザーの一意識別子 |
| userId | String | ○ | ユーザーID（ログイン用） |
| email | String | ○ | メールアドレス |
| name | String | ○ | 氏名 |
| department | String |  | 所属部門 |
| position | String |  | 役職 |
| phone | String |  | 電話番号 |
| passwordHash | String | ○ | パスワードハッシュ値 |
| mfaEnabled | Boolean | ○ | 多要素認証の有効/無効 |
| status | UserStatus | ○ | アカウント状態 |
| lastLoginAt | DateTime |  | 最終ログイン日時 |
| loginAttempts | Integer | ○ | 連続ログイン失敗回数 |
| passwordExpiresAt | DateTime | ○ | パスワード有効期限 |
| createdAt | DateTime | ○ | アカウント作成日時 |
| updatedAt | DateTime | ○ | アカウント更新日時 |

#### バリデーションルール

- `userId`: 英数字とハイフン、アンダースコアのみ許可、3〜32文字
- `email`: 有効なメールアドレス形式、最大256文字
- `name`: 最大100文字
- `department`: 最大100文字
- `position`: 最大100文字
- `phone`: 有効な電話番号形式
- `loginAttempts`: 0以上の整数

#### ビジネスルール

- パスワードはシステムで定義されたポリシーに従う
- 連続ログイン失敗回数が閾値（デフォルト: 5回）を超えた場合、アカウントを自動的にロック
- パスワードは定期的に変更を要求（デフォルト: 90日）
- 過去に使用したパスワードの再利用禁止（デフォルト: 過去5回分）

### 1.2 Role（ロール）

システム内の役割や権限の集合を表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | ロールの一意識別子 |
| roleId | String | ○ | ロールID |
| name | String | ○ | ロール名称 |
| description | String |  | ロールの説明 |
| roleType | RoleType | ○ | ロール区分 |
| createdAt | DateTime | ○ | ロール作成日時 |
| updatedAt | DateTime | ○ | ロール更新日時 |

#### バリデーションルール

- `roleId`: 英数字とハイフン、アンダースコアのみ許可、3〜32文字
- `name`: 最大100文字
- `description`: 最大500文字

#### ビジネスルール

- システムロールはシステム管理者のみが作成・編集可能
- 業務ロールはセキュリティ管理者が作成・編集可能
- 特定のシステムロール（SYSTEM_ADMIN等）は削除不可

### 1.3 Permission（権限）

特定のリソースに対するアクセス権限を表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | 権限の一意識別子 |
| permissionId | String | ○ | 権限ID |
| name | String | ○ | 権限名称 |
| description | String |  | 権限の説明 |
| resourceType | String | ○ | リソース種別（機能グループ） |
| resourceName | String | ○ | リソース名（機能） |
| action | String | ○ | アクション（参照/編集/実行） |

#### バリデーションルール

- `permissionId`: 英数字とハイフン、アンダースコアのみ許可、3〜64文字
- `name`: 最大100文字
- `description`: 最大500文字
- `resourceType`: 最大100文字
- `resourceName`: 最大100文字
- `action`: "READ", "WRITE", "EXECUTE" のいずれか

#### ビジネスルール

- 権限IDは `{resourceType}:{resourceName}:{action}` の形式で自動生成
- システム定義の権限は変更・削除不可

### 1.4 RolePermission（ロール権限関連）

ロールと権限の関連付けを表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| roleId | UUID | ○ | ロールID（外部キー） |
| permissionId | UUID | ○ | 権限ID（外部キー） |
| accessLevel | AccessLevel | ○ | アクセスレベル |

#### バリデーションルール

- `roleId`: 有効なロールIDであること
- `permissionId`: 有効な権限IDであること

#### ビジネスルール

- 一つのロールに対して同じ権限を重複して割り当てることはできない

### 1.5 UserRole（ユーザーロール関連）

ユーザーとロールの関連付けを表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| userId | UUID | ○ | ユーザーID（外部キー） |
| roleId | UUID | ○ | ロールID（外部キー） |
| assignedAt | DateTime | ○ | 割り当て日時 |
| assignedBy | UUID | ○ | 割り当てを行ったユーザーID |
| expiresAt | DateTime |  | 有効期限（一時的な権限付与の場合） |

#### バリデーションルール

- `userId`: 有効なユーザーIDであること
- `roleId`: 有効なロールIDであること
- `assignedBy`: 有効なユーザーIDであること
- `expiresAt`: 現在時刻より後の日時であること

#### ビジネスルール

- 一つのユーザーに対して同じロールを重複して割り当てることはできない
- 有効期限が設定されている場合、期限到達後に自動的に関連が無効化される

### 1.6 UserRoleHistory（ユーザーロール履歴）

ユーザーとロールの関連付け履歴を表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | 履歴の一意識別子 |
| userId | UUID | ○ | ユーザーID（外部キー） |
| roleId | UUID | ○ | ロールID（外部キー） |
| operationType | OperationType | ○ | 操作種別 |
| performedBy | UUID | ○ | 操作を行ったユーザーID |
| performedAt | DateTime | ○ | 操作日時 |
| reason | String |  | 操作理由 |

#### バリデーションルール

- `userId`: 有効なユーザーIDであること
- `roleId`: 有効なロールIDであること
- `performedBy`: 有効なユーザーIDであること
- `reason`: 最大500文字

#### ビジネスルール

- ユーザーロール関連の変更は全て履歴として保存される

## 2. 値オブジェクト定義

### 2.1 UserStatus（ユーザー状態）

ユーザーアカウントの状態を表す列挙型です。

```java
public enum UserStatus {
    ACTIVE,        // 有効
    INACTIVE,      // 無効
    LOCKED,        // ロック中
    PENDING,       // 初期登録中（初回ログイン前）
    EXPIRED        // 期限切れ
}
```

### 2.2 RoleType（ロール区分）

ロールの区分を表す列挙型です。

```java
public enum RoleType {
    SYSTEM,        // システムロール
    BUSINESS       // 業務ロール
}
```

### 2.3 AccessLevel（アクセスレベル）

権限のアクセスレベルを表す列挙型です。

```java
public enum AccessLevel {
    NONE,          // アクセス不可
    READ,          // 閲覧のみ
    WRITE,         // 編集可能
    ADMIN          // 管理者権限
}
```

### 2.4 OperationType（操作種別）

ユーザーロール履歴の操作種別を表す列挙型です。

```java
public enum OperationType {
    ASSIGN,        // 割り当て
    REMOVE,        // 削除
    EXPIRE         // 期限切れ
}
```

## 3. ドメイン関連図

```
User ←→ UserRole ←→ Role ←→ RolePermission ←→ Permission
  ↓         ↓
UserRoleHistory
```

- `User` と `Role` は `UserRole` を介して多対多の関連を持つ
- `Role` と `Permission` は `RolePermission` を介して多対多の関連を持つ
- `UserRole` の操作履歴は `UserRoleHistory` に記録される

## 4. 重要なビジネスルール

### 4.1 アカウントセキュリティルール

- パスワードは平文で保存せず、常にハッシュ化して保存する
- パスワードハッシュ化にはbcryptを使用する
- パスワード強度要件：8文字以上、大文字・小文字・数字・特殊文字を含む
- 連続5回のログイン失敗でアカウントを自動ロック
- パスワードリセット時は一時パスワードをメール送信し、初回ログイン時に変更を強制
- パスワード有効期限は90日間
- 過去5回分のパスワードは再利用不可

### 4.2 ロール・権限管理ルール

- システム管理者ロールは必ず1名以上存在する必要がある
- 最後のシステム管理者ロールを持つユーザーからそのロールを削除することはできない
- システム定義のプリセットロールは削除不可
- ロールに割り当てられた権限を変更した場合、そのロールを持つ全ユーザーに影響する
- 一時的なロール付与（有効期限付き）は、期限到達後に自動的に解除される

### 4.3 アカウントライフサイクル管理ルール

- 新規ユーザー作成時は「PENDING」状態で作成される
- 初回ログイン・パスワード変更後に「ACTIVE」状態に変更される
- 退職者のアカウントは「INACTIVE」状態に変更し、データの参照性を維持する
- 「LOCKED」状態のアカウントは管理者のみが解除可能
- 「INACTIVE」状態のアカウントは再有効化可能
- 「EXPIRED」状態のアカウントはパスワード変更後に「ACTIVE」状態に変更される