# 検索機能 インターフェース定義

## 1. インターフェース概要

検索機能モジュールは、システム全体に検索機能を提供するための複数のインターフェースを定義しています。これらのインターフェースを通じて、他のモジュールは検索操作を実行し、検索結果を取得することができます。また、検索履歴の管理や検索候補の提案などの機能もサポートします。

### 1.1 設計方針

- **統一性**: 様々なリソースタイプに対して一貫した検索インターフェースを提供
- **拡張性**: 新しいリソースタイプや検索機能の追加が容易な設計
- **疎結合**: 業務モジュールとの依存関係を最小限に抑えた設計
- **パフォーマンス**: 大量データに対する高速な検索を実現する非同期処理
- **安全性**: 権限に基づく適切なアクセス制御の実施

### 1.2 パッケージ構成

```
jp.co.sesmanager.common.search
  ├── api          // 公開API
  ├── dto          // データ転送オブジェクト
  ├── service      // サービスインターフェース
  ├── exception    // 例外クラス
  ├── event        // イベント関連
  └── config       // 設定クラス
```

## 2. 提供インターフェース

### 2.1 SearchService

検索の実行と結果の取得を行うための主要インターフェースです。

```java
package jp.co.sesmanager.common.search.service;

import jp.co.sesmanager.common.search.dto.SearchQueryDto;
import jp.co.sesmanager.common.search.dto.SearchResultDto;
import jp.co.sesmanager.common.search.exception.SearchException;

import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;

/**
 * 検索機能を提供するサービスインターフェース
 */
public interface SearchService {
    
    /**
     * 検索クエリを実行して結果を取得します
     * @param query 検索クエリDTO
     * @return 検索結果DTO
     * @throws SearchException 検索実行時のエラー
     */
    SearchResultDto search(SearchQueryDto query) throws SearchException;
    
    /**
     * キーワードによる全文検索を実行します
     * @param keyword 検索キーワード
     * @param resourceTypes 検索対象のリソースタイプ（nullの場合は全タイプ）
     * @param page ページ番号（0始まり）
     * @param pageSize ページサイズ
     * @return 検索結果DTO
     * @throws SearchException 検索実行時のエラー
     */
    SearchResultDto globalSearch(
        String keyword,
        List<String> resourceTypes,
        int page,
        int pageSize
    ) throws SearchException;
    
    /**
     * 特定のリソースタイプに対してフィルタ検索を実行します
     * @param resourceType 検索対象のリソースタイプ
     * @param filters フィルタ条件のマップ
     * @param sortField ソートフィールド
     * @param sortOrder ソート順序（"asc" または "desc"）
     * @param page ページ番号（0始まり）
     * @param pageSize ページサイズ
     * @return 検索結果DTO
     * @throws SearchException 検索実行時のエラー
     */
    SearchResultDto filterSearch(
        String resourceType,
        Map<String, Object> filters,
        String sortField,
        String sortOrder,
        int page,
        int pageSize
    ) throws SearchException;
    
    /**
     * 検索を非同期で実行します
     * @param query 検索クエリDTO
     * @return 検索結果の非同期取得用Future
     */
    CompletableFuture<SearchResultDto> searchAsync(SearchQueryDto query);
    
    /**
     * 検索の実行状態を取得します
     * @param searchId 検索ID
     * @return 検索状態
     */
    String getSearchStatus(UUID searchId);
    
    /**
     * 進行中の検索をキャンセルします
     * @param searchId 検索ID
     * @return キャンセル成功の場合はtrue
     */
    boolean cancelSearch(UUID searchId);
}
```

### 2.2 SearchHistoryService

ユーザーの検索履歴を管理するためのインターフェースです。

```java
package jp.co.sesmanager.common.search.service;

import jp.co.sesmanager.common.search.dto.SearchHistoryDto;
import jp.co.sesmanager.common.search.dto.SearchQueryDto;
import jp.co.sesmanager.common.search.exception.SearchHistoryException;

import java.util.List;
import java.util.UUID;

/**
 * 検索履歴を管理するサービスインターフェース
 */
public interface SearchHistoryService {
    
    /**
     * 検索履歴を保存します
     * @param userId ユーザーID
     * @param query 検索クエリ
     * @param resultCount 検索結果件数
     * @return 作成された検索履歴のID
     * @throws SearchHistoryException 履歴保存時のエラー
     */
    UUID saveSearchHistory(UUID userId, SearchQueryDto query, int resultCount) 
        throws SearchHistoryException;
    
    /**
     * 特定のユーザーの検索履歴を取得します
     * @param userId ユーザーID
     * @param limit 取得する最大件数
     * @return 検索履歴DTOのリスト
     * @throws SearchHistoryException 履歴取得時のエラー
     */
    List<SearchHistoryDto> getUserSearchHistory(UUID userId, int limit) 
        throws SearchHistoryException;
    
    /**
     * 特定の検索履歴を削除します
     * @param userId ユーザーID
     * @param historyId 検索履歴ID
     * @throws SearchHistoryException 履歴削除時のエラー
     */
    void deleteSearchHistory(UUID userId, UUID historyId) 
        throws SearchHistoryException;
    
    /**
     * ユーザーの全検索履歴を削除します
     * @param userId ユーザーID
     * @throws SearchHistoryException 履歴削除時のエラー
     */
    void deleteAllSearchHistory(UUID userId) 
        throws SearchHistoryException;
    
    /**
     * 人気の検索キーワードを取得します
     * @param days 集計期間（日数）
     * @param limit 取得する最大件数
     * @return 人気の検索キーワードと件数のマップ
     */
    Map<String, Integer> getPopularSearchKeywords(int days, int limit);
}
```

### 2.3 SavedSearchService

ユーザーが保存した検索条件を管理するためのインターフェースです。

```java
package jp.co.sesmanager.common.search.service;

import jp.co.sesmanager.common.search.dto.SavedSearchDto;
import jp.co.sesmanager.common.search.exception.SavedSearchException;

import java.util.List;
import java.util.UUID;

/**
 * 保存済み検索を管理するサービスインターフェース
 */
public interface SavedSearchService {
    
    /**
     * 保存済み検索を作成します
     * @param savedSearch 保存する検索条件
     * @return 作成された保存済み検索
     * @throws SavedSearchException 検索条件保存時のエラー
     */
    SavedSearchDto createSavedSearch(SavedSearchDto savedSearch) 
        throws SavedSearchException;
    
    /**
     * 保存済み検索を更新します
     * @param id 保存済み検索ID
     * @param savedSearch 更新内容
     * @return 更新された保存済み検索
     * @throws SavedSearchException 検索条件更新時のエラー
     */
    SavedSearchDto updateSavedSearch(UUID id, SavedSearchDto savedSearch) 
        throws SavedSearchException;
    
    /**
     * 保存済み検索を削除します
     * @param id 保存済み検索ID
     * @throws SavedSearchException 検索条件削除時のエラー
     */
    void deleteSavedSearch(UUID id) 
        throws SavedSearchException;
    
    /**
     * 保存済み検索を取得します
     * @param id 保存済み検索ID
     * @return 保存済み検索
     * @throws SavedSearchException 検索条件取得時のエラー
     */
    SavedSearchDto getSavedSearch(UUID id) 
        throws SavedSearchException;
    
    /**
     * ユーザーの保存済み検索一覧を取得します
     * @param userId ユーザーID
     * @return 保存済み検索のリスト
     * @throws SavedSearchException 検索条件取得時のエラー
     */
    List<SavedSearchDto> getUserSavedSearches(UUID userId) 
        throws SavedSearchException;
    
    /**
     * 共有されている保存済み検索一覧を取得します
     * @return 共有されている保存済み検索のリスト
     * @throws SavedSearchException 検索条件取得時のエラー
     */
    List<SavedSearchDto> getSharedSavedSearches() 
        throws SavedSearchException;
}
```

### 2.4 SearchSuggestionService

検索候補を提供するためのインターフェースです。

```java
package jp.co.sesmanager.common.search.service;

import jp.co.sesmanager.common.search.dto.SearchSuggestionDto;
import jp.co.sesmanager.common.search.dto.PopularSearchDto;
import jp.co.sesmanager.common.search.exception.SearchSuggestionException;

import java.util.List;
import java.util.UUID;

/**
 * 検索サジェスト機能を提供するサービスインターフェース
 */
public interface SearchSuggestionService {
    
    /**
     * 検索プレフィックスに基づくサジェストを提供します
     * @param prefix 検索プレフィックス
     * @param suggestionType サジェストのタイプ（null時は全タイプ）
     * @param resourceType リソースタイプ（null時は全タイプ）
     * @param limit 取得する最大件数
     * @return サジェスト候補のリスト
     * @throws SearchSuggestionException サジェスト取得時のエラー
     */
    List<SearchSuggestionDto> getSuggestions(
        String prefix,
        String suggestionType,
        String resourceType,
        int limit
    ) throws SearchSuggestionException;
    
    /**
     * ユーザーの検索履歴に基づくサジェストを提供します
     * @param userId ユーザーID
     * @param prefix 検索プレフィックス
     * @param limit 取得する最大件数
     * @return サジェスト候補のリスト
     * @throws SearchSuggestionException サジェスト取得時のエラー
     */
    List<SearchSuggestionDto> getUserHistorySuggestions(
        UUID userId,
        String prefix,
        int limit
    ) throws SearchSuggestionException;
    
    /**
     * 人気の検索ワードに基づくサジェストを提供します
     * @param period 集計期間（"daily", "weekly", "monthly"）
     * @param limit 取得する最大件数
     * @return 人気の検索のリスト
     * @throws SearchSuggestionException サジェスト取得時のエラー
     */
    List<PopularSearchDto> getPopularSearches(
        String period,
        int limit
    ) throws SearchSuggestionException;
}
```

### 2.5 SearchIndexService

検索インデックスを管理するためのインターフェースです。

```java
package jp.co.sesmanager.common.search.service;

import jp.co.sesmanager.common.search.dto.IndexMetadataDto;
import jp.co.sesmanager.common.search.exception.SearchIndexException;

import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;

/**
 * 検索インデックスを管理するサービスインターフェース
 */
public interface SearchIndexService {
    
    /**
     * 特定のリソースをインデックスに追加または更新します
     * @param resourceType リソースタイプ
     * @param resourceId リソースID
     * @param resourceData インデックス化するデータ
     * @throws SearchIndexException インデックス更新時のエラー
     */
    void indexResource(String resourceType, String resourceId, Map<String, Object> resourceData) 
        throws SearchIndexException;
    
    /**
     * 特定のリソースをインデックスから削除します
     * @param resourceType リソースタイプ
     * @param resourceId リソースID
     * @throws SearchIndexException インデックス削除時のエラー
     */
    void removeFromIndex(String resourceType, String resourceId) 
        throws SearchIndexException;
    
    /**
     * 指定したリソースタイプのインデックスを再構築します
     * @param resourceType リソースタイプ
     * @return インデックス再構築のジョブID
     * @throws SearchIndexException インデックス再構築時のエラー
     */
    UUID rebuildIndex(String resourceType) 
        throws SearchIndexException;
    
    /**
     * インデックス再構築ジョブの状態を取得します
     * @param jobId ジョブID
     * @return 進行状況（0.0〜1.0）
     * @throws SearchIndexException 状態取得時のエラー
     */
    double getIndexingProgress(UUID jobId) 
        throws SearchIndexException;
    
    /**
     * 非同期でインデックスを最適化します
     * @param resourceType リソースタイプ
     * @return 完了を表すFuture
     */
    CompletableFuture<Void> optimizeIndex(String resourceType);
    
    /**
     * 利用可能なすべてのインデックスの情報を取得します
     * @return インデックスメタデータのリスト
     * @throws SearchIndexException メタデータ取得時のエラー
     */
    List<IndexMetadataDto> getIndexMetadata() 
        throws SearchIndexException;
    
    /**
     * 同義語辞書を更新します
     * @param synonyms 同義語マッピング
     * @throws SearchIndexException 同義語辞書更新時のエラー
     */
    void updateSynonyms(Map<String, List<String>> synonyms) 
        throws SearchIndexException;
}
```

## 3. 要求インターフェース

### 3.1 AuthenticationService

認証と権限情報を取得するためのインターフェースです。認証認可モジュールから提供されます。

```java
package jp.co.sesmanager.common.auth.service;

import jp.co.sesmanager.common.auth.model.UserContextInfo;

import java.util.UUID;

/**
 * 認証情報を提供するサービスインターフェース
 */
public interface AuthenticationService {
    
    /**
     * 現在のユーザーコンテキスト情報を取得します
     * @return ユーザーコンテキスト情報
     */
    UserContextInfo getCurrentUserContext();
    
    /**
     * 指定されたユーザーが特定のリソースにアクセスできるかどうかを判定します
     * @param userId ユーザーID
     * @param resourceType リソースタイプ
     * @param resourceId リソースID
     * @param permission 必要な権限
     * @return アクセス可能な場合はtrue
     */
    boolean canAccessResource(UUID userId, String resourceType, String resourceId, String permission);
    
    /**
     * 現在のユーザーが特定のリソースタイプに対する検索権限を持っているかを判定します
     * @param resourceType リソースタイプ
     * @return 検索権限がある場合はtrue
     */
    boolean canSearchResourceType(String resourceType);
    
    /**
     * 指定されたユーザーがアクセス可能なリソースタイプの一覧を取得します
     * @param userId ユーザーID
     * @return アクセス可能なリソースタイプのリスト
     */
    List<String> getAccessibleResourceTypes(UUID userId);
}
```

### 3.2 ResourceDataProvider

各業務モジュールが検索対象データを提供するためのインターフェースです。各業務モジュールはこのインターフェースを実装します。

```java
package jp.co.sesmanager.common.search.service;

import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.function.Consumer;

/**
 * 検索対象データを提供するインターフェース
 * 各業務モジュールが実装します
 */
public interface ResourceDataProvider {
    
    /**
     * このプロバイダーが提供するリソースタイプを返します
     * @return リソースタイプ識別子
     */
    String getResourceType();
    
    /**
     * リソースタイプの表示名を返します
     * @return リソースタイプの表示名
     */
    String getResourceTypeDisplayName();
    
    /**
     * インデックス対象のフィールド情報を提供します
     * @return フィールド名とその型のマッピング
     */
    Map<String, String> getIndexFieldInfo();
    
    /**
     * 全リソースデータをストリーミングで提供します
     * @param dataConsumer データを受け取るコンシューマー
     */
    void streamAllResources(Consumer<Map<String, Object>> dataConsumer);
    
    /**
     * 指定されたIDのリソースデータを取得します
     * @param resourceId リソースID
     * @return リソースデータのマップ
     */
    Map<String, Object> getResourceById(String resourceId);
    
    /**
     * 指定された期間に更新されたリソースIDのリストを取得します
     * @param fromTimestamp 開始タイムスタンプ
     * @param toTimestamp 終了タイムスタンプ
     * @return 更新されたリソースIDのリスト
     */
    List<String> getUpdatedResourceIds(long fromTimestamp, long toTimestamp);
    
    /**
     * 指定されたユーザーがアクセス可能なリソースIDのリストを取得します
     * @param userId ユーザーID
     * @return アクセス可能なリソースIDのリスト
     */
    List<String> getAccessibleResourceIds(UUID userId);
    
    /**
     * リソースのハイライト対象フィールドを返します
     * @return ハイライト対象フィールドのリスト
     */
    List<String> getHighlightFields();
}
```

### 3.3 EntityChangeNotifier

業務エンティティの変更通知を受け取るためのインターフェースです。

```java
package jp.co.sesmanager.common.event;

import java.util.Map;

/**
 * エンティティの変更通知を受け取るインターフェース
 */
public interface EntityChangeNotifier {
    
    /**
     * エンティティ作成イベントを通知します
     * @param entityType エンティティタイプ
     * @param entityId エンティティID
     * @param attributes エンティティの属性
     */
    void notifyCreated(String entityType, String entityId, Map<String, Object> attributes);
    
    /**
     * エンティティ更新イベントを通知します
     * @param entityType エンティティタイプ
     * @param entityId エンティティID
     * @param attributes 更新された属性
     */
    void notifyUpdated(String entityType, String entityId, Map<String, Object> attributes);
    
    /**
     * エンティティ削除イベントを通知します
     * @param entityType エンティティタイプ
     * @param entityId エンティティID
     */
    void notifyDeleted(String entityType, String entityId);
}
```

## 4. データ交換モデル

### 4.1 SearchQueryDto

検索クエリを表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.validation.constraints.Max;
import javax.validation.constraints.Min;
import javax.validation.constraints.NotNull;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SearchQueryDto {
    
    private UUID id;
    
    private String keywordQuery;
    
    private List<String> resourceTypes;
    
    private Map<String, Object> filters;
    
    private String sortField;
    
    private String sortOrder;
    
    @Min(0)
    private Integer page = 0;
    
    @Min(1)
    @Max(100)
    private Integer pageSize = 20;
    
    private Boolean groupByResourceType = false;
    
    private Boolean saveToHistory = false;
}
```

### 4.2 SearchResultDto

検索結果を表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.ZonedDateTime;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SearchResultDto {
    
    private UUID id;
    
    private UUID queryId;
    
    private Long totalHits;
    
    private Long executionTimeMs;
    
    private Map<String, ResourceTypeResultDto> groupedResults;
    
    private List<SearchResultItemDto> items;
    
    private Map<String, List<FacetValueDto>> facets;
    
    private Integer currentPage;
    
    private Integer pageSize;
    
    private Integer totalPages;
    
    private ZonedDateTime timestamp;
}
```

### 4.3 SearchResultItemDto

検索結果の個々のアイテムを表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;
import java.util.Map;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SearchResultItemDto {
    
    private String id;
    
    private String resourceType;
    
    private String title;
    
    private String subtitle;
    
    private String description;
    
    private String url;
    
    private Map<String, List<String>> highlights;
    
    private Map<String, Object> attributes;
    
    private Float score;
}
```

### 4.4 ResourceTypeResultDto

特定のリソースタイプに対する検索結果を表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;
import java.util.Map;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ResourceTypeResultDto {
    
    private String resourceType;
    
    private String displayName;
    
    private Long totalHits;
    
    private List<SearchResultItemDto> items;
    
    private Map<String, List<FacetValueDto>> facets;
}
```

### 4.5 FacetValueDto

検索結果のファセット情報の値を表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class FacetValueDto {
    
    private String value;
    
    private String displayName;
    
    private Integer count;
    
    private Boolean selected;
}
```

### 4.6 SearchHistoryDto

ユーザーの検索履歴を表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.ZonedDateTime;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SearchHistoryDto {
    
    private UUID id;
    
    private UUID userId;
    
    private String keywordQuery;
    
    private List<String> resourceTypes;
    
    private Map<String, Object> filters;
    
    private Integer resultCount;
    
    private ZonedDateTime searchedAt;
}
```

### 4.7 SavedSearchDto

ユーザーが保存した検索条件を表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Size;
import java.time.ZonedDateTime;
import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SavedSearchDto {
    
    private UUID id;
    
    @NotBlank
    @Size(min = 1, max = 50)
    private String name;
    
    @Size(max = 255)
    private String description;
    
    @NotNull
    private UUID userId;
    
    @NotNull
    private SearchQueryDto query;
    
    private Boolean isShared = false;
    
    private ZonedDateTime createdAt;
    
    private ZonedDateTime updatedAt;
}
```

### 4.8 SearchSuggestionDto

検索サジェスト候補を表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SearchSuggestionDto {
    
    private String keyword;
    
    private String type;
    
    private String resourceType;
    
    private Integer frequency;
    
    private String displayText;
}
```

### 4.9 PopularSearchDto

人気の検索キーワードを表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PopularSearchDto {
    
    private String keyword;
    
    private Integer count;
    
    private List<String> resourceTypes;
    
    private String period;
}
```

### 4.10 IndexMetadataDto

検索インデックスのメタデータを表すデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.search.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.ZonedDateTime;
import java.util.Map;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class IndexMetadataDto {
    
    private String name;
    
    private String resourceType;
    
    private Long documentCount;
    
    private Long sizeInBytes;
    
    private ZonedDateTime createdAt;
    
    private ZonedDateTime lastUpdatedAt;
    
    private Map<String, String> fieldTypes;
    
    private String status;
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

#### 5.1.1 応答時間

- **検索API応答時間**:
  - 通常検索: 平均1秒以内、最大3秒
  - キーワード検索: 平均1.5秒以内、最大4秒
  - サジェスト: 平均100ms以内、最大200ms

- **スループット**:
  - ピーク時処理能力: 20 TPS（トランザクション/秒）
  - 通常時処理能力: 5 TPS

#### 5.1.2 リソース利用

- **メモリ使用**:
  - 検索サービス: 最大2GB
  - インデックスサービス: 最大4GB

- **CPU使用**:
  - 検索処理中: 最大4コア
  - インデックス更新中: 最大2コア

#### 5.1.3 キャッシュ戦略

- **検索結果キャッシュ**:
  - 有効期間: 5分
  - 最大エントリ数: 1000
  - キャッシュヒット率目標: 50%以上

- **サジェストキャッシュ**:
  - 有効期間: 1時間
  - 最大エントリ数: 10000

### 5.2 トランザクション要件

#### 5.2.1 検索処理の原子性

- 検索処理自体はトランザクション管理対象外
- 検索履歴・保存済み検索の登録/更新/削除は原子的に実行

#### 5.2.2 インデックス更新の整合性

- リソース変更の検知から5分以内にインデックス反映
- 更新処理の失敗時はリトライキューに登録（3回まで自動リトライ）
- インデックス更新中の検索は更新前のインデックスを使用

#### 5.2.3 権限反映のタイミング

- 権限変更は5分以内に検索結果に反映
- 権限拡大: 即時反映
- 権限縮小: 最大5分の遅延を許容

### 5.3 セキュリティ要件

#### 5.3.1 認証・認可

- 全APIは認証済みユーザーのみアクセス可能
- 検索結果はユーザーの権限に基づきフィルタリング
- 管理者機能（インデックス管理など）は管理者ロールのみアクセス可能

#### 5.3.2 データ保護

- 検索クエリと結果はHTTPS通信で暗号化
- 機密データのインデックス化を回避（パスワード、個人情報など）
- 検索履歴にセンシティブな情報を含めない

#### 5.3.3 監査

- 以下の操作を監査ログに記録
  - 検索履歴の削除
  - 保存済み検索の共有設定変更
  - インデックス再構築
  - 同義語辞書更新

### 5.4 可用性要件

#### 5.4.1 稼働率

- 検索サービス: 99.9%（月間最大43分のダウンタイム）
- インデックス更新: 99.5%（月間最大3.7時間のダウンタイム）

#### 5.4.2 障害対策

- 検索エンジンの冗長化（クラスタ構成）
- インデックス更新の非同期処理化
- 検索サービス障害時もシステムの他機能は継続動作
- インデックス破損時の自動再構築

#### 5.4.3 バックアップ・リカバリ

- インデックスの日次バックアップ
- インデックス復旧時間: 1時間以内
- 検索履歴・保存済み検索のデータは通常のDBバックアップに含める