# 全文検索機能

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2025-05-10 | 設計担当者 | 初版作成 |
| 0.2 | 2025-05-11 | 設計担当者 | 実装コード削除による軽量化 |

## 1. 機能概要

全文検索機能は、SES業務システム全体を横断して検索するための機能です。ユーザーが入力したキーワードをもとに、システム内の様々なリソース（案件、技術者、契約など）から関連する情報を検索し、一元的な検索結果を提供します。

### 1.1 機能の目的

- 単一の検索インターフェースからシステム全体の情報へのアクセスを提供
- 複数のリソースタイプに対する横断的な検索を実現
- キーワードに基づく関連度の高い検索結果の提供
- 検索結果のグループ化と効率的な表示
- 検索キーワードのハイライト表示による視認性向上

### 1.2 主要機能

- キーワードベースの全文検索
- 複数キーワードの組み合わせ（AND, OR, NOT演算子）
- フレーズ検索（引用符で囲まれたテキスト）
- ワイルドカード検索（前方一致、後方一致）
- リソースタイプごとのグループ化表示
- 検索結果のハイライト表示
- 検索結果のスニペット表示（前後コンテキスト）

## 2. 処理フロー

### 2.1 全文検索の基本フロー

```
1. リクエスト受信と検証
   a. 検索キーワードと検索対象リソースタイプの取得
   b. パラメータの妥当性チェック
   c. 検索クエリオブジェクトの構築

2. クエリ前処理
   a. キーワード分析（トークン分割、ストップワード除去）
   b. クエリ拡張（同義語展開、表記ゆれ対応）
   c. アクセス権限フィルタの適用

3. 検索エンジンへのクエリ実行
   a. Elasticsearchクエリの構築
   b. マルチインデックス検索の実行
   c. スコアリングとソート

4. 検索結果の後処理
   a. リソースタイプごとのグループ化
   b. ハイライト処理
   c. スニペット生成
   d. アクセス権限による結果フィルタリング

5. レスポンス生成
   a. ページネーション処理
   b. レスポンスDTOの構築
   c. 検索履歴への保存（オプション）
```

### 2.2 検索クエリ構築フロー

```
1. キーワード解析
   a. スペースで区切られたキーワードの分割
   b. 引用符で囲まれたフレーズの特定
   c. 演算子（AND, OR, NOT）の処理
   d. ワイルドカード記号（*）の処理

2. フィールド重み付け設定
   a. タイトルフィールド（高重み）
   b. サブタイトル、説明フィールド（中重み）
   c. その他フィールド（低重み）

3. クエリ構築
   a. マッチクエリの構築（標準キーワード）
   b. フレーズクエリの構築（フレーズ検索）
   c. プレフィックス/サフィックスクエリの構築（ワイルドカード）
   d. NOT条件のフィルタ追加
   e. AND/OR条件の結合

4. フィルタ追加
   a. リソースタイプフィルタの追加
   b. アクセス権限フィルタの追加
```

### 2.3 検索結果ハイライト処理フロー

```
1. ハイライト対象フィールドの特定
   a. リソースタイプごとのハイライト対象フィールド設定
   b. デフォルトハイライトフィールドの設定

2. ハイライト処理設定
   a. 前後コンテキストのサイズ設定
   b. ハイライトタグの設定
   c. フラグメント数の設定

3. ハイライトの抽出と整形
   a. Elasticsearchハイライト結果の取得
   b. ハイライト結果のMDCフォーマットへの変換
   c. ハイライトスニペットの生成
```

## 3. 主要コンポーネント構成

### 3.1 GlobalSearchService

検索サービスインターフェースを実装するクラスです。

**責務**:
- 検索クエリの受け付けと検証
- 検索エンジンとの連携
- 検索結果の後処理
- 検索履歴の管理

**主要メソッド**:
- search(SearchQueryDto): 検索クエリに基づき検索を実行
- globalSearch(keyword, resourceTypes, page, pageSize): キーワードによるグローバル検索
- filterSearch(resourceType, filters, sortField, sortOrder, page, pageSize): フィルタ条件による検索
- searchAsync(SearchQueryDto): 非同期検索の実行
- getSearchStatus(searchId): 非同期検索のステータス確認
- cancelSearch(searchId): 非同期検索のキャンセル

### 3.2 SearchQueryBuilder

Elasticsearchクエリを構築するためのクラスです。

**責務**:
- 検索クエリの構築
- キーワード解析
- フィールド重み付けの適用
- フィルタ条件の構築
- 同義語展開の連携

**主要メソッド**:
- buildSearchQuery(SearchQueryDto): 検索クエリの構築
- buildKeywordQuery(BoolQuery, keyword): キーワード検索の構築
- processAndOrConditions(BoolQuery, text): AND/OR条件の処理
- processNotConditions(BoolQuery, text): NOT条件の処理
- addFilterConditions(BoolQuery, filters): フィルタ条件の追加
- buildSortCriteria(sortField, sortDirection): ソート条件の構築

### 3.3 SearchResultProcessor

検索結果を処理するためのクラスです。

**責務**:
- 検索結果の処理
- ハイライト情報の抽出
- 検索結果のグループ化
- レスポンスDTOの生成

**主要メソッド**:
- processSearchResponse(SearchResponse, SearchQueryDto): 検索レスポンスの処理
- convertSearchHits(SearchHits): 検索ヒットの変換
- processHighlights(HighlightFields): ハイライト情報の処理
- groupResultsByResourceType(items): リソースタイプごとの結果グループ化

### 3.4 SynonymExpandService

同義語拡張サービスのクラスです。

**責務**:
- 検索キーワードの同義語展開
- 表記ゆれ対応
- 用語の標準化

**主要メソッド**:
- expandSynonyms(text): テキストの同義語を展開
- tokenize(text): テキストをトークンに分割

## 4. データモデル

### 4.1 検索クエリDTO

```
SearchQueryDto {
    id: UUID                    // クエリID
    keywordQuery: String        // 検索キーワード
    resourceTypes: List<String> // 検索対象リソースタイプ
    filters: Map<String, Object> // フィルタ条件
    sortField: String           // ソートフィールド
    sortOrder: String           // ソート順序（asc/desc）
    page: int                   // ページ番号
    pageSize: int               // ページサイズ
    groupByResourceType: boolean // リソースタイプごとにグループ化するかどうか
    saveToHistory: boolean      // 検索履歴に保存するかどうか
}
```

### 4.2 検索結果DTO

```
SearchResultDto {
    id: UUID                    // 結果ID
    queryId: UUID               // クエリID
    totalHits: long             // 総ヒット数
    executionTimeMs: long       // 実行時間（ミリ秒）
    items: List<SearchResultItemDto> // 検索結果アイテム（グループ化しない場合）
    groupedResults: Map<String, ResourceTypeResultDto> // グループ化された結果
    currentPage: int            // 現在のページ
    pageSize: int               // ページサイズ
    totalPages: int             // 総ページ数
    timestamp: ZonedDateTime    // 検索実行時刻
}
```

### 4.3 検索結果アイテムDTO

```
SearchResultItemDto {
    id: String                  // アイテムID
    resourceType: String        // リソースタイプ
    title: String               // タイトル
    subtitle: String            // サブタイトル
    description: String         // 説明
    url: String                 // URL
    highlights: Map<String, List<String>> // ハイライト情報
    attributes: Map<String, Object> // 追加属性
    score: float                // スコア
}
```

### 4.4 リソースタイプ結果DTO

```
ResourceTypeResultDto {
    resourceType: String        // リソースタイプ
    displayName: String         // 表示名
    totalHits: long             // 総ヒット数
    items: List<SearchResultItemDto> // 検索結果アイテム
    facets: Map<String, List<FacetValueDto>> // ファセット情報
}
```

## 5. クライアントインターフェース

### 5.1 REST API

全文検索機能を提供するREST APIの仕様は以下の通りです。

#### 検索クエリ実行 (POST /api/v1/common/search)

**リクエスト**:
- Content-Type: application/json
- Body: SearchQueryDto

**レスポンス**:
- 200 OK: SearchResultDto
- 400 Bad Request: エラーレスポンス（不正なクエリ）
- 401 Unauthorized: エラーレスポンス（認証エラー）
- 403 Forbidden: エラーレスポンス（権限エラー）
- 500 Internal Server Error: エラーレスポンス（サーバーエラー）

#### グローバル検索 (GET /api/v1/common/search/global)

**リクエストパラメータ**:
- keyword (必須): 検索キーワード
- types (オプション): リソースタイプ（カンマ区切り）
- page (デフォルト: 0): ページ番号
- size (デフォルト: 20): ページサイズ

**レスポンス**:
- 200 OK: SearchResultDto
- 400 Bad Request: エラーレスポンス（不正なパラメータ）
- 401 Unauthorized: エラーレスポンス（認証エラー）
- 403 Forbidden: エラーレスポンス（権限エラー）
- 500 Internal Server Error: エラーレスポンス（サーバーエラー）

### 5.2 検索UIコンポーネント

フロントエンドの検索コンポーネントの基本構成です。

**機能**:
- キーワード入力フォーム
- 検索結果の表示（グループ別）
- ハイライト表示
- 「もっと見る」リンク
- 全検索結果へのリンク

**振る舞い**:
- キーワード入力時に自動検索（デバウンス処理）
- 検索結果をリソースタイプごとに表示
- 検索ハイライトの表示
- 検索結果アイテムのクリックで詳細表示
- 検索履歴の自動保存

## 6. 例外処理

### 6.1 SearchException

検索処理中の例外を表すクラスです。

**属性**:
- message: 例外メッセージ
- errorCode: エラーコード
- cause: 原因となる例外（オプション）

**主要エラーコード**:
- INVALID_QUERY: 不正なクエリ
- INVALID_RESOURCE_TYPE: 不正なリソースタイプ
- SEARCH_TIMEOUT: 検索タイムアウト
- RESOURCE_NOT_FOUND: リソースが見つからない
- PERMISSION_DENIED: 権限エラー

### 6.2 例外ハンドリング

検索例外のハンドリング方針は以下の通りです。

- INVALID_QUERY, INVALID_RESOURCE_TYPE: 400 Bad Request
- SEARCH_TIMEOUT: 408 Request Timeout
- RESOURCE_NOT_FOUND: 404 Not Found
- PERMISSION_DENIED: 403 Forbidden
- その他の例外: 500 Internal Server Error

## 7. パフォーマンス最適化

### 7.1 検索結果キャッシュ

頻繁に実行される検索のキャッシュを管理する方針です。

**キャッシュ対象**:
- キーワードクエリが3文字以上の検索
- 結果件数が5件以上の検索

**キャッシュキー生成**:
- キーワードクエリ
- リソースタイプ
- フィルタキー
- ページ情報
- グループ化フラグ

**キャッシュ有効期限**:
- 短時間（5〜15分程度）
- マスタデータ更新時に無効化

### 7.2 非同期検索処理

時間のかかる検索を非同期で実行する仕組みです。

**処理フロー**:
1. 検索リクエスト受信
2. ジョブID発行
3. 非同期処理開始
4. ジョブステータス管理
5. ポーリングによるステータス取得
6. 結果取得
7. 古いジョブの自動クリーンアップ

**ジョブステータス**:
- PENDING: 待機中
- RUNNING: 実行中
- COMPLETED: 完了
- FAILED: 失敗
- CANCELLED: キャンセル済み

## 8. テスト方針

### 8.1 単体テスト

全文検索機能の単体テストは以下の観点で実施します：

- **SearchQueryBuilderのテスト**：
  - キーワード解析の正確性
  - クエリ構築の正確性
  - フィルタ条件の適用
  - 権限フィルタの適用

- **SearchResultProcessorのテスト**：
  - 検索結果の変換処理
  - ハイライト処理
  - グループ化処理

- **SynonymExpandServiceのテスト**：
  - 同義語展開の正確性
  - 空文字列や無効な入力の処理

### 8.2 統合テスト

全文検索機能の統合テストは以下の観点で実施します：

- **検索実行フロー全体のテスト**：
  - 検索クエリから結果取得までの一連の流れ
  - 実際のElasticsearchインスタンスとの連携
  - キャッシング機能の動作確認

- **権限制御との連携テスト**：
  - 適切なアクセス制御が適用されることの確認
  - 異なる権限を持つユーザーでの検索結果の違い

- **非同期検索処理のテスト**：
  - 長時間検索の非同期実行
  - ステータス取得と結果取得の整合性

### 8.3 パフォーマンステスト

全文検索機能のパフォーマンステストは以下の観点で実施します：

- **応答時間測定**：
  - さまざまな検索条件での応答時間測定
  - 結果サイズによる応答時間の変化

- **スループットテスト**：
  - 同時実行数を変えた場合のスループット測定
  - キャッシュ効果の測定

- **大量データでのテスト**：
  - 実運用規模のデータ量での検索性能測定
  - インデックスサイズと検索性能の関係分析