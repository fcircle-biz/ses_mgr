# 認可機能 詳細設計

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2025-05-10 | 設計担当者 | 初版作成 |
| 0.2 | 2025-05-11 | 設計担当者 | 実装コード削除による軽量化 |

## 1. 概要

### 1.1 目的
認可機能は、SES業務システムにおけるユーザーのアクセス制御を担当するモジュールです。本モジュールは、各ユーザーがどのリソースにどのようなアクションを実行できるかを判定し、システム全体のセキュリティポリシーを一貫して適用することを目的としています。

### 1.2 機能範囲
- ロールベースアクセス制御（RBAC）
- 属性ベースアクセス制御（ABAC）
- リソースレベルの権限管理
- アクションレベルの権限管理
- 動的ポリシー評価
- データフィルタリング
- 管理者向け権限管理インターフェース

### 1.3 関連モジュール
- 認証モジュール：ユーザーの認証情報を取得
- ユーザー管理モジュール：ユーザー情報の取得
- ロギングモジュール：権限チェックの監査ログ記録

## 2. コンポーネント構成

### 2.1 コントローラー

#### RoleController
- **責務**：ロール管理のRESTエンドポイントを提供
- **エンドポイント**：
  - GET /api/v1/admin/roles：ロール一覧取得
  - GET /api/v1/admin/roles/{id}：ロール詳細取得
  - POST /api/v1/admin/roles：ロール作成
  - PUT /api/v1/admin/roles/{id}：ロール更新
  - DELETE /api/v1/admin/roles/{id}：ロール削除
  - GET /api/v1/admin/roles/{id}/permissions：ロールの権限取得
  - PUT /api/v1/admin/roles/{id}/permissions：ロールの権限更新

#### 主要メソッド
- **getAllRoles**：全てのロールを取得
- **createRole**：ロールを作成
- **updateRolePermissions**：ロールの権限を更新
- **getRole**：ロール詳細を取得
- **updateRole**：ロールを更新
- **deleteRole**：ロールを削除
- **getRolePermissions**：ロールの権限一覧を取得

#### PermissionController
- **責務**：権限管理のRESTエンドポイントを提供
- **エンドポイント**：
  - GET /api/v1/admin/permissions：権限一覧取得
  - GET /api/v1/admin/permissions/{id}：権限詳細取得
  - POST /api/v1/admin/permissions：権限作成
  - PUT /api/v1/admin/permissions/{id}：権限更新
  - DELETE /api/v1/admin/permissions/{id}：権限削除

### 2.2 サービス

#### AuthorizationService
- **責務**：認可ロジックの実装、AuthorizationServiceインターフェースの実装
- **主要メソッド**：
  - hasPermission：ユーザーの権限チェック
  - isAllowed：リソースアクセス権限チェック
  - hasRole：ロール所有チェック
  - getUserPermissions：ユーザーの権限取得
  - evaluateAccess：属性ベースのアクセス制御評価

#### PolicyEvaluator
- **責務**：ポリシーベースのアクセス制御評価
- **主要メソッド**：
  - evaluate：アクセスポリシーの評価
  - loadPolicies：ポリシーの読み込み
  - evaluateCondition：条件式の評価

#### RoleService
- **責務**：ロール管理ロジックの実装
- **主要メソッド**：
  - createRole：ロール作成
  - updateRole：ロール更新
  - deleteRole：ロール削除
  - getRoleById：ロール取得
  - getAllRoles：全ロール取得
  - assignPermissionsToRole：ロールへの権限割り当て
  - getRolePermissions：ロールの権限を取得

### 2.3 リポジトリ

#### RoleRepository
- **責務**：ロールエンティティのデータアクセス
- **主要メソッド**：
  - findById：IDによるロール検索
  - findByName：名前によるロール検索
  - existsByName：ロール名の存在確認
  - save：ロール保存
  - findAllOrderByName：全ロールの名前順取得

#### PermissionRepository
- **責務**：権限エンティティのデータアクセス
- **主要メソッド**：
  - findById：IDによる権限検索
  - findByName：名前による権限検索
  - findByRoleId：ロールIDによる権限検索
  - findByResourceTypeAndAction：リソースタイプとアクションによる権限検索

#### PolicyRepository
- **責務**：ポリシーエンティティのデータアクセス
- **主要メソッド**：
  - findByResourceTypeAndActionOrderByPriorityDesc：リソースタイプとアクションによるポリシー検索
  - findByPriorityGreaterThanOrderByPriorityAsc：優先度によるポリシー検索

### 2.4 データモデル

#### Role
- ロールを表すエンティティ
- **属性**：
  - id：ロールID (UUID)
  - name：ロール名 (String)
  - description：説明 (String)
  - createdAt：作成日時 (LocalDateTime)
  - updatedAt：更新日時 (LocalDateTime)

#### Permission
- 権限を表すエンティティ
- **属性**：
  - id：権限ID (UUID)
  - name：権限名 (String)
  - description：説明 (String)
  - resourceType：リソース種別 (String)
  - action：アクション (String)
  - createdAt：作成日時 (LocalDateTime)
  - updatedAt：更新日時 (LocalDateTime)

#### RolePermission
- ロールと権限の多対多関連を表すエンティティ
- **属性**：
  - roleId：ロールID (UUID)
  - permissionId：権限ID (UUID)
  - createdAt：作成日時 (LocalDateTime)

#### Policy
- アクセスポリシーを表すエンティティ
- **属性**：
  - id：ポリシーID (UUID)
  - name：ポリシー名 (String)
  - description：説明 (String)
  - resourceType：リソース種別 (String)
  - action：アクション (String)
  - effect：効果（許可/拒否） (String)
  - priority：優先度 (int)
  - condition：条件式 (String)
  - createdAt：作成日時 (LocalDateTime)
  - updatedAt：更新日時 (LocalDateTime)

## 3. 主要処理フロー

### 3.1 認可チェックフロー

1. クライアントがリソースに対するアクセスをリクエスト
2. JwtAuthenticationFilterが認証情報を抽出・設定
3. API/メソッドレベルで@PreAuthorizeアノテーションによる権限チェック
4. BusinessServiceクラスが必要に応じてAuthorizationServiceを呼び出し
5. AuthorizationServiceがユーザーの権限をチェック
6. ポリシーに基づいてアクセス可否を判定
7. 判定結果を監査ログに記録
8. アクセス可の場合は処理を続行、アクセス拒否の場合は例外をスロー

```
sequenceDiagram
    Client->>Controller: APIリクエスト
    Controller->>SecurityInterceptor: 処理
    SecurityInterceptor->>@PreAuthorize: 評価
    @PreAuthorize->>AuthorizationService: hasPermission(userId, permission)
    
    AuthorizationService->>CacheManager: 権限キャッシュ取得
    
    alt キャッシュHit
        CacheManager-->>AuthorizationService: キャッシュデータ
    else キャッシュMiss
        AuthorizationService->>UserRepository: findById(userId)
        UserRepository-->>AuthorizationService: User
        
        AuthorizationService->>RoleRepository: findById(user.getRoleId())
        RoleRepository-->>AuthorizationService: Role
        
        AuthorizationService->>PermissionRepository: findByRoleId(roleId)
        PermissionRepository-->>AuthorizationService: Permissions
        
        AuthorizationService->>CacheManager: 権限をキャッシュ
    end
    
    AuthorizationService->>AuthorizationService: 権限チェック
    AuthorizationService->>AuditLogService: logAuthorizationEvent()
    
    alt 権限あり
        AuthorizationService-->>@PreAuthorize: true
        @PreAuthorize-->>SecurityInterceptor: アクセス許可
        SecurityInterceptor-->>Controller: 処理継続
        Controller-->>Client: 200 OK + リソース
    else 権限なし
        AuthorizationService-->>@PreAuthorize: false
        @PreAuthorize-->>SecurityInterceptor: アクセス拒否
        SecurityInterceptor-->>Client: 403 Forbidden
    end
```

### 3.2 ポリシー評価フロー

1. AuthorizationServiceが属性ベースのアクセス制御を要求
2. 主体（ユーザー）、リソース、アクション、環境情報を取得・構築
3. PolicyEvaluatorに評価を依頼
4. 適用可能なポリシーをデータベースから取得
5. 優先度順にポリシーを評価
6. 条件式をExpressionEngineで評価
7. 条件に合致する最初のポリシーの効果（許可/拒否）を適用
8. 評価結果を返却

```
sequenceDiagram
    AuthorizationService->>PolicyEvaluator: evaluate(subject, resource, action, environment)
    PolicyEvaluator->>PolicyRepository: findByResourceTypeAndActionOrderByPriorityDesc()
    PolicyRepository-->>PolicyEvaluator: List<Policy>
    
    PolicyEvaluator->>PolicyEvaluator: 評価コンテキスト準備
    
    loop 各ポリシーを優先度順に評価
        PolicyEvaluator->>ExpressionEngine: evaluateCondition(condition, context)
        ExpressionEngine-->>PolicyEvaluator: 条件評価結果
        
        alt 条件に合致
            PolicyEvaluator-->>AuthorizationService: ポリシーの効果（許可/拒否）
        end
    end
    
    alt 合致するポリシーがない
        PolicyEvaluator-->>AuthorizationService: デフォルト結果（拒否）
    end
    
    AuthorizationService->>AuditLogService: logAuthorizationEvent()
```

### 3.3 ロール・権限管理フロー

1. 管理者がロール管理APIを呼び出し
2. RoleControllerがリクエストを受け取る
3. RoleServiceがロール情報を検証・処理
4. 操作結果を監査ログに記録
5. 必要に応じてキャッシュを無効化
6. 結果をクライアントに返却

```
sequenceDiagram
    Client->>RoleController: POST /api/v1/admin/roles
    RoleController->>RoleService: createRole(request)
    
    RoleService->>RoleRepository: existsByName(name)
    RoleRepository-->>RoleService: boolean
    
    alt 名前重複
        RoleService-->>RoleController: throw DuplicateResourceException
        RoleController-->>Client: 409 Conflict
    else 名前OK
        RoleService->>RoleRepository: save(role)
        RoleRepository-->>RoleService: savedRole
        
        alt 権限指定あり
            RoleService->>PermissionRepository: findAllById(permissionIds)
            PermissionRepository-->>RoleService: permissions
            
            RoleService->>RolePermissionRepository: saveAll(rolePermissions)
        end
        
        RoleService-->>RoleController: Role
        RoleController->>AuditLogService: log()
        RoleController-->>Client: 201 Created + Role
    end
```

### 3.4 権限キャッシュ更新フロー

1. ロールに対する権限変更が発生
2. RoleServiceがロールへの権限割り当てを処理
3. 既存の権限関連を削除
4. 新しい権限関連を保存
5. このロールを持つすべてのユーザーの権限キャッシュを無効化
6. 必要に応じてロールキャッシュも無効化

```
sequenceDiagram
    Client->>RoleController: PUT /api/v1/admin/roles/{id}/permissions
    RoleController->>RoleService: assignPermissionsToRole(id, permissionIds)
    
    RoleService->>RoleRepository: findById(roleId)
    RoleRepository-->>RoleService: Role
    
    RoleService->>PermissionRepository: findAllById(permissionIds)
    PermissionRepository-->>RoleService: List<Permission>
    
    RoleService->>RolePermissionRepository: deleteByRoleId(roleId)
    RoleService->>RolePermissionRepository: saveAll(rolePermissions)
    
    RoleService->>UserRepository: findByRoleId(roleId)
    UserRepository-->>RoleService: List<User>
    
    loop 各ユーザーのキャッシュ無効化
        RoleService->>CacheManager: userPermissionsCache.evict(userId)
    end
    
    RoleService->>CacheManager: roleCache.evict(roleId)
    
    RoleService-->>RoleController: 完了
    RoleController->>AuditLogService: log()
    RoleController-->>Client: 204 No Content
```

## 4. 例外処理

### 4.1 認可例外階層

認可機能では、以下の例外階層を定義します：

- **AuthorizationException**：認可関連の基底例外クラス
  - errorCode：エラーコードを保持

- **エラーコード**：
  - ACCESS_DENIED：アクセス拒否
  - INSUFFICIENT_PRIVILEGES：権限不足
  - INVALID_ROLE：無効ロール
  - RESOURCE_ACCESS_DENIED：リソースアクセス拒否
  - POLICY_EVALUATION_ERROR：ポリシー評価エラー

### 4.2 グローバル例外ハンドラー

例外発生時の処理として、以下のように各種認可例外に対応するエラーレスポンスを生成します：

- ACCESS_DENIED、INSUFFICIENT_PRIVILEGES、RESOURCE_ACCESS_DENIED：403 Forbidden
- INVALID_ROLE：400 Bad Request
- POLICY_EVALUATION_ERROR：500 Internal Server Error

## 5. セキュリティ対策

### 5.1 権限管理のセキュリティ

- **最小権限の原則**: ユーザーには職務遂行に必要な最小限の権限のみを付与
- **職務分掌原則**: 不正行為防止のため、重要な操作の権限を適切に分離
- **権限変更監査**: すべての権限変更を監査ログに記録し、追跡可能にする
- **権限管理者の制限**: 権限管理機能へのアクセスを厳密に制限

### 5.2 認可ポリシーのセキュリティ

- **デフォルト拒否**: 明示的に許可されていないアクセスはすべて拒否（Deny by default）
- **多層防御**: アプリケーション層、サービス層、データアクセス層での認可チェック
- **動的ポリシー評価**: コンテキスト（時間、場所など）に基づく柔軟なアクセス制御
- **ポリシー変更監査**: ポリシー変更の全履歴を記録・追跡

### 5.3 実装上のセキュリティ

- **権限チェック抜け防止**: AOP（アスペクト指向プログラミング）による権限チェックの強制
- **サイドチャネル攻撃対策**: 認可判定の処理時間が権限情報を漏らさないよう配慮
- **権限情報の漏洩防止**: エラーメッセージによる権限情報の漏洩を防止
- **認可バイパス対策**: フロントエンド・バックエンド両方での一貫した認可チェック

## 6. 特記事項

### 6.1 実装上の注意点

- **パフォーマンスと権限更新の即時反映のバランス**: キャッシュの適切な管理が重要
- **ポリシー設計の簡潔性**: 複雑すぎるポリシーは管理・デバッグが困難になる
- **権限設計の粒度**: 細かすぎる権限設計は管理コストを増大させる
- **スコープベースの権限設計**: リソース所有者や部署に基づくスコープ制限の実装

### 6.2 パフォーマンス考慮点

- **権限キャッシュ**: ユーザー権限をキャッシュしてデータベースアクセスを削減
- **ポリシー評価の最適化**: 頻繁に使用されるポリシーを優先的に評価
- **バッチ権限チェック**: 複数リソースの権限を一括でチェックする機能
- **クエリの最適化**: 権限・ロール・ポリシーに関するデータベースクエリの最適化

### 6.3 テストの観点

- **認可ルールの単体テスト**: 各認可ルールの正確性を個別にテスト
- **ポリシー評価の単体テスト**: ポリシー評価エンジンの正確性をテスト
- **権限管理機能の統合テスト**: ロール・権限管理APIの一貫性テスト
- **セキュリティテスト**: 認可バイパス攻撃に対する耐性テスト

## 7. 参照情報

- [Spring Security Authorization Documentation](https://docs.spring.io/spring-security/reference/servlet/authorization/index.html)
- [OWASP Authorization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authorization_Cheat_Sheet.html)
- [NIST Guide to Attribute Based Access Control (ABAC)](https://nvlpubs.nist.gov/nistpubs/specialpublications/NIST.sp.800-162.pdf)
- [XACML (eXtensible Access Control Markup Language)](https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=xacml)