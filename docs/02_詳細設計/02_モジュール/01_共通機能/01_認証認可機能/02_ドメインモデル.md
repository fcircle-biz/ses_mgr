# 認証認可機能 ドメインモデル

## 1. エンティティ

### 1.1 User（ユーザー）

ユーザーエンティティは、システムにアクセスする個人を表します。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|--------|------|--------|-------|
| id | UUID | 一意識別子 | PK、自動生成 |
| email | String | メールアドレス | 必須、一意制約、メール形式 |
| passwordHash | String | パスワードハッシュ | 必須、BCryptでハッシュ化 |
| name | String | 氏名 | 必須、最大100文字 |
| department | String | 所属部署 | 任意、最大100文字 |
| position | String | 役職 | 任意、最大100文字 |
| phone | String | 電話番号 | 任意、電話番号形式 |
| roleId | UUID | ロールID | 必須、FK->Role |
| lastLoginAt | LocalDateTime | 最終ログイン日時 | 任意 |
| mfaEnabled | Boolean | 多要素認証有効フラグ | 必須、デフォルトはfalse |
| mfaSecret | String | 多要素認証シークレット | 任意、暗号化して保存 |
| accountLocked | Boolean | アカウントロックフラグ | 必須、デフォルトはfalse |
| accountExpiresAt | LocalDateTime | アカウント有効期限 | 任意 |
| passwordExpiresAt | LocalDateTime | パスワード有効期限 | 必須 |
| createdAt | LocalDateTime | 作成日時 | 必須、自動設定 |
| updatedAt | LocalDateTime | 更新日時 | 必須、自動更新 |

#### ビジネスルール

- パスワードは直接保存せず、必ずBCryptでハッシュ化して保存する
- パスワード有効期限は作成・変更時から90日間
- 管理者アカウントは必ず多要素認証を有効にする必要がある
- 5回連続のログイン失敗でアカウントをロックする

### 1.2 Role（ロール）

ロールエンティティは、ユーザーに割り当てられる役割を表します。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|--------|------|--------|-------|
| id | UUID | 一意識別子 | PK、自動生成 |
| name | String | ロール名 | 必須、一意制約、最大50文字 |
| description | String | 説明 | 任意、最大255文字 |
| createdAt | LocalDateTime | 作成日時 | 必須、自動設定 |
| updatedAt | LocalDateTime | 更新日時 | 必須、自動更新 |

#### ビジネスルール

- システム初期化時に、基本ロール（ADMIN、USER等）を作成する
- ロールの削除は、そのロールを持つユーザーが存在しない場合のみ許可する

### 1.3 Permission（権限）

権限エンティティは、特定の操作や機能へのアクセス権を表します。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|--------|------|--------|-------|
| id | UUID | 一意識別子 | PK、自動生成 |
| name | String | 権限名 | 必須、一意制約、最大100文字 |
| description | String | 説明 | 任意、最大255文字 |
| resourceType | String | リソース種別 | 必須、最大50文字 |
| action | String | アクション種別 | 必須、最大50文字 |
| createdAt | LocalDateTime | 作成日時 | 必須、自動設定 |
| updatedAt | LocalDateTime | 更新日時 | 必須、自動更新 |

#### ビジネスルール

- 権限名は「リソース種別:アクション」の形式で構成する（例：「user:read」）
- システム初期化時に、基本権限を作成する

### 1.4 RolePermission（ロール権限関連）

ロールと権限の多対多関連を表します。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|--------|------|--------|-------|
| roleId | UUID | ロールID | PK、FK->Role |
| permissionId | UUID | 権限ID | PK、FK->Permission |
| createdAt | LocalDateTime | 作成日時 | 必須、自動設定 |

### 1.5 RefreshToken（リフレッシュトークン）

リフレッシュトークンエンティティは、アクセストークンの再取得に使用されるトークンを表します。

#### 属性

| 属性名 | 型 | 説明 | 制約 |
|--------|------|--------|-------|
| id | UUID | 一意識別子 | PK、自動生成 |
| userId | UUID | ユーザーID | 必須、FK->User |
| tokenHash | String | トークンハッシュ | 必須 |
| expiresAt | LocalDateTime | 有効期限 | 必須 |
| createdAt | LocalDateTime | 作成日時 | 必須、自動設定 |
| revoked | Boolean | 無効化フラグ | 必須、デフォルトはfalse |
| revokedAt | LocalDateTime | 無効化日時 | 任意 |

#### ビジネスルール

- リフレッシュトークンの有効期限は、通常2週間
- 「ログイン状態を保持する」オプションが選択された場合は、30日間
- ユーザーがログアウトした場合、関連するすべてのリフレッシュトークンを無効化する

## 2. 値オブジェクト

### 2.1 Credentials（認証情報）

ユーザーのログイン時の認証情報を表します。

#### 属性

| 属性名 | 型 | 説明 |
|--------|------|--------|
| email | String | メールアドレス |
| password | String | パスワード |
| rememberMe | Boolean | ログイン状態保持フラグ |

### 2.2 PasswordPolicy（パスワードポリシー）

パスワード強度や有効期限などのポリシーを表します。

#### 属性

| 属性名 | 型 | 説明 |
|--------|------|--------|
| minLength | int | 最小文字数 |
| requireUpperCase | Boolean | 大文字必須フラグ |
| requireLowerCase | Boolean | 小文字必須フラグ |
| requireDigit | Boolean | 数字必須フラグ |
| requireSpecialChar | Boolean | 特殊文字必須フラグ |
| historyCount | int | 履歴チェック数 |
| expiryDays | int | 有効期限（日数） |

### 2.3 Token（トークン）

JWTトークンのペイロード情報を表します。

#### 属性

| 属性名 | 型 | 説明 |
|--------|------|--------|
| sub | String | 対象（ユーザーID） |
| iat | long | 発行時刻 |
| exp | long | 有効期限 |
| roles | List\<String\> | ロール一覧 |
| permissions | List\<String\> | 権限一覧 |

## 3. 列挙型

### 3.1 AuthenticationMethod（認証方式）

```java
public enum AuthenticationMethod {
    PASSWORD,  // パスワード認証
    MFA_EMAIL, // メール多要素認証
    MFA_APP,   // アプリ多要素認証
    MFA_SMS    // SMS多要素認証
}
```

### 3.2 ResourceType（リソース種別）

```java
public enum ResourceType {
    USER,       // ユーザー
    ROLE,       // ロール
    PERMISSION, // 権限
    ENGINEER,   // 技術者
    PROJECT,    // 案件
    CONTRACT,   // 契約
    INVOICE,    // 請求
    TIMESHEET,  // 勤怠
    REPORT      // レポート
}
```

### 3.3 ActionType（アクション種別）

```java
public enum ActionType {
    CREATE, // 作成
    READ,   // 読取
    UPDATE, // 更新
    DELETE, // 削除
    APPROVE,// 承認
    REJECT, // 却下
    EXPORT, // エクスポート
    IMPORT  // インポート
}
```

## 4. ドメイン関連図

```
User (1) --- (*) RefreshToken
User (*) --- (1) Role
Role (*) --- (*) Permission (through RolePermission)
```

## 5. 重要なビジネスルール

1. **最小権限の原則**：ユーザーには職務遂行に必要な最小限の権限のみ付与する

2. **職務分掌**：特定の重要操作（例：請求書承認と支払処理）は単一ユーザーが行えないよう、適切なロール分割を行う

3. **管理者特権**：システム管理者権限は限定的かつ監査可能な形で付与し、多要素認証を必須とする

4. **監査証跡**：認証・認可に関連するすべての重要操作は監査ログに記録する

5. **トークン管理**：JWTの有効期限を短く設定し、頻繁な再認証を行う。リフレッシュトークンは安全に保管し、ログアウト時には確実に無効化する

6. **認可チェックの多層化**：アプリケーション層、API層、データアクセス層の各レベルで権限チェックを行い、一貫した認可を実施する