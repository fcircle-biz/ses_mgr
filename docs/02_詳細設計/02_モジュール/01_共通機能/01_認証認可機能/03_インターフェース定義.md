# 認証認可機能 インターフェース定義

## 1. インターフェース概要

認証認可機能は、SES業務システム全体のセキュリティを担保するための中核的なインターフェースを提供します。本モジュールは、ユーザー認証、セッション管理、アクセス制御などの機能を他のモジュールに提供し、システム全体のセキュリティを一元管理します。

## 2. 提供インターフェース

認証認可機能が他のモジュールに提供するインターフェースは以下の通りです。

### 2.1 AuthenticationService

**目的**: ユーザー認証とセッション管理の機能を提供するインターフェース

**責務**: 
- ユーザー認証の実行
- トークンの発行・検証
- セッション管理
- 多要素認証の制御

#### メソッド一覧

```java
public interface AuthenticationService {
    /**
     * ユーザー認証を行い、認証成功時にJWTトークンを発行する
     * @param credentials ユーザー認証情報
     * @return 認証トークン（アクセストークンとリフレッシュトークン）
     * @throws AuthenticationException 認証失敗時
     */
    TokenResponse authenticate(Credentials credentials);
    
    /**
     * リフレッシュトークンを使用して新しいアクセストークンを取得する
     * @param refreshToken リフレッシュトークン
     * @return 新しい認証トークン
     * @throws AuthenticationException トークンが無効または期限切れの場合
     */
    TokenResponse refreshToken(String refreshToken);
    
    /**
     * ユーザーのセッションを無効化する（ログアウト）
     * @param userId ユーザーID
     * @param refreshToken リフレッシュトークン
     */
    void logout(UUID userId, String refreshToken);
    
    /**
     * 全てのセッションを無効化する（強制ログアウト）
     * @param userId ユーザーID
     */
    void logoutAll(UUID userId);
    
    /**
     * トークンを検証し、UserPrincipalを取得する
     * @param token JWTトークン
     * @return ユーザープリンシパル
     * @throws AuthenticationException トークンが無効な場合
     */
    UserPrincipal validateToken(String token);
    
    /**
     * 多要素認証コードを検証する
     * @param userId ユーザーID
     * @param code 検証コード
     * @return 検証結果
     */
    boolean verifyMfaCode(UUID userId, String code);
    
    /**
     * 多要素認証を設定する
     * @param userId ユーザーID
     * @param method 認証方式
     * @return 設定情報（QRコードや確認コードなど）
     */
    MfaSetupResponse setupMfa(UUID userId, AuthenticationMethod method);
}
```

#### データモデル

```java
// 認証リクエスト
public class Credentials {
    private String email;
    private String password;
    private boolean rememberMe;
}

// トークンレスポンス
public class TokenResponse {
    private String accessToken;
    private String refreshToken;
    private Date expiresAt;
    private boolean requiresMfa;
}

// ユーザープリンシパル
public class UserPrincipal {
    private UUID userId;
    private String email;
    private String name;
    private List<String> roles;
    private List<String> permissions;
}

// 多要素認証設定レスポンス
public class MfaSetupResponse {
    private String secretKey;
    private String qrCodeUrl;
    private List<String> recoveryCodes;
}
```

#### 例外

```java
// 認証例外
public class AuthenticationException extends RuntimeException {
    private AuthenticationErrorCode errorCode;
}

// 認証エラーコード
public enum AuthenticationErrorCode {
    INVALID_CREDENTIALS,
    ACCOUNT_LOCKED,
    ACCOUNT_EXPIRED,
    PASSWORD_EXPIRED,
    MFA_REQUIRED,
    INVALID_TOKEN,
    TOKEN_EXPIRED
}
```

### 2.2 AuthorizationService

**目的**: 権限チェックと認可管理の機能を提供するインターフェース

**責務**: 
- ユーザーの権限チェック
- リソースへのアクセス制御
- ロールベース・属性ベースの認可判定

#### メソッド一覧

```java
public interface AuthorizationService {
    /**
     * ユーザーが指定した権限を持っているかチェックする
     * @param userId ユーザーID
     * @param permission 権限名
     * @return 権限を持っている場合はtrue
     */
    boolean hasPermission(UUID userId, String permission);
    
    /**
     * ユーザーが指定したリソースに対するアクションを実行できるかチェックする
     * @param userId ユーザーID
     * @param resourceType リソース種別
     * @param resourceId リソースID
     * @param action アクション
     * @return アクションが許可される場合はtrue
     */
    boolean isAllowed(UUID userId, String resourceType, String resourceId, String action);
    
    /**
     * ユーザーが指定したロールを持っているかチェックする
     * @param userId ユーザーID
     * @param roleName ロール名
     * @return ロールを持っている場合はtrue
     */
    boolean hasRole(UUID userId, String roleName);
    
    /**
     * ユーザーが持つ全ての権限を取得する
     * @param userId ユーザーID
     * @return 権限リスト
     */
    List<Permission> getUserPermissions(UUID userId);
    
    /**
     * ユーザーが持つ全てのロールを取得する
     * @param userId ユーザーID
     * @return ロールリスト
     */
    List<Role> getUserRoles(UUID userId);
    
    /**
     * 属性ベースのアクセス制御判定を行う
     * @param subject ユーザー情報
     * @param resource リソース情報
     * @param action アクション
     * @param environment 環境情報
     * @return アクセスが許可される場合はtrue
     */
    boolean evaluateAccess(Subject subject, Resource resource, Action action, Environment environment);
}
```

#### データモデル

```java
// 主体（ユーザー）
public class Subject {
    private UUID id;
    private Map<String, Object> attributes; // 部署、役職など
}

// リソース
public class Resource {
    private String type;
    private String id;
    private Map<String, Object> attributes; // 機密レベル、所有者など
}

// アクション
public class Action {
    private String name;
    private Map<String, Object> attributes;
}

// 環境
public class Environment {
    private Date timestamp;
    private String ipAddress;
    private String deviceType;
    private Map<String, Object> attributes;
}
```

### 2.3 UserService

**目的**: ユーザー管理機能を提供するインターフェース

**責務**: 
- ユーザーアカウントの作成・更新・削除
- ユーザー情報の取得
- パスワード管理
- ユーザーの検索

#### メソッド一覧

```java
public interface UserService {
    /**
     * ユーザーを作成する
     * @param createRequest ユーザー作成リクエスト
     * @return 作成されたユーザー
     * @throws ValidationException バリデーションエラー時
     * @throws DuplicateResourceException メールアドレスが既に存在する場合
     */
    User createUser(UserCreateRequest createRequest);
    
    /**
     * ユーザー情報を更新する
     * @param userId ユーザーID
     * @param updateRequest ユーザー更新リクエスト
     * @return 更新されたユーザー
     * @throws ResourceNotFoundException ユーザーが存在しない場合
     * @throws ValidationException バリデーションエラー時
     */
    User updateUser(UUID userId, UserUpdateRequest updateRequest);
    
    /**
     * ユーザーを削除する（論理削除）
     * @param userId ユーザーID
     * @throws ResourceNotFoundException ユーザーが存在しない場合
     */
    void deleteUser(UUID userId);
    
    /**
     * ユーザー情報を取得する
     * @param userId ユーザーID
     * @return ユーザー情報
     * @throws ResourceNotFoundException ユーザーが存在しない場合
     */
    User getUserById(UUID userId);
    
    /**
     * メールアドレスでユーザーを検索する
     * @param email メールアドレス
     * @return ユーザー情報（存在しない場合はnull）
     */
    User getUserByEmail(String email);
    
    /**
     * ユーザーのパスワードを変更する
     * @param userId ユーザーID
     * @param changeRequest パスワード変更リクエスト
     * @throws ResourceNotFoundException ユーザーが存在しない場合
     * @throws ValidationException バリデーションエラー時
     * @throws AuthenticationException 現在のパスワードが間違っている場合
     */
    void changePassword(UUID userId, PasswordChangeRequest changeRequest);
    
    /**
     * ユーザーのパスワードをリセットする
     * @param resetRequest パスワードリセットリクエスト
     * @throws ResourceNotFoundException ユーザーが存在しない場合
     * @throws ValidationException バリデーションエラー時
     * @throws InvalidTokenException トークンが無効な場合
     */
    void resetPassword(PasswordResetRequest resetRequest);
    
    /**
     * パスワードリセットトークンを発行する
     * @param email ユーザーのメールアドレス
     * @throws ResourceNotFoundException ユーザーが存在しない場合
     */
    void requestPasswordReset(String email);
    
    /**
     * ユーザーを検索する
     * @param searchRequest 検索条件
     * @return ユーザーのページング結果
     */
    Page<User> searchUsers(UserSearchRequest searchRequest);
}
```

#### データモデル

```java
// ユーザー作成リクエスト
public class UserCreateRequest {
    private String email;
    private String password;
    private String name;
    private String department;
    private String position;
    private String phone;
    private UUID roleId;
    private boolean mfaEnabled;
}

// ユーザー更新リクエスト
public class UserUpdateRequest {
    private String name;
    private String department;
    private String position;
    private String phone;
    private UUID roleId;
    private boolean mfaEnabled;
}

// パスワード変更リクエスト
public class PasswordChangeRequest {
    private String currentPassword;
    private String newPassword;
    private String confirmPassword;
}

// パスワードリセットリクエスト
public class PasswordResetRequest {
    private String token;
    private String newPassword;
    private String confirmPassword;
}

// ユーザー検索リクエスト
public class UserSearchRequest {
    private String nameFilter;
    private String emailFilter;
    private String departmentFilter;
    private List<UUID> roleIds;
    private Boolean mfaEnabled;
    private int page;
    private int size;
    private String sortBy;
    private boolean ascending;
}
```

### 2.4 RoleService

**目的**: ロール管理機能を提供するインターフェース

**責務**: 
- ロールの作成・更新・削除
- ロール情報の取得
- ロールへの権限割り当て
- ユーザーへのロール割り当て

#### メソッド一覧

```java
public interface RoleService {
    /**
     * ロールを作成する
     * @param createRequest ロール作成リクエスト
     * @return 作成されたロール
     * @throws ValidationException バリデーションエラー時
     * @throws DuplicateResourceException ロール名が既に存在する場合
     */
    Role createRole(RoleCreateRequest createRequest);
    
    /**
     * ロール情報を更新する
     * @param roleId ロールID
     * @param updateRequest ロール更新リクエスト
     * @return 更新されたロール
     * @throws ResourceNotFoundException ロールが存在しない場合
     * @throws ValidationException バリデーションエラー時
     */
    Role updateRole(UUID roleId, RoleUpdateRequest updateRequest);
    
    /**
     * ロールを削除する
     * @param roleId ロールID
     * @throws ResourceNotFoundException ロールが存在しない場合
     * @throws BusinessException ロールが使用中の場合
     */
    void deleteRole(UUID roleId);
    
    /**
     * ロール情報を取得する
     * @param roleId ロールID
     * @return ロール情報
     * @throws ResourceNotFoundException ロールが存在しない場合
     */
    Role getRoleById(UUID roleId);
    
    /**
     * 全てのロールを取得する
     * @return ロールリスト
     */
    List<Role> getAllRoles();
    
    /**
     * ロールに権限を割り当てる
     * @param roleId ロールID
     * @param permissionIds 権限IDリスト
     * @throws ResourceNotFoundException ロールまたは権限が存在しない場合
     */
    void assignPermissionsToRole(UUID roleId, List<UUID> permissionIds);
    
    /**
     * ロールの権限を取得する
     * @param roleId ロールID
     * @return 権限リスト
     * @throws ResourceNotFoundException ロールが存在しない場合
     */
    List<Permission> getRolePermissions(UUID roleId);
    
    /**
     * 全ての権限を取得する
     * @return 権限リスト
     */
    List<Permission> getAllPermissions();
}
```

#### データモデル

```java
// ロール作成リクエスト
public class RoleCreateRequest {
    private String name;
    private String description;
    private List<UUID> permissionIds;
}

// ロール更新リクエスト
public class RoleUpdateRequest {
    private String name;
    private String description;
}
```

## 3. 要求インターフェース

認証認可機能が他のモジュールに要求するインターフェースは以下の通りです。

### 3.1 NotificationService

**目的**: 通知送信機能を利用するためのインターフェース

**提供モジュール**: 通知機能

**使用目的**: 
- パスワードリセットメールの送信
- アカウントロック通知の送信
- 多要素認証コードの送信

#### 必要なメソッド

```java
public interface NotificationService {
    /**
     * メール通知を送信する
     * @param request メール送信リクエスト
     * @return 送信結果
     */
    NotificationResult sendEmail(EmailNotificationRequest request);
    
    /**
     * システム内通知を送信する
     * @param request システム内通知リクエスト
     * @return 送信結果
     */
    NotificationResult sendSystemNotification(SystemNotificationRequest request);
}
```

#### データモデル

```java
// メール送信リクエスト
public class EmailNotificationRequest {
    private String to;
    private String subject;
    private String templateName;
    private Map<String, Object> templateVariables;
    private NotificationPriority priority;
}

// システム内通知リクエスト
public class SystemNotificationRequest {
    private UUID userId;
    private String title;
    private String message;
    private NotificationType type;
    private Map<String, Object> metadata;
}

// 通知送信結果
public class NotificationResult {
    private boolean success;
    private String messageId;
    private Date sentAt;
    private String errorMessage;
}
```

### 3.2 AuditLogService

**目的**: 監査ログ記録機能を利用するためのインターフェース

**提供モジュール**: ロギング機能

**使用目的**:
- 認証イベントの記録
- 認可判定結果の記録
- セキュリティ関連操作の監査証跡

#### 必要なメソッド

```java
public interface AuditLogService {
    /**
     * 監査ログを記録する
     * @param entry 監査ログエントリ
     */
    void log(AuditLogEntry entry);
    
    /**
     * 認証イベントを記録する
     * @param event 認証イベント
     */
    void logAuthenticationEvent(AuthenticationEvent event);
    
    /**
     * 認可イベントを記録する
     * @param event 認可イベント
     */
    void logAuthorizationEvent(AuthorizationEvent event);
}
```

#### データモデル

```java
// 監査ログエントリ
public class AuditLogEntry {
    private UUID userId;
    private String action;
    private String targetType;
    private String targetId;
    private String details;
    private Date timestamp;
    private String ipAddress;
    private String userAgent;
    private AuditLogSeverity severity;
}

// 認証イベント
public class AuthenticationEvent {
    private UUID userId;
    private String username;
    private AuthenticationResult result;
    private AuthenticationMethod method;
    private String ipAddress;
    private String userAgent;
    private Date timestamp;
    private String failureReason;
    private int failureCount;
}

// 認可イベント
public class AuthorizationEvent {
    private UUID userId;
    private String resource;
    private String action;
    private boolean allowed;
    private String reason;
    private Date timestamp;
}
```

## 4. 非機能要件

### 4.1 パフォーマンス要件

- **認証処理**: 平均応答時間200ms以内、P99 500ms以内
- **認可チェック**: 平均応答時間50ms以内、P99 200ms以内
- **同時リクエスト処理能力**: 秒間100リクエスト以上
- **ユーザー検索**: 平均応答時間300ms以内（1000ユーザーまで）

### 4.2 セキュリティ要件

- **パスワードハッシュ化**: BCryptアルゴリズム（コストパラメータ = 12）
- **トークン署名**: RS256（RSA-SHA256）、2048ビット以上の鍵長
- **トークン有効期限**: アクセストークン30分、リフレッシュトークン14日（最大）
- **認証レート制限**: IPアドレスあたり1分間に10回まで
- **セッション管理**: ステートレスセッション、アイドルタイムアウト30分

### 4.3 可用性要件

- **サービス稼働率**: 99.9%以上
- **障害検出**: 30秒以内
- **バックアップポリシー**: 日次バックアップ、30日間保持
- **データ整合性**: トランザクション整合性の保証

### 4.4 運用要件

- **監査ログ**: 全ての認証・認可イベントを永続的に保存
- **アラート**: 不正アクセス試行の検出と通知
- **メンテナンス**: 計画メンテナンス時も認証機能は継続提供

## 5. インターフェース実装ガイドライン

### 5.1 エラーハンドリング

- 全てのメソッドは、適切な例外をスローすること
- 例外クラスは統一した階層構造を持つこと
- セキュリティ関連の例外は詳細情報を外部に漏らさないこと
- 認証失敗の理由は一般化すること（「資格情報が無効です」など）

### 5.2 スレッドセーフティ

- 全てのインターフェース実装はスレッドセーフであること
- 共有リソースへのアクセスは適切に同期すること
- 状態を持たない（ステートレス）設計を推奨

### 5.3 バージョニング

- APIの後方互換性を維持すること
- 互換性を破る変更は新しいインターフェースバージョンとして提供すること
- 非推奨（deprecated）メソッドは適切にマークし、代替手段を文書化すること

### 5.4 ドキュメンテーション

- 全てのインターフェースとメソッドにJavadocを記述すること
- パラメータの制約条件を明記すること
- 例外条件と発生する例外を文書化すること
- コード例を提供すること