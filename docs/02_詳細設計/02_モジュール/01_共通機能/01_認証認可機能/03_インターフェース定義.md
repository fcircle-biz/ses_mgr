# 認証認可機能 インターフェース定義

## 1. インターフェース概要

認証認可機能は、SES業務システム全体のセキュリティを担保するための中核的なインターフェースを提供します。本モジュールは、ユーザー認証、セッション管理、アクセス制御などの機能を他のモジュールに提供し、システム全体のセキュリティを一元管理します。

## 2. 提供インターフェース

認証認可機能が他のモジュールに提供するインターフェースは以下の通りです。

### 2.1 AuthenticationService

**目的**: ユーザー認証とセッション管理の機能を提供するインターフェース

**責務**: 
- ユーザー認証の実行
- トークンの発行・検証
- セッション管理
- 多要素認証の制御

#### メソッド一覧

**AuthenticationService インターフェース**

ユーザー認証とセッション管理の機能を提供するインターフェースです。

**主要メソッド**
- **authenticate**: ユーザー認証を行い、認証成功時にJWTトークンを発行
  - 引数: ユーザー認証情報
  - 戻り値: 認証トークン（アクセストークンとリフレッシュトークン）
  - 例外: 認証失敗時

- **refreshToken**: リフレッシュトークンを使用して新しいアクセストークンを取得
  - 引数: リフレッシュトークン
  - 戻り値: 新しい認証トークン
  - 例外: トークンが無効または期限切れの場合

- **logout**: ユーザーのセッションを無効化する（ログアウト）
  - 引数: ユーザーID、リフレッシュトークン

- **logoutAll**: 全てのセッションを無効化する（強制ログアウト）
  - 引数: ユーザーID

- **validateToken**: トークンを検証し、ユーザープリンシパルを取得
  - 引数: JWTトークン
  - 戻り値: ユーザープリンシパル
  - 例外: トークンが無効な場合

- **verifyMfaCode**: 多要素認証コードを検証
  - 引数: ユーザーID、検証コード
  - 戻り値: 検証結果

- **setupMfa**: 多要素認証を設定
  - 引数: ユーザーID、認証方式
  - 戻り値: 設定情報（QRコードや確認コードなど）
```

#### データモデル

**認証関連データモデル**

- **Credentials（認証リクエスト）**
  - email: メールアドレス
  - password: パスワード
  - rememberMe: 長期セッション記憶フラグ

- **TokenResponse（トークンレスポンス）**
  - accessToken: アクセストークン
  - refreshToken: リフレッシュトークン
  - expiresAt: 有効期限
  - requiresMfa: 多要素認証要求フラグ

- **UserPrincipal（ユーザープリンシパル）**
  - userId: ユーザーID
  - email: メールアドレス
  - name: ユーザー名
  - roles: ロールリスト
  - permissions: 権限リスト

- **MfaSetupResponse（多要素認証設定レスポンス）**
  - secretKey: 秘密鍵
  - qrCodeUrl: QRコードURL
  - recoveryCodes: リカバリーコードリスト

#### 例外

**認証例外**

- **AuthenticationException**：認証処理中に発生する例外
  - RuntimeExceptionを継承
  - errorCode：認証エラーコードを保持

- **認証エラーコード**
  - INVALID_CREDENTIALS：無効な認証情報
  - ACCOUNT_LOCKED：アカウントロック状態
  - ACCOUNT_EXPIRED：アカウント期限切れ
  - PASSWORD_EXPIRED：パスワード期限切れ
  - MFA_REQUIRED：多要素認証が必要
  - INVALID_TOKEN：無効なトークン
  - TOKEN_EXPIRED：トークン期限切れ

### 2.2 AuthorizationService

**目的**: 権限チェックと認可管理の機能を提供するインターフェース

**責務**: 
- ユーザーの権限チェック
- リソースへのアクセス制御
- ロールベース・属性ベースの認可判定

#### メソッド一覧

**AuthorizationService インターフェース**

権限チェックと認可管理の機能を提供するインターフェースです。

**主要メソッド**
- **hasPermission**: ユーザーが指定した権限を持っているかチェック
  - 引数: ユーザーID、権限名
  - 戻り値: 権限を持っている場合はtrue

- **isAllowed**: ユーザーが指定したリソースに対するアクションを実行できるかチェック
  - 引数: ユーザーID、リソース種別、リソースID、アクション
  - 戻り値: アクションが許可される場合はtrue

- **hasRole**: ユーザーが指定したロールを持っているかチェック
  - 引数: ユーザーID、ロール名
  - 戻り値: ロールを持っている場合はtrue

- **getUserPermissions**: ユーザーが持つ全ての権限を取得
  - 引数: ユーザーID
  - 戻り値: 権限リスト

- **getUserRoles**: ユーザーが持つ全てのロールを取得
  - 引数: ユーザーID
  - 戻り値: ロールリスト

- **evaluateAccess**: 属性ベースのアクセス制御判定を行う
  - 引数: ユーザー情報、リソース情報、アクション、環境情報
  - 戻り値: アクセスが許可される場合はtrue
```

#### データモデル

**認可関連データモデル**

- **Subject（主体/ユーザー）**
  - id: ユーザーID
  - attributes: 属性マップ（部署、役職など）

- **Resource（リソース）**
  - type: リソース種別
  - id: リソースID
  - attributes: 属性マップ（機密レベル、所有者など）

- **Action（アクション）**
  - name: アクション名
  - attributes: 属性マップ

- **Environment（環境）**
  - timestamp: タイムスタンプ
  - ipAddress: IPアドレス
  - deviceType: デバイスタイプ
  - attributes: 属性マップ

### 2.3 UserService

**目的**: ユーザー管理機能を提供するインターフェース

**責務**: 
- ユーザーアカウントの作成・更新・削除
- ユーザー情報の取得
- パスワード管理
- ユーザーの検索

#### メソッド一覧

**UserService インターフェース**

ユーザー管理機能を提供するインターフェースです。

**主要メソッド**
- **createUser**: ユーザーを作成
  - 引数: ユーザー作成リクエスト
  - 戻り値: 作成されたユーザー
  - 例外: バリデーションエラー時、メールアドレスが既に存在する場合

- **updateUser**: ユーザー情報を更新
  - 引数: ユーザーID、ユーザー更新リクエスト
  - 戻り値: 更新されたユーザー
  - 例外: ユーザーが存在しない場合、バリデーションエラー時

- **deleteUser**: ユーザーを削除（論理削除）
  - 引数: ユーザーID
  - 例外: ユーザーが存在しない場合

- **getUserById**: ユーザー情報を取得
  - 引数: ユーザーID
  - 戻り値: ユーザー情報
  - 例外: ユーザーが存在しない場合

- **getUserByEmail**: メールアドレスでユーザーを検索
  - 引数: メールアドレス
  - 戻り値: ユーザー情報（存在しない場合はnull）

- **changePassword**: ユーザーのパスワードを変更
  - 引数: ユーザーID、パスワード変更リクエスト
  - 例外: ユーザーが存在しない場合、バリデーションエラー時、現在のパスワードが間違っている場合

- **resetPassword**: ユーザーのパスワードをリセット
  - 引数: パスワードリセットリクエスト
  - 例外: ユーザーが存在しない場合、バリデーションエラー時、トークンが無効な場合

- **requestPasswordReset**: パスワードリセットトークンを発行
  - 引数: ユーザーのメールアドレス
  - 例外: ユーザーが存在しない場合

- **searchUsers**: ユーザーを検索
  - 引数: 検索条件
  - 戻り値: ユーザーのページング結果
```

#### データモデル

```java
// ユーザー作成リクエスト
public class UserCreateRequest {
    private String email;
    private String password;
    private String name;
    private String department;
    private String position;
    private String phone;
    private UUID roleId;
    private boolean mfaEnabled;
}

// ユーザー更新リクエスト
public class UserUpdateRequest {
    private String name;
    private String department;
    private String position;
    private String phone;
    private UUID roleId;
    private boolean mfaEnabled;
}

// パスワード変更リクエスト
public class PasswordChangeRequest {
    private String currentPassword;
    private String newPassword;
    private String confirmPassword;
}

// パスワードリセットリクエスト
public class PasswordResetRequest {
    private String token;
    private String newPassword;
    private String confirmPassword;
}

// ユーザー検索リクエスト
public class UserSearchRequest {
    private String nameFilter;
    private String emailFilter;
    private String departmentFilter;
    private List<UUID> roleIds;
    private Boolean mfaEnabled;
    private int page;
    private int size;
    private String sortBy;
    private boolean ascending;
}
```

### 2.4 RoleService

**目的**: ロール管理機能を提供するインターフェース

**責務**: 
- ロールの作成・更新・削除
- ロール情報の取得
- ロールへの権限割り当て
- ユーザーへのロール割り当て

#### メソッド一覧

```java
public interface RoleService {
    /**
     * ロールを作成する
     * @param createRequest ロール作成リクエスト
     * @return 作成されたロール
     * @throws ValidationException バリデーションエラー時
     * @throws DuplicateResourceException ロール名が既に存在する場合
     */
    Role createRole(RoleCreateRequest createRequest);
    
    /**
     * ロール情報を更新する
     * @param roleId ロールID
     * @param updateRequest ロール更新リクエスト
     * @return 更新されたロール
     * @throws ResourceNotFoundException ロールが存在しない場合
     * @throws ValidationException バリデーションエラー時
     */
    Role updateRole(UUID roleId, RoleUpdateRequest updateRequest);
    
    /**
     * ロールを削除する
     * @param roleId ロールID
     * @throws ResourceNotFoundException ロールが存在しない場合
     * @throws BusinessException ロールが使用中の場合
     */
    void deleteRole(UUID roleId);
    
    /**
     * ロール情報を取得する
     * @param roleId ロールID
     * @return ロール情報
     * @throws ResourceNotFoundException ロールが存在しない場合
     */
    Role getRoleById(UUID roleId);
    
    /**
     * 全てのロールを取得する
     * @return ロールリスト
     */
    List<Role> getAllRoles();
    
    /**
     * ロールに権限を割り当てる
     * @param roleId ロールID
     * @param permissionIds 権限IDリスト
     * @throws ResourceNotFoundException ロールまたは権限が存在しない場合
     */
    void assignPermissionsToRole(UUID roleId, List<UUID> permissionIds);
    
    /**
     * ロールの権限を取得する
     * @param roleId ロールID
     * @return 権限リスト
     * @throws ResourceNotFoundException ロールが存在しない場合
     */
    List<Permission> getRolePermissions(UUID roleId);
    
    /**
     * 全ての権限を取得する
     * @return 権限リスト
     */
    List<Permission> getAllPermissions();
}
```

#### データモデル

```java
// ロール作成リクエスト
public class RoleCreateRequest {
    private String name;
    private String description;
    private List<UUID> permissionIds;
}

// ロール更新リクエスト
public class RoleUpdateRequest {
    private String name;
    private String description;
}
```

## 3. 要求インターフェース

認証認可機能が他のモジュールに要求するインターフェースは以下の通りです。

### 3.1 NotificationService

**目的**: 通知送信機能を利用するためのインターフェース

**提供モジュール**: 通知機能

**使用目的**: 
- パスワードリセットメールの送信
- アカウントロック通知の送信
- 多要素認証コードの送信

#### 必要なメソッド

**NotificationService インターフェース**

通知機能モジュールが提供する通知送信機能のインターフェースです。

**主要メソッド**
- **sendEmail**: メール通知を送信
  - 引数: メール送信リクエスト
  - 戻り値: 送信結果

- **sendSystemNotification**: システム内通知を送信
  - 引数: システム内通知リクエスト
  - 戻り値: 送信結果
```

#### データモデル

**通知関連データモデル**

- **EmailNotificationRequest（メール送信リクエスト）**
  - to: 宛先
  - subject: 件名
  - templateName: テンプレート名
  - templateVariables: テンプレート変数
  - priority: 優先度

- **SystemNotificationRequest（システム内通知リクエスト）**
  - userId: ユーザーID
  - title: タイトル
  - message: メッセージ
  - type: 通知タイプ
  - metadata: メタデータ

- **NotificationResult（通知送信結果）**
  - success: 成功フラグ
  - messageId: メッセージID
  - sentAt: 送信日時
  - errorMessage: エラーメッセージ
```

### 3.2 AuditLogService

**目的**: 監査ログ記録機能を利用するためのインターフェース

**提供モジュール**: ロギング機能

**使用目的**:
- 認証イベントの記録
- 認可判定結果の記録
- セキュリティ関連操作の監査証跡

#### 必要なメソッド

**AuditLogService インターフェース**

ロギング機能モジュールが提供する監査ログ記録機能のインターフェースです。

**主要メソッド**
- **log**: 監査ログを記録
  - 引数: 監査ログエントリ

- **logAuthenticationEvent**: 認証イベントを記録
  - 引数: 認証イベント

- **logAuthorizationEvent**: 認可イベントを記録
  - 引数: 認可イベント

#### データモデル

**ログ関連データモデル**

- **AuditLogEntry（監査ログエントリ）**
  - userId: ユーザーID
  - action: 操作
  - targetType: 対象タイプ
  - targetId: 対象ID
  - details: 詳細
  - timestamp: タイムスタンプ
  - ipAddress: IPアドレス
  - userAgent: ユーザーエージェント
  - severity: 重要度

- **AuthenticationEvent（認証イベント）**
  - userId: ユーザーID
  - username: ユーザー名
  - result: 認証結果
  - method: 認証方式
  - ipAddress: IPアドレス
  - userAgent: ユーザーエージェント
  - timestamp: タイムスタンプ
  - failureReason: 失敗理由
  - failureCount: 失敗回数

- **AuthorizationEvent（認可イベント）**
  - userId: ユーザーID
  - resource: リソース
  - action: 操作
  - allowed: 許可フラグ
  - reason: 理由
  - timestamp: タイムスタンプ

## 4. 非機能要件

### 4.1 パフォーマンス要件

- **認証処理**: 平均応答時間200ms以内、P99 500ms以内
- **認可チェック**: 平均応答時間50ms以内、P99 200ms以内
- **同時リクエスト処理能力**: 秒間100リクエスト以上
- **ユーザー検索**: 平均応答時間300ms以内（1000ユーザーまで）

### 4.2 セキュリティ要件

- **パスワードハッシュ化**: BCryptアルゴリズム（コストパラメータ = 12）
- **トークン署名**: RS256（RSA-SHA256）、2048ビット以上の鍵長
- **トークン有効期限**: アクセストークン30分、リフレッシュトークン14日（最大）
- **認証レート制限**: IPアドレスあたり1分間に10回まで
- **セッション管理**: ステートレスセッション、アイドルタイムアウト30分

### 4.3 可用性要件

- **サービス稼働率**: 99.9%以上
- **障害検出**: 30秒以内
- **バックアップポリシー**: 日次バックアップ、30日間保持
- **データ整合性**: トランザクション整合性の保証

### 4.4 運用要件

- **監査ログ**: 全ての認証・認可イベントを永続的に保存
- **アラート**: 不正アクセス試行の検出と通知
- **メンテナンス**: 計画メンテナンス時も認証機能は継続提供

## 5. インターフェース実装ガイドライン

### 5.1 エラーハンドリング

- 全てのメソッドは、適切な例外をスローすること
- 例外クラスは統一した階層構造を持つこと
- セキュリティ関連の例外は詳細情報を外部に漏らさないこと
- 認証失敗の理由は一般化すること（「資格情報が無効です」など）

### 5.2 スレッドセーフティ

- 全てのインターフェース実装はスレッドセーフであること
- 共有リソースへのアクセスは適切に同期すること
- 状態を持たない（ステートレス）設計を推奨

### 5.3 バージョニング

- APIの後方互換性を維持すること
- 互換性を破る変更は新しいインターフェースバージョンとして提供すること
- 非推奨（deprecated）メソッドは適切にマークし、代替手段を文書化すること

### 5.4 ドキュメンテーション

- 全てのインターフェースとメソッドにJavadocを記述すること
- パラメータの制約条件を明記すること
- 例外条件と発生する例外を文書化すること
- コード例を提供すること

## 6. 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|----------|------|--------|---------|
| 0.1 | 2023-08-05 | 開発チーム | 初版作成 |
| 0.2 | 2023-09-10 | 開発チーム | 多要素認証機能の追加 |
| 0.3 | 2023-11-15 | 開発チーム | 属性ベース認可の追加 |
| 0.4 | 2025-05-10 | Claude | 実装コードを削除し、設計情報のみに修正 |