# 認証機能 詳細設計

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2025-05-10 | 設計担当者 | 初版作成 |
| 0.2 | 2025-05-11 | 設計担当者 | 実装コード削除による軽量化 |

## 1. 概要

### 1.1 目的
認証機能は、SES業務システムにおけるユーザー認証、セッション管理、トークン発行・検証などのセキュリティ基盤機能を提供する。本モジュールにより、正規のユーザーのみがシステムにアクセスでき、安全なセッション維持が可能となる。

### 1.2 機能範囲
- ユーザー認証（ID/パスワード）
- JWTトークン発行・検証
- リフレッシュトークン管理
- 多要素認証（MFA）
- パスワード管理（リセット、変更）
- アカウントロック管理
- ログイン／ログアウト処理

### 1.3 関連モジュール
- ユーザー管理モジュール：ユーザー情報の取得に利用
- 通知モジュール：パスワードリセットメール送信などに利用
- 監査ログモジュール：セキュリティイベント記録に利用

## 2. コンポーネント構成

### 2.1 コントローラー

#### AuthenticationController
- **責務**：認証関連のRESTエンドポイントを提供
- **エンドポイント**：
  - POST /api/v1/auth/login：ユーザーログイン
  - POST /api/v1/auth/refresh：トークンのリフレッシュ
  - POST /api/v1/auth/logout：ログアウト
  - POST /api/v1/auth/mfa/verify：多要素認証の検証
  - POST /api/v1/auth/mfa/setup：多要素認証のセットアップ
  - POST /api/v1/auth/password/reset-request：パスワードリセット要求
  - POST /api/v1/auth/password/reset：パスワードリセット実行
  - POST /api/v1/auth/password/change：パスワード変更

#### 主要メソッド
- **login**：ユーザー認証とトークン発行
- **refreshToken**：リフレッシュトークンによるアクセストークン更新
- **logout**：ログアウト処理とトークン無効化
- **verifyMfa**：多要素認証コードの検証
- **setupMfa**：多要素認証のセットアップ
- **requestPasswordReset**：パスワードリセット要求の処理
- **resetPassword**：パスワードリセットの実行
- **changePassword**：パスワード変更の実行

### 2.2 サービス

#### AuthenticationServiceImpl
- **責務**：認証ロジックの実装、AuthenticationServiceインターフェースの実装
- **主要メソッド**：
  - authenticate：ユーザー認証とトークン発行
  - refreshToken：リフレッシュトークンによるアクセストークン更新
  - validateToken：トークンの検証
  - logout/logoutAll：セッション無効化
  - verifyMfaCode/setupMfa：多要素認証の処理

#### JwtTokenProvider
- **責務**：JWTトークンの生成・検証・管理
- **主要メソッド**：
  - generateAccessToken：アクセストークン生成
  - generateRefreshToken：リフレッシュトークン生成
  - validateAccessToken：アクセストークン検証
  - validateRefreshToken：リフレッシュトークン検証
  - getAuthentication：トークンから認証情報を取得

#### MfaService
- **責務**：多要素認証の処理
- **主要メソッド**：
  - setupTotpMfa：TOTPベースの多要素認証セットアップ
  - verifyTotpCode：TOTPコードの検証
  - generateRecoveryCodes：リカバリーコード生成
  - verifyRecoveryCode：リカバリーコード検証

### 2.3 リポジトリ

#### UserRepository
- **責務**：ユーザーエンティティのデータアクセス
- **主要メソッド**：
  - findById：IDによるユーザー検索
  - findByEmail：メールアドレスによるユーザー検索
  - save：ユーザー保存
  - updateLastLogin：最終ログイン日時更新
  - updateLoginFailCount：ログイン失敗回数更新
  - updateAccountLockStatus：アカウントロック状態更新

#### RefreshTokenRepository
- **責務**：リフレッシュトークンエンティティのデータアクセス
- **主要メソッド**：
  - findById：IDによるトークン検索
  - findByUserIdAndRevoked：ユーザーIDによる有効なトークン検索
  - save：トークン保存
  - revokeAllUserTokens：ユーザーの全トークン無効化
  - deleteByExpiresAtBefore：期限切れトークン削除

### 2.4 セキュリティ設定

#### SecurityConfig
- **責務**：Spring Securityの設定
- **主要設定**：
  - セキュリティフィルターチェーン
  - 認証プロバイダー
  - CSRFやCORSの設定
  - セキュリティヘッダー設定

#### JwtAuthenticationFilter
- **責務**：リクエストからJWTトークンを抽出し、認証処理を行う
- **主要機能**：
  - トークン抽出
  - トークン検証
  - 認証情報の設定

### 2.5 データモデル

#### User
- ユーザー情報を表すエンティティ
- **属性**：
  - id：ユーザーID (UUID)
  - email：メールアドレス (String)
  - passwordHash：パスワードハッシュ (String)
  - name：氏名 (String)
  - department：部署 (String)
  - position：役職 (String)
  - phone：電話番号 (String)
  - roleId：ロールID (UUID)
  - lastLoginAt：最終ログイン日時 (LocalDateTime)
  - mfaEnabled：MFA有効フラグ (boolean)
  - mfaSecret：MFA秘密鍵 (String)
  - accountLocked：アカウントロックフラグ (boolean)
  - lockedUntil：ロック解除予定日時 (LocalDateTime)
  - accountExpiresAt：アカウント有効期限 (LocalDateTime)
  - passwordExpiresAt：パスワード有効期限 (LocalDateTime)
  - loginFailCount：ログイン失敗回数 (int)
  - createdAt：作成日時 (LocalDateTime)
  - updatedAt：更新日時 (LocalDateTime)

#### RefreshToken
- リフレッシュトークン情報を表すエンティティ
- **属性**：
  - id：トークンID (UUID)
  - userId：ユーザーID (UUID)
  - tokenHash：トークンハッシュ (String)
  - expiresAt：有効期限 (LocalDateTime)
  - createdAt：作成日時 (LocalDateTime)
  - revoked：無効化フラグ (boolean)
  - revokedAt：無効化日時 (LocalDateTime)

#### MfaRecoveryCode
- 多要素認証のリカバリーコードを表すエンティティ
- **属性**：
  - id：コードID (UUID)
  - userId：ユーザーID (UUID)
  - codeHash：コードハッシュ (String)
  - used：使用済みフラグ (boolean)
  - usedAt：使用日時 (LocalDateTime)
  - createdAt：作成日時 (LocalDateTime)

## 3. 主要処理フロー

### 3.1 ユーザー認証フロー

1. クライアントがログイン情報（メールアドレス、パスワード）を送信
2. AuthenticationControllerがリクエストを受け取る
3. AuthenticationServiceがユーザー情報を検証
   - ユーザーの存在確認
   - パスワードのハッシュ照合
   - アカウント状態チェック
4. JWTトークン（アクセス＋リフレッシュ）を生成
5. クライアントにトークンレスポンスを返却
6. 必要に応じて多要素認証を要求
   - MFAが有効な場合、requiresMfaフラグをtrueに設定
   - クライアントがMFAコードを送信
   - MfaServiceがコードを検証

### 3.2 トークンリフレッシュフロー

1. クライアントがリフレッシュトークンを送信
2. AuthenticationControllerがリクエストを受け取る
3. JwtTokenProviderがリフレッシュトークンを検証
4. RefreshTokenRepositoryがトークンの存在と有効性を確認
5. 新しいアクセストークンを生成
6. 必要に応じてリフレッシュトークンもローテーション
7. クライアントに新しいトークンレスポンスを返却

### 3.3 パスワードリセットフロー

1. ユーザーがパスワードリセットをリクエスト
2. AuthenticationControllerがリクエストを受け取る
3. UserServiceがユーザーの存在確認
4. パスワードリセットトークンを生成・保存
5. NotificationServiceがリセットメールを送信
6. ユーザーがメールのリンクからリセットページにアクセス
7. 新しいパスワードを入力・送信
8. AuthenticationControllerがリセットトークンを検証
9. UserServiceがパスワードを更新（ハッシュ化して保存）
10. 既存のセッションを無効化
11. ユーザーにリセット成功を通知

### 3.4 多要素認証セットアップフロー

1. ユーザーがMFAセットアップをリクエスト
2. AuthenticationControllerがリクエストを受け取る
3. MfaServiceが秘密鍵を生成
4. QRコード用のURIを生成
5. リカバリーコードを生成
6. 秘密鍵を暗号化してユーザーに紐づけて保存
7. QRコードURIとリカバリーコードをクライアントに返却
8. ユーザーが認証アプリでQRコードをスキャン
9. 認証アプリが生成したコードを送信
10. MfaServiceがコードを検証
11. 検証成功時にMFAを有効化

## 4. 例外処理

### 4.1 認証例外階層

- **AuthenticationException**：認証関連の基底例外クラス
  - errorCode：エラーコードを保持

- **エラーコード**：
  - INVALID_CREDENTIALS：資格情報無効
  - ACCOUNT_LOCKED：アカウントロック
  - ACCOUNT_EXPIRED：アカウント期限切れ
  - PASSWORD_EXPIRED：パスワード期限切れ
  - MFA_REQUIRED：多要素認証必須
  - MFA_FAILED：多要素認証失敗
  - INVALID_TOKEN：トークン無効
  - TOKEN_EXPIRED：トークン期限切れ
  - REFRESH_TOKEN_REVOKED：リフレッシュトークン無効化済み

### 4.2 グローバル例外ハンドラー

- 各種認証例外に対応するエラーレスポンスの生成
- エラーコードに応じた適切なHTTPステータスコードの設定
- クライアントに返却するエラーメッセージのフォーマット処理

## 5. セキュリティ対策

### 5.1 パスワードセキュリティ

- **ハッシュ化アルゴリズム**: BCrypt（コストパラメータ = 12）
- **パスワード強度検証**:
  - 8文字以上
  - 大文字/小文字/数字/特殊文字から3種類以上の組み合わせ
  - 共通パスワードブラックリストとの照合
- **パスワード有効期限**: 90日（設定により変更可能）
- **パスワード履歴**: 過去5回使用したパスワードの再利用禁止

### 5.2 JWT対策

- **署名アルゴリズム**: RS256（RSA-SHA256）を使用、キー長2048ビット以上
- **有効期限**: アクセストークン30分、リフレッシュトークン最大2週間
- **クレーム内容の最小化**: 必要最小限の情報のみ含める
- **リフレッシュトークン管理**: データベースでの追跡・無効化機能
- **ローテーション**: 定期的なリフレッシュトークンのローテーション

### 5.3 アカウント保護

- **アカウントロック**: 5回連続のログイン失敗でアカウントを一時的にロック（30分）
- **ログイン試行遅延**: 失敗回数に応じて指数関数的に遅延を増加
- **多要素認証**: 管理者アカウントは必須、他のユーザーはオプション
- **リカバリーコード**: 多要素認証のバックアップとして一度限りのリカバリーコード

### 5.4 トランスポートセキュリティ

- **HTTPS強制**: HTTPSでのみアクセス可能（HTTP⇨HTTPSリダイレクト）
- **セキュリティヘッダー**:
  - Strict-Transport-Security
  - X-Content-Type-Options: nosniff
  - X-Frame-Options: DENY
  - Content-Security-Policy
  - X-XSS-Protection

## 6. 特記事項

### 6.1 実装上の注意点

- **セッション管理**: セッションはステートレスに設計し、サーバー側での情報保持を最小限にする
- **スケーラビリティ**: JWT検証は各サーバーで独立して行えるため、水平スケーリングが容易
- **鍵管理**: JWT署名用の秘密鍵は安全に管理し、定期的にローテーションする仕組みを導入
- **トークン漏洩対策**: HTTPヘッダーでの送信、HTTPS強制、XSS対策の徹底

### 6.2 パフォーマンス考慮点

- **キャッシュの活用**: ユーザー情報や権限情報のキャッシュを適切に設定
- **非同期処理**: メール送信などの非同期処理を導入
- **バッチ処理**: 期限切れトークンの定期的なクリーンアップ
- **インデックス最適化**: ユーザー検索、トークン検証のためのインデックス設定

### 6.3 テストの観点

- **単体テスト**: 各サービスクラスのメソッドごとのテスト
- **統合テスト**: 認証フロー全体のE2Eテスト
- **セキュリティテスト**: パスワード強度検証、JWT実装の脆弱性テスト
- **パフォーマンステスト**: 多数のユーザーによる同時ログインテスト

## 7. 参照情報

- [Spring Security Documentation](https://docs.spring.io/spring-security/reference/index.html)
- [JWT.io](https://jwt.io/)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [TOTP Algorithm (RFC 6238)](https://tools.ietf.org/html/rfc6238)