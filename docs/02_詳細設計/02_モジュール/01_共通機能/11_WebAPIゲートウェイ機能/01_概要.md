# WebAPIゲートウェイ機能 概要

## 1. 目的と責務

WebAPIゲートウェイ機能は、SES業務システムの外部インターフェースとして機能し、クライアントからのAPIリクエストを受け付け、適切な内部サービスへルーティングすることを主な責務とします。このゲートウェイは、認証、認可、リクエスト検証、ロギング、キャッシュなどの横断的関心事を一元的に処理することで、バックエンドサービスの負担を軽減し、API全体のセキュリティと一貫性を確保します。

### 1.1 主要な責務

- **単一エントリーポイント**: 全てのAPIリクエストに対する統一的なエントリーポイントの提供
- **リクエストルーティング**: 適切なバックエンドサービスへのリクエスト転送
- **認証・認可**: APIアクセスの認証と権限チェック
- **リクエスト検証**: 入力値の構文チェックと基本的なバリデーション
- **レート制限**: APIの過剰利用防止と公平なリソース割り当て
- **ロギングと監視**: APIトラフィックのロギングとメトリクス収集
- **レスポンス変換**: 統一的なレスポンス形式への変換
- **キャッシュ管理**: 頻繁に利用されるレスポンスのキャッシュ
- **エラーハンドリング**: 統一的なエラーレスポンス形式での例外処理

## 2. 機能概要

WebAPIゲートウェイは以下の主要機能を提供します。

### 2.1 ルーティング機能

- **動的ルート設定**: 設定ベースのルーティングテーブル管理
- **パスベースルーティング**: URIパスに基づくバックエンドサービスの選定
- **コンテンツベースルーティング**: リクエスト内容に基づく条件付きルーティング
- **バックエンドヘルスチェック**: 利用可能なバックエンドサービスの検出と管理

### 2.2 リクエスト処理機能

- **リクエストパース**: JSON/XML形式のリクエストボディの解析
- **リクエストバリデーション**: スキーマベースの入力値検証
- **ヘッダー管理**: リクエストヘッダーの検証と変換
- **パラメータ変換**: クエリパラメータと形式の標準化

### 2.3 セキュリティ機能

- **認証処理**: JWT/APIキーなどによる認証
- **認可管理**: ロールベースとスコープベースのアクセス制御
- **レート制限**: ユーザー/IPベースのリクエスト制限
- **APIキー管理**: 発行、失効、権限設定

### 2.4 レスポンス処理機能

- **レスポンスフォーマット**: 統一的なJSONレスポンス形式変換
- **コンテンツネゴシエーション**: Accept headerに基づく応答形式の調整
- **レスポンス圧縮**: gzipなどによるレスポンスサイズの最適化
- **エラー応答の統一**: エラーコードと詳細情報の標準化

### 2.5 監視機能

- **アクセスログ記録**: リクエスト/レスポンスの詳細記録
- **パフォーマンスメトリクス**: レイテンシー、スループット計測
- **エラー率監視**: エラー発生率の集計と通知
- **利用統計**: エンドポイント別、ユーザー別の利用状況集計

## 3. システム内の位置づけ

WebAPIゲートウェイは、SES業務システムのAPIリクエストを処理する最前線に位置し、以下のような役割を担います。

### 3.1 アーキテクチャ上の位置づけ

```
クライアント(ブラウザ/モバイルアプリ)
          ↓
    ロードバランサー
          ↓
  +-------------------+
  | WebAPIゲートウェイ |
  +-------------------+
          ↓
 +--------+--------+--------+
 ↓        ↓        ↓        ↓
案件管理API 技術者管理API 契約管理API ... その他業務API
```

WebAPIゲートウェイは、モノリシックアーキテクチャの中で論理的に分離されたAPIゲートウェイコンポーネントとして実装されます。将来的なマイクロサービス化を見据えた設計となっています。

### 3.2 他モジュールとの関係

- **認証認可機能**: ユーザー認証とアクセス制御の委譲
- **ロギング機能**: APIトラフィックログの連携
- **エラー処理機能**: 統一的なエラーハンドリングの連携
- **各業務モジュール**: APIリクエストのルーティング先

## 4. ユースケース

WebAPIゲートウェイが関与する主要なユースケースを以下に示します。

### 4.1 認証済みAPIアクセス

1. クライアントがJWTトークンを含むAPIリクエストを送信
2. ゲートウェイがトークンを検証
3. 認証に成功した場合、リクエストを対象バックエンドサービスへ転送
4. バックエンドからのレスポンスを標準形式に変換してクライアントへ返却
5. 全プロセスをログに記録

### 4.2 認可チェックと権限制御

1. 認証済みリクエストに対し、ユーザーロールとリソース権限をチェック
2. 権限不足の場合は403エラーを返却
3. 権限があればリクエストをバックエンドへ転送
4. アクセス制御結果を監査ログに記録

### 4.3 リクエスト検証とエラーハンドリング

1. リクエストのスキーマ検証を実施
2. バリデーションエラーの場合は400エラーを返却
3. バックエンドエラーを適切なHTTPステータスコードに変換
4. 詳細なエラー情報をレスポンスに含める

### 4.4 APIレート制限と過負荷保護

1. 送信元IPアドレスやAPIキーごとにリクエスト数を計測
2. 設定された閾値を超えた場合は429エラー(Too Many Requests)を返却
3. レート制限状況をメトリクスとして記録

## 5. 技術スタック

WebAPIゲートウェイの実装には以下の技術を使用します。

- **Spring Cloud Gateway**: リアクティブなAPIゲートウェイ実装
- **Spring Security**: 認証・認可フレームワーク
- **Redis**: レート制限の状態管理、キャッシュ
- **Resilience4j**: サーキットブレーカー、リトライ機能
- **Micrometer**: メトリクス収集
- **Logback**: ロギング

## 6. 非機能要件

### 6.1 パフォーマンス要件

- レイテンシーオーバーヘッド: バックエンドサービス処理時間の10%以内
- スループット: 1000リクエスト/秒以上の処理能力
- レスポンスタイム: 95パーセンタイルで300ms以内（バックエンド処理時間を除く）

### 6.2 信頼性要件

- 可用性: 99.9%以上
- エラー率: 0.1%以下（ゲートウェイに起因するエラー）
- 障害復旧: 自動リトライと回復機能により30秒以内

### 6.3 スケーラビリティ要件

- 水平スケーリング: ステートレス設計によるインスタンス追加対応
- 設定の動的更新: 再起動不要のルート設定更新

### 6.4 セキュリティ要件

- 全通信のTLS暗号化
- OWASP Top 10脆弱性対策の実装
- APIキーの安全な管理と監査
- センシティブデータのマスキング