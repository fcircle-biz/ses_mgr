# WebAPIゲートウェイ機能 レスポンス処理機能

## 1. 概要

レスポンス処理機能は、バックエンドサービスから返却されたレスポンスを加工、変換、検証し、クライアントに最適な形式で返却する機能です。この機能により、異なるバックエンドサービスからのレスポンスを統一的な形式に標準化し、一貫性のあるAPIレスポンスをクライアントに提供します。また、機密情報のフィルタリングやパフォーマンス最適化も担います。

## 2. レスポンス処理機能の責務

レスポンス処理機能は以下の主要な責務を持ちます：

1. **レスポンス変換**: フォーマットの標準化と正規化
2. **レスポンスフィルタリング**: 機密情報や不要データの除去
3. **レスポンス拡張**: メタデータや追加情報の付加
4. **エラー変換**: バックエンドエラーの統一的な表現への変換
5. **最適化**: 圧縮やキャッシュ制御

## 3. コンポーネント構成

レスポンス処理機能は以下のコンポーネントで構成されます：

### 3.1 ResponseTransformer

バックエンドレスポンスを標準形式に変換するコンポーネントです。

**主要機能**:
- レスポンス構造の変換
- フィールド名の標準化
- データ型の正規化
- 日付/数値フォーマットの統一
- 多言語対応

```java
public interface ResponseTransformer {
    GatewayResponse transform(GatewayResponse response, TransformationRules rules);
    TransformationRules getTransformationRulesForRoute(String routeId);
}
```

### 3.2 ResponseFilter

レスポンスデータのフィルタリングを行うコンポーネントです。

**主要機能**:
- 機密情報のマスキング/除去
- 不要フィールドの削除
- アクセス権限に基づくデータフィルタリング
- APIバージョンに基づく互換性フィルタリング

```java
public interface ResponseFilter {
    GatewayResponse filter(GatewayResponse response, FilteringRules rules);
    FilteringRules getFilteringRulesForRoute(String routeId);
}
```

### 3.3 ResponseEnricher

レスポンスに追加情報を付加するコンポーネントです。

**主要機能**:
- ページネーション情報の追加
- APIバージョン情報の追加
- 処理時間情報の追加
- リクエスト/レスポンス相関情報の追加
- HATEOAS（Hypermedia）リンクの追加

```java
public interface ResponseEnricher {
    GatewayResponse enrich(GatewayResponse response, GatewayRequest request, EnrichmentRules rules);
    EnrichmentRules getEnrichmentRulesForRoute(String routeId);
}
```

### 3.4 ErrorResponseHandler

バックエンドエラーを統一的な形式に変換するコンポーネントです。

**主要機能**:
- エラーコードの標準化
- エラーメッセージの整形
- 詳細情報の構造化
- デバッグ情報の環境依存制御
- ロケール依存のエラーメッセージ生成

```java
public interface ErrorResponseHandler {
    GatewayResponse handleError(GatewayResponse backendResponse, ErrorHandlingRules rules);
    boolean isErrorResponse(GatewayResponse response);
    ErrorHandlingRules getErrorHandlingRulesForRoute(String routeId);
}
```

### 3.5 ResponseOptimizer

レスポンスの最適化を行うコンポーネントです。

**主要機能**:
- 圧縮（gzip, deflate等）
- キャッシュヘッダー設定
- 条件付きレスポンス（ETag, If-Modified-Since等）
- 部分レスポンス（fields指定による必要データのみ返却）
- ストリーミング処理

```java
public interface ResponseOptimizer {
    GatewayResponse optimize(GatewayResponse response, GatewayRequest request, OptimizationRules rules);
    OptimizationRules getOptimizationRulesForRoute(String routeId);
}
```

### 3.6 ResponseFilterChain

レスポンス処理の流れを制御するフィルターチェーンです。

**主要機能**:
- フィルターの順次適用
- 条件付き処理
- エラーハンドリング
- 処理の中断制御

```java
public interface ResponseFilterChain {
    FilterResult applyFilters(GatewayResponse response, GatewayRequest request, List<ResponseFilter> filters);
    void registerFilter(ResponseFilter filter, int order);
}
```

## 4. 処理フロー

### 4.1 基本的なレスポンス処理フロー

```
1. バックエンドからレスポンス受信
   ↓
2. ErrorResponseHandler.isErrorResponse()でエラー判定
   ↓
3. エラーの場合 → ErrorResponseHandler.handleError()でエラー変換
   エラーでない場合 → 次のステップへ
   ↓
4. ResponseTransformer.transform()でレスポンス変換
   ↓
5. ResponseFilter.filter()でレスポンスフィルタリング
   ↓
6. ResponseEnricher.enrich()でレスポンス拡張
   ↓
7. ResponseOptimizer.optimize()でレスポンス最適化
   ↓
8. ResponseFilterChain.applyFilters()でフィルター適用
   ↓
9. 処理済みレスポンスをクライアントへ返却
```

### 4.2 フィルター処理フロー

```
1. フィルターチェーン開始
   ↓
2. フィルター#1実行
   ↓
3. 継続判定 - 中断ならその結果を返却
   ↓
4. フィルター#2実行
   ↓
5. 継続判定 - 中断ならその結果を返却
   ↓
   ...
6. 最終フィルター実行
   ↓
7. 処理済みレスポンス返却
```

## 5. レスポンス処理ルールの設計

### 5.1 変換ルール

変換ルールは以下の要素で構成されます：

**構造変換**:
- **restructure**: レスポンス構造の再構成
- **wrapContent**: コンテンツのラッピング（例：`data`フィールド内へ配置）
- **unwrapContent**: コンテンツの展開（例：ネストされたオブジェクトの展開）

**フィールド変換**:
- **renameField**: フィールド名変更（camelCase ⇔ snake_case 等）
- **moveField**: フィールドの移動（階層変更）
- **typeConversion**: データ型変換
- **formatValue**: 値のフォーマット変更（日付形式等）

**コレクション変換**:
- **flattenArray**: 配列のフラット化
- **groupItems**: 項目のグループ化
- **sortItems**: 項目のソート
- **limitItems**: 項目数の制限

### 5.2 フィルタールール

フィルタールールは以下の要素で構成されます：

**セキュリティフィルタリング**:
- **maskFields**: 機密情報のマスキング
- **removeFields**: 機密フィールドの完全除去
- **filterByRole**: ユーザーロールに基づくフィールドフィルタリング
- **retainOnly**: 指定フィールドのみ保持

**データ最適化**:
- **removeEmpty**: 空要素の除去
- **removeNulls**: null値の除去
- **removeDuplicates**: 重複データの除去
- **truncateStrings**: 文字列の切り詰め

**バージョニング**:
- **compatibilityMode**: 古いAPIバージョン互換のためのフィルタリング
- **featureToggle**: 機能フラグに応じた項目表示/非表示

### 5.3 拡張ルール

拡張ルールは以下の要素で構成されます：

**メタデータ追加**:
- **addPagination**: ページネーション情報の追加
- **addTiming**: 処理時間情報の追加
- **addApiVersion**: APIバージョン情報の追加
- **addRequestId**: リクエストID参照の追加

**コンテキスト情報**:
- **addLinks**: HATEOASリンクの追加
- **addRelations**: 関連リソースへの参照追加
- **addStatus**: リソース状態情報の追加

**デバッグ情報**:
- **addDebugInfo**: 開発環境向けデバッグ情報の追加（環境依存）
- **addTraceability**: トレーサビリティ情報の追加

### 5.4 エラー処理ルール

エラー処理ルールは以下の要素で構成されます：

**エラーマッピング**:
- **statusMapping**: HTTPステータスコードの変換マッピング
- **codeMapping**: エラーコードの変換マッピング
- **messageTemplate**: エラーメッセージの変換テンプレート

**エラー詳細**:
- **includeDetails**: 詳細エラー情報の含め方
- **includeStackTrace**: スタックトレース情報の含め方（環境依存）
- **includeValidationErrors**: バリデーションエラー詳細の含め方

**エラーローカライズ**:
- **messageLocalization**: エラーメッセージの多言語化
- **fallbackLanguage**: メッセージ未翻訳時のフォールバック言語

### 5.5 最適化ルール

最適化ルールは以下の要素で構成されます：

**圧縮設定**:
- **compressionEnabled**: 圧縮の有効化条件
- **compressionThreshold**: 圧縮を適用するサイズ閾値
- **compressionLevel**: 圧縮レベル（速度vs圧縮率）

**キャッシュ設定**:
- **cacheControl**: キャッシュ制御ヘッダー設定
- **maxAge**: キャッシュ有効期間
- **etagEnabled**: ETag生成の有効化
- **varyHeaders**: Varyヘッダー設定

**条件付きレスポンス**:
- **conditionalGet**: 条件付きGETの有効化
- **ifModifiedSince**: If-Modified-Since処理の設定
- **ifNoneMatch**: If-None-Match処理の設定

## 6. 主要ユースケース

### 6.1 標準レスポンス形式への変換

バックエンドから様々な形式で返されるレスポンスを標準形式に変換します。

**バックエンドレスポンス例**:
```json
{
  "engineers": [
    {
      "engineerId": 101,
      "first_name": "太郎",
      "last_name": "山田",
      "skills": ["Java", "Spring", "AWS"],
      "years_experience": 5,
      "hourly_rate": 5000
    },
    {
      "engineerId": 102,
      "first_name": "花子",
      "last_name": "鈴木",
      "skills": ["JavaScript", "React", "Node.js"],
      "years_experience": 3,
      "hourly_rate": 4500
    }
  ],
  "total": 2
}
```

**変換ルール設定**:
```json
{
  "routeId": "api-engineers-search",
  "transformationRules": {
    "wrapContent": {
      "source": "engineers",
      "target": "data.items"
    },
    "moveField": {
      "source": "total",
      "target": "data.total"
    },
    "eachItem": {
      "renameField": [
        {"from": "engineerId", "to": "id"},
        {"from": "first_name", "to": "firstName"},
        {"from": "last_name", "to": "lastName"},
        {"from": "years_experience", "to": "yearsExperience"},
        {"from": "hourly_rate", "to": "hourlyRate"}
      ]
    }
  }
}
```

**変換後のレスポンス**:
```json
{
  "data": {
    "items": [
      {
        "id": 101,
        "firstName": "太郎",
        "lastName": "山田",
        "skills": ["Java", "Spring", "AWS"],
        "yearsExperience": 5,
        "hourlyRate": 5000
      },
      {
        "id": 102,
        "firstName": "花子",
        "lastName": "鈴木",
        "skills": ["JavaScript", "React", "Node.js"],
        "yearsExperience": 3,
        "hourlyRate": 4500
      }
    ],
    "total": 2
  }
}
```

### 6.2 ページネーション情報の拡張

レスポンスにページネーション情報を追加します。

**バックエンドレスポンス例**:
```json
{
  "content": [
    {"id": 1, "name": "SES案件A"},
    {"id": 2, "name": "SES案件B"}
  ],
  "totalElements": 54,
  "size": 10,
  "number": 0
}
```

**拡張ルール設定**:
```json
{
  "routeId": "api-projects-list",
  "transformationRules": {
    "renameField": [
      {"from": "content", "to": "data"},
      {"from": "totalElements", "to": "meta.pagination.totalCount"},
      {"from": "size", "to": "meta.pagination.perPage"},
      {"from": "number", "to": "meta.pagination.currentPage"}
    ]
  },
  "enrichmentRules": {
    "addPagination": {
      "enabled": true,
      "calculateFields": [
        {"name": "meta.pagination.totalPages", "expression": "math.ceil(meta.pagination.totalCount / meta.pagination.perPage)"},
        {"name": "meta.pagination.hasNext", "expression": "meta.pagination.currentPage < meta.pagination.totalPages - 1"},
        {"name": "meta.pagination.hasPrevious", "expression": "meta.pagination.currentPage > 0"}
      ],
      "addLinks": true
    }
  }
}
```

**拡張後のレスポンス**:
```json
{
  "data": [
    {"id": 1, "name": "SES案件A"},
    {"id": 2, "name": "SES案件B"}
  ],
  "meta": {
    "pagination": {
      "totalCount": 54,
      "perPage": 10,
      "currentPage": 0,
      "totalPages": 6,
      "hasNext": true,
      "hasPrevious": false
    },
    "links": {
      "self": "/api/v1/projects?page=0&size=10",
      "next": "/api/v1/projects?page=1&size=10",
      "last": "/api/v1/projects?page=5&size=10"
    }
  }
}
```

### 6.3 機密情報のフィルタリング

レスポンスから機密情報を除去またはマスクします。

**バックエンドレスポンス例**:
```json
{
  "id": "contract-101",
  "title": "システム開発委託契約",
  "clientName": "株式会社ABC",
  "startDate": "2025-06-01",
  "endDate": "2025-12-31",
  "valuePerMonth": 3500000,
  "totalValue": 24500000,
  "bankAccount": {
    "bankName": "サンプル銀行",
    "branch": "本店",
    "accountType": "普通",
    "accountNumber": "1234567",
    "accountName": "カブシキガイシャXYZ"
  },
  "contractTerms": "契約条項の詳細...",
  "signatories": [
    {
      "name": "佐藤一郎",
      "position": "代表取締役",
      "email": "sato@example.com",
      "phone": "03-1234-5678"
    }
  ]
}
```

**フィルタリングルール設定**:
```json
{
  "routeId": "api-contracts-detail",
  "filteringRules": {
    "roleBasedFiltering": {
      "ADMIN": {
        "removeFields": []
      },
      "MANAGER": {
        "removeFields": ["bankAccount.accountNumber"]
      },
      "USER": {
        "removeFields": ["bankAccount", "totalValue", "signatories.email", "signatories.phone"]
      }
    },
    "maskFields": [
      {
        "fields": ["bankAccount.accountNumber"],
        "maskPattern": "xxxx-{last4}",
        "roles": ["MANAGER"]
      }
    ]
  }
}
```

**USER権限でフィルタリング後のレスポンス**:
```json
{
  "id": "contract-101",
  "title": "システム開発委託契約",
  "clientName": "株式会社ABC",
  "startDate": "2025-06-01",
  "endDate": "2025-12-31",
  "valuePerMonth": 3500000,
  "contractTerms": "契約条項の詳細...",
  "signatories": [
    {
      "name": "佐藤一郎",
      "position": "代表取締役"
    }
  ]
}
```

### 6.4 エラーレスポンスの標準化

バックエンドから返される様々な形式のエラーを標準形式に変換します。

**バックエンドエラーレスポンス例**:
```json
{
  "timestamp": "2025-05-11T15:30:45.123+0900",
  "status": 400,
  "error": "Bad Request",
  "errors": [
    {
      "property": "startDate",
      "message": "must be a future date",
      "code": "Future"
    },
    {
      "property": "email",
      "message": "must be a well-formed email address",
      "code": "Email"
    }
  ],
  "message": "Validation failed",
  "path": "/api/engineers"
}
```

**エラー変換ルール設定**:
```json
{
  "routeId": "api-engineers-create",
  "errorHandlingRules": {
    "statusMapping": {
      "400": 400,
      "404": 404,
      "500": 500
    },
    "standardErrorFormat": {
      "structure": {
        "error": {
          "code": "mapStatus",
          "message": "selectMessage",
          "details": "mapValidationErrors",
          "requestId": "addRequestId",
          "timestamp": "useTimestamp"
        }
      },
      "messageMappings": {
        "400": "入力内容に誤りがあります",
        "404": "指定されたリソースが見つかりません",
        "500": "システムエラーが発生しました"
      },
      "validationErrorMapping": {
        "sourceField": "errors",
        "targetStructure": {
          "field": "property",
          "message": "message",
          "code": "code"
        }
      }
    }
  }
}
```

**変換後のエラーレスポンス**:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力内容に誤りがあります",
    "details": [
      {
        "field": "startDate",
        "message": "must be a future date",
        "code": "Future"
      },
      {
        "field": "email",
        "message": "must be a well-formed email address",
        "code": "Email"
      }
    ],
    "requestId": "req-1234567890abcdef",
    "timestamp": "2025-05-11T15:30:45.123+0900"
  }
}
```

## 7. エラーハンドリング

レスポンス処理機能におけるエラーハンドリングは以下のように設計されています：

### 7.1 変換エラー

- **構造不一致**: バックエンドレスポンスが想定構造と異なる場合、オリジナルレスポンスを返却
- **変換失敗**: 変換処理中にエラーが発生した場合、ログに記録し、オリジナルレスポンスを返却
- **型変換エラー**: データ型変換に失敗した場合、オリジナル値を維持してレスポンスを返却

### 7.2 フィルタリングエラー

- **パス解決失敗**: 指定されたフィールドパスが見つからない場合、処理をスキップして続行
- **フィルター適用エラー**: フィルター適用中にエラーが発生した場合、適用をスキップして続行

### 7.3 拡張エラー

- **拡張データ生成エラー**: 拡張データ生成に失敗した場合、その部分のみスキップして続行
- **リンク生成エラー**: HATEOAS/リンク生成に失敗した場合、リンクなしでレスポンスを返却

### 7.4 エラー伝播防止

レスポンス処理中のエラーがクライアントに露出しないように以下の対策を実施します：

- レスポンス処理エラーの詳細ログ記録
- 処理中のエラーをキャッチし、適切なフォールバック処理
- 変換不可能な場合はオリジナルレスポンスを返却
- 重大なエラーが発生した場合のみ、統一形式のシステムエラーレスポンスを返却

## 8. 監視とメトリクス

### 8.1 収集メトリクス

レスポンス処理機能は以下のメトリクスを収集します：

| メトリクス名 | 種類 | 説明 |
|------------|------|------|
| gateway.response.transformation.total | カウンター | 変換処理実行回数 |
| gateway.response.transformation.errors | カウンター | 変換エラー数 |
| gateway.response.filtering.total | カウンター | フィルタリング実行回数 |
| gateway.response.filtering.errors | カウンター | フィルタリングエラー数 |
| gateway.response.enrichment.total | カウンター | 拡張処理実行回数 |
| gateway.response.enrichment.errors | カウンター | 拡張エラー数 |
| gateway.response.size.original | ヒストグラム | 元のレスポンスサイズ分布 |
| gateway.response.size.processed | ヒストグラム | 処理後のレスポンスサイズ分布 |
| gateway.response.processing.time | ヒストグラム | レスポンス処理時間分布 |

### 8.2 アラート条件

以下の条件に基づいてアラートを発行します：

| アラート名 | 条件 | 重要度 | アクション |
|-----------|------|-------|----------|
| ResponseTransformationErrorRate | 変換エラー率が5%超 | 中 | 変換ルールの見直し |
| ResponseProcessingLatency | 処理時間が50ms超 | 中 | パフォーマンス調査 |
| ErrorResponseMappingFailure | エラー変換失敗率が10%超 | 高 | エラー変換ルールの検証 |

## 9. パフォーマンス最適化

### 9.1 最適化手法

レスポンス処理機能のパフォーマンスを最適化するために以下の手法を採用しています：

1. **変換ルールのコンパイル**: 頻繁に使用される変換ルールのコンパイルによる高速化
2. **部分処理**: 特定のフィールドのみを対象とした効率的な処理
3. **遅延評価**: 必要になるまで変換処理を遅延させる最適化
4. **並列処理**: 互いに独立した処理の並列実行
5. **ストリーム処理**: 大きなレスポンスのストリーム処理による省メモリ化

### 9.2 レスポンスサイズ最適化

1. **圧縮処理**: gzip/deflate等による圧縮（Accept-Encodingヘッダーに基づく）
2. **部分レスポンス**: fieldsパラメータによる必要フィールドのみ返却
3. **不要データ除去**: null値や空配列の省略
4. **コンパクトJSON**: 空白の最小化

### 9.3 キャッシュ最適化

1. **条件付きGET**: ETag/If-Modified-Since対応によるトラフィック削減
2. **キャッシュ指示**: Cache-Control/Expiresヘッダーの最適設定
3. **バリエーションキャッシュ**: Accept/Accept-Language等に応じたキャッシュ管理

## 10. 今後の拡張性

レスポンス処理機能は以下の拡張性を考慮して設計されています：

1. **カスタムプロセッサー**: ルートごとの専用レスポンス処理プロセッサーのプラグイン対応
2. **レスポンス形式の多様化**: JSON以外の形式（XML, Protobuf等）への対応
3. **スキーマ検証**: OpenAPI/JSONスキーマによるレスポンス検証
4. **カスタムセキュリティポリシー**: 独自セキュリティルールによるフィルタリング
5. **多言語対応の拡張**: 動的なメッセージ翻訳と地域化
6. **レスポンススクリプティング**: JSONPath/JMESPathによる動的レスポンス加工