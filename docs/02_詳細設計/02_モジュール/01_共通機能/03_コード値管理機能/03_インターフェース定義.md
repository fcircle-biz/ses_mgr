# コード値管理機能 - インターフェース定義

## 1. インターフェース概要

コード値管理機能は、SES業務システム全体に対してコード値（マスタデータ）を提供するための標準的なインターフェースを定義します。本インターフェースは、参照機能と管理機能の2つの主要な責務に分かれています。

## 2. 提供インターフェース

### 2.1 CodeService

コード値参照のための主要インターフェースです。システム全体のあらゆるモジュールがコード値を参照するために使用します。

```java
public interface CodeService {
    /**
     * システムで利用可能なすべてのコードカテゴリを取得する
     * @return コードカテゴリDTOのリスト
     */
    List<CodeCategoryDTO> findAllCategories();
    
    /**
     * 指定されたカテゴリに属するコード値の一覧を取得する
     * @param categoryId カテゴリID
     * @param keyword 検索キーワード（任意）
     * @param parentCode 親コード（任意、階層構造の場合）
     * @param activeOnly 有効なコード値のみ取得するフラグ（デフォルトtrue）
     * @return コード値DTOのリスト
     * @throws EntityNotFoundException カテゴリが存在しない場合
     */
    List<CodeValueDTO> findByCategory(String categoryId, String keyword, String parentCode, Boolean activeOnly);
    
    /**
     * 指定されたカテゴリとコードの組み合わせによるコード値の詳細情報を取得する
     * @param categoryId カテゴリID
     * @param code コード値
     * @return コード値詳細DTO
     * @throws EntityNotFoundException コード値が存在しない場合
     */
    CodeValueDetailDTO findByCode(String categoryId, String code);
    
    /**
     * 階層構造を持つコード値の階層ツリーを取得する
     * @param categoryId カテゴリID
     * @param activeOnly 有効なコード値のみ取得するフラグ（デフォルトtrue）
     * @return 階層構造化されたコード値のツリー
     * @throws EntityNotFoundException カテゴリが存在しない場合
     */
    CodeValueTreeDTO getCodeValueTree(String categoryId, Boolean activeOnly);
    
    /**
     * 指定されたカテゴリIDとコード値一覧から名称マッピングを取得する
     * @param categoryId カテゴリID
     * @param codes コード値のリスト
     * @return コード値と名称のマッピング
     * @throws EntityNotFoundException カテゴリが存在しない場合
     */
    Map<String, String> getCodeNameMap(String categoryId, List<String> codes);
    
    /**
     * コード値のキャッシュを更新する
     * @param categoryId カテゴリID（nullの場合は全カテゴリ）
     */
    void refreshCache(String categoryId);
}
```

### 2.2 AdminCodeService

コード値管理のための管理用インターフェースです。主にシステム管理機能から使用されます。

```java
public interface AdminCodeService {
    /**
     * 新しいコードカテゴリを作成する
     * @param categoryDTO 作成用DTO
     * @return 作成されたコードカテゴリDTO
     * @throws DuplicateEntityException カテゴリIDが既に存在する場合
     * @throws ValidationException バリデーションエラーの場合
     */
    CodeCategoryDTO createCategory(CodeCategoryCreateDTO categoryDTO);
    
    /**
     * コードカテゴリを更新する
     * @param id カテゴリID
     * @param categoryDTO 更新用DTO
     * @return 更新されたコードカテゴリDTO
     * @throws EntityNotFoundException カテゴリが存在しない場合
     * @throws ValidationException バリデーションエラーの場合
     */
    CodeCategoryDTO updateCategory(String id, CodeCategoryUpdateDTO categoryDTO);
    
    /**
     * コードカテゴリを削除する
     * @param id カテゴリID
     * @throws EntityNotFoundException カテゴリが存在しない場合
     * @throws BusinessRuleException 削除できないカテゴリの場合またはコード値が存在する場合
     */
    void deleteCategory(String id);
    
    /**
     * 新しいコード値を作成する
     * @param categoryId カテゴリID
     * @param codeValueDTO 作成用DTO
     * @return 作成されたコード値DTO
     * @throws EntityNotFoundException カテゴリが存在しない場合
     * @throws DuplicateEntityException コード値が既に存在する場合
     * @throws ValidationException バリデーションエラーの場合
     */
    CodeValueDTO createCodeValue(String categoryId, CodeValueCreateDTO codeValueDTO);
    
    /**
     * コード値を更新する
     * @param categoryId カテゴリID
     * @param code コード値
     * @param codeValueDTO 更新用DTO
     * @return 更新されたコード値DTO
     * @throws EntityNotFoundException コード値が存在しない場合
     * @throws ValidationException バリデーションエラーの場合
     */
    CodeValueDTO updateCodeValue(String categoryId, String code, CodeValueUpdateDTO codeValueDTO);
    
    /**
     * コード値を削除する
     * @param categoryId カテゴリID
     * @param code コード値
     * @throws EntityNotFoundException コード値が存在しない場合
     * @throws BusinessRuleException 削除できないコード値の場合または参照されている場合
     */
    void deleteCodeValue(String categoryId, String code);
    
    /**
     * コード値の有効/無効を切り替える
     * @param categoryId カテゴリID
     * @param code コード値
     * @param active 有効/無効フラグ
     * @return 更新されたコード値DTO
     * @throws EntityNotFoundException コード値が存在しない場合
     */
    CodeValueDTO toggleCodeValueActive(String categoryId, String code, boolean active);
    
    /**
     * CSVファイルからコード値を一括インポートする
     * @param categoryId カテゴリID
     * @param inputStream CSVファイルの入力ストリーム
     * @param mode インポートモード（追加/更新/全置換）
     * @return インポート結果
     * @throws EntityNotFoundException カテゴリが存在しない場合
     * @throws ValidationException CSVフォーマットエラーの場合
     */
    ImportResult importCodeValues(String categoryId, InputStream inputStream, ImportMode mode);
    
    /**
     * コード値をCSVファイルにエクスポートする
     * @param categoryId カテゴリID
     * @param outputStream 出力ストリーム
     * @throws EntityNotFoundException カテゴリが存在しない場合
     */
    void exportCodeValues(String categoryId, OutputStream outputStream);
    
    /**
     * コード値の変更履歴を取得する
     * @param categoryId カテゴリID
     * @param code コード値
     * @param pageable ページング情報
     * @return コード値履歴DTOのページング結果
     */
    Page<CodeValueHistoryDTO> getCodeValueHistory(String categoryId, String code, Pageable pageable);
}
```

## 3. 要求インターフェース

### 3.1 AuditLogService

ロギング機能モジュールから提供される監査ログサービスを利用します。

```java
// ロギング機能モジュールが提供するインターフェース（参照のみ）
public interface AuditLogService {
    void recordAuditLog(String action, String resourceType, String resourceId, 
                       String performedBy, Map<String, Object> details);
    Page<AuditLogDTO> searchAuditLogs(AuditLogSearchCriteria criteria, Pageable pageable);
}
```

**使用目的と文脈**:
- コード値の作成、更新、削除操作の監査ログ記録
- コード値カテゴリの作成、更新、削除操作の監査ログ記録
- コード値の一括インポート操作のサマリーログ記録

**依存度**: 中
- 監査ログ記録はコード値管理機能の主要な処理ではないが、操作追跡のために重要

### 3.2 CacheService

共通インフラから提供されるキャッシュサービスを利用します。

```java
// 共通インフラが提供するインターフェース（参照のみ）
public interface CacheService {
    <T> T get(String cacheName, String key, Class<T> type);
    <T> void put(String cacheName, String key, T value);
    void remove(String cacheName, String key);
    void clear(String cacheName);
    boolean containsKey(String cacheName, String key);
}
```

**使用目的と文脈**:
- コード値データのキャッシング
- カテゴリごとのキャッシュ管理
- コード値更新時のキャッシュ更新

**依存度**: 高
- コード値は頻繁に参照されるため、パフォーマンス向上のためにキャッシュが重要

## 4. データ交換モデル

### 4.1 コードカテゴリ関連DTO

```java
// コードカテゴリDTO
public class CodeCategoryDTO {
    private String id;
    private String name;
    private String description;
    private Integer sortOrder;
    private Integer codeCount;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    // getters, setters
}

// コードカテゴリ作成DTO
public class CodeCategoryCreateDTO {
    private String id;
    private String name;
    private String description;
    private Integer sortOrder;
    // getters, setters, validation
}

// コードカテゴリ更新DTO
public class CodeCategoryUpdateDTO {
    private String name;
    private String description;
    private Integer sortOrder;
    // getters, setters, validation
}
```

### 4.2 コード値関連DTO

```java
// コード値基本DTO
public class CodeValueDTO {
    private String code;
    private String name;
    private String description;
    private Integer sortOrder;
    private boolean isActive;
    private Map<String, Object> attributes;
    private String parentCode;
    // getters, setters
}

// コード値詳細DTO
public class CodeValueDetailDTO {
    private CodeCategoryDTO category;
    private String code;
    private String name;
    private String description;
    private Integer sortOrder;
    private boolean isActive;
    private Map<String, Object> attributes;
    private String parentCode;
    private List<String> childCodes;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    // getters, setters
}

// コード値ツリーDTO
public class CodeValueTreeDTO {
    private String code;
    private String name;
    private boolean isActive;
    private List<CodeValueTreeDTO> children;
    // getters, setters
}

// コード値作成DTO
public class CodeValueCreateDTO {
    private String code;
    private String name;
    private String description;
    private Integer sortOrder;
    private boolean isActive;
    private Map<String, Object> attributes;
    private String parentCode;
    // getters, setters, validation
}

// コード値更新DTO
public class CodeValueUpdateDTO {
    private String name;
    private String description;
    private Integer sortOrder;
    private boolean isActive;
    private Map<String, Object> attributes;
    private String parentCode;
    // getters, setters, validation
}

// コード値履歴DTO
public class CodeValueHistoryDTO {
    private UUID id;
    private String categoryId;
    private String code;
    private OperationType operationType;
    private Map<String, Object> beforeValue;
    private Map<String, Object> afterValue;
    private String operatedBy;
    private LocalDateTime operatedAt;
    // getters, setters
}
```

### 4.3 インポート・エクスポート関連DTO

```java
// インポートモードEnum
public enum ImportMode {
    ADD,      // 新規追加のみ
    UPDATE,   // 既存データの更新のみ
    REPLACE   // 既存データを全て削除して置き換え
}

// インポート結果DTO
public class ImportResult {
    private int total;
    private int success;
    private int error;
    private String summary;
    private List<ImportError> errors;
    private String errorReportUrl;
    // getters, setters
}

// インポートエラーDTO
public class ImportError {
    private int line;
    private String code;
    private String reason;
    // getters, setters
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- コード値一覧取得: レスポンス時間100ms以内（キャッシュ使用時）
- コード値詳細取得: レスポンス時間50ms以内（キャッシュ使用時）
- コード値更新後のキャッシュ更新: 500ms以内
- コード値一括インポート: 1,000件/5秒以内

### 5.2 キャッシュ戦略

- コード値はカテゴリ単位でキャッシュ
- キャッシュの有効期限: 60分（デフォルト）
- コード値更新時にカテゴリのキャッシュをクリア
- アプリケーション起動時に全カテゴリのキャッシュを事前ロード（オプション）

### 5.3 トランザクション管理

- コード値登録・更新・削除: REQUIRED
- コード値の一括インポート: REQUIRED
- コード値参照操作: SUPPORTS（読み取りのみの場合）または NOT_SUPPORTED（キャッシュからの読み取りの場合）

### 5.4 スレッドセーフティ

- コード値キャッシュは並行アクセスに対応
- コード値更新操作は楽観的ロックを使用して競合を検出
- 一括インポート処理中は当該カテゴリへの他の更新操作をブロック