# コード値管理機能 - コード値管理機能

## 1. 機能概要

コード値管理機能は、システム管理者がSES業務システムで使用されるコード値（マスタデータ）を管理するための機能を提供します。
この機能により、新しいコード値の追加、既存コード値の編集、不要なコード値の削除・無効化、および一括インポート/エクスポートが可能になります。
コード値の一貫性と整合性を確保しつつ、拡張性と柔軟性を備えた管理手段を提供します。

## 2. 主要コンポーネント構成

コード値管理機能は以下のコンポーネントで構成されます：

### 2.1 コンポーネント構成図

```
                    ┌───────────────────┐
                    │ AdminCodeController │
                    └─────────┬─────────┘
                              │
                              ▼
┌─────────────────┐   ┌───────────────────┐   ┌──────────────────┐
│   CodeService   │◄──┤  AdminCodeService  │──►│  AuditLogService  │
└─────────────────┘   └─────────┬─────────┘   └──────────────────┘
                               │
                               ▼
                    ┌───────────────────┐
                    │  CodeRepository   │
                    └───────────────────┘
```

### 2.2 コンポーネント説明

- **AdminCodeController**: コード値管理のRESTful APIエンドポイントを提供
- **AdminCodeService**: コード値管理のビジネスロジックを実装
- **CodeRepository**: コード値データのデータアクセス層
- **CodeService**: コード値参照サービス（キャッシュ更新のために利用）
- **AuditLogService**: 監査ログ記録サービス

## 3. 処理フロー

### 3.1 カテゴリ作成フロー

```
1. システム管理者がカテゴリ作成APIを呼び出し
2. AdminCodeController.createCategory()メソッドが実行される
3. AdminCodeService.createCategory()メソッドが呼び出される
   3.1. カテゴリIDの重複チェック
   3.2. バリデーション実行
   3.3. カテゴリエンティティの作成
   3.4. カテゴリの保存
   3.5. AuditLogServiceによる監査ログ記録
   3.6. CodeServiceによるキャッシュ更新
4. 作成結果をクライアントに返却
```

### 3.2 カテゴリ更新フロー

```
1. システム管理者がカテゴリ更新APIを呼び出し
2. AdminCodeController.updateCategory()メソッドが実行される
3. AdminCodeService.updateCategory()メソッドが呼び出される
   3.1. カテゴリの存在確認
   3.2. バリデーション実行
   3.3. カテゴリ情報の更新
   3.4. 更新カテゴリの保存
   3.5. AuditLogServiceによる監査ログ記録
   3.6. CodeServiceによるキャッシュ更新
4. 更新結果をクライアントに返却
```

### 3.3 コード値作成フロー

```
1. システム管理者がコード値作成APIを呼び出し
2. AdminCodeController.createCodeValue()メソッドが実行される
3. AdminCodeService.createCodeValue()メソッドが呼び出される
   3.1. カテゴリの存在確認
   3.2. コード値の重複チェック
   3.3. 親コードの存在確認（階層構造の場合）
   3.4. バリデーション実行
   3.5. コード値エンティティの作成
   3.6. コード値の保存
   3.7. AuditLogServiceによる監査ログ記録
   3.8. CodeServiceによるキャッシュ更新
4. 作成結果をクライアントに返却
```

### 3.4 コード値更新フロー

```
1. システム管理者がコード値更新APIを呼び出し
2. AdminCodeController.updateCodeValue()メソッドが実行される
3. AdminCodeService.updateCodeValue()メソッドが呼び出される
   3.1. コード値の存在確認
   3.2. 親コードの存在確認と循環参照チェック（階層構造の場合）
   3.3. バリデーション実行
   3.4. 変更前の状態を履歴用に保存
   3.5. コード値情報の更新
   3.6. 更新されたコード値の保存
   3.7. AuditLogServiceによる監査ログ記録
   3.8. CodeServiceによるキャッシュ更新
4. 更新結果をクライアントに返却
```

### 3.5 コード値削除/無効化フロー

```
1. システム管理者がコード値削除APIを呼び出し
2. AdminCodeController.deleteCodeValue()メソッドが実行される
3. AdminCodeService.deleteCodeValue()メソッドが呼び出される
   3.1. コード値の存在確認
   3.2. システム定義コード値チェック（削除不可）
   3.3. 参照関係チェック
   3.4. 子コード値の存在確認
   3.5. 参照または子コードがある場合は無効化、なければ削除を実行
   3.6. AuditLogServiceによる監査ログ記録
   3.7. CodeServiceによるキャッシュ更新
4. 処理結果をクライアントに返却
```

### 3.6 コード値の一括インポートフロー

```
1. システム管理者がCSVファイルを選択してインポートAPIを呼び出し
2. AdminCodeController.importCodeValues()メソッドが実行される
3. AdminCodeService.importCodeValues()メソッドが呼び出される
   3.1. カテゴリの存在確認
   3.2. CSVファイルの解析とバリデーション
   3.3. インポートモードに応じた処理（追加/更新/全置換）
   3.4. バッチ処理によるコード値の一括保存
   3.5. エラー発生時は処理を継続し、エラーレポートを作成
   3.6. AuditLogServiceによる監査ログ記録
   3.7. CodeServiceによるキャッシュ更新
4. インポート結果サマリーをクライアントに返却
```

### 3.7 コード値の一括エクスポートフロー

```
1. システム管理者がエクスポートAPIを呼び出し
2. AdminCodeController.exportCodeValues()メソッドが実行される
3. AdminCodeService.exportCodeValues()メソッドが呼び出される
   3.1. カテゴリの存在確認
   3.2. カテゴリ内のすべてのコード値を取得
   3.3. CSVフォーマットへの変換
   3.4. レスポンスへのCSVデータ書き込み
   3.5. AuditLogServiceによる監査ログ記録
4. CSVファイルをクライアントにダウンロード提供
```

## 4. 実装詳細

### 4.1 AdminCodeController 実装

```java
@RestController
@RequestMapping("/api/v1/admin/codes")
public class AdminCodeController {

    private final AdminCodeService adminCodeService;
    
    @Autowired
    public AdminCodeController(AdminCodeService adminCodeService) {
        this.adminCodeService = adminCodeService;
    }
    
    // カテゴリ管理API
    
    @PostMapping
    public ResponseEntity<CodeCategoryDTO> createCategory(@RequestBody @Valid CodeCategoryCreateDTO categoryDTO) {
        try {
            CodeCategoryDTO createdCategory = adminCodeService.createCategory(categoryDTO);
            return ResponseEntity.status(HttpStatus.CREATED).body(createdCategory);
        } catch (DuplicateEntityException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT).build();
        } catch (ValidationException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        }
    }
    
    @PutMapping("/{categoryId}")
    public ResponseEntity<CodeCategoryDTO> updateCategory(
            @PathVariable String categoryId,
            @RequestBody @Valid CodeCategoryUpdateDTO categoryDTO) {
        
        try {
            CodeCategoryDTO updatedCategory = adminCodeService.updateCategory(categoryId, categoryDTO);
            return ResponseEntity.ok(updatedCategory);
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        } catch (ValidationException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        }
    }
    
    @DeleteMapping("/{categoryId}")
    public ResponseEntity<Void> deleteCategory(@PathVariable String categoryId) {
        try {
            adminCodeService.deleteCategory(categoryId);
            return ResponseEntity.ok().build();
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        } catch (BusinessRuleException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        }
    }
    
    // コード値管理API
    
    @PostMapping("/{categoryId}/values")
    public ResponseEntity<CodeValueDTO> createCodeValue(
            @PathVariable String categoryId,
            @RequestBody @Valid CodeValueCreateDTO codeValueDTO) {
        
        try {
            CodeValueDTO createdValue = adminCodeService.createCodeValue(categoryId, codeValueDTO);
            return ResponseEntity.status(HttpStatus.CREATED).body(createdValue);
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        } catch (DuplicateEntityException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT).build();
        } catch (ValidationException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        }
    }
    
    @PutMapping("/{categoryId}/values/{code}")
    public ResponseEntity<CodeValueDTO> updateCodeValue(
            @PathVariable String categoryId,
            @PathVariable String code,
            @RequestBody @Valid CodeValueUpdateDTO codeValueDTO) {
        
        try {
            CodeValueDTO updatedValue = adminCodeService.updateCodeValue(categoryId, code, codeValueDTO);
            return ResponseEntity.ok(updatedValue);
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        } catch (ValidationException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        } catch (BusinessRuleException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        }
    }
    
    @DeleteMapping("/{categoryId}/values/{code}")
    public ResponseEntity<Void> deleteCodeValue(@PathVariable String categoryId, @PathVariable String code) {
        try {
            adminCodeService.deleteCodeValue(categoryId, code);
            return ResponseEntity.ok().build();
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        } catch (BusinessRuleException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        }
    }
    
    @PutMapping("/{categoryId}/values/{code}/active")
    public ResponseEntity<CodeValueDTO> toggleCodeValueActive(
            @PathVariable String categoryId,
            @PathVariable String code,
            @RequestBody Map<String, Boolean> activeStatus) {
        
        try {
            boolean active = activeStatus.getOrDefault("active", false);
            CodeValueDTO updatedValue = adminCodeService.toggleCodeValueActive(categoryId, code, active);
            return ResponseEntity.ok(updatedValue);
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        }
    }
    
    // 一括インポート/エクスポートAPI
    
    @PostMapping("/{categoryId}/import")
    public ResponseEntity<ImportResult> importCodeValues(
            @PathVariable String categoryId,
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "mode", defaultValue = "ADD") ImportMode mode) {
        
        try {
            ImportResult result = adminCodeService.importCodeValues(categoryId, file.getInputStream(), mode);
            return ResponseEntity.ok(result);
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        } catch (ValidationException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        } catch (IOException e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).build();
        }
    }
    
    @GetMapping("/{categoryId}/export")
    public void exportCodeValues(
            @PathVariable String categoryId,
            HttpServletResponse response) {
        
        try {
            response.setContentType("text/csv");
            response.setHeader("Content-Disposition", "attachment; filename=\"" + categoryId + "_codes.csv\"");
            
            adminCodeService.exportCodeValues(categoryId, response.getOutputStream());
        } catch (EntityNotFoundException e) {
            response.setStatus(HttpServletResponse.SC_NOT_FOUND);
        } catch (IOException e) {
            response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
        }
    }
    
    // 履歴API
    
    @GetMapping("/{categoryId}/values/{code}/history")
    public ResponseEntity<Page<CodeValueHistoryDTO>> getCodeValueHistory(
            @PathVariable String categoryId,
            @PathVariable String code,
            Pageable pageable) {
        
        try {
            Page<CodeValueHistoryDTO> history = adminCodeService.getCodeValueHistory(categoryId, code, pageable);
            return ResponseEntity.ok(history);
        } catch (EntityNotFoundException e) {
            return ResponseEntity.notFound().build();
        }
    }
}
```

### 4.2 AdminCodeServiceImpl 実装

```java
@Service
@Transactional
public class AdminCodeServiceImpl implements AdminCodeService {

    private final CodeCategoryRepository categoryRepository;
    private final CodeValueRepository codeValueRepository;
    private final CodeValueHistoryRepository historyRepository;
    private final CodeService codeService;
    private final AuditLogService auditLogService;
    private final ObjectMapper objectMapper;
    
    @Autowired
    public AdminCodeServiceImpl(
            CodeCategoryRepository categoryRepository,
            CodeValueRepository codeValueRepository,
            CodeValueHistoryRepository historyRepository,
            CodeService codeService,
            AuditLogService auditLogService,
            ObjectMapper objectMapper) {
        this.categoryRepository = categoryRepository;
        this.codeValueRepository = codeValueRepository;
        this.historyRepository = historyRepository;
        this.codeService = codeService;
        this.auditLogService = auditLogService;
        this.objectMapper = objectMapper;
    }
    
    @Override
    public CodeCategoryDTO createCategory(CodeCategoryCreateDTO categoryDTO) {
        // ID重複チェック
        if (categoryRepository.existsById(categoryDTO.getId())) {
            throw new DuplicateEntityException("Category with id " + categoryDTO.getId() + " already exists");
        }
        
        // バリデーション実行
        validateCategoryId(categoryDTO.getId());
        
        // カテゴリエンティティの作成
        CodeCategory category = new CodeCategory();
        category.setId(categoryDTO.getId());
        category.setName(categoryDTO.getName());
        category.setDescription(categoryDTO.getDescription());
        category.setSortOrder(categoryDTO.getSortOrder());
        
        LocalDateTime now = LocalDateTime.now();
        category.setCreatedAt(now);
        category.setUpdatedAt(now);
        
        // カテゴリの保存
        CodeCategory savedCategory = categoryRepository.save(category);
        
        // 監査ログ記録
        recordAuditLog("CREATE_CATEGORY", "CODE_CATEGORY", savedCategory.getId(),
                Map.of("name", savedCategory.getName()));
        
        // キャッシュ更新
        codeService.refreshCache(null);
        
        return convertToCategoryDTO(savedCategory);
    }
    
    @Override
    public CodeCategoryDTO updateCategory(String id, CodeCategoryUpdateDTO categoryDTO) {
        // カテゴリの存在確認
        CodeCategory category = categoryRepository.findById(id)
                .orElseThrow(() -> new EntityNotFoundException("Category not found with id: " + id));
        
        // 更新前の値を保持
        String oldName = category.getName();
        
        // カテゴリ情報の更新
        category.setName(categoryDTO.getName());
        category.setDescription(categoryDTO.getDescription());
        category.setSortOrder(categoryDTO.getSortOrder());
        category.setUpdatedAt(LocalDateTime.now());
        
        // 更新カテゴリの保存
        CodeCategory updatedCategory = categoryRepository.save(category);
        
        // 監査ログ記録
        recordAuditLog("UPDATE_CATEGORY", "CODE_CATEGORY", updatedCategory.getId(),
                Map.of("oldName", oldName, "newName", updatedCategory.getName()));
        
        // キャッシュ更新
        codeService.refreshCache(id);
        
        return convertToCategoryDTO(updatedCategory);
    }
    
    @Override
    public void deleteCategory(String id) {
        // カテゴリの存在確認
        CodeCategory category = categoryRepository.findById(id)
                .orElseThrow(() -> new EntityNotFoundException("Category not found with id: " + id));
        
        // システム定義カテゴリチェック
        if (isSystemDefinedCategory(id)) {
            throw new BusinessRuleException("System defined category cannot be deleted: " + id);
        }
        
        // コード値の存在確認
        long codeCount = codeValueRepository.countByCategoryId(id);
        if (codeCount > 0) {
            throw new BusinessRuleException("Category contains " + codeCount + " code values and cannot be deleted");
        }
        
        // カテゴリの削除
        categoryRepository.delete(category);
        
        // 監査ログ記録
        recordAuditLog("DELETE_CATEGORY", "CODE_CATEGORY", id,
                Map.of("name", category.getName()));
        
        // キャッシュ更新
        codeService.refreshCache(null);
    }
    
    @Override
    public CodeValueDTO createCodeValue(String categoryId, CodeValueCreateDTO codeValueDTO) {
        // カテゴリの存在確認
        if (!categoryRepository.existsById(categoryId)) {
            throw new EntityNotFoundException("Category not found with id: " + categoryId);
        }
        
        // コード値の重複チェック
        CodeValueId id = new CodeValueId(categoryId, codeValueDTO.getCode());
        if (codeValueRepository.existsById(id)) {
            throw new DuplicateEntityException("Code value already exists: " + codeValueDTO.getCode());
        }
        
        // 親コードの存在確認
        if (codeValueDTO.getParentCode() != null) {
            CodeValueId parentId = new CodeValueId(categoryId, codeValueDTO.getParentCode());
            if (!codeValueRepository.existsById(parentId)) {
                throw new EntityNotFoundException("Parent code not found: " + codeValueDTO.getParentCode());
            }
        }
        
        // バリデーション実行
        validateCodeValue(codeValueDTO);
        
        // コード値エンティティの作成
        CodeValue codeValue = new CodeValue();
        codeValue.setId(id);
        codeValue.setCode(codeValueDTO.getCode());
        codeValue.setCategoryId(categoryId);
        codeValue.setName(codeValueDTO.getName());
        codeValue.setDescription(codeValueDTO.getDescription());
        codeValue.setSortOrder(codeValueDTO.getSortOrder());
        codeValue.setActive(codeValueDTO.isActive());
        codeValue.setParentCode(codeValueDTO.getParentCode());
        
        // 追加属性の処理
        if (codeValueDTO.getAttributes() != null) {
            try {
                String attributesJson = objectMapper.writeValueAsString(codeValueDTO.getAttributes());
                codeValue.setAttributes(attributesJson);
            } catch (JsonProcessingException e) {
                throw new ValidationException("Invalid attributes format");
            }
        }
        
        LocalDateTime now = LocalDateTime.now();
        codeValue.setCreatedAt(now);
        codeValue.setUpdatedAt(now);
        
        // コード値の保存
        CodeValue savedCodeValue = codeValueRepository.save(codeValue);
        
        // 履歴レコードの作成
        createHistory(savedCodeValue, OperationType.CREATE, null);
        
        // 監査ログ記録
        recordAuditLog("CREATE_CODE_VALUE", "CODE_VALUE", categoryId + ":" + savedCodeValue.getCode(),
                Map.of("name", savedCodeValue.getName()));
        
        // キャッシュ更新
        codeService.refreshCache(categoryId);
        
        return convertToCodeValueDTO(savedCodeValue);
    }
    
    @Override
    public CodeValueDTO updateCodeValue(String categoryId, String code, CodeValueUpdateDTO codeValueDTO) {
        // コード値の存在確認
        CodeValueId id = new CodeValueId(categoryId, code);
        CodeValue codeValue = codeValueRepository.findById(id)
                .orElseThrow(() -> new EntityNotFoundException("Code value not found: " + categoryId + ":" + code));
        
        // 親コードの存在確認と循環参照チェック
        if (codeValueDTO.getParentCode() != null && 
            !codeValueDTO.getParentCode().equals(codeValue.getParentCode())) {
            
            // 親コードの存在確認
            CodeValueId parentId = new CodeValueId(categoryId, codeValueDTO.getParentCode());
            if (!codeValueRepository.existsById(parentId)) {
                throw new EntityNotFoundException("Parent code not found: " + codeValueDTO.getParentCode());
            }
            
            // 循環参照チェック
            if (code.equals(codeValueDTO.getParentCode()) || 
                isCircularReference(categoryId, codeValueDTO.getParentCode(), code)) {
                throw new BusinessRuleException("Circular reference detected");
            }
        }
        
        // システム定義コード値の場合の制限チェック
        if (isSystemDefinedCodeValue(categoryId, code)) {
            validateSystemCodeValueUpdate(codeValue, codeValueDTO);
        }
        
        // 変更前の状態を保持
        CodeValue oldCodeValue = cloneCodeValue(codeValue);
        
        // コード値情報の更新
        codeValue.setName(codeValueDTO.getName());
        codeValue.setDescription(codeValueDTO.getDescription());
        codeValue.setSortOrder(codeValueDTO.getSortOrder());
        codeValue.setActive(codeValueDTO.isActive());
        codeValue.setParentCode(codeValueDTO.getParentCode());
        
        // 追加属性の処理
        if (codeValueDTO.getAttributes() != null) {
            try {
                String attributesJson = objectMapper.writeValueAsString(codeValueDTO.getAttributes());
                codeValue.setAttributes(attributesJson);
            } catch (JsonProcessingException e) {
                throw new ValidationException("Invalid attributes format");
            }
        }
        
        codeValue.setUpdatedAt(LocalDateTime.now());
        
        // 更新されたコード値の保存
        CodeValue updatedCodeValue = codeValueRepository.save(codeValue);
        
        // 履歴レコードの作成
        createHistory(updatedCodeValue, OperationType.UPDATE, oldCodeValue);
        
        // 監査ログ記録
        recordAuditLog("UPDATE_CODE_VALUE", "CODE_VALUE", categoryId + ":" + updatedCodeValue.getCode(),
                Map.of("name", updatedCodeValue.getName()));
        
        // キャッシュ更新
        codeService.refreshCache(categoryId);
        
        return convertToCodeValueDTO(updatedCodeValue);
    }
    
    @Override
    public void deleteCodeValue(String categoryId, String code) {
        // コード値の存在確認
        CodeValueId id = new CodeValueId(categoryId, code);
        CodeValue codeValue = codeValueRepository.findById(id)
                .orElseThrow(() -> new EntityNotFoundException("Code value not found: " + categoryId + ":" + code));
        
        // システム定義コード値チェック
        if (isSystemDefinedCodeValue(categoryId, code)) {
            throw new BusinessRuleException("System defined code value cannot be deleted: " + code);
        }
        
        // 子コード値の存在確認
        List<CodeValue> childValues = codeValueRepository.findByCategoryIdAndParentCode(categoryId, code);
        if (!childValues.isEmpty()) {
            throw new BusinessRuleException("Code value has " + childValues.size() + " child values and cannot be deleted");
        }
        
        // 参照関係チェック（実装例では省略）
        boolean isReferenced = false; // 実際には参照テーブルをチェックする
        
        if (isReferenced) {
            // 参照されている場合は無効化のみ
            codeValue.setActive(false);
            codeValue.setUpdatedAt(LocalDateTime.now());
            codeValueRepository.save(codeValue);
            
            // 履歴レコードの作成
            createHistory(codeValue, OperationType.DEACTIVATE, null);
            
            // 監査ログ記録
            recordAuditLog("DEACTIVATE_CODE_VALUE", "CODE_VALUE", categoryId + ":" + code,
                    Map.of("name", codeValue.getName(), "reason", "Referenced by other entities"));
        } else {
            // 参照されていない場合は物理削除
            codeValueRepository.delete(codeValue);
            
            // 履歴レコードの作成（削除前の状態を保存）
            createHistory(codeValue, OperationType.DELETE, null);
            
            // 監査ログ記録
            recordAuditLog("DELETE_CODE_VALUE", "CODE_VALUE", categoryId + ":" + code,
                    Map.of("name", codeValue.getName()));
        }
        
        // キャッシュ更新
        codeService.refreshCache(categoryId);
    }
    
    @Override
    public CodeValueDTO toggleCodeValueActive(String categoryId, String code, boolean active) {
        // コード値の存在確認
        CodeValueId id = new CodeValueId(categoryId, code);
        CodeValue codeValue = codeValueRepository.findById(id)
                .orElseThrow(() -> new EntityNotFoundException("Code value not found: " + categoryId + ":" + code));
        
        // 変更前の状態を保持
        CodeValue oldCodeValue = cloneCodeValue(codeValue);
        
        // 有効/無効の切り替え
        codeValue.setActive(active);
        codeValue.setUpdatedAt(LocalDateTime.now());
        
        // 更新されたコード値の保存
        CodeValue updatedCodeValue = codeValueRepository.save(codeValue);
        
        // 履歴レコードの作成
        createHistory(updatedCodeValue, active ? OperationType.ACTIVATE : OperationType.DEACTIVATE, oldCodeValue);
        
        // 監査ログ記録
        recordAuditLog(active ? "ACTIVATE_CODE_VALUE" : "DEACTIVATE_CODE_VALUE",
                "CODE_VALUE", categoryId + ":" + code,
                Map.of("name", codeValue.getName()));
        
        // キャッシュ更新
        codeService.refreshCache(categoryId);
        
        return convertToCodeValueDTO(updatedCodeValue);
    }
    
    @Override
    public ImportResult importCodeValues(String categoryId, InputStream inputStream, ImportMode mode) {
        // カテゴリの存在確認
        if (!categoryRepository.existsById(categoryId)) {
            throw new EntityNotFoundException("Category not found with id: " + categoryId);
        }
        
        ImportResult result = new ImportResult();
        result.setTotal(0);
        result.setSuccess(0);
        result.setError(0);
        List<ImportError> errors = new ArrayList<>();
        
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream, StandardCharsets.UTF_8));
             CSVReader csvReader = new CSVReader(reader)) {
            
            // ヘッダー行の読み込み
            String[] header = csvReader.readNext();
            if (header == null || !validateCsvHeader(header)) {
                throw new ValidationException("Invalid CSV format: header is missing or invalid");
            }
            
            // REPLACEモードの場合、既存のコード値をすべて削除（システム定義値を除く）
            if (mode == ImportMode.REPLACE) {
                deleteNonSystemCodeValues(categoryId);
            }
            
            // CSVデータの読み込みと処理
            String[] line;
            int lineNumber = 1;
            List<CodeValue> codeValuesToSave = new ArrayList<>();
            
            while ((line = csvReader.readNext()) != null) {
                lineNumber++;
                result.setTotal(result.getTotal() + 1);
                
                try {
                    // CSVデータからコード値オブジェクトを作成
                    CodeValue codeValue = createCodeValueFromCsvLine(categoryId, header, line);
                    
                    // 既存のコード値をチェック
                    CodeValueId id = new CodeValueId(categoryId, codeValue.getCode());
                    boolean exists = codeValueRepository.existsById(id);
                    
                    if (exists) {
                        if (mode == ImportMode.ADD) {
                            // ADDモードでは既存のコード値はスキップ
                            ImportError error = new ImportError();
                            error.setLine(lineNumber);
                            error.setCode(codeValue.getCode());
                            error.setReason("Code already exists");
                            errors.add(error);
                            result.setError(result.getError() + 1);
                            continue;
                        } else if (mode == ImportMode.UPDATE) {
                            // UPDATEモードでは既存のコード値を更新
                            CodeValue existingValue = codeValueRepository.findById(id).orElse(null);
                            if (existingValue != null) {
                                // システム定義コード値の場合は基本情報のみ更新
                                if (isSystemDefinedCodeValue(categoryId, codeValue.getCode())) {
                                    existingValue.setName(codeValue.getName());
                                    existingValue.setDescription(codeValue.getDescription());
                                    existingValue.setSortOrder(codeValue.getSortOrder());
                                } else {
                                    // 通常のコード値は全項目更新
                                    existingValue.setName(codeValue.getName());
                                    existingValue.setDescription(codeValue.getDescription());
                                    existingValue.setSortOrder(codeValue.getSortOrder());
                                    existingValue.setActive(codeValue.isActive());
                                    existingValue.setParentCode(codeValue.getParentCode());
                                    existingValue.setAttributes(codeValue.getAttributes());
                                }
                                existingValue.setUpdatedAt(LocalDateTime.now());
                                codeValuesToSave.add(existingValue);
                            }
                        }
                    } else {
                        // 新規コード値の追加
                        if (mode == ImportMode.UPDATE) {
                            // UPDATEモードでは新規追加はスキップ
                            ImportError error = new ImportError();
                            error.setLine(lineNumber);
                            error.setCode(codeValue.getCode());
                            error.setReason("Code does not exist for update");
                            errors.add(error);
                            result.setError(result.getError() + 1);
                            continue;
                        } else {
                            // ADD/REPLACEモードでは新規追加
                            LocalDateTime now = LocalDateTime.now();
                            codeValue.setCreatedAt(now);
                            codeValue.setUpdatedAt(now);
                            codeValuesToSave.add(codeValue);
                        }
                    }
                    
                    result.setSuccess(result.getSuccess() + 1);
                    
                } catch (Exception e) {
                    // 行の処理中にエラーが発生した場合
                    ImportError error = new ImportError();
                    error.setLine(lineNumber);
                    error.setCode(line.length > 0 ? line[0] : "unknown");
                    error.setReason(e.getMessage());
                    errors.add(error);
                    result.setError(result.getError() + 1);
                }
            }
            
            // 一括保存
            if (!codeValuesToSave.isEmpty()) {
                codeValueRepository.saveAll(codeValuesToSave);
            }
            
        } catch (Exception e) {
            throw new ValidationException("CSV processing error: " + e.getMessage());
        }
        
        // 結果サマリーの設定
        result.setErrors(errors);
        result.setSummary(result.getSuccess() + " of " + result.getTotal() + 
                " code values were imported successfully, with " + result.getError() + " errors");
        
        // エラーレポートの生成
        if (!errors.isEmpty()) {
            String errorReportId = generateErrorReportId();
            result.setErrorReportUrl("/api/v1/admin/codes/" + categoryId + "/import/errors/" + errorReportId);
            // エラーレポートの保存（実装省略）
        }
        
        // 監査ログ記録
        recordAuditLog("IMPORT_CODE_VALUES", "CODE_CATEGORY", categoryId,
                Map.of("mode", mode.name(), "total", result.getTotal(), 
                     "success", result.getSuccess(), "error", result.getError()));
        
        // キャッシュ更新
        codeService.refreshCache(categoryId);
        
        return result;
    }
    
    @Override
    public void exportCodeValues(String categoryId, OutputStream outputStream) {
        // カテゴリの存在確認
        if (!categoryRepository.existsById(categoryId)) {
            throw new EntityNotFoundException("Category not found with id: " + categoryId);
        }
        
        try (OutputStreamWriter writer = new OutputStreamWriter(outputStream, StandardCharsets.UTF_8);
             CSVWriter csvWriter = new CSVWriter(writer)) {
            
            // ヘッダー行の書き込み
            String[] header = {"code", "name", "description", "sortOrder", "isActive", "parentCode", "attributes"};
            csvWriter.writeNext(header);
            
            // カテゴリ内のすべてのコード値を取得
            List<CodeValue> codeValues = codeValueRepository.findByCategoryIdOrderBySortOrder(categoryId);
            
            // コード値データの書き込み
            for (CodeValue codeValue : codeValues) {
                String[] line = {
                    codeValue.getCode(),
                    codeValue.getName(),
                    codeValue.getDescription() != null ? codeValue.getDescription() : "",
                    String.valueOf(codeValue.getSortOrder()),
                    String.valueOf(codeValue.isActive()),
                    codeValue.getParentCode() != null ? codeValue.getParentCode() : "",
                    codeValue.getAttributes() != null ? codeValue.getAttributes() : ""
                };
                csvWriter.writeNext(line);
            }
            
            // フラッシュして書き込みを確定
            csvWriter.flush();
            
            // 監査ログ記録
            recordAuditLog("EXPORT_CODE_VALUES", "CODE_CATEGORY", categoryId,
                    Map.of("count", codeValues.size()));
            
        } catch (IOException e) {
            throw new RuntimeException("Failed to export code values: " + e.getMessage());
        }
    }
    
    @Override
    public Page<CodeValueHistoryDTO> getCodeValueHistory(String categoryId, String code, Pageable pageable) {
        // コード値の存在確認
        CodeValueId id = new CodeValueId(categoryId, code);
        if (!codeValueRepository.existsById(id)) {
            throw new EntityNotFoundException("Code value not found: " + categoryId + ":" + code);
        }
        
        // 履歴レコードの取得
        Page<CodeValueHistory> historyPage = historyRepository.findByCategoryIdAndCodeOrderByOperatedAtDesc(
                categoryId, code, pageable);
        
        // DTOへの変換
        return historyPage.map(this::convertToHistoryDTO);
    }
    
    // ヘルパーメソッド
    
    private void validateCategoryId(String categoryId) {
        if (!categoryId.matches("^[a-z0-9_]{3,32}$")) {
            throw new ValidationException("Category ID must contain only lowercase letters, numbers, and underscores, and be 3-32 characters long");
        }
    }
    
    private void validateCodeValue(CodeValueCreateDTO codeValueDTO) {
        if (!codeValueDTO.getCode().matches("^[A-Za-z0-9_-]{1,32}$")) {
            throw new ValidationException("Code must contain only letters, numbers, hyphens, and underscores, and be 1-32 characters long");
        }
        
        if (codeValueDTO.getName() == null || codeValueDTO.getName().isEmpty()) {
            throw new ValidationException("Name is required");
        }
        
        if (codeValueDTO.getName().length() > 100) {
            throw new ValidationException("Name must be 100 characters or less");
        }
        
        if (codeValueDTO.getDescription() != null && codeValueDTO.getDescription().length() > 500) {
            throw new ValidationException("Description must be 500 characters or less");
        }
        
        if (codeValueDTO.getSortOrder() <= 0) {
            throw new ValidationException("Sort order must be a positive integer");
        }
    }
    
    private boolean isSystemDefinedCategory(String categoryId) {
        // システム定義カテゴリかどうかをチェック
        Set<String> systemCategories = Set.of(
                "error_code", "system_config", "notification_template", "report_template");
        return systemCategories.contains(categoryId);
    }
    
    private boolean isSystemDefinedCodeValue(String categoryId, String code) {
        // システム定義コード値かどうかをチェック
        // 実際の実装では、システム定義コード値のリストをDB等で管理することが考えられる
        if (categoryId.equals("job_type")) {
            return Set.of("PM", "SE", "PG").contains(code);
        } else if (categoryId.equals("contract_type")) {
            return Set.of("DELEGATE", "OUTSOURCE", "DISPATCH").contains(code);
        }
        return false;
    }
    
    private boolean isCircularReference(String categoryId, String parentCode, String currentCode) {
        // 循環参照をチェック
        if (parentCode == null) {
            return false;
        }
        
        // parentCodeが現在のコードと同じであれば循環参照
        if (parentCode.equals(currentCode)) {
            return true;
        }
        
        // parentCodeの親コードを取得
        CodeValueId parentId = new CodeValueId(categoryId, parentCode);
        Optional<CodeValue> parentOpt = codeValueRepository.findById(parentId);
        
        if (parentOpt.isPresent()) {
            String grandParentCode = parentOpt.get().getParentCode();
            if (grandParentCode != null) {
                // 再帰的に親をたどって循環参照をチェック
                return isCircularReference(categoryId, grandParentCode, currentCode);
            }
        }
        
        return false;
    }
    
    private void validateSystemCodeValueUpdate(CodeValue codeValue, CodeValueUpdateDTO updateDTO) {
        // システム定義コード値の場合、変更できる項目を制限
        // 例: コード、親子関係などは変更不可
        if (!Objects.equals(codeValue.getParentCode(), updateDTO.getParentCode())) {
            throw new BusinessRuleException("Parent code cannot be changed for system defined code values");
        }
    }
    
    private CodeValue cloneCodeValue(CodeValue original) {
        // コード値の複製を作成
        CodeValue clone = new CodeValue();
        clone.setId(original.getId());
        clone.setCode(original.getCode());
        clone.setCategoryId(original.getCategoryId());
        clone.setName(original.getName());
        clone.setDescription(original.getDescription());
        clone.setSortOrder(original.getSortOrder());
        clone.setActive(original.isActive());
        clone.setParentCode(original.getParentCode());
        clone.setAttributes(original.getAttributes());
        clone.setCreatedAt(original.getCreatedAt());
        clone.setUpdatedAt(original.getUpdatedAt());
        return clone;
    }
    
    private void createHistory(CodeValue codeValue, OperationType operationType, CodeValue oldValue) {
        // 履歴レコードの作成
        CodeValueHistory history = new CodeValueHistory();
        history.setId(UUID.randomUUID());
        history.setCategoryId(codeValue.getCategoryId());
        history.setCode(codeValue.getCode());
        history.setOperationType(operationType);
        
        // 認証情報からユーザーIDを取得
        String currentUserId = getCurrentUserId();
        history.setOperatedBy(currentUserId);
        history.setOperatedAt(LocalDateTime.now());
        
        // 変更前後の値を設定
        if (oldValue != null) {
            try {
                String beforeJson = objectMapper.writeValueAsString(convertToCodeValueMap(oldValue));
                history.setBeforeValue(beforeJson);
            } catch (JsonProcessingException e) {
                // エラーが発生した場合でも処理を継続
                history.setBeforeValue("{}");
            }
        }
        
        try {
            String afterJson = objectMapper.writeValueAsString(convertToCodeValueMap(codeValue));
            history.setAfterValue(afterJson);
        } catch (JsonProcessingException e) {
            // エラーが発生した場合でも処理を継続
            history.setAfterValue("{}");
        }
        
        // 履歴の保存
        historyRepository.save(history);
    }
    
    private Map<String, Object> convertToCodeValueMap(CodeValue codeValue) {
        // コード値オブジェクトをマップに変換
        Map<String, Object> map = new HashMap<>();
        map.put("code", codeValue.getCode());
        map.put("name", codeValue.getName());
        map.put("description", codeValue.getDescription());
        map.put("sortOrder", codeValue.getSortOrder());
        map.put("isActive", codeValue.isActive());
        map.put("parentCode", codeValue.getParentCode());
        
        // 属性JSONを解析してマップに追加
        if (codeValue.getAttributes() != null && !codeValue.getAttributes().isEmpty()) {
            try {
                @SuppressWarnings("unchecked")
                Map<String, Object> attributes = objectMapper.readValue(codeValue.getAttributes(), Map.class);
                map.put("attributes", attributes);
            } catch (Exception e) {
                map.put("attributes", Collections.emptyMap());
            }
        } else {
            map.put("attributes", Collections.emptyMap());
        }
        
        return map;
    }
    
    private void recordAuditLog(String action, String resourceType, String resourceId, Map<String, Object> details) {
        // 監査ログの記録
        String userId = getCurrentUserId();
        auditLogService.recordAuditLog(action, resourceType, resourceId, userId, details);
    }
    
    private String getCurrentUserId() {
        // 現在の認証情報からユーザーIDを取得
        // 実際の実装ではSpring Securityなどから取得
        return "system"; // ダミー実装
    }
    
    private CodeCategoryDTO convertToCategoryDTO(CodeCategory category) {
        CodeCategoryDTO dto = new CodeCategoryDTO();
        dto.setId(category.getId());
        dto.setName(category.getName());
        dto.setDescription(category.getDescription());
        dto.setSortOrder(category.getSortOrder());
        dto.setCreatedAt(category.getCreatedAt());
        dto.setUpdatedAt(category.getUpdatedAt());
        
        // コード値の件数を設定
        long count = codeValueRepository.countByCategoryId(category.getId());
        dto.setCodeCount((int) count);
        
        return dto;
    }
    
    private CodeValueDTO convertToCodeValueDTO(CodeValue codeValue) {
        CodeValueDTO dto = new CodeValueDTO();
        dto.setCode(codeValue.getCode());
        dto.setName(codeValue.getName());
        dto.setDescription(codeValue.getDescription());
        dto.setSortOrder(codeValue.getSortOrder());
        dto.setActive(codeValue.isActive());
        
        // 属性JSONを解析してマップに変換
        if (codeValue.getAttributes() != null && !codeValue.getAttributes().isEmpty()) {
            try {
                @SuppressWarnings("unchecked")
                Map<String, Object> attributes = objectMapper.readValue(codeValue.getAttributes(), Map.class);
                dto.setAttributes(attributes);
            } catch (Exception e) {
                dto.setAttributes(Collections.emptyMap());
            }
        } else {
            dto.setAttributes(Collections.emptyMap());
        }
        
        dto.setParentCode(codeValue.getParentCode());
        return dto;
    }
    
    private CodeValueHistoryDTO convertToHistoryDTO(CodeValueHistory history) {
        CodeValueHistoryDTO dto = new CodeValueHistoryDTO();
        dto.setId(history.getId());
        dto.setCategoryId(history.getCategoryId());
        dto.setCode(history.getCode());
        dto.setOperationType(history.getOperationType());
        dto.setOperatedBy(history.getOperatedBy());
        dto.setOperatedAt(history.getOperatedAt());
        
        // JSON文字列をマップに変換
        if (history.getBeforeValue() != null && !history.getBeforeValue().isEmpty()) {
            try {
                @SuppressWarnings("unchecked")
                Map<String, Object> beforeValue = objectMapper.readValue(history.getBeforeValue(), Map.class);
                dto.setBeforeValue(beforeValue);
            } catch (Exception e) {
                dto.setBeforeValue(Collections.emptyMap());
            }
        } else {
            dto.setBeforeValue(Collections.emptyMap());
        }
        
        if (history.getAfterValue() != null && !history.getAfterValue().isEmpty()) {
            try {
                @SuppressWarnings("unchecked")
                Map<String, Object> afterValue = objectMapper.readValue(history.getAfterValue(), Map.class);
                dto.setAfterValue(afterValue);
            } catch (Exception e) {
                dto.setAfterValue(Collections.emptyMap());
            }
        } else {
            dto.setAfterValue(Collections.emptyMap());
        }
        
        return dto;
    }
    
    private boolean validateCsvHeader(String[] header) {
        // CSVヘッダーの検証
        List<String> requiredColumns = Arrays.asList("code", "name", "sortOrder");
        return Arrays.asList(header).containsAll(requiredColumns);
    }
    
    private CodeValue createCodeValueFromCsvLine(String categoryId, String[] header, String[] line) {
        // CSVデータからコード値オブジェクトを作成
        if (line.length < header.length) {
            throw new ValidationException("Invalid CSV line: too few columns");
        }
        
        // ヘッダーと値のマッピングを作成
        Map<String, String> values = new HashMap<>();
        for (int i = 0; i < header.length; i++) {
            values.put(header[i], i < line.length ? line[i] : "");
        }
        
        // 必須項目のチェック
        String code = values.get("code");
        String name = values.get("name");
        String sortOrderStr = values.get("sortOrder");
        
        if (code == null || code.isEmpty()) {
            throw new ValidationException("Code is required");
        }
        
        if (name == null || name.isEmpty()) {
            throw new ValidationException("Name is required");
        }
        
        if (sortOrderStr == null || sortOrderStr.isEmpty()) {
            throw new ValidationException("Sort order is required");
        }
        
        // コード値オブジェクトの作成
        CodeValue codeValue = new CodeValue();
        codeValue.setId(new CodeValueId(categoryId, code));
        codeValue.setCode(code);
        codeValue.setCategoryId(categoryId);
        codeValue.setName(name);
        codeValue.setDescription(values.get("description"));
        
        try {
            codeValue.setSortOrder(Integer.parseInt(sortOrderStr));
        } catch (NumberFormatException e) {
            throw new ValidationException("Invalid sort order: " + sortOrderStr);
        }
        
        String isActiveStr = values.get("isActive");
        codeValue.setActive(isActiveStr == null || isActiveStr.isEmpty() ? 
                true : Boolean.parseBoolean(isActiveStr));
        
        String parentCode = values.get("parentCode");
        if (parentCode != null && !parentCode.isEmpty()) {
            // 親コードの存在確認
            CodeValueId parentId = new CodeValueId(categoryId, parentCode);
            if (!codeValueRepository.existsById(parentId)) {
                throw new ValidationException("Parent code not found: " + parentCode);
            }
            codeValue.setParentCode(parentCode);
        }
        
        String attributes = values.get("attributes");
        if (attributes != null && !attributes.isEmpty()) {
            codeValue.setAttributes(attributes);
        }
        
        return codeValue;
    }
    
    private void deleteNonSystemCodeValues(String categoryId) {
        // カテゴリ内の非システム定義コード値を削除
        List<CodeValue> codeValues = codeValueRepository.findByCategoryId(categoryId);
        List<CodeValue> toDelete = new ArrayList<>();
        
        for (CodeValue codeValue : codeValues) {
            if (!isSystemDefinedCodeValue(categoryId, codeValue.getCode())) {
                toDelete.add(codeValue);
            }
        }
        
        if (!toDelete.isEmpty()) {
            codeValueRepository.deleteAll(toDelete);
        }
    }
    
    private String generateErrorReportId() {
        // エラーレポートIDの生成
        return "ERR-" + System.currentTimeMillis();
    }
}
```

## 5. CSV形式の仕様

コード値の一括インポート/エクスポートに使用するCSV形式の仕様を定義します。

### 5.1 基本形式

- 文字コード：UTF-8
- 区切り文字：カンマ（,）
- 引用符：必要に応じてダブルクォーテーション（"）で囲む
- 1行目はヘッダー行とする

### 5.2 必須項目

- `code`: コード値（一意の識別子）
- `name`: 表示名称
- `sortOrder`: 表示順序（整数）

### 5.3 オプション項目

- `description`: 説明文
- `isActive`: 有効/無効フラグ（true/false）
- `parentCode`: 親コード（階層構造の場合）
- `attributes`: 追加属性（JSON形式）

### 5.4 サンプル

```csv
code,name,description,sortOrder,isActive,parentCode,attributes
PM,プロジェクトマネージャ,プロジェクト全体の管理と調整を担当,1,true,,"{""abbreviation"":""PM"",""skillLevel"":""senior"",""gradeRange"":""G4-G6""}"
SE,システムエンジニア,システム設計、開発を担当,2,true,,"{""abbreviation"":""SE"",""skillLevel"":""middle"",""gradeRange"":""G3-G5""}"
PG,プログラマ,プログラム開発を担当,3,true,,"{""abbreviation"":""PG"",""skillLevel"":""junior"",""gradeRange"":""G1-G3""}"
```

## 6. インポートモード

コード値一括インポート時には、以下の3つのモードを提供します：

### 6.1 ADDモード（追加）

- 新規コード値のみを追加
- 既存コード値と重複する場合はエラーとしてスキップ
- システム定義コード値を含む既存データは保持

### 6.2 UPDATEモード（更新）

- 既存コード値のみを更新
- 存在しないコード値はエラーとしてスキップ
- システム定義コード値は基本情報（名称、説明、表示順）のみ更新可能

### 6.3 REPLACEモード（全置換）

- 既存の非システム定義コード値をすべて削除
- CSVファイル内のコード値をすべて追加
- システム定義コード値は削除されず、内容のみ更新

## 7. 例外処理

コード値管理機能では、以下の例外処理を実装します：

### 7.1 例外クラス

```java
// エンティティが存在しない場合の例外
public class EntityNotFoundException extends RuntimeException { /* ... */ }

// エンティティが重複する場合の例外
public class DuplicateEntityException extends RuntimeException { /* ... */ }

// ビジネスルール違反の例外
public class BusinessRuleException extends RuntimeException { /* ... */ }

// バリデーションエラーの例外
public class ValidationException extends RuntimeException { /* ... */ }
```

### 7.2 例外ハンドリング

```java
// 例外ハンドラー
@ControllerAdvice
public class AdminCodeExceptionHandler {
    
    @ExceptionHandler(EntityNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleEntityNotFoundException(EntityNotFoundException ex) {
        ErrorResponse error = new ErrorResponse("NOT_FOUND", ex.getMessage());
        return new ResponseEntity<>(error, HttpStatus.NOT_FOUND);
    }
    
    @ExceptionHandler(DuplicateEntityException.class)
    public ResponseEntity<ErrorResponse> handleDuplicateEntityException(DuplicateEntityException ex) {
        ErrorResponse error = new ErrorResponse("CONFLICT", ex.getMessage());
        return new ResponseEntity<>(error, HttpStatus.CONFLICT);
    }
    
    @ExceptionHandler(BusinessRuleException.class)
    public ResponseEntity<ErrorResponse> handleBusinessRuleException(BusinessRuleException ex) {
        ErrorResponse error = new ErrorResponse("BUSINESS_RULE_VIOLATION", ex.getMessage());
        return new ResponseEntity<>(error, HttpStatus.BAD_REQUEST);
    }
    
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(ValidationException ex) {
        ErrorResponse error = new ErrorResponse("VALIDATION_ERROR", ex.getMessage());
        return new ResponseEntity<>(error, HttpStatus.BAD_REQUEST);
    }
}
```

## 8. 監査ログ

コード値の変更履歴を監査ログとして記録します：

### 8.1 監査ログ記録対象操作

- カテゴリの作成、更新、削除
- コード値の作成、更新、削除、有効化/無効化
- コード値の一括インポート、エクスポート

### 8.2 監査ログ内容

- 操作日時
- 操作ユーザー
- 操作種別（CREATE, UPDATE, DELETE, ACTIVATE, DEACTIVATE, IMPORT, EXPORT）
- 対象リソース（カテゴリID、コード値）
- 操作詳細情報（変更内容サマリー）

### 8.3 コード値履歴

コード値自体の変更履歴も別途保持し、必要時に参照できるようにします：

- 変更前後の値を含む詳細な履歴
- 操作種別ごとの履歴表示
- 履歴の時系列表示

## 9. テスト方針

### 9.1 単体テスト

- AdminCodeServiceの各メソッドのテスト
- 正常系と異常系のシナリオテスト
- システム定義コード値制約のテスト
- 階層構造の整合性チェックテスト

### 9.2 統合テスト

- APIエンドポイント呼び出しの結合テスト
- データベースとの連携テスト
- 監査ログ記録の連携テスト

### 9.3 データ検証テスト

- 大量データのインポート/エクスポートテスト
- データ整合性チェックテスト
- CSVフォーマット異常系テスト