# ロギング機能 インターフェース定義

## 1. インターフェース概要

ロギング機能は、アプリケーション全体に対して一貫したロギングサービスを提供します。このドキュメントでは、ロギング機能が提供するインターフェースと他のモジュールから要求するインターフェースを定義します。

### 1.1 設計方針

- SLF4J APIを基盤としたラッピングインターフェースを提供
- 依存注入可能なインターフェース設計
- アスペクト指向プログラミング(AOP)を活用した宣言的ロギング
- マイクロサービス環境を考慮した分散トレーシング対応

### 1.2 パッケージ構成

```
jp.co.sesmanager.common.logging
  ├── api           // 公開インターフェース
  ├── aop           // アスペクト関連
  ├── config        // 設定クラス
  ├── domain        // ドメインモデル
  ├── internal      // 内部実装
  ├── marker        // ログマーカー
  └── trace         // 分散トレーシング
```

## 2. 提供インターフェース

### 2.1 LoggingFacade

アプリケーションからログを出力するための主要インターフェースです。

```java
package jp.co.sesmanager.common.logging.api;

/**
 * ロギング機能の主要インターフェース
 * システム全体で一貫したロギング方法を提供します
 */
public interface LoggingFacade {
    /**
     * ERRORレベルのログを出力します
     * @param message ログメッセージ（パラメータプレースホルダ{}を含む）
     * @param args メッセージパラメータ
     */
    void error(String message, Object... args);
    
    /**
     * 例外情報を含むERRORレベルのログを出力します
     * @param message ログメッセージ
     * @param t 例外オブジェクト
     * @param args メッセージパラメータ
     */
    void error(String message, Throwable t, Object... args);
    
    /**
     * WARNレベルのログを出力します
     * @param message ログメッセージ
     * @param args メッセージパラメータ
     */
    void warn(String message, Object... args);
    
    /**
     * INFOレベルのログを出力します
     * @param message ログメッセージ
     * @param args メッセージパラメータ
     */
    void info(String message, Object... args);
    
    /**
     * DEBUGレベルのログを出力します
     * @param message ログメッセージ
     * @param args メッセージパラメータ
     */
    void debug(String message, Object... args);
    
    /**
     * TRACEレベルのログを出力します
     * @param message ログメッセージ
     * @param args メッセージパラメータ
     */
    void trace(String message, Object... args);
    
    /**
     * 指定されたログレベルが有効かどうかを確認します
     * @param level ログレベル
     * @return 有効な場合はtrue
     */
    boolean isEnabled(LogLevel level);
    
    /**
     * 現在のロガー名を取得します
     * @return ロガー名
     */
    String getName();
    
    /**
     * MDC（Mapped Diagnostic Context）にキーと値のペアを追加します
     * @param key キー
     * @param value 値
     * @return このインスタンス（メソッドチェーン用）
     */
    LoggingFacade putMdc(String key, String value);
    
    /**
     * MDCから指定されたキーの値を削除します
     * @param key キー
     * @return このインスタンス（メソッドチェーン用）
     */
    LoggingFacade removeMdc(String key);
    
    /**
     * 指定したマーカーを使用してログ出力を行うロガーを取得します
     * @param marker ログマーカー
     * @return マーカー付きロガー
     */
    LoggingFacade withMarker(LoggingMarker marker);
}
```

### 2.2 LoggingFactory

LoggingFacadeインスタンスを取得するためのファクトリーインターフェースです。

```java
package jp.co.sesmanager.common.logging.api;

/**
 * LoggingFacadeインスタンスを生成するファクトリー
 */
public interface LoggingFactory {
    /**
     * 現在のクラス用のロガーを取得します
     * @return LoggingFacadeインスタンス
     */
    LoggingFacade getLogger();
    
    /**
     * 指定されたクラス用のロガーを取得します
     * @param clazz 対象クラス
     * @return LoggingFacadeインスタンス
     */
    LoggingFacade getLogger(Class<?> clazz);
    
    /**
     * 指定された名前のロガーを取得します
     * @param name ロガー名
     * @return LoggingFacadeインスタンス
     */
    LoggingFacade getLogger(String name);
}
```

### 2.3 AuditLogger

監査ログを記録するための専用インターフェースです。

```java
package jp.co.sesmanager.common.logging.api;

import jp.co.sesmanager.common.logging.domain.AuditAction;
import jp.co.sesmanager.common.logging.domain.AuditStatus;

/**
 * 監査ログを記録するためのインターフェース
 */
public interface AuditLogger {
    /**
     * 監査イベントを記録します
     * @param action 実行された操作
     * @param targetType 操作対象の種類
     * @param targetId 操作対象のID
     */
    void logAuditEvent(AuditAction action, String targetType, String targetId);
    
    /**
     * 詳細情報付きの監査イベントを記録します
     * @param action 実行された操作
     * @param targetType 操作対象の種類
     * @param targetId 操作対象のID
     * @param details 詳細情報
     */
    void logAuditEvent(AuditAction action, String targetType, String targetId, String details);
    
    /**
     * ステータス付きの監査イベントを記録します
     * @param action 実行された操作
     * @param targetType 操作対象の種類
     * @param targetId 操作対象のID
     * @param details 詳細情報
     * @param status 操作結果のステータス
     */
    void logAuditEvent(AuditAction action, String targetType, String targetId, 
                      String details, AuditStatus status);
    
    /**
     * すべての情報を指定して監査イベントを記録します
     * @param action 実行された操作
     * @param targetType 操作対象の種類
     * @param targetId 操作対象のID
     * @param details 詳細情報
     * @param status 操作結果のステータス
     * @param userId ユーザーID（null時は現在のユーザーから取得）
     * @param ipAddress IPアドレス（null時は現在のリクエストから取得）
     */
    void logAuditEvent(AuditAction action, String targetType, String targetId,
                      String details, AuditStatus status, String userId, String ipAddress);
}
```

### 2.4 @AuditLog アノテーション

監査ログを宣言的に記録するためのアノテーションです。

```java
package jp.co.sesmanager.common.logging.aop;

import jp.co.sesmanager.common.logging.domain.AuditAction;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * メソッド実行時に監査ログを記録するためのアノテーション
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AuditLog {
    /**
     * 実行される操作
     */
    AuditAction action();
    
    /**
     * 操作対象の種類
     */
    String targetType();
    
    /**
     * 操作対象IDを取得するためのパラメータ名またはSpEL式
     * 空文字の場合はメソッドの戻り値から取得を試みる
     */
    String targetIdExpression() default "";
    
    /**
     * 詳細情報を取得するためのSpEL式
     */
    String detailsExpression() default "";
}
```

### 2.5 PerformanceLogger

パフォーマンス情報を記録するためのインターフェースです。

```java
package jp.co.sesmanager.common.logging.api;

/**
 * パフォーマンス測定結果を記録するためのインターフェース
 */
public interface PerformanceLogger {
    /**
     * メソッド実行時間を記録します
     * @param methodName メソッド名
     * @param durationMs 実行時間（ミリ秒）
     */
    void recordExecutionTime(String methodName, long durationMs);
    
    /**
     * クラスとメソッドを指定して実行時間を記録します
     * @param className クラス名
     * @param methodName メソッド名
     * @param durationMs 実行時間（ミリ秒）
     */
    void recordExecutionTime(String className, String methodName, long durationMs);
    
    /**
     * 処理結果を含めて実行時間を記録します
     * @param className クラス名
     * @param methodName メソッド名
     * @param durationMs 実行時間（ミリ秒）
     * @param success 処理成功フラグ
     */
    void recordExecutionTime(String className, String methodName, long durationMs, boolean success);
    
    /**
     * しきい値情報を含めて実行時間を記録します
     * @param className クラス名
     * @param methodName メソッド名
     * @param durationMs 実行時間（ミリ秒）
     * @param thresholdMs 警告閾値（ミリ秒）
     * @param success 処理成功フラグ
     */
    void recordExecutionTime(String className, String methodName, long durationMs, 
                           long thresholdMs, boolean success);
}
```

### 2.6 @LogPerformance アノテーション

メソッドの実行時間を測定して記録するためのアノテーションです。

```java
package jp.co.sesmanager.common.logging.aop;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * メソッドの実行時間を測定するためのアノテーション
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LogPerformance {
    /**
     * 実行時間の警告閾値（ミリ秒）
     * この値を超えると警告ログが出力されます
     */
    long thresholdMs() default 0;
    
    /**
     * ログに記録する情報レベル
     * INFO: 常に記録
     * WARN: 閾値超過時のみ記録
     */
    String level() default "INFO";
}
```

### 2.7 TracingContext

分散トレーシング情報を管理するインターフェースです。

```java
package jp.co.sesmanager.common.logging.trace;

/**
 * 分散トレーシング情報を管理するインターフェース
 */
public interface TracingContext {
    /**
     * 現在のトレースIDを取得します
     * @return トレースID
     */
    String getCurrentTraceId();
    
    /**
     * 現在のスパンIDを取得します
     * @return スパンID
     */
    String getCurrentSpanId();
    
    /**
     * 現在のスパンから子スパンを作成します
     * @param spanName スパン名
     * @return 新しいスパンID
     */
    String createChildSpan(String spanName);
    
    /**
     * 現在のスパンを閉じます
     */
    void closeCurrentSpan();
    
    /**
     * バゲージアイテム（トレース間で伝播する情報）を追加します
     * @param key キー
     * @param value 値
     */
    void addBaggageItem(String key, String value);
    
    /**
     * バゲージアイテムを取得します
     * @param key キー
     * @return 値（存在しない場合はnull）
     */
    String getBaggageItem(String key);
    
    /**
     * 現在のトレースコンテキスト情報をMapとして取得します
     * @return トレース情報を含むMap
     */
    Map<String, String> getTraceContext();
    
    /**
     * 指定されたトレースコンテキストを現在のスレッドにバインドします
     * @param traceContext トレースコンテキスト情報
     */
    void setTraceContext(Map<String, String> traceContext);
}
```

### 2.8 LoggingConfiguration

ロギング設定を動的に変更するためのインターフェースです。

```java
package jp.co.sesmanager.common.logging.config;

import ch.qos.logback.classic.Level;

/**
 * ロギング設定を動的に変更するためのインターフェース
 */
public interface LoggingConfiguration {
    /**
     * 指定されたロガーのログレベルを変更します
     * @param loggerName ロガー名
     * @param level 設定するログレベル
     */
    void setLogLevel(String loggerName, Level level);
    
    /**
     * 指定されたロガーの現在のログレベルを取得します
     * @param loggerName ロガー名
     * @return 現在のログレベル
     */
    Level getLogLevel(String loggerName);
    
    /**
     * 全てのロガーとそのログレベルの一覧を取得します
     * @return ロガー名とログレベルのマップ
     */
    Map<String, Level> getAllLogLevels();
    
    /**
     * ロガー設定をリロードします
     */
    void reloadConfiguration();
}
```

## 3. 要求インターフェース

### 3.1 UserContextHolder

ログの出力時にユーザー情報を取得するために必要なインターフェースです。認証認可モジュールから提供されます。

```java
package jp.co.sesmanager.common.auth.context;

/**
 * 現在のユーザーコンテキスト情報を取得するインターフェース
 */
public interface UserContextHolder {
    /**
     * 現在認証されているユーザーコンテキストを取得します
     * @return ユーザーコンテキスト
     */
    UserContext getUserContext();
    
    /**
     * 現在のリクエストからクライアントIPアドレスを取得します
     * @return クライアントIPアドレス
     */
    String getClientIpAddress();
    
    /**
     * 現在のセッションIDを取得します
     * @return セッションID
     */
    String getSessionId();
}
```

### 3.2 ErrorHandler

エラーログ出力時にエラー情報を適切に変換するために必要なインターフェースです。エラー処理モジュールから提供されます。

```java
package jp.co.sesmanager.common.error;

/**
 * エラー情報を処理するインターフェース
 */
public interface ErrorHandler {
    /**
     * 例外をエラー情報に変換します
     * @param exception 例外オブジェクト
     * @return エラー情報
     */
    ErrorInfo convertExceptionToErrorInfo(Throwable exception);
    
    /**
     * エラーコードからエラーメッセージを解決します
     * @param errorCode エラーコード
     * @param args メッセージパラメータ
     * @return 解決されたエラーメッセージ
     */
    String resolveErrorMessage(String errorCode, Object... args);
}
```

## 4. データ交換モデル

### 4.1 LoggingEventDTO

ログイベントをシステム間で交換するためのデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.logging.dto;

import jp.co.sesmanager.common.logging.domain.LogLevel;
import java.time.Instant;
import java.util.Map;

/**
 * ログイベントのデータ転送オブジェクト
 */
public class LoggingEventDTO {
    // 基本情報
    private String id;             // ログID
    private Instant timestamp;     // タイムスタンプ
    private LogLevel level;        // ログレベル
    private String loggerName;     // ロガー名
    private String message;        // ログメッセージ
    private String threadName;     // スレッド名
    
    // アプリケーション情報
    private String applicationName; // アプリケーション名
    private String environmentName; // 環境名
    private String hostName;        // ホスト名
    
    // コンテキスト情報
    private Map<String, String> mdc;  // Mapped Diagnostic Context
    private ThrowableDTO throwable;   // 例外情報
    
    // トレース情報
    private String traceId;        // トレースID
    private String spanId;         // スパンID
    
    // ロギングイベント種別
    private String eventType;      // イベント種別（アプリケーション/監査/パフォーマンス/アクセス）
    
    // 拡張情報（種別ごとの固有情報）
    private Map<String, Object> extendedData;
    
    // 監査情報
    private String userId;         // ユーザーID
    private String action;         // 実行操作
    private String targetType;     // 対象タイプ
    private String targetId;       // 対象ID
    
    // パフォーマンス情報
    private Long durationMs;       // 実行時間
    
    // getter/setterメソッド
}
```

### 4.2 LoggingConfigDTO

ロギング設定を交換するためのデータ転送オブジェクトです。

```java
package jp.co.sesmanager.common.logging.dto;

import java.util.Map;

/**
 * ロギング設定のデータ転送オブジェクト
 */
public class LoggingConfigDTO {
    // ロガー名とログレベルのマッピング
    private Map<String, String> loggerLevels;
    
    // アペンダー設定
    private Map<String, AppenderConfigDTO> appenders;
    
    // その他の設定
    private boolean jsonFormat;              // JSON形式出力フラグ
    private boolean includeCallerData;       // 呼び出し元情報を含めるフラグ
    private boolean includeException;        // 例外情報を含めるフラグ
    private boolean asyncLogging;            // 非同期ロギングフラグ
    private Map<String, String> mdcProperties; // 常時MDCに含めるプロパティ
    
    // getter/setterメソッド
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

1. ロギング処理がアプリケーションパフォーマンスに与える影響を最小化するため、以下の対策を実施します：
   - 非同期ロギングの採用
   - バッファリングによるディスクI/O最適化
   - ログレベルによる出力制御の厳格化

2. パフォーマンスメトリック：
   - ログエントリ1件あたりの処理オーバーヘッド: 0.1ミリ秒以下
   - 大量ログ出力時（1秒間に1000エントリ以上）のスループット低下: 5%以内
   - ディスクI/O待ちによるアプリケーションブロッキング: なし

### 5.2 トランザクション要件

1. ロギング処理とアプリケーショントランザクションの分離：
   - ロギング処理の失敗がビジネストランザクションに影響を与えない設計
   - 重要なログ（監査ログなど）の書き込み失敗時の例外ハンドリング方針

2. 監査ログの整合性保証：
   - 監査ログ書き込みエラー時のリトライ機構
   - 一時的なバッファリングとリカバリ機構

### 5.3 スレッドセーフティ要件

1. マルチスレッド環境での安全性確保：
   - スレッドローカルストレージの適切な利用
   - 非同期ロギングにおける競合状態の回避
   - MDC（Mapped Diagnostic Context）の適切なクリアと管理

### 5.4 スケーラビリティ要件

1. 大量ログ処理への対応：
   - ログローテーションの自動化
   - バッファサイズと非同期キューの適切な設計
   - 分散環境でのログ集約処理の効率化

2. マイクロサービス環境での分散トレーシング：
   - サービス間でのトレースコンテキスト伝播
   - 大規模トレースデータの効率的な収集と保存

### 5.5 セキュリティ要件

1. ログデータの保護：
   - 機密情報のマスキング処理
   - ログファイルのアクセス制御
   - 監査ログの改ざん防止対策

2. 認証情報と個人情報の取り扱い：
   - パスワードやトークンの非ログ化
   - 個人識別情報（PII）の適切な処理