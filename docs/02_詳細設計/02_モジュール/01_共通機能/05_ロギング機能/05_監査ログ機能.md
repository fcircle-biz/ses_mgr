# 監査ログ機能

## 1. 機能概要

監査ログ機能は、システム内の重要な操作や変更を記録し、それらの操作に関する監査証跡を提供する機能です。セキュリティ監査、コンプライアンス対応、操作トレーサビリティの確保などの目的で利用されます。

### 1.1 機能の目的

- 重要な業務操作の記録と追跡
- セキュリティ関連操作の監視と証跡保持
- コンプライアンス要件への対応
- 不正操作の検出と調査
- 操作履歴の管理と監査対応

### 1.2 主要機能

- 監査対象操作の自動記録
- アスペクト指向プログラミング(AOP)による宣言的監査ログ
- ユーザー情報、操作対象、操作結果の詳細記録
- 監査ログの長期保存と検索
- アノテーションベースの簡易監査ログ設定

## 2. 処理フロー

### 2.1 監査ログ記録の基本フロー

```
1. 監査対象メソッドの呼び出し
2. AOPによるメソッド実行前処理
   a. ユーザーコンテキスト情報の取得
   b. 操作内容の決定
   c. 対象リソース情報の取得
   d. 監査ログ「操作試行」の記録
3. 対象メソッドの実行
4. AOPによるメソッド実行後処理
   a. 実行結果のステータス確認
   b. 監査ログ「操作成功」の記録
5. 例外発生時の処理
   a. 例外情報の取得
   b. 監査ログ「操作失敗」の記録
   c. 例外の再スロー
```

### 2.2 監査ログフィルタリングフロー

```
1. 監査対象の評価
   a. 操作種別による評価
   b. リソース種別による評価
   c. ユーザーロールによる評価
2. 監査レベルの決定
   a. 詳細レベル（すべての情報を記録）
   b. 標準レベル（基本情報のみ記録）
   c. 最小レベル（操作種別と結果のみ記録）
3. フィルタリング結果に基づく記録内容の調整
```

### 2.3 監査ログ検索フロー

```
1. 検索条件の指定
   a. 期間指定
   b. ユーザー指定
   c. 操作種別指定
   d. リソース種別指定
   e. 操作結果指定
2. Elasticsearchへの検索クエリ構築
3. 検索実行
4. 結果の整形と返却
```

## 3. 主要コンポーネント構成

### 3.1 AuditLoggerImpl クラス

AuditLoggerインターフェースの実装クラスです。

#### 主要責務
- 監査ログイベントの記録
- ユーザーコンテキスト情報の取得と監査データへの付加
- 監査データの整形と構造化
- 適切なログレベルでの監査情報出力
- 監査ハッシュの生成（オプション）
- システム情報の付加

#### 主要メソッド
- `logAuditEvent(AuditAction action, String targetType, String targetId)` - 基本的な監査ログ出力
- `logAuditEvent(AuditAction action, String targetType, String targetId, String details)` - 詳細付き監査ログ出力
- `logAuditEvent(AuditAction action, String targetType, String targetId, String details, AuditStatus status)` - ステータス付き監査ログ出力
- `logAuditEvent(AuditAction action, String targetType, String targetId, String details, AuditStatus status, String userId, String ipAddress)` - すべての情報を指定した監査ログ出力

### 3.2 AuditLogAspect クラス

`@AuditLog`アノテーションを処理するAOPアスペクトクラスです。

#### 主要責務
- アノテーション付きメソッドのインターセプト
- メソッド実行前の監査ログ記録（操作試行）
- メソッド実行後の監査ログ記録（操作成功）
- 例外発生時の監査ログ記録（操作失敗）
- SpEL式による動的な値解決
- ターゲットIDと詳細情報の解決

#### 主要メソッド
- `auditMethod(ProceedingJoinPoint joinPoint)` - アノテーション処理の主メソッド
- `prepareEvaluationContext(ProceedingJoinPoint joinPoint)` - 評価コンテキストの準備
- `resolveTargetId(AuditLog auditLogAnnotation, EvaluationContext context, ProceedingJoinPoint joinPoint, Object result)` - 対象IDの解決
- `resolveDetails(AuditLog auditLogAnnotation, EvaluationContext context, String defaultDetails)` - 詳細情報の解決

### 3.3 AuditLogConfig クラス

監査ログの設定クラスです。

#### 主要責務
- 監査ログ機能の設定と初期化
- 依存コンポーネントの注入
- 標準監査ロガーの構成
- AOPの有効化

#### 主要Bean定義
- `auditLogger(LoggingFactory loggingFactory, UserContextHolder userContextHolder)` - 監査ロガーのBean定義

### 3.4 AuditLogFilter クラス

RESTリクエストの監査ログを記録するためのフィルタークラスです。

#### 主要責務
- HTTPリクエストの監査ログ自動記録
- リクエスト開始時の監査ログ（操作試行）
- レスポンス返却時の監査ログ（操作成功/失敗）
- HTTPメソッドと監査アクションのマッピング
- ステータスコードに基づく操作結果判定
- 監査対象パスのフィルタリング

#### 主要メソッド
- `doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)` - フィルタ処理の主メソッド
- `isExcludedPath(String path)` - 除外パスの判定
- `isAuditableMethod(String method)` - 監査対象メソッドの判定
- `mapHttpMethodToAction(String method)` - HTTPメソッドと監査アクションのマッピング

## 4. 設定詳細

### 4.1 監査ログ専用のLogback設定

監査ログのみを対象とする専用のLogback設定を行います。主な設定内容は以下の通りです：

- 専用のRollingFileAppenderによるログファイル分割
- LogstashEncoderによるJSON形式ログ出力
- 非同期アペンダーによるパフォーマンス向上
- 長期間のログローテーション設定（2年分）
- 大容量のログキャップ設定（20GB）
- 監査種別に応じたフィルタ

### 4.2 監査ログの保持期間設定

監査ログの種類ごとに異なる保持期間を設定します。主な設定は以下の通りです：

- 認証関連監査ログ：2年間保持
- 権限変更監査ログ：2年間保持
- データ操作監査ログ：1年間保持
- システム設定監査ログ：2年間保持
- 業務操作監査ログ：3ヶ月保持

### 4.3 監査ログ関連のアプリケーション設定

Spring Bootアプリケーションの`application.yml`ファイルでの監査ログ設定例です。主な設定項目は以下の通りです：

- 機能の有効/無効設定
- リクエスト/レスポンスボディの記録有無
- 機密データのマスキング設定
- 監査対象カテゴリ別の設定
- 保持期間設定
- サンプリングレート設定

## 5. 使用例

### 5.1 アノテーションを使用した宣言的監査ログ記録

```
// ユーザー作成時に監査ログを記録
@AuditLog(
    action = AuditAction.CREATE,
    targetType = "USER",
    targetIdExpression = "result.id", // 戻り値から対象IDを取得
    detailsExpression = "'ユーザー作成: ' + #userDto.username"
)
public User createUser(UserDto userDto) {
    // ユーザー作成ロジック
    User user = new User();
    user.setUsername(userDto.getUsername());
    // 他のフィールド設定
    
    userRepository.save(user);
    return user;
}

// ユーザー更新時に監査ログを記録
@AuditLog(
    action = AuditAction.UPDATE,
    targetType = "USER",
    targetIdExpression = "#userId",
    detailsExpression = "'ユーザー更新: ' + #userId + ', 変更項目: ' + #updateDto.getChangedFields()"
)
public User updateUser(String userId, UserUpdateDto updateDto) {
    // ユーザー更新ロジック
    // ...
}

// ユーザー削除時に監査ログを記録
@AuditLog(
    action = AuditAction.DELETE,
    targetType = "USER",
    targetIdExpression = "#userId"
)
public void deleteUser(String userId) {
    // ユーザー削除ロジック
    // ...
}
```

### 5.2 プログラムによる明示的な監査ログ記録

```
// 監査ロガーの注入
@Autowired
private AuditLogger auditLogger;

public Contract approveContract(String contractId, String approverComments) {
    try {
        // 監査ログ - 操作開始
        auditLogger.logAuditEvent(
            AuditAction.APPROVE,
            "CONTRACT",
            contractId,
            "契約承認処理開始",
            AuditStatus.ATTEMPT
        );
        
        // 契約承認処理
        Contract contract = contractRepository.findById(contractId)
            .orElseThrow(() -> new NotFoundException("契約が見つかりません: " + contractId));
        
        // ビジネスロジック
        contract.setStatus(ContractStatus.APPROVED);
        contract.setApproverComments(approverComments);
        contract.setApprovedAt(LocalDateTime.now());
        
        Contract savedContract = contractRepository.save(contract);
        
        // 監査ログ - 操作成功
        auditLogger.logAuditEvent(
            AuditAction.APPROVE,
            "CONTRACT",
            contractId,
            "契約承認処理完了: " + approverComments,
            AuditStatus.SUCCESS
        );
        
        return savedContract;
        
    } catch (Exception e) {
        // 監査ログ - 操作失敗
        auditLogger.logAuditEvent(
            AuditAction.APPROVE,
            "CONTRACT",
            contractId,
            "契約承認処理失敗: " + e.getMessage(),
            AuditStatus.FAILURE
        );
        
        throw e;
    }
}
```

### 5.3 複合オブジェクトの詳細情報を含む監査ログ

```
public Invoice createInvoice(InvoiceCreateRequest request) {
    try {
        // 請求書情報のJSON変換（機密情報マスク処理付き）
        String maskedRequestJson = maskSensitiveData(request);
        
        // 監査ログ - 操作開始
        auditLogger.logAuditEvent(
            AuditAction.CREATE,
            "INVOICE",
            null,
            "請求書作成開始: " + maskedRequestJson,
            AuditStatus.ATTEMPT
        );
        
        // 請求書作成処理
        Invoice invoice = new Invoice();
        // ... 処理ロジック
        invoiceRepository.save(invoice);
        
        // 監査ログ - 操作成功
        auditLogger.logAuditEvent(
            AuditAction.CREATE,
            "INVOICE",
            invoice.getId(),
            "請求書作成完了: 請求金額=" + invoice.getAmount(),
            AuditStatus.SUCCESS
        );
        
        return invoice;
        
    } catch (Exception e) {
        // 監査ログ - 操作失敗
        auditLogger.logAuditEvent(
            AuditAction.CREATE,
            "INVOICE",
            null,
            "請求書作成失敗: " + e.getMessage(),
            AuditStatus.FAILURE
        );
        
        throw e;
    }
}

// 機密情報のマスク処理
private String maskSensitiveData(Object obj) {
    // 機密情報のマスク処理ロジック
    // ...
}
```

### 5.4 バッチ処理での監査ログ記録

```
@Component
public class BatchAuditListener implements JobExecutionListener {
    
    private final AuditLogger auditLogger;
    
    @Autowired
    public BatchAuditListener(AuditLogger auditLogger) {
        this.auditLogger = auditLogger;
    }
    
    @Override
    public void beforeJob(JobExecution jobExecution) {
        String jobName = jobExecution.getJobInstance().getJobName();
        String jobId = String.valueOf(jobExecution.getJobId());
        
        // バッチ開始の監査ログ
        auditLogger.logAuditEvent(
            AuditAction.EXECUTE,
            "BATCH_JOB",
            jobId,
            "バッチ処理開始: " + jobName + ", パラメータ: " + jobExecution.getJobParameters(),
            AuditStatus.ATTEMPT,
            "SYSTEM", // システムによる実行
            null
        );
    }
    
    @Override
    public void afterJob(JobExecution jobExecution) {
        String jobName = jobExecution.getJobInstance().getJobName();
        String jobId = String.valueOf(jobExecution.getJobId());
        
        // 実行結果の詳細情報
        StringBuilder details = new StringBuilder();
        details.append("バッチ処理終了: ").append(jobName);
        details.append(", 状態: ").append(jobExecution.getStatus());
        details.append(", 開始時刻: ").append(jobExecution.getStartTime());
        details.append(", 終了時刻: ").append(jobExecution.getEndTime());
        details.append(", 処理時間: ").append(
            jobExecution.getEndTime().getTime() - jobExecution.getStartTime().getTime()
        ).append("ms");
        
        // バッチ終了の監査ログ
        auditLogger.logAuditEvent(
            AuditAction.EXECUTE,
            "BATCH_JOB",
            jobId,
            details.toString(),
            jobExecution.getStatus().isUnsuccessful() ? AuditStatus.FAILURE : AuditStatus.SUCCESS,
            "SYSTEM", // システムによる実行
            null
        );
    }
}
```

## 6. 例外処理

### 6.1 監査ログ記録失敗時の対応

監査ログの記録自体が失敗した場合の対応を実装します。実装ポイントは以下の通りです：

- 監査ログ記録のtry-catch処理
- システムログへのエラー記録
- クリティカルな監査イベントの別手段通知
- ビジネスロジックへの影響排除

### 6.2 監査ログの整合性確保

システム障害時も監査ログの整合性を確保するための対策を実装します。主な実装ポイントは以下の通りです：

- バッファリング機能付き監査ログ記録
- メモリバッファへの一時保存
- 定期的なバッファフラッシュ
- バッチ処理による一括記録

### 6.3 不正なデータのマスキング

監査ログに機密情報や不正なデータが混入するのを防ぐための処理を実装します。主な実装ポイントは以下の通りです：

- クレジットカード番号のマスキング
- パスワードの完全な削除
- 個人情報（メールアドレスなど）の部分マスキング
- 機密データパターンの検知と置換

## 7. セキュリティ考慮事項

### 7.1 監査ログの保護

監査ログの不正な変更や削除を防止するための対策を実装します。主な実装ポイントは以下の通りです：

- 監査ログエントリのハッシュ値計算
- 監査ログの改ざん検知
- 前後のエントリとの連鎖ハッシュ
- 監査ログの書き込み専用化

### 7.2 監査ログへのアクセス制御

監査ログへのアクセスを適切に制限するための対策を実装します。主な実装ポイントは以下の通りです：

- 監査ログ操作の権限制御
- ロールベースのアクセス制御
- 監査ログエクスポートの厳格な制限
- 監査ログ参照のトレーサビリティ確保

### 7.3 監査ログの暗号化

機密性の高い監査情報を保護するための暗号化対策を実装します。主な実装ポイントは以下の通りです：

- 監査ログの暗号化処理
- 機密フィールドの選択的暗号化
- 暗号化キーの安全な管理
- 暗号化監査ログの復号アクセス制御

## 8. バージョン履歴

| バージョン | 更新日     | 担当者    | 変更内容                                |
|----------|------------|---------|--------------------------------------|
| 0.1      | 2023/10/01 | 山田太郎  | 初版作成                               |
| 0.2      | 2023/11/15 | 佐藤次郎  | セキュリティ強化対応追加                   |
| 0.3      | 2024/01/20 | 鈴木三郎  | REST API監査ログ機能追加                 |
| 0.4      | 2024/05/10 | 一丸柴也  | 実装コードを削除し、設計情報のみに修正     |