# パフォーマンスログ機能

## 1. 機能概要

パフォーマンスログ機能は、アプリケーション内の処理時間や各種メトリクスを計測・記録し、システムのボトルネック特定や性能最適化に役立てるための機能です。処理時間の計測、閾値監視、リソース使用状況の記録などを行います。

### 1.1 機能の目的

- 処理時間のモニタリングと記録
- パフォーマンスボトルネックの特定と分析
- 閾値を超えた処理の検知と警告
- パフォーマンス傾向の分析と最適化
- リソース使用状況の監視

### 1.2 主要機能

- メソッド実行時間の自動計測
- アノテーションによる宣言的パフォーマンス計測
- 処理時間の閾値監視と警告通知
- 処理件数と処理速度の計測
- リソース使用状況のログ記録
- パフォーマンスデータの集計と統計情報

## 2. 処理フロー

### 2.1 パフォーマンス計測の基本フロー

```
1. 計測対象メソッドの呼び出し
2. AOPによるメソッド実行前処理
   a. 開始時間の記録
   b. 計測情報の初期化
3. 対象メソッドの実行
4. AOPによるメソッド実行後処理
   a. 終了時間の記録と所要時間の計算
   b. 閾値判定（設定された閾値との比較）
   c. パフォーマンスログ出力
5. 例外発生時の処理
   a. 例外情報の取得
   b. 失敗処理のパフォーマンスログ出力
```

### 2.2 パフォーマンスアラートフロー

```
1. パフォーマンス計測結果の評価
   a. 警告閾値との比較
   b. エラー閾値との比較
2. アラートレベルの決定
   a. 正常（閾値内）
   b. 警告（警告閾値超過）
   c. エラー（エラー閾値超過）
3. アラート通知
   a. ログレベルの選択（INFO/WARN/ERROR）
   b. 通知方法の選択（ログのみ/アラート通知）
```

### 2.3 リソース使用状況記録フロー

```
1. リソース使用状況の取得
   a. CPUリソース使用率
   b. メモリ使用量
   c. スレッド使用状況
   d. コネクション使用状況
2. リソース使用状況のログ出力
3. 閾値超過時のアラート処理
```

## 3. 主要コンポーネント構成

### 3.1 PerformanceLoggerImpl クラス

PerformanceLoggerインターフェースの実装クラスです。

#### 主要責務
- メソッド実行時間の記録
- 閾値超過の判定と適切なログレベルでの出力
- パフォーマンスデータの収集とフォーマット
- システムリソース情報の収集（オプション）
- スレッド情報の収集（オプション）
- パフォーマンス統計情報の管理

#### 主要メソッド
- `recordExecutionTime(String methodName, long durationMs)` - 処理時間を記録
- `recordExecutionTime(String className, String methodName, long durationMs)` - クラス名付きで処理時間を記録
- `recordExecutionTime(String className, String methodName, long durationMs, boolean success)` - 成功/失敗情報付きで処理時間を記録
- `recordExecutionTime(String className, String methodName, long durationMs, long thresholdMs, boolean success)` - 閾値と成功/失敗情報付きで処理時間を記録

### 3.2 LogPerformanceAspect クラス

`@LogPerformance`アノテーションを処理するAOPアスペクトクラスです。

#### 主要責務
- アノテーションの付与されたメソッドのインターセプト
- メソッド実行前後の時間計測
- 処理結果（成功/失敗）の判定
- パフォーマンスロガーへの計測結果の受け渡し
- 例外発生時の適切なハンドリング

#### 主要メソッド
- `logPerformance(ProceedingJoinPoint joinPoint)` - アノテーション付きメソッドをインターセプトして計測

### 3.3 PerformanceLogProperties クラス

パフォーマンスログの設定プロパティクラスです。

#### 主要プロパティ
- `enabled` - パフォーマンスログ機能の有効/無効
- `defaultThresholdMs` - デフォルトの閾値（ミリ秒）
- `includeSystemResources` - リソース情報のログ出力を含めるかどうか
- `includeThreadInfo` - スレッド情報のログ出力を含めるかどうか
- `collectStatistics` - パフォーマンス統計情報を収集するかどうか
- `thresholds` - 機能別の閾値設定（正規表現パターンとミリ秒値のマップ）
- `statisticsRetentionMs` - 統計情報保持期間（ミリ秒）

#### 主要メソッド
- `getThresholdForMethod(String methodPattern)` - 指定されたメソッドパターンの閾値を取得

### 3.4 PerformanceMonitor クラス

パフォーマンスモニタリングを行うユーティリティクラスです。

#### 主要責務
- 処理時間計測の簡易化
- 処理の開始/終了時間の記録
- バッチ処理のパフォーマンス記録
- 処理速度（スループット）の計算

#### 主要メソッド
- `measure(String methodName, Supplier<T> action)` - 処理時間を計測して実行（戻り値あり）
- `measureVoid(String methodName, Runnable action)` - 処理時間を計測して実行（戻り値なし）
- `startMonitoring(String key)` - モニタリングを開始
- `stopMonitoring(String key, boolean success)` - モニタリングを終了し結果をログに記録
- `recordBatchPerformance(String batchName, int recordCount, long durationMs)` - バッチ処理のパフォーマンス記録

### 3.5 SystemResourceMonitor クラス

システムリソースの使用状況をモニタリングするクラスです。

#### 主要責務
- システムリソース（CPU、メモリ、スレッド）の使用状況取得
- リソース使用状況の定期的な記録
- リソース使用量の閾値判定とアラート出力

#### 主要メソッド
- `monitorSystemResources()` - システムリソースの使用状況をログに記録（スケジュール実行）
- `collectResourceData()` - システムリソースデータを収集
- `isMemoryUsageHigh()` - メモリ使用率が高いかを判定
- `isCpuUsageHigh()` - CPU使用率が高いかを判定
- `isThreadCountHigh()` - スレッド数が多いかを判定

## 4. 設定詳細

### 4.1 パフォーマンスログ専用のLogback設定

パフォーマンスログのためのLogback設定例は以下の要素から構成されます：

- 専用のRollingFileAppenderを使用したログファイル分割
- LogstashEncoderによるJSON形式ログ出力
- 非同期アペンダーによるパフォーマンス向上
- ログのローテーション設定（日次、保持期間30日、最大サイズ5GB）
- ログレベルに応じた出力先振り分け（WARN以上はコンソールにも出力）

### 4.2 パフォーマンスログ関連のアプリケーション設定

Spring Bootアプリケーションの`application.yml`ファイルに、以下のようなパフォーマンスログ設定を行います：

- 機能の有効/無効設定
- デフォルト閾値の設定（ミリ秒）
- リソース情報・スレッド情報の出力有無
- 統計情報収集の有無
- システムリソースモニタリングの間隔
- 機能別の閾値設定（正規表現パターンとミリ秒値のマップ）
  - APIコントローラー: 500ms
  - リポジトリ操作: 200ms
  - 外部システム連携: 2000ms
  - バッチ処理: 10000ms

## 5. 使用例

### 5.1 アノテーションを使用した宣言的パフォーマンス計測

`@LogPerformance`アノテーションを使用してメソッドの処理時間を自動的に計測する方法の例：

- 基本的な使用方法（デフォルト閾値）
- カスタム閾値の指定
- 警告レベルでのログ出力（閾値超過時のみ）

### 5.2 プログラムによる明示的なパフォーマンス計測

プログラム内で明示的にパフォーマンスを計測する方法の例：

- 手動での計測開始/終了
- PerformanceMonitorを使用した関数型の計測
- バッチ処理のパフォーマンス記録（処理件数と速度の計測）

### 5.3 SQLクエリのパフォーマンス計測

データベースクエリのパフォーマンスを計測する方法の例：

- Spring JDBCを使用したクエリ実行時間の計測
- 複雑なレポートクエリの実行時間監視
- 動的に構築されるSQLのパフォーマンス計測

### 5.4 バッチ処理のパフォーマンス計測

バッチ処理のパフォーマンスを計測する方法の例：

- バッチ処理開始/終了時の計測
- 個別アイテム処理時間の計測
- 処理速度（スループット）の計算と記録
- バッチ処理の統計情報のログ記録

## 6. 例外処理

### 6.1 パフォーマンスログ出力の例外ハンドリング

パフォーマンスログ記録中に発生する例外を適切に処理する方法：

- ロギング処理自体の例外をキャッチ
- ビジネスロジックに影響を与えない設計
- エラー発生時のフォールバック処理

### 6.2 計測中の処理エラーハンドリング

処理の実行中に例外が発生した場合でも、パフォーマンスログを確実に記録する方法：

- try-catch-finallyブロックを使用した確実な計測終了処理
- エラーハンドラによるカスタムエラー処理
- 成功/失敗フラグの適切な設定

### 6.3 リソース計測エラーのハンドリング

システムリソースの計測中に発生するエラーを適切に処理する方法：

- リソース情報取得時の例外ハンドリング
- 取得できない場合のデフォルト値提供
- エラー発生時のログ記録

## 7. パフォーマンス考慮事項

### 7.1 監視コストの最小化

パフォーマンスログ自体がシステムに与える影響を最小限に抑えるための対策：

- 最小閾値以下の短時間処理は記録しない設定
- ログレベルに基づく出力制御
- 特定パターンのメソッドを除外する設定
- サンプリングレートによる出力頻度制御

### 7.2 パフォーマンスロギングの最適化

パフォーマンスログ出力自体を効率化するための対策：

- 閾値に基づくログレベルの動的選択
- 処理成功時と失敗時の出力内容の最適化
- 必要な情報のみを含めた効率的なログ出力

### 7.3 キャッシュの活用

頻繁に使用する値や計算結果をキャッシュして効率化：

- メソッド閾値のキャッシュ
- 正規表現パターンマッチングの結果キャッシュ
- 計算コストの高い操作結果のキャッシュ

### 7.4 バッファリングとバッチ処理

パフォーマンスログをバッファリングしてバッチ処理することで、I/O負荷を軽減：

- ログエントリのバッファリング
- 定期的なバッファフラッシュ
- 非同期ログライティング
- バッファオーバーフロー時の対策

## 8. バージョン履歴

| バージョン | 更新日     | 担当者    | 変更内容                                |
|----------|------------|---------|--------------------------------------|
| 0.1      | 2023/10/01 | 山田太郎  | 初版作成                               |
| 0.2      | 2023/11/15 | 佐藤次郎  | リソースモニタリング機能追加              |
| 0.3      | 2024/01/20 | 鈴木三郎  | バッチ処理のパフォーマンス計測機能追加     |
| 0.4      | 2024/05/10 | 一丸柴也  | 実装コードを削除し、設計情報のみに修正     |