# ロギング機能 概要

## 1. 目的と責務

ロギング機能は、SES業務システム全体のさまざまな操作やイベントを記録し、以下の用途に活用するための共通基盤を提供します：

- システムの動作状況の監視と把握
- 障害発生時の原因調査と解析
- セキュリティ監査とコンプライアンス対応
- パフォーマンス分析と最適化
- ユーザーの操作履歴の追跡
- システム改善のためのデータ収集

本モジュールは、アプリケーション全体で一貫したロギング方式を提供し、様々なレベルと種類のログを体系的に収集、保存、検索できる仕組みを実現します。

## 2. 主要機能

### 2.1 アプリケーションログ機能
- 様々なログレベル（ERROR, WARN, INFO, DEBUG, TRACE）に対応
- 構造化ログフォーマット（JSON）の出力
- ログローテーションと保持期間管理
- 環境別（開発/テスト/本番）ログ設定の切り替え

### 2.2 監査ログ機能
- 重要な業務操作や管理機能の利用を記録
- ユーザー、操作内容、対象、結果などの追跡可能性の確保
- アスペクト指向プログラミング(AOP)による宣言的監査ログ
- 改ざん検知機能（オプション）

### 2.3 パフォーマンスログ機能
- 処理時間の計測と記録
- 処理のボトルネック特定
- しきい値を超えた処理の警告
- リソース使用状況のモニタリング

### 2.4 分散トレーシング機能
- リクエスト横断的な処理の追跡
- トレースID、スパンIDによる関連処理の紐付け
- マイクロサービス間の処理フロー可視化
- エンドツーエンドの処理時間分析

## 3. システム内の位置づけ

ロギング機能は、システム全体の共通基盤として、すべてのモジュールから利用される横断的な機能です。以下の特徴を持ちます：

- 全モジュールからの依存を受ける共通機能
- 他の共通機能（エラー処理、認証認可など）と連携
- インフラストラクチャとアプリケーションを橋渡しする役割
- 非機能要件（可観測性、運用保守性）の実現を担う

## 4. アーキテクチャ概要

### 4.1 全体アーキテクチャ

ロギング機能は、複数の層からなるアーキテクチャで構成されます：

1. **アプリケーションログ層**
   - SLF4J + Logbackを使用したアプリケーションからのログ出力
   - JSON形式でのログフォーマット
   - 非同期処理によるパフォーマンス最適化

2. **ログ収集層**
   - ログファイルの監視と変更検出
   - サービス間のログ集約
   - Filebeatによるログデータの転送

3. **ログ処理層**
   - Logstashによるログデータの正規化とエンリッチメント
   - フィルタリングと変換処理
   - データの構造化と強化

4. **ログ保存層**
   - Elasticsearchによる検索可能な形式でのログ永続化
   - インデックスライフサイクル管理
   - スナップショットによるバックアップ

5. **ログ可視化層**
   - Kibanaを用いたログの検索・分析・可視化
   - ダッシュボードによるモニタリング
   - アラート機能による異常検知

### 4.2 テクノロジースタック

| コンポーネント | 採用技術 | バージョン | 用途 |
|--------------|---------|-----------|------|
| ロギングAPI | SLF4J | 2.0.x | ロギングファサード |
| ロギング実装 | Logback | 1.4.x | ログ出力フレームワーク |
| 構造化ログ | logstash-logback-encoder | 7.x | JSON形式ログ出力 |
| ログ収集 | Filebeat | 8.x | ログファイル監視・転送 |
| ログ処理 | Logstash | 8.x | ログデータ処理パイプライン |
| ログストア | Elasticsearch | 8.x | ログデータ保存・検索 |
| ログ可視化 | Kibana | 8.x | ログ分析・ダッシュボード |
| 分散トレーシング | Spring Cloud Sleuth | 3.1.x | トレースID/スパンID管理 |

### 4.3 ログフロー

ログデータは、発生から保存・可視化まで以下の流れで処理されます：

1. アプリケーションが SLF4J API を通じてログを出力
2. Logback が設定に基づきログを JSON 形式でファイルに書き込み
3. Filebeat がログファイルの変更を検知し、データを収集
4. 収集されたデータが Logstash に転送され、正規化・強化処理
5. 処理されたログが Elasticsearch に保存
6. Kibana を通じてログデータの検索・分析・可視化
7. 異常検知時に Elasticsearch の Watcher 機能でアラート発報

## 5. ユースケース一覧

### 5.1 アプリケーションログ関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| AL1 | エラーログ記録 | システムエラー、例外発生時の詳細情報を記録 | 高 |
| AL2 | 警告ログ記録 | 潜在的な問題や注意事項を警告レベルで記録 | 中 |
| AL3 | 情報ログ記録 | 通常の処理フローや状態変化を情報レベルで記録 | 中 |
| AL4 | デバッグログ記録 | 開発・テスト時に詳細な情報を記録 | 低 |

### 5.2 監査ログ関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| AUD1 | ユーザーログイン記録 | ユーザーのログイン成功/失敗を記録 | 高 |
| AUD2 | 権限変更記録 | ユーザー権限の変更操作を記録 | 高 |
| AUD3 | 重要データ操作記録 | 契約情報など重要データの作成/更新/削除を記録 | 高 |
| AUD4 | マスターデータ変更記録 | マスターデータの変更操作を記録 | 中 |

### 5.3 パフォーマンスログ関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| PER1 | API処理時間記録 | REST API呼び出しの処理時間を記録 | 高 |
| PER2 | DB処理時間記録 | データベース操作の処理時間を記録 | 中 |
| PER3 | 外部システム連携処理時間記録 | 外部システム連携処理の所要時間を記録 | 中 |
| PER4 | バッチ処理パフォーマンス記録 | バッチ処理の処理時間と処理件数を記録 | 高 |

### 5.4 分散トレーシング関連

| ID | ユースケース | 説明 | 優先度 |
|----|------------|------|--------|
| TRC1 | マイクロサービス間トレース | 複数サービスにまたがる処理フローの追跡 | 中 |
| TRC2 | エンドツーエンド処理追跡 | フロントエンドからバックエンドまでの処理追跡 | 中 |
| TRC3 | 非同期処理追跡 | メッセージキュー経由の非同期処理の追跡 | 低 |

## 6. 外部システム連携

| 連携システム | 連携内容 | 連携方向 | 連携方式 |
|------------|---------|---------|----------|
| 監視システム | ログアラート連携 | ロギング → 監視 | REST API / Webhook |
| SIEM | セキュリティイベント連携 | ロギング → SIEM | Syslog / REST API |
| 運用ダッシュボード | 統合監視 | ロギング → ダッシュボード | Elasticsearch API |
| チケット管理システム | 障害自動登録 | ロギング → チケット | Webhook / REST API |

## 7. 非機能要件

### 7.1 パフォーマンス要件

- アプリケーションのパフォーマンスへの影響を最小限に抑えるため、非同期ロギングを採用
- ログ出力による処理時間増加は5%以内に抑制
- 大量ログ発生時のバッファオーバーフロー対策を実施

### 7.2 セキュリティ要件

- 個人情報などの機密情報はマスキング処理を実施
- 認証情報（パスワード、トークンなど）はログに記録しない
- 監査ログへのアクセスは特権ユーザーのみに制限
- ログデータ転送時はTLS/SSLによる暗号化を実施

### 7.3 可用性要件

- ロギング機能の障害がアプリケーション本体に影響を与えない設計
- ログ収集・保存システムの冗長化構成
- ログデータの定期バックアップ

### 7.4 運用要件

- ログローテーションの自動化
- ログレベルの動的変更機能
- ディスク容量の監視と警告機能
- ログ保持期間のポリシー適用