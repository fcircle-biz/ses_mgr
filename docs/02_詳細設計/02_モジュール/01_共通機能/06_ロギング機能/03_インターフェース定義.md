# ロギング機能 インターフェース定義

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2023-08-05 | 設計担当者 | 初版作成 |
| 0.2 | 2023-09-15 | 設計担当者 | 分散トレーシング機能の追加 |
| 0.3 | 2023-11-20 | 設計担当者 | パフォーマンスロギング機能の強化 |
| 0.4 | 2025-05-10 | 設計担当者 | 実装コードを削除し、設計情報のみに修正 |
| 0.5 | 2025-05-11 | 設計担当者 | 残りの実装コードを削除し、完全に軽量化 |

## 1. インターフェース概要

ロギング機能は、アプリケーション全体に対して一貫したロギングサービスを提供します。このドキュメントでは、ロギング機能が提供するインターフェースと他のモジュールから要求するインターフェースを定義します。

### 1.1 設計方針

- SLF4J APIを基盤としたラッピングインターフェースを提供
- 依存注入可能なインターフェース設計
- アスペクト指向プログラミング(AOP)を活用した宣言的ロギング
- マイクロサービス環境を考慮した分散トレーシング対応

### 1.2 パッケージ構成

```
jp.co.sesmanager.common.logging
  ├── api           // 公開インターフェース
  ├── aop           // アスペクト関連
  ├── config        // 設定クラス
  ├── domain        // ドメインモデル
  ├── internal      // 内部実装
  ├── marker        // ログマーカー
  └── trace         // 分散トレーシング
```

## 2. 提供インターフェース

### 2.1 LoggingFacade

**目的**: アプリケーションからログを出力するための主要インターフェース

**責務**:
- 各種ログレベル（ERROR, WARN, INFO, DEBUG, TRACE）でのログ出力
- 例外情報を含むログ出力
- ログレベル有効性の確認
- MDC（Mapped Diagnostic Context）の操作
- マーカーによるログ出力の分類

#### メソッド一覧

**error (メッセージのみ)**
- **目的**: ERRORレベルのログを出力
- **引数**: ログメッセージ（パラメータプレースホルダ{}を含む）、メッセージパラメータ

**error (例外情報付き)**
- **目的**: 例外情報を含むERRORレベルのログを出力
- **引数**: ログメッセージ、例外オブジェクト、メッセージパラメータ

**warn**
- **目的**: WARNレベルのログを出力
- **引数**: ログメッセージ、メッセージパラメータ

**info**
- **目的**: INFOレベルのログを出力
- **引数**: ログメッセージ、メッセージパラメータ

**debug**
- **目的**: DEBUGレベルのログを出力
- **引数**: ログメッセージ、メッセージパラメータ

**trace**
- **目的**: TRACEレベルのログを出力
- **引数**: ログメッセージ、メッセージパラメータ

**isEnabled**
- **目的**: 指定されたログレベルが有効かどうかを確認
- **引数**: ログレベル
- **戻り値**: 有効な場合はtrue

**getName**
- **目的**: 現在のロガー名を取得
- **戻り値**: ロガー名

**putMdc**
- **目的**: MDC（Mapped Diagnostic Context）にキーと値のペアを追加
- **引数**: キー、値
- **戻り値**: このインスタンス（メソッドチェーン用）

**removeMdc**
- **目的**: MDCから指定されたキーの値を削除
- **引数**: キー
- **戻り値**: このインスタンス（メソッドチェーン用）

**withMarker**
- **目的**: 指定したマーカーを使用してログ出力を行うロガーを取得
- **引数**: ログマーカー
- **戻り値**: マーカー付きロガー

### 2.2 LoggingFactory

**目的**: LoggingFacadeインスタンスを取得するためのファクトリーインターフェース

**責務**:
- 様々なコンテキスト（クラス、名前）に応じたロガーインスタンスの提供

#### メソッド一覧

**getLogger (引数なし)**
- **目的**: 現在のクラス用のロガーを取得
- **戻り値**: LoggingFacadeインスタンス

**getLogger (クラス指定)**
- **目的**: 指定されたクラス用のロガーを取得
- **引数**: 対象クラス
- **戻り値**: LoggingFacadeインスタンス

**getLogger (名前指定)**
- **目的**: 指定された名前のロガーを取得
- **引数**: ロガー名
- **戻り値**: LoggingFacadeインスタンス

### 2.3 AuditLogger

**目的**: 監査ログを記録するための専用インターフェース

**責務**:
- システム監査に必要な操作ログの記録
- ユーザーアクションの追跡
- セキュリティイベントの記録

#### メソッド一覧

**logAuditEvent (基本)**
- **目的**: 監査イベントを記録
- **引数**: 実行された操作、操作対象の種類、操作対象のID

**logAuditEvent (詳細付き)**
- **目的**: 詳細情報付きの監査イベントを記録
- **引数**: 実行された操作、操作対象の種類、操作対象のID、詳細情報

**logAuditEvent (ステータス付き)**
- **目的**: ステータス付きの監査イベントを記録
- **引数**: 実行された操作、操作対象の種類、操作対象のID、詳細情報、操作結果のステータス

**logAuditEvent (完全)**
- **目的**: すべての情報を指定して監査イベントを記録
- **引数**: 実行された操作、操作対象の種類、操作対象のID、詳細情報、操作結果のステータス、ユーザーID、IPアドレス

### 2.4 AuditLog アノテーション

**目的**: 監査ログを宣言的に記録するためのアノテーション

**責務**:
- メソッド実行時の監査ログ自動記録
- 監査情報のメソッドパラメータからの抽出

#### 属性

**action**
- **目的**: 実行される操作
- **型**: AuditAction列挙型

**targetType**
- **目的**: 操作対象の種類
- **型**: 文字列

**targetIdExpression**
- **目的**: 操作対象IDを取得するためのパラメータ名またはSpEL式
- **型**: 文字列
- **デフォルト値**: 空文字（メソッドの戻り値から取得を試みる）

**detailsExpression**
- **目的**: 詳細情報を取得するためのSpEL式
- **型**: 文字列
- **デフォルト値**: 空文字

### 2.5 PerformanceLogger

**目的**: パフォーマンス情報を記録するためのインターフェース

**責務**:
- メソッド実行時間の記録
- パフォーマンス閾値監視
- 処理成功/失敗情報の記録

#### メソッド一覧

**recordExecutionTime (メソッド名のみ)**
- **目的**: メソッド実行時間を記録
- **引数**: メソッド名、実行時間（ミリ秒）

**recordExecutionTime (クラス・メソッド名)**
- **目的**: クラスとメソッドを指定して実行時間を記録
- **引数**: クラス名、メソッド名、実行時間（ミリ秒）

**recordExecutionTime (成功フラグ付き)**
- **目的**: 処理結果を含めて実行時間を記録
- **引数**: クラス名、メソッド名、実行時間（ミリ秒）、処理成功フラグ

**recordExecutionTime (閾値付き)**
- **目的**: しきい値情報を含めて実行時間を記録
- **引数**: クラス名、メソッド名、実行時間（ミリ秒）、警告閾値（ミリ秒）、処理成功フラグ

### 2.6 LogPerformance アノテーション

**目的**: メソッドの実行時間を測定して記録するためのアノテーション

**責務**:
- メソッド実行時間の自動測定と記録
- パフォーマンス閾値の設定と監視

#### 属性

**thresholdMs**
- **目的**: 実行時間の警告閾値（ミリ秒）
- **型**: long
- **デフォルト値**: 0（閾値なし）

**level**
- **目的**: ログに記録する情報レベル
- **型**: 文字列
- **デフォルト値**: "INFO"
- **有効値**: "INFO"（常に記録）、"WARN"（閾値超過時のみ記録）

### 2.7 TracingContext

**目的**: 分散トレーシング情報を管理するインターフェース

**責務**:
- トレースIDの管理
- スパン作成と管理
- 追加情報（バゲージアイテム）の管理

#### メソッド一覧

**getCurrentTraceId**
- **目的**: 現在のトレースIDを取得
- **戻り値**: トレースID

**getCurrentSpanId**
- **目的**: 現在のスパンIDを取得
- **戻り値**: スパンID

**createChildSpan**
- **目的**: 現在のスパンから子スパンを作成
- **引数**: スパン名
- **戻り値**: 新しいスパンID

**closeCurrentSpan**
- **目的**: 現在のスパンを閉じる

**addBaggageItem**
- **目的**: バゲージアイテム（トレース間で伝播する情報）を追加
- **引数**: キー、値

**getBaggageItem**
- **目的**: バゲージアイテムを取得
- **引数**: キー
- **戻り値**: 値（存在しない場合はnull）

**getTraceContext**
- **目的**: 現在のトレースコンテキスト情報をMapとして取得
- **戻り値**: トレース情報を含むMap

**setTraceContext**
- **目的**: 指定されたトレースコンテキストを現在のスレッドにバインド
- **引数**: トレースコンテキスト情報

### 2.8 LoggingConfiguration

**目的**: ロギング設定を動的に変更するためのインターフェース

**責務**:
- ロガーのログレベル変更
- ロガー設定の取得
- ロガー設定の再読込

#### メソッド一覧

**setLogLevel**
- **目的**: 指定されたロガーのログレベルを変更
- **引数**: ロガー名、設定するログレベル

**getLogLevel**
- **目的**: 指定されたロガーの現在のログレベルを取得
- **引数**: ロガー名
- **戻り値**: 現在のログレベル

**getAllLogLevels**
- **目的**: 全てのロガーとそのログレベルの一覧を取得
- **戻り値**: ロガー名とログレベルのマップ

**reloadConfiguration**
- **目的**: ロガー設定をリロード

## 3. 要求インターフェース

### 3.1 UserContextHolder

**目的**: ログの出力時にユーザー情報を取得するために必要なインターフェース

**提供モジュール**: 認証認可機能

**責務**:
- 現在のユーザー情報の取得
- クライアント情報の取得
- セッション情報の取得

#### メソッド一覧

**getUserContext**
- **目的**: 現在認証されているユーザーコンテキストを取得
- **戻り値**: ユーザーコンテキスト

**getClientIpAddress**
- **目的**: 現在のリクエストからクライアントIPアドレスを取得
- **戻り値**: クライアントIPアドレス

**getSessionId**
- **目的**: 現在のセッションIDを取得
- **戻り値**: セッションID

### 3.2 ErrorHandler

**目的**: エラーログ出力時にエラー情報を適切に変換するために必要なインターフェース

**提供モジュール**: エラー処理機能

**責務**:
- 例外情報の変換
- エラーメッセージの解決

#### メソッド一覧

**convertExceptionToErrorInfo**
- **目的**: 例外をエラー情報に変換
- **引数**: 例外オブジェクト
- **戻り値**: エラー情報

**resolveErrorMessage**
- **目的**: エラーコードからエラーメッセージを解決
- **引数**: エラーコード、メッセージパラメータ
- **戻り値**: 解決されたエラーメッセージ

## 4. データ交換モデル

### 4.1 LoggingEventDTO

**目的**: ログイベントをシステム間で交換するためのデータ転送オブジェクト

**属性**:
- **基本情報**
  - id: ログID (String)
  - timestamp: タイムスタンプ (Instant)
  - level: ログレベル (LogLevel)
  - loggerName: ロガー名 (String)
  - message: ログメッセージ (String)
  - threadName: スレッド名 (String)

- **アプリケーション情報**
  - applicationName: アプリケーション名 (String)
  - environmentName: 環境名 (String)
  - hostName: ホスト名 (String)

- **コンテキスト情報**
  - mdc: Mapped Diagnostic Context (Map<String, String>)
  - throwable: 例外情報 (ThrowableDTO)

- **トレース情報**
  - traceId: トレースID (String)
  - spanId: スパンID (String)

- **ロギングイベント種別**
  - eventType: イベント種別 (String)
    - アプリケーション
    - 監査
    - パフォーマンス
    - アクセス

- **拡張情報**
  - extendedData: 種別ごとの固有情報 (Map<String, Object>)

- **監査情報**
  - userId: ユーザーID (String)
  - action: 実行操作 (String)
  - targetType: 対象タイプ (String)
  - targetId: 対象ID (String)

- **パフォーマンス情報**
  - durationMs: 実行時間 (Long)

### 4.2 LoggingConfigDTO

**目的**: ロギング設定を交換するためのデータ転送オブジェクト

**属性**:
- **ロガー設定**
  - loggerLevels: ロガー名とログレベルのマッピング (Map<String, String>)

- **アペンダー設定**
  - appenders: アペンダー名と設定のマッピング (Map<String, AppenderConfigDTO>)

- **その他の設定**
  - jsonFormat: JSON形式出力フラグ (boolean)
  - includeCallerData: 呼び出し元情報を含めるフラグ (boolean)
  - includeException: 例外情報を含めるフラグ (boolean)
  - asyncLogging: 非同期ロギングフラグ (boolean)
  - mdcProperties: 常時MDCに含めるプロパティ (Map<String, String>)

## 5. 非機能要件

### 5.1 パフォーマンス要件

1. ロギング処理がアプリケーションパフォーマンスに与える影響を最小化するため、以下の対策を実施します：
   - 非同期ロギングの採用
   - バッファリングによるディスクI/O最適化
   - ログレベルによる出力制御の厳格化

2. パフォーマンスメトリック：
   - ログエントリ1件あたりの処理オーバーヘッド: 0.1ミリ秒以下
   - 大量ログ出力時（1秒間に1000エントリ以上）のスループット低下: 5%以内
   - ディスクI/O待ちによるアプリケーションブロッキング: なし

### 5.2 トランザクション要件

1. ロギング処理とアプリケーショントランザクションの分離：
   - ロギング処理の失敗がビジネストランザクションに影響を与えない設計
   - 重要なログ（監査ログなど）の書き込み失敗時の例外ハンドリング方針

2. 監査ログの整合性保証：
   - 監査ログ書き込みエラー時のリトライ機構
   - 一時的なバッファリングとリカバリ機構

### 5.3 スレッドセーフティ要件

1. マルチスレッド環境での安全性確保：
   - スレッドローカルストレージの適切な利用
   - 非同期ロギングにおける競合状態の回避
   - MDC（Mapped Diagnostic Context）の適切なクリアと管理

### 5.4 スケーラビリティ要件

1. 大量ログ処理への対応：
   - ログローテーションの自動化
   - バッファサイズと非同期キューの適切な設計
   - 分散環境でのログ集約処理の効率化

2. マイクロサービス環境での分散トレーシング：
   - サービス間でのトレースコンテキスト伝播
   - 大規模トレースデータの効率的な収集と保存

### 5.5 セキュリティ要件

1. ログデータの保護：
   - 機密情報のマスキング処理
   - ログファイルのアクセス制御
   - 監査ログの改ざん防止対策

2. 認証情報と個人情報の取り扱い：
   - パスワードやトークンの非ログ化
   - 個人識別情報（PII）の適切な処理