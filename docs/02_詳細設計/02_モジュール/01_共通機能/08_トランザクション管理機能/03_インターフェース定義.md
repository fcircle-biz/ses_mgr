# トランザクション管理機能 インターフェース定義

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2025-05-10 | 設計担当者 | 初版作成 |
| 0.2 | 2025-05-11 | 設計担当者 | 実装コード削除による軽量化 |

## 1. 概要

本ドキュメントでは、トランザクション管理機能が提供するインターフェースと、外部システムからの依存インターフェースを定義します。これらのインターフェースは、トランザクション管理機能を他のモジュールと統合するための主要な契約となります。

## 2. 提供インターフェース

### 2.1 TransactionManager

トランザクション管理の主要なエントリポイントとなるサービスインターフェースです。基本的なトランザクション操作を提供します。

#### インターフェース概要
- トランザクション操作の開始、コミット、ロールバックを制御する
- トランザクションの状態管理と監視を行う
- トランザクションの一時停止と再開をサポートする

#### メソッド
- **begin**
  - 説明: 新しいトランザクションを開始する
  - パラメータ:
    - propagation: PropagationBehavior - 伝播方式
    - isolation: IsolationLevel - 分離レベル
    - timeout: int - タイムアウト（秒）
    - readOnly: boolean - 読み取り専用フラグ
  - 戻り値: TransactionStatus - トランザクション情報

- **commit**
  - 説明: 現在のトランザクションをコミットする
  - パラメータ: なし
  - 戻り値: void
  - 例外:
    - NoTransactionException - アクティブなトランザクションがない場合
    - TransactionSystemException - コミット処理中にエラーが発生した場合

- **rollback**
  - 説明: 現在のトランザクションをロールバックする
  - パラメータ: なし
  - 戻り値: void
  - 例外:
    - NoTransactionException - アクティブなトランザクションがない場合
    - TransactionSystemException - ロールバック処理中にエラーが発生した場合

- **isActive**
  - 説明: 現在アクティブなトランザクションがあるか確認する
  - パラメータ: なし
  - 戻り値: boolean - トランザクションがアクティブな場合はtrue

- **getCurrentTransaction**
  - 説明: 現在のトランザクション情報を取得する
  - パラメータ: なし
  - 戻り値: Optional<TransactionStatus> - トランザクション情報（存在しない場合はEmpty）

- **suspend**
  - 説明: 現在のトランザクションを一時停止する
  - パラメータ: なし
  - 戻り値: TransactionStatus - 停止したトランザクションの状態
  - 例外:
    - NoTransactionException - アクティブなトランザクションがない場合

- **resume**
  - 説明: 一時停止したトランザクションを再開する
  - パラメータ:
    - status: TransactionStatus - 再開するトランザクションの状態
  - 戻り値: void
  - 例外:
    - InvalidTransactionException - 無効なトランザクション状態の場合

- **setRollbackOnlyForException**
  - 説明: 指定した例外発生時にロールバックするかどうかを設定する
  - パラメータ:
    - exceptionClass: Class<? extends Throwable> - 例外クラス
    - rollback: boolean - ロールバックするかどうか
  - 戻り値: void

### 2.2 TransactionTemplate

宣言的なプログラミングスタイルでトランザクション処理を実行するためのテンプレートインターフェースです。

#### インターフェース概要
- トランザクション境界内でのビジネスロジックの実行を簡略化する
- トランザクション設定のカスタマイズをサポートする
- メソッドチェーンによる流暢なAPIを提供する

#### メソッド
- **execute**
  - 説明: トランザクション内で処理を実行する
  - パラメータ:
    - action: TransactionCallback<T> - 実行する処理
  - 戻り値: T - 処理結果
  - 例外:
    - TransactionException - トランザクション処理中にエラーが発生した場合

- **executeReadOnly**
  - 説明: 読み取り専用トランザクション内で処理を実行する
  - パラメータ:
    - action: TransactionCallback<T> - 実行する処理
  - 戻り値: T - 処理結果
  - 例外:
    - TransactionException - トランザクション処理中にエラーが発生した場合

- **executeWithNewTransaction**
  - 説明: 新しいトランザクションを作成して処理を実行する
  - パラメータ:
    - action: TransactionCallback<T> - 実行する処理
  - 戻り値: T - 処理結果
  - 例外:
    - TransactionException - トランザクション処理中にエラーが発生した場合

- **setPropagationBehavior**
  - 説明: トランザクションの伝播方式を設定する
  - パラメータ:
    - propagationBehavior: PropagationBehavior - 伝播方式
  - 戻り値: TransactionTemplate - 自身のインスタンス

- **setIsolationLevel**
  - 説明: トランザクションの分離レベルを設定する
  - パラメータ:
    - isolationLevel: IsolationLevel - 分離レベル
  - 戻り値: TransactionTemplate - 自身のインスタンス

- **setTimeout**
  - 説明: トランザクションのタイムアウトを設定する
  - パラメータ:
    - timeout: int - タイムアウト（秒）
  - 戻り値: TransactionTemplate - 自身のインスタンス

- **setReadOnly**
  - 説明: 読み取り専用フラグを設定する
  - パラメータ:
    - readOnly: boolean - 読み取り専用の場合はtrue
  - 戻り値: TransactionTemplate - 自身のインスタンス

### 2.3 TransactionSynchronizationManager

トランザクションの実行前後に処理を挿入するための同期マネージャインターフェースです。

#### インターフェース概要
- トランザクションライフサイクルへのフックポイントを提供する
- トランザクションに関連するリソースのバインド・アンバインドを管理する
- 現在のトランザクションの状態を検査する機能を提供する

#### メソッド
- **registerSynchronization**
  - 説明: トランザクション同期処理を登録する
  - パラメータ:
    - synchronization: TransactionSynchronization - 同期処理
  - 戻り値: void
  - 例外:
    - IllegalStateException - アクティブなトランザクションがない場合

- **isSynchronizationActive**
  - 説明: 現在トランザクションが有効かどうか確認する
  - パラメータ: なし
  - 戻り値: boolean - トランザクションが有効な場合はtrue

- **isCurrentTransactionReadOnly**
  - 説明: 現在のトランザクションがロールバックのみ可能かどうか確認する
  - パラメータ: なし
  - 戻り値: boolean - ロールバックのみ可能な場合はtrue

- **getCurrentTransactionName**
  - 説明: 現在のトランザクション名を取得する
  - パラメータ: なし
  - 戻り値: String - トランザクション名（存在しない場合はnull）

- **bindResource**
  - 説明: リソースをトランザクションにバインドする
  - パラメータ:
    - key: Object - リソースキー
    - value: Object - リソース値
  - 戻り値: void

- **getResource**
  - 説明: トランザクションからリソースを取得する
  - パラメータ:
    - key: Object - リソースキー
  - 戻り値: Object - バインドされたリソース（存在しない場合はnull）

- **unbindResource**
  - 説明: トランザクションからリソースをアンバインドする
  - パラメータ:
    - key: Object - リソースキー
  - 戻り値: Object - アンバインドされたリソース

### 2.4 DistributedTransactionManager

分散トランザクションを管理するためのインターフェースです。

#### インターフェース概要
- 複数サービス間のトランザクション調整を行う
- 2相コミットプロトコルをサポートする
- 未解決トランザクションの回復機能を提供する

#### メソッド
- **beginDistributedTransaction**
  - 説明: 分散トランザクションを開始する
  - パラメータ:
    - transactionConfig: DistributedTransactionConfig - 分散トランザクション設定
  - 戻り値: String - 分散トランザクションID
  - 例外:
    - DistributedTransactionException - 分散トランザクション開始中にエラーが発生した場合

- **prepare**
  - 説明: 分散トランザクションを完了する（準備フェーズを実行）
  - パラメータ:
    - transactionId: String - 分散トランザクションID
  - 戻り値: PrepareResult - 準備フェーズの結果
  - 例外:
    - DistributedTransactionException - 準備フェーズでエラーが発生した場合

- **commit**
  - 説明: 分散トランザクションをコミットする
  - パラメータ:
    - transactionId: String - 分散トランザクションID
  - 戻り値: void
  - 例外:
    - DistributedTransactionException - コミット中にエラーが発生した場合

- **rollback**
  - 説明: 分散トランザクションをロールバックする
  - パラメータ:
    - transactionId: String - 分散トランザクションID
  - 戻り値: void
  - 例外:
    - DistributedTransactionException - ロールバック中にエラーが発生した場合

- **enlistParticipant**
  - 説明: サービスを分散トランザクションに参加させる
  - パラメータ:
    - transactionId: String - 分散トランザクションID
    - participantConfig: ParticipantConfig - 参加者設定
  - 戻り値: void
  - 例外:
    - DistributedTransactionException - 参加処理中にエラーが発生した場合

- **getTransactionStatus**
  - 説明: 分散トランザクションの状態を取得する
  - パラメータ:
    - transactionId: String - 分散トランザクションID
  - 戻り値: DistributedTransactionStatus - 分散トランザクションステータス
  - 例外:
    - DistributedTransactionException - 状態取得中にエラーが発生した場合

- **recoverInDoubtTransactions**
  - 説明: 未解決のトランザクションを回復する
  - パラメータ: なし
  - 戻り値: int - 回復したトランザクション数

### 2.5 SagaCoordinator

SAGAパターンによる分散トランザクションを調整するためのインターフェースです。

#### インターフェース概要
- 長時間実行トランザクションをステップに分割して管理する
- ステップごとの補償トランザクションを実行できる
- 状態管理と障害回復をサポートする

#### メソッド
- **startSaga**
  - 説明: SAGAプロセスを開始する
  - パラメータ:
    - sagaDefinitionId: String - SAGAプロセス定義ID
    - initialData: Map<String, Object> - 初期データ
  - 戻り値: String - SAGA実行ID
  - 例外:
    - SagaException - SAGA開始中にエラーが発生した場合

- **endSaga**
  - 説明: SAGAプロセスを完了する
  - パラメータ:
    - sagaExecutionId: String - SAGA実行ID
    - result: Map<String, Object> - 最終結果
  - 戻り値: void
  - 例外:
    - SagaException - SAGA完了中にエラーが発生した場合

- **abortSaga**
  - 説明: SAGAプロセスを中止し、補償トランザクションを実行する
  - パラメータ:
    - sagaExecutionId: String - SAGA実行ID
    - cause: Throwable - 中止理由
  - 戻り値: void
  - 例外:
    - SagaException - SAGA中止中にエラーが発生した場合

- **executeStep**
  - 説明: SAGAステップを実行する
  - パラメータ:
    - sagaExecutionId: String - SAGA実行ID
    - stepId: String - ステップID
    - stepData: Map<String, Object> - ステップデータ
  - 戻り値: StepExecutionResult - ステップ実行結果
  - 例外:
    - SagaException - ステップ実行中にエラーが発生した場合

- **getSagaState**
  - 説明: SAGAの現在の状態を取得する
  - パラメータ:
    - sagaExecutionId: String - SAGA実行ID
  - 戻り値: SagaState - SAGA状態情報
  - 例外:
    - SagaException - 状態取得中にエラーが発生した場合

- **listActiveSagas**
  - 説明: 実行中のSAGAプロセスをリストアップする
  - パラメータ: なし
  - 戻り値: List<String> - 実行中のSAGA実行IDリスト

### 2.6 TransactionEventPublisher

トランザクション関連イベントを発行するためのインターフェースです。

#### インターフェース概要
- トランザクションのライフサイクルイベントを発行する
- イベントリスナーの登録・解除を管理する
- イベントタイプによるフィルタリングをサポートする

#### メソッド
- **publishEvent**
  - 説明: トランザクションイベントを発行する
  - パラメータ:
    - event: TransactionEvent - 発行するイベント
  - 戻り値: void

- **subscribeListener**
  - 説明: トランザクションイベントリスナーを登録する
  - パラメータ:
    - listener: TransactionEventListener - イベントリスナー
    - eventTypes: TransactionEventType... - 購読するイベント種別
  - 戻り値: void

- **unsubscribeListener**
  - 説明: トランザクションイベントリスナーの登録を解除する
  - パラメータ:
    - listener: TransactionEventListener - 解除するイベントリスナー
  - 戻り値: void

### 2.7 TransactionLogService

トランザクションログを管理するためのインターフェースです。

#### インターフェース概要
- トランザクション関連イベントのログ記録を行う
- ログの検索と取得機能を提供する
- 古いログのアーカイブ処理をサポートする

#### メソッド
- **logTransactionEvent**
  - 説明: トランザクションログを記録する
  - パラメータ:
    - transactionId: String - トランザクションID
    - eventType: TransactionEventType - イベント種別
    - detail: String - 詳細情報
    - successful: boolean - 成功フラグ
    - errorCode: String - エラーコード（エラー時のみ）
    - errorMessage: String - エラーメッセージ（エラー時のみ）
  - 戻り値: String - 記録されたログID

- **getTransactionLogs**
  - 説明: トランザクションのログを取得する
  - パラメータ:
    - transactionId: String - トランザクションID
  - 戻り値: List<TransactionLog> - 該当トランザクションのログリスト

- **findErrorLogs**
  - 説明: 期間内のエラーログを検索する
  - パラメータ:
    - startTime: LocalDateTime - 開始時間
    - endTime: LocalDateTime - 終了時間
    - pageable: Pageable - ページ情報
  - 戻り値: Page<TransactionLog> - エラーログのページ

- **searchLogs**
  - 説明: トランザクションログを検索する
  - パラメータ:
    - criteria: TransactionLogSearchCriteria - 検索条件
    - pageable: Pageable - ページ情報
  - 戻り値: Page<TransactionLog> - ログのページ

- **archiveOldLogs**
  - 説明: 古いログをアーカイブする
  - パラメータ:
    - cutoffTime: LocalDateTime - 基準時間（これより前のログをアーカイブ）
  - 戻り値: int - アーカイブされたログの数

## 3. データ転送オブジェクト (DTO)

### 3.1 TransactionStatus

トランザクションの状態を表すDTOです。

#### 属性
- transactionId: String - トランザクションID
- status: TransactionStatusEnum - トランザクション状態
- startTime: LocalDateTime - 開始時間
- newTransaction: boolean - 新規トランザクションフラグ
- completed: boolean - 完了フラグ
- rollbackOnly: boolean - ロールバックのみフラグ
- timeout: Integer - タイムアウト（秒）
- isolationLevel: IsolationLevel - 分離レベル
- readOnly: boolean - 読み取り専用フラグ

### 3.2 TransactionConfig

トランザクション設定を表すDTOです。

#### 属性
- propagation: PropagationBehavior - 伝播方式（デフォルト: REQUIRED）
- isolation: IsolationLevel - 分離レベル（デフォルト: READ_COMMITTED）
- timeout: int - タイムアウト（秒）（デフォルト: 60）
- readOnly: boolean - 読み取り専用フラグ（デフォルト: false）
- rollbackFor: Set<Class<? extends Throwable>> - ロールバック対象例外
- noRollbackFor: Set<Class<? extends Throwable>> - ロールバック対象外例外
- transactionManagerName: String - トランザクションマネージャ名

### 3.3 DistributedTransactionConfig

分散トランザクション設定を表すDTOです。

#### 属性
- coordinatorId: String - コーディネータID
- participantIds: List<String> - 参加者IDリスト
- timeout: int - タイムアウト（秒）（デフォルト: 120）
- type: DistributedTransactionType - トランザクション種別（デフォルト: TWO_PHASE_COMMIT）
- properties: Map<String, Object> - 追加プロパティ

### 3.4 ParticipantConfig

分散トランザクション参加者の設定を表すDTOです。

#### 属性
- participantId: String - 参加者ID
- endpoint: String - エンドポイントURL
- resourceManagerName: String - リソースマネージャ名
- timeout: int - タイムアウト（秒）（デフォルト: 60）
- properties: Map<String, Object> - 追加プロパティ

### 3.5 SagaDefinitionDto

SAGAプロセス定義を表すDTOです。

#### 属性
- id: String - 定義ID
- name: String - 名前
- description: String - 説明
- version: Integer - バージョン
- steps: List<SagaStepDto> - ステップリスト
- active: boolean - 有効フラグ（デフォルト: true）

### 3.6 SagaStepDto

SAGAステップ定義を表すDTOです。

#### 属性
- stepId: String - ステップID
- serviceId: String - サービスID
- actionName: String - アクション名
- compensationActionName: String - 補償アクション名
- order: Integer - 実行順序
- timeout: Integer - タイムアウト（秒）（デフォルト: 60）
- retryPolicy: RetryPolicyDto - リトライポリシー

### 3.7 TransactionLogSearchCriteria

トランザクションログ検索条件を表すDTOです。

#### 属性
- transactionIds: Set<String> - トランザクションIDリスト
- eventTypes: Set<TransactionEventType> - イベント種別リスト
- startTime: LocalDateTime - 開始時間
- endTime: LocalDateTime - 終了時間
- successful: Boolean - 成功フラグ
- resourceName: String - リソース名
- errorCode: String - エラーコード

## 4. API エンドポイント

### 4.1 管理用REST API

トランザクション管理機能は、運用管理のための以下のREST APIエンドポイントを提供します。

#### 4.1.1 アクティブトランザクション管理API

| メソッド | パス | 説明 | リクエスト | レスポンス | ステータスコード |
|--------|-----|------|-----------|-----------|--------------|
| GET | /api/transactions | アクティブなトランザクション一覧取得 | - | TransactionSummaryDto[] | 200 OK |
| GET | /api/transactions/{id} | トランザクション詳細取得 | - | TransactionDetailDto | 200 OK, 404 Not Found |
| POST | /api/transactions/{id}/force-terminate | トランザクション強制終了 | - | TerminationResultDto | 200 OK, 404 Not Found |

#### 4.1.2 分散トランザクション管理API

| メソッド | パス | 説明 | リクエスト | レスポンス | ステータスコード |
|--------|-----|------|-----------|-----------|--------------|
| GET | /api/distributed-transactions | 分散トランザクション一覧取得 | - | DistributedTransactionSummaryDto[] | 200 OK |
| GET | /api/distributed-transactions/{id} | 分散トランザクション詳細取得 | - | DistributedTransactionDetailDto | 200 OK, 404 Not Found |
| POST | /api/distributed-transactions/{id}/resolve | 未解決トランザクション解決 | ResolutionActionDto | ResolutionResultDto | 200 OK, 404 Not Found |

#### 4.1.3 SAGAプロセス管理API

| メソッド | パス | 説明 | リクエスト | レスポンス | ステータスコード |
|--------|-----|------|-----------|-----------|--------------|
| GET | /api/saga-definitions | SAGA定義一覧取得 | - | SagaDefinitionSummaryDto[] | 200 OK |
| GET | /api/saga-definitions/{id} | SAGA定義詳細取得 | - | SagaDefinitionDto | 200 OK, 404 Not Found |
| POST | /api/saga-definitions | SAGA定義登録 | SagaDefinitionDto | SagaDefinitionDto | 201 Created |
| PUT | /api/saga-definitions/{id} | SAGA定義更新 | SagaDefinitionDto | SagaDefinitionDto | 200 OK, 404 Not Found |
| GET | /api/saga-executions | SAGA実行一覧取得 | - | SagaExecutionSummaryDto[] | 200 OK |
| GET | /api/saga-executions/{id} | SAGA実行詳細取得 | - | SagaExecutionDetailDto | 200 OK, 404 Not Found |
| POST | /api/saga-executions/{id}/abort | SAGA実行中止 | - | AbortResultDto | 200 OK, 404 Not Found |

#### 4.1.4 トランザクションログAPI

| メソッド | パス | 説明 | リクエスト | レスポンス | ステータスコード |
|--------|-----|------|-----------|-----------|--------------|
| GET | /api/transaction-logs | トランザクションログ検索 | TransactionLogSearchCriteria | Page<TransactionLogDto> | 200 OK |
| GET | /api/transaction-logs/transaction/{id} | トランザクションのログ取得 | - | TransactionLogDto[] | 200 OK |
| GET | /api/transaction-logs/statistics | トランザクションログ統計情報取得 | - | TransactionStatisticsDto | 200 OK |

### 4.2 JMXエンドポイント

トランザクション管理機能は、監視・管理のために以下のJMXエンドポイントを提供します。

#### 4.2.1 TransactionManagerMXBean

##### 属性
- activeTransactionCount: int - アクティブなトランザクション数
- totalTransactionCount: long - 合計トランザクション数
- committedTransactionCount: long - コミット済みトランザクション数
- rolledBackTransactionCount: long - ロールバック済みトランザクション数
- transactionTimeoutSeconds: long - トランザクションタイムアウト秒数
- averageTransactionDurationMs: double - 平均トランザクション実行時間（ミリ秒）

##### 操作
- setDefaultTimeout(int seconds): void - デフォルトタイムアウトを設定
- listActiveTransactions(): String[] - アクティブなトランザクションをリスト
- forceTerminateTransaction(String transactionId): boolean - トランザクションを強制終了
- getTransactionStatistics(): Map<String, Object> - トランザクション統計情報を取得

#### 4.2.2 DistributedTransactionManagerMXBean

##### 属性
- activeDistributedTransactionCount: int - アクティブな分散トランザクション数
- totalDistributedTransactionCount: long - 合計分散トランザクション数
- successfulDistributedTransactionCount: long - 成功した分散トランザクション数
- failedDistributedTransactionCount: long - 失敗した分散トランザクション数
- inDoubtTransactionCount: long - 未解決トランザクション数

##### 操作
- listActiveDistributedTransactions(): String[] - アクティブな分散トランザクションをリスト
- listInDoubtTransactions(): String[] - 未解決トランザクションをリスト
- resolveInDoubtTransaction(String transactionId, String resolution): boolean - 未解決トランザクションを解決
- recoverInDoubtTransactions(): int - 未解決トランザクションを回復
- getDistributedTransactionStatistics(): Map<String, Object> - 分散トランザクション統計情報を取得

## 5. 依存インターフェース

トランザクション管理機能が依存する外部システムインターフェースを定義します。

### 5.1 PlatformTransactionManager

Spring Framework互換のトランザクションマネージャインターフェースです。

#### インターフェース概要
- トランザクションの開始、コミット、ロールバックの基本操作を提供する
- フレームワークとの互換性を確保する
- 様々なトランザクションマネージャの実装を統一的に扱う

#### メソッド
- **getTransaction**
  - 説明: 指定された属性に従ってトランザクションを開始する
  - パラメータ:
    - definition: TransactionDefinition - トランザクション定義
  - 戻り値: TransactionStatus - トランザクションステータス

- **commit**
  - 説明: 現在のトランザクションをコミットする
  - パラメータ:
    - status: TransactionStatus - トランザクションステータス
  - 戻り値: void

- **rollback**
  - 説明: 現在のトランザクションをロールバックする
  - パラメータ:
    - status: TransactionStatus - トランザクションステータス
  - 戻り値: void

### 5.2 TransactionOperations

Spring Framework互換のトランザクション操作インターフェースです。

#### インターフェース概要
- トランザクション内でのコードブロック実行を簡素化する
- テンプレートパターンによるボイラープレートコードの削減を実現する

#### メソッド
- **execute**
  - 説明: トランザクション内で処理を実行する
  - パラメータ:
    - action: TransactionCallback<T> - 実行する処理
  - 戻り値: T - 処理結果

### 5.3 ResourceManager

分散トランザクションで利用するリソースマネージャインターフェースです。

#### インターフェース概要
- XA互換のリソース管理機能を提供する
- 2相コミットプロトコルをサポートする
- トランザクション回復処理を提供する

#### メソッド
- **getResourceManagerId**
  - 説明: リソースマネージャの一意識別子を取得する
  - パラメータ: なし
  - 戻り値: String - リソースマネージャID

- **prepare**
  - 説明: トランザクションの準備処理を実行する
  - パラメータ:
    - xid: Xid - トランザクション識別子
  - 戻り値: int - 準備結果
  - 例外:
    - XAException - XA例外

- **commit**
  - 説明: トランザクションをコミットする
  - パラメータ:
    - xid: Xid - トランザクション識別子
    - onePhase: boolean - 1フェーズコミットかどうか
  - 戻り値: void
  - 例外:
    - XAException - XA例外

- **rollback**
  - 説明: トランザクションをロールバックする
  - パラメータ:
    - xid: Xid - トランザクション識別子
  - 戻り値: void
  - 例外:
    - XAException - XA例外

- **recover**
  - 説明: 未解決トランザクションのリストを取得する
  - パラメータ:
    - flag: int - 回復フラグ
  - 戻り値: Xid[] - 未解決トランザクションのXID配列
  - 例外:
    - XAException - XA例外

### 5.4 MetricsRegistry

メトリクス登録のためのインターフェースです。

#### インターフェース概要
- パフォーマンスメトリクスの登録と管理を行う
- 異なる種類のメトリクス（カウンター、ゲージ、タイマー）をサポートする

#### メソッド
- **registerCounter**
  - 説明: カウンターメトリクスを登録する
  - パラメータ:
    - name: String - メトリクス名
    - description: String - 説明
  - 戻り値: Counter - カウンターメトリクス

- **registerGauge**
  - 説明: ゲージメトリクスを登録する
  - パラメータ:
    - name: String - メトリクス名
    - description: String - 説明
    - supplier: Supplier<T> - 値の供給元
  - 戻り値: void

- **registerTimer**
  - 説明: タイマーメトリクスを登録する
  - パラメータ:
    - name: String - メトリクス名
    - description: String - 説明
  - 戻り値: Timer - タイマーメトリクス

### 5.5 EventPublisher

イベント発行のためのインターフェースです。

#### インターフェース概要
- 非同期イベント発行機能を提供する
- イベントドリブンアーキテクチャの構成要素として機能する

#### メソッド
- **publishEvent**
  - 説明: イベントを発行する
  - パラメータ:
    - event: Object - 発行するイベント
  - 戻り値: void

## 6. 例外階層

トランザクション管理機能が発生させる主な例外クラスを定義します。

### 6.1 TransactionException

トランザクション処理の基本例外クラスです。

#### 属性
- transactionId: String - トランザクションID

#### コンストラクタ
- TransactionException(String message)
- TransactionException(String message, String transactionId)
- TransactionException(String message, Throwable cause)
- TransactionException(String message, String transactionId, Throwable cause)

### 6.2 派生例外クラス

以下の例外クラスは `TransactionException` から派生します。

#### NoTransactionException
アクティブなトランザクションが存在しない場合の例外。

#### TransactionCreationException
トランザクションの作成に失敗した場合の例外。

#### TransactionCommitException
トランザクションのコミットに失敗した場合の例外。

#### TransactionRollbackException
トランザクションのロールバックに失敗した場合の例外。

#### TransactionTimeoutException
トランザクションがタイムアウトした場合の例外。

#### TransactionSystemException
システム関連のトランザクションエラーの例外。

### 6.3 分散トランザクション例外

分散トランザクション関連の例外クラスです。

#### DistributedTransactionException
分散トランザクションの基本例外。

#### DistributedTransactionCommunicationException
分散トランザクション通信エラー例外。

#### ParticipantException
分散トランザクション参加者エラー例外。

### 6.4 SAGAパターン例外

SAGAパターン関連の例外クラスです。

#### SagaException
SAGAの基本例外。

#### SagaStepExecutionException
SAGAステップ実行例外。

#### SagaCompensationException
SAGA補償トランザクション例外。

## 7. イベント定義

トランザクション管理機能が発行する主なイベントを定義します。

### 7.1 トランザクションイベント基本クラス

#### TransactionEvent
トランザクションイベントの基底クラス。

##### 属性
- transactionId: String - トランザクションID
- timestamp: LocalDateTime - イベント発生時間

### 7.2 トランザクションライフサイクルイベント

#### TransactionStartedEvent
トランザクション開始イベント。

##### 属性
- propagation: PropagationBehavior - 伝播方式
- isolation: IsolationLevel - 分離レベル
- readOnly: boolean - 読み取り専用フラグ
- timeout: Integer - タイムアウト（秒）

#### TransactionCommittedEvent
トランザクションコミットイベント。

##### 属性
- executionTimeMs: long - 実行時間（ミリ秒）

#### TransactionRolledBackEvent
トランザクションロールバックイベント。

##### 属性
- executionTimeMs: long - 実行時間（ミリ秒）
- reason: String - ロールバック理由
- cause: Throwable - 例外原因

#### TransactionTimeoutEvent
トランザクションタイムアウトイベント。

##### 属性
- executionTimeMs: long - 実行時間（ミリ秒）

### 7.3 分散トランザクションイベント

#### DistributedTransactionStartedEvent
分散トランザクション開始イベント。

##### 属性
- type: DistributedTransactionType - トランザクション種別
- participantIds: List<String> - 参加者IDリスト

#### DistributedTransactionPhaseChangedEvent
分散トランザクションフェーズ変更イベント。

##### 属性
- previousPhase: TransactionPhase - 前フェーズ
- newPhase: TransactionPhase - 新フェーズ

#### DistributedTransactionCompletedEvent
分散トランザクション完了イベント。

##### 属性
- status: DistributedTransactionStatus - ステータス
- totalExecutionTimeMs: long - 合計実行時間（ミリ秒）
- participantResults: Map<String, ParticipantResult> - 参加者結果

### 7.4 SAGAイベント

#### SagaStartedEvent
SAGA開始イベント。

##### 属性
- sagaExecutionId: String - SAGA実行ID
- sagaDefinitionId: String - SAGA定義ID
- timestamp: LocalDateTime - タイムスタンプ
- initialData: Map<String, Object> - 初期データ

#### SagaStepExecutedEvent
SAGAステップ実行イベント。

##### 属性
- sagaExecutionId: String - SAGA実行ID
- stepId: String - ステップID
- timestamp: LocalDateTime - タイムスタンプ
- successful: boolean - 成功フラグ
- resultData: Map<String, Object> - 結果データ
- error: Throwable - エラー情報

#### SagaCompletedEvent
SAGA完了イベント。

##### 属性
- sagaExecutionId: String - SAGA実行ID
- timestamp: LocalDateTime - タイムスタンプ
- successful: boolean - 成功フラグ
- resultData: Map<String, Object> - 結果データ
- executedSteps: List<String> - 実行されたステップ
- compensatedSteps: List<String> - 補償されたステップ

## 8. クライアント使用例

### 8.1 宣言的トランザクション（アノテーション使用）

OrderServiceクラスでの使用例:

#### 使用例概要
- @Transactionalアノテーションでトランザクション境界を定義
- 様々なトランザクション属性（伝播方式、分離レベル、タイムアウト）の指定方法
- ロールバック条件のカスタマイズ

#### 主要な使用パターン
1. 標準的なトランザクション - createOrder() メソッド
   - 基本的なトランザクション境界を定義
   - 複数のリポジトリ操作を一つのトランザクションで実行

2. 読み取り専用トランザクション - getOrderDetails() メソッド
   - 読み取り専用最適化を利用
   - 参照系操作のためのトランザクション

3. カスタムトランザクション設定 - processOrderPayment() メソッド
   - REQUIRES_NEW伝播方式
   - SERIALIZABLE分離レベル
   - 明示的なタイムアウト設定
   - 特定例外のロールバック制御

### 8.2 プログラム的トランザクション（TransactionTemplate使用）

InventoryServiceクラスでの使用例:

#### 使用例概要
- TransactionTemplateを使用したプログラマティックなトランザクション制御
- トランザクションテンプレートのカスタマイズ
- 複数のトランザクションテンプレートの使い分け

#### 主要な使用パターン
1. 基本的なトランザクション実行 - reserveInventory() メソッド
   - ラムダ式によるトランザクション内処理の定義
   - 例外時の明示的なロールバックマーク

2. 読み取り専用トランザクション - getInventoryLevelsForProducts() メソッド
   - 読み取り専用トランザクションテンプレートの使用
   - 参照系処理の最適化

3. カスタムトランザクション設定 - bulkUpdateInventory() メソッド
   - トランザクションテンプレートのその場でのカスタマイズ
   - REQUIRES_NEW伝播方式と REPEATABLE_READ分離レベルの設定

### 8.3 分散トランザクション管理

OrderProcessingServiceクラスでの使用例:

#### 使用例概要
- DistributedTransactionManagerによる分散トランザクション制御
- 2相コミットプロトコルの実装
- 複数サービス間トランザクション調整

#### 主要な使用パターン
1. 分散トランザクションの設定と開始
   - DistributedTransactionConfigの作成と設定
   - トランザクションIDの取得

2. 参加者の登録
   - 各サービスのトランザクション参加登録
   - エンドポイント情報の設定

3. サービス呼び出しとトランザクション伝播
   - トランザクションIDを各サービス呼び出しに伝播
   - 結果に基づくトランザクション判断

4. 2相コミットの実行
   - prepare()による準備フェーズの実行
   - 結果に基づくcommit()またはrollback()の実行

5. 例外処理とロールバック
   - 例外時の自動ロールバック
   - エラー情報の返却

### 8.4 SAGAパターンによる処理

OrderProcessingSagaServiceクラスでの使用例:

#### 使用例概要
- SagaCoordinatorによるSAGAプロセス管理
- 長時間実行トランザクションの分割実行
- 補償トランザクションによる障害回復

#### 主要な使用パターン
1. SAGA実行の準備
   - ローカルトランザクションでの初期データ作成
   - SAGAパラメータの組み立て

2. SAGAプロセスの開始と監視
   - 定義済みSAGAプロセスの実行開始
   - 非同期実行状態の監視

3. 結果に基づく処理
   - SAGA完了状態の確認
   - 成功/失敗に応じたシステム状態の更新

4. エラー処理
   - 例外発生時の処理
   - 状態の更新と結果通知

## 9. 設定例

### 9.1 Spring XMLベース設定例

Spring Framework XMLコンフィグレーションによる設定例:

#### 設定要素
- トランザクションマネージャ定義
- トランザクションテンプレート設定
- 読み取り専用トランザクションテンプレート設定
- アノテーションドリブンでのトランザクション有効化
- 分散トランザクションマネージャ設定
- SAGAコーディネーター設定
- トランザクションログサービス設定

### 9.2 Spring Javaベース設定例

Spring Framework Javaコンフィグレーションによる設定例:

#### 設定要素
- @Configuration クラス定義
- トランザクション管理有効化
- トランザクションマネージャのBean定義
- 標準・読み取り専用トランザクションテンプレートの定義
- 分散トランザクションマネージャの設定
- SAGAコーディネーターの設定
- トランザクションログサービスの設定
- トランザクションイベント発行者の設定

### 9.3 トランザクション設定プロパティ例

YAML形式での設定プロパティ例:

#### 設定カテゴリ
- ローカルトランザクション設定
  - デフォルトタイムアウト、分離レベルなど

- 分散トランザクション設定
  - コーディネータID、タイムアウト、最大参加者数など

- SAGAパターン設定
  - 定義パス、実行タイムアウト、非同期実行フラグなど

- ログ設定
  - 有効フラグ、詳細情報含有フラグ、保持日数など