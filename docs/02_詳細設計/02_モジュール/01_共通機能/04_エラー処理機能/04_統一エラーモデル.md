# エラー処理機能 - 統一エラーモデル

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2025-05-10 | 設計担当者 | 初版作成 |
| 0.2 | 2025-05-11 | 設計担当者 | 実装コード削除による軽量化 |

## 1. 機能概要

統一エラーモデルは、SES業務システム全体でエラー情報を一貫した形式で表現し、管理するための機能です。エラーコードの体系化、エラー種別の定義、エラーメッセージの管理を行い、システム全体で統一されたエラー表現を実現します。この統一されたアプローチにより、ユーザビリティの向上、開発効率の向上、運用・保守の容易性向上を実現します。

## 2. 主要コンポーネント構成

統一エラーモデル機能は以下のコンポーネントで構成されます：

### 2.1 コンポーネント構成図

```
                   ┌───────────────────┐
                   │ ErrorCodeController │
                   └─────────┬─────────┘
                             │
                             ▼
┌───────────────┐   ┌───────────────────┐   ┌─────────────────┐
│ MessageSource │◄──┤ ErrorCodeRegistry  │──►│ ErrorCodeRepository │
└───────────────┘   └─────────┬─────────┘   └─────────────────┘
                              │
                              ▼
                   ┌───────────────────┐
                   │ ErrorCodeManager  │
                   └───────────────────┘
```

### 2.2 コンポーネント説明

- **ErrorCodeController**: エラーコード管理用のRESTfulエンドポイントを提供
- **ErrorCodeRegistry**: エラーコードの一元管理と参照を担当
- **ErrorCodeManager**: エラーコードの登録・更新・削除などの管理操作を提供
- **MessageSource**: Spring Frameworkの国際化機能を使ったメッセージリソース管理
- **ErrorCodeRepository**: エラーコードの永続化を担当

## 3. エラーコード体系

### 3.1 エラーコード形式

エラーコードは、「E-AABCC」の形式で定義します：
- **E-**: エラーコードを表す固定プレフィックス
- **AA**: モジュール識別子（01: 共通, 02: 案件管理, 03: 技術者管理, など）
- **B**: エラー種別（1: 検証エラー, 2: 業務エラー, 3: システムエラー, 4: セキュリティエラー, 5: リソースエラー）
- **CC**: 連番（00-99）

例：
- **E-01101**: 共通モジュールの検証エラー01
- **E-02302**: 案件管理モジュールのシステムエラー02
- **E-03201**: 技術者管理モジュールの業務エラー01

### 3.2 モジュール識別子一覧

| モジュールID | モジュール名 |
|------------|-----------|
| 01 | 共通機能 |
| 02 | 案件管理 |
| 03 | 技術者管理 |
| 04 | マッチング |
| 05 | 契約管理 |
| 06 | 勤怠工数管理 |
| 07 | 請求支払管理 |
| 08 | レポーティング |
| 09 | システム管理 |

### 3.3 エラー種別

| 種別コード | エラー種別 | 説明 |
|-----------|---------|------|
| 1 | ValidationError（検証エラー） | ユーザー入力値の検証エラー、必須項目チェック、形式チェックエラーなど |
| 2 | BusinessError（業務エラー） | ビジネスルールに基づく制約違反、マスタデータ整合性エラー、ステータス遷移制約など |
| 3 | SystemError（システムエラー） | 内部的な技術エラー、データベースエラー、外部サービス連携エラーなど |
| 4 | SecurityError（セキュリティエラー） | 認証・認可エラー、アクセス権限エラー、セキュリティ制約違反など |
| 5 | ResourceError（リソースエラー） | リソースが存在しないエラー、リソースへのアクセス制限エラー、重複リソースエラーなど |

## 4. エラーコード管理機能

### 4.1 エラーコード登録フロー

```
1. システム管理者またはモジュール開発者がエラーコード登録APIを呼び出し
2. ErrorCodeController.registerErrorCode()メソッドが実行される
3. ErrorCodeManager.registerErrorCode()メソッドが呼び出される
   3.1. エラーコード形式の検証
   3.2. 重複チェック
   3.3. エラーコードエンティティの作成
   3.4. メッセージリソースファイルへのメッセージ追加
   3.5. エラーコードの永続化
4. 登録結果をクライアントに返却
```

### 4.2 エラーコード参照フロー

```
1. アプリケーションコードがErrorCodeRegistry.getErrorCode()メソッドを呼び出し
2. ErrorCodeRegistry.getErrorCode()メソッドが実行される
   2.1. キャッシュからエラーコードを検索
   2.2. キャッシュに存在しない場合はリポジトリから取得
   2.3. 該当するエラーコードが存在しない場合は例外をスロー
3. エラーコードをアプリケーションコードに返却
```

### 4.3 メッセージフォーマットフロー

```
1. アプリケーションコードがErrorCodeRegistry.formatMessage()メソッドを呼び出し
2. ErrorCodeRegistry.formatMessage()メソッドが実行される
   2.1. エラーコードの存在確認
   2.2. MessageSourceからメッセージテンプレートを取得
   2.3. メッセージパラメータを使用してテンプレートをフォーマット
3. フォーマットされたメッセージをアプリケーションコードに返却
```

## 5. 実装詳細

### 5.1 ErrorCodeRegistry インターフェース

ErrorCodeRegistryは以下の機能を提供します：

- **getErrorCode**: エラーコードIDからエラーコードを取得
- **existsErrorCode**: エラーコードが存在するか確認
- **formatMessage**: エラーコードとパラメータからフォーマット済みメッセージを生成
- **getModuleErrorCodes**: モジュールIDに関連するエラーコードを取得
- **getErrorCodesByType**: エラー種別によるエラーコードを取得
- **registerErrorCode**: 新規エラーコードを登録
- **updateErrorCodeMessage**: エラーコードのメッセージを更新

### 5.2 ErrorCodeManager インターフェース

ErrorCodeManagerは以下の機能を提供します：

- **registerErrorCode**: エラーコード登録DTOからエラーコードを登録
- **updateErrorCode**: エラーコードを更新
- **deleteErrorCode**: エラーコードを削除
- **getErrorCodesByModule**: モジュール別にグループ化されたエラーコードを取得

### 5.3 エラーメッセージリソース管理

エラーメッセージはプロパティファイルで多言語対応可能な形式で管理します。各言語ごとに以下のような形式でメッセージリソースファイルを用意します。

**messages_ja.properties（日本語）**:
```properties
# 共通 - 検証エラー
error.E-01101=入力値「{0}」は必須項目です。
error.E-01102=入力値「{0}」が不正です。{1}の形式で入力してください。
error.E-01103=入力値「{0}」は{1}文字以上{2}文字以下で入力してください。
error.E-01104=入力値「{0}」は{1}以上{2}以下の値を入力してください。

# 共通 - システムエラー
error.E-01301=システムエラーが発生しました。しばらく経ってから再度お試しください。
error.E-01302=データベースアクセス中にエラーが発生しました。
error.E-01303=外部サービスとの通信中にエラーが発生しました。

# 共通 - セキュリティエラー
error.E-01401=認証に失敗しました。ユーザーIDとパスワードを確認してください。
error.E-01402=このリソースへのアクセス権限がありません。
error.E-01403=セッションの有効期限が切れました。再度ログインしてください。

# 案件管理 - 業務エラー
error.E-02201=指定された案件は既に{0}状態のため、この操作は実行できません。
error.E-02202=案件の開始日は終了日よりも前の日付である必要があります。
```

**messages_en.properties（英語）**:
```properties
# Common - Validation errors
error.E-01101=Input value "{0}" is required.
error.E-01102=Input value "{0}" is invalid. Please enter in {1} format.
error.E-01103=Input value "{0}" must be between {1} and {2} characters.
error.E-01104=Input value "{0}" must be between {1} and {2}.

# Common - System errors
error.E-01301=A system error has occurred. Please try again later.
error.E-01302=An error occurred during database access.
error.E-01303=An error occurred while communicating with external service.

# Common - Security errors
error.E-01401=Authentication failed. Please check your user ID and password.
error.E-01402=You do not have permission to access this resource.
error.E-01403=Your session has expired. Please log in again.

# Project management - Business errors
error.E-02201=The specified project is already in {0} status. This operation cannot be performed.
error.E-02202=The project start date must be before the end date.
```

## 6. エラーコード一覧

### 6.1 共通モジュールの基本エラーコード

| エラーコード | 種別 | 説明 |
|------------|------|------|
| E-01101 | 検証 | 必須入力項目エラー |
| E-01102 | 検証 | 形式不正エラー |
| E-01103 | 検証 | 文字数制限エラー |
| E-01104 | 検証 | 数値範囲エラー |
| E-01105 | 検証 | 日付形式エラー |
| E-01201 | 業務 | 一般的な業務ルールエラー |
| E-01202 | 業務 | マスタデータ不整合エラー |
| E-01301 | システム | 一般的なシステムエラー |
| E-01302 | システム | データベースエラー |
| E-01303 | システム | 外部サービス連携エラー |
| E-01304 | システム | ファイル操作エラー |
| E-01401 | セキュリティ | 認証エラー |
| E-01402 | セキュリティ | 権限エラー |
| E-01403 | セキュリティ | セッションタイムアウト |
| E-01501 | リソース | リソース未検出エラー |
| E-01502 | リソース | リソース重複エラー |
| E-01503 | リソース | リソースアクセス拒否エラー |

### 6.2 各モジュール固有のエラーコード

各モジュール開発時に、上記の共通エラーコード以外に必要なエラーコードを定義します。定義されたエラーコードは一元管理され、すべてのモジュールで参照可能となります。

## 7. 例外処理ポリシー

### 7.1 例外の種類と使い分け

各例外クラスの使用方針は以下の通りです：

1. **ValidationException**: 
   - ユーザー入力値の検証エラー時
   - フォームのバリデーションエラー時
   - リクエストパラメータのチェックエラー時

2. **BusinessException**: 
   - ビジネスルール違反時
   - ステータス遷移エラー時
   - マスタデータ整合性エラー時

3. **SystemException**: 
   - データベースエラー時
   - 外部サービス連携エラー時
   - 内部的な技術エラー時

4. **SecurityException**: 
   - 認証エラー時
   - 権限エラー時
   - セキュリティ制約違反時

5. **ResourceNotFoundException**: 
   - 対象リソースが存在しない時

6. **ResourceAlreadyExistsException**: 
   - 既に存在するリソースを作成しようとした時

### 7.2 例外のスロー方法

例外をスローする際は、以下のポリシーに従います：

1. エラーコードの指定: 適切なエラーコードを指定する
2. メッセージの指定: ユーザー向けのメッセージを指定する
3. 原因の設定: 必要に応じて原因となる例外を指定する
4. パラメータの設定: メッセージ内で置換するパラメータを指定する

例外をスローする例：
```
// 例外をスローする例
if (requiredField == null) {
    throw new ValidationException("E-01101", "Required field is missing", "field_name");
}

try {
    // データベース操作
} catch (DataAccessException e) {
    throw new SystemException("E-01302", "Database error occurred", e);
}

// リソースが存在しない場合
Project project = projectRepository.findById(id)
    .orElseThrow(() -> new ResourceNotFoundException("E-02501", "Project not found", id.toString()));
```

## 8. UI表現

### 8.1 エラーメッセージの表現方法

各UIコンポーネントでのエラー表示方法を定義します：

1. **入力フォームでのフィールドエラー**:
   - エラーのある入力フィールドの下に赤字でエラーメッセージを表示
   - エラーのあるフィールドを赤枠で強調表示
   - 複数エラーがある場合は、各フィールドにそれぞれ表示

2. **処理エラーダイアログ**:
   - エラーアイコン + エラーメッセージ
   - エラーコード（トラブルシューティング用）
   - 対処方法の案内（可能な場合）
   - 閉じる/再試行などのアクションボタン

3. **エラー通知（トースト）**:
   - 軽微なエラーはトースト通知で表示
   - アイコン + 簡潔なメッセージ
   - 自動的に数秒後に消える

4. **エラーページ**:
   - 致命的なエラーは専用のエラーページにリダイレクト
   - 以下の情報を表示:
     - エラータイトル
     - エラーメッセージ
     - エラーコード
     - トラブルシューティングのヒント
     - ホームページに戻るリンク
     - サポート問い合わせ方法

### 8.2 エラーコード管理UI

システム管理者向けのエラーコード管理画面を提供します：

1. **エラーコード一覧部**:
   - モジュールごとのタブ表示
   - エラーコード、種別、メッセージ一覧をテーブル表示
   - 検索、フィルタリング機能
   - ソート機能

2. **エラーコード編集部**:
   - エラーコードの詳細表示
   - メッセージの編集機能
   - 多言語対応のための言語切り替え
   - 保存/キャンセルボタン

3. **エラーコード登録部**:
   - 新規エラーコード登録フォーム
   - 自動採番機能（次の利用可能なエラーコード提案）
   - バリデーション機能

## 9. テスト方針

### 9.1 単体テスト

- ErrorCodeRegistryの各メソッドのテスト
- ErrorCodeManagerの各メソッドのテスト
- 異常系を含むバリデーションテスト
- キャッシュ動作の検証テスト

### 9.2 統合テスト

- MessageSourceとの連携テスト
- リポジトリとの連携テスト
- APIエンドポイント呼び出しテスト
- 多言語対応テスト

### 9.3 非機能テスト

- キャッシュパフォーマンステスト
- 高負荷時の動作検証
- メモリ使用量検証