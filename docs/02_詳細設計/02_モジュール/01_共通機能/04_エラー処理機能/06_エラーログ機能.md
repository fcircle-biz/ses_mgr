# エラー処理機能 - エラーログ機能

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2025-05-10 | 設計担当者 | 初版作成 |
| 0.2 | 2025-05-11 | 設計担当者 | 実装コード削除による軽量化 |

## 1. 機能概要

エラーログ機能は、SES業務システムで発生するエラーを体系的に記録し、分析、監視するための機能です。開発者や運用担当者がシステムの問題を迅速に把握し、対応するための情報を提供します。また、エラーの発生パターンの分析を通じて、システムの改善点を特定するためのデータも提供します。

## 2. 主要コンポーネント構成

エラーログ機能は以下のコンポーネントで構成されます：

### 2.1 コンポーネント構成図

```
┌──────────────┐    ┌────────────────┐    ┌───────────────────┐
│ ErrorLogger  │───►│ LoggingService │───►│ LogRepository     │
└──────┬───────┘    └────────────────┘    └───────────────────┘
       │                                            ▲
       │                                            │
       ▼                                            │
┌───────────────┐    ┌────────────────┐    ┌───────────────────┐
│ ErrorMonitor  │───►│ ErrorAnalyzer  │───►│ ErrorStatistics   │
└───────────────┘    └────────────────┘    └───────────────────┘
       │                                            │
       ▼                                            ▼
┌───────────────┐                          ┌───────────────────┐
│ AlertService  │                          │ ErrorReportService│
└───────────────┘                          └───────────────────┘
```

### 2.2 コンポーネント説明

- **ErrorLogger**: エラー情報をログに記録するための中核コンポーネント
- **LoggingService**: ロギング機能モジュールが提供するログ記録サービス
- **LogRepository**: ログの永続化を担当するリポジトリ
- **ErrorMonitor**: エラーログをリアルタイムに監視する機能
- **ErrorAnalyzer**: エラーログを分析してパターンを抽出する機能
- **ErrorStatistics**: エラーの統計情報を管理する機能
- **AlertService**: 重大なエラー発生時に通知する機能
- **ErrorReportService**: エラーレポートを生成する機能

## 3. エラーログデータモデル

### 3.1 ErrorLog（エラーログ）エンティティ

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | エラーログID（一意識別子） |
| errorCode | String | | エラーコード（ない場合もある） |
| errorType | ErrorType | ○ | エラー種別（VALIDATION, BUSINESS, SYSTEM, SECURITY, RESOURCE） |
| message | String | ○ | エラーメッセージ |
| details | JSON | | 詳細情報（フィールドエラーなど） |
| userId | String | | ユーザーID |
| requestUri | String | | リクエストURI |
| requestMethod | String | | HTTPメソッド |
| userAgent | String | | ユーザーエージェント |
| traceId | String | | 分散トレースID |
| spanId | String | | 分散トレーススパンID |
| occurredAt | DateTime | ○ | 発生日時 |
| severity | LogSeverity | ○ | 重要度（DEBUG, INFO, WARN, ERROR, CRITICAL） |
| stackTrace | String | | スタックトレース（開発環境のみ） |
| resolvedAt | DateTime | | 解決日時 |
| resolution | String | | 解決方法 |
| environment | String | ○ | 実行環境（development, staging, production） |
| hostName | String | | ホスト名 |
| applicationName | String | ○ | アプリケーション名 |
| sessionId | String | | セッションID |

### 3.2 ErrorStatistics（エラー統計）エンティティ

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | 統計ID（一意識別子） |
| errorCode | String | ○ | エラーコード |
| startDate | Date | ○ | 集計開始日 |
| endDate | Date | ○ | 集計終了日 |
| count | Integer | ○ | 発生回数 |
| uniqueUserCount | Integer | | 影響ユーザー数 |
| lastOccurredAt | DateTime | | 最終発生日時 |
| avgResponseTime | Integer | | 平均レスポンス時間（ms） |
| impactLevel | ImpactLevel | | 影響度（LOW, MEDIUM, HIGH, CRITICAL） |
| environment | String | ○ | 実行環境 |
| moduleId | String | | モジュールID |

## 4. エラーログ記録フロー

### 4.1 標準エラーログ記録フロー

1. アプリケーション内で例外が発生
2. エラーログ記録が要求される（例外ハンドラなど）
3. ErrorLoggerのlogExceptionメソッドが呼び出される
4. 例外情報からErrorLogエンティティを構築
   4.1. トレース情報の追加
   4.2. リクエスト情報の追加
   4.3. ユーザー情報の追加
   4.4. 環境情報の追加
5. LoggingServiceを使用してログを記録
   5.1. 構造化ログとして記録
   5.2. ログレベルに応じた出力先の選択
6. 重要度に応じた追加処理
   6.1. CRITICALレベルの場合はアラート通知
   6.2. ERROR以上のレベルはエラー統計に反映

### 4.2 非同期ログ記録フロー

高負荷時のパフォーマンスを確保するため、エラーログの記録処理は非同期で行うオプションを提供します：

1. アプリケーション内で例外が発生
2. ErrorLoggerの非同期ログ記録メソッドが呼び出される
3. エラー情報をキューに追加
4. メインスレッドの処理を継続
5. 別スレッドでキューからエラー情報を取得してログ記録を実行
6. エラー統計の更新も非同期で実行

## 5. エラー監視と通知

### 5.1 エラー監視機能

1. **リアルタイムモニタリング**:
   - 発生したエラーをリアルタイムで監視
   - 特定のエラーパターンや閾値を超えた場合にアラート

2. **定期的なエラー検査**:
   - バッチジョブによる定期的なエラーログの分析
   - トレンド変化の検出と報告

3. **異常検知**:
   - 通常のエラー発生パターンからの逸脱を検知
   - 突発的なエラー増加や新種のエラーを識別

### 5.2 通知メカニズム

1. **通知チャネル**:
   - メール
   - SMS
   - チャットツール（Slack, Microsoft Teams等）
   - オンコールシステム連携

2. **通知レベルと条件**:
   - CRITICAL: 即時通知（全チャネル）
   - ERROR: 集約して定期通知（メール、チャット）
   - WARN: 日次レポートに含める
   - 特定のエラーパターン発生時: カスタム通知条件

3. **エスカレーションポリシー**:
   - 初期通知後、応答がない場合のエスカレーション手順
   - タイムアウトに基づく段階的なエスカレーション
   - 関係者への段階的な通知

## 6. エラーログ検索と分析

### 6.1 検索機能

エラーログの検索は、以下の条件で実行可能です：

1. **基本検索条件**:
   - 時間範囲（開始日時、終了日時）
   - エラーコード
   - エラー種別
   - 重要度
   - モジュールID
   - 実行環境

2. **高度な検索条件**:
   - ユーザーID
   - リクエストパス
   - トレースID
   - エラーメッセージのキーワード
   - ホスト名
   - 解決済み/未解決ステータス

3. **検索結果表示**:
   - ページング機能
   - ソート機能（発生日時、重要度など）
   - グループ化（エラーコード、ユーザーなど）

### 6.2 分析機能

1. **統計分析**:
   - 時系列でのエラー発生傾向
   - モジュール別のエラー分布
   - エラー種別ごとの発生頻度
   - ユーザー別のエラー発生状況

2. **パターン分析**:
   - 関連するエラーの関係性分析
   - エラーの連鎖パターンの検出
   - エラー発生の前後関係分析

3. **インパクト分析**:
   - ユーザーへの影響度評価
   - システムパフォーマンスへの影響評価
   - ビジネスプロセスへの影響評価

## 7. エラーレポート生成

### 7.1 レポート種類

1. **日次レポート**:
   - 過去24時間のエラー概要
   - 重要度別の発生件数
   - 新規発生したエラーパターン
   - 解決したエラー

2. **週次レポート**:
   - 週間のエラー傾向分析
   - モジュール別の安定性評価
   - 未解決エラーのステータス
   - 優先対応すべきエラー

3. **月次レポート**:
   - 月間のエラー傾向と前月比較
   - システム安定性の評価
   - 主要な問題点と改善提案
   - パフォーマンス指標の変化

### 7.2 レポート配信

1. **配信方法**:
   - メール添付
   - ダッシュボードでの表示
   - ドキュメント管理システムへの自動保存

2. **カスタマイズ**:
   - 受信者ごとのレポート内容カスタマイズ
   - 重要度に基づく内容フィルタリング
   - 担当モジュールに特化したレポート

## 8. エラーログ管理

### 8.1 データ保持ポリシー

1. **保持期間**:
   - CRITICAL, ERROR: 5年間
   - WARN: 1年間
   - INFO: 3ヶ月間
   - DEBUG: 1週間

2. **アーカイブポリシー**:
   - 保持期間を超えたデータは自動アーカイブ
   - アーカイブデータは低コストストレージに移動
   - アーカイブデータへのアクセスは制限付き

3. **削除ポリシー**:
   - アーカイブ後の一定期間経過後に自動削除
   - 法的要件に基づく例外的な保持
   - 重要なシステム障害関連のログは永久保存

### 8.2 アクセス制御

1. **ロールベースのアクセス制御**:
   - 運用管理者: 全てのログ閲覧・管理権限
   - 開発者: 開発環境・ステージング環境のログ閲覧権限
   - モジュール責任者: 担当モジュールのログ閲覧権限
   - セキュリティ担当: セキュリティ関連ログの閲覧権限

2. **環境別のアクセス制御**:
   - 本番環境ログへのアクセスは制限付き
   - 個人情報を含むログへの特別なアクセス制御
   - アクセスログの記録と監査

## 9. 連携ポイント

### 9.1 他モジュールとの連携

1. **ロギング機能モジュール**:
   - 構造化ログ出力の共通基盤として利用
   - ログレベル制御と出力先の管理

2. **監視モニタリング機能**:
   - エラー指標の監視ダッシュボードへの統合
   - アラート機能との連携

3. **分散トレース機能**:
   - トレースIDとスパンIDの関連付け
   - エラー発生コンテキストの把握

4. **ユーザー管理機能**:
   - エラー発生時のユーザーコンテキスト取得
   - ユーザー別のエラー履歴管理

5. **通知機能**:
   - エラーアラートの配信
   - レポートの配信

### 9.2 外部システムとの連携

1. **ログ集約システム（ELK, Splunk等）**:
   - エラーログの外部システムへの転送
   - 全社的なログ分析基盤との統合

2. **インシデント管理システム**:
   - 重大エラー発生時の自動インシデント作成
   - インシデント管理とエラーログの関連付け

3. **ヘルプデスクシステム**:
   - エラー情報のヘルプデスクチケットへの添付
   - エラーコードとナレッジベースの連携