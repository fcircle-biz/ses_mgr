# エラー処理機能 - ドメインモデル

## 1. エンティティ定義

### 1.1 ErrorCode（エラーコード）

システム内で定義されたエラーコードを表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| errorCode | String | ○ | エラーコード（一意識別子） |
| errorType | ErrorType | ○ | エラー種別 |
| moduleId | String | ○ | モジュールID |
| messageTemplate | String | ○ | メッセージテンプレート |
| description | String |  | 説明文 |
| createdAt | DateTime | ○ | 作成日時 |
| updatedAt | DateTime | ○ | 更新日時 |

#### バリデーションルール

- `errorCode`: 「E-AABCC」形式（AA: モジュールID, B: エラー種別, CC: 連番）
- `messageTemplate`: 空文字列不可
- `moduleId`: 2桁の数字（01～99）

#### ビジネスルール

- エラーコードは一度作成すると変更不可
- メッセージテンプレートは変更可能
- システム定義の基本エラーコードは削除不可

### 1.2 ErrorLog（エラーログ）

システム内で発生したエラーの記録を表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | エラーログID（一意識別子） |
| errorCode | String |  | エラーコード |
| errorType | ErrorType | ○ | エラー種別 |
| message | String | ○ | エラーメッセージ |
| details | JSON |  | 詳細情報 |
| userId | String |  | ユーザーID |
| requestUri | String |  | リクエストURI |
| requestMethod | String |  | HTTPメソッド |
| userAgent | String |  | ユーザーエージェント |
| traceId | String |  | 分散トレースID |
| occurredAt | DateTime | ○ | 発生日時 |
| severity | LogSeverity | ○ | 重要度 |
| stackTrace | String |  | スタックトレース |
| resolvedAt | DateTime |  | 解決日時 |
| resolution | String |  | 解決方法 |

#### バリデーションルール

- `message`: 空文字列不可
- `occurredAt`: 未来の日時は不可

#### ビジネスルール

- エラーログは作成後変更不可（解決情報のみ更新可能）
- 古いエラーログは保存ポリシーに基づいてアーカイブ

### 1.3 ErrorStatistics（エラー統計）

エラー発生の集計情報を表すエンティティです。

#### 属性

| 属性名 | 型 | 必須 | 説明 |
|-------|------|------|------|
| id | UUID | ○ | 統計ID（一意識別子） |
| errorCode | String | ○ | エラーコード |
| startDate | Date | ○ | 集計開始日 |
| endDate | Date | ○ | 集計終了日 |
| count | Integer | ○ | 発生回数 |
| uniqueUserCount | Integer |  | 影響ユーザー数 |
| lastOccurredAt | DateTime |  | 最終発生日時 |
| avgResponseTime | Integer |  | 平均レスポンス時間（ms） |
| impactLevel | ImpactLevel |  | 影響度 |

#### バリデーションルール

- `count`: 0以上の整数
- `startDate`: endDateより前の日付
- `endDate`: startDateより後の日付

#### ビジネスルール

- 統計情報は日次バッチで自動集計
- 影響度は発生回数と影響ユーザー数から自動計算

## 2. 値オブジェクト定義

### 2.1 ErrorType（エラー種別）

エラーの種類を表す列挙型です。

```java
public enum ErrorType {
    VALIDATION,    // 検証エラー
    BUSINESS,      // 業務エラー
    SYSTEM,        // システムエラー
    SECURITY,      // セキュリティエラー
    RESOURCE       // リソースエラー
}
```

### 2.2 LogSeverity（ログ重要度）

エラーログの重要度を表す列挙型です。

```java
public enum LogSeverity {
    DEBUG,     // デバッグ情報
    INFO,      // 情報
    WARN,      // 警告
    ERROR,     // エラー
    CRITICAL   // 重大エラー
}
```

### 2.3 ImpactLevel（影響度）

エラーの影響レベルを表す列挙型です。

```java
public enum ImpactLevel {
    LOW,       // 低（影響小）
    MEDIUM,    // 中（一部機能に影響）
    HIGH,      // 高（主要機能に影響）
    CRITICAL   // 致命的（システム全体に影響）
}
```

### 2.4 ErrorResponse（エラーレスポンス）

API呼び出し時のエラーレスポンスを表す値オブジェクトです。

```java
public class ErrorResponse {
    private String status;           // 常に "error"
    private String errorCode;        // エラーコード
    private String errorType;        // エラー種別の文字列表現
    private String message;          // ユーザー向けメッセージ
    private List<ErrorDetail> details; // エラー詳細（フィールドエラーなど）
    private LocalDateTime timestamp;  // エラー発生日時
    private String requestId;         // リクエスト識別子
    private String path;              // エラー発生リソースパス
    private String traceId;           // 分散トレースID
    private String cause;             // 技術的なエラー原因（開発者向け）
    
    // getters, setters
}
```

### 2.5 ErrorDetail（エラー詳細）

エラーの詳細情報を表す値オブジェクトです。特に検証エラーで使用されます。

```java
public class ErrorDetail {
    private String field;      // エラーのあるフィールド名
    private String message;    // フィールド固有のエラーメッセージ
    private String code;       // エラーコード
    private Object rejectedValue; // 拒否された値
    
    // getters, setters
}
```

## 3. ドメイン関連図

```
ErrorCode <----- ErrorLog
              |
              v
         ErrorStatistics
```

- `ErrorLog` は `ErrorCode` を参照します（任意）
- `ErrorStatistics` は `ErrorCode` ごとに集計されます

## 4. 重要なビジネスルール

### 4.1 エラーコード体系ルール

- エラーコードは「E-AABCC」形式で管理します
  - AA: モジュールID（01: 共通, 02: 案件管理, 03: 技術者管理 など）
  - B: エラー種別（1: 検証, 2: 業務, 3: システム, 4: セキュリティ, 5: リソース）
  - CC: 連番（00-99）

- 例:
  - E-01101: 共通モジュールの検証エラー01
  - E-02302: 案件管理モジュールのシステムエラー02
  - E-03201: 技術者管理モジュールの業務エラー01

### 4.2 エラー情報の開示制御ルール

- ユーザー向けの情報開示
  - 一般ユーザーには技術的な詳細（スタックトレースなど）を表示しない
  - ビジネスエラーは具体的なメッセージを表示
  - システムエラーは一般的なメッセージのみ表示
  
- 環境による開示制御
  - 開発環境: すべてのエラー情報（スタックトレース、原因など）を表示
  - ステージング環境: 一部の技術的な情報を非表示
  - 本番環境: 技術的な情報はログのみに記録し、ユーザーには表示しない

### 4.3 エラーログ管理ルール

- 重要度に応じたログ処理
  - CRITICAL: 即時アラート通知 + ログ記録
  - ERROR: ログ記録 + 定期レポート
  - WARN: ログ記録
  - INFO, DEBUG: 開発環境のみログ記録

- ログデータ保持ポリシー
  - CRITICAL, ERROR: 5年間保持
  - WARN: 1年間保持
  - INFO, DEBUG: 3ヶ月間保持
  - 期間経過後は圧縮アーカイブ

### 4.4 例外処理の原則

- 適切な例外型の使用
  - 検証エラー: ValidationException
  - 業務ルールエラー: BusinessException
  - システムエラー: SystemException
  - セキュリティエラー: SecurityException
  - リソースエラー: ResourceException（ResourceNotFoundException など）

- 例外変換の原則
  - 技術的な例外（SQLExceptionなど）はビジネス層で意味のある例外に変換する
  - 低レベル例外の詳細はログに記録し、上位層には抽象化された例外を伝播させる
  - 例外メッセージには機密情報を含めない

### 4.5 トランザクション管理と例外処理の連携

- トランザクション境界での例外処理
  - 非チェック例外（RuntimeException）はトランザクションをロールバックさせる
  - チェック例外はロールバックしない（明示的にロールバック指定のある場合を除く）
  - ビジネス例外（BusinessException）はロールバックさせる

- 一貫したエラー処理
  - 同一操作で複数のエラーが発生した場合は集約して返す
  - トランザクションの整合性を維持するため、部分的な成功は許容しない