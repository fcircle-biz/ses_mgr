# エラー処理機能 - インターフェース定義

## バージョン管理
| バージョン | 日付 | 更新者 | 更新内容 |
|----------|------|-------|---------|
| 0.1 | 2025-05-10 | 設計担当者 | 初版作成 |
| 0.2 | 2025-05-11 | 設計担当者 | 実装コード削除による軽量化 |

## 1. インターフェース概要

エラー処理機能は、SES業務システム全体でエラーと例外を一貫して処理するためのインターフェースを提供します。これらのインターフェースを通じて、各モジュールはエラーコードの取得、例外の変換、エラーレスポンスの生成、エラーログの記録などの操作を統一的に行うことができます。

## 2. 提供インターフェース

### 2.1 ExceptionHandlingService

アプリケーション内の例外を一貫して処理し、適切な変換を行うサービスインターフェースです。

#### 主要メソッド

- **convertException**: 技術的な例外をビジネス例外に変換する
- **createValidationException**: フィールドエラーのリストからValidationExceptionを作成する
- **createBusinessException**: 特定のエラーコードに対応するBusinessExceptionを作成する
- **createSystemException**: 特定のエラーコードに対応するSystemExceptionを作成する
- **createResourceNotFoundException**: 特定のエラーコードに対応するResourceNotFoundExceptionを作成する
- **handleAndRethrow**: 特定の例外をログ記録し、適切な例外に変換して再スローする

### 2.2 ErrorCodeRegistry

エラーコードを一元管理し、参照するためのサービスインターフェースです。

#### 主要メソッド

- **getErrorCode**: エラーコードIDからエラーコードエンティティを取得する
- **formatMessage**: エラーコードIDとパラメータからフォーマット済みメッセージを生成する
- **existsErrorCode**: エラーコードが存在するか確認する
- **getModuleErrorCodes**: モジュールIDに関連するエラーコード一覧を取得する
- **getErrorCodesByType**: エラー種別によるエラーコード一覧を取得する
- **registerErrorCode**: 新規エラーコードを登録する
- **updateErrorCodeMessage**: エラーコードのメッセージテンプレートを更新する

### 2.3 ErrorResponseBuilder

エラーレスポンスを構築するためのサービスインターフェースです。主にWeb/APIレイヤーで使用されます。

#### 主要メソッド

- **build**: アプリケーション例外からエラーレスポンスを構築する
- **buildValidationErrorResponse**: バリデーション例外からエラーレスポンスを構築する
- **buildMethodArgumentNotValidResponse**: Spring MVCのバリデーション例外からエラーレスポンスを構築する
- **buildGenericErrorResponse**: エラーコード、エラー種別、メッセージ、パスから汎用エラーレスポンスを構築する
- **determineStatus**: 例外の種類に基づいて適切なHTTPステータスコードを決定する

### 2.4 ErrorLogger

エラー情報をログに記録し、管理するためのサービスインターフェースです。

#### 主要メソッド

- **logException**: アプリケーション例外をログに記録する
- **logSystemException**: システム例外をログに記録する
- **logSecurityException**: セキュリティ例外をログに記録する
- **searchErrorLogs**: 検索条件とページング情報によりエラーログを検索する
- **getErrorStatistics**: 期間と対象エラーコードを指定してエラー発生の統計情報を取得する
- **detectAndAlertCriticalError**: 重大エラーを検知してアラート通知する

## 3. 要求インターフェース

### 3.1 MessageSource

Spring Frameworkが提供するメッセージ国際化と解決のためのインターフェースを利用します。

#### 主要メソッド

- **getMessage**: コード、引数、ロケールからメッセージを取得する

**使用目的と文脈**:
- エラーメッセージの国際化対応
- エラーコードに対応するメッセージの解決
- メッセージパラメータの置換

**依存度**: 高
- エラーメッセージの表示は本機能の中核的な要素であり、MessageSourceに強く依存

### 3.2 LoggingService

ロギング機能モジュールが提供するログ出力と管理のためのインターフェースを利用します。

#### 主要メソッド

- **debug/info/warn/error**: 各レベルでのログ出力
- **logStructuredData**: 構造化データのログ記録
- **setMDC/clearMDC**: MDC（Mapped Diagnostic Context）の設定・クリア

**使用目的と文脈**:
- エラー情報の構造化ログ記録
- ログレベルに応じた適切なログ出力
- 分散トレーシングIDなどのコンテキスト情報の設定

**依存度**: 高
- エラーログの記録は本機能の主要な責務であり、LoggingServiceに強く依存

### 3.3 TraceIdProvider

分散トレース機能が提供するトレースID取得のためのインターフェースを利用します。

#### 主要メソッド

- **getCurrentTraceId**: 現在のトレースIDを取得
- **getCurrentSpanId**: 現在のスパンIDを取得
- **isTraceActive**: トレースがアクティブかを確認
- **putTraceIdIntoMDC**: トレースIDをMDCに設定

**使用目的と文脈**:
- エラー発生時のトレースID記録
- 分散システム間でのエラー追跡
- ログとトレースの関連付け

**依存度**: 中
- トレースIDは重要な情報だが、取得できない場合でもエラー処理の主要機能は動作可能

## 4. データ交換モデル

### 4.1 例外クラス階層

エラー処理機能では、以下の例外クラス階層を定義します：

- **BaseException**: すべてのアプリケーション例外の基底クラス
  - 属性: errorCode, args, additional情報

- **ValidationException**: 入力値検証に関する例外
  - 追加属性: fieldErrors（フィールドごとのエラー情報のリスト）

- **BusinessException**: ビジネスルール違反などの業務的な例外

- **SystemException**: システム内部エラーなどの技術的な例外

- **SecurityException**: 認証・認可などのセキュリティに関する例外

- **ResourceException**: リソース操作に関する例外の基底クラス
  - 追加属性: resourceId（リソース識別子）

  - **ResourceNotFoundException**: リソースが見つからない例外

  - **ResourceAlreadyExistsException**: リソースがすでに存在する例外

### 4.2 エラーレスポンス関連DTO

APIのエラーレスポンスを表現するためのデータ構造：

- **ErrorResponse**: API呼び出し時のエラーレスポンス
  - 属性: status, errorCode, errorType, message, details, timestamp, requestId, path, traceId, cause

- **ErrorDetail**: エラーの詳細情報（特にバリデーションエラー）
  - 属性: field, message, code, rejectedValue

### 4.3 エラーログ関連DTO

エラー情報のログ記録と検索に関連するデータ構造：

- **ErrorLogDTO**: ログに記録されたエラー情報
  - 属性: id, errorCode, errorType, message, details, userId, requestUri, requestMethod, userAgent, traceId, occurredAt, severity

- **ErrorLogSearchCriteria**: エラーログ検索条件
  - 属性: errorCodes, errorType, severity, userId, startDate, endDate, traceId, requestUri

- **ErrorStatisticsDTO**: エラー発生の集計情報
  - 属性: errorCode, errorType, errorMessage, date, count, uniqueUserCount, impactLevel

## 5. 非機能要件

### 5.1 パフォーマンス要件

- エラーコード取得: 10ms以内
- 例外ハンドリング: アプリケーション全体のレスポンスタイムに50ms以上の影響を与えないこと
- エラーログ記録: 非同期処理とし、メインスレッドのブロックを最小限に抑える
- エラーログ検索: 100,000件のログに対して検索結果を1秒以内に返却

### 5.2 セキュリティ要件

- エラーメッセージに機密情報（個人情報、認証情報、内部パス、SQLなど）を含めない
- 本番環境ではスタックトレースなどの技術的詳細を一般ユーザーに表示しない
- エラーログ閲覧権限は運用管理者のみに制限
- 重大なセキュリティ例外（認証失敗の連続発生など）は即時アラート通知

### 5.3 可用性要件

- エラー処理モジュール自体の障害がシステム全体に波及しないよう、フォールバック機構を実装
- エラーログのディスク容量枯渇を防ぐための自動アーカイブ・クリーンアップ機能
- エラー処理の処理時間が長い場合のタイムアウト処理

### 5.4 運用要件

- エラーコードとメッセージの管理画面の提供
- エラーログの検索・閲覧画面の提供
- エラー統計レポートの自動生成（日次/週次/月次）
- 重大エラーの即時通知設定機能