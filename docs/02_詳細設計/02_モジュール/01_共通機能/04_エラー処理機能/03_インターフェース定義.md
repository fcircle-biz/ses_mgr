# エラー処理機能 - インターフェース定義

## 1. インターフェース概要

エラー処理機能は、SES業務システム全体でエラーと例外を一貫して処理するためのインターフェースを提供します。これらのインターフェースを通じて、各モジュールはエラーコードの取得、例外の変換、エラーレスポンスの生成、エラーログの記録などの操作を統一的に行うことができます。

## 2. 提供インターフェース

### 2.1 ExceptionHandlingService

アプリケーション内の例外を一貫して処理し、適切な変換を行うサービスインターフェースです。

```java
/**
 * アプリケーション内で発生する例外を処理し、適切なビジネス例外に変換するサービス
 */
public interface ExceptionHandlingService {
    /**
     * 技術的な例外をビジネス例外に変換する
     * @param technicalException 技術的な例外
     * @param errorCode 対応するエラーコード
     * @param messageArgs メッセージパラメータ
     * @return 変換されたビジネス例外
     */
    BaseException convertException(Exception technicalException, String errorCode, Object... messageArgs);
    
    /**
     * ValidationExceptionを集約された形で作成する
     * @param fieldErrors フィールドエラーのリスト
     * @return バリデーション例外
     */
    ValidationException createValidationException(List<ErrorDetail> fieldErrors);
    
    /**
     * 特定のエラーコードに対応するBusinessExceptionを作成する
     * @param errorCode エラーコード
     * @param messageArgs メッセージパラメータ
     * @return 業務例外
     */
    BusinessException createBusinessException(String errorCode, Object... messageArgs);
    
    /**
     * 特定のエラーコードに対応するSystemExceptionを作成する
     * @param errorCode エラーコード
     * @param cause 原因となる例外
     * @param messageArgs メッセージパラメータ
     * @return システム例外
     */
    SystemException createSystemException(String errorCode, Throwable cause, Object... messageArgs);
    
    /**
     * 特定のエラーコードに対応するResourceNotFoundExceptionを作成する
     * @param errorCode エラーコード
     * @param resourceId リソースID
     * @param messageArgs メッセージパラメータ
     * @return リソース未検出例外
     */
    ResourceNotFoundException createResourceNotFoundException(String errorCode, String resourceId, Object... messageArgs);
    
    /**
     * 特定の例外をログ記録し、適切な例外に変換して再スローする
     * @param ex 例外
     * @param errorCode エラーコード
     * @param messageArgs メッセージパラメータ
     * @throws BaseException 変換された例外
     */
    void handleAndRethrow(Exception ex, String errorCode, Object... messageArgs) throws BaseException;
}
```

### 2.2 ErrorCodeRegistry

エラーコードを一元管理し、参照するためのサービスインターフェースです。

```java
/**
 * エラーコードの一元管理と参照を行うサービス
 */
public interface ErrorCodeRegistry {
    /**
     * エラーコードを取得する
     * @param errorCodeId エラーコードID
     * @return エラーコードエンティティ
     * @throws IllegalArgumentException エラーコードが存在しない場合
     */
    ErrorCode getErrorCode(String errorCodeId);
    
    /**
     * エラーコードのメッセージをフォーマットする（引数置換）
     * @param errorCodeId エラーコードID
     * @param args メッセージパラメータ
     * @return フォーマットされたメッセージ
     */
    String formatMessage(String errorCodeId, Object... args);
    
    /**
     * エラーコードの存在確認
     * @param errorCodeId エラーコードID
     * @return 存在する場合はtrue
     */
    boolean existsErrorCode(String errorCodeId);
    
    /**
     * 特定モジュールに属するエラーコード一覧を取得する
     * @param moduleId モジュールID
     * @return エラーコードのリスト
     */
    List<ErrorCode> getModuleErrorCodes(String moduleId);
    
    /**
     * 特定のエラー種別に属するエラーコード一覧を取得する
     * @param errorType エラー種別
     * @return エラーコードのリスト
     */
    List<ErrorCode> getErrorCodesByType(ErrorType errorType);
    
    /**
     * 新しいエラーコードを登録する
     * @param errorCode エラーコードエンティティ
     * @return 登録されたエラーコード
     * @throws DuplicateEntityException 既に存在するエラーコードの場合
     */
    ErrorCode registerErrorCode(ErrorCode errorCode);
    
    /**
     * エラーコードのメッセージテンプレートを更新する
     * @param errorCodeId エラーコードID
     * @param newMessageTemplate 新しいメッセージテンプレート
     * @return 更新されたエラーコード
     * @throws IllegalArgumentException エラーコードが存在しない場合
     */
    ErrorCode updateErrorCodeMessage(String errorCodeId, String newMessageTemplate);
}
```

### 2.3 ErrorResponseBuilder

エラーレスポンスを構築するためのサービスインターフェースです。主にWeb/APIレイヤーで使用されます。

```java
/**
 * エラーレスポンスを構築するサービス
 */
public interface ErrorResponseBuilder {
    /**
     * アプリケーション例外からエラーレスポンスを構築する
     * @param ex アプリケーション例外
     * @param request Webリクエスト
     * @return エラーレスポンス
     */
    ErrorResponse build(BaseException ex, WebRequest request);
    
    /**
     * バリデーション例外からエラーレスポンスを構築する
     * @param ex バリデーション例外
     * @param request Webリクエスト
     * @return エラーレスポンス
     */
    ErrorResponse buildValidationErrorResponse(ValidationException ex, WebRequest request);
    
    /**
     * Spring MVCのバリデーション例外からエラーレスポンスを構築する
     * @param ex Spring MVCのバリデーション例外
     * @param request Webリクエスト
     * @return エラーレスポンス
     */
    ErrorResponse buildMethodArgumentNotValidResponse(MethodArgumentNotValidException ex, WebRequest request);
    
    /**
     * 汎用エラーレスポンスを構築する
     * @param errorCode エラーコード
     * @param errorType エラー種別
     * @param message メッセージ
     * @param path リソースパス
     * @return エラーレスポンス
     */
    ErrorResponse buildGenericErrorResponse(String errorCode, ErrorType errorType, String message, String path);
    
    /**
     * 例外の種類に基づいて適切なHTTPステータスコードを決定する
     * @param ex アプリケーション例外
     * @return HTTPステータスコード
     */
    HttpStatus determineStatus(BaseException ex);
}
```

### 2.4 ErrorLogger

エラー情報をログに記録し、管理するためのサービスインターフェースです。

```java
/**
 * エラー情報のログ記録と管理を行うサービス
 */
public interface ErrorLogger {
    /**
     * アプリケーション例外をログに記録する
     * @param ex アプリケーション例外
     * @param request Webリクエスト
     */
    void logException(BaseException ex, WebRequest request);
    
    /**
     * システム例外をログに記録する
     * @param ex システム例外
     * @param request Webリクエスト
     */
    void logSystemException(Exception ex, WebRequest request);
    
    /**
     * セキュリティ例外をログに記録する
     * @param ex セキュリティ例外
     * @param request Webリクエスト
     */
    void logSecurityException(Exception ex, WebRequest request);
    
    /**
     * エラーログを検索する
     * @param criteria 検索条件
     * @param pageable ページング情報
     * @return エラーログのページング結果
     */
    Page<ErrorLogDTO> searchErrorLogs(ErrorLogSearchCriteria criteria, Pageable pageable);
    
    /**
     * エラー発生の統計情報を取得する
     * @param startDate 開始日
     * @param endDate 終了日
     * @param errorCodes 対象エラーコード（指定しない場合はすべて）
     * @return エラー統計情報のリスト
     */
    List<ErrorStatisticsDTO> getErrorStatistics(LocalDate startDate, LocalDate endDate, List<String> errorCodes);
    
    /**
     * 重大エラーを検知してアラート通知する
     * @param errorLog エラーログ
     */
    void detectAndAlertCriticalError(ErrorLog errorLog);
}
```

## 3. 要求インターフェース

### 3.1 MessageSource

Spring Frameworkが提供するメッセージ国際化と解決のためのインターフェースを利用します。

```java
// Spring Frameworkが提供するインターフェース（参照のみ）
public interface MessageSource {
    String getMessage(String code, Object[] args, String defaultMessage, Locale locale);
    String getMessage(String code, Object[] args, Locale locale) throws NoSuchMessageException;
    String getMessage(MessageSourceResolvable resolvable, Locale locale) throws NoSuchMessageException;
}
```

**使用目的と文脈**:
- エラーメッセージの国際化対応
- エラーコードに対応するメッセージの解決
- メッセージパラメータの置換

**依存度**: 高
- エラーメッセージの表示は本機能の中核的な要素であり、MessageSourceに強く依存

### 3.2 LoggingService

ロギング機能モジュールが提供するログ出力と管理のためのインターフェースを利用します。

```java
// ロギング機能モジュールが提供するインターフェース（参照のみ）
public interface LoggingService {
    void debug(String message, Object... args);
    void info(String message, Object... args);
    void warn(String message, Object... args);
    void error(String message, Object... args);
    void error(String message, Throwable throwable, Object... args);
    
    void logStructuredData(String eventType, Map<String, Object> data, LogSeverity severity);
    void setMDC(String key, String value);
    void clearMDC();
}
```

**使用目的と文脈**:
- エラー情報の構造化ログ記録
- ログレベルに応じた適切なログ出力
- 分散トレーシングIDなどのコンテキスト情報の設定

**依存度**: 高
- エラーログの記録は本機能の主要な責務であり、LoggingServiceに強く依存

### 3.3 TraceIdProvider

分散トレース機能が提供するトレースID取得のためのインターフェースを利用します。

```java
// 分散トレース機能が提供するインターフェース（参照のみ）
public interface TraceIdProvider {
    String getCurrentTraceId();
    String getCurrentSpanId();
    boolean isTraceActive();
    void putTraceIdIntoMDC();
}
```

**使用目的と文脈**:
- エラー発生時のトレースID記録
- 分散システム間でのエラー追跡
- ログとトレースの関連付け

**依存度**: 中
- トレースIDは重要な情報だが、取得できない場合でもエラー処理の主要機能は動作可能

## 4. データ交換モデル

### 4.1 例外クラス階層

```java
// 基底例外クラス
public abstract class BaseException extends RuntimeException {
    private final String errorCode;
    private final Object[] args;
    private final Map<String, Object> additional = new HashMap<>();
    
    public BaseException(String errorCode, String message, Throwable cause, Object... args) {
        super(message, cause);
        this.errorCode = errorCode;
        this.args = args;
    }
    
    // getters, setters, utility methods
}

// 検証例外
public class ValidationException extends BaseException {
    private List<ErrorDetail> fieldErrors;
    
    public ValidationException(String errorCode, String message, List<ErrorDetail> fieldErrors, Object... args) {
        super(errorCode, message, null, args);
        this.fieldErrors = fieldErrors;
    }
    
    // getters, setters
}

// 業務例外
public class BusinessException extends BaseException {
    public BusinessException(String errorCode, String message, Object... args) {
        super(errorCode, message, null, args);
    }
    
    // constructors, methods
}

// システム例外
public class SystemException extends BaseException {
    public SystemException(String errorCode, String message, Throwable cause, Object... args) {
        super(errorCode, message, cause, args);
    }
    
    // constructors, methods
}

// セキュリティ例外
public class SecurityException extends BaseException {
    public SecurityException(String errorCode, String message, Object... args) {
        super(errorCode, message, null, args);
    }
    
    // constructors, methods
}

// リソース例外基底クラス
public abstract class ResourceException extends BaseException {
    private final String resourceId;
    
    public ResourceException(String errorCode, String message, String resourceId, Object... args) {
        super(errorCode, message, null, args);
        this.resourceId = resourceId;
    }
    
    // getters, constructors, methods
}

// リソース未検出例外
public class ResourceNotFoundException extends ResourceException {
    public ResourceNotFoundException(String errorCode, String message, String resourceId, Object... args) {
        super(errorCode, message, resourceId, args);
    }
    
    // constructors, methods
}

// リソース重複例外
public class ResourceAlreadyExistsException extends ResourceException {
    public ResourceAlreadyExistsException(String errorCode, String message, String resourceId, Object... args) {
        super(errorCode, message, resourceId, args);
    }
    
    // constructors, methods
}
```

### 4.2 エラーレスポンス関連DTO

```java
// エラーレスポンスDTO
public class ErrorResponse {
    private String status;
    private String errorCode;
    private String errorType;
    private String message;
    private List<ErrorDetail> details;
    private LocalDateTime timestamp;
    private String requestId;
    private String path;
    private String traceId;
    private String cause;
    
    // getters, setters
}

// エラー詳細DTO
public class ErrorDetail {
    private String field;
    private String message;
    private String code;
    private Object rejectedValue;
    
    // getters, setters
}
```

### 4.3 エラーログ関連DTO

```java
// エラーログDTO
public class ErrorLogDTO {
    private UUID id;
    private String errorCode;
    private ErrorType errorType;
    private String message;
    private Map<String, Object> details;
    private String userId;
    private String requestUri;
    private String requestMethod;
    private String userAgent;
    private String traceId;
    private LocalDateTime occurredAt;
    private LogSeverity severity;
    
    // getters, setters
}

// エラーログ検索条件
public class ErrorLogSearchCriteria {
    private List<String> errorCodes;
    private ErrorType errorType;
    private LogSeverity severity;
    private String userId;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private String traceId;
    private String requestUri;
    
    // getters, setters
}

// エラー統計情報DTO
public class ErrorStatisticsDTO {
    private String errorCode;
    private ErrorType errorType;
    private String errorMessage;
    private LocalDate date;
    private Integer count;
    private Integer uniqueUserCount;
    private ImpactLevel impactLevel;
    
    // getters, setters
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- エラーコード取得: 10ms以内
- 例外ハンドリング: アプリケーション全体のレスポンスタイムに50ms以上の影響を与えないこと
- エラーログ記録: 非同期処理とし、メインスレッドのブロックを最小限に抑える
- エラーログ検索: 100,000件のログに対して検索結果を1秒以内に返却

### 5.2 セキュリティ要件

- エラーメッセージに機密情報（個人情報、認証情報、内部パス、SQLなど）を含めない
- 本番環境ではスタックトレースなどの技術的詳細を一般ユーザーに表示しない
- エラーログ閲覧権限は運用管理者のみに制限
- 重大なセキュリティ例外（認証失敗の連続発生など）は即時アラート通知

### 5.3 可用性要件

- エラー処理モジュール自体の障害がシステム全体に波及しないよう、フォールバック機構を実装
- エラーログのディスク容量枯渇を防ぐための自動アーカイブ・クリーンアップ機能
- エラー処理の処理時間が長い場合のタイムアウト処理

### 5.4 運用要件

- エラーコードとメッセージの管理画面の提供
- エラーログの検索・閲覧画面の提供
- エラー統計レポートの自動生成（日次/週次/月次）
- 重大エラーの即時通知設定機能