# スキル管理機能

## 1. 機能概要

スキル管理機能は、SES業務システムにおいて技術者のスキル情報を登録・更新・管理するための機能です。技術スキル、業務スキル、資格情報などを統合的に管理し、マッチングや技術者検索の基盤となる情報を提供します。

### 主な責務
- 技術者のスキル情報の登録・更新・削除・参照
- スキル定義マスタの管理
- スキルカテゴリの管理
- スキルレベルの評価と検証
- 資格情報の管理
- スキル情報の検索と集計

## 2. 主要コンポーネント構成

スキル管理機能は、以下の主要コンポーネントから構成されます。

### 2.1 SkillController

スキル情報操作のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- スキル関連操作のREST APIエンドポイント提供
- リクエストのバリデーション
- レスポンスの整形と返却
- エラーハンドリング

### 2.2 SkillManagementService

スキル情報管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- スキル情報の登録・更新・削除・参照のビジネスロジック実装
- スキル評価・検証ロジックの実装
- スキル情報のビジネスルール適用
- トランザクション管理
- ドメインイベントの発行

### 2.3 SkillRepository

スキル情報のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- スキル情報のデータベース操作（CRUD）
- スキル検索クエリの実行
- データベースとのマッピング
- 集計クエリの実行

### 2.4 SkillDefinitionRepository

スキル定義マスタのデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- スキル定義情報のデータベース操作（CRUD）
- スキル定義の検索
- スキルカテゴリの管理

### 2.5 CertificationRepository

資格情報のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- 資格情報のデータベース操作（CRUD）
- 資格の検証ステータス管理
- 資格証明書ファイルの関連付け

### 2.6 SkillValidator

スキル情報のバリデーションを行うコンポーネントです。

**主な責務:**
- スキル情報の整合性チェック
- スキルレベルのバリデーション
- 重複スキル登録のチェック
- 資格情報のバリデーション

### 2.7 SkillEventPublisher

スキル情報の変更に関するイベントを発行するコンポーネントです。

**主な責務:**
- スキル更新イベントの発行
- 資格取得イベントの発行
- スキル検証完了イベントの発行
- イベントデータの構築

## 3. 処理フロー

スキル管理機能における主要な処理フローを説明します。

### 3.1 スキル情報登録フロー

1. クライアントがスキル登録APIを呼び出し、技術者IDとスキル情報を送信
2. SkillControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. SkillValidatorがスキル情報の詳細バリデーションを実行
   - スキル定義の存在確認
   - スキルレベルの有効性確認
   - 技術者の存在確認
   - 重複スキル登録のチェック
4. SkillManagementServiceがスキル登録のビジネスロジックを処理
   - 技術者スキルエンティティの生成
   - デフォルト値の設定（検証状態など）
5. SkillRepositoryがスキル情報をデータベースに保存
6. SkillEventPublisherがスキル追加イベントを発行
7. SkillControllerが結果をクライアントに返却

### 3.2 スキル情報更新フロー

1. クライアントがスキル更新APIを呼び出し、更新対象のIDと更新情報を送信
2. SkillControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. SkillManagementServiceが対象のスキル情報をリポジトリから取得
4. 対象スキルが存在しない場合はエラーを返却
5. SkillValidatorが更新情報の詳細バリデーションを実行
6. SkillManagementServiceがスキル情報の更新ロジックを処理
   - 更新対象フィールドの判定
   - スキルレベル変更時の検証状態リセット
   - 更新履歴の記録
7. SkillRepositoryが更新されたスキル情報をデータベースに保存
8. SkillEventPublisherがスキル更新イベントを発行
9. SkillControllerが結果をクライアントに返却

### 3.3 スキル検証フロー

1. クライアントがスキル検証APIを呼び出し、検証対象のスキルIDと検証結果を送信
2. SkillControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. SkillManagementServiceが対象のスキル情報をリポジトリから取得
4. 対象スキルが存在しない場合はエラーを返却
5. 現在のユーザーがスキル検証権限を持つか確認
6. SkillManagementServiceがスキル検証ロジックを処理
   - 検証状態の更新
   - 検証者と検証日時の記録
   - 検証コメントの記録
7. SkillRepositoryが更新されたスキル情報をデータベースに保存
8. SkillEventPublisherがスキル検証完了イベントを発行
9. SkillControllerが結果をクライアントに返却

### 3.4 技術者スキル一覧取得フロー

1. クライアントが技術者スキル一覧APIを呼び出し、技術者IDを送信
2. SkillControllerがリクエストを受け取り、パラメータをバリデーション
3. SkillManagementServiceが技術者のスキル一覧取得ロジックを実行
4. SkillRepositoryが指定された技術者のスキル情報一覧を取得
5. 必要に応じてスキルカテゴリでグループ化
6. 各スキル情報にスキル定義の詳細情報を付加
7. SkillControllerがスキル情報一覧をレスポンスとして整形
8. クライアントにスキル情報一覧を返却

### 3.5 資格情報登録フロー

1. クライアントが資格登録APIを呼び出し、技術者IDと資格情報を送信
2. SkillControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. SkillValidatorが資格情報の詳細バリデーションを実行
   - 資格種別の存在確認
   - 日付の有効性確認
   - 技術者の存在確認
4. 添付ファイルがある場合はファイルストレージサービスに保存
5. SkillManagementServiceが資格登録のビジネスロジックを処理
   - 資格エンティティの生成
   - デフォルト検証状態の設定
6. CertificationRepositoryが資格情報をデータベースに保存
7. SkillEventPublisherが資格登録イベントを発行
8. SkillControllerが結果をクライアントに返却

### 3.6 スキル定義・カテゴリ管理フロー

1. 管理者がスキル定義管理APIを呼び出し
2. SkillControllerがリクエストを受け取り、管理者権限を確認
3. SkillDefinitionRepositoryからスキル定義情報を取得または更新
4. スキルカテゴリの階層構造を維持
5. スキル定義の更新はすべての依存スキルに影響するため慎重に処理
6. 変更内容をデータベースに反映
7. SkillControllerが結果をクライアントに返却

## 4. データモデル参照

スキル管理機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティを扱います。

- 技術者スキル (EngineerSkill) エンティティ
- スキル定義 (SkillDefinition) エンティティ
- スキルカテゴリ (SkillCategory) エンティティ
- 資格 (Certification) エンティティ

## 5. バリデーションルール

スキル管理機能に適用されるバリデーションルールは以下の通りです。

### 5.1 技術者スキルバリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| engineerId | 必須、存在する技術者ID |
| skillDefinitionId | 必須、存在するスキル定義ID |
| skillLevel | 必須、1-5の整数 |
| experienceMonths | 必須、0以上の整数 |
| note | 任意、最大500文字 |

### 5.2 スキル定義バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| skillCode | 必須、英数字のみ、最大50文字、システム内で一意 |
| skillName | 必須、最大100文字 |
| skillCategoryId | 必須、存在するスキルカテゴリID |
| description | 任意、最大500文字 |
| evalCriteria | 任意、最大1000文字 |
| isActive | 必須、真偽値 |

### 5.3 スキルカテゴリバリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| categoryCode | 必須、英数字のみ、最大50文字、システム内で一意 |
| categoryName | 必須、最大100文字 |
| parentCategoryId | 任意、存在するスキルカテゴリID |
| displayOrder | 必須、0以上の整数 |
| description | 任意、最大500文字 |
| isActive | 必須、真偽値 |

### 5.4 資格バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| engineerId | 必須、存在する技術者ID |
| certificationTypeId | 必須、存在する資格種別ID |
| certificationCode | 任意、最大100文字 |
| acquisitionDate | 必須、過去の日付または現在の日付 |
| expirationDate | 任意、acquisitionDateより後の日付 |
| fileId | 任意、存在するファイルID |
| note | 任意、最大500文字 |

## 6. 例外処理

スキル管理機能における主な例外処理は以下の通りです。

### 6.1 バリデーション例外

- **InvalidSkillDataException**: スキルデータが無効な場合にスローされる例外
  - 処理: クライアントにバリデーションエラーの詳細を返却

### 6.2 重複例外

- **DuplicateSkillException**: 同一技術者に同一スキル定義のスキルを重複登録しようとした場合にスローされる例外
  - 処理: クライアントに重複エラーメッセージを返却
  
- **DuplicateSkillCodeException**: 既に存在するスキルコードでスキル定義を登録しようとした場合にスローされる例外
  - 処理: クライアントに重複エラーメッセージを返却

### 6.3 リソース未検出例外

- **SkillNotFoundException**: 指定されたIDのスキルが存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却
  
- **SkillDefinitionNotFoundException**: 指定されたIDのスキル定義が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 6.4 権限例外

- **SkillVerificationAccessDeniedException**: スキル検証権限がないユーザーが検証操作を行おうとした場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

### 6.5 ファイル処理例外

- **CertificationFileProcessingException**: 資格証明書ファイルの処理中にエラーが発生した場合にスローされる例外
  - 処理: ログに詳細を記録し、クライアントにエラーメッセージを返却

### 6.6 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. バリデーション例外は詳細なエラー情報をクライアントに返却
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. トランザクション管理による整合性の確保

## 7. セキュリティ考慮事項

スキル管理機能における主なセキュリティ考慮事項は以下の通りです。

### 7.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- スキル情報の操作には以下の権限が必要
  - スキル照会: `SKILL_VIEW` 権限
  - スキル登録・更新: `SKILL_MANAGE` 権限
  - スキル検証: `SKILL_VERIFY` 権限
  - スキル定義管理: `SKILL_DEFINITION_MANAGE` 権限
- 自己スキル更新と管理者によるスキル更新の権限を分離

### 7.2 データ保護

- スキル検証履歴を含むすべてのスキル変更履歴を保持
- 機密性の高いスキル情報（内部プロジェクト名など）はマスキング機能を提供

### 7.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- SQLインジェクション対策としてパラメータ化クエリを使用
- クロスサイトスクリプティング対策として出力エスケープを実施

### 7.4 監査証跡

- スキル情報の重要な操作（登録、更新、検証、削除）はすべて監査ログに記録
- 監査ログには以下の情報を含める
  - 操作を行ったユーザーID
  - 操作の種類（登録、更新、検証、削除）
  - 操作の対象（スキルID、技術者ID）
  - 操作の日時
  - 操作のIPアドレス
  - 変更前後の値（更新の場合）

## 8. パフォーマンス最適化

スキル管理機能におけるパフォーマンス最適化策は以下の通りです。

### 8.1 データベース最適化

- 頻繁に検索される項目（技術者ID、スキル定義ID）にインデックスを作成
- 技術者スキルテーブルは大量データになるため、パーティショニング戦略を検討
- スキルレベルやスキルカテゴリでの検索を高速化するためのインデックス

### 8.2 キャッシング戦略

- スキル定義・カテゴリ（変更頻度の低いマスタデータ）のアプリケーションキャッシング
- キャッシュの有効期間: 60分
- スキル定義更新時のキャッシュ無効化処理

### 8.3 クエリ最適化

- 技術者のスキル一覧取得時に必要最小限のフィールドのみを取得
- スキルカテゴリによるグループ化をデータベース側で処理
- スキル検索のための最適化されたクエリ（部分的なインデックス利用）

### 8.4 バッチ処理

- 複数スキルの一括登録・更新機能の提供
- バルクインサート/アップデートの活用
- バッチサイズの最適化（100件単位など）

## 9. 監視とロギング

スキル管理機能における監視とロギングの方針は以下の通りです。

### 9.1 ロギング方針

- INFO レベル: 通常の操作ログ（スキル登録、更新、検証など）
- WARN レベル: 潜在的な問題（バリデーションエラー、権限不足など）
- ERROR レベル: 例外と障害（データベース接続エラー、未処理例外など）
- DEBUG レベル: 開発・トラブルシューティング用の詳細ログ

### 9.2 監視指標

- スキル管理APIの応答時間
- エラー率（4xx, 5xxレスポンス）
- スキル操作の頻度（登録数、更新数、検証数）
- スキル定義の利用状況（使用頻度の高いスキル定義）
- スキル検索のパフォーマンス

### 9.3 アラート条件

- API応答時間が閾値（1秒）を超えた場合
- エラー率が閾値（5%）を超えた場合
- スキル検証の拒否率が閾値（20%）を超えた場合
- 不正なスキル定義参照の試行が増加した場合

## 10. インターフェース連携

スキル管理機能と他モジュールとのインターフェース連携について説明します。

### 10.1 マッチングモジュールとの連携

- 技術者のスキル情報をマッチングエンジンに提供
- スキルベースのマッチングアルゴリズムで利用
- スキル要件を満たす技術者の検索

### 10.2 スキルシート管理機能との連携

- スキルシート生成のためのスキルデータ提供
- スキルシートに含めるスキル選択機能との連携

### 10.3 レポーティングモジュールとの連携

- スキル分布の分析データ提供
- スキルマップ生成のためのデータ提供
- スキルトレンド分析のためのデータ提供

### 10.4 ファイル管理モジュールとの連携

- 資格証明書ファイルの保存と取得
- ファイルメタデータの管理

## 11. マスタデータ管理

スキル管理機能におけるマスタデータ管理について説明します。

### 11.1 スキル定義マスタ管理

- スキル定義の登録・更新・無効化機能
- スキルコードの一意性管理
- スキル定義の階層管理
- 評価基準の標準化
- 類似スキルの関連付け

### 11.2 スキルカテゴリ管理

- カテゴリ階層の管理（最大3階層）
- カテゴリの表示順制御
- カテゴリの有効/無効制御
- 部署別カスタムカテゴリの管理

### 11.3 資格種別マスタ管理

- 資格種別の登録・更新・無効化機能
- 資格の有効期限ルールの設定
- 資格のレベル分け管理
- 関連スキルとの紐づけ

### 11.4 マスタデータ同期

- 外部システムとのスキル定義同期機能
- スキルトレンドに基づく定期的なマスタ更新プロセス
- マスタデータのインポート/エクスポート機能

## 12. 分析機能

スキル管理機能における分析機能について説明します。

### 12.1 スキル分布分析

- 部署別・職種別のスキル分布分析
- スキルレベルの分布状況
- スキル習得傾向の時系列分析
- 不足スキルの識別

### 12.2 技術者スキルプロファイル

- 技術者ごとのスキルレーダーチャート
- 強みスキル領域の識別
- 成長分野の推奨
- 類似スキルセットを持つ技術者のクラスタリング

### 12.3 スキルギャップ分析

- 市場需要とスキル保有状況のギャップ分析
- トレーニング推奨機能
- スキル習得計画立案支援

### 12.4 資格取得状況分析

- 資格別取得状況の分析
- 資格取得率のKPI管理
- 資格有効期限の管理と更新アラート