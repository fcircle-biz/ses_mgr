# 稼働状況管理機能

## 1. 機能概要

稼働状況管理機能は、SES業務システムにおいて技術者の稼働状況を登録・更新・管理するための機能です。技術者の現在の稼働状態、将来の予定、過去の稼働履歴を管理し、リソース割り当て、マッチング、稼働率分析の基盤となる情報を提供します。

### 主な責務
- 技術者の現在の稼働状況の管理（稼働中、待機中、研修中、休暇中など）
- 将来の稼働予定の管理（案件アサイン予定、研修予定など）
- 稼働状況の履歴管理と追跡
- 稼働状況の変更管理と通知
- 稼働率やリソース効率の分析データ提供
- 部署・チーム単位の稼働状況集計
- 空き状況に基づく技術者検索機能

## 2. 主要コンポーネント構成

稼働状況管理機能は、以下の主要コンポーネントから構成されます。

### 2.1 AvailabilityController

稼働状況操作のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- 稼働状況関連操作のREST APIエンドポイント提供
- リクエストのバリデーション
- レスポンスの整形と返却
- エラーハンドリング

### 2.2 AvailabilityService

稼働状況管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- 稼働状況の登録・更新・削除・照会のビジネスロジック実装
- 稼働状況変更のビジネスルール適用と検証
- 稼働率計算ロジックの実装
- 空き状況検索ロジックの実装
- トランザクション管理
- ドメインイベントの発行

### 2.3 AvailabilityRepository

稼働状況情報のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- 稼働状況情報のデータベース操作（CRUD）
- 稼働状況の検索クエリの実行
- 稼働履歴の取得
- データベースとのマッピング
- 稼働率集計クエリの実行

### 2.4 AvailabilityValidator

稼働状況情報のバリデーションを行うコンポーネントです。

**主な責務:**
- 稼働状況情報の整合性チェック
- 稼働期間の重複チェック
- 稼働率制約のチェック
- 関連データ（案件など）の整合性確認

### 2.5 AvailabilityEventPublisher

稼働状況の変更に関するイベントを発行するコンポーネントです。

**主な責務:**
- 稼働状況変更イベントの発行
- アサイン変更イベントの発行
- 空き状況通知イベントの発行
- イベントデータの構築

### 2.6 UtilizationAnalysisService

稼働率分析機能を提供するサービスコンポーネントです。

**主な責務:**
- 技術者の稼働率計算
- 部署・チーム単位の稼働率集計
- 期間別稼働率分析
- 稼働状況の統計データ生成

## 3. 処理フロー

稼働状況管理機能における主要な処理フローを説明します。

### 3.1 稼働状況登録/更新フロー

1. クライアントが稼働状況登録/更新APIを呼び出し、技術者IDと稼働状況情報を送信
2. AvailabilityControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. AvailabilityValidatorが稼働状況情報の詳細バリデーションを実行
   - 期間の妥当性検証
   - 稼働率の妥当性検証（0-100%）
   - 稼働期間の重複チェック
   - 案件情報の整合性確認（稼働中の場合）
4. AvailabilityServiceが稼働状況登録/更新のビジネスロジックを処理
   - 既存稼働状況の取得と比較（更新の場合）
   - 新規稼働状況エンティティの生成または既存エンティティの更新
   - ビジネスルールの適用（稼働中の場合は案件IDが必須など）
5. AvailabilityRepositoryが稼働状況情報をデータベースに保存
6. AvailabilityEventPublisherが稼働状況変更イベントを発行
   - 稼働タイプが変更された場合はAvailabilityChangedEventを発行
   - 案件アサインが変更された場合はAssignmentChangedEventを発行
7. 必要に応じて通知サービスに通知依頼（状態変化時）
8. AvailabilityControllerが結果をクライアントに返却

### 3.2 現在の稼働状況取得フロー

1. クライアントが現在の稼働状況取得APIを呼び出し、技術者IDを送信
2. AvailabilityControllerがリクエストを受け取り、パラメータをバリデーション
3. AvailabilityServiceが技術者の現在の稼働状況取得ロジックを実行
   - 現在日付を含む最新の稼働状況レコードを検索
   - 存在しない場合はデフォルト状態（待機中）を返却
4. 稼働中の場合は案件情報を取得して稼働情報に付加
5. AvailabilityControllerが稼働状況情報をレスポンスとして整形
6. クライアントに稼働状況情報を返却

### 3.3 稼働履歴取得フロー

1. クライアントが稼働履歴取得APIを呼び出し、技術者IDと期間を送信
2. AvailabilityControllerがリクエストを受け取り、パラメータをバリデーション
3. AvailabilityServiceが稼働履歴取得ロジックを実行
   - 指定期間内の稼働状況レコードを取得
   - 時系列で並べ替え
4. 各稼働状況に関連情報（案件名など）を付加
5. AvailabilityControllerが稼働履歴をレスポンスとして整形
6. クライアントに稼働履歴を返却

### 3.4 稼働状況による技術者検索フロー

1. クライアントが稼働状況検索APIを呼び出し、検索条件を送信
   - 稼働状況タイプ（待機中、一部稼働可能など）
   - 期間（開始日、終了日）
   - 稼働率条件（最低稼働率など）
   - 希望勤務地など
2. AvailabilityControllerがリクエストを受け取り、検索条件をバリデーション
3. AvailabilityServiceが検索条件に基づく技術者検索ロジックを実行
   - 期間条件を満たす技術者の検索
   - 稼働率条件を満たす技術者のフィルタリング
   - 希望勤務地条件を満たす技術者のフィルタリング
4. 検索結果をページング処理
5. 技術者の基本情報を付加
6. AvailabilityControllerが検索結果をレスポンスとして整形
7. クライアントに検索結果を返却

### 3.5 稼働率計算フロー

1. クライアントが稼働率計算APIを呼び出し、技術者ID（または部署ID）と期間を送信
2. AvailabilityControllerがリクエストを受け取り、パラメータをバリデーション
3. UtilizationAnalysisServiceが稼働率計算ロジックを実行
   - 期間内の稼働状況データを取得
   - 日別の稼働状態を集計
   - 稼働中日数 / 総営業日数 × 100 で稼働率を計算
   - 必要に応じて稼働率の内訳（プロジェクト別、稼働状態別）を集計
4. 計算結果を整形
5. AvailabilityControllerが計算結果をレスポンスとして返却
6. クライアントに稼働率情報を返却

### 3.6 部署別稼働状況集計フロー

1. クライアントが部署別稼働状況APIを呼び出し、基準日を送信
2. AvailabilityControllerがリクエストを受け取り、パラメータをバリデーション
3. UtilizationAnalysisServiceが部署別稼働状況集計ロジックを実行
   - 基準日時点の部署別技術者リストを取得
   - 各技術者の稼働状況を取得
   - 部署ごとに稼働中、待機中などの人数を集計
   - 稼働率（稼働中人数 / 総人数 × 100）を計算
4. 集計結果を部署階層に沿って整理
5. AvailabilityControllerが集計結果をレスポンスとして整形
6. クライアントに部署別稼働状況を返却

## 4. データモデル参照

稼働状況管理機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティを扱います。

- 技術者稼働状況 (EngineerAvailability) エンティティ
- 稼働検索条件 (AvailabilitySearchCriteria) 値オブジェクト

## 5. バリデーションルール

稼働状況管理機能に適用されるバリデーションルールは以下の通りです。

### 5.1 稼働状況バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| engineerId | 必須、存在する技術者ID |
| availabilityType | 必須、定義された列挙値のいずれか |
| projectId | 稼働中(ASSIGNED)の場合必須、存在する案件ID |
| startDate | 必須、現在日以降の日付（過去の稼働状況登録は特権ユーザーのみ許可） |
| endDate | 任意、startDateより後の日付（指定なしは無期限を意味） |
| workRate | 必須、0-100の整数値 |
| location | 任意、最大100文字 |
| note | 任意、最大500文字 |

### 5.2 稼働期間のバリデーション

- 同一技術者の稼働期間が重複する場合、稼働率の合計が100%を超えないこと
- 同一技術者・同一案件で期間が重複する稼働状況は登録不可
- 休職中の技術者は他の稼働状況を登録不可
- 待機中(AVAILABLE)状態は他の状態と一部期間が重複してはならない
- 稼働予定(PLANNED_ASSIGNMENT)は稼働中(ASSIGNED)と重複してはならない

### 5.3 稼働検索条件バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| availabilityType | 任意、定義された列挙値のいずれか |
| startDate | 必須、有効な日付 |
| endDate | 必須、startDateより後の日付 |
| minimumWorkRate | 必須、0-100の整数値 |
| locationPreference | 任意、最大10件の地域名リスト |

## 6. 例外処理

稼働状況管理機能における主な例外処理は以下の通りです。

### 6.1 バリデーション例外

- **InvalidAvailabilityDataException**: 稼働状況データが無効な場合にスローされる例外
  - 処理: クライアントにバリデーションエラーの詳細を返却

### 6.2 重複例外

- **AvailabilityConflictException**: 稼働期間や稼働率が既存の稼働状況と競合する場合にスローされる例外
  - 処理: クライアントに競合の詳細情報を返却

### 6.3 リソース未検出例外

- **AvailabilityNotFoundException**: 指定されたIDの稼働状況が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **EngineerNotFoundException**: 指定されたIDの技術者が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 6.4 ビジネスルール違反例外

- **AvailabilityBusinessRuleViolationException**: 稼働状況に関するビジネスルールに違反する場合にスローされる例外
  - 処理: クライアントにビジネスルール違反の詳細を返却

### 6.5 権限例外

- **AvailabilityAccessDeniedException**: 稼働状況の変更権限がない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

### 6.6 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. 競合例外は詳細な競合情報（競合期間、競合する稼働タイプなど）を提供し、ユーザーが問題を解決できるようにする
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. トランザクション管理による整合性の確保

## 7. セキュリティ考慮事項

稼働状況管理機能における主なセキュリティ考慮事項は以下の通りです。

### 7.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- 稼働状況の操作には以下の権限が必要
  - 稼働状況照会: `AVAILABILITY_VIEW` 権限
  - 稼働状況登録・更新: `AVAILABILITY_MANAGE` 権限
  - 過去の稼働状況変更: `AVAILABILITY_ADMIN` 権限
  - 稼働率レポート生成: `AVAILABILITY_REPORT` 権限
- 部署単位のアクセス制御を適用し、自部署の技術者の稼働状況のみ管理可能とする設定も可能

### 7.2 データ保護

- 稼働状況変更履歴はすべて保持し、監査可能にする
- 稼働状況変更理由は記録し、変更の適切性を担保

### 7.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- SQLインジェクション対策としてパラメータ化クエリを使用
- クロスサイトスクリプティング対策として出力エスケープを実施

### 7.4 監査証跡

- 稼働状況の操作（登録、更新、削除）はすべて監査ログに記録
- 監査ログには以下の情報を含める
  - 操作を行ったユーザーID
  - 操作の種類（登録、更新、削除）
  - 操作の対象（稼働状況ID、技術者ID）
  - 操作の日時
  - 操作のIPアドレス
  - 変更前後の値（更新の場合）
  - 変更理由（更新・削除の場合）

## 8. パフォーマンス最適化

稼働状況管理機能におけるパフォーマンス最適化策は以下の通りです。

### 8.1 データベース最適化

- 頻繁に検索される項目（技術者ID、稼働タイプ、開始日・終了日）にインデックスを作成
- 稼働状況テーブルは時間経過とともに大量データになるため、パーティショニング戦略を採用
  - 年月単位のパーティショニングにより検索効率化
- 現在の稼働状況の高速取得のための特殊インデックス

### 8.2 キャッシング戦略

- 現在の稼働状況（変更頻度の低いデータ）のキャッシング
- キャッシュの有効期間: 10分
- 稼働状況更新時のキャッシュ無効化処理

### 8.3 クエリ最適化

- 現在の稼働状況取得のための最適化クエリ
- 稼働率計算のための集計クエリの最適化
- 空き状況検索の効率化（インデックス活用、検索条件の最適化）

### 8.4 バッチ処理

- 大量の稼働状況更新はバッチ処理で効率化
- 稼働率レポート生成は非同期処理でレスポンス改善
- 夜間バッチによる稼働状況の事前集計

## 9. 監視とロギング

稼働状況管理機能における監視とロギングの方針は以下の通りです。

### 9.1 ロギング方針

- INFO レベル: 通常の操作ログ（稼働状況登録、更新、削除など）
- WARN レベル: 潜在的な問題（バリデーションエラー、競合状況など）
- ERROR レベル: 例外と障害（データベース接続エラー、未処理例外など）
- DEBUG レベル: 開発・トラブルシューティング用の詳細ログ

### 9.2 監視指標

- 稼働状況APIの応答時間
- エラー率（4xx, 5xxレスポンス）
- 稼働状況変更の頻度（登録数、更新数、削除数）
- 待機リソース数の推移
- 部署別稼働率の推移

### 9.3 アラート条件

- API応答時間が閾値（1秒）を超えた場合
- エラー率が閾値（5%）を超えた場合
- 待機リソース数が閾値を下回った場合（リソース不足警告）
- 部署の稼働率が閾値を下回った場合（低稼働率警告）

## 10. インターフェース連携

稼働状況管理機能と他モジュールとのインターフェース連携について説明します。

### 10.1 マッチングモジュールとの連携

- 空き状況データをマッチングエンジンに提供
- マッチング成立時の稼働状況自動更新
- マッチング候補技術者の空き状況確認

### 10.2 案件管理モジュールとの連携

- 案件情報との紐づけ
- 案件期間変更時の稼働状況への反映
- 案件状態変更時の稼働状況更新通知

### 10.3 勤怠工数管理モジュールとの連携

- 勤怠情報と稼働状況の整合性検証
- 休暇情報の稼働状況への反映
- 実稼働実績と稼働予定の差異分析

### 10.4 レポーティングモジュールとの連携

- 稼働率データのレポーティングへの提供
- リソース状況の見える化
- 予測稼働率情報の提供

### 10.5 通知モジュールとの連携

- 稼働状況変更時の関係者への通知
- 空きリソース発生の通知
- 稼働率低下アラートの通知

## 11. カレンダー表示と操作

稼働状況管理機能におけるカレンダー表示と操作について説明します。

### 11.1 個人稼働カレンダー

- 技術者個人の稼働カレンダー表示
- 月別・週別・日別表示切替
- 稼働タイプによる色分け表示
- カレンダー上での稼働状況登録・変更機能
- 稼働状況の詳細表示機能

### 11.2 部署稼働カレンダー

- 部署全体の稼働状況カレンダー表示
- 技術者一覧とカレンダーのマトリクス表示
- 稼働タイプ別の集計表示
- フィルタリング機能（稼働タイプ、プロジェクト別など）
- ドラッグ&ドロップでの稼働状況調整機能

### 11.3 カレンダーデータ提供

- カレンダーデータのエクスポート機能（iCal形式）
- 外部カレンダーとの連携機能
- モバイルデバイス対応表示

## 12. 稼働分析機能

稼働状況管理機能における稼働分析機能について説明します。

### 12.1 稼働率分析

- 技術者別稼働率の時系列分析
- 部署別稼働率の比較分析
- スキル別稼働率の傾向分析
- 稼働率のトレンド予測

### 12.2 リソース予測分析

- 将来の稼働予定に基づくリソース予測
- 案件終了時期を考慮した空きリソース予測
- リソース不足・過剰時期の予測

### 12.3 最適リソース配分分析

- スキルセットに基づく最適リソース配分提案
- ローテーション最適化提案
- リソース競合の検出と解決支援

### 12.4 ベンチマーク分析

- 業界平均との稼働率比較
- 過去実績との比較分析
- 目標稼働率達成状況の分析