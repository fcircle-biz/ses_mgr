# 案件管理モジュール - ドメインモデル

## 1. エンティティ定義

案件管理モジュールのコアとなるドメインモデルについて定義します。

### 1.1 Project（案件）エンティティ

`Project`は案件管理モジュールの中心的なエンティティであり、顧客から依頼された案件の情報を表現します。

```java
public class Project {
    private UUID id;                 // 案件ID
    private String projectCode;      // 案件コード
    private String name;             // 案件名
    private String description;      // 案件概要
    private ProjectStatus status;    // 案件ステータス
    private ProjectType type;        // 案件種別
    private UUID clientId;           // 顧客ID（外部参照）
    private String clientName;       // 顧客名（表示用）
    private String location;         // 勤務地
    private LocalDate startDate;     // 開始予定日
    private LocalDate endDate;       // 終了予定日
    private Integer requiredHeadcount; // 必要人数
    private BigDecimal estimatedBudget; // 予算額
    private Set<UUID> requiredSkillIds; // 必要スキルIDセット
    private UUID salesPersonId;      // 営業担当者ID
    private LocalDateTime createdAt;  // 作成日時
    private LocalDateTime updatedAt;  // 更新日時
    
    // ビジネスメソッド
    
    /**
     * 指定されたステータスに遷移可能かチェックする
     * @param newStatus 新しいステータス
     * @return 遷移可能であればtrue
     */
    public boolean canTransitionTo(ProjectStatus newStatus) {
        // ステータス遷移ルールの実装
        // 詳細は05_案件ステータス管理.mdを参照
        return status.canTransitionTo(newStatus);
    }
    
    /**
     * 案件の有効期間内かどうかをチェックする
     * @param referenceDate 基準日
     * @return 有効期間内であればtrue
     */
    public boolean isActive(LocalDate referenceDate) {
        return !referenceDate.isBefore(startDate) && 
               (endDate == null || !referenceDate.isAfter(endDate));
    }
    
    /**
     * 案件が指定日数以内に終了するかチェックする
     * @param days 日数
     * @return 指定日数以内に終了する場合true
     */
    public boolean isEndingSoon(int days) {
        if (endDate == null) {
            return false;
        }
        LocalDate today = LocalDate.now();
        return isActive(today) && 
               ChronoUnit.DAYS.between(today, endDate) <= days;
    }
    
    // その他のメソッド、ゲッター、セッター
}
```

### 1.2 ProjectStatus（案件ステータス）列挙型

`ProjectStatus`は案件のライフサイクルにおける状態を表現する列挙型です。

```java
public enum ProjectStatus {
    DRAFT("下書き"),
    PUBLISHED("公開中"),
    IN_PROGRESS("進行中"),
    MATCHING("マッチング中"),
    CONTRACTED("契約済み"),
    COMPLETED("完了"),
    CANCELLED("キャンセル");
    
    private final String displayName;
    
    ProjectStatus(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
    
    /**
     * このステータスから指定されたステータスへの遷移が可能かチェックする
     * @param newStatus 新しいステータス
     * @return 遷移可能であればtrue
     */
    public boolean canTransitionTo(ProjectStatus newStatus) {
        switch (this) {
            case DRAFT:
                // 下書きからは公開かキャンセルのみ可能
                return newStatus == PUBLISHED || 
                       newStatus == CANCELLED;
            case PUBLISHED:
                // 公開中からはマッチング中、進行中、キャンセルに変更可能
                return newStatus == MATCHING || 
                       newStatus == IN_PROGRESS || 
                       newStatus == CANCELLED;
            case MATCHING:
                // マッチング中からは契約済み、公開中、キャンセルに変更可能
                return newStatus == CONTRACTED || 
                       newStatus == PUBLISHED || 
                       newStatus == CANCELLED;
            case IN_PROGRESS:
                // 進行中からは完了、キャンセルに変更可能
                return newStatus == COMPLETED || 
                       newStatus == CANCELLED;
            case CONTRACTED:
                // 契約済みからは進行中、キャンセルに変更可能
                return newStatus == IN_PROGRESS || 
                       newStatus == CANCELLED;
            case COMPLETED:
            case CANCELLED:
                // 完了、キャンセル状態からの変更は不可
                return false;
            default:
                return false;
        }
    }
}
```

### 1.3 ProjectType（案件種別）列挙型

`ProjectType`は案件の種類を表現する列挙型です。

```java
public enum ProjectType {
    SES("SES案件"),
    CONSIGNMENT("受託案件"),
    INTERNAL("社内案件");
    
    private final String displayName;
    
    ProjectType(String displayName) {
        this.displayName = displayName;
    }
    
    public String getDisplayName() {
        return displayName;
    }
}
```

### 1.4 ProjectSkill（案件スキル）エンティティ

`ProjectSkill`は案件に必要なスキルを表現するエンティティです。

```java
public class ProjectSkill {
    private UUID projectId;         // 案件ID
    private UUID skillId;           // スキルID
    private boolean isRequired;     // 必須スキルフラグ
    private int priority;           // 優先度（1-5）
    
    // コンストラクタ、ゲッター、セッター
}
```

## 2. 値オブジェクト

案件管理で使用する値オブジェクトについて定義します。

### 2.1 ProjectPeriod（案件期間）値オブジェクト

`ProjectPeriod`は案件の期間を表す値オブジェクトです。

```java
public class ProjectPeriod {
    private final LocalDate startDate;   // 開始日
    private final LocalDate endDate;     // 終了日（任意）
    
    public ProjectPeriod(LocalDate startDate, LocalDate endDate) {
        if (startDate == null) {
            throw new IllegalArgumentException("開始日は必須です");
        }
        if (endDate != null && startDate.isAfter(endDate)) {
            throw new IllegalArgumentException("開始日は終了日より前である必要があります");
        }
        
        this.startDate = startDate;
        this.endDate = endDate;
    }
    
    public boolean includes(LocalDate date) {
        if (date == null) {
            return false;
        }
        
        boolean afterOrEqualToStart = !date.isBefore(startDate);
        boolean beforeOrEqualToEnd = endDate == null || !date.isAfter(endDate);
        
        return afterOrEqualToStart && beforeOrEqualToEnd;
    }
    
    public int getDurationDays() {
        if (endDate == null) {
            return 0; // 終了日が指定されていない場合
        }
        return (int) ChronoUnit.DAYS.between(startDate, endDate) + 1;
    }
    
    // ゲッター（イミュータブルなのでセッターは提供しない）
    public LocalDate getStartDate() {
        return startDate;
    }
    
    public LocalDate getEndDate() {
        return endDate;
    }
    
    public boolean hasEndDate() {
        return endDate != null;
    }
}
```

### 2.2 ProjectBudget（案件予算）値オブジェクト

`ProjectBudget`は案件の予算情報を表現する値オブジェクトです。

```java
public class ProjectBudget {
    private final BigDecimal amount;      // 予算額
    private final String currencyCode;    // 通貨コード（デフォルト: JPY）
    
    public ProjectBudget(BigDecimal amount) {
        this(amount, "JPY");
    }
    
    public ProjectBudget(BigDecimal amount, String currencyCode) {
        if (amount == null || amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("予算額は0以上である必要があります");
        }
        if (currencyCode == null || currencyCode.trim().isEmpty()) {
            throw new IllegalArgumentException("通貨コードは必須です");
        }
        
        this.amount = amount;
        this.currencyCode = currencyCode;
    }
    
    // ゲッター（イミュータブルなのでセッターは提供しない）
    public BigDecimal getAmount() {
        return amount;
    }
    
    public String getCurrencyCode() {
        return currencyCode;
    }
    
    public String getFormattedAmount() {
        // 通貨記号 + 3桁区切りでフォーマット
        NumberFormat format = NumberFormat.getCurrencyInstance(Locale.JAPAN);
        return format.format(amount);
    }
}
```

## 3. リポジトリインターフェース

ドメインモデルを永続化するためのリポジトリインターフェースを定義します。

### 3.1 ProjectRepository

`ProjectRepository`は案件エンティティの永続化を担当するリポジトリインターフェースです。

```java
public interface ProjectRepository {
    /**
     * 案件をIDで検索する
     * @param id 案件ID
     * @return 案件エンティティのOptional
     */
    Optional<Project> findById(UUID id);
    
    /**
     * 案件コードで案件を検索する
     * @param projectCode 案件コード
     * @return 案件エンティティのOptional
     */
    Optional<Project> findByProjectCode(String projectCode);
    
    /**
     * 条件に基づいて案件を検索する
     * @param keyword キーワード（案件名、概要に含まれる文字列）
     * @param status ステータス
     * @param type 種別
     * @param clientId 顧客ID
     * @param startDateFrom 開始日（From）
     * @param startDateTo 開始日（To）
     * @param pageable ページネーション情報
     * @return 案件エンティティのページ
     */
    Page<Project> findByConditions(
        String keyword, 
        ProjectStatus status, 
        ProjectType type, 
        UUID clientId, 
        LocalDate startDateFrom, 
        LocalDate startDateTo, 
        Pageable pageable
    );
    
    /**
     * 指定された会計年度の案件数をカウントする
     * @param fiscalYear 会計年度
     * @return 案件数
     */
    int countByFiscalYear(int fiscalYear);
    
    /**
     * 案件を保存する
     * @param project 案件エンティティ
     * @return 保存された案件エンティティ
     */
    Project save(Project project);
    
    /**
     * 案件を論理削除する
     * @param id 案件ID
     */
    void delete(UUID id);
    
    /**
     * 技術者IDに関連する案件を検索する
     * @param engineerId 技術者ID
     * @return 案件エンティティのリスト
     */
    List<Project> findByEngineerId(UUID engineerId);
    
    /**
     * 終了が近い案件を検索する
     * @param thresholdDays 残り日数閾値
     * @return 案件エンティティのリスト
     */
    List<Project> findEndingSoonProjects(int thresholdDays);
}
```

### 3.2 ProjectSkillRepository

`ProjectSkillRepository`は案件スキル関連の永続化を担当するリポジトリインターフェースです。

```java
public interface ProjectSkillRepository {
    /**
     * 案件IDに関連するスキルを取得する
     * @param projectId 案件ID
     * @return 案件スキルのリスト
     */
    List<ProjectSkill> findByProjectId(UUID projectId);
    
    /**
     * スキルIDに関連する案件を検索する
     * @param skillId スキルID
     * @return 案件スキルのリスト
     */
    List<ProjectSkill> findBySkillId(UUID skillId);
    
    /**
     * 案件スキルを保存する
     * @param projectSkill 案件スキル
     * @return 保存された案件スキル
     */
    ProjectSkill save(ProjectSkill projectSkill);
    
    /**
     * 案件IDに関連するスキルを保存する（一括）
     * @param projectId 案件ID
     * @param projectSkills 案件スキルのリスト
     */
    void saveAll(UUID projectId, List<ProjectSkill> projectSkills);
    
    /**
     * 案件IDに関連するスキルを削除する
     * @param projectId 案件ID
     */
    void deleteByProjectId(UUID projectId);
}
```

## 4. ドメインサービス

ドメインモデルに関連するビジネスロジックを実装するドメインサービスを定義します。

### 4.1 ProjectDomainService

`ProjectDomainService`は案件に関するドメインロジックを実装するドメインサービスです。

```java
public class ProjectDomainService {
    private final ProjectRepository projectRepository;
    
    public ProjectDomainService(ProjectRepository projectRepository) {
        this.projectRepository = projectRepository;
    }
    
    /**
     * 新規案件コードを生成する
     * @return 生成された案件コード
     */
    public String generateProjectCode() {
        // 現在年度の取得
        int fiscalYear = calculateCurrentFiscalYear();
        
        // その年度の案件数（シーケンス）を取得
        int sequence = projectRepository.countByFiscalYear(fiscalYear) + 1;
        
        // フォーマット: PJ{年度下2桁}{5桁連番}
        // 例: PJ2304500001
        return String.format("PJ%02d%05d", fiscalYear % 100, sequence);
    }
    
    /**
     * 現在の会計年度を計算する（4月始まり）
     * @return 会計年度（西暦）
     */
    private int calculateCurrentFiscalYear() {
        LocalDate today = LocalDate.now();
        // 4月以降は当年度、3月以前は前年度
        return today.getMonthValue() >= 4 ? today.getYear() : today.getYear() - 1;
    }
    
    /**
     * 案件ステータスの遷移が可能かチェックする
     * @param project 案件エンティティ
     * @param newStatus 新しいステータス
     * @return 遷移可能であればtrue
     */
    public boolean canUpdateStatus(Project project, ProjectStatus newStatus) {
        if (project == null || newStatus == null) {
            return false;
        }
        return project.canTransitionTo(newStatus);
    }
}
```

### 4.2 ProjectLifecycleService

`ProjectLifecycleService`は案件のライフサイクル管理を担当するドメインサービスです。

```java
public class ProjectLifecycleService {
    private final ProjectRepository projectRepository;
    
    public ProjectLifecycleService(ProjectRepository projectRepository) {
        this.projectRepository = projectRepository;
    }
    
    /**
     * 期限切れの案件を自動的に完了状態に更新する
     * @return 更新された案件数
     */
    public int completeExpiredProjects() {
        LocalDate today = LocalDate.now();
        // ステータスが進行中かつ終了日が過去の案件を取得
        List<Project> expiredProjects = projectRepository.findExpiredProjects(today);
        
        int count = 0;
        for (Project project : expiredProjects) {
            // 完了ステータスに更新可能なら更新
            if (project.canTransitionTo(ProjectStatus.COMPLETED)) {
                project.setStatus(ProjectStatus.COMPLETED);
                projectRepository.save(project);
                count++;
            }
        }
        
        return count;
    }
    
    /**
     * 間もなく開始する案件を取得する
     * @param daysThreshold 閾値（日数）
     * @return 間もなく開始する案件のリスト
     */
    public List<Project> findUpcomingProjects(int daysThreshold) {
        LocalDate today = LocalDate.now();
        LocalDate threshold = today.plusDays(daysThreshold);
        
        return projectRepository.findUpcomingProjects(today, threshold);
    }
}
```

## 5. ドメインイベント

ドメインモデルに関連するイベントを定義します。

### 5.1 ProjectCreatedEvent

`ProjectCreatedEvent`は案件作成時に発生するイベントです。

```java
public class ProjectCreatedEvent {
    private final UUID projectId;
    private final String projectCode;
    private final String projectName;
    private final LocalDateTime createdAt;
    private final UUID createdBy;
    
    public ProjectCreatedEvent(
            UUID projectId, 
            String projectCode, 
            String projectName, 
            LocalDateTime createdAt, 
            UUID createdBy) {
        this.projectId = projectId;
        this.projectCode = projectCode;
        this.projectName = projectName;
        this.createdAt = createdAt;
        this.createdBy = createdBy;
    }
    
    // ゲッター
}
```

### 5.2 ProjectStatusChangedEvent

`ProjectStatusChangedEvent`は案件ステータス変更時に発生するイベントです。

```java
public class ProjectStatusChangedEvent {
    private final UUID projectId;
    private final String projectCode;
    private final ProjectStatus oldStatus;
    private final ProjectStatus newStatus;
    private final LocalDateTime changedAt;
    private final UUID changedBy;
    
    public ProjectStatusChangedEvent(
            UUID projectId, 
            String projectCode, 
            ProjectStatus oldStatus, 
            ProjectStatus newStatus, 
            LocalDateTime changedAt, 
            UUID changedBy) {
        this.projectId = projectId;
        this.projectCode = projectCode;
        this.oldStatus = oldStatus;
        this.newStatus = newStatus;
        this.changedAt = changedAt;
        this.changedBy = changedBy;
    }
    
    // ゲッター
}
```

## 6. ドメインモデル関連図

案件管理モジュールのドメインモデル関連図は以下のようになります。

```
+----------------+      +------------------+
| Project        |<>--->| ProjectSkill     |
+----------------+      +------------------+
| id: UUID       |      | projectId: UUID  |
| projectCode    |      | skillId: UUID    |
| name           |      | isRequired       |
| description    |      | priority         |
| status         |      +------------------+
| type           |
| clientId       |      +------------------+
| ...            |      | ProjectPeriod    |
+----------------+      +------------------+
        |               | startDate        |
        |               | endDate          |
        |               +------------------+
        |
        |               +------------------+
        |               | ProjectBudget    |
        |               +------------------+
        |               | amount           |
        |               | currencyCode     |
        v               +------------------+
+----------------+
| ProjectStatus  |
+----------------+
| DRAFT          |
| PUBLISHED      |
| IN_PROGRESS    |
| MATCHING       |
| CONTRACTED     |
| COMPLETED      |
| CANCELLED      |
+----------------+
```