# 案件検索機能

## 1. 機能概要

案件検索機能は、SES業務システムにおいて、さまざまな条件に基づいて案件を柔軟かつ効率的に検索するための機能を提供します。単純なキーワード検索から複雑な条件の組み合わせまで、多様な検索ニーズに対応し、マッチングや営業活動を支援します。

### 主な責務
- 複合条件に基づく案件検索
- キーワードベースの全文検索
- スキル要件に基づく案件検索
- 検索条件の保存と再利用
- 検索結果のソートとフィルタリング
- 検索パフォーマンスの最適化

## 2. 主要コンポーネント構成

案件検索機能は、以下の主要コンポーネントから構成されます。

### 2.1 ProjectQueryController

案件検索のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- 検索リクエストの受付
- 検索パラメータのバリデーション
- 検索結果の整形と返却
- ページネーション処理
- エラーハンドリング

### 2.2 ProjectQueryService

案件検索のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- 検索条件の解析と処理
- 検索条件に基づくクエリ実行のコーディネート
- 検索結果の取得と加工
- 検索条件の保存と管理
- 複雑な検索ロジックの実装

### 2.3 ProjectSearchRepository

案件検索のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- 複雑な検索条件に基づくクエリ実行
- 検索クエリの最適化
- 検索結果のソートと集計
- パフォーマンス最適化

### 2.4 FullTextSearchService

全文検索機能を提供するサービスコンポーネントです。

**主な責務:**
- キーワードに基づく全文検索
- 関連性スコアリング
- インデックス管理
- 検索結果のランキング

### 2.5 SavedSearchRepository

保存済み検索条件のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- 保存済み検索条件の保存・取得・削除
- ユーザー別の検索条件管理
- 検索条件の共有管理

### 2.6 SearchCriteriaBuilder

検索条件構築を支援するビルダーコンポーネントです。

**主な責務:**
- 複雑な検索条件の構築支援
- 検索条件の正規化
- 条件間の矛盾検出
- デフォルト値の適用

## 3. 処理フロー

案件検索機能における主要な処理フローを説明します。

### 3.1 複合条件検索フロー

1. クライアントが複合条件検索APIを呼び出し、検索条件とページネーション情報を送信
2. ProjectQueryControllerがリクエストを受け取り、検索条件をバリデーション
3. SearchCriteriaBuilderが検索条件を正規化し、検索実行用に変換
4. ProjectQueryServiceが検索ロジックを実行
   - 基本条件の処理
   - スキル要件条件の処理
   - 予算条件の処理
   - アクセス権限によるフィルタリング条件の追加
5. ProjectSearchRepositoryが最適化されたクエリを構築して実行
6. 検索結果のカウントと、指定ページのデータを取得
7. 検索結果に必要な関連情報（顧客名、ステータス名など）を付加
8. ProjectQueryControllerが検索結果をレスポンスとして整形
9. クライアントに検索結果を返却

### 3.2 キーワード検索フロー

1. クライアントがキーワード検索APIを呼び出し、キーワードとページネーション情報を送信
2. ProjectQueryControllerがリクエストを受け取り、キーワードをバリデーション
3. ProjectQueryServiceがキーワード検索ロジックを実行
4. FullTextSearchServiceがキーワードに基づいて全文検索を実行
   - キーワードの分析（形態素解析など）
   - 関連性スコアリング
   - 検索結果のランキング
5. 検索結果に対するアクセス権限フィルタリング
6. 検索結果のカウントと、指定ページのデータを取得
7. 検索結果に必要な関連情報を付加
8. ProjectQueryControllerが検索結果をレスポンスとして整形
9. クライアントに検索結果を返却

### 3.3 スキル要件検索フロー

1. クライアントがスキル要件検索APIを呼び出し、スキル条件とページネーション情報を送信
2. ProjectQueryControllerがリクエストを受け取り、スキル条件をバリデーション
3. ProjectQueryServiceがスキル要件検索ロジックを実行
4. ProjectSearchRepositoryがスキル要件に基づく案件検索クエリを構築して実行
   - 必須スキルと任意スキルの区別
   - スキルレベルに基づくフィルタリング
   - スキル要件の重み付け
5. 検索結果に対するアクセス権限フィルタリング
6. 検索結果のカウントと、指定ページのデータを取得
7. 検索結果に必要な関連情報を付加
8. ProjectQueryControllerが検索結果をレスポンスとして整形
9. クライアントに検索結果を返却

### 3.4 検索条件保存フロー

1. クライアントが検索条件保存APIを呼び出し、保存する検索条件情報を送信
2. ProjectQueryControllerがリクエストを受け取り、保存情報をバリデーション
3. ProjectQueryServiceが検索条件保存ロジックを実行
4. 検索条件の正規化と妥当性確認
5. SavedSearchRepositoryが検索条件をデータベースに保存
6. 保存IDを生成して返却
7. ProjectQueryControllerが結果をレスポンスとして整形
8. クライアントに保存結果を返却

### 3.5 保存済み検索条件取得フロー

1. クライアントが保存済み検索条件取得APIを呼び出し、検索条件IDを送信
2. ProjectQueryControllerがリクエストを受け取り、パラメータをバリデーション
3. ProjectQueryServiceが保存済み検索条件取得ロジックを実行
4. SavedSearchRepositoryが指定された検索条件を取得
5. 検索条件が存在しない場合はエラーを返却
6. 検索条件のアクセス権限チェック（作成者または公開されたもののみアクセス可能）
7. ProjectQueryControllerが検索条件をレスポンスとして整形
8. クライアントに検索条件を返却

## 4. データモデル参照

案件検索機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティと値オブジェクトを扱います。

- 案件 (Project) エンティティ
- 案件検索条件 (ProjectSearchCriteria) 値オブジェクト
- 保存済み検索条件 (SavedSearch) エンティティ

### 4.1 保存済み検索条件 (SavedSearch) エンティティ

保存済み検索条件は、ユーザーが保存した検索条件を表現します。

| 属性 | 型 | 説明 | 制約 |
|------|------|------|------|
| searchId | Long | 検索ID | 主キー、自動採番 |
| userId | Long | ユーザーID | FK(users)、必須 |
| searchName | String | 検索名 | 必須、最大100文字 |
| description | String | 説明 | 任意、最大500文字 |
| criteriaJson | String | 検索条件（JSON形式） | 必須 |
| isPublic | Boolean | 公開フラグ | 必須、デフォルトfalse |
| lastUsedAt | Timestamp | 最終使用日時 | 任意 |
| createdAt | Timestamp | 作成日時 | 必須、自動設定 |
| updatedAt | Timestamp | 更新日時 | 必須、自動設定 |

## 5. バリデーションルール

案件検索機能に適用されるバリデーションルールは以下の通りです。

### 5.1 基本検索条件バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| keyword | 任意、最大200文字 |
| projectTypes | 任意、定義された列挙値のリスト |
| projectCategories | 任意、定義された列挙値のリスト |
| statusIds | 任意、存在するステータスIDのリスト |
| customerIds | 任意、存在する顧客IDのリスト |
| startDateFrom | 任意、有効な日付 |
| startDateTo | 任意、startDateFrom以降の日付 |
| endDateFrom | 任意、有効な日付 |
| endDateTo | 任意、endDateFrom以降の日付 |
| workLocations | 任意、文字列のリスト |
| workStyles | 任意、定義された列挙値のリスト |
| priorities | 任意、定義された列挙値のリスト |
| salesRepIds | 任意、存在するユーザーIDのリスト |
| onlyPublic | 任意、真偽値 |

### 5.2 スキル要件検索条件バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| skillDefinitionId | 必須、存在するスキル定義ID |
| minimumLevel | 任意、1-5の整数 |
| isRequired | 任意、真偽値 |

### 5.3 予算条件バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| minAmount | 任意、0以上の数値 |
| maxAmount | 任意、minAmount以上の数値 |
| currency | 必須（条件指定時）、定義された列挙値のいずれか |
| budgetType | 任意、定義された列挙値のいずれか |

### 5.4 検索条件保存バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| searchName | 必須、最大100文字 |
| description | 任意、最大500文字 |
| searchCriteria | 必須、有効な検索条件 |
| isPublic | 任意、真偽値 |

## 6. 例外処理

案件検索機能における主な例外処理は以下の通りです。

### 6.1 バリデーション例外

- **InvalidSearchCriteriaException**: 検索条件が無効な場合にスローされる例外
  - 処理: クライアントにバリデーションエラーの詳細を返却

### 6.2 リソース未検出例外

- **SavedSearchNotFoundException**: 指定されたIDの保存済み検索条件が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 6.3 権限例外

- **SavedSearchAccessDeniedException**: 保存済み検索条件へのアクセス権限がない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

### 6.4 検索実行例外

- **SearchExecutionException**: 検索実行中にエラーが発生した場合にスローされる例外
  - 処理: ログに詳細を記録し、クライアントにエラーメッセージを返却

### 6.5 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. バリデーション例外は詳細なエラー情報をクライアントに返却
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. 複雑な検索クエリのタイムアウト処理

## 7. セキュリティ考慮事項

案件検索機能における主なセキュリティ考慮事項は以下の通りです。

### 7.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- 案件検索機能の使用には以下の権限が必要
  - 基本検索: `PROJECT_VIEW` 権限
  - 高度な検索: `PROJECT_SEARCH` 権限
  - 検索条件保存: `SEARCH_SAVE` 権限
- 検索結果は自動的にアクセス権限でフィルタリングされる
  - 非公開案件
  - 機密レベルに応じたフィルタリング
- 保存済み検索条件へのアクセスは作成者または公開されたもののみ許可

### 7.2 データ保護

- 検索条件に含まれる機密情報の保護
- 検索結果に含まれる機密情報のマスキング
- 検索履歴の適切な管理

### 7.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- 特にキーワード検索での注入攻撃対策
- 複雑な検索条件のサニタイズ

### 7.4 監査証跡

- 検索操作の監査ログへの記録
  - 実行された検索条件
  - 実行したユーザー
  - 実行日時
  - ヒット件数
- 特に機密案件を含む検索や、大量の検索実行は詳細にログ記録

## 8. パフォーマンス最適化

案件検索機能におけるパフォーマンス最適化策は以下の通りです。

### 8.1 インデックス最適化

- 検索対象フィールドへの適切なインデックス作成
  - 案件名、顧客ID、ステータスIDなどの基本フィールド
  - 開始日・終了日などの日付フィールド
  - 全文検索用の特殊インデックス
- 複合インデックスの活用
  - 頻繁に組み合わせて検索される条件の複合インデックス
- インデックスの定期的な再構築と最適化

### 8.2 クエリ最適化

- 検索条件に応じた動的クエリ構築
- 不要な結合（JOIN）の回避
- 検索結果件数のみを取得するクエリの最適化
- ページネーションの適切な実装（LIMIT/OFFSETの効率的な使用）
- 検索条件の複雑さに応じたクエリ実行戦略の選択

### 8.3 キャッシング戦略

- 頻繁に実行される検索結果のキャッシング
- マスタデータ（ステータス、顧客情報など）のキャッシング
- キーワード検索インデックスのキャッシング
- 検索条件に基づくキャッシュキーの生成
- キャッシュの適切な有効期限設定（検索条件の種類に応じて）

### 8.4 非同期処理

- 複雑な検索条件での検索は非同期処理で実行
- 長時間実行される検索の進捗状況提供
- バックグラウンドでの検索結果通知機能

## 9. 監視とロギング

案件検索機能における監視とロギングの方針は以下の通りです。

### 9.1 ロギング方針

- INFO レベル: 検索実行ログ（条件、ヒット件数、実行時間）
- WARN レベル: 実行時間が閾値を超える検索、大量のヒット件数の検索
- ERROR レベル: 検索実行エラー、タイムアウト、リソース不足
- DEBUG レベル: 実行クエリの詳細、検索条件の内部変換過程

### 9.2 監視指標

- 検索API応答時間
- 検索実行回数（ユーザー別、条件種類別）
- 平均検索ヒット件数
- キャッシュヒット率
- 検索インデックスのサイズと更新頻度
- 検索条件保存数
- タイムアウトした検索の割合

### 9.3 アラート条件

- 検索API応答時間が閾値（3秒）を超えた場合
- 検索エラー率が閾値（5%）を超えた場合
- インデックス更新の失敗
- キャッシュヒット率の急激な低下
- 特定ユーザーからの過剰な検索リクエスト

## 10. ユーザーインターフェース考慮事項

案件検索機能におけるユーザーインターフェース考慮事項は以下の通りです。

### 10.1 検索条件入力UI

- 単純検索と高度検索の切り替え
- インクリメンタル検索（タイピング中に候補表示）
- 検索条件のグループ化と論理演算子（AND/OR）の視覚的表現
- スキル要件検索のための階層的選択UI
- 日付範囲のカレンダーピッカー
- よく使う検索条件のショートカット

### 10.2 検索結果表示UI

- カスタマイズ可能な列表示
- 複数ソート条件の適用
- インライン詳細表示
- CSV/Excelエクスポート機能
- 検索結果のグルーピング表示
- ステータスや優先度による色分け

### 10.3 検索条件管理UI

- 保存済み検索条件の一覧表示
- 検索条件の編集・削除
- お気に入り検索条件の設定
- 検索条件の共有設定
- 最近使用した検索条件の履歴

## 11. テスト方針

案件検索機能のテスト方針は以下の通りです。

### 11.1 単体テスト

- SearchCriteriaBuilderの条件構築ロジックテスト
- 各種検索条件の変換ロジックテスト
- バリデーションロジックの網羅的テスト
- 権限フィルタリングロジックのテスト

### 11.2 統合テスト

- 検索条件からSQLクエリ生成までの統合テスト
- 実際のデータベースを使用した検索結果検証
- キャッシュ機能の動作テスト
- 保存済み検索条件の保存と読み込みテスト

### 11.3 パフォーマンステスト

- 大量データ（1万件以上）での検索パフォーマンス
- 複雑な検索条件での応答時間測定
- 同時多数検索時のシステム挙動
- キャッシュ効果の測定

### 11.4 使いやすさテスト

- 検索UI操作性の評価
- 一般的な検索シナリオでの操作ステップ数測定
- 検索結果の関連性評価
- 検索機能の学習曲線評価