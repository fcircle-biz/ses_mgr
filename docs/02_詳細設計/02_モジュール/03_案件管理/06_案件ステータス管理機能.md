# 案件ステータス管理機能

## 1. 機能概要

案件ステータス管理機能は、SES業務システムにおいて案件のライフサイクル全体を通じたステータス遷移を管理し、業務プロセスの適切な進行をサポートする機能です。案件の状態変化を追跡し、関連システムへの通知や権限に基づいた処理制御を行います。

### 主な責務
- 案件ステータスの定義と管理
- ステータス遷移ルールの管理と適用
- ステータス変更の検証と実行
- ステータス変更履歴の記録と追跡
- ステータス変更時の通知管理
- ステータスに応じた操作制御

## 2. 主要コンポーネント構成

案件ステータス管理機能は、以下の主要コンポーネントから構成されます。

### 2.1 ProjectStatusController

案件ステータス管理のREST APIエンドポイントを提供するコントローラーコンポーネントです。

**主な責務:**
- ステータス関連操作のREST APIエンドポイント提供
- リクエストのバリデーション
- レスポンスの整形と返却
- エラーハンドリング

### 2.2 ProjectStatusService

案件ステータス管理のビジネスロジックを実装するサービスコンポーネントです。

**主な責務:**
- ステータス変更のビジネスロジック実装
- ステータス遷移ルールの検証
- ステータス変更履歴の管理
- ステータス定義の管理
- ステータス関連イベントの発行

### 2.3 ProjectStatusRepository

案件ステータス情報のデータアクセスを担当するリポジトリコンポーネントです。

**主な責務:**
- ステータス定義の取得・保存
- ステータス変更履歴の記録
- ステータス関連のデータアクセス

### 2.4 StatusTransitionValidator

ステータス遷移の検証を行うコンポーネントです。

**主な責務:**
- ステータス遷移ルールの適用
- 遷移可能なステータスの判定
- ステータス遷移の前提条件チェック

### 2.5 StatusWorkflowEngine

ステータスワークフローを制御するコンポーネントです。

**主な責務:**
- ステータスワークフローの定義
- ステータス遷移のオーケストレーション
- ステータス変更に伴う副作用処理

### 2.6 ProjectStatusEventPublisher

ステータス変更に関するイベントを発行するコンポーネントです。

**主な責務:**
- ステータス変更イベントの発行
- 関連システムへの通知
- イベントデータの構築

## 3. 処理フロー

案件ステータス管理機能における主要な処理フローを説明します。

### 3.1 ステータス変更フロー

1. クライアントがステータス変更APIを呼び出し、案件ID・新ステータスID・変更理由を送信
2. ProjectStatusControllerがリクエストを受け取り、基本的なリクエスト形式をバリデーション
3. ProjectStatusServiceが案件の現在のステータスを取得
4. StatusTransitionValidatorが遷移可能性を検証
   - 現在のステータスから新ステータスへの遷移がルール上許可されているか確認
   - ユーザーが当該遷移の権限を持っているか確認
   - 遷移の前提条件（必須項目の入力など）が満たされているか確認
5. 検証エラーがある場合は適切な例外をスローしてクライアントに返却
6. StatusWorkflowEngineがステータス遷移処理を実行
   - 案件のステータスを更新
   - ステータス変更履歴を記録
   - ステータス変更に伴う副作用処理（例：特定ステータスになった場合に関連レコードを更新）
7. ProjectStatusEventPublisherが案件ステータス変更イベントを発行
8. 通知サービスを通じて関係者に通知
9. ProjectStatusControllerが結果をクライアントに返却

### 3.2 次遷移可能ステータス取得フロー

1. クライアントが次遷移可能ステータス取得APIを呼び出し、案件IDを送信
2. ProjectStatusControllerがリクエストを受け取り、パラメータをバリデーション
3. ProjectStatusServiceが案件の現在のステータスを取得
4. StatusTransitionValidatorが現在のステータスから遷移可能なステータス一覧を取得
   - ステータス定義から遷移ルールを参照
   - ユーザーの権限に基づいてフィルタリング
5. 遷移可能ステータスの詳細情報（名称、説明など）を取得
6. ProjectStatusControllerが遷移可能ステータス一覧をレスポンスとして整形
7. クライアントに遷移可能ステータス一覧を返却

### 3.3 ステータス変更履歴取得フロー

1. クライアントがステータス変更履歴取得APIを呼び出し、案件IDを送信
2. ProjectStatusControllerがリクエストを受け取り、パラメータをバリデーション
3. ProjectStatusServiceがステータス変更履歴取得ロジックを実行
4. ProjectStatusRepositoryが指定された案件のステータス変更履歴をデータベースから取得
   - 時系列順に並べ替え
   - ステータス名や変更者情報などの関連情報を付加
5. ProjectStatusControllerがステータス変更履歴をレスポンスとして整形
6. クライアントにステータス変更履歴を返却

### 3.4 ステータス定義一覧取得フロー

1. クライアントがステータス定義一覧取得APIを呼び出し
2. ProjectStatusControllerがリクエストを受け取り
3. ProjectStatusServiceがステータス定義一覧取得ロジックを実行
4. ProjectStatusRepositoryがステータス定義一覧をデータベースから取得
   - 表示順に並べ替え
   - 有効なステータスのみフィルタリング（isActive=true）
5. 各ステータスの詳細情報（名称、説明、色など）を付加
6. ProjectStatusControllerがステータス定義一覧をレスポンスとして整形
7. クライアントにステータス定義一覧を返却

### 3.5 ステータス別案件カウントフロー

1. クライアントがステータス別案件カウントAPIを呼び出し、オプションのフィルター条件を送信
2. ProjectStatusControllerがリクエストを受け取り、フィルター条件をバリデーション
3. ProjectStatusServiceがステータス別案件カウントロジックを実行
4. ProjectStatusRepositoryがステータス別の案件数を集計クエリで取得
   - フィルター条件に基づく絞り込み
   - アクセス権限に基づくフィルタリング
5. 各ステータスの詳細情報を付加
6. ProjectStatusControllerがステータス別案件カウントをレスポンスとして整形
7. クライアントにステータス別案件カウントを返却

## 4. データモデル参照

案件ステータス管理機能で使用する主要なデータモデルについては、[ドメインモデル](./02_ドメインモデル.md)を参照してください。本機能では主に以下のエンティティを扱います。

- 案件ステータス (ProjectStatus) エンティティ
- 案件ステータス履歴 (ProjectStatusHistory) エンティティ

## 5. ステータス遷移ルール

案件ステータス管理の中核となるステータス遷移ルールについて説明します。

### 5.1 標準ステータスフロー

案件の標準的なライフサイクルにおける主要なステータスと遷移を定義します。

```
[新規案件] → [要件確認中] → [提案準備中] → [提案中] → [提案検討中] → [成約] → [契約準備中] → [契約締結] → [実施中] → [完了]
                  ↓              ↓             ↓                      ↓
                  └──────────────┴─────────────┴──────────────────────→ [失注]
```

### 5.2 主要ステータス定義

| ステータスコード | ステータス名 | 説明 | 遷移可能な次ステータス |
|----------------|-----------|------|-------------------|
| NEW | 新規案件 | 新たに登録された案件 | REQ_CHK, CANCEL |
| REQ_CHK | 要件確認中 | 顧客要件の確認中 | PREP_PROP, LOST, CANCEL |
| PREP_PROP | 提案準備中 | 提案資料の作成中 | PROPOSING, LOST, CANCEL |
| PROPOSING | 提案中 | 顧客への提案実施中 | PROP_REVIEW, LOST, CANCEL |
| PROP_REVIEW | 提案検討中 | 顧客による提案内容の検討中 | ACCEPTED, LOST, CANCEL |
| ACCEPTED | 成約 | 提案が受理され、契約へ進む | PREP_CONTRACT, LOST, CANCEL |
| PREP_CONTRACT | 契約準備中 | 契約書の準備・調整中 | CONTRACTED, LOST, CANCEL |
| CONTRACTED | 契約締結 | 契約が締結された | IN_PROGRESS, CANCEL |
| IN_PROGRESS | 実施中 | 案件が実施中 | COMPLETED, CANCEL |
| COMPLETED | 完了 | 案件が完了 | ARCHIVE |
| LOST | 失注 | 提案が不採用となった | ARCHIVE |
| CANCEL | 中止 | 案件が中止された | ARCHIVE |
| ARCHIVE | アーカイブ | 過去案件として保管 | - |

### 5.3 ステータス遷移権限

ステータス遷移に必要な権限を定義します。

| 遷移パターン | 必要権限 |
|------------|---------|
| 全般的な変更 | PROJECT_STATUS_UPDATE |
| 成約 → 契約準備中 | CONTRACT_CREATE |
| 契約準備中 → 契約締結 | CONTRACT_APPROVE |
| 実施中 → 完了 | PROJECT_COMPLETE |
| アーカイブへの変更 | PROJECT_ARCHIVE |

### 5.4 ステータス遷移条件

特定のステータス遷移に必要な条件を定義します。

| 遷移パターン | 必要条件 |
|------------|---------|
| 新規案件 → 要件確認中 | 顧客情報が完全に入力されていること |
| 提案準備中 → 提案中 | 提案書ドキュメントが添付されていること |
| 成約 → 契約準備中 | 予算情報が入力されていること |
| 契約準備中 → 契約締結 | 契約書ドキュメントが添付されていること |
| 任意 → 完了 | 請求情報が完了していること |

## 6. バリデーションルール

案件ステータス管理機能に適用されるバリデーションルールは以下の通りです。

### 6.1 ステータス変更バリデーション

| フィールド | バリデーションルール |
|----------|-------------------|
| projectId | 必須、存在する案件ID |
| newStatusId | 必須、存在するステータスID、現在のステータスから遷移可能なステータスであること |
| changeReason | 必須、最大500文字 |

### 6.2 ステータス遷移可能性バリデーション

- 現在のステータスから新ステータスへの遷移がステータス定義の遷移ルールで許可されていること
- 現在のユーザーが当該ステータス遷移の権限を持っていること
- 遷移条件（必須項目の入力など）が満たされていること

## 7. 例外処理

案件ステータス管理機能における主な例外処理は以下の通りです。

### 7.1 ステータス遷移例外

- **InvalidStatusTransitionException**: 現在のステータスから指定されたステータスへの遷移が許可されていない場合にスローされる例外
  - 処理: クライアントに遷移ルール違反の詳細と遷移可能なステータス一覧を返却

### 7.2 権限例外

- **StatusTransitionAccessDeniedException**: ユーザーが当該ステータス遷移の権限を持っていない場合にスローされる例外
  - 処理: クライアントに403エラーと適切なメッセージを返却

### 7.3 条件不足例外

- **StatusTransitionConditionNotFoundException**: ステータス遷移の前提条件が満たされていない場合にスローされる例外
  - 処理: クライアントに条件不足の詳細を返却

### 7.4 リソース未検出例外

- **ProjectNotFoundException**: 指定されたIDの案件が存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

- **StatusNotFoundException**: 指定されたIDのステータスが存在しない場合にスローされる例外
  - 処理: クライアントに404エラーと適切なメッセージを返却

### 7.5 例外ハンドリング方針

1. コントローラーレベルでの例外ハンドラーを実装し、一貫した例外レスポンスフォーマットを提供
2. ステータス遷移例外は、適切なガイダンス情報（遷移可能なステータスや必要な条件など）を含める
3. セキュリティに関わる例外は詳細情報を隠蔽し、一般的なエラーメッセージのみを返却
4. すべての例外をログに記録し、重大な例外は管理者に通知
5. トランザクション管理による整合性の確保

## 8. セキュリティ考慮事項

案件ステータス管理機能における主なセキュリティ考慮事項は以下の通りです。

### 8.1 アクセス制御

- すべてのAPIエンドポイントはJWTによる認証を必要とする
- ステータス管理機能の使用には以下の権限が必要
  - ステータス参照: `PROJECT_VIEW` 権限
  - ステータス変更: `PROJECT_STATUS_UPDATE` 権限
  - 特定のステータス遷移: 遷移ごとに定義された特別な権限
- ステータス定義の管理には管理者権限が必要

### 8.2 データ保護

- ステータス変更履歴はすべて保持し、監査可能にする
- ステータス変更理由の機密性確保
- 特定のステータスの案件情報は機密レベルを上げて保護

### 8.3 入力検証

- すべてのユーザー入力はサーバーサイドでバリデーション
- 特にステータス変更理由のサニタイズ（XSS対策）
- 不正なステータスIDの検証

### 8.4 監査証跡

- ステータス変更操作はすべて監査ログに記録
- 監査ログには以下の情報を含める
  - 操作を行ったユーザーID
  - 変更前ステータス
  - 変更後ステータス
  - 変更理由
  - 操作の日時
  - 操作のIPアドレス

## 9. 通知管理

案件ステータス管理機能における通知管理について説明します。

### 9.1 通知トリガーとなるステータス変更

特定のステータス変更時に通知を送信するトリガーを定義します。

| ステータス変更 | 通知先 | 通知内容 |
|--------------|-------|---------|
| 任意 → 成約 | 営業担当者、営業管理者 | 案件成約通知 |
| 任意 → 契約締結 | 営業担当者、契約管理者 | 契約締結通知 |
| 任意 → 失注 | 営業担当者、営業管理者 | 失注通知 |
| 提案中 → 提案検討中 | 営業担当者 | 提案完了通知 |
| 任意 → 完了 | 案件関係者全員 | 案件完了通知 |

### 9.2 通知チャネル

ステータス変更通知を送信するチャネルを定義します。

- アプリ内通知: システム内の通知センターに表示
- メール通知: 登録されたメールアドレスに送信
- Slack/Teams通知: 連携設定がある場合はワークスペース/チャネルに送信
- SMS通知: 緊急性の高い通知の場合のみ

### 9.3 通知テンプレート

ステータス変更通知のテンプレートを定義します。各テンプレートには以下の情報を含みます。

- 案件名
- 旧ステータス
- 新ステータス
- 変更日時
- 変更者
- 変更理由
- 案件詳細へのリンク

### 9.4 通知設定

ユーザーごとの通知設定を管理し、通知過多を防止します。

- 通知受信設定（チャネルごとに有効/無効）
- 通知タイミング設定（即時/日次ダイジェスト）
- 特定ステータス変更の通知設定（特定のステータス変更のみ通知対象に設定）

## 10. パフォーマンス最適化

案件ステータス管理機能におけるパフォーマンス最適化策は以下の通りです。

### 10.1 データベース最適化

- 頻繁に参照されるステータス関連フィールドへのインデックス作成
  - 案件テーブルのステータスIDフィールド
  - ステータス履歴テーブルの案件IDフィールド
- ステータス履歴テーブルのパーティショニング（案件ID、年月などで分割）
- ステータス定義テーブルのキャッシュ

### 10.2 クエリ最適化

- ステータス別集計クエリの最適化
- ステータス履歴取得クエリのページング
- 不要なJOINの回避

### 10.3 処理の最適化

- ステータス変更イベントの非同期処理
- 通知の非同期送信処理
- バッチ処理による定期的なステータス集計の事前計算

## 11. 監視とロギング

案件ステータス管理機能における監視とロギングの方針は以下の通りです。

### 11.1 ロギング方針

- INFO レベル: ステータス変更ログ（案件ID、旧ステータス、新ステータス、変更者、変更理由）
- WARN レベル: 潜在的な問題（遷移ルール違反の試み、権限不足など）
- ERROR レベル: 例外と障害（データ整合性エラー、未処理例外など）
- DEBUG レベル: 詳細な処理ログ（ステータス遷移検証プロセスなど）

### 11.2 監視指標

- ステータス変更API応答時間
- ステータス変更頻度（時間帯別、ステータス別）
- ステータス遷移エラー率
- ステータス滞留時間（各ステータスでの平均滞在時間）
- 通知送信成功率

### 11.3 アラート条件

- 特定の時間枠内でのステータス変更の異常な増加
- 同一案件の短時間での複数回のステータス変更
- ステータス変更API応答時間が閾値（1秒）を超えた場合
- ステータス遷移エラー率が閾値（5%）を超えた場合
- 通知送信失敗率が閾値（5%）を超えた場合

## 12. ビジネスメトリクス

案件ステータス管理機能から得られるビジネスメトリクスについて説明します。

### 12.1 ステータス分布

- 現在のステータス別案件数
- ステータス分布の時系列変化
- 特定期間の成約率・失注率

### 12.2 プロセス効率指標

- 各ステータスの平均滞在時間
- 新規案件から成約までの平均リードタイム
- 成約から契約締結までの平均所要日数
- ボトルネックとなっているステータスの特定

### 12.3 予測指標

- ステータス遷移確率（現在のステータスから次のステータスへの遷移確率）
- 案件のステータス推移予測
- 成約可能性の予測

### 12.4 営業活動指標

- 営業担当者別のステータス分布
- 営業担当者別の成約率
- 顧客別のステータス分布