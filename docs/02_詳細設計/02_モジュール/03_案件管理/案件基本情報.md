# 案件基本情報モジュール詳細設計

## 1. 概要

案件基本情報モジュールは、SES業務システムにおける案件の登録、閲覧、検索、更新、削除などの基本的な機能を提供するコアモジュールです。顧客企業から依頼された案件情報を一元管理し、案件のライフサイクル全体を通じた状態管理を行います。

### 1.1 主要機能

- 案件基本情報の登録・更新・削除
- 案件の検索・フィルタリング機能
- 案件ステータス管理
- 案件の詳細情報表示
- 関連する技術者・契約情報との連携

### 1.2 ユースケース

- 営業担当者が新規案件を登録する
- マネージャーが案件情報を閲覧・検索する
- 営業担当者が案件の進捗状況を更新する
- マッチング担当者が案件要件に合致する技術者を検索する
- 管理者が案件情報を分析・レポートする

## 2. アーキテクチャ設計

案件管理モジュールは、全体アーキテクチャに準拠した4層構造（プレゼンテーション層、アプリケーション層、ドメイン層、インフラストラクチャ層）で設計します。

### 2.1 コンポーネント構成

```
jp.co.system_engineer_service.project
├── presentation
│   ├── controller
│   │   ├── ProjectController.java （Web向けコントローラ）
│   │   └── ProjectRestController.java （REST API向けコントローラ）
│   └── dto
│       ├── ProjectDTO.java （画面表示用DTO）
│       ├── ProjectSearchDTO.java （検索条件用DTO）
│       └── ProjectDetailDTO.java （詳細表示用DTO）
├── application
│   ├── service
│   │   ├── ProjectService.java （インターフェース）
│   │   └── ProjectServiceImpl.java（実装クラス）
│   └── mapper
│       └── ProjectMapper.java （DTO⇔エンティティ変換）
├── domain
│   ├── model
│   │   ├── Project.java （案件エンティティ）
│   │   ├── ProjectStatus.java （案件ステータス列挙型）
│   │   └── ProjectType.java （案件種別列挙型）
│   ├── repository
│   │   └── ProjectRepository.java （リポジトリインターフェース）
│   └── service
│       └── ProjectDomainService.java （ドメインサービス）
└── infrastructure
    ├── repository
    │   └── ProjectRepositoryImpl.java （リポジトリ実装）
    └── entity
        └── ProjectEntity.java （DBエンティティ）
```

## 3. データモデル設計

### 3.1 エンティティ定義

**Project（案件）エンティティ**

```java
public class Project {
    private UUID id;                 // 案件ID
    private String projectCode;      // 案件コード
    private String name;             // 案件名
    private String description;      // 案件概要
    private ProjectStatus status;    // 案件ステータス
    private ProjectType type;        // 案件種別
    private UUID clientId;           // 顧客ID（外部参照）
    private String clientName;       // 顧客名（表示用）
    private String location;         // 勤務地
    private LocalDate startDate;     // 開始予定日
    private LocalDate endDate;       // 終了予定日
    private Integer requiredHeadcount; // 必要人数
    private BigDecimal estimatedBudget; // 予算額
    private Set<UUID> requiredSkillIds; // 必要スキルIDセット
    private UUID salesPersonId;      // 営業担当者ID
    private LocalDateTime createdAt;  // 作成日時
    private LocalDateTime updatedAt;  // 更新日時
    
    // コンストラクタ、ゲッター、セッター、ビジネスロジックメソッド
}
```

**ProjectStatus（案件ステータス）列挙型**

```java
public enum ProjectStatus {
    DRAFT("下書き"),
    PUBLISHED("公開中"),
    IN_PROGRESS("進行中"),
    MATCHING("マッチング中"),
    CONTRACTED("契約済み"),
    COMPLETED("完了"),
    CANCELLED("キャンセル");
    
    private final String displayName;
    
    // コンストラクタ、ゲッター
}
```

**ProjectType（案件種別）列挙型**

```java
public enum ProjectType {
    SES("SES案件"),
    CONSIGNMENT("受託案件"),
    INTERNAL("社内案件");
    
    private final String displayName;
    
    // コンストラクタ、ゲッター
}
```

### 3.2 データベース設計

**projects テーブル**

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PK | 案件ID |
| project_code | VARCHAR(50) | UK, NOT NULL | 案件コード（自動生成） |
| name | VARCHAR(200) | NOT NULL | 案件名 |
| description | TEXT | | 案件概要 |
| status | VARCHAR(50) | NOT NULL | 案件ステータス |
| type | VARCHAR(50) | NOT NULL | 案件種別 |
| client_id | UUID | FK | 顧客ID |
| client_name | VARCHAR(200) | NOT NULL | 顧客名（表示用） |
| location | VARCHAR(200) | | 勤務地 |
| start_date | DATE | | 開始予定日 |
| end_date | DATE | | 終了予定日 |
| required_headcount | INTEGER | | 必要人数 |
| estimated_budget | DECIMAL(12,2) | | 予算額 |
| sales_person_id | UUID | FK | 営業担当者ID |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

**project_skills テーブル**（案件-スキル関連テーブル）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| project_id | UUID | PK, FK | 案件ID |
| skill_id | UUID | PK, FK | スキルID |
| is_required | BOOLEAN | NOT NULL | 必須スキルフラグ |
| priority | INTEGER | | 優先度 |

## 4. インターフェース設計

### 4.1 Controller

**ProjectController（Web画面用）**

```java
@Controller
@RequestMapping("/projects")
public class ProjectController {

    @GetMapping
    public String list(Model model, ProjectSearchDTO searchDTO) {
        // 案件一覧表示
    }
    
    @GetMapping("/{id}")
    public String detail(@PathVariable UUID id, Model model) {
        // 案件詳細表示
    }
    
    @GetMapping("/new")
    public String createForm(Model model) {
        // 案件登録フォーム表示
    }
    
    @PostMapping
    public String create(@Valid ProjectDTO projectDTO) {
        // 案件登録処理
    }
    
    @GetMapping("/{id}/edit")
    public String editForm(@PathVariable UUID id, Model model) {
        // 案件編集フォーム表示
    }
    
    @PostMapping("/{id}")
    public String update(@PathVariable UUID id, @Valid ProjectDTO projectDTO) {
        // 案件更新処理
    }
}
```

**ProjectRestController（REST API用）**

```java
@RestController
@RequestMapping("/api/projects")
public class ProjectRestController {

    @GetMapping
    public ResponseEntity<Page<ProjectDTO>> search(ProjectSearchDTO searchDTO, Pageable pageable) {
        // 案件検索API
    }
    
    @GetMapping("/{id}")
    public ResponseEntity<ProjectDetailDTO> getById(@PathVariable UUID id) {
        // 案件詳細取得API
    }
    
    @PostMapping
    public ResponseEntity<ProjectDTO> create(@RequestBody @Valid ProjectDTO projectDTO) {
        // 案件作成API
    }
    
    @PutMapping("/{id}")
    public ResponseEntity<ProjectDTO> update(@PathVariable UUID id, @RequestBody @Valid ProjectDTO projectDTO) {
        // 案件更新API
    }
    
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> delete(@PathVariable UUID id) {
        // 案件削除API
    }
    
    @PatchMapping("/{id}/status")
    public ResponseEntity<Void> updateStatus(@PathVariable UUID id, @RequestBody String status) {
        // 案件ステータス更新API
    }
}
```

### 4.2 Service

**ProjectService（インターフェース）**

```java
public interface ProjectService {
    Page<ProjectDTO> searchProjects(ProjectSearchDTO searchDTO, Pageable pageable);
    ProjectDetailDTO getProjectById(UUID id);
    ProjectDTO createProject(ProjectDTO projectDTO);
    ProjectDTO updateProject(UUID id, ProjectDTO projectDTO);
    void deleteProject(UUID id);
    void updateProjectStatus(UUID id, ProjectStatus status);
    List<ProjectDTO> findMatchingProjects(UUID engineerId);
}
```

**ProjectServiceImpl（実装クラス）**

```java
@Service
@Transactional(readOnly = true)
public class ProjectServiceImpl implements ProjectService {

    private final ProjectRepository projectRepository;
    private final ProjectMapper projectMapper;
    
    // コンストラクタ注入
    
    @Override
    public Page<ProjectDTO> searchProjects(ProjectSearchDTO searchDTO, Pageable pageable) {
        // 検索条件をもとに案件を検索
        Page<Project> projects = projectRepository.findByConditions(
            searchDTO.getKeyword(),
            searchDTO.getStatus(),
            searchDTO.getType(),
            searchDTO.getClientId(),
            searchDTO.getStartDateFrom(),
            searchDTO.getStartDateTo(),
            pageable
        );
        
        return projects.map(projectMapper::toDto);
    }
    
    @Override
    @Transactional
    public ProjectDTO createProject(ProjectDTO projectDTO) {
        // DTOからエンティティに変換
        Project project = projectMapper.toEntity(projectDTO);
        
        // 案件コードの自動生成
        project.setProjectCode(generateProjectCode());
        
        // 新規作成日時設定
        LocalDateTime now = LocalDateTime.now();
        project.setCreatedAt(now);
        project.setUpdatedAt(now);
        
        // リポジトリで保存
        Project savedProject = projectRepository.save(project);
        
        // エンティティからDTOに変換して返却
        return projectMapper.toDto(savedProject);
    }
    
    // 他のメソッド実装
}
```

## 5. ビジネスロジック設計

### 5.1 案件コード生成ロジック

新規案件登録時に一意の案件コードを生成します。

```java
private String generateProjectCode() {
    // 現在年度の取得
    int fiscalYear = LocalDate.now().getMonth().getValue() >= 4 
        ? LocalDate.now().getYear() 
        : LocalDate.now().getYear() - 1;
    
    // その年度の案件数（シーケンス）を取得
    int sequence = projectRepository.countByFiscalYear(fiscalYear) + 1;
    
    // フォーマット: PJ{年度下2桁}{5桁連番}
    // 例: PJ2304500001
    return String.format("PJ%02d%05d", fiscalYear % 100, sequence);
}
```

### 5.2 案件ステータス遷移ルール

案件のステータス遷移は以下のルールに従います。

```java
public boolean canTransitionTo(ProjectStatus newStatus) {
    switch (this.status) {
        case DRAFT:
            // 下書きからは公開かキャンセルのみ可能
            return newStatus == ProjectStatus.PUBLISHED || 
                   newStatus == ProjectStatus.CANCELLED;
        case PUBLISHED:
            // 公開中からはマッチング中、進行中、キャンセルに変更可能
            return newStatus == ProjectStatus.MATCHING || 
                   newStatus == ProjectStatus.IN_PROGRESS || 
                   newStatus == ProjectStatus.CANCELLED;
        case MATCHING:
            // マッチング中からは契約済み、公開中、キャンセルに変更可能
            return newStatus == ProjectStatus.CONTRACTED || 
                   newStatus == ProjectStatus.PUBLISHED || 
                   newStatus == ProjectStatus.CANCELLED;
        case IN_PROGRESS:
            // 進行中からは完了、キャンセルに変更可能
            return newStatus == ProjectStatus.COMPLETED || 
                   newStatus == ProjectStatus.CANCELLED;
        case CONTRACTED:
            // 契約済みからは進行中、キャンセルに変更可能
            return newStatus == ProjectStatus.IN_PROGRESS || 
                   newStatus == ProjectStatus.CANCELLED;
        case COMPLETED:
        case CANCELLED:
            // 完了、キャンセル状態からの変更は不可
            return false;
        default:
            return false;
    }
}
```

### 5.3 案件検索ロジック

案件検索は複数条件の組み合わせに対応します。

```java
@Override
public List<Project> findByConditions(
        String keyword, 
        ProjectStatus status, 
        ProjectType type, 
        UUID clientId, 
        LocalDate startDateFrom, 
        LocalDate startDateTo, 
        Pageable pageable) {
    
    // SQL検索条件の構築
    StringBuilder sql = new StringBuilder();
    Map<String, Object> params = new HashMap<>();
    
    sql.append("SELECT p.* FROM projects p WHERE 1=1 ");
    
    // キーワード検索（案件名と概要）
    if (StringUtils.hasText(keyword)) {
        sql.append("AND (p.name LIKE :keyword OR p.description LIKE :keyword) ");
        params.put("keyword", "%" + keyword + "%");
    }
    
    // ステータス検索
    if (status != null) {
        sql.append("AND p.status = :status ");
        params.put("status", status.name());
    }
    
    // 種別検索
    if (type != null) {
        sql.append("AND p.type = :type ");
        params.put("type", type.name());
    }
    
    // 顧客検索
    if (clientId != null) {
        sql.append("AND p.client_id = :clientId ");
        params.put("clientId", clientId);
    }
    
    // 開始日範囲検索
    if (startDateFrom != null) {
        sql.append("AND p.start_date >= :startDateFrom ");
        params.put("startDateFrom", startDateFrom);
    }
    
    if (startDateTo != null) {
        sql.append("AND p.start_date <= :startDateTo ");
        params.put("startDateTo", startDateTo);
    }
    
    // ソート順の適用
    sql.append("ORDER BY p.updated_at DESC");
    
    // ページネーション適用して結果取得
    // ...実装省略...
}
```

## 6. 画面遷移設計

案件管理モジュールの主要画面遷移図を以下に示します。

```
+----------------+     +----------------+     +------------------+
| 案件一覧画面   |---->| 案件新規登録画面 |---->| 案件一覧画面     |
| (一覧・検索)   |     |                |     | (登録完了表示)   |
+----------------+     +----------------+     +------------------+
        |
        v
+----------------+     +----------------+     +------------------+
| 案件詳細画面   |---->| 案件編集画面   |---->| 案件詳細画面     |
|                |     |                |     | (更新完了表示)   |
+----------------+     +----------------+     +------------------+
        |
        v
+----------------+
| 関連情報画面   |
| (技術者/契約)  |
+----------------+
```

## 7. セキュリティ設計

案件情報へのアクセス権限は以下のように設定します。

| 役割 | 参照 | 登録 | 更新 | 削除 | ステータス変更 |
|------|------|------|------|------|--------------|
| 管理者 | ○ | ○ | ○ | ○ | ○ |
| 営業担当 | ○ | ○ | ○ | × | ○ |
| マッチング担当 | ○ | × | × | × | ○(一部) |
| 一般ユーザー | ○ | × | × | × | × |

具体的な実装は、Spring Securityのメソッドレベルセキュリティを使用します。

```java
@PreAuthorize("hasAnyRole('ADMIN', 'SALES', 'MATCHING', 'USER')")
public ProjectDetailDTO getProjectById(UUID id);

@PreAuthorize("hasAnyRole('ADMIN', 'SALES')")
public ProjectDTO createProject(ProjectDTO projectDTO);

@PreAuthorize("hasAnyRole('ADMIN', 'SALES')")
public ProjectDTO updateProject(UUID id, ProjectDTO projectDTO);

@PreAuthorize("hasRole('ADMIN')")
public void deleteProject(UUID id);

@PreAuthorize("hasAnyRole('ADMIN', 'SALES', 'MATCHING')")
public void updateProjectStatus(UUID id, ProjectStatus status);
```

## 8. テスト計画

案件管理モジュールの主要テスト項目を以下に示します。

### 8.1 単体テスト

- ProjectServiceImplの各メソッドのテスト
- リポジトリメソッドのテスト
- ドメインロジック（ステータス遷移など）のテスト

### 8.2 結合テスト

- コントローラとサービスの連携テスト
- REST APIのエンドポイントテスト

### 8.3 シナリオテスト

- 案件登録から検索、更新、ステータス変更までの一連のフロー
- 権限による機能制限の確認
- 案件コード生成ロジックの検証

## 9. 外部連携

案件管理モジュールと連携する他のモジュールとのインターフェースを定義します。

### 9.1 技術者管理モジュールとの連携

- 案件に対する技術者のマッチング検索
- 案件に技術者をアサインする機能

### 9.2 契約管理モジュールとの連携

- 案件情報を元に契約書を作成
- 契約成立時の案件ステータス連動

### 9.3 請求管理モジュールとの連携

- 案件情報を元に請求情報を生成
- 案件期間に基づく請求サイクル設定

### 9.4 レポーティングモジュールとの連携

- 案件状況の集計データ提供
- 案件別収益情報の提供

## 10. 運用設計

### 10.1 バッチ処理

- 日次：案件ステータスの自動更新（開始日到来時など）
- 週次：案件状況のレポート生成
- 月次：案件の統計情報生成

### 10.2 監視項目

- 案件数の急激な増減
- 長期間更新のない案件のアラート
- ステータス遷移の異常検知

### 10.3 パフォーマンス対策

- 案件検索のインデックス最適化
- 大量案件データの効率的なページング処理