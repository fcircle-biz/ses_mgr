# 集計レポート機能

## 1. 機能概要

集計レポート機能は、勤怠・工数データの集計、分析、レポート出力を行うための機能を提供します。個人別、プロジェクト別、部門別などの様々な切り口でのデータ集計、各種KPIの算出、視覚的なダッシュボード表示、カスタムレポートの生成、データエクスポートなどを通じて、勤怠・工数データに基づく意思決定と業務効率化を支援します。

## 2. 処理フロー

### 2.1 個人別勤怠集計フロー

1. ユーザーが個人別勤怠集計画面を開く
2. 対象期間の指定（月次、四半期、年次など）
3. システムが対象ユーザーと期間の勤怠データを取得
4. 勤怠データの集計処理
   - 勤務日数・時間の集計
   - 残業時間の集計
   - 休暇取得状況の集計
   - 時間外勤務の分析
5. 集計結果の表示
   - 表形式での集計表示
   - グラフ表示（時系列、分布など）
   - 前期・前年比較表示
6. 必要に応じたカスタム集計条件の適用
7. 結果の出力（画面表示、PDF、Excel等）

### 2.2 プロジェクト工数集計フロー

1. ユーザーがプロジェクト工数集計画面を開く
2. 対象プロジェクトの選択
3. 対象期間の指定（月次、全期間など）
4. システムがプロジェクト工数データを取得
5. 工数データの集計処理
   - 総工数の集計
   - メンバー別工数の集計
   - 作業種別別工数の集計
   - 計画vs実績の比較
6. 集計結果の表示
   - 表形式での集計表示
   - 工数分布グラフ
   - 進捗状況チャート
   - EVM分析チャート（オプション）
7. 詳細表示（ドリルダウン）
8. 結果の出力（画面表示、PDF、Excel等）

### 2.3 部門別稼働状況集計フロー

1. ユーザーが部門別稼働状況画面を開く
2. 対象部門の選択
3. 対象期間の指定
4. システムが部門メンバーの勤怠・工数データを取得
5. 稼働状況の集計処理
   - 部門全体の稼働率計算
   - メンバー別稼働率計算
   - プロジェクト別稼働分布計算
   - 請求対象/非対象工数の分析
6. 集計結果の表示
   - 部門サマリーダッシュボード
   - メンバー別稼働状況一覧
   - 稼働率ヒートマップ
   - 時系列稼働率グラフ
7. 異常値（低稼働、高稼働）のハイライト
8. 結果の出力（画面表示、PDF、Excel等）

### 2.4 請求用工数集計フロー

1. ユーザーが請求用工数集計画面を開く
2. 対象取引先または案件の選択
3. 請求対象期間の指定
4. システムが請求対象工数データを取得
5. 請求用工数の集計処理
   - 技術者別請求工数の集計
   - 請求対象/非対象の振り分け
   - 請求レート適用計算
   - 請求金額の算出
6. 集計結果の表示
   - 請求工数サマリー
   - 技術者別明細
   - 前月比較データ
   - 異常値のハイライト
7. 請求データの確定処理
8. 請求管理モジュールへのデータ連携

### 2.5 カスタムレポート生成フロー

1. ユーザーがカスタムレポート画面を開く
2. レポート種別の選択
   - 勤怠集計レポート
   - 工数集計レポート
   - 稼働分析レポート
   - 複合レポート
3. 集計条件の設定
   - 対象期間
   - 対象ユーザー/プロジェクト/部門
   - 集計項目の選択
   - フィルター条件の設定
4. 表示形式の選択
   - 表形式
   - グラフ種別の選択
   - ダッシュボード配置設定
5. システムがレポートデータを集計
6. レポートプレビューの表示
7. レポート調整（必要に応じて）
8. レポートの保存・出力
   - 保存（テンプレートとして）
   - 出力（PDF/Excel/CSV等）
   - メール送信

### 2.6 定期レポート配信フロー

1. 管理者が定期レポート設定画面を開く
2. 定期レポートの設定
   - レポート種別選択
   - 配信頻度設定（日次/週次/月次等）
   - 配信先設定
   - 出力形式設定
3. レポートテンプレートの作成または選択
4. スケジュール設定の確定
5. 定期実行時の処理
   - スケジュールトリガーによる起動
   - 対象期間の自動計算
   - データ集計処理
   - レポート生成
   - 配信処理（メール、システム内通知等）
6. 配信履歴の記録

## 3. 主要コンポーネント構成

### 3.1 ReportService

レポート機能の基本操作を提供するサービスコンポーネントです。

```java
class ReportServiceImpl implements ReportService {
    private AttendanceRepository attendanceRepository;
    private TimesheetRepository timesheetRepository;
    private ProjectService projectService;
    private OrganizationService organizationService;
    private ReportTemplateRepository reportTemplateRepository;
    private ReportDataExporter reportDataExporter;
    private ReportRenderer reportRenderer;
    
    @Override
    public AttendanceSummary getAttendanceSummary(String userId, int year, int month) {
        // 勤怠集計ロジック
    }
    
    @Override
    public TimesheetSummary getTimesheetSummary(String userId, int year, int month) {
        // 工数集計ロジック
    }
    
    @Override
    public ProjectTimesheetSummary getProjectTimesheetSummary(String projectId, int year, int month) {
        // プロジェクト工数集計ロジック
    }
    
    @Override
    public DepartmentAttendanceSummary getDepartmentAttendanceSummary(String departmentId, int year, int month) {
        // 部門勤怠集計ロジック
    }
    
    @Override
    public UtilizationReport getUtilizationReport(UtilizationReportRequest request) {
        // 稼働率レポート生成ロジック
    }
    
    @Override
    public byte[] exportAttendanceData(AttendanceExportRequest request) {
        // 勤怠データエクスポートロジック
    }
    
    @Override
    public byte[] exportTimesheetData(TimesheetExportRequest request) {
        // 工数データエクスポートロジック
    }
    
    @Override
    public Report generateCustomReport(CustomReportRequest request) {
        // カスタムレポート生成ロジック
    }
    
    // その他のメソッド実装
}
```

### 3.2 ReportTemplateRepository

レポートテンプレートの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ReportTemplateRepository {
    ReportTemplate save(ReportTemplate template);
    Optional<ReportTemplate> findById(String id);
    List<ReportTemplate> findByCreatorId(String creatorId);
    List<ReportTemplate> findByReportType(ReportType reportType);
    List<ReportTemplate> findByIsPublicTrue();
    List<ReportTemplate> findByIsSystemTemplateTrue();
    void deleteById(String id);
}
```

### 3.3 ScheduledReportRepository

定期レポートの永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ScheduledReportRepository {
    ScheduledReport save(ScheduledReport scheduledReport);
    Optional<ScheduledReport> findById(String id);
    List<ScheduledReport> findByCreatorId(String creatorId);
    List<ScheduledReport> findByStatus(ScheduledReportStatus status);
    List<ScheduledReport> findByNextExecutionDateBefore(LocalDateTime dateTime);
    void deleteById(String id);
}
```

### 3.4 ReportExecutionHistoryRepository

レポート実行履歴の永続化と検索を担当するリポジトリコンポーネントです。

```java
interface ReportExecutionHistoryRepository {
    ReportExecutionHistory save(ReportExecutionHistory history);
    Optional<ReportExecutionHistory> findById(String id);
    List<ReportExecutionHistory> findByScheduledReportId(String scheduledReportId);
    List<ReportExecutionHistory> findByExecutorIdAndExecutionDateBetween(String executorId, LocalDateTime start, LocalDateTime end);
    List<ReportExecutionHistory> findByStatusAndCreatedAtBefore(ReportExecutionStatus status, LocalDateTime dateTime);
}
```

### 3.5 AttendanceReportGenerator

勤怠レポートの生成を担当するコンポーネントです。

```java
class AttendanceReportGenerator {
    private AttendanceRepository attendanceRepository;
    private AttendanceSheetRepository attendanceSheetRepository;
    private OrganizationService organizationService;
    
    public PersonalAttendanceReport generatePersonalReport(String userId, int year, int month) {
        // 個人勤怠レポート生成ロジック
        return report;
    }
    
    public DepartmentAttendanceReport generateDepartmentReport(String departmentId, int year, int month) {
        // 部門勤怠レポート生成ロジック
        return report;
    }
    
    public CompanyAttendanceReport generateCompanyReport(int year, int month) {
        // 会社全体勤怠レポート生成ロジック
        return report;
    }
    
    public OvertimeAnalysisReport generateOvertimeReport(OvertimeReportRequest request) {
        // 残業分析レポート生成ロジック
        return report;
    }
    
    public AttendanceComparisonReport generateComparisonReport(AttendanceComparisonRequest request) {
        // 勤怠比較レポート生成ロジック
        return report;
    }
}
```

### 3.6 TimesheetReportGenerator

工数レポートの生成を担当するコンポーネントです。

```java
class TimesheetReportGenerator {
    private TimesheetRepository timesheetRepository;
    private TimesheetEntryRepository timesheetEntryRepository;
    private ProjectService projectService;
    
    public PersonalTimesheetReport generatePersonalReport(String userId, int year, int month) {
        // 個人工数レポート生成ロジック
        return report;
    }
    
    public ProjectTimesheetReport generateProjectReport(String projectId, int year, int month) {
        // プロジェクト工数レポート生成ロジック
        return report;
    }
    
    public BillingTimesheetReport generateBillingReport(BillingReportRequest request) {
        // 請求用工数レポート生成ロジック
        return report;
    }
    
    public UtilizationReport generateUtilizationReport(UtilizationReportRequest request) {
        // 稼働率レポート生成ロジック
        return report;
    }
    
    public TaskTypeDistributionReport generateTaskDistributionReport(TaskDistributionRequest request) {
        // 作業種別分布レポート生成ロジック
        return report;
    }
}
```

### 3.7 ReportDataExporter

レポートデータのエクスポートを担当するコンポーネントです。

```java
class ReportDataExporter {
    public byte[] exportToCsv(ReportData reportData) {
        // CSVエクスポートロジック
        return csvData;
    }
    
    public byte[] exportToExcel(ReportData reportData) {
        // Excelエクスポートロジック
        return excelData;
    }
    
    public byte[] exportToPdf(ReportData reportData) {
        // PDFエクスポートロジック
        return pdfData;
    }
    
    public byte[] exportToJson(ReportData reportData) {
        // JSONエクスポートロジック
        return jsonData;
    }
}
```

### 3.8 ScheduledReportExecutor

定期レポートの実行を担当するコンポーネントです。

```java
class ScheduledReportExecutor {
    private ScheduledReportRepository scheduledReportRepository;
    private ReportExecutionHistoryRepository historyRepository;
    private ReportService reportService;
    private NotificationService notificationService;
    
    public void executeScheduledReports() {
        // スケジュール済みレポートの実行ロジック
    }
    
    public ReportExecutionHistory executeReport(String scheduledReportId) {
        // 個別レポート実行ロジック
        return executionHistory;
    }
    
    public ScheduleResult scheduleReport(ScheduledReportRequest request) {
        // レポートスケジューリングロジック
        return result;
    }
    
    public void updateNextExecutionDate(String scheduledReportId) {
        // 次回実行日更新ロジック
    }
}
```

## 4. 例外処理

### 4.1 ReportGenerationException

レポート生成中にエラーが発生した場合の例外です。

```java
class ReportGenerationException extends ApplicationException {
    private String reportType;
    private Map<String, Object> parameters;
    private String errorDetail;
    
    // コンストラクタ、getterなど
}
```

### 4.2 InvalidReportParameterException

レポートパラメータが不正な場合に発生する例外です。

```java
class InvalidReportParameterException extends ValidationException {
    private String parameterName;
    private Object invalidValue;
    private String expectedFormat;
    
    // コンストラクタ、getterなど
}
```

### 4.3 ReportTemplateNotFoundException

指定されたレポートテンプレートが存在しない場合に発生する例外です。

```java
class ReportTemplateNotFoundException extends ResourceNotFoundException {
    private String templateId;
    
    // コンストラクタ、getterなど
}
```

### 4.4 ReportExportException

レポートのエクスポート処理でエラーが発生した場合の例外です。

```java
class ReportExportException extends ApplicationException {
    private String reportId;
    private String exportFormat;
    private String errorDetail;
    
    // コンストラクタ、getterなど
}
```

### 4.5 ScheduledReportException

定期レポートの処理中にエラーが発生した場合の例外です。

```java
class ScheduledReportException extends ApplicationException {
    private String scheduledReportId;
    private String executionId;
    private String errorDetail;
    
    // コンストラクタ、getterなど
}
```

### 4.6 NoDataForReportException

レポート生成に必要なデータが存在しない場合に発生する例外です。

```java
class NoDataForReportException extends BusinessRuleException {
    private String reportType;
    private Map<String, Object> parameters;
    private String dataType;
    
    // コンストラクタ、getterなど
}
```

## 5. レポート種別と内容

### 5.1 個人向けレポート

個人の勤怠・工数データに関するレポートです。

- **個人勤怠サマリーレポート**
  - 対象期間: 月次（標準）、週次、年次
  - 内容:
    - 勤務日数・時間の集計
    - 残業時間の集計（通常、深夜、休日）
    - 休暇取得状況（種別ごと）
    - 前月・前年同月比較
  - 形式: 表、棒グラフ、時系列グラフ

- **個人工数分布レポート**
  - 対象期間: 月次（標準）、週次、年次
  - 内容:
    - 案件別工数分布
    - 作業種別別工数分布
    - 請求可能/不可工数の比率
    - 勤怠との整合性分析
  - 形式: 表、円グラフ、積み上げ棒グラフ

- **個人稼働分析レポート**
  - 対象期間: 四半期（標準）、月次、年次
  - 内容:
    - 稼働率推移
    - 請求対象率推移
    - 作業種別トレンド分析
    - スキル活用分析
  - 形式: 表、時系列グラフ、レーダーチャート

### 5.2 プロジェクト向けレポート

プロジェクトの工数データに関するレポートです。

- **プロジェクト工数サマリーレポート**
  - 対象期間: 月次（標準）、全期間
  - 内容:
    - 総工数の集計
    - メンバー別工数分布
    - 作業種別別工数分布
    - 計画vs実績比較
  - 形式: 表、積み上げ棒グラフ、円グラフ

- **プロジェクト進捗レポート**
  - 対象期間: 全期間（標準）、月次
  - 内容:
    - 工数消化率
    - 作業進捗率
    - EVM分析（SPI, CPI）
    - 残工数予測
  - 形式: 表、進捗チャート、S字カーブ

- **プロジェクトメンバー貢献度レポート**
  - 対象期間: 全期間（標準）、月次
  - 内容:
    - メンバー別工数寄与率
    - 作業種別別貢献分析
    - スキル活用状況
    - メンバーごとの効率性分析
  - 形式: 表、積み上げグラフ、ヒートマップ

### 5.3 部門向けレポート

部門・組織の勤怠・工数データに関するレポートです。

- **部門勤怠集計レポート**
  - 対象期間: 月次（標準）、年次
  - 内容:
    - 部門全体の勤務日数・時間
    - 残業時間分布
    - 休暇取得状況
    - 異常値分析（長時間労働等）
  - 形式: 表、集計グラフ、分布図

- **部門稼働状況レポート**
  - 対象期間: 月次（標準）、四半期
  - 内容:
    - 部門全体の稼働率
    - メンバー別稼働率分布
    - 案件別工数分布
    - 請求可能率
  - 形式: 表、ヒートマップ、棒グラフ

- **部門リソース配分レポート**
  - 対象期間: 月次（標準）、四半期
  - 内容:
    - 案件別リソース配分状況
    - スキル別稼働状況
    - 未稼働リソース分析
    - リソース配分最適化提案
  - 形式: 表、バブルチャート、サンキーダイアグラム

### 5.4 経営層向けレポート

経営判断に必要な集計・分析レポートです。

- **全社稼働状況ダッシュボード**
  - 対象期間: 月次（標準）、四半期、年次
  - 内容:
    - 全社稼働率
    - 部門別稼働率比較
    - 請求可能率
    - トレンド分析
  - 形式: ダッシュボード、グラフパネル、KPIインジケーター

- **プロジェクトポートフォリオレポート**
  - 対象期間: 四半期（標準）、年次
  - 内容:
    - プロジェクト別収益性
    - リソース配分状況
    - リスクプロジェクト分析
    - 成長領域分析
  - 形式: ポートフォリオマトリクス、バブルチャート

- **人材リソース分析レポート**
  - 対象期間: 四半期（標準）、年次
  - 内容:
    - スキル別稼働状況
    - 技術者成長分析
    - リソースギャップ分析
    - 採用・育成提案
  - 形式: 表、ヒートマップ、スキルマップ

### 5.5 請求・支払向けレポート

請求・支払業務に必要なレポートです。

- **請求工数集計レポート**
  - 対象期間: 月次（標準）
  - 内容:
    - 顧客別請求工数集計
    - 案件別請求工数集計
    - 技術者別請求工数集計
    - 請求金額集計
  - 形式: 表、請求明細形式

- **技術者別請求工数明細**
  - 対象期間: 月次（標準）
  - 内容:
    - 技術者の日別工数明細
    - 作業内容詳細
    - 請求条件適用詳細
    - 承認履歴
  - 形式: 表、日次明細形式

- **請求トレンド分析レポート**
  - 対象期間: 年次（標準）、四半期
  - 内容:
    - 請求工数の月次推移
    - 顧客別売上推移
    - 案件種別別売上分析
    - 平均単価分析
  - 形式: 表、時系列グラフ、予測曲線

## 6. レポート表示と機能

### 6.1 ダッシュボード機能

視覚的なデータ表示を行うダッシュボード機能です。

- **個人ダッシュボード**
  - 当月の勤務状況サマリー
  - 工数入力状況インジケーター
  - 稼働率グラフ
  - TODO項目（未入力日、承認待ち等）
  - カレンダー表示

- **管理者ダッシュボード**
  - 部門/チームの勤怠状況サマリー
  - 承認待ちタスク一覧
  - 異常値アラート（長時間労働、低稼働等）
  - リソース状況サマリー
  - トレンドグラフ

- **プロジェクトダッシュボード**
  - プロジェクト工数・進捗サマリー
  - メンバー稼働状況
  - 課題・リスク指標
  - 予算消化状況グラフ
  - 予測完了曲線

### 6.2 インタラクティブ機能

レポート操作のためのインタラクティブ機能です。

- **フィルタリング機能**
  - 日付範囲フィルター
  - 部門/チーム/メンバーフィルター
  - 案件/プロジェクトフィルター
  - 作業種別フィルター
  - 複合条件フィルター

- **ドリルダウン機能**
  - サマリーから詳細への展開
  - 階層別の詳細表示
  - レベル間ナビゲーション
  - ソース元データ表示

- **ソート・グループ化機能**
  - 複数条件でのソート
  - 階層別グループ化
  - ピボットテーブル機能
  - カスタム集計関数の適用

### 6.3 比較・分析機能

データ分析のための機能です。

- **時系列比較**
  - 前期比較（前月、前年同月等）
  - トレンド分析
  - 季節変動分析
  - 移動平均表示

- **ベンチマーク比較**
  - 計画vs実績比較
  - 部門間ベンチマーク
  - 業界標準との比較
  - 目標値との差異分析

- **異常検知機能**
  - 統計的異常検知
  - しきい値超過アラート
  - 変化率監視
  - パターン逸脱検出

### 6.4 出力・配信機能

レポートの出力と配信のための機能です。

- **エクスポート機能**
  - PDF形式出力
  - Excel形式出力
  - CSV形式出力
  - JSON形式出力（API連携用）

- **定期配信機能**
  - メール配信設定
  - 配信スケジュール設定
  - 配信先グループ管理
  - 配信履歴管理

- **共有機能**
  - レポート共有設定
  - 権限別閲覧制御
  - コメント・注釈付加
  - 共有履歴管理

## 7. カスタムレポート機能

### 7.1 テンプレート管理

レポートのテンプレートを管理するための機能です。

- **システム標準テンプレート**
  - 個人別勤怠サマリー
  - プロジェクト工数サマリー
  - 部門稼働サマリー
  - 請求工数サマリー
  - 月次レポートセット

- **カスタムテンプレート作成**
  - レポート種別選択
  - 集計項目設定
  - 表示形式設定
  - フィルター条件設定
  - ソート・グループ化設定

- **テンプレート共有設定**
  - 個人用テンプレート
  - 部門共有テンプレート
  - 全社共有テンプレート
  - 公開範囲設定

### 7.2 データ集計条件

カスタムレポートのデータ集計条件設定です。

- **期間設定**
  - 固定期間（特定の月、四半期、年など）
  - 相対期間（直近3ヶ月、過去1年など）
  - 複数期間選択（比較用）
  - カスタム期間範囲

- **対象選択**
  - 個人（自分、特定ユーザー）
  - 組織（部門、チーム）
  - プロジェクト（単一、複数）
  - 取引先（単一、複数）
  - カスタム組み合わせ

- **集計項目選択**
  - 勤怠項目（勤務日数、時間、残業等）
  - 工数項目（総工数、案件別工数等）
  - 稼働項目（稼働率、請求可能率等）
  - KPI項目（効率性指標、達成率等）
  - カスタム計算式

### 7.3 表示形式設定

レポートの表示形式に関する設定です。

- **表形式設定**
  - 列選択
  - グループ化設定
  - 小計・合計表示
  - 条件付き書式
  - セル結合・レイアウト

- **グラフ形式設定**
  - グラフ種類選択（棒、折れ線、円等）
  - 軸設定
  - 系列設定
  - 凡例・ラベル設定
  - 色・スタイル設定

- **複合表示設定**
  - 表とグラフの組み合わせ
  - 複数グラフのレイアウト
  - ダッシュボード配置
  - パネル分割

### 7.4 高度な分析機能

より高度なデータ分析のための機能です。

- **統計分析機能**
  - 記述統計量計算
  - 相関分析
  - 回帰分析
  - 分散分析
  - クラスター分析

- **予測分析機能**
  - トレンド予測
  - 季節変動予測
  - 「What-If」分析
  - シナリオシミュレーション

- **多次元分析機能**
  - ピボット分析
  - ドリルスルー分析
  - スライス＆ダイス
  - ロールアップ・ドリルダウン

## 8. データ連携とエクスポート

### 8.1 内部モジュール連携

他モジュールとのデータ連携機能です。

- **レポーティングモジュール連携**
  - 勤怠・工数データの提供
  - 集計データの提供
  - KPI算出データの提供
  - 連携用API

- **請求支払管理モジュール連携**
  - 請求用工数データの提供
  - 請求根拠データの提供
  - 承認済みデータの連携
  - 請求書エビデンスデータ提供

- **技術者管理モジュール連携**
  - 稼働実績データの提供
  - スキル活用データの提供
  - リソース配分データの提供
  - 技術者評価指標提供

### 8.2 外部システム連携

外部システムとのデータ連携機能です。

- **給与システム連携**
  - 勤怠集計データの連携
  - 残業時間データの連携
  - 休暇取得データの連携
  - 手当計算用データ連携

- **経営管理システム連携**
  - 部門別稼働率データ連携
  - 案件別収益性データ連携
  - リソース効率性データ連携
  - KPI達成状況データ連携

- **BI/分析ツール連携**
  - データマート連携
  - 分析用データセット提供
  - リアルタイムデータフィード
  - OLAPキューブデータ提供

### 8.3 エクスポート形式

各種データフォーマットでのエクスポート機能です。

- **Excel形式**
  - マクロ無し標準形式
  - ピボットテーブル形式
  - グラフ付き形式
  - テンプレート適用形式

- **PDF形式**
  - 標準レポート形式
  - 印刷最適化形式
  - グラフィック強化形式
  - インタラクティブ形式

- **CSV/TSV形式**
  - 標準CSV
  - カンマ区切り/タブ区切り選択
  - 文字コード選択
  - 日付形式選択

- **JSON/XML形式**
  - 標準JSON形式
  - ネストされた構造
  - フラット構造
  - スキーマ付きXML