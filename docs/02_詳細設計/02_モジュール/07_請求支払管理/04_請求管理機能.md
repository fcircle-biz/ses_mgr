# 請求管理機能

本ドキュメントでは、請求支払管理モジュールの中核機能である請求管理機能の詳細設計を記述します。

## 1. 概要

請求管理機能は、クライアントへの請求書の作成、管理、更新、ステータス管理を行う機能群です。勤怠工数管理と連携して請求データを自動生成する機能や、契約情報から請求条件を設定する機能も提供します。

### 1.1 主要機能

- 請求書の作成・更新・削除
- 請求書の検索・照会
- 請求書のステータス管理（下書き、確定、取消、入金済み等）
- 請求明細の管理
- 勤怠データに基づく請求データの自動生成
- 契約情報に基づく請求条件の設定

### 1.2 処理フロー概要

1. 請求書作成
   - 手動作成：ユーザーによる入力で請求書を作成
   - 自動生成：月次の勤怠データから請求書を自動生成

2. 請求書編集・確認
   - 請求内容の確認
   - 必要に応じた編集

3. 請求書確定
   - 請求内容を確定し、編集不可状態に変更
   - 請求番号の採番

4. 請求書ドキュメント生成
   - 確定した請求書から請求書ドキュメントを生成

5. 請求書送付
   - 生成したドキュメントをクライアントに送付

6. 入金管理
   - 請求書に対する入金情報の登録
   - 入金状況の管理

7. 請求書取消
   - 必要に応じて請求書の取消処理

## 2. 機能詳細設計

### 2.1 請求書管理

#### 2.1.1 請求書作成機能

**概要**

請求書を新規作成する機能です。手動での作成と勤怠データからの自動生成の2つの方法をサポートします。

**処理フロー**

1. ユーザーが請求書作成画面にアクセス
2. クライアント選択
3. 請求日・支払期限日の設定
4. 請求明細の入力
   - 明細項目名
   - 単価
   - 数量
   - 単位
   - 課税区分
   - 税率
5. 請求条件の設定
   - 支払条件
   - 請求先情報
   - 銀行口座情報
6. 請求書データの保存
7. 計算処理（小計、税額、合計金額）

**バリデーションルール**

- クライアントは必須
- 請求日は必須、過去日も可
- 支払期限日は必須、請求日より後の日付
- 請求明細は最低1件必須
- 請求明細の単価、数量は0より大きい値
- 課税対象の場合は税率の設定が必須

**エラー処理**

- クライアントが存在しない場合：ResourceNotFoundException
- 請求明細の値が不正な場合：IllegalArgumentException
- 請求金額計算時のエラー：BusinessException

#### 2.1.2 勤怠データからの請求書自動生成機能

**概要**

月次の勤怠データを元に、クライアント毎に請求書を自動生成する機能です。

**処理フロー**

1. 対象年月の指定
2. 対象クライアントの選択（未選択時は全クライアント）
3. 対象クライアントの契約情報取得
4. 契約に関連する技術者の勤怠データ取得
5. 請求データの構築
   - クライアント情報設定
   - 請求日・支払期限日の設定（契約の支払条件から）
   - 請求明細の自動作成（技術者毎の勤怠情報から）
   - 請求金額の計算
6. 請求書データの保存

**ビジネスロジック**

- 契約タイプに応じた請求金額計算
  - 固定単価契約：契約金額をそのまま請求
  - 時間単価契約：実績時間 × 時間単価
  - 日単価契約：実績日数 × 日単価
- 請求書の説明文は「YYYY年MM月分 技術者派遣料金」の形式で自動生成
- 複数契約がある場合、契約毎に請求明細を作成
- 勤怠未承認の技術者は対象外

**エラー処理**

- 対象契約が存在しない場合：処理をスキップ
- 承認済み勤怠データが存在しない場合：処理をスキップ
- 請求条件が不足している場合：InsufficientInvoiceGenerationDataException

#### 2.1.3 請求書更新機能

**概要**

作成済みの請求書情報を更新する機能です。

**処理フロー**

1. 対象請求書の取得
2. 請求書ステータスの確認（下書き状態のみ更新可能）
3. 請求情報の更新
   - 請求日・支払期限日の更新
   - 説明・備考の更新
   - 請求条件の更新
4. 請求明細の更新
   - 既存明細の削除
   - 新規明細の作成
5. 請求金額の再計算
6. 更新データの保存

**バリデーションルール**

- 下書き状態の請求書のみ更新可能
- 請求明細は最低1件必須
- 更新後も各項目のバリデーションルールを満たすこと

**エラー処理**

- 請求書が存在しない場合：ResourceNotFoundException
- 請求書が下書き状態でない場合：InvalidInvoiceStatusException
- 更新データが不正な場合：IllegalArgumentException

#### 2.1.4 請求書確定機能

**概要**

請求書を確定状態に変更し、請求番号を付与する機能です。

**処理フロー**

1. 対象請求書の取得
2. 請求書ステータスの確認（下書き状態のみ確定可能）
3. 請求書番号の採番
   - フォーマット：INV-{年月}-{5桁連番}
   - 例：INV-202305-00001
4. 請求書ステータスを「CONFIRMED」に変更
5. 確定日時の記録
6. 確定情報の保存

**ビジネスロジック**

- 請求書番号は年月毎に連番で管理
- 採番後の請求書番号は重複不可かつ変更不可
- 確定後の請求書は編集不可、取消のみ可能

**エラー処理**

- 請求書が存在しない場合：ResourceNotFoundException
- 請求書が下書き状態でない場合：InvalidInvoiceStatusException
- 請求番号採番エラー：SystemException

#### 2.1.5 請求書取消機能

**概要**

確定済みの請求書をキャンセル状態に変更する機能です。

**処理フロー**

1. 対象請求書の取得
2. 請求書ステータスの確認（確定済み状態のみ取消可能）
3. 入金状況の確認（入金済みの場合は取消不可）
4. 請求書ステータスを「CANCELED」に変更
5. 取消日時と取消理由の記録
6. 取消情報の保存

**バリデーションルール**

- 確定済み状態の請求書のみ取消可能
- 入金処理が行われた請求書は取消不可
- 取消理由は必須

**エラー処理**

- 請求書が存在しない場合：ResourceNotFoundException
- 請求書が確定済み状態でない場合：InvalidInvoiceStatusException
- 入金済みの請求書を取消しようとした場合：BusinessException

#### 2.1.6 請求書検索機能

**概要**

条件に基づいて請求書を検索する機能です。

**検索条件**

- クライアントID
- 請求書ステータス
- 請求日範囲
- 支払期限日範囲
- 請求番号
- 請求金額範囲
- 対象年月
- 入金状況（未入金/入金済み）
- 支払期限超過フラグ

**処理フロー**

1. 検索条件の入力
2. バリデーション
3. 検索条件に基づくクエリ構築
4. データベース検索
5. 検索結果の返却（ページネーション対応）

**ソート条件**

- デフォルト：請求日の降順
- ソート可能項目：請求日、支払期限日、請求番号、請求金額、ステータス

**エラー処理**

- 検索条件が不正な場合：IllegalArgumentException
- 検索処理エラー：SystemException

### 2.2 契約情報からの請求条件設定

**概要**

契約情報から請求書の請求条件を自動設定する機能です。

**処理フロー**

1. 契約IDの指定
2. 契約情報の取得
3. 契約から請求条件の抽出
   - 支払期限日数
   - 請求方法
   - 請求先情報
   - 銀行口座情報
4. 請求条件DTOの作成と返却

**ビジネスロジック**

- 契約に請求条件が設定されていない場合はクライアントのデフォルト条件を使用
- クライアントにデフォルト条件がない場合はシステムのデフォルト条件を使用

**エラー処理**

- 契約が存在しない場合：ResourceNotFoundException
- 請求条件の取得に失敗した場合：SystemException

## 3. イベント設計

請求管理機能では、以下のイベントを定義し、他モジュールとの連携を実現します。

### 3.1 発行イベント

| イベント名 | 発行タイミング | 含む情報 | 目的 |
|-----------|--------------|---------|------|
| InvoiceCreatedEvent | 請求書作成時 | 請求書ID、作成日時 | 請求書作成の通知 |
| InvoiceConfirmedEvent | 請求書確定時 | 請求書ID、確定日時 | ドキュメント生成などの後続処理のトリガー |
| InvoiceCanceledEvent | 請求書取消時 | 請求書ID、取消理由、取消日時 | 関連処理のキャンセル |
| InvoiceUpdatedEvent | 請求書更新時 | 請求書ID、更新日時 | 更新内容の通知 |
| InvoiceStatusChangedEvent | 請求書ステータス変更時 | 請求書ID、旧ステータス、新ステータス、変更日時 | ステータス変更の通知 |

### 3.2 購読イベント

| イベント名 | 発行元 | 処理内容 | 目的 |
|-----------|-------|---------|------|
| ReceiptRegisteredEvent | 入金管理機能 | 請求書の入金状況更新 | 入金情報との連携 |
| ContractUpdatedEvent | 契約管理モジュール | 関連する請求条件の更新確認 | 契約情報との整合性維持 |
| TimesheetApprovedEvent | 勤怠工数管理モジュール | 請求書自動生成の検討 | 勤怠承認に基づく請求書生成 |

## 4. セキュリティ設計

### 4.1 アクセス制御

請求管理機能に対するアクセス制御は以下のように設定します。

| 操作 | 必要権限 | 説明 |
|-----|---------|------|
| 請求書閲覧 | ROLE_INVOICE_VIEW | 請求書の詳細情報を閲覧する権限 |
| 請求書一覧 | ROLE_INVOICE_LIST | 請求書の一覧を閲覧する権限 |
| 請求書作成 | ROLE_INVOICE_CREATE | 新規請求書を作成する権限 |
| 請求書更新 | ROLE_INVOICE_EDIT | 既存請求書を更新する権限 |
| 請求書確定 | ROLE_INVOICE_CONFIRM | 請求書を確定する権限 |
| 請求書取消 | ROLE_INVOICE_CANCEL | 請求書を取消する権限 |
| 請求書自動生成 | ROLE_INVOICE_GENERATE | 勤怠データから請求書を自動生成する権限 |

### 4.2 データアクセス制限

請求データのクライアント間のセキュリティを確保するため、以下の制限を実装します。

- クライアント担当者は自社の請求書のみ閲覧可能
- 経理担当者は全クライアントの請求書を閲覧・編集可能
- 管理者は全ての操作が可能

## 5. エラー処理設計

請求管理機能では、以下のエラーハンドリングを実装します。

| エラーコード | エラー名 | 説明 | HTTP ステータス |
|------------|--------|------|---------------|
| BILLING_ERR_001 | ResourceNotFoundException | 指定されたリソースが存在しない | 404 Not Found |
| BILLING_ERR_002 | InvalidInvoiceStatusException | 請求書のステータスが期待される状態でない | 409 Conflict |
| BILLING_ERR_005 | AmountMismatchException | 金額の整合性が取れていない | 400 Bad Request |
| BILLING_ERR_006 | DataIntegrityException | データの整合性制約違反 | 409 Conflict |
| BILLING_ERR_007 | InsufficientInvoiceGenerationDataException | 請求書生成に必要なデータが不足している | 400 Bad Request |
| BILLING_ERR_009 | InvoicePaidException | 入金済みの請求書に対する禁止操作 | 409 Conflict |

## 6. テスト方針

### 6.1 単体テスト

- 請求書作成処理のバリデーションテスト
- 請求金額計算ロジックのテスト
- 請求書状態遷移テスト
- 請求番号採番処理テスト
- 請求条件自動設定テスト

### 6.2 統合テスト

- 請求書作成から確定までの一連の処理テスト
- 勤怠データからの請求書自動生成テスト
- 契約情報と請求条件の連携テスト
- 請求書と入金情報の連携テスト

### 6.3 パフォーマンステスト

- 大量請求書の検索性能テスト
- 月次一括請求書生成の処理時間テスト
- 複数ユーザーによる同時操作テスト

## 7. 将来拡張性

請求管理機能は以下の拡張性を考慮して設計します。

### 7.1 多通貨対応

将来的な多通貨対応のため、以下の設計ポイントを考慮します。

- 通貨コードを請求書と請求明細に保持
- 金額計算・表示時の通貨考慮
- 為替レート管理機能の拡張ポイントを用意

### 7.2 税制改正対応

消費税率変更などの税制改正に柔軟に対応するため、以下の設計を行います。

- 税率をマスタデータとして管理
- 請求明細単位での税率保持
- 請求日に基づく適用税率の自動判定機能

### 7.3 請求書フォーマットカスタマイズ

クライアント別の請求書フォーマットカスタマイズに対応するため、以下の設計を行います。

- テンプレートベースの請求書生成
- クライアント別テンプレート設定機能
- カスタムフィールド対応