# 請求書管理機能

本ドキュメントでは、請求支払管理モジュールの中の請求書管理機能の詳細設計を記述します。この機能は請求書ドキュメントの生成、管理、送付を担当します。

## 1. 概要

請求書管理機能は、請求書データから実際の請求書ドキュメント（PDF等）を生成し、管理するための機能です。テンプレートベースの請求書生成、電子配信、ダウンロード、履歴管理などの機能を提供します。

### 1.1 主要機能

- 請求書ドキュメントの生成
- 請求書テンプレートの管理
- 請求書ドキュメントの保存・取得
- 請求書ドキュメントのメール送信
- 請求書ドキュメントの履歴管理
- 請求書ドキュメントのセキュリティ管理

### 1.2 処理フロー概要

1. 請求書ドキュメント生成
   - 確定した請求書データを元にテンプレートを適用
   - PDF等のフォーマットでドキュメント生成

2. ドキュメント保存
   - 生成したドキュメントをファイルストレージに保存
   - メタデータをデータベースに記録

3. ドキュメント配信
   - 顧客へのメール送信
   - ダウンロードURLの生成

4. 履歴管理
   - 送信履歴の記録
   - 閲覧履歴の追跡

## 2. 機能詳細設計

### 2.1 請求書ドキュメント生成

#### 2.1.1 請求書ドキュメント生成機能

**概要**

請求書データをテンプレートに適用し、PDF形式の請求書ドキュメントを生成する機能です。

**処理フロー**

1. 請求書IDの指定
2. 請求書データの取得
3. 請求書ステータスの確認（確定済み状態が必須）
4. テンプレートの選択
   - 指定されたテンプレート
   - クライアント固有テンプレート
   - デフォルトテンプレート
5. 請求書データとテンプレートの結合
6. PDFの生成
7. ファイルストレージへの保存
8. ドキュメントメタデータの保存

**利用コンポーネント**

- テンプレートエンジン：Thymeleaf等のHTMLテンプレートエンジン
- PDF生成：HTML to PDF変換ライブラリ
- ファイルストレージ：共通モジュールのファイル管理サービス

**バリデーションルール**

- 請求書は確定済み状態であること
- 指定されたテンプレートが存在すること
- 必要なデータ（クライアント情報、請求明細等）が揃っていること

**エラー処理**

- 請求書が存在しない場合：ResourceNotFoundException
- 請求書が確定済み状態でない場合：BusinessException
- テンプレートが存在しない場合：ResourceNotFoundException
- PDF生成エラー：SystemException

#### 2.1.2 請求書テンプレート管理機能

**概要**

請求書ドキュメント生成に使用するテンプレートを管理する機能です。

**処理フロー**

1. テンプレート作成
   - テンプレート名の設定
   - テンプレート内容（HTML）の登録
   - デフォルトフラグの設定
2. テンプレート更新
   - 既存テンプレートの取得と更新
   - デフォルト設定変更時の整合性確保
3. クライアント別テンプレート設定
   - クライアントとテンプレートの紐付け
   - 紐付け情報の保存

**テンプレート構成要素**

- ヘッダー：会社ロゴ、住所、連絡先等
- 請求情報：請求番号、請求日、支払期限等
- クライアント情報：名称、住所、担当者等
- 請求明細テーブル：項目名、数量、単価、金額等
- 合計金額：小計、税額、合計金額等
- フッター：銀行口座情報、備考等

**バリデーションルール**

- テンプレート名は必須かつ100文字以内
- テンプレート内容は必須かつ有効なHTML形式
- デフォルトフラグがtrueのテンプレートは常に1つ存在すること

**エラー処理**

- テンプレートが存在しない場合：ResourceNotFoundException
- テンプレート名が重複した場合：DataIntegrityException
- 有効なHTMLでない場合：IllegalArgumentException

### 2.2 請求書ドキュメント管理

#### 2.2.1 請求書ドキュメント取得機能

**概要**

生成された請求書ドキュメントの情報を取得する機能です。

**処理フロー**

1. ドキュメントIDの指定
2. ドキュメントメタデータの取得
3. 関連情報（送信履歴等）の取得
4. 結果の返却

**取得可能情報**

- ドキュメント基本情報（ID、ファイル名、サイズ等）
- 関連請求書情報
- 生成情報（日時、テンプレート、生成者等）
- 送信履歴情報
- 閲覧履歴情報

**エラー処理**

- ドキュメントが存在しない場合：ResourceNotFoundException
- アクセス権限がない場合：AccessDeniedException

#### 2.2.2 請求書ドキュメントコンテンツ取得機能

**概要**

生成された請求書ドキュメントの実体（PDFファイル）を取得する機能です。

**処理フロー**

1. ドキュメントIDの指定
2. ドキュメントメタデータの取得
3. ファイルストレージからファイル実体の取得
4. 閲覧履歴の記録
5. ファイルコンテンツの返却

**セキュリティ対策**

- アクセス権限の確認
- ダウンロード時のユーザー認証
- アクセスログの記録

**エラー処理**

- ドキュメントが存在しない場合：ResourceNotFoundException
- ファイルが見つからない場合：FileNotFoundException
- アクセス権限がない場合：AccessDeniedException

#### 2.2.3 請求書ドキュメントダウンロードURL生成機能

**概要**

請求書ドキュメントをダウンロードするための一時URLを生成する機能です。

**処理フロー**

1. ドキュメントIDと有効期限の指定
2. ドキュメントメタデータの取得
3. ファイルストレージでの署名付きURL生成
4. URLと有効期限情報の返却

**セキュリティ対策**

- 有効期限の設定（デフォルト30分）
- URLに認証情報を含める
- URLアクセス時の閲覧履歴記録

**エラー処理**

- ドキュメントが存在しない場合：ResourceNotFoundException
- URL生成エラー：SystemException

### 2.3 請求書ドキュメント送信

#### 2.3.1 請求書ドキュメント送信機能

**概要**

生成された請求書ドキュメントをメールで送信する機能です。

**処理フロー**

1. ドキュメントIDの指定
2. 送信先メールアドレスの指定
3. 件名・本文の設定（テンプレートまたはカスタム）
4. 請求書PDFの添付
5. メール送信処理
6. 送信履歴の記録
7. ドキュメントステータスの更新

**送信オプション**

- 複数送信先の指定
- CC、BCCの設定
- 開封確認の要求設定
- 件名・本文のカスタマイズ

**バリデーションルール**

- 送信先メールアドレスは必須かつ有効な形式
- 件名は必須かつ255文字以内
- 本文は必須

**エラー処理**

- ドキュメントが存在しない場合：ResourceNotFoundException
- メール送信エラー：DocumentDeliveryException
- バリデーションエラー：IllegalArgumentException

#### 2.3.2 メール開封確認機能

**概要**

送信した請求書メールの開封状況を追跡する機能です。

**処理フロー**

1. 送信時に一意のトラッキングIDを生成
2. メール本文にトラッキング用の小さな画像を埋め込み
3. 画像のURLにトラッキングIDを含める
4. 画像リクエスト受信時に開封情報を記録
5. 送信履歴の更新

**セキュリティ対策**

- トラッキングIDの暗号化
- アクセス情報の匿名化

**エラー処理**

- トラッキングIDが無効な場合：無視して透明画像を返す
- 記録処理エラー：ログに記録して処理継続

### 2.4 請求書ドキュメント履歴管理

#### 2.4.1 送信履歴管理機能

**概要**

請求書ドキュメントの送信履歴を管理する機能です。

**処理フロー**

1. ドキュメント送信時に履歴レコード作成
2. 送信先、送信日時、送信方法等の記録
3. 開封情報の更新（該当する場合）
4. 履歴情報の取得・表示

**記録情報**

- 送信日時
- 送信先リスト
- 送信方法（メール、ダウンロードリンク等）
- 送信ステータス（成功、失敗）
- 開封確認フラグ
- 開封日時（確認された場合）

**エラー処理**

- 履歴記録エラー：ログに記録し処理継続
- 履歴取得エラー：ResourceNotFoundException

#### 2.4.2 閲覧履歴管理機能

**概要**

請求書ドキュメントの閲覧履歴を管理する機能です。

**処理フロー**

1. ドキュメント閲覧時に履歴レコード作成
2. 閲覧者、日時、IPアドレス等の記録
3. 履歴情報の取得・表示

**記録情報**

- 閲覧日時
- 閲覧者ID（認証ユーザーの場合）
- IPアドレス
- User-Agent情報

**セキュリティ対策**

- IPアドレスの匿名化（必要に応じて）
- アクセス権限の確認

**エラー処理**

- 履歴記録エラー：ログに記録し処理継続
- 履歴取得エラー：ResourceNotFoundException

## 3. イベント設計

請求書ドキュメント管理機能では、以下のイベントを定義します。

### 3.1 発行イベント

| イベント名 | 発行タイミング | 含む情報 | 目的 |
|-----------|--------------|---------|------|
| DocumentGeneratedEvent | ドキュメント生成時 | ドキュメントID、請求書ID、生成日時 | ドキュメント生成の通知 |
| DocumentSentEvent | ドキュメント送信時 | ドキュメントID、請求書ID、送信先リスト、送信日時 | ドキュメント送信の通知 |
| DocumentViewedEvent | ドキュメント閲覧時 | ドキュメントID、請求書ID、閲覧日時 | ドキュメント閲覧の通知 |
| DocumentReadEvent | メール開封確認時 | ドキュメントID、請求書ID、開封日時 | メール開封の通知 |

### 3.2 購読イベント

| イベント名 | 発行元 | 処理内容 | 目的 |
|-----------|-------|---------|------|
| InvoiceConfirmedEvent | 請求管理機能 | ドキュメント自動生成の検討 | 確定請求書のドキュメント生成 |
| InvoiceCanceledEvent | 請求管理機能 | 関連ドキュメントのステータス更新 | 取消請求書のドキュメント管理 |

## 4. セキュリティ設計

### 4.1 アクセス制御

請求書ドキュメント管理機能に対するアクセス制御は以下のように設定します。

| 操作 | 必要権限 | 説明 |
|-----|---------|------|
| ドキュメント生成 | ROLE_INVOICE_DOCUMENT_CREATE | 請求書ドキュメントを生成する権限 |
| ドキュメント閲覧 | ROLE_INVOICE_DOCUMENT_VIEW | 請求書ドキュメントを閲覧する権限 |
| ドキュメント送信 | ROLE_INVOICE_DOCUMENT_SEND | 請求書ドキュメントを送信する権限 |
| ドキュメント履歴閲覧 | ROLE_INVOICE_DOCUMENT_HISTORY_VIEW | 送信・閲覧履歴を閲覧する権限 |
| テンプレート管理 | ROLE_INVOICE_TEMPLATE_MANAGE | 請求書テンプレートを管理する権限 |

### 4.2 ドキュメントアクセス制限

請求書ドキュメントのセキュリティを確保するため、以下の対策を実装します。

- クライアント担当者は自社の請求書ドキュメントのみ閲覧可能
- ドキュメントへのアクセスは認証・認可を必須とする
- ダウンロードURLには有効期限を設定する
- ダウンロードURLには一意のトークンを含め、推測を防止する
- ドキュメントのストレージには暗号化を適用する

### 4.3 データ保護

請求書ドキュメントの機密情報保護のため、以下の対策を実装します。

- ファイル転送時のTLS/SSL暗号化
- ストレージ上のファイル暗号化（サーバーサイド暗号化）
- 銀行口座情報等の機密情報マスキング（必要に応じて）
- セキュリティポリシーに基づくアクセス制御

## 5. エラー処理設計

請求書ドキュメント管理機能では、以下のエラーハンドリングを実装します。

| エラーコード | エラー名 | 説明 | HTTP ステータス |
|------------|--------|------|---------------|
| BILLING_ERR_001 | ResourceNotFoundException | 指定されたリソースが存在しない | 404 Not Found |
| BILLING_ERR_010 | DocumentGenerationException | ドキュメント生成エラー | 500 Internal Server Error |
| BILLING_ERR_011 | DocumentDeliveryException | ドキュメント送信エラー | 400 Bad Request |
| BILLING_ERR_012 | InvalidDocumentStatusException | ドキュメント状態が不正 | 409 Conflict |
| BILLING_ERR_013 | FileStorageException | ファイルストレージ操作エラー | 500 Internal Server Error |
| BILLING_ERR_014 | TemplateProcessingException | テンプレート処理エラー | 500 Internal Server Error |

## 6. テスト方針

### 6.1 単体テスト

- テンプレート処理ロジックのテスト
- PDF生成処理のテスト
- メール送信処理のテスト
- 閲覧履歴記録処理のテスト
- ダウンロードURL生成処理のテスト

### 6.2 統合テスト

- 請求書確定からドキュメント生成までの一連の処理テスト
- ドキュメント生成から送信までの一連の処理テスト
- テンプレート管理機能のテスト
- ファイルストレージとの連携テスト
- メール送信サービスとの連携テスト

### 6.3 パフォーマンステスト

- 大量ドキュメント生成の処理時間テスト
- 複数テンプレート適用の処理時間比較
- 同時アクセス時のパフォーマンステスト

## 7. 将来拡張性

請求書ドキュメント管理機能は以下の拡張性を考慮して設計します。

### 7.1 マルチフォーマット対応

将来的な複数フォーマットでの請求書出力に対応するための拡張ポイントを用意します。

- ドキュメントフォーマッタインターフェースの導入
- フォーマッタの実装（PDF, Excel, CSV等）
- フォーマットに応じたテンプレート管理

### 7.2 電子インボイス対応

将来的な電子インボイス制度への対応を考慮します。

- Peppol/JEDICなどの標準フォーマット出力対応
- 電子署名機能の統合
- インボイス連携ポータルとの接続機能

### 7.3 多言語対応

グローバル展開を考慮した多言語対応の拡張ポイントを用意します。

- 言語別テンプレート管理
- 言語リソースの外部化
- 多言語対応の日付・通貨フォーマット