# インターフェース定義

本ドキュメントでは、レポーティングモジュールが提供するインターフェースと、他モジュールから利用するインターフェースを定義します。

## 1. 提供インターフェース

レポーティングモジュールは以下のサービスインターフェースを提供します。

### 1.1 DashboardService

KPIダッシュボードの管理と提供に関する機能を提供するサービスです。

```java
/**
 * ダッシュボード管理サービスのインターフェース
 */
public interface DashboardService {
    
    /**
     * ユーザーのダッシュボード一覧を取得します
     * 
     * @param userId ユーザーID
     * @return ダッシュボード情報のリスト
     * @throws ResourceNotFoundException ユーザーが存在しない場合
     */
    List<DashboardDto> getUserDashboards(String userId);
    
    /**
     * 公開されているダッシュボード一覧を取得します
     * 
     * @return 公開ダッシュボード情報のリスト
     */
    List<DashboardDto> getPublicDashboards();
    
    /**
     * ダッシュボードの詳細情報を取得します
     * 
     * @param dashboardId ダッシュボードID
     * @return ダッシュボード詳細情報
     * @throws ResourceNotFoundException ダッシュボードが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    DashboardDetailDto getDashboard(String dashboardId);
    
    /**
     * ダッシュボードを新規作成します
     * 
     * @param request ダッシュボード作成リクエスト
     * @return 作成されたダッシュボード情報
     * @throws IllegalArgumentException パラメータが不正な場合
     */
    DashboardDto createDashboard(CreateDashboardRequest request);
    
    /**
     * ダッシュボードを更新します
     * 
     * @param dashboardId ダッシュボードID
     * @param request ダッシュボード更新リクエスト
     * @return 更新されたダッシュボード情報
     * @throws ResourceNotFoundException ダッシュボードが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     */
    DashboardDto updateDashboard(String dashboardId, UpdateDashboardRequest request);
    
    /**
     * ダッシュボードを削除します
     * 
     * @param dashboardId ダッシュボードID
     * @throws ResourceNotFoundException ダッシュボードが存在しない場合
     * @throws AccessDeniedException 削除権限がない場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    void deleteDashboard(String dashboardId);
    
    /**
     * ウィジェットを追加します
     * 
     * @param dashboardId ダッシュボードID
     * @param request ウィジェット作成リクエスト
     * @return 作成されたウィジェット情報
     * @throws ResourceNotFoundException ダッシュボードが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     */
    WidgetDto addWidget(String dashboardId, CreateWidgetRequest request);
    
    /**
     * ウィジェットを更新します
     * 
     * @param widgetId ウィジェットID
     * @param request ウィジェット更新リクエスト
     * @return 更新されたウィジェット情報
     * @throws ResourceNotFoundException ウィジェットが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     */
    WidgetDto updateWidget(String widgetId, UpdateWidgetRequest request);
    
    /**
     * ウィジェットを削除します
     * 
     * @param widgetId ウィジェットID
     * @throws ResourceNotFoundException ウィジェットが存在しない場合
     * @throws AccessDeniedException 削除権限がない場合
     */
    void deleteWidget(String widgetId);
    
    /**
     * KPI一覧を取得します
     * 
     * @param category カテゴリ（任意）
     * @param isActive 有効フラグ（任意）
     * @return KPI情報のリスト
     */
    List<KpiDefinitionDto> getKpiDefinitions(KpiCategory category, Boolean isActive);
    
    /**
     * KPI実績を取得します
     * 
     * @param kpiId KPI ID
     * @param year 年
     * @param month 月（0の場合は年次）
     * @param departmentId 部門ID（任意）
     * @return KPI実績情報
     * @throws ResourceNotFoundException KPIが存在しない場合
     */
    KpiAchievementDto getKpiAchievement(String kpiId, int year, int month, String departmentId);
    
    /**
     * 複数KPIの実績を一括取得します
     * 
     * @param request KPI実績取得リクエスト
     * @return KPI実績情報のリスト
     */
    List<KpiAchievementDto> getKpiAchievements(GetKpiAchievementsRequest request);
}
```

### 1.2 ReportService

標準レポートの生成と管理に関する機能を提供するサービスです。

```java
/**
 * レポート管理サービスのインターフェース
 */
public interface ReportService {
    
    /**
     * レポート一覧を取得します
     * 
     * @param category カテゴリ（任意）
     * @param isActive 有効フラグ（任意）
     * @return レポート情報のリスト
     */
    List<ReportDto> getReports(ReportCategory category, Boolean isActive);
    
    /**
     * レポートの詳細情報を取得します
     * 
     * @param reportId レポートID
     * @return レポート詳細情報
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    ReportDetailDto getReport(String reportId);
    
    /**
     * レポートをコードで取得します
     * 
     * @param reportCode レポートコード
     * @return レポート詳細情報
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    ReportDetailDto getReportByCode(String reportCode);
    
    /**
     * レポートを実行します
     * 
     * @param reportId レポートID
     * @param parameters 実行パラメータ
     * @param outputFormat 出力形式
     * @param async 非同期実行フラグ
     * @return レポート実行結果
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws AccessDeniedException 実行権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws ReportGenerationException レポート生成エラーの場合
     */
    ReportExecutionResultDto executeReport(String reportId, Map<String, Object> parameters, 
                                          OutputFormat outputFormat, boolean async);
    
    /**
     * 売上レポートを生成します
     * 
     * @param year 年
     * @param month 月（0の場合は年次）
     * @param clientId クライアントID（任意）
     * @param outputFormat 出力形式
     * @return レポート実行結果
     */
    ReportExecutionResultDto generateSalesReport(int year, int month, String clientId, 
                                               OutputFormat outputFormat);
    
    /**
     * 粗利レポートを生成します
     * 
     * @param year 年
     * @param month 月（0の場合は年次）
     * @param clientId クライアントID（任意）
     * @param outputFormat 出力形式
     * @return レポート実行結果
     */
    ReportExecutionResultDto generateProfitReport(int year, int month, String clientId, 
                                                OutputFormat outputFormat);
    
    /**
     * 稼働率レポートを生成します
     * 
     * @param year 年
     * @param month 月（0の場合は年次）
     * @param departmentId 部門ID（任意）
     * @param outputFormat 出力形式
     * @return レポート実行結果
     */
    ReportExecutionResultDto generateUtilizationReport(int year, int month, String departmentId, 
                                                     OutputFormat outputFormat);
    
    /**
     * レポート実行履歴を取得します
     * 
     * @param reportId レポートID（任意）
     * @param userId 実行者ID（任意）
     * @param status 実行ステータス（任意）
     * @param fromDate 開始日（任意）
     * @param toDate 終了日（任意）
     * @return 実行履歴のリスト
     */
    List<ReportExecutionDto> getReportExecutionHistory(String reportId, String userId, 
                                                    ExecutionStatus status, 
                                                    LocalDate fromDate, LocalDate toDate);
    
    /**
     * 実行結果ファイルをダウンロードするURLを取得します
     * 
     * @param executionId 実行ID
     * @param expirationMinutes URL有効期限（分）
     * @return ダウンロードURL
     * @throws ResourceNotFoundException 実行結果が存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    String getReportDownloadUrl(String executionId, int expirationMinutes);
}
```

### 1.3 CustomReportService

カスタムレポートの定義と実行に関する機能を提供するサービスです。

```java
/**
 * カスタムレポート管理サービスのインターフェース
 */
public interface CustomReportService {
    
    /**
     * カスタムレポート一覧を取得します
     * 
     * @param category カテゴリ（任意）
     * @param userId 作成者ID（任意）
     * @param isPublic 公開フラグ（任意）
     * @return カスタムレポート情報のリスト
     */
    List<CustomReportDto> getCustomReports(ReportCategory category, String userId, Boolean isPublic);
    
    /**
     * カスタムレポートの詳細情報を取得します
     * 
     * @param reportId レポートID
     * @return カスタムレポート詳細情報
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    CustomReportDetailDto getCustomReport(String reportId);
    
    /**
     * カスタムレポートを新規作成します
     * 
     * @param request カスタムレポート作成リクエスト
     * @return 作成されたカスタムレポート情報
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws AccessDeniedException データソースへのアクセス権限がない場合
     */
    CustomReportDto createCustomReport(CreateCustomReportRequest request);
    
    /**
     * カスタムレポートを更新します
     * 
     * @param reportId レポートID
     * @param request カスタムレポート更新リクエスト
     * @return 更新されたカスタムレポート情報
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     */
    CustomReportDto updateCustomReport(String reportId, UpdateCustomReportRequest request);
    
    /**
     * カスタムレポートを削除します
     * 
     * @param reportId レポートID
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws AccessDeniedException 削除権限がない場合
     */
    void deleteCustomReport(String reportId);
    
    /**
     * カスタムレポートを実行します
     * 
     * @param reportId レポートID
     * @param parameters 実行パラメータ
     * @param outputFormat 出力形式
     * @param async 非同期実行フラグ
     * @return レポート実行結果
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws AccessDeniedException 実行権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws ReportGenerationException レポート生成エラーの場合
     */
    ReportExecutionResultDto executeCustomReport(String reportId, Map<String, Object> parameters, 
                                               OutputFormat outputFormat, boolean async);
    
    /**
     * データソース一覧を取得します
     * 
     * @param type データソース種別（任意）
     * @return データソース情報のリスト
     */
    List<DataSourceDto> getDataSources(DataSourceType type);
    
    /**
     * データソースのメタデータを取得します
     * 
     * @param dataSourceId データソースID
     * @return データソースメタデータ情報
     * @throws ResourceNotFoundException データソースが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    DataSourceMetadataDto getDataSourceMetadata(String dataSourceId);
}
```

### 1.4 ForecastService

予測分析とシミュレーションに関する機能を提供するサービスです。

```java
/**
 * 予測分析サービスのインターフェース
 */
public interface ForecastService {
    
    /**
     * 予測モデル一覧を取得します
     * 
     * @param type 予測タイプ（任意）
     * @param target 予測対象（任意）
     * @param isActive 有効フラグ（任意）
     * @return 予測モデル情報のリスト
     */
    List<ForecastModelDto> getForecastModels(ForecastType type, String target, Boolean isActive);
    
    /**
     * 予測モデルの詳細情報を取得します
     * 
     * @param modelId モデルID
     * @return 予測モデル詳細情報
     * @throws ResourceNotFoundException モデルが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    ForecastModelDetailDto getForecastModel(String modelId);
    
    /**
     * 予測モデルを新規作成します
     * 
     * @param request 予測モデル作成リクエスト
     * @return 作成された予測モデル情報
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws AccessDeniedException データソースへのアクセス権限がない場合
     */
    ForecastModelDto createForecastModel(CreateForecastModelRequest request);
    
    /**
     * 予測モデルを更新します
     * 
     * @param modelId モデルID
     * @param request 予測モデル更新リクエスト
     * @return 更新された予測モデル情報
     * @throws ResourceNotFoundException モデルが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     */
    ForecastModelDto updateForecastModel(String modelId, UpdateForecastModelRequest request);
    
    /**
     * 予測モデルを削除します
     * 
     * @param modelId モデルID
     * @throws ResourceNotFoundException モデルが存在しない場合
     * @throws AccessDeniedException 削除権限がない場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    void deleteForecastModel(String modelId);
    
    /**
     * 予測モデルを学習します
     * 
     * @param modelId モデルID
     * @param parameters 学習パラメータ
     * @param async 非同期実行フラグ
     * @return 学習結果
     * @throws ResourceNotFoundException モデルが存在しない場合
     * @throws AccessDeniedException 実行権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws ModelTrainingException 学習エラーの場合
     */
    ModelTrainingResultDto trainForecastModel(String modelId, Map<String, Object> parameters, boolean async);
    
    /**
     * 予測シナリオを実行します
     * 
     * @param scenarioId シナリオID
     * @param parameters 実行パラメータ
     * @return 予測結果
     * @throws ResourceNotFoundException シナリオが存在しない場合
     * @throws AccessDeniedException 実行権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws ForecastExecutionException 予測実行エラーの場合
     */
    ForecastResultDto executeForecast(String scenarioId, Map<String, Object> parameters);
    
    /**
     * 売上予測を取得します
     * 
     * @param months 予測月数
     * @param clientId クライアントID（任意）
     * @param confidence 信頼区間（0.0-1.0）
     * @return 売上予測結果
     */
    SalesForecastDto getSalesForecast(int months, String clientId, double confidence);
    
    /**
     * 利益予測を取得します
     * 
     * @param months 予測月数
     * @param clientId クライアントID（任意）
     * @param confidence 信頼区間（0.0-1.0）
     * @return 利益予測結果
     */
    ProfitForecastDto getProfitForecast(int months, String clientId, double confidence);
    
    /**
     * 稼働率予測を取得します
     * 
     * @param months 予測月数
     * @param departmentId 部門ID（任意）
     * @param confidence 信頼区間（0.0-1.0）
     * @return 稼働率予測結果
     */
    UtilizationForecastDto getUtilizationForecast(int months, String departmentId, double confidence);
    
    /**
     * What-ifシミュレーションを実行します
     * 
     * @param request シミュレーションリクエスト
     * @return シミュレーション結果
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws SimulationExecutionException シミュレーション実行エラーの場合
     */
    SimulationResultDto executeSimulation(SimulationRequest request);
}
```

### 1.5 DataSourceService

レポート用データソースの管理に関する機能を提供するサービスです。

```java
/**
 * データソース管理サービスのインターフェース
 */
public interface DataSourceService {
    
    /**
     * データソース一覧を取得します
     * 
     * @param type データソース種別（任意）
     * @param isBuiltIn ビルトインフラグ（任意）
     * @return データソース情報のリスト
     */
    List<DataSourceDto> getDataSources(DataSourceType type, Boolean isBuiltIn);
    
    /**
     * データソースの詳細情報を取得します
     * 
     * @param dataSourceId データソースID
     * @return データソース詳細情報
     * @throws ResourceNotFoundException データソースが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    DataSourceDetailDto getDataSource(String dataSourceId);
    
    /**
     * データソースを新規作成します
     * 
     * @param request データソース作成リクエスト
     * @return 作成されたデータソース情報
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws DataSourceConnectionException 接続エラーの場合
     */
    DataSourceDto createDataSource(CreateDataSourceRequest request);
    
    /**
     * データソースを更新します
     * 
     * @param dataSourceId データソースID
     * @param request データソース更新リクエスト
     * @return 更新されたデータソース情報
     * @throws ResourceNotFoundException データソースが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws DataSourceConnectionException 接続エラーの場合
     */
    DataSourceDto updateDataSource(String dataSourceId, UpdateDataSourceRequest request);
    
    /**
     * データソースを削除します
     * 
     * @param dataSourceId データソースID
     * @throws ResourceNotFoundException データソースが存在しない場合
     * @throws AccessDeniedException 削除権限がない場合
     * @throws BusinessException ビジネスルール違反の場合
     */
    void deleteDataSource(String dataSourceId);
    
    /**
     * データソースの接続テストを実行します
     * 
     * @param dataSourceId データソースID
     * @return 接続テスト結果
     * @throws ResourceNotFoundException データソースが存在しない場合
     * @throws DataSourceConnectionException 接続エラーの場合
     */
    ConnectionTestResultDto testConnection(String dataSourceId);
    
    /**
     * データソースからデータを取得します
     * 
     * @param dataSourceId データソースID
     * @param parameters クエリパラメータ
     * @param maxRows 最大行数
     * @return 取得したデータ
     * @throws ResourceNotFoundException データソースが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     * @throws DataSourceExecutionException 実行エラーの場合
     */
    DataResultDto executeQuery(String dataSourceId, Map<String, Object> parameters, int maxRows);
    
    /**
     * データソースのメタデータを取得します
     * 
     * @param dataSourceId データソースID
     * @return メタデータ情報
     * @throws ResourceNotFoundException データソースが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     * @throws DataSourceConnectionException 接続エラーの場合
     */
    DataSourceMetadataDto getMetadata(String dataSourceId);
}
```

### 1.6 ScheduleService

レポートの自動実行スケジュール管理に関する機能を提供するサービスです。

```java
/**
 * スケジュール管理サービスのインターフェース
 */
public interface ScheduleService {
    
    /**
     * スケジュール一覧を取得します
     * 
     * @param reportId レポートID（任意）
     * @param isActive 有効フラグ（任意）
     * @return スケジュール情報のリスト
     */
    List<ScheduleDto> getSchedules(String reportId, Boolean isActive);
    
    /**
     * スケジュールの詳細情報を取得します
     * 
     * @param scheduleId スケジュールID
     * @return スケジュール詳細情報
     * @throws ResourceNotFoundException スケジュールが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    ScheduleDetailDto getSchedule(String scheduleId);
    
    /**
     * スケジュールを新規作成します
     * 
     * @param request スケジュール作成リクエスト
     * @return 作成されたスケジュール情報
     * @throws ResourceNotFoundException レポートが存在しない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     * @throws AccessDeniedException 権限がない場合
     */
    ScheduleDto createSchedule(CreateScheduleRequest request);
    
    /**
     * スケジュールを更新します
     * 
     * @param scheduleId スケジュールID
     * @param request スケジュール更新リクエスト
     * @return 更新されたスケジュール情報
     * @throws ResourceNotFoundException スケジュールが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     * @throws IllegalArgumentException パラメータが不正な場合
     */
    ScheduleDto updateSchedule(String scheduleId, UpdateScheduleRequest request);
    
    /**
     * スケジュールを削除します
     * 
     * @param scheduleId スケジュールID
     * @throws ResourceNotFoundException スケジュールが存在しない場合
     * @throws AccessDeniedException 削除権限がない場合
     */
    void deleteSchedule(String scheduleId);
    
    /**
     * スケジュールを有効化/無効化します
     * 
     * @param scheduleId スケジュールID
     * @param active 有効フラグ
     * @return 更新されたスケジュール情報
     * @throws ResourceNotFoundException スケジュールが存在しない場合
     * @throws AccessDeniedException 更新権限がない場合
     */
    ScheduleDto setScheduleActive(String scheduleId, boolean active);
    
    /**
     * スケジュールを即時実行します
     * 
     * @param scheduleId スケジュールID
     * @return 実行結果
     * @throws ResourceNotFoundException スケジュールが存在しない場合
     * @throws AccessDeniedException 実行権限がない場合
     * @throws ScheduleExecutionException 実行エラーの場合
     */
    ScheduleExecutionResultDto executeScheduleNow(String scheduleId);
    
    /**
     * スケジュール実行履歴を取得します
     * 
     * @param scheduleId スケジュールID
     * @param maxResults 最大結果数
     * @return 実行履歴のリスト
     * @throws ResourceNotFoundException スケジュールが存在しない場合
     * @throws AccessDeniedException アクセス権限がない場合
     */
    List<ScheduleExecutionDto> getScheduleExecutionHistory(String scheduleId, int maxResults);
}
```

## 2. 利用インターフェース

レポーティングモジュールは、以下の他モジュールが提供するインターフェースを利用します。

### 2.1 共通機能モジュール

```java
// ユーザー情報・権限管理サービス
public interface UserService {
    UserDto getUserById(String userId);
    List<UserDto> getUsersByIds(List<String> userIds);
    List<UserDto> getUsersByDepartmentId(String departmentId);
    boolean hasPermission(String userId, String permission);
}

// ファイル管理サービス
public interface FileManagementService {
    String storeFile(byte[] content, String fileName, String contentType, Map<String, String> metadata);
    byte[] getFileContent(String fileId);
    String generateDownloadUrl(String fileId, int expirationMinutes);
    void deleteFile(String fileId);
}

// 通知サービス
public interface NotificationService {
    void sendNotification(NotificationType type, String targetUserId, String title, String content, Map<String, Object> parameters);
    void sendEmail(String to, String subject, String body, List<Attachment> attachments);
    void sendNotificationToRole(NotificationType type, String role, String title, String content, Map<String, Object> parameters);
}
```

### 2.2 請求支払管理モジュール

```java
// 売上データ取得サービス
public interface SalesService {
    List<SalesDataDto> getSalesData(int year, int month, String clientId);
    List<SalesDataDto> getSalesDataByPeriod(LocalDate startDate, LocalDate endDate, String clientId);
    SalesSummaryDto getSalesSummary(int year, int month, String clientId);
}

// 利益データ取得サービス
public interface ProfitService {
    List<ProfitDataDto> getProfitData(int year, int month, String clientId);
    List<ProfitDataDto> getProfitDataByPeriod(LocalDate startDate, LocalDate endDate, String clientId);
    ProfitSummaryDto getProfitSummary(int year, int month, String clientId);
}
```

### 2.3 勤怠工数管理モジュール

```java
// 稼働データ取得サービス
public interface TimesheetService {
    List<TimesheetSummaryDto> getTimesheetSummaries(int year, int month, List<String> engineerIds);
    UtilizationSummaryDto getUtilizationSummary(int year, int month, String departmentId);
    List<EngineerUtilizationDto> getEngineerUtilizations(int year, int month, String departmentId);
}
```

### 2.4 技術者管理モジュール

```java
// 技術者情報取得サービス
public interface EngineerService {
    EngineerDto getEngineerById(String engineerId);
    List<EngineerDto> getEngineersByIds(List<String> engineerIds);
    List<EngineerDto> getEngineersByDepartmentId(String departmentId);
    List<EngineerDto> getEngineersBySkill(String skillId, int level);
}
```

### 2.5 案件管理モジュール

```java
// 案件情報取得サービス
public interface ProjectService {
    ProjectDto getProjectById(String projectId);
    List<ProjectDto> getProjectsByIds(List<String> projectIds);
    List<ProjectDto> getProjectsByClientId(String clientId);
    List<ProjectDto> getActiveProjects();
}
```

## 3. データ交換モデル

### 3.1 ダッシュボード関連データモデル

```java
// ダッシュボードDTO
public class DashboardDto {
    private String id;
    private String name;
    private String userId;
    private boolean isDefault;
    private boolean isPublic;
    private String description;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// ダッシュボード詳細DTO
public class DashboardDetailDto {
    private String id;
    private String name;
    private String userId;
    private boolean isDefault;
    private boolean isPublic;
    private String description;
    private Map<String, Object> layoutConfig;
    private List<WidgetDto> widgets;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// ウィジェットDTO
public class WidgetDto {
    private String id;
    private String dashboardId;
    private String title;
    private WidgetType type;
    private String dataSourceId;
    private Map<String, Object> queryConfig;
    private Map<String, Object> displayConfig;
    private Map<String, Object> positionConfig;
    private int refreshInterval;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// ダッシュボード作成リクエスト
public class CreateDashboardRequest {
    private String name;
    private boolean isDefault;
    private boolean isPublic;
    private String description;
    private Map<String, Object> layoutConfig;
}

// ダッシュボード更新リクエスト
public class UpdateDashboardRequest {
    private String name;
    private boolean isDefault;
    private boolean isPublic;
    private String description;
    private Map<String, Object> layoutConfig;
}

// ウィジェット作成リクエスト
public class CreateWidgetRequest {
    private String title;
    private WidgetType type;
    private String dataSourceId;
    private Map<String, Object> queryConfig;
    private Map<String, Object> displayConfig;
    private Map<String, Object> positionConfig;
    private int refreshInterval;
}

// KPI定義DTO
public class KpiDefinitionDto {
    private String id;
    private String code;
    private String name;
    private String description;
    private KpiCategory category;
    private String unit;
    private String displayFormat;
    private int sortOrder;
    private boolean isActive;
    private TargetDirection targetDirection;
}

// KPI実績DTO
public class KpiAchievementDto {
    private String id;
    private String kpiId;
    private String kpiName;
    private String kpiCode;
    private KpiCategory category;
    private int achievementYear;
    private int achievementMonth;
    private BigDecimal achievementValue;
    private BigDecimal targetValue;
    private BigDecimal achievementPercentage;
    private String departmentId;
    private String unit;
    private TargetDirection targetDirection;
}
```

### 3.2 レポート関連データモデル

```java
// レポートDTO
public class ReportDto {
    private String id;
    private String code;
    private String name;
    private String description;
    private ReportCategory category;
    private ReportType type;
    private boolean isBuiltIn;
    private boolean isActive;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// レポート詳細DTO
public class ReportDetailDto {
    private String id;
    private String code;
    private String name;
    private String description;
    private ReportCategory category;
    private ReportType type;
    private String templatePath;
    private Map<String, Object> parameterConfig;
    private Map<String, Object> displayConfig;
    private Map<String, Object> permissions;
    private boolean isBuiltIn;
    private boolean isActive;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// レポート実行結果DTO
public class ReportExecutionResultDto {
    private String executionId;
    private String reportId;
    private String reportName;
    private ExecutionStatus status;
    private Map<String, Object> parameters;
    private OutputFormat outputFormat;
    private String outputPath;
    private String downloadUrl;
    private String errorMessage;
    private LocalDateTime executionStartTime;
    private LocalDateTime executionEndTime;
    private String executedBy;
}

// レポート実行DTO
public class ReportExecutionDto {
    private String id;
    private String reportId;
    private String reportName;
    private LocalDateTime executionStartTime;
    private LocalDateTime executionEndTime;
    private ExecutionStatus status;
    private Map<String, Object> parameters;
    private OutputFormat outputFormat;
    private String outputPath;
    private String errorMessage;
    private String executedBy;
    private String scheduleId;
}
```

### 3.3 予測分析関連データモデル

```java
// 予測モデルDTO
public class ForecastModelDto {
    private String id;
    private String name;
    private String description;
    private ForecastType type;
    private String target;
    private String algorithm;
    private String dataSourceId;
    private LocalDateTime lastTrainedAt;
    private BigDecimal accuracy;
    private boolean isActive;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// 予測シナリオDTO
public class ForecastScenarioDto {
    private String id;
    private String name;
    private String description;
    private String modelId;
    private LocalDate startDate;
    private LocalDate endDate;
    private Map<String, Object> variables;
    private Map<String, Object> resultSummary;
    private boolean isBaseline;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// 予測結果DTO
public class ForecastResultDto {
    private String id;
    private String scenarioId;
    private String scenarioName;
    private String modelId;
    private String modelName;
    private LocalDate startDate;
    private LocalDate endDate;
    private Map<String, Object> resultData;
    private Map<String, Object> confidenceIntervals;
    private LocalDateTime generatedAt;
}

// 売上予測DTO
public class SalesForecastDto {
    private List<ForecastPeriodDto> periods;
    private BigDecimal totalForecastedSales;
    private Map<String, Object> confidenceIntervals;
    private Map<String, Object> influencingFactors;
    private LocalDateTime generatedAt;
}

// 利益予測DTO
public class ProfitForecastDto {
    private List<ForecastPeriodDto> periods;
    private BigDecimal totalForecastedProfit;
    private BigDecimal forecastedProfitMargin;
    private Map<String, Object> confidenceIntervals;
    private Map<String, Object> influencingFactors;
    private LocalDateTime generatedAt;
}

// 稼働率予測DTO
public class UtilizationForecastDto {
    private List<ForecastPeriodDto> periods;
    private BigDecimal averageForecastedUtilization;
    private Map<String, Object> departmentUtilization;
    private Map<String, Object> confidenceIntervals;
    private Map<String, Object> influencingFactors;
    private LocalDateTime generatedAt;
}

// 予測期間DTO
public class ForecastPeriodDto {
    private int year;
    private int month;
    private BigDecimal value;
    private BigDecimal lowerBound;
    private BigDecimal upperBound;
}
```

### 3.4 データソース関連データモデル

```java
// データソースDTO
public class DataSourceDto {
    private String id;
    private String name;
    private String description;
    private DataSourceType type;
    private boolean cacheEnabled;
    private Integer cacheTimeToLive;
    private boolean isBuiltIn;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// データソース詳細DTO
public class DataSourceDetailDto {
    private String id;
    private String name;
    private String description;
    private DataSourceType type;
    private Map<String, Object> connectionDetails;
    private String queryText;
    private Map<String, Object> parameters;
    private boolean cacheEnabled;
    private Integer cacheTimeToLive;
    private boolean isBuiltIn;
    private Map<String, Object> permissions;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// データソースメタデータDTO
public class DataSourceMetadataDto {
    private String dataSourceId;
    private List<DataFieldDto> fields;
    private List<String> tables;
    private List<ParameterDefinitionDto> parameters;
    private Map<String, Object> additionalMetadata;
}

// データフィールドDTO
public class DataFieldDto {
    private String name;
    private String dataType;
    private String description;
    private boolean isMeasure;
    private boolean isDimension;
    private String tableName;
    private Map<String, Object> properties;
}

// クエリ結果DTO
public class DataResultDto {
    private List<Map<String, Object>> data;
    private int totalRows;
    private int returnedRows;
    private boolean truncated;
    private List<DataFieldDto> columns;
    private Map<String, Object> metadata;
    private LocalDateTime generatedAt;
    private long executionTimeMs;
}
```

### 3.5 スケジュール関連データモデル

```java
// スケジュールDTO
public class ScheduleDto {
    private String id;
    private String name;
    private String description;
    private String reportId;
    private String reportName;
    private String cronExpression;
    private boolean isActive;
    private LocalDate startDate;
    private LocalDate endDate;
    private LocalDateTime nextRunDate;
    private LocalDateTime lastRunDate;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// スケジュール詳細DTO
public class ScheduleDetailDto {
    private String id;
    private String name;
    private String description;
    private String reportId;
    private String reportName;
    private String cronExpression;
    private Map<String, Object> parameters;
    private OutputFormat outputFormat;
    private boolean isActive;
    private LocalDate startDate;
    private LocalDate endDate;
    private LocalDateTime nextRunDate;
    private LocalDateTime lastRunDate;
    private Map<String, Object> recipients;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// スケジュール実行DTO
public class ScheduleExecutionDto {
    private String id;
    private String scheduleId;
    private String reportId;
    private LocalDateTime executionTime;
    private ExecutionStatus status;
    private String outputPath;
    private String errorMessage;
    private List<String> sentTo;
}

// スケジュール作成リクエスト
public class CreateScheduleRequest {
    private String reportId;
    private String name;
    private String description;
    private String cronExpression;
    private Map<String, Object> parameters;
    private OutputFormat outputFormat;
    private boolean isActive;
    private LocalDate startDate;
    private LocalDate endDate;
    private Map<String, Object> recipients;
}
```

## 4. 例外定義

レポーティングモジュールでは、以下の例外を定義します。

```java
// リソース未検出例外
public class ResourceNotFoundException extends BusinessException {
    public ResourceNotFoundException(String resourceType, String resourceId) {
        super("REPORT_ERR_001", resourceType + " not found with id: " + resourceId);
    }
}

// パラメータ不正例外
public class InvalidParameterException extends BusinessException {
    public InvalidParameterException(String message) {
        super("REPORT_ERR_002", message);
    }
}

// レポート生成例外
public class ReportGenerationException extends BusinessException {
    public ReportGenerationException(String message, Throwable cause) {
        super("REPORT_ERR_003", message, cause);
    }
}

// データソース接続例外
public class DataSourceConnectionException extends BusinessException {
    public DataSourceConnectionException(String message, Throwable cause) {
        super("REPORT_ERR_004", message, cause);
    }
}

// データソース実行例外
public class DataSourceExecutionException extends BusinessException {
    public DataSourceExecutionException(String message, Throwable cause) {
        super("REPORT_ERR_005", message, cause);
    }
}

// 予測モデル学習例外
public class ModelTrainingException extends BusinessException {
    public ModelTrainingException(String message, Throwable cause) {
        super("REPORT_ERR_006", message, cause);
    }
}

// 予測実行例外
public class ForecastExecutionException extends BusinessException {
    public ForecastExecutionException(String message, Throwable cause) {
        super("REPORT_ERR_007", message, cause);
    }
}

// シミュレーション実行例外
public class SimulationExecutionException extends BusinessException {
    public SimulationExecutionException(String message, Throwable cause) {
        super("REPORT_ERR_008", message, cause);
    }
}

// スケジュール実行例外
public class ScheduleExecutionException extends BusinessException {
    public ScheduleExecutionException(String message, Throwable cause) {
        super("REPORT_ERR_009", message, cause);
    }
}

// データ不足例外
public class InsufficientDataException extends BusinessException {
    public InsufficientDataException(String message) {
        super("REPORT_ERR_010", message);
    }
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件

- ダッシュボード表示は3秒以内にレスポンスを返却すること
- 標準レポート生成は10秒以内に完了すること
- 大量データを扱うレポートは非同期処理とし、キューイングシステムを使用すること
- データソースからのデータ取得はデフォルトで最大10000行に制限すること
- 予測モデルの学習と実行は非同期処理とすること
- レポートデータのキャッシュ機能を実装し、高頻度アクセスに対応すること

### 5.2 セキュリティ要件

- 全てのインターフェースは認証と認可を必須とすること
- レポートへのアクセスはロールベースのアクセス制御を実装すること
- 機密データ（粗利情報など）へのアクセスは特別な権限を要求すること
- データソース接続情報は暗号化して保存すること
- レポートデータの取得・生成・配信操作はログを記録すること
- セキュリティ上重要な操作（データソース追加など）は監査ログを記録すること

### 5.3 可用性要件

- 通常のレポート表示・生成機能は業務時間中の可用性99.5%以上を確保すること
- バッチ処理によるレポート生成は定時実行を担保し、失敗時は自動再実行機能を提供すること
- 長時間実行される処理（予測モデル学習など）は障害時にリカバリ可能な設計とすること
- メンテナンス時間帯でも重要なレポート参照機能は利用可能な設計とすること

### 5.4 拡張性要件

- 新しいレポート種別やデータソースの追加が容易な設計とすること
- 予測アルゴリズムの追加・変更が容易なプラグイン構造とすること
- 外部BIツールとの連携を想定したデータエクスポート機能を実装すること
- レポートテンプレートとビジュアル表現の拡張が容易な構造とすること