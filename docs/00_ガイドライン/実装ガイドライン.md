# 実装ガイドライン

このガイドラインは、SES管理システムの実装フェーズにおいて、開発者が従うべき標準とベストプラクティスを定義します。各機能の実装において、このガイドラインに従うことで、コードの品質、一貫性、保守性を確保します。

## 目次

1. [一般的なガイドライン](#1-一般的なガイドライン)
2. [コーディング規約](#2-コーディング規約)
3. [アーキテクチャとレイヤー](#3-アーキテクチャとレイヤー)
4. [セキュリティ](#4-セキュリティ)
5. [エラー処理](#5-エラー処理)
6. [ロギング](#6-ロギング)
7. [テスト](#7-テスト)
8. [パフォーマンス最適化](#8-パフォーマンス最適化)
9. [コードレビュー](#9-コードレビュー)
10. [実装チェックリスト](#10-実装チェックリスト)

## 1. 一般的なガイドライン

### 基本方針

- **可読性**: コードは、他の開発者が容易に理解できるよう明確に記述する
- **シンプルさ**: 複雑な実装よりもシンプルな実装を優先する
- **再利用性**: 共通処理は適切に抽象化し、重複を避ける
- **テスト可能性**: コードは単体テストが容易な構造にする

### ファイル管理

- ファイルエンコーディングは必ずUTF-8を使用する
- 1ファイルには1つの公開クラス（+内部クラス）のみを定義する
- ファイル名はクラス名と一致させる

### チェックリスト ✅

- [ ] すべてのファイルがUTF-8エンコーディングを使用しているか
- [ ] 1ファイルに1つの公開クラスのみを定義しているか
- [ ] ファイル名とクラス名が一致しているか
- [ ] 使用していないインポート文を削除しているか
- [ ] 未使用のコードやコメントアウトしたコードを削除しているか

## 2. コーディング規約

### 命名規則

- **パッケージ**: `jp.co.example.sesapp.[モジュール名].[レイヤー名]`
  - 例: `jp.co.example.sesapp.engineer.domain`
- **クラス**: 英語の名詞、パスカルケース（先頭大文字）
  - 例: `EngineerService`, `ProjectRepository`
- **インターフェース**: 英語の名詞または形容詞+名詞、パスカルケース
  - 例: `EngineerRepository`, `Searchable`
- **メソッド**: 英語の動詞または動詞+名詞、キャメルケース（先頭小文字）
  - 例: `findById()`, `createProject()`
- **変数**: 英語の名詞、キャメルケース
  - 例: `engineerList`, `projectId`
- **定数**: 英語の名詞、大文字とアンダースコア
  - 例: `MAX_RETRY_COUNT`, `DEFAULT_PAGE_SIZE`

#### 各レイヤーの命名規則

- **コントローラー**: `[機能名]Controller`
  - 例: `EngineerController`
- **サービス**: `[機能名]Service`
  - 例: `EngineerService`
- **リポジトリ**: `[機能名]Repository`
  - 例: `EngineerRepository`
- **エンティティ**: 単数形の名詞
  - 例: `Engineer`, `Project`
- **DTO**: 用途に応じて`[機能名][用途]Dto`
  - 例: `EngineerResponseDto`, `ProjectCreateRequestDto`

#### メソッド命名規則

- **取得系**: `findBy[条件]`, `getBy[条件]`
  - 例: `findById()`, `getByName()`
- **検索系**: `searchBy[条件]`
  - 例: `searchBySkill()`
- **作成系**: `create[エンティティ]`, `register[エンティティ]`
  - 例: `createEngineer()`, `registerProject()`
- **更新系**: `update[エンティティ]`
  - 例: `updateEngineer()`
- **削除系**: `delete[エンティティ]`, `remove[エンティティ]`
  - 例: `deleteEngineer()`, `removeProject()`
- **検証系**: `validate[対象]`, `check[条件]`, `is[条件]`
  - 例: `validateInput()`, `checkDuplicate()`, `isActive()`

### コードスタイル

- インデントはスペース4つを使用
- 行の最大長は120文字
- メソッドチェーンは適切に改行
- 括弧、空白、改行の一貫したスタイルを維持

### チェックリスト ✅

- [ ] 命名規則に沿った名前を使用しているか
- [ ] パッケージ構造が適切か
- [ ] コードスタイルが一貫しているか
- [ ] 命名が機能を適切に表現しているか
- [ ] 誤解を招く命名を避けているか

## 3. アーキテクチャとレイヤー

SES管理システムは、以下の多層アーキテクチャに基づいて実装します：

### レイヤー構造

1. **プレゼンテーション層**
   - Webコントローラー（@Controller, @RestController）
   - ビュー（Thymeleaf）
   - DTOクラス（リクエスト/レスポンス）

2. **アプリケーション層**
   - サービスクラス（@Service）
   - トランザクション境界
   - ユースケース実装

3. **ドメイン層**
   - エンティティ
   - 値オブジェクト
   - ドメインサービス
   - リポジトリインターフェース

4. **インフラストラクチャ層**
   - リポジトリ実装（@Repository）
   - データベースアクセス
   - 外部システム連携
   - キャッシュ、セキュリティなどの技術実装

### レイヤー間通信

- 上位レイヤーから下位レイヤーへの依存のみ許可
- 下位レイヤーから上位レイヤーへの参照は禁止
- 異なるモジュール間の通信は適切なインターフェースを介して行う

### レイヤー別の責務

- **コントローラー**: リクエスト/レスポンス処理、バリデーション、サービス呼び出し
- **サービス**: ビジネスロジック、トランザクション管理、複数リポジトリの連携
- **リポジトリ**: データアクセス、永続化、検索機能
- **エンティティ**: ビジネスデータと基本ルール

### 依存性注入

- コンストラクタインジェクションを優先する
- フィールドインジェクション（@Autowired）は使用しない
- 循環参照を避ける

### チェックリスト ✅

- [ ] レイヤーの責務分離が明確か
- [ ] 上位レイヤーから下位レイヤーへの依存のみになっているか
- [ ] コンストラクタインジェクションを使用しているか
- [ ] 循環参照が発生していないか
- [ ] モジュール間の依存関係が明確か

## 4. セキュリティ

### 認証・認可

- Spring Securityを使用した認証・認可の実装
- JWTを使用したステートレス認証
- メソッドレベルでの権限チェック（@PreAuthorize）
- ロールベースのアクセス制御（RBAC）

### 脆弱性対策

- SQLインジェクションの防止
  - パラメータ化クエリを使用する
  - 生のSQLを避ける
- クロスサイトスクリプティング（XSS）対策
  - 出力エスケープを徹底する
  - Content Security Policyの適用
- クロスサイトリクエストフォージェリ（CSRF）対策
  - CSRFトークンの使用
- セッションハイジャック対策
  - HTTPSの使用
  - セキュアCookieの設定

### 機密情報の取り扱い

- パスワードはハッシュ化して保存
- APIキーなどの秘密情報は環境変数または安全な設定から取得
- 個人情報は必要最低限のみを取得・保存
- ログに機密情報を出力しない

### チェックリスト ✅

- [ ] 認証・認可が適切に実装されているか
- [ ] SQLインジェクション対策がとられているか
- [ ] XSS対策がとられているか
- [ ] CSRF対策がとられているか
- [ ] パスワードが適切にハッシュ化されているか
- [ ] 機密情報がログに出力されていないか
- [ ] すべてのAPIエンドポイントが適切に保護されているか

## 5. エラー処理

### 例外の階層構造

- 次の階層構造に従った例外クラスの設計
  - `BaseException`: すべての例外の基底クラス
  - `BusinessException`: ビジネスルール違反
  - `SystemException`: システムエラー
  - 機能別の例外クラス

### 例外処理のルール

- チェック例外は使用しない（非チェック例外を使用）
- リソースの解放は try-with-resources で確実に行う
- 例外をキャッチする場合は、適切に処理するか、より具体的な例外に変換して再スローする
- 例外は最上位レイヤーでのみキャッチし、一貫したレスポンス形式に変換する

### グローバル例外ハンドラー

- `@ControllerAdvice`を使用したグローバル例外ハンドラの実装
- 例外の種類に応じた適切なHTTPステータスコードとレスポンスの設定
- エラーレスポンスの標準化

### チェックリスト ✅

- [ ] 例外の階層構造に従っているか
- [ ] リソースの解放が確実に行われているか
- [ ] 空のcatchブロックがないか
- [ ] エラーメッセージが明確で役立つ情報を提供しているか
- [ ] グローバル例外ハンドラが実装されているか
- [ ] ビジネス例外と技術例外が適切に区別されているか

## 6. ロギング

### ロギングの方針

- デバッグ情報は開発環境のみで出力
- 運用環境では警告とエラーレベルのログを中心に出力
- パフォーマンスに影響を与えるデバッグログは避ける
- 構造化ログを使用（JSON形式）

### ログレベルの使い分け

- **ERROR**: 影響が大きく、すぐに対応が必要な問題
- **WARN**: 潜在的な問題や警告
- **INFO**: システムの重要なイベント
- **DEBUG**: トラブルシューティング用の詳細情報
- **TRACE**: 詳細なデバッグ情報

### コンテキスト情報

- MDC（Mapped Diagnostic Context）を使用したコンテキスト情報の提供
  - リクエストID
  - セッションID
  - ユーザーID
  - 実行時間

### チェックリスト ✅

- [ ] 適切なログレベルを使用しているか
- [ ] 機密情報がログに出力されていないか
- [ ] MDCを使用したコンテキスト情報が提供されているか
- [ ] ログメッセージが明確で役立つ情報を提供しているか
- [ ] 例外スタックトレースが適切に記録されているか

## 7. テスト

### テスト種別

- **単体テスト**: クラスやメソッドの個々の機能
- **統合テスト**: 複数のコンポーネントの連携
- **E2Eテスト**: エンドツーエンドの機能

### テスト実装の方針

- **単体テスト**
  - JUnit 5 + Mockitoを使用
  - モックとスタブを活用して依存関係を分離
  - 境界値や異常系のテストケースを含める

- **統合テスト**
  - Spring Bootのテスト機能を活用
  - TestContainersを使用したDBテスト
  - インメモリDBではなく実際のDBMSを使用

- **E2Eテスト**
  - Playwrightを使用したブラウザテスト
  - 主要なユーザーストーリーに焦点を当てる

### テストカバレッジ

- 単体テストでは最低80%のコードカバレッジを目標
- 重要なビジネスロジックは100%のカバレッジを目指す
- 単純なGetter/Setterはテストカバレッジから除外可能

### テストコードの品質

- テストコードも本番コードと同様に品質を維持
- テストメソッド名は「何をテストするか」を明確に記述
- Arrange-Act-Assert（AAA）パターンに従う
- 各テストは独立して実行可能にする

### チェックリスト ✅

- [ ] 単体テストは独立して実行可能か
- [ ] モックとスタブを適切に使用しているか
- [ ] 境界値や異常系のテストケースが含まれているか
- [ ] AAAパターンに従っているか
- [ ] テストメソッド名が明確にテスト内容を表しているか
- [ ] テストカバレッジの目標を達成しているか

## 8. パフォーマンス最適化

### データベースアクセス

- N+1問題を避ける（必要なデータは一括で取得）
- インデックスを適切に使用
- ページネーションを実装（大量データの取得を避ける）
- トランザクションの範囲を最小限に
- PostgreSQLのUUID型を使用する場合は明示的にキャストする
  ```java
  // 正しい実装
  String sql = "SELECT * FROM schema.table WHERE id = CAST(? AS UUID)";
  jdbcTemplate.queryForObject(sql, rowMapper, uuid.toString());
  
  // 誤った実装
  String sql = "SELECT * FROM schema.table WHERE id = ?";
  jdbcTemplate.queryForObject(sql, rowMapper, uuid.toString()); // PostgreSQLで型エラー発生
  ```

### キャッシュ

- 参照頻度が高く、更新頻度が低いデータはキャッシュ
- Spring Cacheアノテーションを使用
- キャッシュの有効期限を適切に設定

### クエリ最適化

- 必要な列のみを選択
- 結合は必要最小限に
- 複雑なクエリはネイティブSQLの使用を検討

### チェックリスト ✅

- [ ] N+1問題が発生していないか
- [ ] 大量データの取得を避け、ページネーションを実装しているか
- [ ] キャッシュを適切に使用しているか
- [ ] トランザクションの範囲が適切か
- [ ] クエリが最適化されているか

## 9. コードレビュー

### レビュー項目

- 機能要件の充足
- 設計ドキュメントとの整合性
- コーディング規約への準拠
- テストの適切性
- セキュリティ上の問題
- パフォーマンスへの影響

### レビュープロセス

1. PRの作成前に自己レビューを実施
2. 小さな単位でPRを作成
3. レビュアーは少なくとも1名以上
4. レビューコメントに対して適切に対応
5. すべての指摘が解決されたらマージ

### チェックリスト ✅

- [ ] 自己レビューを実施したか
- [ ] PRの粒度が適切か
- [ ] すべてのレビューコメントに対応したか
- [ ] コーディング規約に準拠しているか
- [ ] 機能要件を満たしているか

## 10. 実装チェックリスト

以下の総合チェックリストを使用して、実装の完了を確認します。

### 一般

- [ ] コードはコーディング規約に従っているか
- [ ] 未使用のインポートやコードが削除されているか
- [ ] JavaDocコメントが必要な箇所に記載されているか
- [ ] すべてのファイルがUTF-8エンコーディングを使用しているか

### 機能実装

- [ ] 設計ドキュメントの要件をすべて満たしているか
- [ ] ビジネスロジックが正しく実装されているか
- [ ] UIが要件を満たし、使いやすいか
- [ ] エラー処理が適切に実装されているか

### テスト

- [ ] 単体テストが実装され、パスするか
- [ ] 統合テストが実装され、パスするか
- [ ] E2Eテストが必要に応じて実装されているか
- [ ] テストカバレッジが目標を達成しているか

### セキュリティ

- [ ] 認証・認可が適切に実装されているか
- [ ] 入力値のバリデーションが実装されているか
- [ ] SQLインジェクション、XSS、CSRFなどの対策がとられているか
- [ ] 機密情報が適切に保護されているか

### パフォーマンス

- [ ] N+1問題が解消されているか
- [ ] 適切なキャッシュが実装されているか
- [ ] 大量データの処理が最適化されているか
- [ ] インデックスが適切に使用されているか

### 品質

- [ ] 静的解析ツールの警告がないか
- [ ] すべてのPRレビューコメントが解決されているか
- [ ] 技術的負債が最小限に抑えられているか
- [ ] ドキュメントが更新されているか

このガイドラインを遵守することで、SES管理システムの実装における品質と一貫性を確保します。実装前に関連するチェックリストを確認し、実装後に全体のチェックリストを使用して検証することを推奨します。