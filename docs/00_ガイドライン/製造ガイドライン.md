# SES業務システム 製造ガイドライン

> **重要**: コミットおよびプッシュは、必ず明示的な指示があるまで実行しないでください。  
> 担当者からの具体的な許可なく変更をリポジトリに反映することは厳禁です。

## 1. 概要

本文書は、SES業務システムの製造（実装）フェーズにおける開発ガイドラインを記載しています。このガイドラインは、高品質なコードの作成と効率的な開発プロセスを実現するために、開発者が遵守すべき原則と実践を定めています。

## 2. 製造フェーズの目的

- 基本設計・詳細設計に基づいた正確な実装を行う
- 保守性・拡張性の高いコードを作成する
- コーディング規約に準拠した一貫性のあるコードを書く
- 適切なテストを実施し、品質を確保する
- スケジュール通りに開発を進める

## 3. 基本設計書の参照

**最重要**: 製造作業は必ず基本設計書および詳細設計書を参照しながら進めてください。

### 3.1 設計書参照の原則

- 実装に着手する前に、該当機能の基本設計書と詳細設計書を熟読し、内容を十分に理解すること
- 設計書に記載されている仕様・制約条件・非機能要件を遵守すること
- 設計と異なる実装が必要な場合は、必ず担当者に相談し、承認を得ること
- 設計書の不明点・曖昧な点・矛盾点を発見した場合は、実装を進める前に担当者に確認すること

### 3.2 主要設計書の場所

| 設計書タイプ | ディレクトリパス |
|------------|----------------|
| 基本設計 | `/docs/02_基本設計/` |
| DB設計 | `/docs/02_基本設計/DB設計/` |
| UI設計 | `/docs/02_基本設計/UI設計/` |
| API設計 | `/docs/02_基本設計/IF設計/REST_API/` |
| 詳細設計 | `/docs/03_詳細設計/` |

### 3.3 設計書変更時の対応

- 設計書に変更があった場合は、速やかに実装への影響を確認する
- 影響範囲を特定し、必要な修正を計画的に実施する
- 設計変更による仕様変更は、コードコメントに記録する

## 4. 開発環境

### 4.1 必要なソフトウェア

- JDK 21
- Docker & Docker Compose
- Gradle
- IDE（推奨: IntelliJ IDEA または Eclipse STS）
- Git

### 4.2 環境構築手順

1. Gitリポジトリをクローン
   ```bash
   git clone https://github.com/yourusername/ses_mgr.git
   cd ses_mgr
   ```

2. Docker環境の起動
   ```bash
   docker-compose up -d
   ```

3. IDE設定
   - プロジェクトをGradle projectとして開く
   - JDK 17を設定
   - コード整形ルールを適用（.editorconfig）

## 5. コーディング規約

### 5.1 Java コーディング規約

- Google Java Style Guide に準拠
- クラス名はパスカルケース（例: `CustomerService`）
- メソッド名・変数名はキャメルケース（例: `findByCustomerId`）
- 定数は大文字スネークケース（例: `MAX_RETRY_COUNT`）
- パッケージ名は小文字（例: `com.ses_mgr.project`）

### 5.2 命名規則

- クラス名は名詞または名詞句
- メソッド名は動詞または動詞句
- ブール値を返すメソッドは `is`, `has`, `can` などのプレフィックスを使用
- インターフェース名は機能を表す形容詞や名詞（例: `Serializable`, `Repository`）
- エンティティクラスはドメインオブジェクトの名前（例: `Project`, `Engineer`）
- DTOクラスは接尾辞として `Dto` を使用（例: `ProjectDto`）

### 5.3 コメント規則

- Javadocコメントは全てのパブリッククラス・メソッドに記述
- 複雑なロジックにはインラインコメントを追加
- TODO コメントには担当者と期限を明記
- コメントは「何を」ではなく「なぜ」を説明する

### 5.4 パッケージ構造

```
com.ses_mgr
  ├── common        // 共通機能
  │   ├── controller
  │   ├── dto
  │   ├── exception
  │   ├── model
  │   ├── repository
  │   └── service
  ├── config        // 設定クラス
  ├── project       // 案件管理機能
  │   ├── controller
  │   ├── dto
  │   ├── model
  │   ├── repository
  │   └── service
  ├── engineer      // 技術者管理機能（以下同様）
  ├── matching      // マッチング機能
  ├── contract      // 契約管理機能
  ├── timesheet     // 勤怠工数管理機能
  ├── billing       // 請求支払管理機能
  └── reporting     // レポーティング機能
```

## 6. Spring Bootでの実装ガイドライン

### 6.1 レイヤード構造の実装

- **Controller層**
  - REST APIエンドポイントの実装
  - リクエスト検証
  - DTO/エンティティ変換
  - 例外ハンドリング

- **Service層**
  - ビジネスロジックの実装
  - トランザクション管理
  - 認可チェック

- **Repository層**
  - データアクセス処理
  - Spring Data JPAの活用

### 6.2 依存性注入

- `@Autowired`よりコンストラクタインジェクションを優先
- コンポーネントは適切なスコープを使用（`@Component`, `@Service`, `@Repository`, `@Controller`）
- テスト容易性のためにインターフェースを活用

### 6.3 設定管理

- 環境ごとの設定は`application-{env}.properties`で管理
- 機密情報（パスワードなど）はハードコーディングしない
- 設定変数は定数クラスでタイプセーフに管理

### 6.4 循環依存の回避

- Spring Beanの循環依存を避ける設計を心がける
- 循環依存が避けられない場合は以下の対策を実施:
  - `@Lazy`アノテーションを使用して遅延初期化する
  - コンポーネントをFactoryパターンで作成する
  - フィルターなどはコンポーネントではなくBeanメソッドで定義する
- 特にセキュリティ関連コンポーネント（`JwtAuthenticationFilter`, `JwtTokenProvider`など）での循環依存に注意

### 6.5 エラー処理

- 例外クラス階層を適切に設計
- グローバル例外ハンドラ（`@ControllerAdvice`）を活用
- APIレスポンスのエラーフォーマットを統一

## 7. データベースアクセス

### 7.1 Spring Data JPAの使用方針

- エンティティクラスはJPAアノテーションで適切にマッピング
- リポジトリインターフェースはSpring Data JPAを活用
- 複雑なクエリは`@Query`アノテーションで定義
- 大量データ処理ではページネーションを活用

### 7.2 トランザクション管理

- サービスメソッドに`@Transactional`アノテーションを適用
- 読み取り専用操作には`@Transactional(readOnly = true)`を使用
- トランザクションの伝播属性を適切に設定
- 長時間トランザクションを避ける

### 7.3 パフォーマンス最適化

- N+1問題に注意し、適切にJOINやFetch戦略を設定
- 大きなデータセットは遅延ロードやストリーミング処理を検討
- 頻繁にアクセスされるデータにはキャッシュを検討

## 8. セキュリティ実装

### 8.1 認証・認可

- Spring Securityを使用した認証・認可の実装
- JWT認証の正確な実装
- ロールベースアクセス制御（RBAC）の実装
- CSRFトークンの適切な実装

### 8.2 セキュアコーディング

- 入力値の検証と無害化
- SQLインジェクション対策（パラメータ化クエリの使用）
- XSS対策
- パスワードは必ずハッシュ化して保存

## 9. テストと品質保証

### 9.1 単体テスト

- JUnitでの単体テスト作成
- Mockitoを使用したモックの活用
- 各サービスクラスに対してテストケースを作成
- テストカバレッジ目標：80%以上
- リポジトリテストには `@DataJpaTest` アノテーションを使用
- サービステストでは `@ExtendWith(MockitoExtension.class)` を使用
- モックの設定では `lenient()` を適切に使用して不要な例外を回避

#### 9.1.1 レイヤー別テスト戦略

- **Repository層テスト**:
  - `@DataJpaTest` を使用して実際のJPAコンテキストをテスト
  - H2インメモリデータベースで高速テスト
  - データベース操作のみをテスト（ビジネスロジックなし）

- **Service層テスト**:
  - 依存するリポジトリはすべてモック化
  - 副作用のないユニットテストを作成
  - 複雑なロジックに対して複数のテストケースを作成
  - Mockitoの `when` と `verify` を活用

- **Controller層テスト**:
  - MockMvc を使用したコントローラーテスト
  - サービス層はモック化
  - リクエスト/レスポンスのシリアライズ/デシリアライズをテスト
  - エラーケースを含む多様なシナリオをテスト

### 9.2 統合テスト

- Spring Boot Testを使用した統合テスト
- テスト用データベース（H2など）の活用
- APIエンドポイントのテスト
- 循環依存がある場合は、簡略化したコンポーネントを使用したテストも検討
- `@SpringBootTest` の代わりに `@WebMvcTest` を使用して軽量なテストを行う

### 9.3 静的コード解析

- CheckstyleによるJavaコーディング規約チェック
- FindBugsによるバグパターン検出
- PMDによる追加的な静的解析

## 10. バージョン管理

### 10.1 Gitの使用方針

- 作業ブランチの命名規則：`feature/機能名`
- コミットメッセージの形式：
  ```
  [機能名] 変更内容の概要

  - 詳細な変更点1
  - 詳細な変更点2

  関連チケット：#チケット番号
  ```
- コミット前に必ずローカルでビルドとテストを実行すること
- コミットとプッシュは明示的な許可が出るまで行わないこと

### 10.2 コードレビュー

- プルリクエスト前に自己レビューを実施
- レビュー担当者の指摘には迅速に対応
- マージ前に必ずレビュー承認を得ること

## 11. ビルドとデプロイ

### 11.1 ビルドプロセス

- Gradleを使用したビルド
- テスト・コード解析を含むビルド
- 環境ごとのプロファイル設定

### 11.2 Dockerコンテナ化

- マルチステージビルドの活用
- 最小限のベースイメージの使用
- 適切なヘルスチェックの設定

## 12. トラブルシューティングとサポート

### 12.1 一般的な問題と解決策

- よくある開発環境の問題とその解決方法
- ビルド失敗時のチェックポイント
- パフォーマンス問題のデバッグ方法

### 12.2 サポート・問い合わせ

- 技術的な質問の相談先
- バグ報告プロセス
- ドキュメント・ガイドラインの改善提案プロセス

## 13. チェックリスト

開発作業完了時には下記のチェックリストを確認してください：

- [ ] 基本設計書・詳細設計書に沿った実装になっているか
- [ ] コーディング規約に従っているか
- [ ] 適切なコメントは記述されているか
- [ ] 単体テストは実装され、成功しているか
- [ ] 静的コード解析でエラーや警告が出ていないか
- [ ] セキュリティ上の問題はないか
- [ ] パフォーマンス要件を満たしているか
- [ ] ログ出力は適切か
- [ ] エラー処理は適切に実装されているか
- [ ] ビルドが正常に成功するか

## 14. 実装前確認項目リスト

以下は、各コンポーネントの実装前に確認すべき重要なポイントです。実装に着手する前に必ずこれらの項目を確認してください。

### 14.1 要件定義の確認

- [ ] 対象機能の目的と要件を理解しているか
- [ ] 非機能要件（性能・可用性・セキュリティ）を確認したか
- [ ] システム全体における当該機能の位置づけを理解しているか
- [ ] ステークホルダーの期待と利用シナリオを把握しているか
- [ ] システムの技術スタック（Java Spring Boot、PostgreSQL等）を確認したか

### 14.2 システムアーキテクチャの確認

- [ ] マイクロサービスアーキテクチャの構成を理解しているか
- [ ] 担当モジュールと他モジュールとの連携方法を確認したか
- [ ] APIゲートウェイを通した通信フローを理解しているか
- [ ] 認証・認可の方式（JWT）と実装方法を確認したか
- [ ] リソースの命名規則とRESTful設計に準拠しているか

### 14.3 DB設計の確認

- [ ] テーブル定義（物理名・論理名・主キー・外部キー）を確認したか
- [ ] データ型と制約（NOT NULL、一意制約等）を確認したか
- [ ] インデックス設計を確認し、パフォーマンス要件を満たせるか
- [ ] 正規化レベルと性能のバランスを考慮しているか
- [ ] PostgreSQL固有機能（シーケンス、スキーマ等）の使用方針を確認したか
- [ ] マイグレーション方法（Liquibase/Flyway）を理解しているか

### 14.4 共通機能の確認

- [ ] 認証・認可機能の実装方法を理解しているか
- [ ] エラー処理・例外管理の標準パターンを確認したか
- [ ] エラーコード体系（E-AABCC）と使用方法を理解しているか
- [ ] トランザクション管理の方針と属性を確認したか
- [ ] ファイル管理機能の使用方法を理解しているか
- [ ] コード値管理機能の使用方法を理解しているか
- [ ] 通知機能の連携方法を確認したか
- [ ] 検索機能のインターフェースを確認したか
- [ ] ロギング方針と実装方法を理解しているか

### 14.5 エラー処理・例外管理の確認

- [ ] システム定義の例外階層を理解しているか
- [ ] グローバル例外ハンドラの実装方法を確認したか
- [ ] 業務例外と技術例外の区別と処理方法を理解しているか
- [ ] エラーレスポンスの標準フォーマットを確認したか
- [ ] エラーログの記録方針と実装方法を理解しているか
- [ ] 多言語対応のエラーメッセージ管理を理解しているか

### 14.6 トランザクション管理の確認

- [ ] トランザクション境界をサービスレイヤーに設定する方針を理解しているか
- [ ] トランザクション伝播属性（REQUIRED、REQUIRES_NEW等）の適切な使用方法を確認したか
- [ ] 読み取り専用トランザクションの最適化方法を理解しているか
- [ ] 分散トランザクション管理（Sagaパターン）の適用方法を確認したか
- [ ] 長時間トランザクションを避ける設計になっているか
- [ ] トランザクション失敗時のリカバリ戦略を確認したか

### 14.7 セキュリティ実装の確認

- [ ] Spring Securityの設定方法を理解しているか
- [ ] JWT認証の実装詳細を確認したか
- [ ] CSRF対策の実装方法を理解しているか
- [ ] セキュアコーディング（入力検証、SQLインジェクション対策、XSS対策）のガイドラインを確認したか
- [ ] センシティブデータの暗号化方針を理解しているか
- [ ] セキュリティログの記録方針を確認したか

### 14.8 テスト計画の確認

- [ ] 単体テストの範囲と方法を確認したか
- [ ] 統合テストのアプローチを理解しているか
- [ ] テストデータの準備方法を確認したか
- [ ] モックとスタブの利用方針を理解しているか
- [ ] テストカバレッジの目標（80%以上）を認識しているか
- [ ] テスト自動化の方針を確認したか
- [ ] レイヤー別テスト戦略（リポジトリ、サービス、コントローラ）を理解しているか
- [ ] 循環依存を含むコンポーネントのテスト戦略を確認したか
- [ ] テスト環境（H2データベース等）の設定方法を理解しているか
- [ ] テスト用の簡略化コンポーネント作成方針を確認したか
- [ ] 適切なテストアノテーション（`@DataJpaTest`, `@ExtendWith(MockitoExtension.class)`, `@WebMvcTest`等）の使用方法を理解しているか

### 14.9 パフォーマンス要件の確認

- [ ] 応答時間要件（平均応答時間 < 2 秒）を確認したか
- [ ] 同時ユーザー数（500）を考慮した設計になっているか
- [ ] N+1問題の回避策を理解しているか
- [ ] 大量データ処理の最適化方法を確認したか
- [ ] キャッシュ戦略を理解し、適用方法を確認したか
- [ ] 処理量増加に対するスケールアウト戦略を理解しているか

### 14.10 ドキュメント関連の確認

- [ ] クラス・メソッドのJavadocコメント規約を確認したか
- [ ] API仕様書（Swagger/OpenAPI）の記述方法を理解しているか
- [ ] コードの変更履歴管理とコミットメッセージの記述方法を確認したか
- [ ] 実装完了後の設計書へのフィードバック方法を理解しているか
- [ ] トラブルシューティングのためのドキュメント準備方法を確認したか

## 15. 注意事項

- コードの複製（コピー＆ペースト）は必要最小限に抑える
- 第三者ライブラリの使用は事前承認が必要
- 潜在的な問題は早期に報告する
- 障害発生時は迅速に担当者に報告する
- 作業の進捗状況は定期的に共有する

---

このガイドラインは随時更新される可能性があります。最新版を常に確認してください。

最終更新日: 2025年5月7日