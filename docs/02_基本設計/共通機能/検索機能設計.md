# SES業務システム 検索機能 基本設計書

## 1. はじめに

本書は、SES業務システムにおける検索機能の基本設計を定義したものである。
システム全体で利用される横断的な検索機能および各モジュール内での検索機能の実装方針について記述する。

## 2. 機能概要

検索機能は、SES業務システム内の様々なデータ（案件情報、技術者情報、契約情報など）を効率的に検索し、
必要な情報に素早くアクセスできるようにする基盤的な共通機能である。キーワード検索やフィルタリング検索などを
提供し、ユーザーの業務効率向上に寄与する。

## 3. 検索機能設計

### 3.1 機能構成

検索機能は以下のサブ機能で構成される：

1. **グローバル検索**: システム全体を対象とした横断的な検索
2. **モジュール内検索**: 各モジュール（案件管理、技術者管理など）内での詳細検索
3. **検索インデックス管理**: 検索用インデックスの構築・更新
4. **検索結果処理**: 検索結果の集約、ソート、ページング
5. **検索履歴管理**: ユーザーの検索履歴の保存・利用

### 3.2 グローバル検索機能

#### 3.2.1 検索対象

グローバル検索では以下の主要なエンティティを検索対象とする：

| エンティティ | 検索対象項目 | 検索優先度 |
|------------|------------|------------|
| 案件 | 案件名、案件概要、スキル要件、勤務地 | 高 |
| 技術者 | 氏名、スキル、経歴、自己PR | 高 |
| 契約 | 契約名、契約概要、契約番号 | 中 |
| 請求 | 請求先、請求番号、備考 | 中 |
| ファイル | ファイル名、説明文 | 低 |
| マスタデータ | 各種マスタデータの名称、説明 | 低 |

#### 3.2.2 検索方式

グローバル検索では以下の検索方式を提供する：

1. **シンプル検索**:
   - 単一のテキストボックスによるキーワード検索
   - すべての検索対象フィールドから一致するものを検索
   - 部分一致、前方一致、後方一致に対応
   - 日本語のかな・カナ・漢字の表記揺れに対応

2. **検索結果のカテゴリ表示**:
   - 検索結果をエンティティ種別ごとにグループ化
   - 各エンティティの上位5件を表示し、「もっと見る」リンクで全件表示

#### 3.2.3 UI設計

グローバル検索のUIは以下の構成を持つ：

* **検索ボックス（ヘッダー部分に常に表示）**:
  - キーワード入力フィールド
  - 検索ボタン
  - 検索中のローディングインジケータ

* **検索結果ドロップダウン**:
  - エンティティ種別ごとのタブ
  - 検索結果項目（タイトル、簡易説明、更新日時）
  - 各カテゴリの「もっと見る」リンク
  - 該当件数なしの場合のメッセージ表示

* **詳細検索結果画面**:
  - エンティティ種別のフィルター
  - 検索結果の詳細表示（表形式）
  - ソート機能（関連度、更新日時、名称など）
  - ページネーション

### 3.3 モジュール内検索機能

#### 3.3.1 共通検索コンポーネント

各モジュールで共通して利用できる検索コンポーネントを提供する：

* **検索条件部**:
  - テキストフィールド（キーワード検索用）
  - セレクトボックス（選択肢からの絞り込み用）
  - 日付選択（期間指定用）
  - チェックボックス、ラジオボタン（状態指定用）
  - 検索ボタン、クリアボタン、詳細検索トグル

* **検索結果部**:
  - 一覧表示（テーブル形式）
  - ソート機能（各カラムヘッダクリックでソート）
  - ページネーション
  - CSV/Excel出力ボタン
  - 検索結果件数表示

#### 3.3.2 主要モジュールの検索機能

主要なモジュールごとの検索機能仕様を以下に示す：

##### 3.3.2.1 案件検索

| 検索条件 | 型 | 検索方式 | 説明 |
|---------|-----|---------|------|
| 案件ID | 文字列 | 完全一致 | 案件の一意識別子 |
| 案件名 | 文字列 | 部分一致 | 案件の名称 |
| 案件種別 | 選択式 | 完全一致 | 案件の種別（新規開発、保守運用等） |
| スキル要件 | 複数選択 | OR条件 | 必要なスキル要件 |
| 単価範囲 | 数値範囲 | 範囲検索 | 単価の下限・上限 |
| 勤務地 | 複数選択 | OR条件 | 勤務地域 |
| 開始日期間 | 日付範囲 | 範囲検索 | 案件開始日の期間 |
| 終了日期間 | 日付範囲 | 範囲検索 | 案件終了日の期間 |
| 案件ステータス | 複数選択 | OR条件 | 案件の状態（募集中、クローズド等） |
| 顧客名 | 文字列 | 部分一致 | 顧客企業名 |

##### 3.3.2.2 技術者検索

| 検索条件 | 型 | 検索方式 | 説明 |
|---------|-----|---------|------|
| 技術者ID | 文字列 | 完全一致 | 技術者の一意識別子 |
| 氏名 | 文字列 | 部分一致 | 技術者の氏名 |
| スキル | 複数選択 | OR/AND条件 | 保有スキル |
| 経験年数 | 数値範囲 | 範囲検索 | 経験年数の下限・上限 |
| 単価範囲 | 数値範囲 | 範囲検索 | 希望単価の下限・上限 |
| 稼働可能日 | 日付 | 以降/以前 | 稼働開始可能日 |
| 勤務地希望 | 複数選択 | OR条件 | 希望勤務地域 |
| 稼働状態 | 選択式 | 完全一致 | 稼働状態（稼働中、待機中等） |
| 雇用形態 | 複数選択 | OR条件 | 雇用形態（正社員、契約社員等） |

##### 3.3.2.3 契約検索

| 検索条件 | 型 | 検索方式 | 説明 |
|---------|-----|---------|------|
| 契約ID | 文字列 | 完全一致 | 契約の一意識別子 |
| 契約名 | 文字列 | 部分一致 | 契約の名称 |
| 契約種別 | 選択式 | 完全一致 | 契約の種別（準委任、請負等） |
| 契約状態 | 複数選択 | OR条件 | 契約の状態（交渉中、締結済等） |
| 契約期間 | 日付範囲 | 範囲検索 | 契約期間の範囲 |
| 顧客名 | 文字列 | 部分一致 | 顧客企業名 |
| 技術者名 | 文字列 | 部分一致 | 契約対象技術者名 |
| 更新日範囲 | 日付範囲 | 範囲検索 | 契約更新日の範囲 |

#### 3.3.3 高度な検索機能

各モジュールで利用可能な高度な検索機能を提供する：

1. **保存済み検索条件**:
   - 頻繁に使用する検索条件の保存・呼び出し
   - 保存済み検索条件の編集・削除
   - デフォルト検索条件の設定

2. **検索条件テンプレート**:
   - 管理者が作成した検索条件テンプレートの提供
   - 特定の業務シーンに最適化された検索条件セット

3. **組み合わせ検索**:
   - 複数の検索条件を論理演算子（AND/OR）で組み合わせ
   - カッコを使った優先順位の指定
   - 除外条件（NOT）の指定

4. **類似検索**:
   - 特定のエンティティと類似したエンティティの検索
   - 例：類似スキルセットを持つ技術者の検索
   - 例：類似要件を持つ案件の検索

### 3.4 検索エンジン設計

#### 3.4.1 検索アーキテクチャ

検索機能のアーキテクチャは以下の構成とする：

1. **フロントエンド**:
   - 検索UIコンポーネント
   - 検索クエリビルダー
   - 検索結果表示コンポーネント

2. **バックエンド**:
   - 検索APIコントローラ
   - 検索サービス
   - クエリ変換・実行エンジン
   - 検索結果プロセッサ

3. **検索インフラ**:
   - 全文検索エンジン（Elasticsearch）
   - インデックス管理
   - データ同期メカニズム

#### 3.4.2 インデックス管理

検索インデックスの管理方法を以下に定義する：

1. **インデックス構造**:
   - エンティティごとのインデックス定義
   - フィールドマッピングとデータ型
   - 分析器と言語設定（日本語形態素解析）

2. **データ同期**:
   - データベースの変更検知（CDC）
   - 即時インデックス更新（リアルタイム性の高いデータ）
   - バッチインデックス更新（リアルタイム性の低いデータ）
   - 再インデックス処理

3. **インデックス最適化**:
   - インデックスのシャーディングと複製
   - 定期的なインデックスメンテナンス
   - キャッシュ戦略

#### 3.4.3 検索クエリ最適化

効率的な検索のための最適化戦略：

1. **クエリ書き換え**:
   - 同義語展開
   - スペルミス修正
   - 単語の正規化

2. **検索結果ランキング**:
   - 関連度スコアリング
   - ブースト係数の適用
   - ユーザー行動に基づくランキング調整

3. **パフォーマンス最適化**:
   - クエリキャッシュ
   - フィルタキャッシュ
   - 分散検索と集約

### 3.5 検索履歴管理

#### 3.5.1 履歴管理モデル

検索履歴は以下のモデルで管理する：

| 属性 | 型 | 説明 |
|------|------|------|
| id | UUID | 履歴の一意識別子 |
| userId | UUID | 実行ユーザーID |
| searchType | Enum | 検索タイプ（グローバル、モジュール内等） |
| moduleType | Enum | モジュール種別（案件、技術者等） |
| searchKeyword | String | 検索キーワード |
| searchParams | JSON | 詳細検索条件（JSON形式） |
| resultCount | Integer | 検索結果件数 |
| executedAt | DateTime | 実行日時 |
| isSaved | Boolean | 保存済みフラグ |
| savedName | String | 保存時の名称 |

#### 3.5.2 履歴管理機能

検索履歴管理では以下の機能を提供する：

1. **最近の検索履歴**:
   - 最新10件の検索履歴の表示
   - 検索履歴からの検索条件再利用
   - 検索履歴のクリア

2. **保存済み検索**:
   - 検索条件の永続的な保存
   - 保存済み検索の編集・削除
   - 保存済み検索の共有（チーム内）

3. **推奨検索**:
   - 過去の検索パターンに基づく推奨検索の提示
   - よく使われる検索条件の提示
   - ユーザーの役割に応じた検索条件の提示

## 4. UI設計

### 4.1 グローバル検索UI

グローバル検索のUIは以下の構成を持つ：

* **ヘッダー検索ボックス**:
  - 常に表示されるシンプルな検索フィールド
  - 検索アイコン
  - 入力時の候補表示（オートコンプリート）

* **検索結果ドロップダウン**:
  - エンティティ種別ごとのタブ（案件、技術者、契約など）
  - 各タブ内に最大5件の検索結果サマリを表示
  - 「すべての結果を表示」リンク

* **詳細検索結果画面（検索結果ページ）**:
  - 検索キーワードと条件の表示
  - フィルターパネル（左側）
  - 検索結果リスト（中央）
  - ソートオプション
  - ページネーションコントロール
  - 「検索条件を保存」ボタン
  - エクスポートオプション

### 4.2 モジュール内検索UI

モジュール内の検索UIは以下の構成を持つ：

* **標準検索フォーム**:
  - モジュールのメイン画面上部に配置
  - 主要な検索条件フィールド（3〜5項目）
  - 「詳細検索」トグルボタン
  - 検索ボタン、クリアボタン

* **詳細検索パネル**:
  - 展開可能なパネル形式
  - すべての検索条件を表示
  - 条件をグループ化したタブまたはアコーディオン
  - 「保存済み検索」ドロップダウン
  - 「この検索を保存」ボタン

* **検索結果部**:
  - テーブル形式の結果一覧
  - ページごとの表示件数選択
  - ページネーションコントロール
  - 列ヘッダーによるソート機能
  - 行アクション（詳細表示、編集など）
  - 検索結果サマリ（「〇〇件中xx〜yyを表示」）

### 4.3 検索履歴・保存検索UI

検索履歴と保存済み検索のUIは以下の構成を持つ：

* **検索履歴ドロップダウン**:
  - 検索ボックス横のアイコンから表示
  - 最近の検索履歴リスト（最大10件）
  - 各履歴項目に「再実行」「保存」アクション
  - 「すべての履歴を表示」リンク

* **保存済み検索管理画面**:
  - 保存済み検索の一覧表示
  - 名前、モジュール、作成日時、最終使用日時を表示
  - 「編集」「削除」「共有」アクション
  - 「新規保存」ボタン
  - フォルダによる整理機能

## 5. API設計

### 5.1 グローバル検索API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/search | GET | グローバル検索の実行 |
| /api/v1/search/suggest | GET | 検索候補のサジェスト取得 |
| /api/v1/search/{entityType} | GET | 特定エンティティタイプに限定した検索 |

#### リクエストパラメータ例（グローバル検索）

```json
{
  "query": "Java 東京",
  "entityTypes": ["project", "engineer"],
  "pageSize": 10,
  "pageNumber": 0,
  "sortBy": "relevance", // relevance, createdAt, updatedAt
  "sortDirection": "desc"
}
```

#### レスポンス例（グローバル検索）

```json
{
  "totalResults": 45,
  "pageSize": 10,
  "pageNumber": 0,
  "totalPages": 5,
  "aggregations": {
    "byEntityType": {
      "project": 25,
      "engineer": 20
    }
  },
  "results": [
    {
      "entityType": "project",
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "Javaエンジニア募集（東京都）",
      "summary": "金融系システムの開発案件。Javaでのバックエンド開発経験必須。",
      "highlightedFields": {
        "title": "...<em>Java</em>エンジニア募集（<em>東京</em>都）...",
        "summary": "...金融系システムの開発案件。<em>Java</em>でのバックエンド開発経験必須..."
      },
      "url": "/projects/550e8400-e29b-41d4-a716-446655440000",
      "updatedAt": "2025-04-01T09:30:00Z",
      "score": 0.95
    },
    // ...他の検索結果
  ]
}
```

### 5.2 モジュール内検索API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/{module}/search | GET | モジュール内検索の実行 |
| /api/v1/{module}/search/advanced | POST | 高度な検索条件によるモジュール内検索 |
| /api/v1/{module}/search/export | GET | 検索結果のエクスポート |

#### リクエスト例（案件検索）

```json
{
  "keyword": "システム開発",
  "filters": {
    "projectType": ["新規開発", "機能追加"],
    "skills": ["Java", "Spring", "AWS"],
    "skillsMatchType": "any", // any, all
    "rateRange": {
      "min": 600000,
      "max": 800000
    },
    "location": ["東京", "神奈川"],
    "periodRange": {
      "startFrom": "2025-06-01",
      "startTo": "2025-08-31"
    },
    "status": ["募集中"]
  },
  "sort": {
    "field": "updatedAt",
    "direction": "desc"
  },
  "page": 0,
  "size": 20
}
```

### 5.3 検索履歴・保存検索API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/search/history | GET | 検索履歴の取得 |
| /api/v1/search/history/clear | DELETE | 検索履歴のクリア |
| /api/v1/search/saved | GET | 保存済み検索の取得 |
| /api/v1/search/saved | POST | 検索条件の保存 |
| /api/v1/search/saved/{id} | GET | 保存済み検索の詳細取得 |
| /api/v1/search/saved/{id} | PUT | 保存済み検索の更新 |
| /api/v1/search/saved/{id} | DELETE | 保存済み検索の削除 |
| /api/v1/search/saved/{id}/share | POST | 保存済み検索の共有 |

## 6. 技術的実装

### 6.1 使用技術

* **検索エンジン**: Elasticsearch 8.x
* **バックエンド実装**: Spring Boot + Spring Data Elasticsearch
* **フロントエンド**: React + TypeScript
* **検索UI**: カスタムコンポーネント + React Query

### 6.2 データモデル設計

以下のモデルを実装する：

```java
// 検索履歴エンティティ
@Entity
@Table(name = "search_history")
public class SearchHistory {
    @Id
    private UUID id;
    
    @Column(nullable = false)
    private UUID userId;
    
    @Enumerated(EnumType.STRING)
    private SearchType searchType;
    
    @Enumerated(EnumType.STRING)
    private ModuleType moduleType;
    
    private String searchKeyword;
    
    @Column(columnDefinition = "jsonb")
    private String searchParams;
    
    private Integer resultCount;
    
    @Column(nullable = false)
    private LocalDateTime executedAt;
    
    private boolean isSaved;
    
    private String savedName;
}

// 保存済み検索エンティティ
@Entity
@Table(name = "saved_searches")
public class SavedSearch {
    @Id
    private UUID id;
    
    @Column(nullable = false)
    private UUID userId;
    
    @Column(nullable = false)
    private String name;
    
    @Enumerated(EnumType.STRING)
    private ModuleType moduleType;
    
    private String description;
    
    @Column(columnDefinition = "jsonb", nullable = false)
    private String searchParams;
    
    private boolean isShared;
    
    @ElementCollection
    private Set<UUID> sharedWithUserIds = new HashSet<>();
    
    @Column(nullable = false)
    private LocalDateTime createdAt;
    
    private LocalDateTime updatedAt;
    
    private LocalDateTime lastUsedAt;
}

// Elasticsearchインデックスマッピング例（案件）
@Document(indexName = "projects")
public class ProjectIndex {
    @Id
    private String id;
    
    @Field(type = FieldType.Text, analyzer = "japanese")
    private String projectName;
    
    @Field(type = FieldType.Text, analyzer = "japanese")
    private String description;
    
    @Field(type = FieldType.Keyword)
    private String projectType;
    
    @Field(type = FieldType.Keyword)
    private List<String> skills;
    
    @Field(type = FieldType.Integer)
    private Integer rateMin;
    
    @Field(type = FieldType.Integer)
    private Integer rateMax;
    
    @Field(type = FieldType.Keyword)
    private List<String> locations;
    
    @Field(type = FieldType.Date)
    private LocalDate startDate;
    
    @Field(type = FieldType.Date)
    private LocalDate endDate;
    
    @Field(type = FieldType.Keyword)
    private String status;
    
    @Field(type = FieldType.Keyword)
    private String clientName;
    
    @Field(type = FieldType.Date)
    private LocalDateTime createdAt;
    
    @Field(type = FieldType.Date)
    private LocalDateTime updatedAt;
}
```

### 6.3 検索性能最適化

検索性能を最適化するために以下の手法を採用する：

1. **インデックス最適化**:
   - フィールドの適切なマッピング（テキスト、キーワード、数値など）
   - マルチフィールドインデックス（完全一致用と部分一致用）
   - インデックスの定期的な再生成とマージ

2. **クエリ最適化**:
   - フィルタとクエリの適切な使い分け
   - 集約のキャッシュ利用
   - クエリの複雑さに応じたタイムアウト設定

3. **スケーリング戦略**:
   - インデックスのシャーディング
   - 高可用性のためのレプリケーション
   - 検索ノードのオートスケーリング

4. **キャッシュ戦略**:
   - 頻繁に実行される検索結果のキャッシュ
   - 変更頻度の低いデータのキャッシュ保持時間延長
   - クライアントサイドキャッシュの活用

## 7. セキュリティと権限制御

### 7.1 検索権限制御

ユーザーの権限に基づいて検索結果をフィルタリングする：

1. **セキュリティフィルタリング**:
   - クエリタイムでのユーザー権限に基づく検索結果フィルタリング
   - 部門間・組織間のアクセス制御

2. **フィールドレベルのセキュリティ**:
   - 権限に基づく表示可能フィールドの制限
   - 機密情報の適切なマスキング

3. **検索履歴のセキュリティ**:
   - ユーザー個人の検索履歴の隔離
   - 保存済み検索の適切なアクセス制御

### 7.2 機密検索対象の取り扱い

機密性の高い情報の検索対応：

1. **暗号化フィールドの検索**:
   - 暗号化されたフィールドの検索手法
   - トークン化による安全な検索

2. **機密レベルに応じた検索制限**:
   - 情報の機密レベルに応じた検索機能の制限
   - 高機密情報の検索ログ記録と監査

## 8. 課題と拡張性

* **検索結果の適合性向上**: ユーザーフィードバックを基にした検索結果ランキングの改善
* **自然言語検索**: 自然言語による問い合わせに対応する検索機能の拡張
* **多言語対応**: 日本語以外の言語での検索に対応
* **AI支援検索**: AIによる検索の支援と推奨検索の提供
* **大規模データ対応**: データ量の増加に伴う検索パフォーマンスの維持