<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共通機能アーキテクチャ - SES業務システム</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #2c3e50;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        h1 {
            font-size: 28px;
            text-align: center;
            margin-top: 1em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            font-size: 24px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
            background-color: #f8f9fa;
            padding: 8px 12px;
        }
        h3 {
            font-size: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        h4 {
            font-size: 18px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        pre, code {
            background-color: #f6f8fa;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            padding: 2px 4px;
        }
        pre {
            padding: 10px;
            overflow: auto;
            line-height: 1.45;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        .image-placeholder {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            color: #999;
            background-color: #f9f9f9;
            width: 80%;
        }
        .navigation {
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .navigation a {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: white;
        }
        footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="index.html">目次へ戻る</a>
    </div>

    <h1>共通機能アーキテクチャ</h1>
    
    <h2 id="overview">1. 概要</h2>
    <p>共通機能は、SES業務システムの複数の業務モジュールで共有される基盤機能を提供する。これらの機能は一貫性のある実装を通じて、システム全体の品質向上とメンテナンス性の確保に貢献する。</p>
    
    <div class="container">
        <div class="image-placeholder">
            [共通機能アーキテクチャ全体図]<br>
            ここに共通機能の全体アーキテクチャ図を挿入
        </div>
    </div>

    <h2 id="architecture">2. アーキテクチャ設計原則</h2>
    <p>共通機能の設計において、以下の原則を適用する：</p>
    <ul>
        <li><strong>関心の分離</strong>: 各共通機能は明確に定義された責務を持ち、他の機能との依存関係を最小限に抑える</li>
        <li><strong>拡張性</strong>: 将来的な要件の変化に対応できるよう、拡張ポイントを適切に設計する</li>
        <li><strong>再利用性</strong>: 共通機能は業務ロジックから独立して再利用可能な形で実装する</li>
        <li><strong>一貫性</strong>: 共通機能全体で一貫したインターフェース設計と振る舞いを提供する</li>
        <li><strong>構成可能性</strong>: 運用環境に応じた柔軟な設定変更を可能にする</li>
    </ul>

    <h2 id="common-modules">3. 共通機能モジュール構成</h2>
    <p>SES業務システムの共通機能は以下のモジュールから構成される：</p>
    
    <table>
        <tr>
            <th>機能分類</th>
            <th>モジュール</th>
            <th>概要</th>
            <th>詳細設計書</th>
        </tr>
        <tr>
            <td rowspan="2">認証・認可</td>
            <td>認証機能</td>
            <td>ユーザー認証、セッション管理、多要素認証</td>
            <td><a href="認証機能設計_01_概要とアーキテクチャ.html">認証機能設計</a></td>
        </tr>
        <tr>
            <td>認可機能</td>
            <td>権限管理、アクセス制御、ロールベースアクセス制御（RBAC）</td>
            <td><a href="認可機能設計_01_概要とアーキテクチャ.html">認可機能設計</a></td>
        </tr>
        <tr>
            <td rowspan="2">基盤サービス</td>
            <td>通知機能</td>
            <td>メール通知、システム内通知、プッシュ通知</td>
            <td><a href="通知機能設計_01_概要とアーキテクチャ.html">通知機能設計</a></td>
        </tr>
        <tr>
            <td>ファイル管理機能</td>
            <td>ファイルストレージ、アクセス管理、バージョン管理</td>
            <td><a href="ファイル管理機能設計_01_概要とアーキテクチャ.html">ファイル管理機能設計</a></td>
        </tr>
        <tr>
            <td rowspan="2">検索・データ管理</td>
            <td>検索機能</td>
            <td>全文検索、ファセット検索、検索インデックス管理</td>
            <td><a href="検索機能設計_01_概要とアーキテクチャ.html">検索機能設計</a></td>
        </tr>
        <tr>
            <td>キャッシュ機能</td>
            <td>データキャッシュ、結果キャッシュ、分散キャッシュ</td>
            <td><a href="キャッシュ機能設計.html">キャッシュ機能設計</a></td>
        </tr>
        <tr>
            <td rowspan="2">システム管理</td>
            <td>監査ログ機能</td>
            <td>操作ログ記録、監査証跡、ログ検索</td>
            <td><a href="監査ログ機能設計.html">監査ログ機能設計</a></td>
        </tr>
        <tr>
            <td>マスターデータ管理</td>
            <td>コード管理、マスターデータメンテナンス</td>
            <td><a href="マスターデータ管理機能設計.html">マスターデータ管理機能設計</a></td>
        </tr>
    </table>

    <h2 id="interaction">4. 共通機能間の連携モデル</h2>
    <p>共通機能間の連携は、以下のパターンに基づいて設計される：</p>

    <h3>4.1 直接呼び出し</h3>
    <p>依存性の明確な機能間では、APIを通じた直接呼び出しを行う。例えば、ファイル管理機能が認可機能を呼び出して、アクセス権のチェックを行う。</p>
    
    <pre><code>// 例: ファイル管理機能が認可機能を呼び出す
@Autowired
private AuthorizationService authService;

public FileDTO getFile(String fileId, String userId) {
    // 認可機能を呼び出してアクセス権をチェック
    if (!authService.hasPermission(userId, "FILE_READ", fileId)) {
        throw new AccessDeniedException("ファイルへのアクセス権がありません");
    }
    
    // ファイルの取得処理
    return fileRepository.findById(fileId)
        .map(fileMapper::toDTO)
        .orElseThrow(() -> new ResourceNotFoundException("ファイルが見つかりません"));
}</code></pre>

    <h3>4.2 イベント駆動連携</h3>
    <p>緩やかな結合が望ましい機能間では、イベントを介した非同期連携を行う。例えば、ファイルのアップロード完了時に通知機能へイベントを発行する。</p>
    
    <pre><code>// 例: ファイルアップロード完了イベントの発行
@Autowired
private ApplicationEventPublisher eventPublisher;

public FileDTO uploadFile(FileUploadRequest request) {
    // ファイルアップロード処理
    File savedFile = fileStorage.store(request.getContent());
    File fileEntity = fileRepository.save(new File(savedFile.getId(), request.getName()));
    
    // イベント発行
    eventPublisher.publishEvent(new FileUploadedEvent(fileEntity, request.getUserId()));
    
    return fileMapper.toDTO(fileEntity);
}</code></pre>

    <pre><code>// 例: 通知機能でのイベントハンドリング
@Component
public class FileEventListener {
    @Autowired
    private NotificationService notificationService;
    
    @EventListener
    public void handleFileUploadedEvent(FileUploadedEvent event) {
        // 通知の送信
        NotificationRequest request = NotificationRequest.builder()
            .userId(event.getUserId())
            .type(NotificationType.FILE_UPLOADED)
            .subject("ファイルがアップロードされました")
            .params(Map.of("fileName", event.getFile().getName()))
            .build();
            
        notificationService.sendNotification(request);
    }
}</code></pre>

    <h3>4.3 サービスレジストリ</h3>
    <p>動的な機能拡張が必要な場合は、サービスレジストリパターンを使用する。例えば、複数の認証プロバイダーを統合管理する。</p>
    
    <pre><code>// 例: 認証プロバイダーのレジストリ
@Service
public class AuthenticationProviderRegistry {
    private final Map&lt;String, AuthenticationProvider&gt; providers = new HashMap<>();
    
    public void registerProvider(String type, AuthenticationProvider provider) {
        providers.put(type, provider);
    }
    
    public AuthenticationProvider getProvider(String type) {
        AuthenticationProvider provider = providers.get(type);
        if (provider == null) {
            throw new IllegalArgumentException("不明な認証プロバイダー: " + type);
        }
        return provider;
    }
}</code></pre>

    <h2 id="integration">5. 業務モジュールとの統合</h2>
    <p>共通機能と業務モジュールの統合は、以下のアプローチで実現する：</p>

    <h3>5.1 依存性注入</h3>
    <p>業務モジュールは、共通機能をサービスとして注入して利用する。</p>
    
    <pre><code>// 例: 案件管理モジュールでのファイル管理機能の利用
@Service
public class ProjectDocumentService {
    @Autowired
    private FileManagementService fileService;
    
    public void attachDocumentToProject(Long projectId, MultipartFile document) {
        // プロジェクトに関連づけてドキュメントを保存
        FileDTO savedFile = fileService.uploadFile(
            FileUploadRequest.builder()
                .content(document.getBytes())
                .name(document.getOriginalFilename())
                .metadata(Map.of("projectId", projectId.toString()))
                .build()
        );
        
        // プロジェクトとファイルの関連付け処理
        projectRepository.attachDocument(projectId, savedFile.getId());
    }
}</code></pre>

    <h3>5.2 アスペクト指向プログラミング</h3>
    <p>横断的関心事（監査ログ、認可など）は、アスペクトとして実装し、業務ロジックと分離する。</p>
    
    <pre><code>// 例: 監査ログアスペクト
@Aspect
@Component
public class AuditLogAspect {
    @Autowired
    private AuditLogService auditLogService;
    
    @Around("@annotation(auditLog)")
    public Object logAudit(ProceedingJoinPoint joinPoint, AuditLog auditLog) throws Throwable {
        // 監査ログ用のデータ収集
        String operation = auditLog.operation();
        String userId = SecurityContextHolder.getContext().getAuthentication().getName();
        String targetType = auditLog.targetType();
        
        // 元のメソッド実行
        Object result = joinPoint.proceed();
        
        // 監査ログの記録
        auditLogService.logOperation(
            AuditLogEntry.builder()
                .userId(userId)
                .operation(operation)
                .targetType(targetType)
                .targetId(extractTargetId(result, joinPoint.getArgs()))
                .timestamp(LocalDateTime.now())
                .build()
        );
        
        return result;
    }
    
    // 対象IDの抽出ロジック
    private String extractTargetId(Object result, Object[] args) {
        // 結果または引数から対象IDを抽出するロジック
        // ...
    }
}</code></pre>

    <h3>5.3 ファサードパターン</h3>
    <p>複数の共通機能を組み合わせて利用する場合、ファサードを提供して業務モジュールの利用を簡素化する。</p>
    
    <pre><code>// 例: ユーザー管理ファサード
@Service
public class UserManagementFacade {
    @Autowired
    private AuthenticationService authService;
    
    @Autowired
    private AuthorizationService authzService;
    
    @Autowired
    private NotificationService notificationService;
    
    public void createUserAccount(UserCreateRequest request) {
        // ユーザー作成
        User user = authService.createUser(
            request.getUsername(), 
            request.getPassword(),
            request.getEmail()
        );
        
        // 初期ロール割り当て
        authzService.assignRolesToUser(
            user.getId(), 
            request.getInitialRoles()
        );
        
        // 通知送信
        notificationService.sendNotification(
            NotificationRequest.builder()
                .type(NotificationType.USER_CREATED)
                .userId(user.getId())
                .subject("アカウント作成完了")
                .build()
        );
    }
}</code></pre>

    <h2 id="technical-stack">6. 技術スタック</h2>
    <p>共通機能の実装には、以下の技術スタックを採用する：</p>
    
    <table>
        <tr>
            <th>分類</th>
            <th>採用技術</th>
            <th>用途</th>
        </tr>
        <tr>
            <td>プログラミング言語</td>
            <td>Java 17、Kotlin</td>
            <td>共通機能の実装</td>
        </tr>
        <tr>
            <td>フレームワーク</td>
            <td>Spring Boot 3.x、Spring Security、Spring Data</td>
            <td>基盤フレームワーク</td>
        </tr>
        <tr>
            <td>データストア</td>
            <td>PostgreSQL、Redis</td>
            <td>永続化、キャッシュ</td>
        </tr>
        <tr>
            <td>検索エンジン</td>
            <td>Elasticsearch</td>
            <td>全文検索、検索機能</td>
        </tr>
        <tr>
            <td>認証</td>
            <td>OAuth 2.0、JWT、Spring Security</td>
            <td>認証基盤</td>
        </tr>
        <tr>
            <td>ファイル管理</td>
            <td>MinIO (S3互換)、Apache Tika</td>
            <td>ファイルストレージ、コンテンツ分析</td>
        </tr>
        <tr>
            <td>監査・ログ</td>
            <td>SLF4J、Logback、ELK Stack</td>
            <td>ログ記録、分析</td>
        </tr>
        <tr>
            <td>メッセージング</td>
            <td>RabbitMQ、Spring AMQP</td>
            <td>非同期メッセージング</td>
        </tr>
    </table>

    <h2 id="api-design">7. 共通API設計原則</h2>
    <p>共通機能が提供するAPIは、以下の原則に従って設計される：</p>
    
    <h3>7.1 RESTful API設計</h3>
    <ul>
        <li><strong>リソース指向</strong>: システムの各機能をリソースとして表現</li>
        <li><strong>HTTPメソッドの適切な利用</strong>: GET（取得）、POST（作成）、PUT（更新）、DELETE（削除）の明確な使い分け</li>
        <li><strong>ステートレスなインターフェース</strong>: リクエスト間で状態を保持しない設計</li>
        <li><strong>HATEOAS</strong>: リソース間のリンク情報を含めた応答</li>
    </ul>
    
    <h3>7.2 内部API（Java）</h3>
    <ul>
        <li><strong>モジュール化</strong>: 明確な責務を持つモジュールの分割</li>
        <li><strong>インターフェース駆動設計</strong>: 実装から分離された抽象インターフェース</li>
        <li><strong>イミュータブルオブジェクト</strong>: 可能な限り不変オブジェクトを使用</li>
        <li><strong>例外ハンドリング</strong>: 一貫した例外階層と説明的なメッセージ</li>
    </ul>
    
    <pre><code>// 例: ファイル管理API（Java）
public interface FileManagementService {
    /**
     * ファイルをアップロードする
     * @param request アップロード要求
     * @return アップロードされたファイル情報
     * @throws ValidationException 入力検証エラー時
     * @throws StorageException ストレージエラー時
     */
    FileDTO uploadFile(FileUploadRequest request);
    
    /**
     * ファイルを取得する
     * @param fileId ファイルID
     * @return ファイル情報
     * @throws ResourceNotFoundException ファイルが存在しない場合
     * @throws AccessDeniedException アクセス権がない場合
     */
    FileDTO getFile(String fileId);
    
    /**
     * ファイルの内容を取得する
     * @param fileId ファイルID
     * @return ファイル内容のストリーム
     * @throws ResourceNotFoundException ファイルが存在しない場合
     * @throws AccessDeniedException アクセス権がない場合
     */
    InputStream getFileContent(String fileId);
    
    /**
     * ファイルのメタデータを更新する
     * @param fileId ファイルID
     * @param request 更新要求
     * @return 更新されたファイル情報
     * @throws ResourceNotFoundException ファイルが存在しない場合
     * @throws AccessDeniedException アクセス権がない場合
     * @throws ValidationException 入力検証エラー時
     */
    FileDTO updateFileMetadata(String fileId, FileMetadataUpdateRequest request);
    
    /**
     * ファイルを削除する
     * @param fileId ファイルID
     * @throws ResourceNotFoundException ファイルが存在しない場合
     * @throws AccessDeniedException アクセス権がない場合
     */
    void deleteFile(String fileId);
}</code></pre>

    <h3>7.3 REST APIの例</h3>
    <pre><code>// ファイル管理REST API例

// ファイルアップロード
POST /api/v1/files
Accept: application/json
Content-Type: multipart/form-data

// レスポンス
{
  "id": "f12345",
  "name": "document.pdf",
  "mimeType": "application/pdf",
  "size": 1024567,
  "createdAt": "2025-05-05T10:30:00Z",
  "createdBy": "user123",
  "metadata": {
    "description": "プロジェクト提案書",
    "projectId": "p789"
  },
  "_links": {
    "self": { "href": "/api/v1/files/f12345" },
    "content": { "href": "/api/v1/files/f12345/content" },
    "metadata": { "href": "/api/v1/files/f12345/metadata" }
  }
}

// ファイル取得
GET /api/v1/files/f12345
Accept: application/json

// ファイル内容の取得
GET /api/v1/files/f12345/content
Accept: application/octet-stream

// メタデータ更新
PATCH /api/v1/files/f12345/metadata
Content-Type: application/json
{
  "description": "改訂版プロジェクト提案書",
  "version": "2.0"
}

// ファイル削除
DELETE /api/v1/files/f12345</code></pre>

    <h2 id="security">8. セキュリティ設計</h2>
    <p>共通機能全体で適用されるセキュリティ設計原則：</p>
    
    <h3>8.1 認証と認可</h3>
    <ul>
        <li><strong>多層防御</strong>: API層、アプリケーション層、データ層での複数の防御策</li>
        <li><strong>最小権限の原則</strong>: 必要最小限の権限のみを付与</li>
        <li><strong>認証の分離</strong>: 認証と認可の責務を明確に分離</li>
    </ul>
    
    <h3>8.2 データ保護</h3>
    <ul>
        <li><strong>保存データの暗号化</strong>: 機密データの暗号化保存</li>
        <li><strong>転送中のデータ暗号化</strong>: TLS 1.3による通信の保護</li>
        <li><strong>機密データの取り扱い</strong>: 適切なマスキングと最小限の保持</li>
    </ul>
    
    <h3>8.3 脆弱性対策</h3>
    <ul>
        <li><strong>入力検証</strong>: すべての入力データの厳格な検証</li>
        <li><strong>出力エンコーディング</strong>: XSS攻撃対策のための出力エンコーディング</li>
        <li><strong>SQLインジェクション対策</strong>: プリペアドステートメントの使用</li>
        <li><strong>CSRF対策</strong>: トークンベースの保護</li>
    </ul>

    <h2 id="monitoring">9. 監視と運用</h2>
    <p>共通機能の監視と運用に関する設計：</p>
    
    <h3>9.1 ヘルスチェック</h3>
    <p>各共通機能は、以下の情報を提供するヘルスエンドポイントを実装する：</p>
    <ul>
        <li>サービスの状態（UP/DOWN/WARNING）</li>
        <li>依存サービスの状態</li>
        <li>リソース使用状況（メモリ、CPU、接続数など）</li>
    </ul>
    
    <h3>9.2 メトリクス収集</h3>
    <p>以下のメトリクスを収集して、Prometheusに公開する：</p>
    <ul>
        <li>リクエスト数と応答時間</li>
        <li>エラー率と種類</li>
        <li>リソース使用率</li>
        <li>キャッシュヒット率</li>
        <li>接続プール使用率</li>
    </ul>
    
    <h3>9.3 ログ管理</h3>
    <p>以下のログレベルとポリシーを適用する：</p>
    <ul>
        <li><strong>ERROR</strong>: システムエラー、例外、障害（常に詳細情報を含める）</li>
        <li><strong>WARN</strong>: 潜在的な問題、リトライが必要な状況</li>
        <li><strong>INFO</strong>: 重要な操作、状態変化</li>
        <li><strong>DEBUG</strong>: 開発・トラブルシューティング用の詳細情報（本番環境では無効）</li>
        <li><strong>TRACE</strong>: 非常に詳細な診断情報（開発環境のみ）</li>
    </ul>

    <h2 id="extension">10. 拡張ポイント</h2>
    <p>将来の機能拡張を容易にするための拡張ポイント：</p>
    
    <h3>10.1 認証プロバイダー</h3>
    <p>新しい認証方式（SAML、OpenID Connect等）の追加</p>
    
    <h3>10.2 通知チャネル</h3>
    <p>新しい通知チャネル（モバイルプッシュ、SMS等）の追加</p>
    
    <h3>10.3 ストレージプロバイダー</h3>
    <p>新しいストレージバックエンド（クラウドストレージ等）の追加</p>
    
    <h3>10.4 データエクスポート形式</h3>
    <p>新しいエクスポート形式（CSV、Excel等）の追加</p>

    <div class="navigation">
        <a href="index.html">目次へ戻る</a>
    </div>

    <footer>
        <p>SES業務システム 基本設計書 &copy; 2025</p>
    </footer>
</body>
</html>