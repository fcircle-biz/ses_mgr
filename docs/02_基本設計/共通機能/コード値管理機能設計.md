# SES業務システム コード値管理機能 基本設計書

## 1. はじめに

本書は、SES業務システムにおけるコード値管理機能の基本設計を定義したものである。
システム全体で使用されるマスタデータ（コード値）の管理方法および実装方針について記述する。

## 2. 機能概要

コード値管理機能は、SES業務システムにおける各種コード値（マスタデータ）を一元管理するための共通機能である。
職種、スキル、案件種別、契約種別など、様々なカテゴリのコード値を提供し、システム全体での一貫性を確保する。
コード値は主に参照される用途で使用され、更新はシステム管理機能を通じて行われる。

## 3. コード値管理機能設計

### 3.1 コード値の基本構造

コード値は以下の階層構造で管理される：

1. **カテゴリ（Category）**: コード値のグループ（例：職種、スキル、契約種別）
2. **コード（Code）**: カテゴリ内での一意のコード値（例：職種カテゴリ内の「SE」「PG」「PM」など）
3. **名称（Name）**: コードの表示名称
4. **追加情報（Attributes）**: コードに関連する追加的な属性情報（オプション）

一部のコード値カテゴリでは、以下のような親子関係を持つ階層構造を採用する：

```
// 階層構造の例（スキルカテゴリ）
Programming Language（親）
  |- Java
  |- Python
  |- JavaScript
     |- TypeScript
     |- React
     |- Vue.js
  |- C#
  |- PHP

// 階層構造の例（勤務地カテゴリ）
Japan（親）
  |- Tokyo
     |- Chiyoda
     |- Minato
     |- Shibuya
  |- Osaka
  |- Nagoya
  |- Fukuoka
```

### 3.2 主要コード値カテゴリ

システムで使用される主要なコード値カテゴリは以下の通り：

| カテゴリID | 名称 | 説明 |
|------------|------|------|
| job_type | 職種 | 技術者の職種区分（PM, SE, PG など） |
| skill | スキル | 技術スキル一覧（Java, Python, AWS など） |
| skill_level | スキルレベル | スキルの習熟度（beginner, intermediate, advanced, expert） |
| project_type | プロジェクト種別 | 案件の種類（新規開発, 保守, コンサルティング など） |
| industry | 業界 | クライアントの業界（金融, 製造, 小売 など） |
| contract_type | 契約種別 | 契約形態（準委任, 請負, 派遣 など） |
| billing_unit | 請求単位 | 請求の単位（月額, 人月, 時間 など） |
| work_location | 勤務地 | 勤務場所（リモート, オンサイト, ハイブリッド） |
| work_status | 稼働状況 | 技術者の稼働状態（稼働中, 待機中, 研修中 など） |
| project_status | 案件ステータス | 案件の状態（募集中, 提案中, 成約, 終了 など） |
| invoice_status | 請求書ステータス | 請求書の処理状態（作成中, 承認待ち, 発行済み, 入金済み など） |
| payment_status | 支払ステータス | 支払いの処理状態（未払い, 処理中, 支払済み など） |

### 3.3 マスタデータ分類

マスタデータは、その用途に基づいて以下のように分類される：

#### 3.3.1 組織系マスタ
- 部門マスタ：会社の組織構造
- 役職マスタ：社内の役職
- 雇用形態マスタ：正社員、契約社員、派遣社員など
- 取引先分類マスタ：顧客、パートナー、仕入先など

#### 3.3.2 業務系マスタ
- スキル分類マスタ：スキルの大分類（言語、DB、フレームワークなど）
- スキル詳細マスタ：具体的なスキル項目
- 案件ステータスマスタ：案件の状態（募集中、契約中、完了など）
- 案件種別マスタ：SES、受託開発、コンサルなど
- 稼働形態マスタ：常駐、リモート、ハイブリッドなど
- 契約種別マスタ：準委任、請負など
- 請求サイクルマスタ：月次、週次、完了時など
- 単価種別マスタ：時給、日給、月給など

#### 3.3.3 システム系マスタ
- システム設定マスタ：システム全体の設定値
- 通知テンプレートマスタ：メール通知などのテンプレート
- 帳票テンプレートマスタ：各種帳票のテンプレート
- エラーコードマスタ：システムエラーコードと説明

### 3.4 コード値の属性

基本的なコード値は以下の属性を持つ：

| 属性 | 型 | 説明 |
|------|------|------|
| code | String | コード値（一意識別子） |
| name | String | 表示名称 |
| description | String | 説明文 |
| sortOrder | Integer | 表示順序 |
| isActive | Boolean | 有効/無効フラグ |
| attributes | JSON | 追加属性（コード値種別ごとに異なる） |
| parentCode | String | 親コード（階層構造の場合） |
| createdAt | DateTime | 作成日時 |
| updatedAt | DateTime | 更新日時 |

カテゴリごとに固有の追加属性を持つことができる。例えば：

**職種（job_type）の追加属性例**:
```json
{
  "abbreviation": "PM",
  "skillLevel": "senior",
  "gradeRange": "G4-G6",
  "typicalYearsExperience": "5-10"
}
```

**スキル（skill）の追加属性例**:
```json
{
  "category": "programming",
  "popularity": "high",
  "learningResources": ["https://example.com/learn-java", "https://example.com/java-tutorial"]
}
```

## 4. 機能設計

### 4.1 コード値参照機能

コード値参照機能は、システム全体でコード値を一貫して参照するためのAPI群を提供する。

#### 4.1.1 コード値カテゴリ一覧取得

* **機能**: システムで利用可能なコード値カテゴリの一覧を取得する
* **入力**: なし
* **出力**: カテゴリ一覧（ID、名前、説明、コード値件数）
* **処理フロー**:
  1. 利用可能なすべてのカテゴリ情報を取得
  2. カテゴリごとのコード値件数を計算
  3. 結果を返却

#### 4.1.2 特定カテゴリのコード値一覧取得

* **機能**: 指定されたカテゴリに属するコード値の一覧を取得する
* **入力**: カテゴリID、検索条件（キーワード、親コード、有効フラグ）
* **出力**: コード値一覧（コード、名称、ソート順、有効フラグ、追加属性）
* **処理フロー**:
  1. カテゴリの存在確認
  2. 指定された条件に合致するコード値を検索
  3. ソート順に並べ替え
  4. 結果を返却

#### 4.1.3 特定コード値の詳細取得

* **機能**: 指定されたカテゴリとコードの組み合わせによる詳細情報を取得する
* **入力**: カテゴリID、コード値
* **出力**: コード値詳細（コード、名称、説明、ソート順、有効フラグ、追加属性、親コード、子コード、作成日時、更新日時）
* **処理フロー**:
  1. カテゴリとコードの組み合わせの存在確認
  2. 詳細情報の取得
  3. 階層構造の場合は親コードと子コードの情報も取得
  4. 結果を返却

### 4.2 コード値管理機能

コード値管理機能は、システム管理者がコード値を管理するための機能を提供する。

#### 4.2.1 コード値登録機能

* **機能**: 新しいコード値を登録する
* **入力**: カテゴリID、コード、名称、説明、ソート順、有効フラグ、追加属性、親コード
* **出力**: 登録結果（成功/失敗）
* **処理フロー**:
  1. 入力値のバリデーション
  2. コードの重複チェック
  3. コード値の登録
  4. 結果を返却

#### 4.2.2 コード値更新機能

* **機能**: 既存のコード値を更新する
* **入力**: カテゴリID、コード、更新情報（名称、説明、ソート順、有効フラグ、追加属性）
* **出力**: 更新結果（成功/失敗）
* **処理フロー**:
  1. コード値の存在確認
  2. 入力値のバリデーション
  3. コード値の更新
  4. 結果を返却

#### 4.2.3 コード値削除/無効化機能

* **機能**: コード値を削除または無効化する
* **入力**: カテゴリID、コード
* **出力**: 削除/無効化結果（成功/失敗）
* **処理フロー**:
  1. コード値の存在確認
  2. 関連データの参照チェック
  3. 参照がある場合は無効化、なければ削除
  4. 結果を返却

#### 4.2.4 一括インポート/エクスポート機能

* **機能**: コード値を一括でインポート/エクスポートする
* **入力**: カテゴリID、CSVファイル（インポート時）、インポートモード（追加/更新/全置換）
* **出力**: インポート/エクスポート結果
* **処理フロー**:
  1. CSVファイルの形式チェック
  2. 指定されたモードでのインポート処理またはエクスポート処理
  3. 処理結果サマリーの生成
  4. 結果を返却

## 5. API設計

### 5.1 コード値参照API

#### 5.1.1 コード値カテゴリ一覧取得API

**エンドポイント**: `GET /api/v1/common/codes`

**レスポンス例**:
```json
{
  "data": [
    {
      "id": "job_type",
      "name": "職種",
      "description": "技術者の職種区分",
      "count": 15
    },
    {
      "id": "skill",
      "name": "スキル",
      "description": "技術スキル一覧",
      "count": 120
    }
  ]
}
```

#### 5.1.2 特定カテゴリのコード値一覧取得API

**エンドポイント**: `GET /api/v1/common/codes/{category}`

**クエリパラメータ**:
- `keyword`: 検索キーワード（オプション）
- `parent`: 親コード（オプション）
- `active_only`: 有効なコードのみ取得するフラグ（デフォルトtrue）

**レスポンス例**:
```json
{
  "data": {
    "category": {
      "id": "job_type",
      "name": "職種",
      "description": "技術者の職種区分"
    },
    "codes": [
      {
        "code": "PM",
        "name": "プロジェクトマネージャ",
        "sort_order": 1,
        "is_active": true,
        "attributes": {
          "abbreviation": "PM",
          "skill_level": "senior"
        }
      },
      {
        "code": "SE",
        "name": "システムエンジニア",
        "sort_order": 2,
        "is_active": true,
        "attributes": {
          "abbreviation": "SE",
          "skill_level": "middle"
        }
      }
    ]
  }
}
```

#### 5.1.3 特定コード値の詳細取得API

**エンドポイント**: `GET /api/v1/common/codes/{category}/{code}`

**レスポンス例**:
```json
{
  "data": {
    "category": {
      "id": "job_type",
      "name": "職種",
      "description": "技術者の職種区分"
    },
    "code": "PM",
    "name": "プロジェクトマネージャ",
    "description": "プロジェクト全体の管理と調整を担当する職種",
    "sort_order": 1,
    "is_active": true,
    "attributes": {
      "abbreviation": "PM",
      "skill_level": "senior",
      "grade_range": "G4-G6",
      "typical_years_experience": "5-10"
    },
    "parent_code": null,
    "child_codes": [],
    "created_at": "2023-01-01T00:00:00.000Z",
    "updated_at": "2023-04-10T15:30:00.000Z"
  }
}
```

### 5.2 コード値管理API

#### 5.2.1 コード値登録API

**エンドポイント**: `POST /api/v1/admin/codes/{category}`

**リクエスト例**:
```json
{
  "code": "AI_ENG",
  "name": "AIエンジニア",
  "description": "AI・機械学習分野の開発を行うエンジニア",
  "sort_order": 10,
  "is_active": true,
  "attributes": {
    "abbreviation": "AI",
    "skill_level": "expert",
    "grade_range": "G5-G7"
  },
  "parent_code": null
}
```

**レスポンス例**:
```json
{
  "data": {
    "category": "job_type",
    "code": "AI_ENG",
    "name": "AIエンジニア",
    "created_at": "2023-05-05T10:30:00.000Z"
  }
}
```

#### 5.2.2 コード値更新API

**エンドポイント**: `PUT /api/v1/admin/codes/{category}/{code}`

**リクエスト例**:
```json
{
  "name": "AI/ML エンジニア",
  "description": "AI・機械学習領域の開発を担当するエンジニア",
  "sort_order": 12,
  "is_active": true,
  "attributes": {
    "abbreviation": "AI/ML",
    "skill_level": "expert",
    "grade_range": "G5-G7"
  }
}
```

**レスポンス例**:
```json
{
  "data": {
    "category": "job_type",
    "code": "AI_ENG",
    "name": "AI/ML エンジニア",
    "updated_at": "2023-05-05T11:45:00.000Z"
  }
}
```

#### 5.2.3 コード値削除API

**エンドポイント**: `DELETE /api/v1/admin/codes/{category}/{code}`

**レスポンス例**:
```json
{
  "data": {
    "message": "コード値が正常に削除されました。",
    "category": "job_type",
    "code": "AI_ENG"
  }
}
```

#### 5.2.4 コード値一括インポートAPI

**エンドポイント**: `POST /api/v1/admin/codes/{category}/import`

**リクエスト**:
- Content-Type: multipart/form-data
- file: CSVファイル
- mode: "add" | "update" | "replace"

**レスポンス例**:
```json
{
  "data": {
    "total": 50,
    "success": 48,
    "error": 2,
    "summary": "48件のインポートに成功し、2件が失敗しました。",
    "errors": [
      {"line": 10, "reason": "既に存在するコードです。"},
      {"line": 23, "reason": "必須項目「名称」が未入力です。"}
    ],
    "error_report_url": "/api/v1/admin/codes/job_type/import/errors/20230505123045"
  }
}
```

#### 5.2.5 コード値一括エクスポートAPI

**エンドポイント**: `GET /api/v1/admin/codes/{category}/export`

**レスポンス**:
- Content-Type: text/csv
- CSVファイルのダウンロード

## 6. UI設計

### 6.1 マスタ管理画面

マスタ管理画面（ADM-003）は以下の構成を持つ：

#### 6.1.1 マスタ分類選択部
- マスタ分類タブ: 組織系、業務系、システム系
- マスタ一覧: 選択した分類内のマスタデータ一覧

#### 6.1.2 マスタデータ管理部共通
- マスタ名: 選択中のマスタデータ名
- 新規登録ボタン: マスタデータの新規登録
- 一括インポートボタン: CSVによるマスタデータの一括インポート
- 一括エクスポートボタン: CSVへのマスタデータの一括エクスポート
- 検索ボックス: マスタデータの検索

#### 6.1.3 マスタデータ一覧部
- コード: マスタデータのコード値
- 名称: マスタデータの表示名
- 説明: マスタデータの説明
- 表示順: マスタデータの表示順
- 有効フラグ: マスタデータの有効/無効状態
- 最終更新日時: マスタデータの最終更新日時
- 操作: 編集/削除/有効化・無効化
- ページング: 一覧のページ切り替え

#### 6.1.4 マスタデータ編集モーダル
- コード: マスタデータのコード値（編集時は読み取り専用）
- 名称: マスタデータの表示名
- 説明: マスタデータの説明
- 表示順: マスタデータの表示順
- 有効フラグ: マスタデータの有効/無効設定
- 追加属性: マスタ種別ごとの固有属性
- 保存ボタン: マスタデータの保存
- キャンセルボタン: 編集のキャンセル

## 7. 技術的実装

### 7.1 データモデル設計

以下のエンティティを実装する：

```java
// CodeCategoryエンティティ
@Entity
@Table(name = "code_categories")
public class CodeCategory {
    @Id
    private String id;
    
    @Column(nullable = false)
    private String name;
    
    private String description;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
    
    @OneToMany(mappedBy = "category", cascade = CascadeType.ALL)
    private Set<CodeValue> codeValues;
}

// CodeValueエンティティ
@Entity
@Table(name = "code_values")
public class CodeValue {
    @EmbeddedId
    private CodeValueId id;
    
    @ManyToOne
    @MapsId("categoryId")
    private CodeCategory category;
    
    @Column(nullable = false)
    private String name;
    
    private String description;
    
    @Column(nullable = false)
    private Integer sortOrder;
    
    @Column(nullable = false)
    private Boolean isActive = true;
    
    @Column(columnDefinition = "jsonb")
    private String attributes;
    
    private String parentCode;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
}

// CodeValueIdエンティティ（複合主キー）
@Embeddable
public class CodeValueId implements Serializable {
    private String categoryId;
    private String code;
    
    // コンストラクタ、equals、hashCodeを適切に実装
}
```

### 7.2 サービス実装

以下の主要サービスを実装する：

```java
// CodeServiceインターフェース
public interface CodeService {
    List<CodeCategoryDTO> findAllCategories();
    List<CodeValueDTO> findByCategory(String categoryId, String keyword, String parent, Boolean activeOnly);
    CodeValueDetailDTO findByCode(String categoryId, String code);
}

// AdminCodeServiceインターフェース
public interface AdminCodeService {
    CodeValueDTO create(String categoryId, CodeValueCreateDTO codeValueDTO);
    CodeValueDTO update(String categoryId, String code, CodeValueUpdateDTO codeValueDTO);
    void delete(String categoryId, String code);
    ImportResult importCodes(String categoryId, MultipartFile file, ImportMode mode);
    void exportCodes(String categoryId, HttpServletResponse response);
}

// ImportModeのenumクラス
public enum ImportMode {
    ADD, // 新規追加のみ
    UPDATE, // 既存データの更新のみ
    REPLACE // 既存データを全て削除して置き換え
}

// ImportResultのDTOクラス
public class ImportResult {
    private int total;
    private int success;
    private int error;
    private String summary;
    private List<ImportError> errors;
    private String errorReportUrl;
    
    // getterとsetter
}
```

### 7.3 実装上の注意点

1. **キャッシュ戦略**:
   - コード値は頻繁に参照されるため、適切なキャッシュ戦略を実装する
   - カテゴリごとにキャッシュを分割し、更新時に該当カテゴリのキャッシュのみを更新
   - キャッシュの有効期限を設定し、定期的に最新データで更新

2. **バリデーション**:
   - コード値のバリデーションルールをカテゴリごとに設定
   - 必須項目、文字数制限、形式チェックなどの基本的なバリデーション
   - 特定カテゴリ固有のビジネスルールに基づくバリデーション

3. **関連データの整合性**:
   - 他のデータから参照されているコード値の削除を防止
   - コード値の無効化時に関連データへの影響を評価
   - 階層構造を持つコード値の親子関係の整合性を維持

4. **パフォーマンス**:
   - 大量のコード値に対する検索・フィルタリングの最適化
   - 階層構造を持つコード値の効率的な取得方法

## 8. テスト方針

1. **単体テスト**:
   - コード値サービスの各メソッドのテスト
   - 異常系を含むバリデーションのテスト
   - キャッシュ戦略の正常動作確認

2. **統合テスト**:
   - APIエンドポイント呼び出しの結合テスト
   - データベースとの連携テスト
   - キャッシュとデータベースの一貫性テスト

3. **性能テスト**:
   - 大量データでの検索性能テスト
   - キャッシュ有効時と無効時の性能比較
   - 同時アクセス時の挙動テスト