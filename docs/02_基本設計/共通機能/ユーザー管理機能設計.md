# SES業務システム ユーザー管理機能 基本設計書

## 1. はじめに

本書は、SES業務システムにおけるユーザー管理機能の基本設計を定義したものである。
システム全体のユーザー、ロール、権限の管理方法およびユーザーのライフサイクル管理に関する実装方針について記述する。

## 2. 機能概要

ユーザー管理機能は、SES業務システムにおけるユーザーアカウントの作成、編集、無効化、ロール割り当てなどを担当する
基盤的な共通機能である。本機能により、システム管理者は適切なユーザー管理とアクセス制御を実現できる。

## 3. ユーザー管理機能設計

### 3.1 機能構成

ユーザー管理機能は以下のサブ機能で構成される：

1. **ユーザーアカウント管理**: ユーザーの登録・編集・無効化
2. **ロール管理**: ロールの定義・権限設定
3. **権限割り当て**: ユーザーへのロール割り当て
4. **組織階層管理**: 部門構造と所属管理
5. **アカウントセキュリティ管理**: パスワードリセット・アカウントロック解除

### 3.2 ユーザーアカウント管理

#### 3.2.1 ユーザーモデル

ユーザーは以下の属性で管理される：

| 属性 | 型 | 説明 |
|------|------|------|
| id | UUID | ユーザーの一意識別子 |
| userId | String | ユーザーID（ログイン用） |
| email | String | メールアドレス |
| name | String | 氏名 |
| department | String | 所属部門 |
| position | String | 役職 |
| phone | String | 電話番号 |
| passwordHash | String | パスワードハッシュ値 |
| mfaEnabled | Boolean | 多要素認証の有効/無効 |
| status | Enum | アカウント状態（有効/無効/ロック中） |
| lastLoginAt | DateTime | 最終ログイン日時 |
| loginAttempts | Integer | 連続ログイン失敗回数 |
| passwordExpiresAt | DateTime | パスワード有効期限 |
| createdAt | DateTime | アカウント作成日時 |
| updatedAt | DateTime | アカウント更新日時 |

#### 3.2.2 アカウントライフサイクル

ユーザーアカウントのライフサイクルは以下のステータスで管理される：

1. **作成**: システム管理者によるアカウント作成
2. **有効化**: アカウントの有効化と初回パスワード設定
3. **アクティブ**: 通常の利用状態
4. **ロック**: 連続したログイン失敗や不正アクセス検知によるロック
5. **無効化**: 退職や長期不使用によるアカウント無効化
6. **削除**: 物理削除（監査のため基本的には実行しない）

#### 3.2.3 管理機能

ユーザーアカウント管理では以下の機能を提供する：

* **ユーザー検索**: ID、名前、メールアドレス、ロール、ステータスによる検索
* **一覧表示**: ページング機能付きのユーザー一覧表示
* **新規登録**: 新規ユーザーの登録
* **編集**: 既存ユーザー情報の更新
* **ステータス変更**: アカウントの有効化/無効化
* **ロール割り当て**: ユーザーへのロール付与/削除
* **パスワードリセット**: 仮パスワード発行とメール送信

### 3.3 ロール管理機能

#### 3.3.1 ロールモデル

ロールは以下の属性で管理される：

| 属性 | 型 | 説明 |
|------|------|------|
| id | UUID | ロールの一意識別子 |
| roleId | String | ロールID |
| name | String | ロール名称 |
| description | String | ロールの説明 |
| roleType | Enum | ロール区分（システム/業務） |
| createdAt | DateTime | ロール作成日時 |
| updatedAt | DateTime | ロール更新日時 |

#### 3.3.2 ロール区分

ロールは以下の区分に分類される：

1. **システムロール**: システム管理機能へのアクセス権限を定義
   - システム管理者
   - セキュリティ管理者
   - 監査者

2. **業務ロール**: 業務機能へのアクセス権限を定義
   - 営業管理者
   - 人事管理者
   - 経理管理者
   - 営業担当者
   - 人事担当者
   - 経理担当者
   - マッチング担当者

#### 3.3.3 プリセットロール

システムには以下のプリセットロールを提供する：

| ロール | 説明 | 主な権限 |
|--------|------|----------|
| システム管理者 | システム全体の管理権限 | すべての機能への完全アクセス |
| セキュリティ管理者 | セキュリティ関連の管理権限 | ユーザー管理（参照、ロック/ロック解除）、監査ログ管理、セキュリティ設定 |
| 監査者 | 監査・参照権限 | すべての機能への参照のみアクセス |
| 営業管理者 | 営業部門の管理権限 | 案件管理機能の管理、営業データの参照/更新 |
| 人事管理者 | 人事部門の管理権限 | 技術者管理機能の管理、人事データの参照/更新 |
| 経理管理者 | 経理部門の管理権限 | 請求支払機能の管理、経理データの参照/更新 |
| 営業担当者 | 営業担当の基本権限 | 案件情報の登録/更新、担当案件の参照 |
| 人事担当者 | 人事担当の基本権限 | 技術者情報の登録/更新、担当技術者の参照 |
| 経理担当者 | 経理担当の基本権限 | 請求書の作成、入金情報の登録 |
| マッチング担当者 | マッチング担当の基本権限 | マッチング機能の利用、提案書作成 |

#### 3.3.4 管理機能

ロール管理では以下の機能を提供する：

* **ロール一覧表示**: システムに定義されたロールの一覧表示
* **ロール新規作成**: 新しいロールの定義
* **ロール編集**: 既存ロールの更新
* **ロール削除**: 不要なロールの削除
* **ロール複製**: 既存ロールを基にした新規ロール作成
* **権限設定**: ロールに対する権限の設定

### 3.4 権限管理機能

#### 3.4.1 権限モデル

権限は以下の属性で管理される：

| 属性 | 型 | 説明 |
|------|------|------|
| id | UUID | 権限の一意識別子 |
| permissionId | String | 権限ID |
| name | String | 権限名称 |
| description | String | 権限の説明 |
| resourceType | String | リソース種別（機能グループ） |
| resourceName | String | リソース名（機能） |
| action | String | アクション（参照/編集/実行） |

#### 3.4.2 権限階層

権限は以下の階層構造で管理される：

1. **機能グループ**: 関連する機能の集合（案件管理、技術者管理など）
2. **機能**: 特定の機能単位（案件登録、案件検索など）
3. **アクション**: 機能に対する操作（参照、編集、削除など）

#### 3.4.3 ロール・権限関連付け

ロールと権限の関連付けは以下のモデルで管理される：

| 属性 | 型 | 説明 |
|------|------|------|
| roleId | UUID | ロールID（外部キー） |
| permissionId | UUID | 権限ID（外部キー） |
| accessLevel | Enum | アクセスレベル（なし/閲覧/編集） |

#### 3.4.4 管理機能

権限管理では以下の機能を提供する：

* **権限一覧表示**: システムに定義された権限の一覧表示
* **権限グループ管理**: 機能グループの階層構造管理
* **ロールへの権限割り当て**: ロールに対する権限の付与/削除
* **アクセスレベル設定**: 各権限に対するアクセスレベル（なし/閲覧/編集）の設定

### 3.5 ユーザー・ロール関連付け

#### 3.5.1 ユーザー・ロール関連モデル

ユーザーとロールの関連付けは以下のモデルで管理される：

| 属性 | 型 | 説明 |
|------|------|------|
| userId | UUID | ユーザーID（外部キー） |
| roleId | UUID | ロールID（外部キー） |
| assignedAt | DateTime | 割り当て日時 |
| assignedBy | UUID | 割り当てを行ったユーザーID |
| expiresAt | DateTime | 有効期限（一時的な権限付与の場合） |

#### 3.5.2 管理機能

ユーザー・ロール関連付け管理では以下の機能を提供する：

* **ユーザーへのロール割り当て**: ユーザーに対するロールの付与
* **ユーザーからのロール削除**: ユーザーからのロールの削除
* **一時的なロール付与**: 期限付きでのロール付与
* **ロール割り当て履歴**: ロール割り当ての変更履歴表示

## 4. UI設計

### 4.1 ユーザー管理画面

ユーザー管理画面（ADM-001）は以下の構成を持つ：

* **検索条件部**:
  - ユーザーID
  - ユーザー名
  - メールアドレス
  - ロール
  - ステータス（有効/無効/すべて）
  - 検索ボタン
  - クリアボタン

* **ユーザー一覧部**:
  - 新規登録ボタン
  - 一括操作ドロップダウン（有効化/無効化/ロック解除）
  - ユーザー一覧（ID、名前、メールアドレス、ロール、所属部門、ステータス、最終ログイン日時）
  - 各ユーザーに対する操作（編集/パスワードリセット/有効化・無効化）
  - ページング

* **ユーザー登録/編集モーダル**:
  - ユーザーID
  - 氏名
  - メールアドレス
  - パスワード（新規登録時のみ）
  - ロール
  - 所属部門
  - 電話番号
  - 多要素認証
  - アカウントロック（編集時のみ）
  - 保存ボタン
  - キャンセルボタン

### 4.2 ロール管理画面

ロール管理画面（ADM-002）は以下の構成を持つ：

* **ロール一覧部**:
  - 新規ロール作成ボタン
  - ロール一覧（ID、名前、説明、ユーザー数、作成日時、最終更新日時）
  - 各ロールに対する操作（編集/削除/複製）
  - ページング

* **ロール登録/編集モーダル**:
  * **基本情報タブ**:
    - ロールID
    - ロール名
    - 説明
    - ロール区分（システム/業務）
  * **権限設定タブ**:
    - 機能グループのツリービュー
    - 各機能項目に対するアクセス権限設定（なし/閲覧/編集）
    - 一括選択/解除ボタン
  * **共通操作ボタン**:
    - 保存ボタン
    - キャンセルボタン

## 5. API設計

### 5.1 ユーザー管理API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/admin/users | GET | ユーザー一覧取得 |
| /api/v1/admin/users/{id} | GET | ユーザー詳細取得 |
| /api/v1/admin/users | POST | ユーザー新規作成 |
| /api/v1/admin/users/{id} | PUT | ユーザー情報更新 |
| /api/v1/admin/users/{id}/status | PUT | ユーザーステータス更新 |
| /api/v1/admin/users/{id}/password/reset | POST | パスワードリセット |
| /api/v1/admin/users/{id}/unlock | POST | アカウントロック解除 |
| /api/v1/admin/users/bulk-status | PUT | 複数ユーザーのステータス一括更新 |

### 5.2 ロール管理API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/admin/roles | GET | ロール一覧取得 |
| /api/v1/admin/roles/{id} | GET | ロール詳細取得 |
| /api/v1/admin/roles | POST | ロール新規作成 |
| /api/v1/admin/roles/{id} | PUT | ロール情報更新 |
| /api/v1/admin/roles/{id} | DELETE | ロール削除 |
| /api/v1/admin/roles/{id}/clone | POST | ロール複製 |

### 5.3 権限管理API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/admin/permissions | GET | 権限一覧取得 |
| /api/v1/admin/permissions/groups | GET | 権限グループ階層取得 |
| /api/v1/admin/roles/{roleId}/permissions | GET | ロールの権限一覧取得 |
| /api/v1/admin/roles/{roleId}/permissions | PUT | ロールの権限更新 |

### 5.4 ユーザーロール管理API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/admin/users/{userId}/roles | GET | ユーザーのロール一覧取得 |
| /api/v1/admin/users/{userId}/roles | PUT | ユーザーのロール更新 |
| /api/v1/admin/users/{userId}/roles/{roleId} | POST | ユーザーにロールを付与 |
| /api/v1/admin/users/{userId}/roles/{roleId} | DELETE | ユーザーからロールを削除 |
| /api/v1/admin/roles/{roleId}/users | GET | ロールが付与されたユーザー一覧取得 |

## 6. 技術的実装

### 6.1 使用技術

* **フレームワーク**: Spring Boot + Spring Security
* **ORM**: Spring Data JPA
* **UI**: Thymeleaf + Bootstrap

### 6.2 データモデル設計

以下のエンティティを実装する：

```java
// Userエンティティ
@Entity
@Table(name = "users")
public class User {
    @Id
    private UUID id;
    
    @Column(unique = true, nullable = false)
    private String userId;
    
    @Column(unique = true, nullable = false)
    private String email;
    
    @Column(nullable = false)
    private String name;
    
    private String department;
    
    private String position;
    
    private String phone;
    
    @Column(nullable = false)
    private String passwordHash;
    
    private boolean mfaEnabled;
    
    @Enumerated(EnumType.STRING)
    private UserStatus status;
    
    private LocalDateTime lastLoginAt;
    
    private int loginAttempts;
    
    private LocalDateTime passwordExpiresAt;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
    
    @ManyToMany
    @JoinTable(
        name = "user_roles",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<Role> roles = new HashSet<>();
}

// Roleエンティティ
@Entity
@Table(name = "roles")
public class Role {
    @Id
    private UUID id;
    
    @Column(unique = true, nullable = false)
    private String roleId;
    
    @Column(nullable = false)
    private String name;
    
    private String description;
    
    @Enumerated(EnumType.STRING)
    private RoleType roleType;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
    
    @ManyToMany(mappedBy = "roles")
    private Set<User> users = new HashSet<>();
    
    @OneToMany(mappedBy = "role", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<RolePermission> rolePermissions = new HashSet<>();
}

// Permissionエンティティ
@Entity
@Table(name = "permissions")
public class Permission {
    @Id
    private UUID id;
    
    @Column(unique = true, nullable = false)
    private String permissionId;
    
    @Column(nullable = false)
    private String name;
    
    private String description;
    
    @Column(nullable = false)
    private String resourceType;
    
    @Column(nullable = false)
    private String resourceName;
    
    @Column(nullable = false)
    private String action;
    
    @OneToMany(mappedBy = "permission", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<RolePermission> rolePermissions = new HashSet<>();
}

// RolePermissionエンティティ（関連テーブル）
@Entity
@Table(name = "role_permissions")
public class RolePermission {
    @EmbeddedId
    private RolePermissionId id;
    
    @ManyToOne
    @MapsId("roleId")
    private Role role;
    
    @ManyToOne
    @MapsId("permissionId")
    private Permission permission;
    
    @Enumerated(EnumType.STRING)
    private AccessLevel accessLevel;
}

// UserRoleHistoryエンティティ（監査用）
@Entity
@Table(name = "user_role_history")
public class UserRoleHistory {
    @Id
    private UUID id;
    
    @Column(nullable = false)
    private UUID userId;
    
    @Column(nullable = false)
    private UUID roleId;
    
    @Enumerated(EnumType.STRING)
    private OperationType operationType;
    
    @Column(nullable = false)
    private UUID performedBy;
    
    @CreationTimestamp
    private LocalDateTime performedAt;
}
```

### 6.3 サービス実装

以下の主要サービスを実装する：

```java
// UserServiceインターフェース
public interface UserService {
    List<UserDTO> findAll(UserSearchCriteria criteria, Pageable pageable);
    UserDTO findById(UUID id);
    UserDTO create(UserCreateDTO userCreateDTO);
    UserDTO update(UUID id, UserUpdateDTO userUpdateDTO);
    void updateStatus(UUID id, UserStatus status);
    void resetPassword(UUID id);
    void unlockAccount(UUID id);
    void bulkUpdateStatus(List<UUID> ids, UserStatus status);
}

// RoleServiceインターフェース
public interface RoleService {
    List<RoleDTO> findAll(Pageable pageable);
    RoleDTO findById(UUID id);
    RoleDTO create(RoleCreateDTO roleCreateDTO);
    RoleDTO update(UUID id, RoleUpdateDTO roleUpdateDTO);
    void delete(UUID id);
    RoleDTO clone(UUID id, String newRoleId);
}

// PermissionServiceインターフェース
public interface PermissionService {
    List<PermissionDTO> findAll();
    List<PermissionGroupDTO> findAllGroups();
    List<RolePermissionDTO> findByRoleId(UUID roleId);
    void updateRolePermissions(UUID roleId, List<RolePermissionUpdateDTO> permissions);
}

// UserRoleServiceインターフェース
public interface UserRoleService {
    List<RoleDTO> findRolesByUserId(UUID userId);
    void updateUserRoles(UUID userId, List<UUID> roleIds);
    void assignRoleToUser(UUID userId, UUID roleId);
    void removeRoleFromUser(UUID userId, UUID roleId);
    List<UserDTO> findUsersByRoleId(UUID roleId, Pageable pageable);
}
```

## 7. セキュリティ対策

* **パスワードセキュリティ**:
  - パスワードは平文で保存せず、bcryptでハッシュ化
  - 強力なパスワードポリシーの適用
  - 定期的なパスワード変更の強制
  - 過去のパスワード再利用防止

* **アカウントロック**:
  - 一定回数のログイン失敗でアカウントを自動ロック
  - 管理者のみがロック解除可能
  - ロック解除時にセキュリティログを記録

* **アクセス制御**:
  - 最小権限の原則に基づく権限付与
  - 不要になった権限の迅速な削除
  - 定期的な権限レビュー

* **監査ログ**:
  - ユーザー登録・変更・削除の監査ログ記録
  - ロール割り当て・変更の監査ログ記録
  - 権限変更の監査ログ記録

## 8. 課題と制限事項

* **大量ユーザー管理**: 大量のユーザーを管理する場合のパフォーマンス最適化が必要
* **複雑な組織階層**: 複雑な組織階層を持つ企業での運用には工夫が必要
* **柔軟なアクセス制御**: 特定の条件下での一時的な権限付与などの柔軟な制御
* **外部システム連携**: 外部認証システムとの連携