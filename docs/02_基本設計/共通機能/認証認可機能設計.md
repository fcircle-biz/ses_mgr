# SES業務システム 認証・認可機能 基本設計書

## 1. はじめに

本書は、SES業務システムにおける認証・認可機能の基本設計を定義したものである。
システム全体のセキュリティを確保するための認証・認可の仕組みおよび実装方針について記述する。

## 2. 機能概要

認証・認可機能は、SES業務システムにおけるユーザー認証、アクセス制御、セッション管理を担当する
基盤的な共通機能である。本機能により、正当なユーザーのみがシステムにアクセスでき、
かつユーザーの権限に応じた適切なリソースアクセス制御を実現する。

## 3. 認証設計

### 3.1 認証基本方針

SES業務システムでは、以下の認証方式を採用する：

* **認証プロトコル**: OAuth2.0 + OpenID Connect
* **認証方式**: ユーザーID/パスワード認証 + 多要素認証（MFA）
* **セッション管理**: JWTトークンによるステートレスセッション
* **アカウントロック**: 5回連続ログイン失敗でアカウントロック（30分）

### 3.2 JWT認証フロー

1. ユーザーがログイン情報を送信
2. 認証成功時、アクセストークンとリフレッシュトークンを発行
3. 以降のAPIリクエストには、Authorization ヘッダーにアクセストークンを付与
4. アクセストークンの有効期限が切れた場合、リフレッシュトークンを使用して再取得

#### 3.2.1 トークン仕様

* **アクセストークン**:
  * 形式: JWT (JSON Web Token)
  * 署名アルゴリズム: RS256 (RSA-SHA256)
  * 有効期限: 30分
  * 含む情報: ユーザーID、ロール、権限、発行時間、有効期限

* **リフレッシュトークン**:
  * 形式: JWT
  * 署名アルゴリズム: RS256
  * 有効期限: 2週間（remember_me=true の場合は30日）
  * 含む情報: ユーザーID、トークンID、発行時間、有効期限

### 3.3 パスワード管理

パスワードポリシーとして以下の要件を設定する：

* 最小長: 8文字以上
* 文字種: 英大文字、英小文字、数字、記号のうち3種類以上を使用
* 履歴: 過去5回分のパスワードと同一のものは使用不可
* 有効期限: 90日間（期限切れ前7日間から更新可能）
* ハッシュ化: bcryptアルゴリズムを使用（コストパラメータ: 12）

### 3.4 多要素認証（MFA）

以下のユーザーには多要素認証を必須とする：

* システム管理者アカウント
* 経営管理者アカウント
* 特権操作を実行するユーザー

対応する認証要素：

* SMSワンタイムパスワード
* 認証アプリケーション（Google Authenticator等）
* 生体認証（スマートフォン連携、WebAuthn/FIDO2対応）

### 3.5 認証アーキテクチャ

認証サービスは独立したマイクロサービスとして実装し、以下の機能を提供する：

* 集中認証サービス（Single Sign-On）
* ユーザー管理・アカウントライフサイクル管理
* トークン発行・検証
* 多要素認証（MFA）
* アカウントロック管理

## 4. 認可設計

### 4.1 認可基本方針

SES業務システムでは、以下の認可方式を採用する：

* **アクセス制御モデル**: RBAC（Role-Based Access Control）+ ABAC（Attribute-Based Access Control）のハイブリッド
* **権限管理**: ロール単位での権限付与、組織階層に基づくアクセス制御
* **API認可**: OAuth2.0のスコープベースの認可 + JWT クレーム

### 4.2 ロール体系

| ロール区分 | ロール | 主な権限 |
|------------|--------|----------|
| システム管理者 | システム管理者（全体） | 全機能の管理・設定変更 |
| システム管理者 | セキュリティ管理者 | セキュリティ設定、監査ログ管理 |
| 業務管理者 | 営業管理者 | 案件管理機能の管理、営業データの参照/更新 |
| 業務管理者 | 人事管理者 | 技術者管理機能の管理、人事データの参照/更新 |
| 業務管理者 | 経理管理者 | 請求支払機能の管理、経理データの参照/更新 |
| 一般ユーザー | 営業担当者 | 案件情報の登録/更新、担当案件の参照 |
| 一般ユーザー | 人事担当者 | 技術者情報の登録/更新、担当技術者の参照 |
| 一般ユーザー | 経理担当者 | 請求書の作成、入金情報の登録 |
| 一般ユーザー | マッチング担当者 | マッチング機能の利用、提案書作成 |

### 4.3 権限定義

権限は以下の粒度で定義する：

* **機能単位の権限**: 各機能モジュールへのアクセス権限
* **操作単位の権限**: 参照、登録、更新、削除などの操作権限
* **データ単位の権限**: 担当案件、担当技術者などのデータ範囲指定

### 4.4 属性ベースのアクセス制御（ABAC）

RBAC（ロールベース）だけでは表現できない複雑なアクセス制御ケースに対して、ABAC（属性ベース）のアプローチを併用する。以下の属性を考慮したアクセス制御を実装する：

* **ユーザー属性**: 所属部署、役職、雇用形態など
* **リソース属性**: データの種類、機密レベル、所有者など
* **環境属性**: アクセス時間、アクセス元IPアドレス、デバイスタイプなど
* **コンテキスト属性**: 現在のワークフロー状態、関係性など

### 4.5 認可の実装方式

認可の実装には、Spring Securityを採用し、以下のコンポーネントを実装する：

* **認可サービス（AuthorizationService）**: ユーザーの権限チェックを担当
* **セキュリティフィルター**: リクエストごとの認証・認可チェック
* **メソッドセキュリティ**: アノテーションベースの細粒度アクセス制御
* **データフィルタリング**: ユーザーの権限に基づくデータアクセス制限

## 5. API仕様

### 5.1 認証API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/auth/login | POST | ユーザーログイン認証 |
| /api/v1/auth/logout | POST | ユーザーログアウト |
| /api/v1/auth/refresh-token | POST | アクセストークンの更新 |
| /api/v1/auth/profile | GET | ログインユーザーのプロフィール取得 |
| /api/v1/auth/profile | PUT | ログインユーザーのプロフィール更新 |
| /api/v1/auth/password | PUT | パスワード変更 |
| /api/v1/auth/password/reset-request | POST | パスワードリセット要求 |
| /api/v1/auth/password/reset | POST | パスワードリセット実行 |

### 5.2 認可管理API

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| /api/v1/admin/users | GET | ユーザー一覧取得 |
| /api/v1/admin/users/{id} | GET | ユーザー詳細取得 |
| /api/v1/admin/users | POST | ユーザー新規作成 |
| /api/v1/admin/users/{id} | PUT | ユーザー情報更新 |
| /api/v1/admin/users/{id} | DELETE | ユーザー削除 |
| /api/v1/admin/roles | GET | ロール一覧取得 |
| /api/v1/admin/roles/{id} | GET | ロール詳細取得 |
| /api/v1/admin/roles | POST | ロール新規作成 |
| /api/v1/admin/roles/{id} | PUT | ロール情報更新 |
| /api/v1/admin/roles/{id} | DELETE | ロール削除 |
| /api/v1/admin/permissions | GET | 権限一覧取得 |

## 6. 技術的実装

### 6.1 使用技術

* **認証フレームワーク**: Spring Security
* **トークン管理**: JJWT (Java JWT)
* **パスワードハッシュ化**: BCrypt
* **多要素認証**: Google Authenticator / WebAuthn

### 6.2 データモデル

**User（ユーザー）**
```
id: UUID (PK)
email: String (一意)
password_hash: String
name: String
department: String
position: String
phone: String
role_id: UUID (FK -> Role)
last_login_at: Timestamp
mfa_enabled: Boolean
mfa_secret: String (暗号化)
account_locked: Boolean
account_expires_at: Timestamp
password_expires_at: Timestamp
created_at: Timestamp
updated_at: Timestamp
```

**Role（ロール）**
```
id: UUID (PK)
name: String (一意)
description: String
created_at: Timestamp
updated_at: Timestamp
```

**Permission（権限）**
```
id: UUID (PK)
name: String (一意)
description: String
created_at: Timestamp
updated_at: Timestamp
```

**RolePermission（ロール権限関連）**
```
role_id: UUID (PK, FK -> Role)
permission_id: UUID (PK, FK -> Permission)
created_at: Timestamp
```

**RefreshToken（リフレッシュトークン）**
```
id: UUID (PK)
user_id: UUID (FK -> User)
token_hash: String
expires_at: Timestamp
created_at: Timestamp
revoked: Boolean
revoked_at: Timestamp
```

### 6.3 クラス構成

* **AuthController**: 認証関連エンドポイントの制御
* **UserController**: ユーザー管理エンドポイントの制御
* **RoleController**: ロール管理エンドポイントの制御
* **AuthService**: 認証ロジックの実装
* **UserService**: ユーザー管理ロジックの実装
* **RoleService**: ロール管理ロジックの実装
* **JwtTokenProvider**: JWTトークン生成・検証
* **CustomUserDetailsService**: ユーザー詳細情報提供
* **SecurityConfig**: セキュリティ設定
* **JwtAuthenticationFilter**: JWT認証フィルター
* **AuthorizationManager**: 認可判定ロジック

## 7. セキュリティ対策

* **CSRF対策**: トークンベースの保護、SameSite Cookie設定
* **XSS対策**: 適切なエスケープ処理、Content-Security-Policy設定
* **SQLインジェクション対策**: PreparedStatement、パラメータバインディング
* **サイドチャネル攻撃対策**: 定数時間比較、レートリミット
* **監査ログ**: 認証・認可に関する全ての操作を記録
* **セキュアコーディング**: OWASP Top 10対策を実装

## 8. 拡張性と将来対応

* **ソーシャルログイン**: Google、GitHub等の外部IdPとの連携
* **OAuth2.0 認可サーバー**: 外部システム連携のためのOAuth2.0認可機能
* **SAML対応**: 企業向けシングルサインオン（SSO）対応
* **リスクベース認証**: ユーザー行動パターンに基づく適応型認証
* **ユーザー行動分析**: 不正アクセス検知のための行動ベースのセキュリティ

## 9. テスト計画

* **単体テスト**: 各サービスクラスの機能テスト
* **統合テスト**: 認証・認可フローの一貫したテスト
* **セキュリティテスト**: 脆弱性スキャン、ペネトレーションテスト
* **パフォーマンステスト**: 大量リクエスト時の認証・認可処理の応答性能