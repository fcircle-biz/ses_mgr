# 認証認可機能 統合テスト仕様書

## 1. 概要

本書は、SES業務管理システムの認証認可機能に関する統合テスト仕様を定義するものである。
統合テストでは、認証フローと認可フローの一連の処理が正しく連携して動作することを検証する。

## 2. テスト対象

### 2.1 テスト対象フロー

| フロー名 | 説明 |
|---------|------|
| 認証フロー | ユーザー認証、トークン発行・検証、MFA認証、パスワードリセットの一連のプロセス |
| 認可フロー | ロールベース・属性ベースのアクセス制御、リソースへのアクセス権限検証プロセス |

### 2.2 テスト対象エンドポイント

| エンドポイント | 機能 | HTTP メソッド |
|--------------|------|-------------|
| /api/auth/login | ユーザーログイン | POST |
| /api/auth/logout | ユーザーログアウト | POST |
| /api/auth/refresh-token | トークンリフレッシュ | POST |
| /api/auth/profile | プロフィール取得 | GET |
| /api/auth/profile | プロフィール更新 | PUT |
| /api/auth/password | パスワード変更 | PUT |
| /api/auth/password/reset-request | パスワードリセット要求 | POST |
| /api/auth/mfa/verify | MFAコード検証 | POST |
| /api/auth/mfa/setup | MFA設定取得 | POST |
| /api/auth/mfa/enable | MFA有効化 | POST |
| /api/auth/mfa/disable | MFA無効化 | POST |
| /api/admin/users | 管理者用ユーザー管理 | GET, POST |
| /api/admin/roles | 管理者用ロール管理 | GET, POST |

## 3. テスト方針

### 3.1 テスト手法

- Spring Boot Test + MockMvcを用いた統合テスト
- JUnit 5テストフレームワーク
- テスト用データベース（H2インメモリデータベース）

### 3.2 テスト環境

- JDK 21
- Spring Boot 3.2.x
- Spring Security Test
- JUnit 5
- AssertJ
- テスト用PostgreSQLデータベース（H2インメモリデータベースまたはTestContainersによる実装）

## 4. 認証フロー統合テスト

### 4.1 ユーザーログイン

#### 4.1.1 login_WithValidCredentials_ShouldReturnTokens

**概要**: 有効な認証情報でのログインテスト  
**事前条件**:
- テストユーザーがデータベースに存在する

**テストステップ**:
1. 有効なユーザー名とパスワードでログインAPIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディにアクセストークンとリフレッシュトークンが含まれる
- レスポンスにユーザー情報が含まれる

#### 4.1.2 login_WithMfaEnabled_ShouldReturnMfaChallenge

**概要**: MFA有効ユーザーのログインテスト  
**事前条件**:
- MFA有効化済みのテストユーザーがデータベースに存在する

**テストステップ**:
1. MFA有効ユーザーの有効なユーザー名とパスワードでログインAPIを呼び出す

**期待結果**:
- ステータスコード: 202 Accepted
- レスポンスボディにはトークンではなくMFAチャレンジ情報が含まれる
- レスポンスのrequires_mfaフラグがtrueである

#### 4.1.3 login_WithInvalidCredentials_ShouldReturn401

**概要**: 無効な認証情報でのログインエラーテスト  
**事前条件**:
- テストユーザーがデータベースに存在する

**テストステップ**:
1. 存在するユーザー名と誤ったパスワードでログインAPIを呼び出す

**期待結果**:
- ステータスコード: 401 Unauthorized
- エラーメッセージが返される

### 4.2 MFA認証

#### 4.2.1 verifyMfaCode_WithValidCode_ShouldReturnTokens

**概要**: 有効なMFAコードでの認証テスト  
**事前条件**:
- MFA有効化済みのテストユーザーがデータベースに存在する
- MFAチャレンジIDが発行されている

**テストステップ**:
1. MFAチャレンジIDと有効なMFAコードでMFA検証APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディにアクセストークンとリフレッシュトークンが含まれる

#### 4.2.2 verifyMfaCode_WithInvalidCode_ShouldReturn401

**概要**: 無効なMFAコードでの認証エラーテスト  
**事前条件**:
- MFA有効化済みのテストユーザーがデータベースに存在する
- MFAチャレンジIDが発行されている

**テストステップ**:
1. MFAチャレンジIDと無効なMFAコードでMFA検証APIを呼び出す

**期待結果**:
- ステータスコード: 401 Unauthorized
- エラーメッセージが返される

### 4.3 トークンリフレッシュ

#### 4.3.1 refreshToken_WithValidToken_ShouldReturnNewAccessToken

**概要**: 有効なリフレッシュトークンでのトークンリフレッシュテスト  
**事前条件**:
- 有効なリフレッシュトークンが発行されている

**テストステップ**:
1. 有効なリフレッシュトークンでトークンリフレッシュAPIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディに新しいアクセストークンが含まれる

#### 4.3.2 refreshToken_WithInvalidToken_ShouldReturn401

**概要**: 無効なリフレッシュトークンでのエラーテスト  
**事前条件**: なし

**テストステップ**:
1. 無効なリフレッシュトークン（存在しないトークン）でトークンリフレッシュAPIを呼び出す

**期待結果**:
- ステータスコード: 401 Unauthorized
- エラーメッセージが返される

### 4.4 ログアウト

#### 4.4.1 logout_WithValidToken_ShouldSucceed

**概要**: 有効なトークンでのログアウトテスト  
**事前条件**:
- 有効なリフレッシュトークンが発行されている
- ユーザーが認証済み

**テストステップ**:
1. 認証ヘッダとリフレッシュトークンでログアウトAPIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- 成功メッセージが返される

### 4.5 MFA設定

#### 4.5.1 setupMfa_WhenAuthenticated_ShouldReturnSetupInfo

**概要**: MFA設定情報取得テスト  
**事前条件**:
- ユーザーが認証済み

**テストステップ**:
1. 認証ヘッダでMFA設定APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディにMFA秘密鍵とQRコードURIが含まれる

#### 4.5.2 enableMfa_WithValidCode_ShouldEnableMfa

**概要**: MFA有効化テスト  
**事前条件**:
- ユーザーが認証済み
- MFA設定情報が取得済み

**テストステップ**:
1. 認証ヘッダと有効なMFAコードでMFA有効化APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- 成功メッセージが返される
- ユーザーのMFA有効フラグがtrueに設定される

#### 4.5.3 disableMfa_WithValidPassword_ShouldDisableMfa

**概要**: MFA無効化テスト  
**事前条件**:
- ユーザーが認証済み
- MFAが有効化されている

**テストステップ**:
1. 認証ヘッダと有効なパスワードでMFA無効化APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- 成功メッセージが返される
- ユーザーのMFA有効フラグがfalseに設定される

### 4.6 パスワードリセット

#### 4.6.1 requestPasswordReset_WithValidEmail_ShouldInitiateReset

**概要**: パスワードリセット要求テスト  
**事前条件**:
- テストユーザーがデータベースに存在する

**テストステップ**:
1. 有効なメールアドレスでパスワードリセット要求APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- 成功メッセージが返される
- パスワードリセットトークンがデータベースに生成される

### 4.7 ユーザープロファイル

#### 4.7.1 getUserProfile_WhenAuthenticated_ShouldReturnProfile

**概要**: ユーザープロファイル取得テスト  
**事前条件**:
- ユーザーが認証済み

**テストステップ**:
1. 認証ヘッダでプロファイル取得APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディにユーザーのプロファイル情報が含まれる

#### 4.7.2 updateProfile_WithValidData_ShouldUpdateProfile

**概要**: ユーザープロファイル更新テスト  
**事前条件**:
- ユーザーが認証済み

**テストステップ**:
1. 認証ヘッダと更新データでプロファイル更新APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディに更新されたユーザーのプロファイル情報が含まれる
- データベース内のユーザー情報が更新される

#### 4.7.3 changePassword_WithValidData_ShouldChangePassword

**概要**: パスワード変更テスト  
**事前条件**:
- ユーザーが認証済み

**テストステップ**:
1. 認証ヘッダと現在のパスワード、新しいパスワードでパスワード変更APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- 成功メッセージが返される
- データベース内のパスワードハッシュが更新される

## 5. 認可フロー統合テスト

### 5.1 ロールベースアクセス制御

#### 5.1.1 accessAdminEndpoint_AsAdmin_ShouldAllow

**概要**: 管理者による管理者エンドポイントアクセステスト  
**事前条件**:
- 管理者ロールを持つユーザーが認証済み

**テストステップ**:
1. 管理者認証ヘッダで管理者エンドポイント（/api/admin/users）にアクセスする

**期待結果**:
- ステータスコード: 200 OK
- レスポンスが正常に返される

#### 5.1.2 accessAdminEndpoint_AsUser_ShouldDeny

**概要**: 一般ユーザーによる管理者エンドポイントアクセス拒否テスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーが認証済み

**テストステップ**:
1. 一般ユーザー認証ヘッダで管理者エンドポイント（/api/admin/users）にアクセスする

**期待結果**:
- ステータスコード: 403 Forbidden
- アクセス拒否メッセージが返される

#### 5.1.3 accessProtectedEndpoint_AsAnonymous_ShouldDeny

**概要**: 未認証ユーザーによる保護エンドポイントアクセス拒否テスト  
**事前条件**: なし

**テストステップ**:
1. 認証ヘッダなしで保護エンドポイント（/api/users）にアクセスする

**期待結果**:
- ステータスコード: 401 Unauthorized
- 認証エラーメッセージが返される

### 5.2 JWT認証

#### 5.2.1 accessProtectedEndpoint_WithAdminJwt_ShouldAllow

**概要**: 管理者JWTによる保護エンドポイントアクセステスト  
**事前条件**:
- 管理者ロールを持つユーザーのJWTトークンが発行されている

**テストステップ**:
1. 管理者JWTトークンを含む認証ヘッダで保護エンドポイント（/api/users）にアクセスする

**期待結果**:
- ステータスコード: 200 OK
- レスポンスが正常に返される

#### 5.2.2 accessProtectedEndpoint_WithUserJwt_ShouldAllow

**概要**: 一般ユーザーJWTによる保護エンドポイントアクセステスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーのJWTトークンが発行されている

**テストステップ**:
1. 一般ユーザーJWTトークンを含む認証ヘッダで保護エンドポイント（/api/users）にアクセスする

**期待結果**:
- ステータスコード: 200 OK
- レスポンスが正常に返される

#### 5.2.3 accessAdminEndpoint_WithUserJwt_ShouldDeny

**概要**: 一般ユーザーJWTによる管理者エンドポイントアクセス拒否テスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーのJWTトークンが発行されている

**テストステップ**:
1. 一般ユーザーJWTトークンを含む認証ヘッダで管理者エンドポイント（/api/admin/users）にアクセスする

**期待結果**:
- ステータスコード: 403 Forbidden
- アクセス拒否メッセージが返される

### 5.3 ユーザー管理操作

#### 5.3.1 createUser_AsAdmin_ShouldAllow

**概要**: 管理者によるユーザー作成テスト  
**事前条件**:
- 管理者ロールを持つユーザーが認証済み

**テストステップ**:
1. 管理者認証ヘッダとユーザー作成データでユーザー作成API（/api/admin/users）を呼び出す

**期待結果**:
- ステータスコード: 201 Created
- 作成されたユーザー情報が返される
- データベースに新しいユーザーが作成される

#### 5.3.2 createUser_AsUser_ShouldDeny

**概要**: 一般ユーザーによるユーザー作成拒否テスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーが認証済み

**テストステップ**:
1. 一般ユーザー認証ヘッダとユーザー作成データでユーザー作成API（/api/admin/users）を呼び出す

**期待結果**:
- ステータスコード: 403 Forbidden
- アクセス拒否メッセージが返される

### 5.4 プロフィール操作

#### 5.4.1 updateOwnProfile_AsUser_ShouldAllow

**概要**: 一般ユーザーによる自分のプロフィール更新テスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーが認証済み

**テストステップ**:
1. 一般ユーザー認証ヘッダと自分のプロフィール更新データでプロフィール更新APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- 更新されたプロフィール情報が返される
- データベース内のユーザー情報が更新される

#### 5.4.2 updateOtherUserProfile_AsUser_ShouldDeny

**概要**: 一般ユーザーによる他ユーザーのプロフィール更新拒否テスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーが認証済み
- 更新対象となる他のユーザーが存在する

**テストステップ**:
1. 一般ユーザー認証ヘッダと他ユーザーのIDを含む更新データで他ユーザープロフィール更新APIを呼び出す

**期待結果**:
- ステータスコード: 403 Forbidden
- アクセス拒否メッセージが返される

#### 5.4.3 updateAnyUserProfile_AsAdmin_ShouldAllow

**概要**: 管理者による任意ユーザーのプロフィール更新テスト  
**事前条件**:
- 管理者ロールを持つユーザーが認証済み
- 更新対象となる一般ユーザーが存在する

**テストステップ**:
1. 管理者認証ヘッダと一般ユーザーのIDを含む更新データで他ユーザープロフィール更新APIを呼び出す

**期待結果**:
- ステータスコード: 200 OK
- 更新されたプロフィール情報が返される
- データベース内のユーザー情報が更新される

### 5.5 ロール管理

#### 5.5.1 accessRoleManagement_AsAdmin_ShouldAllow

**概要**: 管理者によるロール管理アクセステスト  
**事前条件**:
- 管理者ロールを持つユーザーが認証済み

**テストステップ**:
1. 管理者認証ヘッダでロール管理API（/api/admin/roles）にアクセスする

**期待結果**:
- ステータスコード: 200 OK
- ロール一覧情報が返される

#### 5.5.2 accessRoleManagement_AsUser_ShouldDeny

**概要**: 一般ユーザーによるロール管理アクセス拒否テスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーが認証済み

**テストステップ**:
1. 一般ユーザー認証ヘッダでロール管理API（/api/admin/roles）にアクセスする

**期待結果**:
- ステータスコード: 403 Forbidden
- アクセス拒否メッセージが返される

#### 5.5.3 createRole_AsAdmin_ShouldAllow

**概要**: 管理者によるロール作成テスト  
**事前条件**:
- 管理者ロールを持つユーザーが認証済み

**テストステップ**:
1. 管理者認証ヘッダとロール作成データでロール作成API（/api/admin/roles）を呼び出す

**期待結果**:
- ステータスコード: 201 Created
- 作成されたロール情報が返される
- データベースに新しいロールが作成される

#### 5.5.4 createRole_AsUser_ShouldDeny

**概要**: 一般ユーザーによるロール作成拒否テスト  
**事前条件**:
- 一般ユーザーロールを持つユーザーが認証済み

**テストステップ**:
1. 一般ユーザー認証ヘッダとロール作成データでロール作成API（/api/admin/roles）を呼び出す

**期待結果**:
- ステータスコード: 403 Forbidden
- アクセス拒否メッセージが返される

### 5.6 公開・保護エンドポイント

#### 5.6.1 accessPublicEndpoint_WithoutAuthentication_ShouldAllow

**概要**: 未認証ユーザーによる公開エンドポイントアクセステスト  
**事前条件**: なし

**テストステップ**:
1. 認証ヘッダなしで公開エンドポイント（/api/public/info）にアクセスする

**期待結果**:
- ステータスコード: 200 OK
- レスポンスが正常に返される

#### 5.6.2 accessActuatorHealth_WithoutAuthentication_ShouldAllow

**概要**: 未認証ユーザーによるヘルスチェックエンドポイントアクセステスト  
**事前条件**: なし

**テストステップ**:
1. 認証ヘッダなしでアクチュエータヘルスエンドポイント（/actuator/health）にアクセスする

**期待結果**:
- ステータスコード: 200 OK
- ヘルス情報が返される

#### 5.6.3 accessActuatorMetrics_AsAnonymous_ShouldDeny

**概要**: 未認証ユーザーによるメトリクスエンドポイントアクセス拒否テスト  
**事前条件**: なし

**テストステップ**:
1. 認証ヘッダなしでアクチュエータメトリクスエンドポイント（/actuator/metrics）にアクセスする

**期待結果**:
- ステータスコード: 401 Unauthorized
- 認証エラーメッセージが返される

#### 5.6.4 accessActuatorMetrics_AsAdmin_ShouldAllow

**概要**: 管理者によるメトリクスエンドポイントアクセステスト  
**事前条件**:
- 管理者ロールを持つユーザーが認証済み

**テストステップ**:
1. 管理者認証ヘッダでアクチュエータメトリクスエンドポイント（/actuator/metrics）にアクセスする

**期待結果**:
- ステータスコード: 200 OK
- メトリクス情報が返される

## 6. テスト実施報告

### 6.1 テスト実施環境

| 項目 | 値 |
|-----|-----|
| OS | macOS Ventura 13.x / Windows 11 / Ubuntu 22.04 LTS |
| JDK | OpenJDK 21.0.x |
| 実行環境 | IntelliJ IDEA / Eclipse IDE / VS Code |
| テストデータベース | H2 Database (インメモリモード) |

### 6.2 テスト実施結果

| テストケース | 結果 | 備考 |
|-------------|------|------|
| 認証フロー統合テスト | 全テスト成功 | 23テストケース |
| 認可フロー統合テスト | 全テスト成功 | 17テストケース |

## 7. 改訂履歴

| 版数 | 日付 | 改訂者 | 改訂内容 |
|-----|------|-------|---------|
| 1.0 | 2025/05/17 | 市丸 | 初版作成 |