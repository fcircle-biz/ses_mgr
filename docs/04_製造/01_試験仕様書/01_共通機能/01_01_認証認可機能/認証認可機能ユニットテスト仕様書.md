# 認証認可機能 ユニットテスト仕様書

## 1. 概要

本書は、SES業務管理システムの認証認可機能に関するユニットテスト仕様を定義するものである。
認証認可機能は、システムの中核となるセキュリティ機能であり、適切な認証と認可の実施によって、システムのセキュリティを担保する。

## 2. テスト対象

### 2.1 テスト対象モジュール

| モジュール名 | 説明 |
|------------|------|
| JwtProviderImpl | JWT（JSON Web Token）の生成、検証、解析を担当するサービス |
| UserDetailsServiceImpl | Spring SecurityのUserDetailsServiceインターフェースの実装 |
| AuthenticationServiceImpl | ユーザー認証プロセスを統括するサービス |
| MfaService | 多要素認証（TOTP）の機能を提供するサービス |
| PasswordResetServiceImpl | パスワードリセット機能を提供するサービス |
| AuthorizationService | ユーザー権限確認機能を提供するサービス |

### 2.2 テスト対象外

- UIコンポーネント（Thymeleafテンプレート）
- 外部システム連携（メールサービスなど）
- パフォーマンステスト
- セキュリティ脆弱性テスト（これらは別途セキュリティテスト計画にて実施）

## 3. テスト方針

### 3.1 テスト手法

- JUnit 5を用いたユニットテスト
- Mockitoを利用した依存コンポーネントのモック化
- AssertJによるアサーション

### 3.2 テストカバレッジ目標

- コード行カバレッジ: 85%以上
- 分岐カバレッジ: 80%以上
- メソッドカバレッジ: 90%以上

## 4. テスト環境

- JDK 21
- Spring Boot 3.2.x
- JUnit 5
- Mockito
- AssertJ
- テスト用PostgreSQLデータベース
  - リポジトリ層テストでは専用のPostgreSQLテストデータベース（ses_mgr_test）を使用
  - テストプロファイル（test）で分離された環境を使用

## 5. テスト仕様

### 5.1 JwtProviderImplTest

#### 5.1.1 generateAccessToken_ShouldGenerateValidToken

**概要**: アクセストークン生成機能の正常系テスト  
**入力条件**:
- ユーザー情報
- 権限リスト

**期待結果**:
- 有効なJWTトークンが生成されること
- トークンの検証が成功すること
- トークンに正しいクレーム（sub, iat, exp, iss, userId, role, email, name, permissions）が含まれていること

#### 5.1.2 generateAccessToken_WithoutPermissions_ShouldGenerateValidToken

**概要**: 権限なしでのアクセストークン生成テスト  
**入力条件**:
- ユーザー情報
- 権限リスト = null または空

**期待結果**:
- 有効なJWTトークンが生成されること
- トークンにパーミッションクレームが含まれないこと

#### 5.1.3 generateRefreshToken_ShouldGenerateValidToken

**概要**: リフレッシュトークン生成機能の正常系テスト  
**入力条件**:
- ユーザー情報

**期待結果**:
- 有効なリフレッシュトークンが生成されること
- トークンの検証が成功すること
- トークンに正しいクレームが含まれていること
- トークンの有効期限がアクセストークンより長いこと

#### 5.1.4 validateToken_WithValidToken_ShouldReturnTrue

**概要**: 有効なトークンの検証テスト  
**入力条件**:
- 有効期限内の正しく署名されたトークン

**期待結果**:
- 検証結果がtrueを返すこと

#### 5.1.5 validateToken_WithExpiredToken_ShouldReturnFalse

**概要**: 期限切れトークンの検証テスト  
**入力条件**:
- 有効期限切れのトークン

**期待結果**:
- 検証結果がfalseを返すこと

#### 5.1.6 validateToken_WithInvalidSignature_ShouldReturnFalse

**概要**: 不正な署名のトークン検証テスト  
**入力条件**:
- 不正な署名のトークン

**期待結果**:
- 検証結果がfalseを返すこと

#### 5.1.7 validateToken_WithMalformedToken_ShouldReturnFalse

**概要**: 不正な形式のトークン検証テスト  
**入力条件**:
- 不正な形式のトークン文字列

**期待結果**:
- 検証結果がfalseを返すこと

#### 5.1.8 getEmailFromToken_ShouldReturnEmail

**概要**: トークンからのメールアドレス抽出テスト  
**入力条件**:
- 有効なトークン（subjectがメールアドレス）

**期待結果**:
- トークンからメールアドレスが正しく抽出されること

#### 5.1.9 getUserIdFromToken_ShouldReturnUserId

**概要**: トークンからのユーザーID抽出テスト  
**入力条件**:
- 有効なトークン（userIdクレームあり）

**期待結果**:
- トークンからユーザーIDが正しく抽出されること

#### 5.1.10 getRoleFromToken_ShouldReturnRole

**概要**: トークンからのロール抽出テスト  
**入力条件**:
- 有効なトークン（roleクレームあり）

**期待結果**:
- トークンからロールが正しく抽出されること

### 5.2 UserDetailsServiceImplTest

#### 5.2.1 loadUserByUsername_WithValidEmail_ShouldReturnUserDetails

**概要**: 有効なメールアドレスでのユーザー詳細読み込みテスト  
**入力条件**:
- 存在するユーザーのメールアドレス

**期待結果**:
- 対応するUserDetailsオブジェクトが返されること
- UserDetailsの各プロパティ（ユーザー名、パスワード、権限、アカウント状態フラグ）が正しく設定されていること

#### 5.2.2 loadUserByUsername_WithNonExistentEmail_ShouldThrowException

**概要**: 存在しないメールアドレスでのエラーハンドリングテスト  
**入力条件**:
- 存在しないユーザーのメールアドレス

**期待結果**:
- UsernameNotFoundExceptionがスローされること

#### 5.2.3 loadUserByUsername_WithLockedAccount_ShouldReturnLockedUserDetails

**概要**: ロックされたアカウントの状態フラグテスト  
**入力条件**:
- ロックされたアカウントのメールアドレス

**期待結果**:
- UserDetailsのisAccountNonLockedがfalseに設定されていること

#### 5.2.4 loadUserByUsername_WithDisabledAccount_ShouldReturnDisabledUserDetails

**概要**: 無効化されたアカウントの状態フラグテスト  
**入力条件**:
- 無効化されたアカウントのメールアドレス

**期待結果**:
- UserDetailsのisEnabledがfalseに設定されていること

#### 5.2.5 loadUserByUsername_WithExpiredAccount_ShouldReturnExpiredUserDetails

**概要**: 期限切れアカウントの状態フラグテスト  
**入力条件**:
- 期限切れアカウントのメールアドレス

**期待結果**:
- UserDetailsのisAccountNonExpiredがfalseに設定されていること

#### 5.2.6 loadUserByUsername_WithExpiredCredentials_ShouldReturnExpiredCredentialsUserDetails

**概要**: 期限切れ認証情報の状態フラグテスト  
**入力条件**:
- 認証情報が期限切れのアカウントのメールアドレス

**期待結果**:
- UserDetailsのisCredentialsNonExpiredがfalseに設定されていること

#### 5.2.7 getAuthorities_ForAdminRole_ShouldReturnAllPermissions

**概要**: 管理者ロールの権限マッピングテスト  
**入力条件**:
- 管理者ロールを持つユーザー

**期待結果**:
- 全てのシステム権限を含む権限リストが返されること

#### 5.2.8 getAuthorities_ForUserRole_ShouldReturnLimitedPermissions

**概要**: 一般ユーザーロールの権限マッピングテスト  
**入力条件**:
- 一般ユーザーロールを持つユーザー

**期待結果**:
- 一般ユーザーに割り当てられた限定的な権限リストが返されること

### 5.3 AuthenticationServiceImplTest

#### 5.3.1 authenticate_WithValidCredentials_ShouldReturnTokens

**概要**: 有効な認証情報での認証テスト  
**入力条件**:
- 有効なユーザー名/メールアドレスとパスワード

**期待結果**:
- 認証が成功すること
- アクセストークンとリフレッシュトークンを含む認証レスポンスが返されること
- 最終ログイン日時が更新されること
- 失敗ログイン試行回数がリセットされること

#### 5.3.2 authenticate_WithInvalidPassword_ShouldThrowAuthenticationException

**概要**: 無効なパスワードでの認証エラーテスト  
**入力条件**:
- 存在するユーザーと無効なパスワード

**期待結果**:
- AuthenticationExceptionがスローされること
- 失敗ログイン試行回数が増加すること

#### 5.3.3 authenticate_WithNonExistentUser_ShouldThrowAuthenticationException

**概要**: 存在しないユーザーでの認証エラーテスト  
**入力条件**:
- 存在しないユーザー名/メールアドレス

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.3.4 authenticate_WithLockedAccount_ShouldThrowAuthenticationException

**概要**: ロックされたアカウントでの認証エラーテスト  
**入力条件**:
- ロックされたアカウントのユーザー名/メールアドレスと正しいパスワード

**期待結果**:
- AuthenticationExceptionがスローされ、アカウントがロックされている旨のメッセージが含まれること

#### 5.3.5 authenticate_WithDisabledAccount_ShouldThrowAuthenticationException

**概要**: 無効化されたアカウントでの認証エラーテスト  
**入力条件**:
- 無効化されたアカウントのユーザー名/メールアドレスと正しいパスワード

**期待結果**:
- AuthenticationExceptionがスローされ、アカウントが無効である旨のメッセージが含まれること

#### 5.3.6 authenticate_WithExpiredAccount_ShouldThrowAuthenticationException

**概要**: 期限切れアカウントでの認証エラーテスト  
**入力条件**:
- 期限切れアカウントのユーザー名/メールアドレスと正しいパスワード

**期待結果**:
- AuthenticationExceptionがスローされ、アカウントが期限切れである旨のメッセージが含まれること

#### 5.3.7 authenticate_WithMfaEnabled_ShouldReturnMfaChallenge

**概要**: MFA有効時の認証フローテスト  
**入力条件**:
- MFA有効なユーザーの有効な認証情報

**期待結果**:
- 通常のトークンではなくMFAチャレンジが返されること
- レスポンスのrequiresMfaフラグがtrueであること

#### 5.3.8 authenticateWithMfa_WithValidMfaCode_ShouldReturnTokens

**概要**: 有効なMFAコードでの二段階認証完了テスト  
**入力条件**:
- 有効なMFAチャレンジID
- 有効なMFAコード

**期待結果**:
- 認証が成功すること
- アクセストークンとリフレッシュトークンを含む認証レスポンスが返されること

#### 5.3.9 authenticateWithMfa_WithInvalidMfaCode_ShouldThrowAuthenticationException

**概要**: 無効なMFAコードでの認証エラーテスト  
**入力条件**:
- 有効なMFAチャレンジID
- 無効なMFAコード

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.3.10 authenticateWithMfa_WithExpiredChallenge_ShouldThrowAuthenticationException

**概要**: 期限切れMFAチャレンジでの認証エラーテスト  
**入力条件**:
- 期限切れのMFAチャレンジID
- 有効なMFAコード

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.3.11 refreshToken_WithValidToken_ShouldReturnNewAccessToken

**概要**: 有効なリフレッシュトークンでのトークンリフレッシュテスト  
**入力条件**:
- 有効なリフレッシュトークン

**期待結果**:
- 新しいアクセストークンを含む認証レスポンスが返されること
- リフレッシュトークンの最終使用日時が更新されること

#### 5.3.12 refreshToken_WithInvalidToken_ShouldThrowAuthenticationException

**概要**: 無効なリフレッシュトークンでのエラーテスト  
**入力条件**:
- 存在しないリフレッシュトークン

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.3.13 refreshToken_WithExpiredToken_ShouldThrowAuthenticationException

**概要**: 期限切れリフレッシュトークンでのエラーテスト  
**入力条件**:
- 期限切れのリフレッシュトークン

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.3.14 refreshToken_WithRevokedToken_ShouldThrowAuthenticationException

**概要**: 無効化されたリフレッシュトークンでのエラーテスト  
**入力条件**:
- 無効化されたリフレッシュトークン

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.3.15 logout_ShouldRevokeRefreshToken

**概要**: ログアウト処理のリフレッシュトークン無効化テスト  
**入力条件**:
- 有効なリフレッシュトークン

**期待結果**:
- リフレッシュトークンが無効化されること
- ログアウトイベントが記録されること

#### 5.3.16 updateFailedLoginAttempts_ShouldIncrementCounter

**概要**: ログイン失敗カウンター増加テスト  
**入力条件**:
- 既存ユーザー

**期待結果**:
- 失敗ログイン試行回数が1増加すること

#### 5.3.17 updateFailedLoginAttempts_WhenMaxAttempts_ShouldLockAccount

**概要**: 最大ログイン失敗時のアカウントロックテスト  
**入力条件**:
- 既存ユーザー
- 現在の失敗回数 = 最大試行回数 - 1

**期待結果**:
- 失敗ログイン試行回数が増加すること
- アカウントがロックされること
- ロック日時が設定されること

#### 5.3.18 changePassword_WithValidOldPassword_ShouldUpdatePassword

**概要**: パスワード変更の正常系テスト  
**入力条件**:
- 有効な現在のパスワード
- 新しいパスワード

**期待結果**:
- パスワードが正常に変更されること
- パスワード有効期限が更新されること

#### 5.3.19 changePassword_WithInvalidOldPassword_ShouldThrowAuthenticationException

**概要**: 不正な現在パスワードでのパスワード変更エラーテスト  
**入力条件**:
- 無効な現在のパスワード
- 新しいパスワード

**期待結果**:
- AuthenticationExceptionがスローされること

### 5.4 MfaServiceTest

#### 5.4.1 generateSecretKey_ShouldGenerateBase32EncodedString

**概要**: TOTP秘密鍵生成テスト  
**入力条件**: なし

**期待結果**:
- Base32エンコードされた文字列が生成されること
- 文字列長が適切であること

#### 5.4.2 generateQrCodeUri_ShouldReturnValidOtpauthUri

**概要**: QRコードURI生成テスト  
**入力条件**:
- ユーザー名（メールアドレス）
- 秘密鍵

**期待結果**:
- 有効なotpauth://形式のURIが生成されること
- URIに正しいパラメータ（secret, issuer, algorithm, digits, period）が含まれていること

#### 5.4.3 generateMfaSetup_ShouldReturnCompleteSetupInfo

**概要**: MFA設定情報生成テスト  
**入力条件**:
- ユーザー情報

**期待結果**:
- 秘密鍵とQRコードURIを含むMFAセットアップレスポンスが返されること

#### 5.4.4 generateTotpCode_ShouldGenerateSixDigitCode

**概要**: TOTPコード生成テスト  
**入力条件**:
- 秘密鍵

**期待結果**:
- 6桁の数字コードが生成されること

#### 5.4.5 generateTotpCode_WithSameSecretAndTimeStep_ShouldGenerateSameCode

**概要**: 同一条件でのTOTPコード一貫性テスト  
**入力条件**:
- 秘密鍵
- 時間ステップ

**期待結果**:
- 同じ秘密鍵と時間ステップで同じコードが生成されること

#### 5.4.6 generateTotpCode_WithDifferentTimeSteps_ShouldGenerateDifferentCodes

**概要**: 異なる時間ステップでのTOTPコード変化テスト  
**入力条件**:
- 秘密鍵
- 異なる時間ステップ

**期待結果**:
- 異なる時間ステップで異なるコードが生成されること

#### 5.4.7 generateTotpCode_WithDifferentSecrets_ShouldGenerateDifferentCodes

**概要**: 異なる秘密鍵でのTOTPコード変化テスト  
**入力条件**:
- 異なる秘密鍵
- 同じ時間ステップ

**期待結果**:
- 異なる秘密鍵で異なるコードが生成されること

#### 5.4.8 verifyTotpCode_WithValidCode_ShouldReturnTrue

**概要**: 有効なTOTPコード検証テスト  
**入力条件**:
- 秘密鍵
- 現在の時間ステップで生成した有効なコード

**期待結果**:
- 検証結果がtrueを返すこと

#### 5.4.9 verifyTotpCode_WithPreviousTimeStepCode_ShouldReturnTrue

**概要**: 直前の時間ステップのTOTPコード検証テスト  
**入力条件**:
- 秘密鍵
- 直前の時間ステップで生成したコード

**期待結果**:
- 検証結果がtrueを返すこと（許容範囲内の時間ずれ）

#### 5.4.10 verifyTotpCode_WithNextTimeStepCode_ShouldReturnTrue

**概要**: 次の時間ステップのTOTPコード検証テスト  
**入力条件**:
- 秘密鍵
- 次の時間ステップで生成したコード

**期待結果**:
- 検証結果がtrueを返すこと（許容範囲内の時間ずれ）

#### 5.4.11 verifyTotpCode_WithOutOfRangeTimeStepCode_ShouldReturnFalse

**概要**: 許容範囲外の時間ステップのTOTPコード検証テスト  
**入力条件**:
- 秘密鍵
- 許容範囲外の時間ステップで生成したコード

**期待結果**:
- 検証結果がfalseを返すこと

#### 5.4.12 verifyTotpCode_WithInvalidLength_ShouldReturnFalse

**概要**: 不正な長さのTOTPコード検証テスト  
**入力条件**:
- 秘密鍵
- 6桁でないコード（短すぎる/長すぎる）

**期待結果**:
- 検証結果がfalseを返すこと

### 5.5 PasswordResetServiceImplTest

#### 5.5.1 createPasswordResetToken_ShouldCreateNewToken

**概要**: パスワードリセットトークン生成テスト  
**入力条件**:
- 有効なメールアドレス

**期待結果**:
- 新しいパスワードリセットトークンが生成されること
- トークンの有効期限が正しく設定されていること

#### 5.5.2 createPasswordResetToken_WithExistingValidToken_ShouldInvalidateOldToken

**概要**: 既存トークン無効化テスト  
**入力条件**:
- 既存の有効なトークンを持つユーザーのメールアドレス

**期待結果**:
- 既存トークンが使用済みとしてマークされること
- 新しいトークンが生成されること

#### 5.5.3 createPasswordResetToken_UserNotFound_ShouldThrowException

**概要**: 存在しないユーザーのトークン生成エラーテスト  
**入力条件**:
- 存在しないユーザーのメールアドレス

**期待結果**:
- ResourceNotFoundExceptionがスローされること

#### 5.5.4 validatePasswordResetToken_WithValidToken_ShouldReturnTrue

**概要**: 有効なパスワードリセットトークン検証テスト  
**入力条件**:
- 有効なトークン文字列
- 対応するユーザーのメールアドレス

**期待結果**:
- 検証結果がtrueを返すこと

#### 5.5.5 validatePasswordResetToken_WithExpiredToken_ShouldReturnFalse

**概要**: 期限切れパスワードリセットトークン検証テスト  
**入力条件**:
- 期限切れのトークン文字列
- 対応するユーザーのメールアドレス

**期待結果**:
- 検証結果がfalseを返すこと

#### 5.5.6 validatePasswordResetToken_WithUsedToken_ShouldReturnFalse

**概要**: 使用済みパスワードリセットトークン検証テスト  
**入力条件**:
- 使用済みのトークン文字列
- 対応するユーザーのメールアドレス

**期待結果**:
- 検証結果がfalseを返すこと

#### 5.5.7 validatePasswordResetToken_TokenNotFound_ShouldReturnFalse

**概要**: 存在しないパスワードリセットトークン検証テスト  
**入力条件**:
- 存在しないトークン文字列
- 有効なユーザーのメールアドレス

**期待結果**:
- 検証結果がfalseを返すこと

#### 5.5.8 validatePasswordResetToken_UserNotFound_ShouldThrowException

**概要**: 存在しないユーザーのトークン検証エラーテスト  
**入力条件**:
- 有効なトークン文字列
- 存在しないユーザーのメールアドレス

**期待結果**:
- ResourceNotFoundExceptionがスローされること

#### 5.5.9 resetPassword_WithValidToken_ShouldChangePasswordAndInvalidateToken

**概要**: パスワードリセット正常系テスト  
**入力条件**:
- 有効なトークン文字列
- 対応するユーザーのメールアドレス
- 新しいパスワード

**期待結果**:
- パスワードが正常に変更されること
- トークンが使用済みとしてマークされること

#### 5.5.10 resetPassword_WithExpiredToken_ShouldThrowException

**概要**: 期限切れトークンでのパスワードリセットエラーテスト  
**入力条件**:
- 期限切れのトークン文字列
- 対応するユーザーのメールアドレス
- 新しいパスワード

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.5.11 resetPassword_WithUsedToken_ShouldThrowException

**概要**: 使用済みトークンでのパスワードリセットエラーテスト  
**入力条件**:
- 使用済みのトークン文字列
- 対応するユーザーのメールアドレス
- 新しいパスワード

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.5.12 resetPassword_TokenNotFound_ShouldThrowException

**概要**: 存在しないトークンでのパスワードリセットエラーテスト  
**入力条件**:
- 存在しないトークン文字列
- 有効なユーザーのメールアドレス
- 新しいパスワード

**期待結果**:
- AuthenticationExceptionがスローされること

#### 5.5.13 resetPassword_UserNotFound_ShouldThrowException

**概要**: 存在しないユーザーのパスワードリセットエラーテスト  
**入力条件**:
- 有効なトークン文字列
- 存在しないユーザーのメールアドレス
- 新しいパスワード

**期待結果**:
- ResourceNotFoundExceptionがスローされること

#### 5.5.14 getUserByResetToken_WithValidToken_ShouldReturnUser

**概要**: トークンからのユーザー取得テスト  
**入力条件**:
- 有効なトークン文字列

**期待結果**:
- 対応するユーザーが返されること

#### 5.5.15 getUserByResetToken_TokenNotFound_ShouldThrowException

**概要**: 存在しないトークンからのユーザー取得エラーテスト  
**入力条件**:
- 存在しないトークン文字列

**期待結果**:
- ResourceNotFoundExceptionがスローされること

#### 5.5.16 getUserByResetToken_UserNotFound_ShouldThrowException

**概要**: トークンに対応するユーザーが存在しない場合のエラーテスト  
**入力条件**:
- 有効なトークン文字列（対応するユーザーは存在しない）

**期待結果**:
- ResourceNotFoundExceptionがスローされること

## 6. 統合テスト

認証認可機能の統合テストに関しては、別途「認証認可機能_統合テスト仕様書.md」にて定義する。

## 7. テスト実施報告

### 7.1 テスト実施環境

| 項目 | 値 |
|-----|-----|
| OS | macOS Ventura 13.x / Windows 11 / Ubuntu 22.04 LTS |
| JDK | OpenJDK 21.0.x |
| 実行環境 | IntelliJ IDEA / Eclipse IDE / VS Code |
| テストデータベース | PostgreSQL 17 (ses_mgr_test) |
| テストプロファイル | test（application-test.yml） |

### 7.2 テスト実施結果

| テストケース | 結果 | 備考 |
|-------------|------|------|
| JwtProviderImplTest | 全テスト成功 | カバレッジ：92% |
| UserDetailsServiceImplTest | 全テスト成功 | カバレッジ：88% |
| AuthenticationServiceImplTest | 全テスト成功 | カバレッジ：91% |
| MfaServiceTest | 全テスト成功 | カバレッジ：95% |
| PasswordResetServiceImplTest | 全テスト成功 | カバレッジ：89% |
| JdbcUserRepositoryTest | 全テスト成功 | PostgreSQLテストDB使用 |
| JdbcRoleRepositoryTest | 全テスト成功 | PostgreSQLテストDB使用 |
| JdbcPermissionRepositoryTest | 全テスト成功 | PostgreSQLテストDB使用 |
| JdbcRefreshTokenRepositoryTest | 全テスト成功 | PostgreSQLテストDB使用 |
| JdbcPasswordResetTokenRepositoryTest | 全テスト成功 | PostgreSQLテストDB使用 |

### 7.3 テストカバレッジ

| カバレッジ種別 | 結果 | 目標 |
|--------------|------|------|
| コード行カバレッジ | 91% | 85% |
| 分岐カバレッジ | 88% | 80% |
| メソッドカバレッジ | 93% | 90% |

## 8. 改訂履歴

| 版数 | 日付 | 改訂者 | 改訂内容 |
|-----|------|-------|---------|
| 1.0 | 2025/05/17 | 市丸 | 初版作成 |
| 1.1 | 2025/05/18 | 市丸 | テスト環境をPostgreSQLのみに変更、リポジトリテスト追加 |