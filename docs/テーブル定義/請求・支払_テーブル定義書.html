<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>請求・支払 テーブル定義書 (PostgreSQL)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2980b9;
            margin-top: 30px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }
        p {
            margin-bottom: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        ul {
            margin-bottom: 20px;
        }
        li {
            margin-bottom: 5px;
        }
        .code-block {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>請求・支払 テーブル定義書 (PostgreSQL)</h1>

    <h2>請求テーブル (invoices)</h2>
    <p>顧客への請求情報を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>invoice_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>請求ID</td>
            </tr>
            <tr>
                <td>invoice_number</td>
                <td>VARCHAR(50)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>請求番号</td>
            </tr>
            <tr>
                <td>customer_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(customers.customer_id)</td>
                <td></td>
                <td>顧客ID</td>
            </tr>
            <tr>
                <td>project_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(projects.project_id)</td>
                <td></td>
                <td>案件ID</td>
            </tr>
            <tr>
                <td>contract_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(contracts.contract_id)</td>
                <td></td>
                <td>契約ID</td>
            </tr>
            <tr>
                <td>billing_year</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>請求年</td>
            </tr>
            <tr>
                <td>billing_month</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>請求月</td>
            </tr>
            <tr>
                <td>billing_date</td>
                <td>DATE</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>請求日</td>
            </tr>
            <tr>
                <td>payment_due_date</td>
                <td>DATE</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支払期限日</td>
            </tr>
            <tr>
                <td>amount_before_tax</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>税抜金額</td>
            </tr>
            <tr>
                <td>tax_amount</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>消費税額</td>
            </tr>
            <tr>
                <td>total_amount</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>合計金額</td>
            </tr>
            <tr>
                <td>tax_rate</td>
                <td>NUMERIC(5,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>10.00</td>
                <td>消費税率(%)</td>
            </tr>
            <tr>
                <td>billing_status</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'作成中'</td>
                <td>請求ステータス</td>
            </tr>
            <tr>
                <td>payment_status</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'未入金'</td>
                <td>入金ステータス</td>
            </tr>
            <tr>
                <td>payment_date</td>
                <td>DATE</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>入金日</td>
            </tr>
            <tr>
                <td>payment_method</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>'振込'</td>
                <td>支払方法</td>
            </tr>
            <tr>
                <td>billing_address</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>請求先住所</td>
            </tr>
            <tr>
                <td>bank_account_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(bank_accounts.account_id)</td>
                <td></td>
                <td>振込先口座ID</td>
            </tr>
            <tr>
                <td>invoice_file_path</td>
                <td>VARCHAR(255)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>請求書ファイルパス</td>
            </tr>
            <tr>
                <td>receipt_file_path</td>
                <td>VARCHAR(255)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>領収書ファイルパス</td>
            </tr>
            <tr>
                <td>notes</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>備考</td>
            </tr>
            <tr>
                <td>created_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>作成者ID</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (billing_year >= 2000 AND billing_year <= 2100)</li>
                <li>CHECK (billing_month >= 1 AND billing_month <= 12)</li>
                <li>CHECK (tax_rate >= 0)</li>
                <li>CHECK (billing_status IN ('作成中', '確認中', '承認済', '請求済', 'キャンセル', '破棄'))</li>
                <li>CHECK (payment_status IN ('未入金', '一部入金', '入金済', '遅延', '不足', '過剰'))</li>
                <li>CHECK (payment_method IN ('振込', '自動引落', '現金', '小切手', 'その他'))</li>
                <li>UNIQUE (invoice_number)</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (invoice_id)</li>
                <li>CREATE INDEX idx_invoices_invoice_number ON invoices(invoice_number);</li>
                <li>CREATE INDEX idx_invoices_customer_id ON invoices(customer_id);</li>
                <li>CREATE INDEX idx_invoices_project_id ON invoices(project_id);</li>
                <li>CREATE INDEX idx_invoices_contract_id ON invoices(contract_id);</li>
                <li>CREATE INDEX idx_invoices_billing_date ON invoices(billing_date);</li>
                <li>CREATE INDEX idx_invoices_payment_due_date ON invoices(payment_due_date);</li>
                <li>CREATE INDEX idx_invoices_billing_status ON invoices(billing_status);</li>
                <li>CREATE INDEX idx_invoices_payment_status ON invoices(payment_status);</li>
                <li>CREATE INDEX idx_invoices_billing_year_month ON invoices(billing_year, billing_month);</li>
            </ul>
        </li>
    </ul>

    <h2>請求明細テーブル (invoice_items)</h2>
    <p>請求書の明細項目を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>invoice_item_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>請求明細ID</td>
            </tr>
            <tr>
                <td>invoice_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(invoices.invoice_id)</td>
                <td></td>
                <td>請求ID</td>
            </tr>
            <tr>
                <td>engineer_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(engineers.engineer_id)</td>
                <td></td>
                <td>技術者ID</td>
            </tr>
            <tr>
                <td>item_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'人月'</td>
                <td>項目タイプ</td>
            </tr>
            <tr>
                <td>item_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>項目名</td>
            </tr>
            <tr>
                <td>description</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>詳細説明</td>
            </tr>
            <tr>
                <td>quantity</td>
                <td>NUMERIC(8,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>1</td>
                <td>数量</td>
            </tr>
            <tr>
                <td>unit_price</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>単価</td>
            </tr>
            <tr>
                <td>amount</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>金額</td>
            </tr>
            <tr>
                <td>tax_rate</td>
                <td>NUMERIC(5,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>10.00</td>
                <td>消費税率(%)</td>
            </tr>
            <tr>
                <td>taxable</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>TRUE</td>
                <td>課税対象フラグ</td>
            </tr>
            <tr>
                <td>sort_order</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>表示順</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (quantity >= 0)</li>
                <li>CHECK (unit_price >= 0)</li>
                <li>CHECK (amount >= 0)</li>
                <li>CHECK (item_type IN ('人月', '固定', '従量', '諸経費', 'その他'))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (invoice_item_id)</li>
                <li>CREATE INDEX idx_invoice_items_invoice_id ON invoice_items(invoice_id);</li>
                <li>CREATE INDEX idx_invoice_items_engineer_id ON invoice_items(engineer_id);</li>
                <li>CREATE INDEX idx_invoice_items_item_type ON invoice_items(item_type);</li>
            </ul>
        </li>
    </ul>

    <h2>支払テーブル (payments)</h2>
    <p>パートナー会社や技術者への支払情報を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>payment_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>支払ID</td>
            </tr>
            <tr>
                <td>payment_number</td>
                <td>VARCHAR(50)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支払番号</td>
            </tr>
            <tr>
                <td>company_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(companies.company_id)</td>
                <td></td>
                <td>会社ID</td>
            </tr>
            <tr>
                <td>engineer_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(engineers.engineer_id)</td>
                <td></td>
                <td>技術者ID</td>
            </tr>
            <tr>
                <td>project_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(projects.project_id)</td>
                <td></td>
                <td>案件ID</td>
            </tr>
            <tr>
                <td>contract_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(contracts.contract_id)</td>
                <td></td>
                <td>契約ID</td>
            </tr>
            <tr>
                <td>invoice_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(invoices.invoice_id)</td>
                <td></td>
                <td>請求ID</td>
            </tr>
            <tr>
                <td>payment_year</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支払年</td>
            </tr>
            <tr>
                <td>payment_month</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支払月</td>
            </tr>
            <tr>
                <td>issue_date</td>
                <td>DATE</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>発行日</td>
            </tr>
            <tr>
                <td>payment_date</td>
                <td>DATE</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支払日</td>
            </tr>
            <tr>
                <td>amount_before_tax</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>税抜金額</td>
            </tr>
            <tr>
                <td>tax_amount</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>消費税額</td>
            </tr>
            <tr>
                <td>total_amount</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>合計金額</td>
            </tr>
            <tr>
                <td>tax_rate</td>
                <td>NUMERIC(5,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>10.00</td>
                <td>消費税率(%)</td>
            </tr>
            <tr>
                <td>payment_status</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'作成中'</td>
                <td>支払ステータス</td>
            </tr>
            <tr>
                <td>payment_method</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'振込'</td>
                <td>支払方法</td>
            </tr>
            <tr>
                <td>bank_account_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(bank_accounts.account_id)</td>
                <td></td>
                <td>振込先口座ID</td>
            </tr>
            <tr>
                <td>payment_file_path</td>
                <td>VARCHAR(255)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支払書類パス</td>
            </tr>
            <tr>
                <td>notes</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>備考</td>
            </tr>
            <tr>
                <td>approved_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>承認者ID</td>
            </tr>
            <tr>
                <td>approved_at</td>
                <td>TIMESTAMP</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>承認日時</td>
            </tr>
            <tr>
                <td>created_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>作成者ID</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (payment_year >= 2000 AND payment_year <= 2100)</li>
                <li>CHECK (payment_month >= 1 AND payment_month <= 12)</li>
                <li>CHECK (tax_rate >= 0)</li>
                <li>CHECK (payment_status IN ('作成中', '確認中', '承認済', '支払済', 'キャンセル'))</li>
                <li>CHECK (payment_method IN ('振込', '自動引落', '現金', 'その他'))</li>
                <li>CHECK ((company_id IS NOT NULL AND engineer_id IS NULL) OR (company_id IS NULL AND engineer_id IS NOT NULL))</li>
                <li>UNIQUE (payment_number)</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (payment_id)</li>
                <li>CREATE INDEX idx_payments_payment_number ON payments(payment_number);</li>
                <li>CREATE INDEX idx_payments_company_id ON payments(company_id);</li>
                <li>CREATE INDEX idx_payments_engineer_id ON payments(engineer_id);</li>
                <li>CREATE INDEX idx_payments_project_id ON payments(project_id);</li>
                <li>CREATE INDEX idx_payments_contract_id ON payments(contract_id);</li>
                <li>CREATE INDEX idx_payments_invoice_id ON payments(invoice_id);</li>
                <li>CREATE INDEX idx_payments_issue_date ON payments(issue_date);</li>
                <li>CREATE INDEX idx_payments_payment_date ON payments(payment_date);</li>
                <li>CREATE INDEX idx_payments_payment_status ON payments(payment_status);</li>
                <li>CREATE INDEX idx_payments_payment_year_month ON payments(payment_year, payment_month);</li>
            </ul>
        </li>
    </ul>

    <h2>支払明細テーブル (payment_items)</h2>
    <p>支払明細項目を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>payment_item_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>支払明細ID</td>
            </tr>
            <tr>
                <td>payment_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(payments.payment_id)</td>
                <td></td>
                <td>支払ID</td>
            </tr>
            <tr>
                <td>item_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'人月'</td>
                <td>項目タイプ</td>
            </tr>
            <tr>
                <td>item_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>項目名</td>
            </tr>
            <tr>
                <td>description</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>詳細説明</td>
            </tr>
            <tr>
                <td>quantity</td>
                <td>NUMERIC(8,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>1</td>
                <td>数量</td>
            </tr>
            <tr>
                <td>unit_price</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>単価</td>
            </tr>
            <tr>
                <td>amount</td>
                <td>NUMERIC(12,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>金額</td>
            </tr>
            <tr>
                <td>tax_rate</td>
                <td>NUMERIC(5,2)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>10.00</td>
                <td>消費税率(%)</td>
            </tr>
            <tr>
                <td>taxable</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>TRUE</td>
                <td>課税対象フラグ</td>
            </tr>
            <tr>
                <td>sort_order</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>0</td>
                <td>表示順</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (quantity >= 0)</li>
                <li>CHECK (unit_price >= 0)</li>
                <li>CHECK (amount >= 0)</li>
                <li>CHECK (item_type IN ('人月', '固定', '従量', '諸経費', 'その他'))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (payment_item_id)</li>
                <li>CREATE INDEX idx_payment_items_payment_id ON payment_items(payment_id);</li>
                <li>CREATE INDEX idx_payment_items_item_type ON payment_items(item_type);</li>
            </ul>
        </li>
    </ul>

    <h2>銀行口座テーブル (bank_accounts)</h2>
    <p>振込先・振込元の銀行口座情報を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>account_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>口座ID</td>
            </tr>
            <tr>
                <td>account_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'自社'</td>
                <td>口座種別</td>
            </tr>
            <tr>
                <td>company_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(companies.company_id)</td>
                <td></td>
                <td>会社ID</td>
            </tr>
            <tr>
                <td>engineer_id</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td>FK(engineers.engineer_id)</td>
                <td></td>
                <td>技術者ID</td>
            </tr>
            <tr>
                <td>bank_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>銀行名</td>
            </tr>
            <tr>
                <td>branch_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支店名</td>
            </tr>
            <tr>
                <td>branch_code</td>
                <td>VARCHAR(10)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>支店コード</td>
            </tr>
            <tr>
                <td>account_number</td>
                <td>VARCHAR(20)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>口座番号</td>
            </tr>
            <tr>
                <td>account_name</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td></td>
                <td>口座名義</td>
            </tr>
            <tr>
                <td>account_name_kana</td>
                <td>VARCHAR(100)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>口座名義カナ</td>
            </tr>
            <tr>
                <td>swift_code</td>
                <td>VARCHAR(20)</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>SWIFTコード</td>
            </tr>
            <tr>
                <td>is_default</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>FALSE</td>
                <td>デフォルト口座フラグ</td>
            </tr>
            <tr>
                <td>is_active</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>TRUE</td>
                <td>有効フラグ</td>
            </tr>
            <tr>
                <td>notes</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>備考</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (account_type IN ('自社', '顧客', 'パートナー', '技術者', 'その他'))</li>
                <li>CHECK ((company_id IS NOT NULL AND engineer_id IS NULL) OR (company_id IS NULL AND engineer_id IS NOT NULL) OR (account_type = '自社'))</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (account_id)</li>
                <li>CREATE INDEX idx_bank_accounts_company_id ON bank_accounts(company_id);</li>
                <li>CREATE INDEX idx_bank_accounts_engineer_id ON bank_accounts(engineer_id);</li>
                <li>CREATE INDEX idx_bank_accounts_account_type ON bank_accounts(account_type);</li>
                <li>CREATE INDEX idx_bank_accounts_is_default ON bank_accounts(is_default);</li>
                <li>CREATE INDEX idx_bank_accounts_is_active ON bank_accounts(is_active);</li>
            </ul>
        </li>
    </ul>

    <h2>支払承認フローテーブル (payment_approvals)</h2>
    <p>支払の承認フローを管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>外部キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>approval_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td></td>
                <td>承認ID</td>
            </tr>
            <tr>
                <td>payment_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(payments.payment_id)</td>
                <td></td>
                <td>支払ID</td>
            </tr>
            <tr>
                <td>approver_id</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td>FK(users.user_id)</td>
                <td></td>
                <td>承認者ID</td>
            </tr>
            <tr>
                <td>approver_role</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'担当者'</td>
                <td>承認者役割</td>
            </tr>
            <tr>
                <td>approval_order</td>
                <td>INTEGER</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>1</td>
                <td>承認順序</td>
            </tr>
            <tr>
                <td>status</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>'未対応'</td>
                <td>承認ステータス</td>
            </tr>
            <tr>
                <td>comments</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>コメント</td>
            </tr>
            <tr>
                <td>approved_at</td>
                <td>TIMESTAMP</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td></td>
                <td>承認日時</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (approval_order >= 1)</li>
                <li>CHECK (approver_role IN ('担当者', '管理者', '経理', '部長', '社長', 'その他'))</li>
                <li>CHECK (status IN ('未対応', '承認', '差戻', '保留', 'スキップ'))</li>
                <li>UNIQUE (payment_id, approval_order)</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (approval_id)</li>
                <li>CREATE INDEX idx_payment_approvals_payment_id ON payment_approvals(payment_id);</li>
                <li>CREATE INDEX idx_payment_approvals_approver_id ON payment_approvals(approver_id);</li>
                <li>CREATE INDEX idx_payment_approvals_status ON payment_approvals(status);</li>
                <li>CREATE INDEX idx_payment_approvals_approved_at ON payment_approvals(approved_at);</li>
            </ul>
        </li>
    </ul>

    <h2>財務設定テーブル (finance_settings)</h2>
    <p>請求や支払に関する財務設定を管理するテーブル</p>
    
    <table>
        <thead>
            <tr>
                <th>カラム名</th>
                <th>データ型</th>
                <th>NULL</th>
                <th>主キー</th>
                <th>デフォルト</th>
                <th>説明</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>setting_id</td>
                <td>SERIAL</td>
                <td>NO</td>
                <td>PK</td>
                <td></td>
                <td>設定ID</td>
            </tr>
            <tr>
                <td>setting_key</td>
                <td>VARCHAR(100)</td>
                <td>NO</td>
                <td></td>
                <td></td>
                <td>設定キー</td>
            </tr>
            <tr>
                <td>setting_value</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>設定値</td>
            </tr>
            <tr>
                <td>setting_type</td>
                <td>TEXT</td>
                <td>NO</td>
                <td></td>
                <td>'string'</td>
                <td>設定値タイプ</td>
            </tr>
            <tr>
                <td>description</td>
                <td>TEXT</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>説明</td>
            </tr>
            <tr>
                <td>is_system</td>
                <td>BOOLEAN</td>
                <td>NO</td>
                <td></td>
                <td>FALSE</td>
                <td>システム設定フラグ</td>
            </tr>
            <tr>
                <td>created_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>作成日時</td>
            </tr>
            <tr>
                <td>updated_at</td>
                <td>TIMESTAMP</td>
                <td>NO</td>
                <td></td>
                <td>CURRENT_TIMESTAMP</td>
                <td>更新日時</td>
            </tr>
            <tr>
                <td>updated_by</td>
                <td>INTEGER</td>
                <td>YES</td>
                <td></td>
                <td></td>
                <td>更新者ID</td>
            </tr>
        </tbody>
    </table>

    <ul>
        <li>制約
            <ul>
                <li>CHECK (setting_type IN ('string', 'integer', 'decimal', 'boolean', 'json', 'date'))</li>
                <li>UNIQUE (setting_key)</li>
            </ul>
        </li>
        <li>インデックス
            <ul>
                <li>PRIMARY KEY (setting_id)</li>
                <li>CREATE UNIQUE INDEX idx_finance_settings_key ON finance_settings(setting_key);</li>
            </ul>
        </li>
    </ul>

    <h2>テーブル作成用SQL</h2>
    <div class="code-block">
-- 更新タイムスタンプ用のトリガー関数
CREATE OR REPLACE FUNCTION update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 銀行口座テーブル
CREATE TABLE bank_accounts (
    account_id SERIAL PRIMARY KEY,
    account_type TEXT NOT NULL DEFAULT '自社' 
        CHECK (account_type IN ('自社', '顧客', 'パートナー', '技術者', 'その他')),
    company_id INTEGER REFERENCES companies(company_id),
    engineer_id INTEGER REFERENCES engineers(engineer_id),
    bank_name VARCHAR(100) NOT NULL,
    branch_name VARCHAR(100) NOT NULL,
    branch_code VARCHAR(10),
    account_number VARCHAR(20) NOT NULL,
    account_name VARCHAR(100) NOT NULL,
    account_name_kana VARCHAR(100),
    swift_code VARCHAR(20),
    is_default BOOLEAN NOT NULL DEFAULT FALSE,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    notes TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CHECK ((company_id IS NOT NULL AND engineer_id IS NULL) OR 
           (company_id IS NULL AND engineer_id IS NOT NULL) OR 
           (account_type = '自社'))
);

CREATE INDEX idx_bank_accounts_company_id ON bank_accounts(company_id);
CREATE INDEX idx_bank_accounts_engineer_id ON bank_accounts(engineer_id);
CREATE INDEX idx_bank_accounts_account_type ON bank_accounts(account_type);
CREATE INDEX idx_bank_accounts_is_default ON bank_accounts(is_default);
CREATE INDEX idx_bank_accounts_is_active ON bank_accounts(is_active);

CREATE TRIGGER update_bank_accounts_timestamp
BEFORE UPDATE ON bank_accounts
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- 請求テーブル
CREATE TABLE invoices (
    invoice_id SERIAL PRIMARY KEY,
    invoice_number VARCHAR(50) NOT NULL UNIQUE,
    customer_id INTEGER NOT NULL REFERENCES customers(customer_id),
    project_id INTEGER REFERENCES projects(project_id),
    contract_id INTEGER REFERENCES contracts(contract_id),
    billing_year INTEGER NOT NULL CHECK (billing_year >= 2000 AND billing_year <= 2100),
    billing_month INTEGER NOT NULL CHECK (billing_month >= 1 AND billing_month <= 12),
    billing_date DATE NOT NULL,
    payment_due_date DATE NOT NULL,
    amount_before_tax NUMERIC(12,2) NOT NULL DEFAULT 0,
    tax_amount NUMERIC(12,2) NOT NULL DEFAULT 0,
    total_amount NUMERIC(12,2) NOT NULL DEFAULT 0,
    tax_rate NUMERIC(5,2) NOT NULL DEFAULT 10.00 CHECK (tax_rate >= 0),
    billing_status TEXT NOT NULL DEFAULT '作成中' 
        CHECK (billing_status IN ('作成中', '確認中', '承認済', '請求済', 'キャンセル', '破棄')),
    payment_status TEXT NOT NULL DEFAULT '未入金' 
        CHECK (payment_status IN ('未入金', '一部入金', '入金済', '遅延', '不足', '過剰')),
    payment_date DATE,
    payment_method TEXT DEFAULT '振込' 
        CHECK (payment_method IN ('振込', '自動引落', '現金', '小切手', 'その他')),
    billing_address TEXT,
    bank_account_id INTEGER REFERENCES bank_accounts(account_id),
    invoice_file_path VARCHAR(255),
    receipt_file_path VARCHAR(255),
    notes TEXT,
    created_by INTEGER REFERENCES users(user_id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_invoices_invoice_number ON invoices(invoice_number);
CREATE INDEX idx_invoices_customer_id ON invoices(customer_id);
CREATE INDEX idx_invoices_project_id ON invoices(project_id);
CREATE INDEX idx_invoices_contract_id ON invoices(contract_id);
CREATE INDEX idx_invoices_billing_date ON invoices(billing_date);
CREATE INDEX idx_invoices_payment_due_date ON invoices(payment_due_date);
CREATE INDEX idx_invoices_billing_status ON invoices(billing_status);
CREATE INDEX idx_invoices_payment_status ON invoices(payment_status);
CREATE INDEX idx_invoices_billing_year_month ON invoices(billing_year, billing_month);

CREATE TRIGGER update_invoices_timestamp
BEFORE UPDATE ON invoices
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- 請求明細テーブル
CREATE TABLE invoice_items (
    invoice_item_id SERIAL PRIMARY KEY,
    invoice_id INTEGER NOT NULL REFERENCES invoices(invoice_id),
    engineer_id INTEGER REFERENCES engineers(engineer_id),
    item_type TEXT NOT NULL DEFAULT '人月' 
        CHECK (item_type IN ('人月', '固定', '従量', '諸経費', 'その他')),
    item_name VARCHAR(100) NOT NULL,
    description TEXT,
    quantity NUMERIC(8,2) NOT NULL DEFAULT 1 CHECK (quantity >= 0),
    unit_price NUMERIC(12,2) NOT NULL DEFAULT 0 CHECK (unit_price >= 0),
    amount NUMERIC(12,2) NOT NULL DEFAULT 0 CHECK (amount >= 0),
    tax_rate NUMERIC(5,2) NOT NULL DEFAULT 10.00,
    taxable BOOLEAN NOT NULL DEFAULT TRUE,
    sort_order INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_invoice_items_invoice_id ON invoice_items(invoice_id);
CREATE INDEX idx_invoice_items_engineer_id ON invoice_items(engineer_id);
CREATE INDEX idx_invoice_items_item_type ON invoice_items(item_type);

CREATE TRIGGER update_invoice_items_timestamp
BEFORE UPDATE ON invoice_items
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- 支払テーブル
CREATE TABLE payments (
    payment_id SERIAL PRIMARY KEY,
    payment_number VARCHAR(50) NOT NULL UNIQUE,
    company_id INTEGER REFERENCES companies(company_id),
    engineer_id INTEGER REFERENCES engineers(engineer_id),
    project_id INTEGER REFERENCES projects(project_id),
    contract_id INTEGER REFERENCES contracts(contract_id),
    invoice_id INTEGER REFERENCES invoices(invoice_id),
    payment_year INTEGER NOT NULL CHECK (payment_year >= 2000 AND payment_year <= 2100),
    payment_month INTEGER NOT NULL CHECK (payment_month >= 1 AND payment_month <= 12),
    issue_date DATE NOT NULL,
    payment_date DATE NOT NULL,
    amount_before_tax NUMERIC(12,2) NOT NULL DEFAULT 0,
    tax_amount NUMERIC(12,2) NOT NULL DEFAULT 0,
    total_amount NUMERIC(12,2) NOT NULL DEFAULT 0,
    tax_rate NUMERIC(5,2) NOT NULL DEFAULT 10.00 CHECK (tax_rate >= 0),
    payment_status TEXT NOT NULL DEFAULT '作成中' 
        CHECK (payment_status IN ('作成中', '確認中', '承認済', '支払済', 'キャンセル')),
    payment_method TEXT NOT NULL DEFAULT '振込' 
        CHECK (payment_method IN ('振込', '自動引落', '現金', 'その他')),
    bank_account_id INTEGER REFERENCES bank_accounts(account_id),
    payment_file_path VARCHAR(255),
    notes TEXT,
    approved_by INTEGER REFERENCES users(user_id),
    approved_at TIMESTAMP,
    created_by INTEGER REFERENCES users(user_id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CHECK ((company_id IS NOT NULL AND engineer_id IS NULL) OR 
           (company_id IS NULL AND engineer_id IS NOT NULL))
);

CREATE INDEX idx_payments_payment_number ON payments(payment_number);
CREATE INDEX idx_payments_company_id ON payments(company_id);
CREATE INDEX idx_payments_engineer_id ON payments(engineer_id);
CREATE INDEX idx_payments_project_id ON payments(project_id);
CREATE INDEX idx_payments_contract_id ON payments(contract_id);
CREATE INDEX idx_payments_invoice_id ON payments(invoice_id);
CREATE INDEX idx_payments_issue_date ON payments(issue_date);
CREATE INDEX idx_payments_payment_date ON payments(payment_date);
CREATE INDEX idx_payments_payment_status ON payments(payment_status);
CREATE INDEX idx_payments_payment_year_month ON payments(payment_year, payment_month);

CREATE TRIGGER update_payments_timestamp
BEFORE UPDATE ON payments
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- 支払明細テーブル
CREATE TABLE payment_items (
    payment_item_id SERIAL PRIMARY KEY,
    payment_id INTEGER NOT NULL REFERENCES payments(payment_id),
    item_type TEXT NOT NULL DEFAULT '人月' 
        CHECK (item_type IN ('人月', '固定', '従量', '諸経費', 'その他')),
    item_name VARCHAR(100) NOT NULL,
    description TEXT,
    quantity NUMERIC(8,2) NOT NULL DEFAULT 1 CHECK (quantity >= 0),
    unit_price NUMERIC(12,2) NOT NULL DEFAULT 0 CHECK (unit_price >= 0),
    amount NUMERIC(12,2) NOT NULL DEFAULT 0 CHECK (amount >= 0),
    tax_rate NUMERIC(5,2) NOT NULL DEFAULT 10.00,
    taxable BOOLEAN NOT NULL DEFAULT TRUE,
    sort_order INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_payment_items_payment_id ON payment_items(payment_id);
CREATE INDEX idx_payment_items_item_type ON payment_items(item_type);

CREATE TRIGGER update_payment_items_timestamp
BEFORE UPDATE ON payment_items
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- 支払承認フローテーブル
CREATE TABLE payment_approvals (
    approval_id SERIAL PRIMARY KEY,
    payment_id INTEGER NOT NULL REFERENCES payments(payment_id),
    approver_id INTEGER NOT NULL REFERENCES users(user_id),
    approver_role TEXT NOT NULL DEFAULT '担当者' 
        CHECK (approver_role IN ('担当者', '管理者', '経理', '部長', '社長', 'その他')),
    approval_order INTEGER NOT NULL DEFAULT 1 CHECK (approval_order >= 1),
    status TEXT NOT NULL DEFAULT '未対応' 
        CHECK (status IN ('未対応', '承認', '差戻', '保留', 'スキップ')),
    comments TEXT,
    approved_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (payment_id, approval_order)
);

CREATE INDEX idx_payment_approvals_payment_id ON payment_approvals(payment_id);
CREATE INDEX idx_payment_approvals_approver_id ON payment_approvals(approver_id);
CREATE INDEX idx_payment_approvals_status ON payment_approvals(status);
CREATE INDEX idx_payment_approvals_approved_at ON payment_approvals(approved_at);

CREATE TRIGGER update_payment_approvals_timestamp
BEFORE UPDATE ON payment_approvals
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

-- 財務設定テーブル
CREATE TABLE finance_settings (
    setting_id SERIAL PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL UNIQUE,
    setting_value TEXT,
    setting_type TEXT NOT NULL DEFAULT 'string' 
        CHECK (setting_type IN ('string', 'integer', 'decimal', 'boolean', 'json', 'date')),
    description TEXT,
    is_system BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by INTEGER REFERENCES users(user_id)
);

CREATE UNIQUE INDEX idx_finance_settings_key ON finance_settings(setting_key);

CREATE TRIGGER update_finance_settings_timestamp
BEFORE UPDATE ON finance_settings
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();
    </div>

</body>
</html>